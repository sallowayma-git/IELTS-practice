# Phase 04：数据与功能完善（题库/历史/提示词/设置/图片）

Based on current information, my understanding is: 在 Phase 02/03 的“能评分能展示”基础上，本 Phase 补齐需求文档中写作模块的核心功能：题库、历史记录、提示词管理完善、API 配置 UI、图片上传与缩略图、草稿与对比分析等。

---

## 【需求文档定位】（对应章节，便于对照）
- 文档路径：`developer/docs/雅思AI作文评判应用完整需求文档.md`
- 关联章节：
  - 3. 数据库设计（topics/essays/app_settings/prompts/api_configs）
  - 4. API 接口设计（topics/essays/upload/configs/prompts）
  - 6.4 历史记录管理
  - 6.5 题目管理
  - 6.6 系统设置
  - 7. 文件存储结构（images/备份）
  - 9. 用户体验流程（历史/题目管理流程）

---

## 【核心判断】🟡 能做，但要分层，别把功能堆成 if 垃圾
数据结构先稳住（schema/migrations/DAO），UI 才不会边写边炸。

---

## 【边界（本 Phase 可拆成多个小迭代）】
- 允许按优先级拆：先题库/历史最小 CRUD，再导入导出/图片/统计。
- 不强行追求“功能齐全一次到位”；每个子迭代都必须可回归、可用。

---

## 【数据层任务】

### P04-001：落地完整 schema + migrations（topics/essays/app_settings/prompts/api_configs）
- [ ] schema 与需求文档对齐，但修正自相矛盾字段（`evaluation_json` 的结构必须统一）
- [ ] migrations 机制：应用启动检查并自动执行未应用迁移
- [ ] 索引与约束：避免后续查询慢到不可用

**验收**：
- 旧数据升级不丢；迁移可重复跑；失败可诊断。

### P04-002：草稿机制
- [ ] 草稿保存位置决策：
  - 推荐：SQLite（避免 `file://` 下 localStorage 行为差异）
  - 可选：localStorage（但必须做 key 前缀隔离）
- [ ] 自动保存间隔/防抖、恢复弹窗

**验收**：
- 切换页面/关闭应用后草稿可恢复；不引发卡顿。

---

## 【功能任务（按需求文档优先级拆）】

### P04-101：题库列表/筛选/详情（Task1/Task2）
- [ ] 题目筛选（类型/分类/难度）
- [ ] 列表性能（虚拟滚动：确有需要再上，别为技术而技术）
- [ ] 题目详情渲染（Task1 图片预览/放大）

### P04-102：题目 CRUD + 批量导入
- [ ] 编辑器（先简化，后续再上 Tiptap）
- [ ] JSON 导入校验、预览、导入结果报告

### P04-201：历史记录列表/筛选/详情
- [ ] 列表（分页/虚拟滚动二选一，先分页）
- [ ] 筛选（日期/分数/任务类型）
- [ ] 详情复用 Result 渲染

### P04-202：历史统计与对比（雷达图）
- [ ] 计算口径写死（全部/最近10次/本月/Task专项）
- [ ] 无历史数据的空状态

### P04-301：设置页（API 配置 UI、提示词管理 UI、数据管理）
- [ ] API 配置：CRUD + 测试连接 + 默认/启用开关
- [ ] 提示词：版本信息、导入导出、危险编辑（必须二次确认）
- [ ] 数据管理：保留条数、清空、（备份恢复可放 Phase 05）

### P04-401：图片上传与缩略图（Task1）
- [ ] 图片选择/校验（类型、大小）
- [ ] 主进程落盘到 userData（不要塞进渲染进程）
- [ ] 缩略图生成（可选：先不做也行，但要写清楚）

---

## 【测试与门禁】

### DB/导入导出测试（必须自动化）
- [ ] migrations：从空库→最新；从旧版本库→最新
- [ ] topics JSON 导入：合法/非法/大文件/重复
- [ ] essays 查询：筛选条件组合

### 强制回归
```bash
python3 developer/tests/ci/run_static_suite.py
python3 developer/tests/e2e/suite_practice_flow.py
```

---

## 【风险点与对策】
- 性能：历史/题库一上量就慢，先用分页+索引，虚拟滚动按需加。
- 图片/备份：大文件处理要流式，不要一次读进内存。
