# IELTS AI 作文评判（Electron + Legacy + Vue 写作模块）总任务进度

Based on current information, my understanding is: 在不破坏现有 `index.html`/`js/`（Legacy 听力/阅读/练习系统）的前提下，把本仓库演进为 Electron 可执行应用；当用户需要 LLM 作文评判时，同窗口从 Legacy 页面切换到“写作专用 Vue 前端页面”；从写作返回 Legacy 时允许直接重载重建。

---

## 【核心判断】✅ 值得做

**关键取舍**：同窗口切页 + 回 Legacy 重载，这个决定把“跨页面状态保留”这坨复杂度直接砍掉，是正确的。

---

## 【全局边界/硬约束】（不满足就是垃圾实现）

### 0. 不破坏 userspace（Legacy 必须继续能跑）
- 现有 `index.html` + `js/` 必须保持功能完整（至少通过现有静态/E2E 套件）。
- Legacy 中新增的“进入写作”入口必须**降级兼容**：浏览器 `file://` 打开时不可报错（检测不到 `window.electronAPI` 就隐藏/禁用）。

### 1. 架构边界：两个前端，不允许混跑
- **禁止**在同一个 DOM 里把 Legacy 和 Vue 写作模块“挂载/卸载”来切换（CSS/全局变量/事件泄漏会把项目做成垃圾）。
- 切换只能由 Electron 主进程执行：`BrowserWindow.loadFile(...)` / `loadURL(...)` 切到另一个入口页面。

### 2. 安全边界：渲染进程不许碰密钥与磁盘
- 渲染进程（Legacy / 写作 Vue）**不得**直接持有 API Key、不得直接访问磁盘、不得直接请求第三方 LLM。
- 所有敏感能力下沉到主进程：LLM 调用、SQLite、文件读写、日志、备份恢复。
- `contextIsolation: true`、`nodeIntegration: false`、禁用 `remote`（或不引入）。
- 仅通过 `preload` 暴露白名单 API：`window.electronAPI.*`。

### 3. “流式”实现边界：不用 Express/SSE 服务器
- 需求文档里的 `/api/evaluate` + SSE 是桌面端参考架构；本项目落地采用 **IPC 事件流**：
  - `evaluate.start(...) -> sessionId`
  - `evaluate.event(sessionId) -> {progress|score|sentence|feedback|complete|error}`
  - `evaluate.cancel(sessionId)`
- **禁止**为了“看起来像后端”而在 Electron 里硬塞 Express（复杂度上升、端口/防火墙/并发/安全全是坑）。

### 4. `file://` 兼容（调试/回归要求）
- Legacy 必须继续支持 `file://` 打开（现有 `developer/tests/e2e` 依赖此模式）。
- 写作 Vue 构建产物必须可被 `loadFile` 加载（资源路径需相对；路由使用 Hash 模式；不依赖同源 `fetch` 读本地文件）。

---

## 【核心数据结构（先定死，消灭特殊情况）】

### 评分结果（evaluation）
统一使用一个最小 JSON 结构（主进程产出，渲染进程只渲染）：

```json
{
  "version": "v1",
  "task_type": "task1",
  "total_score": 6.5,
  "task_achievement": 6.0,
  "coherence_cohesion": 7.0,
  "lexical_resource": 6.5,
  "grammatical_range": 6.0,
  "sentences": [
    {
      "index": 0,
      "original": "The chart show the population growth.",
      "errors": [
        {
          "type": "grammar",
          "range": {"unit":"utf16","start":10,"end":14},
          "word": "show",
          "reason": "Subject-verb agreement error",
          "correction": "shows"
        }
      ],
      "corrected": "The chart shows the population growth."
    }
  ],
  "overall_feedback": "..."
}
```

**强制约束**：
- `range.unit` 必须明确（建议统一 `utf16`，与 JS 字符串索引一致）。不写清就会出现高亮错位的垃圾 bug。
- 顶层不搞 `errors`/`sentences.errors` 两套定义；只保留一种，避免特殊情况。

---

## 【目录规划（目标态）】

> 这里只定义“应该放哪”，不是现在就改。每个 Phase 的任务文档会落到具体文件/命令。

- `electron/`：主进程/预加载/窗口管理/IPC 路由
- `apps/writing-vue/`：写作 Vue 前端工程（独立构建产物）
- `dist/writing/`：写作 Vue 构建输出（供 Electron `loadFile`）
- `developer/tasks/ielts-writing-electron/`：本任务分解与进度追踪（本目录）

---

## 【Phase 总览与进度】

> 状态字段手工维护：`TODO / DOING / DONE / BLOCKED`

| Phase | 名称 | 目标交付物 | Gate（必须满足） | 状态 |
|---|---|---|---|---|
| 01 | Electron 壳与导航切换 | 单窗口可从 Legacy 切到写作占位页并返回；Legacy 入口降级不报错 | 现有静态/E2E 全通过 | TODO |
| 02 | 主进程服务层（IPC+加密+LLM 流式） | 统一 IPC API；API Key 加密存储；评测流式事件；取消/超时 | 新增主进程自测脚本 + 静态/E2E 全通过 | TODO |
| 03 | 写作 Vue 前端（最小闭环） | Compose→Evaluating→Result 最小闭环；基础错误高亮 | 写作模块 UI 冒烟用例全通过 | TODO |
| 04 | 题库/历史/提示词/设置 | SQLite schema+migrations；CRUD；导入导出；图片 | DB 迁移/导入导出测试通过 | TODO |
| 05 | 打包发布与回归 | electron-builder 打包；崩溃日志；安装/升级策略 | 全量回归 + 打包产物冒烟 | TODO |

---

## 【统一测试门禁】（每个 Phase 收尾必须做）

### 现有仓库强制回归（不跑就是瞎改）
```bash
python3 developer/tests/ci/run_static_suite.py
python3 developer/tests/e2e/suite_practice_flow.py
```

### 追加门禁（Electron/写作模块）
> 具体脚本在 Phase 02/03 落地（放在 `developer/tests/`，避免污染产物）。
- 主进程 IPC 合约自测：启动 Electron 主进程（无 UI），跑一组 evaluate/config/db 的合约用例
- 写作模块 UI 冒烟：最小路径（输入→开始→收到 progress→complete→展示）

---

## 【风险清单（提前写，别等炸了再补洞）】

1. **API Key 明文落盘**：必须用 `safeStorage`（或 OS Keychain 方案）加密后再入库。
2. **不同供应商流式格式不一致**：做 Provider Adapter 层；先支持 OpenAI-compatible，其他按实际抓包补齐。
3. **`file://` 下资源/路由问题**：写作模块必须 Hash 路由 + 相对 base；渲染层不读本地文件（全部走 IPC）。
4. **SQLite 原生依赖打包痛苦**：尽量用 Electron 兼容的预编译方案；打包期提前验证三平台。

---

## 【下一步】

- 进入 `phase01_Electron壳与导航切换.md`，按任务清单落地 Phase 01。

