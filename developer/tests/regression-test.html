<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>本地回归测试套件</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .pass {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .fail {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        button {
            padding: 10px 15px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        button:hover { opacity: 0.8; transform: translateY(-1px); }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background-color: #28a745;
            transition: width 0.3s ease;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .test-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: white;
        }
        .test-card h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-pending { background-color: #ffc107; }
        .status-running { background-color: #17a2b8; }
        .status-pass { background-color: #28a745; }
        .status-fail { background-color: #dc3545; }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .stat-number { font-size: 24px; font-weight: bold; }
        .stat-label { font-size: 14px; opacity: 0.9; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 本地回归测试套件</h1>
        <p>自动化测试核心功能，确保系统稳定性和数据完整性</p>

        <div class="test-section">
            <h3>🎯 测试控制面板</h3>

            <div style="margin: 15px 0;">
                <button class="btn-primary" onclick="runAllTests()" id="runAllBtn">
                    🚀 运行所有测试
                </button>
                <button class="btn-success" onclick="runExamTests()">
                    📚 Exam加载测试
                </button>
                <button class="btn-success" onclick="runPracticeTests()">
                    📝 Practice记录测试
                </button>
                <button class="btn-success" onclick="runBackupTests()">
                    💾 备份恢复测试
                </button>
                <button class="btn-warning" onclick="runStateTests()">
                    🔄 状态序列化测试
                </button>
                <button class="btn-secondary" onclick="clearResults()">
                    🗑️ 清除结果
                </button>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 0%"></div>
            </div>
            <div id="progressText" style="text-align: center; margin: 10px 0;">准备就绪</div>
        </div>

        <div class="test-section">
            <h3>📊 测试结果汇总</h3>

            <div class="summary-stats" id="summaryStats">
                <div class="stat-card">
                    <div class="stat-number" id="totalTests">0</div>
                    <div class="stat-label">总测试数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="passedTests">0</div>
                    <div class="stat-label">通过测试</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="failedTests">0</div>
                    <div class="stat-label">失败测试</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="successRate">0%</div>
                    <div class="stat-label">成功率</div>
                </div>
            </div>

            <div id="testResults"></div>
        </div>

        <div class="test-section">
            <h3>📋 详细测试报告</h3>
            <pre id="detailedReport">点击"运行所有测试"开始测试...</pre>
        </div>

        <div class="test-grid">
            <div class="test-card">
                <h4><span class="status-indicator status-pending" id="examStatus"></span>Exam加载测试</h4>
                <p>验证考试数据加载、分类、搜索和UI渲染功能</p>
                <button class="btn-primary" onclick="runExamTests()">运行测试</button>
                <div id="examResults" style="margin-top: 10px;"></div>
            </div>

            <div class="test-card">
                <h4><span class="status-indicator status-pending" id="practiceStatus"></span>Practice记录测试</h4>
                <p>验证练习记录的创建、读取、更新、删除和批量操作</p>
                <button class="btn-primary" onclick="runPracticeTests()">运行测试</button>
                <div id="practiceResults" style="margin-top: 10px;"></div>
            </div>

            <div class="test-card">
                <h4><span class="status-indicator status-pending" id="backupStatus"></span>备份恢复测试</h4>
                <p>验证数据备份创建、恢复、删除和完整性验证</p>
                <button class="btn-primary" onclick="runBackupTests()">运行测试</button>
                <div id="backupResults" style="margin-top: 10px;"></div>
            </div>

            <div class="test-card">
                <h4><span class="status-indicator status-pending" id="stateStatus"></span>状态序列化测试</h4>
                <p>验证Set/Map对象的序列化/反序列化和数据完整性</p>
                <button class="btn-primary" onclick="runStateTests()">运行测试</button>
                <div id="stateResults" style="margin-top: 10px;"></div>
            </div>
        </div>
    </div>

    <!-- 加载必要的脚本 -->
    <script src="../../js/utils/storage.js"></script>
    <script src="../../js/data/dataSources/storageDataSource.js"></script>
    <script src="../../js/data/repositories/baseRepository.js"></script>
    <script src="../../js/data/repositories/dataRepositoryRegistry.js"></script>
    <script src="../../js/data/repositories/practiceRepository.js"></script>
    <script src="../../js/data/repositories/settingsRepository.js"></script>
    <script src="../../js/data/repositories/backupRepository.js"></script>
    <script src="../../js/data/repositories/metaRepository.js"></script>
    <script src="../../js/data/index.js"></script>
    <script src="../../js/utils/stateSerializer.js"></script>
    <script src="../../js/utils/simpleStorageWrapper.js"></script>
    <script src="./js/stateSerializerTest.js"></script>
    <script src="./js/dataIntegrityValidator.js"></script>
    <script src="./js/examAutomationTest.js"></script>
    <script src="./js/practiceRecordTest.js"></script>
    <script src="./js/backupRestoreTest.js"></script>

    <!-- 加载主要数据文件 -->
    <script src="../../assets/scripts/complete-exam-data.js"></script>
    <script src="../../assets/scripts/listening-exam-data.js"></script>
    <script src="../../js/utils/dataBackupManager.js"></script>

    <script>
        // 测试实例
        let examTest = null;
        let practiceTest = null;
        let backupTest = null;
        let stateTest = null;
        let integrityValidator = null;

        // 测试结果
        let allTestResults = {
            exam: null,
            practice: null,
            backup: null,
            state: null
        };

        // 初始化测试实例
        function initializeTestInstances() {
            try {
                // 检查所有必要的类是否存在
                const requiredClasses = [
                    { name: 'ExamAutomationTest', class: window.ExamAutomationTest },
                    { name: 'PracticeRecordTest', class: window.PracticeRecordTest },
                    { name: 'BackupRestoreTest', class: window.BackupRestoreTest },
                    { name: 'StateSerializerTest', class: window.StateSerializerTest },
                    { name: 'DataIntegrityValidator', class: window.DataIntegrityValidator }
                ];

                const missingClasses = requiredClasses.filter(req => typeof req.class === 'undefined');
                if (missingClasses.length > 0) {
                    throw new Error('缺少必要的类: ' + missingClasses.map(c => c.name).join(', '));
                }

                // 创建实例
                examTest = new ExamAutomationTest();
                practiceTest = new PracticeRecordTest();
                backupTest = new BackupRestoreTest();
                stateTest = new StateSerializerTest();
                integrityValidator = new DataIntegrityValidator();

                console.log('✅ 测试实例初始化成功');
                return true;
            } catch (error) {
                console.error('❌ 测试实例初始化失败:', error);

                // 显示错误信息
                document.getElementById('testResults').innerHTML =
                    `<div class="fail"><strong>❌ 初始化失败:</strong> ${error.message}</div>`;

                return false;
            }
        }

        // 更新状态指示器
        function updateStatusIndicator(testName, status) {
            const indicator = document.getElementById(`${testName}Status`);
            if (indicator) {
                indicator.className = `status-indicator status-${status}`;
            }
        }

        // 更新进度条
        function updateProgress(current, total, text = '') {
            const percentage = total > 0 ? (current / total) * 100 : 0;
            document.getElementById('progressBar').style.width = `${percentage}%`;
            document.getElementById('progressText').textContent = text || `${current}/${total} 完成`;
        }

        // 运行所有测试
        async function runAllTests() {
            if (!initializeTestInstances()) {
                alert('测试实例初始化失败，请检查依赖是否正确加载');
                return;
            }

            const runAllBtn = document.getElementById('runAllBtn');
            runAllBtn.disabled = true;

            try {
                updateProgress(0, 4, '开始运行所有测试...');
                clearResults();

                // 1. 运行Exam测试
                updateStatusIndicator('exam', 'running');
                updateProgress(1, 4, '正在运行Exam加载测试...');
                await runExamTests(false);
                updateStatusIndicator('exam', allTestResults.exam ? 'pass' : 'fail');

                // 2. 运行Practice测试
                updateStatusIndicator('practice', 'running');
                updateProgress(2, 4, '正在运行Practice记录测试...');
                await runPracticeTests(false);
                updateStatusIndicator('practice', allTestResults.practice ? 'pass' : 'fail');

                // 3. 运行备份测试
                updateStatusIndicator('backup', 'running');
                updateProgress(3, 4, '正在运行备份恢复测试...');
                await runBackupTests(false);
                updateStatusIndicator('backup', allTestResults.backup ? 'pass' : 'fail');

                // 4. 运行状态测试
                updateStatusIndicator('state', 'running');
                updateProgress(4, 4, '正在运行状态序列化测试...');
                await runStateTests(false);
                updateStatusIndicator('state', allTestResults.state ? 'pass' : 'fail');

                updateProgress(4, 4, '所有测试完成！');
                updateSummaryStats();
                generateDetailedReport();

            } catch (error) {
                console.error('运行所有测试时发生错误:', error);
                updateProgress(4, 4, '测试执行出错');
            } finally {
                runAllBtn.disabled = false;
            }
        }

        // 运行Exam测试
        async function runExamTests(updateUI = true) {
            try {
                if (updateUI) {
                    updateStatusIndicator('exam', 'running');
                    document.getElementById('examResults').innerHTML = '<div class="info">正在运行Exam测试...</div>';
                }

                if (!examTest) {
                    if (!initializeTestInstances()) {
                        throw new Error('无法初始化测试实例');
                    }
                }

                const results = await examTest.runAllTests();
                const allPassed = results.every(r => r.passed);
                allTestResults.exam = results;

                if (updateUI) {
                    updateStatusIndicator('exam', allPassed ? 'pass' : 'fail');
                    displayTestResults('examResults', results, allPassed);
                    updateSummaryStats();
                }

                return results;

            } catch (error) {
                console.error('Exam测试失败:', error);
                if (updateUI) {
                    updateStatusIndicator('exam', 'fail');
                    document.getElementById('examResults').innerHTML = `<div class="fail">测试失败: ${error.message}</div>`;
                }
                return null;
            }
        }

        // 运行Practice测试
        async function runPracticeTests(updateUI = true) {
            try {
                if (updateUI) {
                    updateStatusIndicator('practice', 'running');
                    document.getElementById('practiceResults').innerHTML = '<div class="info">正在运行Practice记录测试...</div>';
                }

                if (!practiceTest) {
                    if (!initializeTestInstances()) {
                        throw new Error('无法初始化测试实例');
                    }
                }

                const results = await practiceTest.runAllTests();
                const allPassed = results.every(r => r.passed);
                allTestResults.practice = results;

                if (updateUI) {
                    updateStatusIndicator('practice', allPassed ? 'pass' : 'fail');
                    displayTestResults('practiceResults', results, allPassed);
                    updateSummaryStats();
                }

                return results;

            } catch (error) {
                console.error('Practice测试失败:', error);
                if (updateUI) {
                    updateStatusIndicator('practice', 'fail');
                    document.getElementById('practiceResults').innerHTML = `<div class="fail">测试失败: ${error.message}</div>`;
                }
                return null;
            }
        }

        // 运行备份测试
        async function runBackupTests(updateUI = true) {
            try {
                if (updateUI) {
                    updateStatusIndicator('backup', 'running');
                    document.getElementById('backupResults').innerHTML = '<div class="info">正在运行备份恢复测试...</div>';
                }

                if (!backupTest) {
                    if (!initializeTestInstances()) {
                        throw new Error('无法初始化测试实例');
                    }
                }

                const results = await backupTest.runAllTests();
                const allPassed = results.every(r => r.passed);
                allTestResults.backup = results;

                if (updateUI) {
                    updateStatusIndicator('backup', allPassed ? 'pass' : 'fail');
                    displayTestResults('backupResults', results, allPassed);
                    updateSummaryStats();
                }

                return results;

            } catch (error) {
                console.error('备份测试失败:', error);
                if (updateUI) {
                    updateStatusIndicator('backup', 'fail');
                    document.getElementById('backupResults').innerHTML = `<div class="fail">测试失败: ${error.message}</div>`;
                }
                return null;
            }
        }

        // 运行状态测试
        async function runStateTests(updateUI = true) {
            try {
                if (updateUI) {
                    updateStatusIndicator('state', 'running');
                    document.getElementById('stateResults').innerHTML = '<div class="info">正在运行状态序列化测试...</div>';
                }

                if (!stateTest) {
                    if (!initializeTestInstances()) {
                        throw new Error('无法初始化测试实例');
                    }
                }

                const results = await stateTest.runAllTests();
                const allPassed = results.every(r => r.passed);
                allTestResults.state = results;

                if (updateUI) {
                    updateStatusIndicator('state', allPassed ? 'pass' : 'fail');
                    displayTestResults('stateResults', results, allPassed);
                    updateSummaryStats();
                }

                return results;

            } catch (error) {
                console.error('状态测试失败:', error);
                if (updateUI) {
                    updateStatusIndicator('state', 'fail');
                    document.getElementById('stateResults').innerHTML = `<div class="fail">测试失败: ${error.message}</div>`;
                }
                return null;
            }
        }

        // 显示测试结果
        function displayTestResults(elementId, results, allPassed) {
            const element = document.getElementById(elementId);
            if (!element) return;

            const totalTests = results.length;
            const passedTests = results.filter(r => r.passed).length;
            const failedTests = totalTests - passedTests;

            let html = `
                <div class="${allPassed ? 'pass' : 'fail'}">
                    <strong>测试结果: ${passedTests}/${totalTests} 通过</strong>
                    ${failedTests > 0 ? ` (${failedTests} 失败)` : ''}
                </div>
            `;

            if (failedTests > 0) {
                html += '<div style="margin-top: 10px;"><strong>失败的测试:</strong></div>';
                results.filter(r => !r.passed).forEach(r => {
                    html += `<div class="fail" style="font-size: 12px; margin: 2px 0;">• ${r.name}</div>`;
                });
            }

            element.innerHTML = html;
        }

        // 更新汇总统计
        function updateSummaryStats() {
            const results = Object.values(allTestResults).filter(r => r !== null);
            if (results.length === 0) return;

            const totalTests = results.reduce((sum, r) => sum + r.length, 0);
            const passedTests = results.reduce((sum, r) => sum + r.filter(t => t.passed).length, 0);
            const failedTests = totalTests - passedTests;
            const successRate = totalTests > 0 ? ((passedTests / totalTests) * 100).toFixed(1) : 0;

            document.getElementById('totalTests').textContent = totalTests;
            document.getElementById('passedTests').textContent = passedTests;
            document.getElementById('failedTests').textContent = failedTests;
            document.getElementById('successRate').textContent = `${successRate}%`;

            // 更新整体结果区域
            const testResultsElement = document.getElementById('testResults');
            if (failedTests === 0) {
                testResultsElement.innerHTML = '<div class="pass"><strong>🎉 所有测试通过！系统运行正常</strong></div>';
            } else {
                testResultsElement.innerHTML = `<div class="fail"><strong>⚠️ 发现 ${failedTests} 个失败的测试，需要关注</strong></div>`;
            }
        }

        // 生成详细报告
        function generateDetailedReport() {
            const report = {
                timestamp: new Date().toISOString(),
                summary: {
                    totalSuites: Object.keys(allTestResults).filter(k => allTestResults[k] !== null).length,
                    totalTests: 0,
                    totalPassed: 0,
                    totalFailed: 0
                },
                suites: {}
            };

            // 收集各测试套件的结果
            ['exam', 'practice', 'backup', 'state'].forEach(suiteName => {
                const results = allTestResults[suiteName];
                if (results) {
                    const passed = results.filter(r => r.passed).length;
                    const failed = results.length - passed;

                    report.suites[suiteName] = {
                        name: suiteName,
                        total: results.length,
                        passed,
                        failed,
                        successRate: ((passed / results.length) * 100).toFixed(1)
                    };

                    report.summary.totalTests += results.length;
                    report.summary.totalPassed += passed;
                    report.summary.totalFailed += failed;
                }
            });

            report.summary.successRate = report.summary.totalTests > 0
                ? ((report.summary.totalPassed / report.summary.totalTests) * 100).toFixed(1)
                : 0;

            // 显示详细报告
            document.getElementById('detailedReport').textContent = JSON.stringify(report, null, 2);
        }

        // 清除结果
        function clearResults() {
            allTestResults = { exam: null, practice: null, backup: null, state: null };

            document.getElementById('testResults').innerHTML = '<div class="info">准备运行测试...</div>';
            document.getElementById('detailedReport').textContent = '点击"运行所有测试"开始测试...';

            ['exam', 'practice', 'backup', 'state'].forEach(testName => {
                updateStatusIndicator(testName, 'pending');
                const resultsElement = document.getElementById(`${testName}Results`);
                if (resultsElement) {
                    resultsElement.innerHTML = '';
                }
            });

            updateSummaryStats();
            updateProgress(0, 4, '准备就绪');
        }

        // 页面加载完成后的初始化
        window.addEventListener('load', () => {
            console.log('🧪 回归测试套件已加载');
            initializeTestInstances();
            updateProgress(0, 4, '准备就绪');
        });
    </script>
</body>
</html>
