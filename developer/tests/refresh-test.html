<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŠ¶æ€åºåˆ—åŒ–åˆ·æ–°æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .pass {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .fail {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        button {
            padding: 10px 15px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        .btn-danger { background-color: #dc3545; color: white; }
        button:hover { opacity: 0.8; transform: translateY(-1px); }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ çŠ¶æ€åºåˆ—åŒ–åˆ·æ–°æµ‹è¯•</h1>
        <p>æµ‹è¯•Set/Mapå¯¹è±¡åœ¨é¡µé¢åˆ·æ–°åçš„æŒä¹…åŒ–èƒ½åŠ›</p>

        <div class="test-section">
            <h3>ğŸ“‹ æµ‹è¯•æ­¥éª¤:</h3>
            <ol>
                <li><strong>ç‚¹å‡»"åˆ›å»ºæµ‹è¯•æ•°æ®"</strong> - åˆ›å»ºåŒ…å«Set/Mapçš„æµ‹è¯•çŠ¶æ€</li>
                <li><strong>ç‚¹å‡»"ä¿å­˜çŠ¶æ€åˆ°å­˜å‚¨"</strong> - åºåˆ—åŒ–å¹¶ä¿å­˜åˆ°localStorage</li>
                <li><strong>åˆ·æ–°é¡µé¢ (F5)</strong> - æ¨¡æ‹Ÿç”¨æˆ·åˆ·æ–°è¡Œä¸º</li>
                <li><strong>ç‚¹å‡»"éªŒè¯æ¢å¤çš„çŠ¶æ€"</strong> - æ£€æŸ¥æ•°æ®å®Œæ•´æ€§</li>
            </ol>

            <div style="margin: 15px 0;">
                <button class="btn-primary" onclick="createTestData()">ğŸ”§ åˆ›å»ºæµ‹è¯•æ•°æ®</button>
                <button class="btn-success" onclick="saveState()">ğŸ’¾ ä¿å­˜çŠ¶æ€åˆ°å­˜å‚¨</button>
                <button class="btn-warning" onclick="loadState()">ğŸ“‚ åŠ è½½çŠ¶æ€</button>
                <button class="btn-danger" onclick="verifyState()">âœ… éªŒè¯æ¢å¤çš„çŠ¶æ€</button>
                <button class="btn-primary" onclick="runFullTest()">ğŸ§ª è¿è¡Œå®Œæ•´æµ‹è¯•</button>
                <button class="btn-primary" onclick="runIntegrityValidation()">ğŸ” è¿è¡Œå®Œæ•´æ€§éªŒè¯</button>
                <button class="btn-danger" onclick="clearTestData()">ğŸ—‘ï¸ æ¸…é™¤æµ‹è¯•æ•°æ®</button>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š æµ‹è¯•ç»“æœ:</h3>
            <div id="test-results">
                <div class="status info">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•</div>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ“‹ å½“å‰çŠ¶æ€:</h3>
            <pre id="current-state">æ— çŠ¶æ€æ•°æ®</pre>
        </div>

        <div class="test-section">
            <h3>ğŸ” å­˜å‚¨æ£€æŸ¥:</h3>
            <div id="storage-check">
                <button class="btn-primary" onclick="checkStorage()">æ£€æŸ¥localStorageå†…å®¹</button>
                <pre id="storage-content" style="margin-top: 10px;"></pre>
            </div>
        </div>
    </div>

    <!-- åŠ è½½å¿…è¦çš„è„šæœ¬ -->
    <script src="../../js/utils/storage.js"></script>
    <script src="../../js/data/dataSources/storageDataSource.js"></script>
    <script src="../../js/data/repositories/baseRepository.js"></script>
    <script src="../../js/data/repositories/dataRepositoryRegistry.js"></script>
    <script src="../../js/data/repositories/practiceRepository.js"></script>
    <script src="../../js/data/repositories/settingsRepository.js"></script>
    <script src="../../js/data/repositories/backupRepository.js"></script>
    <script src="../../js/data/repositories/metaRepository.js"></script>
    <script src="../../js/data/index.js"></script>
    <script src="../../js/utils/stateSerializer.js"></script>
    <script src="./js/stateSerializerTest.js"></script>
    <script src="./js/dataIntegrityValidator.js"></script>

    <script>
        let testState = null;
        const test = new StateSerializerTest();
        const validator = new DataIntegrityValidator();
        const TEST_KEY = 'refresh_test_state';

        // åˆ›å»ºæµ‹è¯•æ•°æ®
        function createTestData() {
            testState = {
                // æ¨¡æ‹Ÿapp.jsä¸­çš„å®é™…çŠ¶æ€ç»“æ„
                exam: {
                    filteredExams: ['exam1', 'exam2', 'exam3'],
                    configurations: new Map([
                        ['config1', { enabled: true, difficulty: 'medium' }],
                        ['config2', { enabled: false, difficulty: 'hard' }]
                    ])
                },
                practice: {
                    selectedRecords: new Set(['record1', 'record2', 'record3']),
                    bulkDeleteMode: false,
                    records: [
                        { id: 'record1', score: 85, type: 'reading' },
                        { id: 'record2', score: 92, type: 'listening' },
                        { id: 'record3', score: 78, type: 'reading' }
                    ]
                },
                ui: {
                    browseFilter: { category: 'all', type: 'all' },
                    currentVirtualScroller: null,
                    loading: false
                },
                system: {
                    processedSessions: new Set(['session1', 'session2']),
                    fallbackExamSessions: new Map([
                        ['fallback1', { examId: 'exam1', data: 'backup data' }],
                        ['fallback2', { examId: 'exam2', data: 'backup data 2' }]
                    ]),
                    failedScripts: new Set(['script1'])
                },
                timestamp: new Date().toISOString(),
                testId: Math.random().toString(36).substr(2, 9)
            };

            updateDisplay('âœ… æµ‹è¯•æ•°æ®å·²åˆ›å»º', false);
            updateCurrentState();
        }

        // ä¿å­˜çŠ¶æ€åˆ°å­˜å‚¨
        async function saveState() {
            if (!testState) {
                updateDisplay('âŒ è¯·å…ˆåˆ›å»ºæµ‹è¯•æ•°æ®', true);
                return;
            }

            try {
                const serialized = StateSerializer.serialize(testState);
                await storage.set(TEST_KEY, serialized);

                // éªŒè¯ä¿å­˜æ˜¯å¦æˆåŠŸ
                const saved = await storage.get(TEST_KEY);
                if (saved) {
                    updateDisplay('âœ… çŠ¶æ€å·²æˆåŠŸä¿å­˜åˆ°localStorage', false);
                } else {
                    updateDisplay('âŒ ä¿å­˜éªŒè¯å¤±è´¥', true);
                }
            } catch (error) {
                updateDisplay('âŒ ä¿å­˜å¤±è´¥: ' + error.message, true);
            }
        }

        // ä»å­˜å‚¨åŠ è½½çŠ¶æ€
        async function loadState() {
            try {
                const stored = await storage.get(TEST_KEY);
                if (stored) {
                    testState = StateSerializer.deserialize(stored);
                    updateDisplay('âœ… çŠ¶æ€å·²æˆåŠŸä»localStorageåŠ è½½', false);
                    updateCurrentState();
                } else {
                    updateDisplay('âš ï¸ æœªæ‰¾åˆ°å­˜å‚¨çš„çŠ¶æ€æ•°æ®', true);
                }
            } catch (error) {
                updateDisplay('âŒ åŠ è½½å¤±è´¥: ' + error.message, true);
            }
        }

        // éªŒè¯æ¢å¤çš„çŠ¶æ€
        function verifyState() {
            if (!testState) {
                updateDisplay('âŒ æ— çŠ¶æ€æ•°æ®å¯éªŒè¯', true);
                return;
            }

            const results = [];
            let allPassed = true;

            // éªŒè¯practice.selectedRecords (Set)
            const setSelected = testState.practice.selectedRecords instanceof Set &&
                               testState.practice.selectedRecords.size === 3;
            results.push({
                name: 'practice.selectedRecords (Set)',
                passed: setSelected,
                details: setSelected ? 'âœ… Setæ­£ç¡®æ¢å¤ï¼ŒåŒ…å«3ä¸ªå…ƒç´ ' : 'âŒ Setæ¢å¤å¤±è´¥'
            });
            if (!setSelected) allPassed = false;

            // éªŒè¯exam.configurations (Map)
            const configMap = testState.exam.configurations instanceof Map &&
                            testState.exam.configurations.size === 2;
            results.push({
                name: 'exam.configurations (Map)',
                passed: configMap,
                details: configMap ? 'âœ… Mapæ­£ç¡®æ¢å¤ï¼ŒåŒ…å«2ä¸ªé…ç½®' : 'âŒ Mapæ¢å¤å¤±è´¥'
            });
            if (!configMap) allPassed = false;

            // éªŒè¯system.processedSessions (Set)
            const processedSet = testState.system.processedSessions instanceof Set &&
                               testState.system.processedSessions.size === 2;
            results.push({
                name: 'system.processedSessions (Set)',
                passed: processedSet,
                details: processedSet ? 'âœ… Setæ­£ç¡®æ¢å¤ï¼ŒåŒ…å«2ä¸ªä¼šè¯' : 'âŒ Setæ¢å¤å¤±è´¥'
            });
            if (!processedSet) allPassed = false;

            // éªŒè¯system.fallbackExamSessions (Map)
            const fallbackMap = testState.system.fallbackExamSessions instanceof Map &&
                              testState.system.fallbackExamSessions.size === 2;
            results.push({
                name: 'system.fallbackExamSessions (Map)',
                passed: fallbackMap,
                details: fallbackMap ? 'âœ… Mapæ­£ç¡®æ¢å¤ï¼ŒåŒ…å«2ä¸ªå›é€€ä¼šè¯' : 'âŒ Mapæ¢å¤å¤±è´¥'
            });
            if (!fallbackMap) allPassed = false;

            // éªŒè¯æ™®é€šæ•°ç»„å’Œå¯¹è±¡
            const arraysValid = Array.isArray(testState.practice.records) &&
                               testState.practice.records.length === 3;
            results.push({
                name: 'practice.records (Array)',
                passed: arraysValid,
                details: arraysValid ? 'âœ… æ•°ç»„æ­£ç¡®æ¢å¤' : 'âŒ æ•°ç»„æ¢å¤å¤±è´¥'
            });
            if (!arraysValid) allPassed = false;

            // æ˜¾ç¤ºè¯¦ç»†ç»“æœ
            let html = '<h4>ğŸ” è¯¦ç»†éªŒè¯ç»“æœ:</h4>';
            results.forEach(r => {
                html += `<div class="result ${r.passed ? 'pass' : 'fail'}">${r.details}</div>`;
            });
            html += `<div class="result ${allPassed ? 'pass' : 'fail'}"><strong>${
                allPassed ? 'ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Set/Mapåºåˆ—åŒ–å·¥ä½œæ­£å¸¸' : 'ğŸ’¥ æµ‹è¯•å¤±è´¥ï¼å­˜åœ¨æ•°æ®å®Œæ•´æ€§é—®é¢˜'
            }</strong></div>`;

            document.getElementById('test-results').innerHTML = html;

            updateDisplay(allPassed ? 'ğŸ‰ çŠ¶æ€éªŒè¯å®Œæˆï¼æ‰€æœ‰æ•°æ®å®Œæ•´' : 'ğŸ’¥ çŠ¶æ€éªŒè¯å¤±è´¥ï¼æ•°æ®æŸå', !allPassed);
        }

        // è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
        async function runFullTest() {
            updateDisplay('ğŸ§ª æ­£åœ¨è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶...', false);
            try {
                await test.runAllTests();
                updateDisplay('âœ… å®Œæ•´æµ‹è¯•å¥—ä»¶æ‰§è¡Œå®Œæˆ', false);
            } catch (error) {
                updateDisplay('âŒ æµ‹è¯•å¥—ä»¶æ‰§è¡Œå¤±è´¥: ' + error.message, true);
            }
        }

        // è¿è¡Œæ•°æ®å®Œæ•´æ€§éªŒè¯
        async function runIntegrityValidation() {
            updateDisplay('ğŸ” æ­£åœ¨è¿è¡Œæ•°æ®å®Œæ•´æ€§éªŒè¯...', false);
            try {
                await validator.runAllValidations();
                const report = validator.generateReport();

                let html = '<h4>ğŸ” æ•°æ®å®Œæ•´æ€§éªŒè¯æŠ¥å‘Š:</h4>';
                html += `<div class="result ${report.summary.failedTests === 0 ? 'pass' : 'fail'}">`;
                html += `æ€»éªŒè¯: ${report.summary.totalTests}, é€šè¿‡: ${report.summary.passedTests}, å¤±è´¥: ${report.summary.failedTests}`;
                html += ` (æˆåŠŸç‡: ${report.summary.successRate})</div>`;

                if (report.summary.failedTests > 0) {
                    html += '<div class="result fail"><strong>å¤±è´¥çš„éªŒè¯:</strong></div>';
                    report.failedTests.forEach(failure => {
                        html += `<div class="result fail">- ${failure.category}: ${failure.name} (${failure.error})</div>`;
                    });
                }

                html += '<h5>åˆ†ç±»ç»“æœ:</h5>';
                report.categories.forEach(cat => {
                    html += `<div class="result ${cat.failed === 0 ? 'pass' : 'fail'}">`;
                    html += `${cat.name}: ${cat.passed}/${cat.total} (æˆåŠŸç‡: ${cat.successRate})</div>`;
                });

                document.getElementById('test-results').innerHTML = html;
                updateDisplay(`âœ… æ•°æ®å®Œæ•´æ€§éªŒè¯å®Œæˆ (æˆåŠŸç‡: ${report.summary.successRate})`, report.summary.failedTests > 0);

            } catch (error) {
                updateDisplay('âŒ å®Œæ•´æ€§éªŒè¯å¤±è´¥: ' + error.message, true);
            }
        }

        // æ¸…é™¤æµ‹è¯•æ•°æ®
        async function clearTestData() {
            try {
                await storage.remove(TEST_KEY);
                testState = null;
                updateDisplay('ğŸ—‘ï¸ æµ‹è¯•æ•°æ®å·²æ¸…é™¤', false);
                updateCurrentState();
                document.getElementById('test-results').innerHTML = '<div class="status info">æµ‹è¯•æ•°æ®å·²æ¸…é™¤</div>';
            } catch (error) {
                updateDisplay('âŒ æ¸…é™¤å¤±è´¥: ' + error.message, true);
            }
        }

        // æ£€æŸ¥localStorageå†…å®¹
        async function checkStorage() {
            try {
                const keys = Object.keys(localStorage);
                const relevantKeys = keys.filter(key => key.includes('state') || key.includes('test'));

                let content = 'localStorageç›¸å…³é”®:\n';
                if (relevantKeys.length === 0) {
                    content += '  æ— ç›¸å…³å­˜å‚¨é”®\n';
                } else {
                    relevantKeys.forEach(key => {
                        const value = localStorage.getItem(key);
                        content += `  ${key}: ${value.length > 100 ? value.substring(0, 100) + '...' : value}\n`;
                    });
                }

                if (testState) {
                    content += '\nå½“å‰å†…å­˜ä¸­çš„testState:\n';
                    content += `  testId: ${testState.testId}\n`;
                    content += `  timestamp: ${testState.timestamp}\n`;
                    content += `  practice.selectedRecords.size: ${testState.practice.selectedRecords.size}\n`;
                    content += `  system.processedSessions.size: ${testState.system.processedSessions.size}\n`;
                }

                document.getElementById('storage-content').textContent = content;
            } catch (error) {
                document.getElementById('storage-content').textContent = 'æ£€æŸ¥å¤±è´¥: ' + error.message;
            }
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateDisplay(message, isError = false) {
            console.log((isError ? 'âŒ' : 'âœ…') + ' ' + message);
        }

        // æ›´æ–°å½“å‰çŠ¶æ€æ˜¾ç¤º
        function updateCurrentState() {
            const element = document.getElementById('current-state');
            if (!testState) {
                element.textContent = 'æ— çŠ¶æ€æ•°æ®';
                return;
            }

            element.textContent = JSON.stringify(testState, (key, value) => {
                if (value instanceof Set) return `Set(${Array.from(value).join(', ')})`;
                if (value instanceof Map) return `Map(${Array.from(value.entries()).map(([k, v]) => `${k}: ${JSON.stringify(v)}`).join(', ')})`;
                return value;
            }, 2);
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨å°è¯•æ¢å¤çŠ¶æ€å¹¶éªŒè¯
        window.addEventListener('load', async () => {
            updateDisplay('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆï¼Œå°è¯•æ¢å¤çŠ¶æ€...', false);

            await loadState();
            if (testState) {
                updateDisplay('ğŸ”„ æ£€æµ‹åˆ°å·²ä¿å­˜çš„çŠ¶æ€ï¼Œå¼€å§‹è‡ªåŠ¨éªŒè¯...', false);
                setTimeout(() => {
                    verifyState();
                }, 500);
            } else {
                updateDisplay('ğŸ“‹ æœªæ‰¾åˆ°ä¿å­˜çš„çŠ¶æ€ï¼Œè¯·åˆ›å»ºæ–°çš„æµ‹è¯•æ•°æ®', false);
            }
        });
    </script>
</body>
</html>
