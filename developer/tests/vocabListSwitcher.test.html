<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VocabListSwitcher å•å…ƒæµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            margin: 5px;
            padding: 8px 15px;
            cursor: pointer;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #007bff;
            color: white;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 3px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { 
            color: green; 
            font-weight: bold;
        }
        .error { 
            color: red; 
            font-weight: bold;
        }
        .test-container {
            border: 2px dashed #ccc;
            padding: 20px;
            margin: 10px 0;
            min-height: 100px;
            background: #fafafa;
        }
        #test-summary {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-width: 200px;
        }
        .stat-line {
            margin: 5px 0;
            font-size: 14px;
        }
        .vocab-list-switcher {
            display: inline-block;
        }
        .switcher-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }
        .switcher-btn:hover {
            background: #f5f5f5;
        }
        .switcher-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 4px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-width: 250px;
            z-index: 1000;
        }
        .dropdown-content {
            padding: 8px 0;
        }
        .list-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            cursor: pointer;
        }
        .list-option:hover {
            background: #f5f5f5;
        }
        .list-option.active {
            background: #e3f2fd;
        }
        .list-icon {
            font-size: 18px;
        }
        .list-name {
            flex: 1;
        }
        .list-count {
            color: #666;
            font-size: 12px;
        }
        .active-indicator {
            color: #007bff;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª VocabListSwitcher å•å…ƒæµ‹è¯•</h1>
    <p>æµ‹è¯•è¯è¡¨åˆ‡æ¢å™¨ç»„ä»¶çš„æ ¸å¿ƒåŠŸèƒ½</p>

    <div id="test-summary">
        <h4 style="margin-top: 0;">æµ‹è¯•æ‘˜è¦</h4>
        <div class="stat-line">æ€»æµ‹è¯•æ•°: <span id="total-tests">0</span></div>
        <div class="stat-line">é€šè¿‡: <span id="passed-tests" class="success">0</span></div>
        <div class="stat-line">å¤±è´¥: <span id="failed-tests" class="error">0</span></div>
        <div class="stat-line">æˆåŠŸç‡: <span id="success-rate">0%</span></div>
    </div>

    <div class="test-section">
        <h3>æ§åˆ¶é¢æ¿</h3>
        <button onclick="runAllTests()">ğŸš€ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
        <button onclick="clearResults()">ğŸ—‘ï¸ æ¸…é™¤ç»“æœ</button>
    </div>

    <div class="test-section">
        <h3>1. ç»„ä»¶æ¸²æŸ“æµ‹è¯•</h3>
        <button onclick="testRender()">è¿è¡Œæµ‹è¯•</button>
        <div class="test-container" id="render-container"></div>
        <div id="render-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>2. è¯è¡¨åˆ‡æ¢æµ‹è¯•</h3>
        <button onclick="testSwitchList()">è¿è¡Œæµ‹è¯•</button>
        <div class="test-container" id="switch-container"></div>
        <div id="switch-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>3. è¯è¡¨è®¡æ•°æ›´æ–°æµ‹è¯•</h3>
        <button onclick="testUpdateListCounts()">è¿è¡Œæµ‹è¯•</button>
        <div id="counts-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>4. ç”¨æˆ·åå¥½ä¿å­˜æµ‹è¯•</h3>
        <button onclick="testUserPreference()">è¿è¡Œæµ‹è¯•</button>
        <div id="preference-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>5. é”™è¯¯å¤„ç†æµ‹è¯•</h3>
        <button onclick="testErrorHandling()">è¿è¡Œæµ‹è¯•</button>
        <div id="error-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>6. ä¸‹æ‹‰èœå•äº¤äº’æµ‹è¯•</h3>
        <button onclick="testDropdownInteraction()">è¿è¡Œæµ‹è¯•</button>
        <div id="dropdown-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>æµ‹è¯•æ—¥å¿—</h3>
        <div id="test-log" class="result"></div>
    </div>

    <!-- åŠ è½½ä¾èµ– -->
    <script src="../../js/utils/storage.js"></script>
    <script src="../../js/app/spellingErrorCollector.js"></script>
    <script src="../../js/app/vocabListSwitcher.js"></script>

    <script>
        // æµ‹è¯•ç»Ÿè®¡
        let testStats = {
            total: 0,
            passed: 0,
            failed: 0
        };

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logEl = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
            logEl.innerHTML += `[${timestamp}] ${prefix} ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        // æ–­è¨€å‡½æ•°
        function assert(condition, message) {
            testStats.total++;
            if (condition) {
                testStats.passed++;
                log(`âœ“ ${message}`, 'success');
                return true;
            } else {
                testStats.failed++;
                log(`âœ— ${message}`, 'error');
                return false;
            }
        }

        // æ›´æ–°æµ‹è¯•æ‘˜è¦
        function updateSummary() {
            document.getElementById('total-tests').textContent = testStats.total;
            document.getElementById('passed-tests').textContent = testStats.passed;
            document.getElementById('failed-tests').textContent = testStats.failed;
            const rate = testStats.total > 0 ? ((testStats.passed / testStats.total) * 100).toFixed(1) : 0;
            document.getElementById('success-rate').textContent = `${rate}%`;
        }

        // Mock VocabStore
        class MockVocabStore {
            constructor() {
                this.VOCAB_LISTS = {
                    'p1': {
                        id: 'p1',
                        name: 'P1 æ‹¼å†™é”™è¯¯',
                        icon: 'ğŸ“',
                        source: 'p1',
                        storageKey: 'vocab_list_p1_errors'
                    },
                    'p4': {
                        id: 'p4',
                        name: 'P4 æ‹¼å†™é”™è¯¯',
                        icon: 'ğŸ“',
                        source: 'p4',
                        storageKey: 'vocab_list_p4_errors'
                    },
                    'master': {
                        id: 'master',
                        name: 'ç»¼åˆé”™è¯¯è¯è¡¨',
                        icon: 'ğŸ“š',
                        source: 'all',
                        storageKey: 'vocab_list_master_errors'
                    },
                    'custom': {
                        id: 'custom',
                        name: 'è‡ªå®šä¹‰è¯è¡¨',
                        icon: 'âœï¸',
                        source: 'user',
                        storageKey: 'vocab_list_custom'
                    }
                };

                this.activeListId = 'master';
                this.activeList = null;
                this.wordCounts = {
                    'p1': 5,
                    'p4': 8,
                    'master': 13,
                    'custom': 0
                };
            }

            getAvailableLists() {
                return Object.values(this.VOCAB_LISTS);
            }

            getActiveListId() {
                return this.activeListId;
            }

            async loadList(listId) {
                // æ¨¡æ‹Ÿå¼‚æ­¥åŠ è½½
                await new Promise(resolve => setTimeout(resolve, 100));
                
                if (listId === 'custom' && this.wordCounts[listId] === 0) {
                    return null; // ç©ºè¯è¡¨
                }

                return {
                    id: listId,
                    name: this.VOCAB_LISTS[listId].name,
                    source: this.VOCAB_LISTS[listId].source,
                    words: Array(this.wordCounts[listId]).fill({ word: 'test' }),
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                };
            }

            async setActiveList(list) {
                await new Promise(resolve => setTimeout(resolve, 50));
                this.activeList = list;
                this.activeListId = list.id;
                
                // ä¿å­˜ç”¨æˆ·åå¥½
                if (window.storage) {
                    await window.storage.set('vocab_active_list', list.id);
                }
                
                return true;
            }

            async getListWordCount(listId) {
                await new Promise(resolve => setTimeout(resolve, 50));
                return this.wordCounts[listId] || 0;
            }
        }

        // æµ‹è¯•1: ç»„ä»¶æ¸²æŸ“
        async function testRender() {
            const result = document.getElementById('render-result');
            const container = document.getElementById('render-container');
            container.innerHTML = '';
            result.innerHTML = 'è¿è¡Œä¸­...\n';

            try {
                const vocabStore = new MockVocabStore();
                const switcher = new VocabListSwitcher(vocabStore);

                // æ¸²æŸ“ç»„ä»¶
                switcher.render(container);

                // éªŒè¯DOMç»“æ„
                assert(container.querySelector('.vocab-list-switcher'), 'åº”è¯¥æ¸²æŸ“åˆ‡æ¢å™¨å®¹å™¨');
                assert(container.querySelector('.switcher-btn'), 'åº”è¯¥æ¸²æŸ“åˆ‡æ¢æŒ‰é’®');
                assert(container.querySelector('.switcher-dropdown'), 'åº”è¯¥æ¸²æŸ“ä¸‹æ‹‰èœå•');
                assert(container.querySelector('.current-list-name'), 'åº”è¯¥æ¸²æŸ“å½“å‰è¯è¡¨åç§°');
                assert(container.querySelector('.dropdown-content'), 'åº”è¯¥æ¸²æŸ“ä¸‹æ‹‰å†…å®¹');

                // éªŒè¯è¯è¡¨é€‰é¡¹
                const listOptions = container.querySelectorAll('.list-option');
                assert(listOptions.length === 4, `åº”è¯¥æœ‰4ä¸ªè¯è¡¨é€‰é¡¹ï¼Œå®é™…: ${listOptions.length}`);

                // éªŒè¯å½“å‰æ¿€æ´»çš„è¯è¡¨
                const activeOption = container.querySelector('.list-option.active');
                assert(activeOption !== null, 'åº”è¯¥æœ‰æ¿€æ´»çš„è¯è¡¨é€‰é¡¹');
                assert(activeOption.dataset.listId === 'master', 'é»˜è®¤åº”è¯¥æ¿€æ´»ç»¼åˆè¯è¡¨');

                result.innerHTML += '\n<span class="success">âœ… ç»„ä»¶æ¸²æŸ“æµ‹è¯•é€šè¿‡</span>';
                updateSummary();

            } catch (error) {
                result.innerHTML += `\n<span class="error">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</span>`;
                log(`ç»„ä»¶æ¸²æŸ“æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•2: è¯è¡¨åˆ‡æ¢
        async function testSwitchList() {
            const result = document.getElementById('switch-result');
            const container = document.getElementById('switch-container');
            container.innerHTML = '';
            result.innerHTML = 'è¿è¡Œä¸­...\n';

            try {
                const vocabStore = new MockVocabStore();
                const switcher = new VocabListSwitcher(vocabStore);
                switcher.render(container);

                // åˆå§‹çŠ¶æ€
                assert(switcher.currentListId === 'master', 'åˆå§‹åº”è¯¥æ˜¯ç»¼åˆè¯è¡¨');

                // åˆ‡æ¢åˆ°P1è¯è¡¨
                await switcher.switchList('p1');
                assert(switcher.currentListId === 'p1', 'åº”è¯¥åˆ‡æ¢åˆ°P1è¯è¡¨');
                assert(vocabStore.activeListId === 'p1', 'VocabStoreåº”è¯¥æ›´æ–°æ¿€æ´»è¯è¡¨');

                // éªŒè¯UIæ›´æ–°
                const currentName = container.querySelector('.current-list-name');
                assert(currentName.textContent === 'P1 æ‹¼å†™é”™è¯¯', 'UIåº”è¯¥æ˜¾ç¤ºP1è¯è¡¨åç§°');

                // åˆ‡æ¢åˆ°P4è¯è¡¨
                await switcher.switchList('p4');
                assert(switcher.currentListId === 'p4', 'åº”è¯¥åˆ‡æ¢åˆ°P4è¯è¡¨');

                // å°è¯•åˆ‡æ¢åˆ°æ— æ•ˆè¯è¡¨
                const previousId = switcher.currentListId;
                await switcher.switchList('invalid');
                assert(switcher.currentListId === previousId, 'æ— æ•ˆè¯è¡¨IDä¸åº”è¯¥æ”¹å˜å½“å‰è¯è¡¨');

                result.innerHTML += '\n<span class="success">âœ… è¯è¡¨åˆ‡æ¢æµ‹è¯•é€šè¿‡</span>';
                updateSummary();

            } catch (error) {
                result.innerHTML += `\n<span class="error">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</span>`;
                log(`è¯è¡¨åˆ‡æ¢æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•3: è¯è¡¨è®¡æ•°æ›´æ–°
        async function testUpdateListCounts() {
            const result = document.getElementById('counts-result');
            result.innerHTML = 'è¿è¡Œä¸­...\n';

            try {
                const container = document.createElement('div');
                const vocabStore = new MockVocabStore();
                const switcher = new VocabListSwitcher(vocabStore);
                switcher.render(container);

                // æ›´æ–°è¯è¡¨è®¡æ•°
                await switcher.updateListCounts();

                // éªŒè¯è®¡æ•°æ˜¾ç¤º
                const p1Count = container.querySelector('.list-count[data-list-id="p1"] .count-loaded');
                const p4Count = container.querySelector('.list-count[data-list-id="p4"] .count-loaded');
                const masterCount = container.querySelector('.list-count[data-list-id="master"] .count-loaded');

                assert(p1Count && p1Count.textContent === '5', 'P1è¯è¡¨è®¡æ•°åº”è¯¥æ˜¯5');
                assert(p4Count && p4Count.textContent === '8', 'P4è¯è¡¨è®¡æ•°åº”è¯¥æ˜¯8');
                assert(masterCount && masterCount.textContent === '13', 'ç»¼åˆè¯è¡¨è®¡æ•°åº”è¯¥æ˜¯13');

                result.innerHTML += '\n<span class="success">âœ… è¯è¡¨è®¡æ•°æ›´æ–°æµ‹è¯•é€šè¿‡</span>';
                updateSummary();

            } catch (error) {
                result.innerHTML += `\n<span class="error">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</span>`;
                log(`è¯è¡¨è®¡æ•°æ›´æ–°æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•4: ç”¨æˆ·åå¥½ä¿å­˜
        async function testUserPreference() {
            const result = document.getElementById('preference-result');
            result.innerHTML = 'è¿è¡Œä¸­...\n';

            try {
                // ç­‰å¾…storageåˆå§‹åŒ–
                if (window.storage && window.storage.ready) {
                    await window.storage.ready;
                }

                const container = document.createElement('div');
                const vocabStore = new MockVocabStore();
                const switcher = new VocabListSwitcher(vocabStore);
                switcher.render(container);

                // åˆ‡æ¢è¯è¡¨
                await switcher.switchList('p1');

                // éªŒè¯åå¥½å·²ä¿å­˜
                const savedPreference = await window.storage.get('vocab_active_list');
                assert(savedPreference === 'p1', 'ç”¨æˆ·åå¥½åº”è¯¥ä¿å­˜ä¸ºp1');

                // åˆ‡æ¢åˆ°å¦ä¸€ä¸ªè¯è¡¨
                await switcher.switchList('p4');
                const updatedPreference = await window.storage.get('vocab_active_list');
                assert(updatedPreference === 'p4', 'ç”¨æˆ·åå¥½åº”è¯¥æ›´æ–°ä¸ºp4');

                result.innerHTML += '\n<span class="success">âœ… ç”¨æˆ·åå¥½ä¿å­˜æµ‹è¯•é€šè¿‡</span>';
                updateSummary();

            } catch (error) {
                result.innerHTML += `\n<span class="error">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</span>`;
                log(`ç”¨æˆ·åå¥½ä¿å­˜æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•5: é”™è¯¯å¤„ç†
        async function testErrorHandling() {
            const result = document.getElementById('error-result');
            result.innerHTML = 'è¿è¡Œä¸­...\n';

            try {
                const container = document.createElement('div');
                const vocabStore = new MockVocabStore();
                const switcher = new VocabListSwitcher(vocabStore);
                switcher.render(container);

                // æµ‹è¯•ç©ºè¯è¡¨å¤„ç†
                const previousId = switcher.currentListId;
                await switcher.switchList('custom'); // customè¯è¡¨ä¸ºç©º
                
                // åº”è¯¥å›é€€åˆ°ä¸Šä¸€ä¸ªè¯è¡¨
                assert(switcher.currentListId === previousId, 'ç©ºè¯è¡¨åº”è¯¥å›é€€åˆ°ä¸Šä¸€ä¸ªè¯è¡¨');

                // æµ‹è¯•æ— æ•ˆè¯è¡¨ID
                await switcher.switchList('nonexistent');
                assert(switcher.currentListId === previousId, 'æ— æ•ˆè¯è¡¨IDä¸åº”è¯¥æ”¹å˜å½“å‰è¯è¡¨');

                // æµ‹è¯•æ— æ•ˆå®¹å™¨
                try {
                    const badSwitcher = new VocabListSwitcher(vocabStore);
                    badSwitcher.render(null);
                    assert(true, 'åº”è¯¥èƒ½å¤„ç†æ— æ•ˆå®¹å™¨');
                } catch (e) {
                    assert(false, 'ä¸åº”è¯¥æŠ›å‡ºå¼‚å¸¸');
                }

                result.innerHTML += '\n<span class="success">âœ… é”™è¯¯å¤„ç†æµ‹è¯•é€šè¿‡</span>';
                updateSummary();

            } catch (error) {
                result.innerHTML += `\n<span class="error">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</span>`;
                log(`é”™è¯¯å¤„ç†æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•6: ä¸‹æ‹‰èœå•äº¤äº’
        async function testDropdownInteraction() {
            const result = document.getElementById('dropdown-result');
            result.innerHTML = 'è¿è¡Œä¸­...\n';

            try {
                const container = document.createElement('div');
                document.body.appendChild(container);

                const vocabStore = new MockVocabStore();
                const switcher = new VocabListSwitcher(vocabStore);
                switcher.render(container);

                // åˆå§‹çŠ¶æ€ï¼šä¸‹æ‹‰èœå•åº”è¯¥éšè—
                const dropdown = container.querySelector('.switcher-dropdown');
                assert(dropdown.style.display === 'none', 'ä¸‹æ‹‰èœå•åˆå§‹åº”è¯¥éšè—');
                assert(switcher.dropdownVisible === false, 'dropdownVisibleåº”è¯¥æ˜¯false');

                // ç‚¹å‡»æŒ‰é’®æ˜¾ç¤ºä¸‹æ‹‰èœå•
                const menuBtn = container.querySelector('.switcher-btn');
                menuBtn.click();
                assert(dropdown.style.display === 'block', 'ç‚¹å‡»æŒ‰é’®åº”è¯¥æ˜¾ç¤ºä¸‹æ‹‰èœå•');
                assert(switcher.dropdownVisible === true, 'dropdownVisibleåº”è¯¥æ˜¯true');

                // å†æ¬¡ç‚¹å‡»æŒ‰é’®éšè—ä¸‹æ‹‰èœå•
                menuBtn.click();
                assert(dropdown.style.display === 'none', 'å†æ¬¡ç‚¹å‡»åº”è¯¥éšè—ä¸‹æ‹‰èœå•');
                assert(switcher.dropdownVisible === false, 'dropdownVisibleåº”è¯¥æ˜¯false');

                // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰èœå•
                menuBtn.click(); // å…ˆæ‰“å¼€
                document.body.click(); // ç‚¹å‡»å¤–éƒ¨
                await new Promise(resolve => setTimeout(resolve, 100));
                assert(dropdown.style.display === 'none', 'ç‚¹å‡»å¤–éƒ¨åº”è¯¥å…³é—­ä¸‹æ‹‰èœå•');

                // æ¸…ç†
                document.body.removeChild(container);

                result.innerHTML += '\n<span class="success">âœ… ä¸‹æ‹‰èœå•äº¤äº’æµ‹è¯•é€šè¿‡</span>';
                updateSummary();

            } catch (error) {
                result.innerHTML += `\n<span class="error">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</span>`;
                log(`ä¸‹æ‹‰èœå•äº¤äº’æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        async function runAllTests() {
            log('å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•...', 'info');
            testStats = { total: 0, passed: 0, failed: 0 };
            
            await testRender();
            await testSwitchList();
            await testUpdateListCounts();
            await testUserPreference();
            await testErrorHandling();
            await testDropdownInteraction();

            log(`æµ‹è¯•å®Œæˆï¼é€šè¿‡: ${testStats.passed}/${testStats.total}`, 'success');
            updateSummary();
        }

        // æ¸…é™¤ç»“æœ
        function clearResults() {
            document.querySelectorAll('.result').forEach(el => {
                el.innerHTML = '';
            });
            document.querySelectorAll('.test-container').forEach(el => {
                el.innerHTML = '';
            });
            testStats = { total: 0, passed: 0, failed: 0 };
            updateSummary();
            log('ç»“æœå·²æ¸…é™¤', 'info');
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        window.addEventListener('load', async () => {
            log('VocabListSwitcher æµ‹è¯•é¡µé¢å·²åŠ è½½', 'info');
            
            // ç­‰å¾…storageåˆå§‹åŒ–
            if (window.storage && window.storage.ready) {
                await window.storage.ready;
                log('Storage å·²åˆå§‹åŒ–', 'success');
            }
            
            updateSummary();
        });
    </script>
</body>
</html>
