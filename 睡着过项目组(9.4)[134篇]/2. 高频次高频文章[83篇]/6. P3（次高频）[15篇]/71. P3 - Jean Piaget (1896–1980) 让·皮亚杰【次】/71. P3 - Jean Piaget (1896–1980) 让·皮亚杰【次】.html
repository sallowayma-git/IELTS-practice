<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>P3 - Jean Piaget (1896–1980)</title>
  <style>
    :root { 
      --line:#e5e7eb; 
      --bg:#f6f7fb; 
      --panel:#fff; 
      --accent:#3b82f6; 
      --muted:#6b7280; 
      --shadow:0 6px 20px rgba(0,0,0,.12); 
      --text-color: #333;
      --highlight: #fff3a3;
      --selbar-bg: #111;
      --selbar-text: #fff;
    }

    body.dark-mode {
        --line: #4a4a4a;
        --bg: #1a1a1a;
        --panel: #2a2a2a;
        --muted: #bbb;
        --text-color: #f0f0f0;
        --highlight: #5b21b6;
        --selbar-bg: #1f2937;
        --selbar-text: #e5e7eb;
    }
    
    * { 
      box-sizing: border-box; 
      margin: 0;
      padding: 0;
    }

    html { font-size: 16px; }
    html.font-regular { font-size: 16px; }
    html.font-large { font-size: 18px; }
    html.font-xlarge { font-size: 20px; }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
      background: var(--bg);
      color: var(--text-color); 
      overflow: hidden;
      height: 100vh;
      transition: background-color 0.3s ease;
      padding-bottom: 64px;
    }

    .header {
        background-color: #e0e0e0;
        padding: 12px 20px;
        border-bottom: 2px solid var(--line);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        z-index: 100;
    }

    .dark-mode .header {
        background-color: #2a2a2a;
    }

    .header-content {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .header h1 {
        font-size: 1.2rem;
        font-weight: 500;
        color: #374151;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .dark-mode .header h1 {
        color: var(--text-color);
    }

    #timer {
        font-size: 1rem;
        font-weight: 500;
        background: white;
        padding: 6px 12px;
        border-radius: 6px;
        border: 1px solid var(--line);
        min-width: 90px;
        text-align: center;
        color: #333;
    }

    .dark-mode #timer {
        background: #3a3a3a;
        color: var(--text-color);
    }

    .header-controls {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .header-btn {
        background: white;
        border: 1px solid var(--line);
        border-radius: 6px;
        padding: 6px 12px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.2s ease;
        color: #333;
    }

    .dark-mode .header-btn {
        background: #3a3a3a;
        color: var(--text-color);
    }

    .header-btn:hover {
        background: #f1f5f9;
        border-color: var(--accent);
    }

    #settings-panel {
        position: absolute;
        top: 60px;
        right: 20px;
        width: 200px;
        background: var(--panel);
        border-radius: 12px;
        box-shadow: var(--shadow);
        border: 1px solid var(--line);
        z-index: 1000;
        padding: 8px;
        display: none;
    }

    .settings-group {
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--line);
    }

    .settings-title {
        font-size: 0.85rem;
        color: var(--muted);
        margin-bottom: 8px;
        padding-left: 12px;
    }

    .settings-option {
        display: block;
        width: 100%;
        text-align: left;
        padding: 8px 12px;
        border: none;
        background: none;
        cursor: pointer;
        font-size: 0.9rem;
        border-radius: 6px;
        color: var(--text-color);
    }

    .settings-option.active {
        background: #e9effd;
        color: var(--accent);
        font-weight: 500;
    }

    .dark-mode .settings-option.active {
        background: #1e3a8a;
    }

    #notes-panel {
        position: fixed;
        right: 12px;
        bottom: 76px;
        width: 320px;
        height: 45vh;
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: 12px;
        display: none;
        flex-direction: column;
        z-index: 900;
        box-shadow: var(--shadow);
        overflow: hidden;
    }

    #notes-panel header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        border-bottom: 1px solid var(--line);
        background-color: #f1f5f9;
    }

    .dark-mode #notes-panel header {
        background-color: #334155;
    }

    #notes-panel h3 {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-color);
        margin: 0;
    }

    #notes-panel textarea {
        flex: 1;
        border: 0;
        padding: 16px;
        resize: none;
        font-size: 0.95rem;
        background: transparent;
        color: var(--text-color);
        line-height: 1.6;
    }

    #notes-panel textarea:focus {
        outline: none;
    }

    #close-note {
        padding: 4px 8px;
        border-radius: 4px;
        border: 1px solid var(--line);
        background: transparent;
        cursor: pointer;
        color: var(--text-color);
        transition: background-color 0.2s;
    }

    #close-note:hover {
        background-color: rgba(0,0,0,0.1);
    }

    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.08);
        z-index: 800;
        display: none;
        backdrop-filter: blur(2px);
    }

    .dark-mode .overlay {
        background: rgba(0, 0, 0, 0.3);
    }
    
    /* Main Layout */
    .main-container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 58px - 64px);
    }
    
    /* Content Area with Draggable Divider */
    .content-wrapper {
      flex: 1;
      display: flex;
      overflow: hidden;
      position: relative;
    }
    
    .passage-pane {
      background: white;
      overflow-y: auto;
      padding: 24px;
      padding-bottom: 100px;
      flex: 0 0 50%;
      min-width: 300px;
    }
    
    #divider {
      width: 12px;
      background: #f9fafb;
      cursor: ew-resize;
      position: relative;
      user-select: none;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s ease;
    }
    
    #divider::before {
      content: '⋮⋮';
      position: absolute;
      color: #d1d5db;
      font-size: 12px;
      letter-spacing: -2px;
      font-weight: bold;
    }
    
    .questions-pane {
      background: #fbfbff;
      overflow-y: auto;
      padding: 24px;
      padding-bottom: 100px;
      flex: 1;
      min-width: 300px;
      border-left: 1px solid var(--line);
    }
    
    /* Text Styles */
    .passage-pane p {
      line-height: 1.7;
      margin-bottom: 12px;
      text-align: justify;
      color: #374151;
    }
    
    .questions-pane h3 {
      font-size: 15px;
      font-weight: 600;
      margin: 20px 0 8px;
      color: #374151;
    }
    
    .question-group {
      background: white;
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }
    
    .question-item {
        padding: 12px 0;
        border-bottom: 1px dashed var(--line);
    }
    .question-item:last-child {
        border-bottom: none;
    }
    
    /* Form Elements */
    .radio-options-list {
        list-style-type: none;
        padding-left: 0;
        margin-top: 10px;
    }
    .radio-options-list li {
        margin-bottom: 8px;
    }
    .radio-options-list label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
    }

    /* --- OPTIMIZED DRAG AND DROP STYLES --- */
    .summary-text p {
        line-height: 2.5;
    }
    .drop-target-summary {
        display: inline-flex; /* Use flexbox for centering */
        align-items: center;    /* Vertical center */
        justify-content: center; /* Horizontal center */
        width: 120px;
        height: 32px;
        border: 2px dashed var(--line);
        border-radius: 6px;
        vertical-align: middle;
        transition: background-color 0.2s, border-color 0.2s;
        position: relative;
        top: 8px;
    }
    .drop-target-summary.drag-over {
        background-color: #dbeafe;
        border-color: var(--accent);
    }
    #word-options {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        padding: 12px;
        border: 1px solid var(--line);
        border-radius: 8px;
        margin-top: 16px;
    }
    .draggable-word {
        padding: 6px 12px;
        background-color: #eef2ff;
        border: 1px solid #c7d2fe;
        border-radius: 6px;
        cursor: grab;
        transition: all 0.2s;
        font-size: 14px;
        user-select: none;
    }
    .draggable-word.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }
    /* Style for word once it's dropped */
    .drop-target-summary .draggable-word {
        background: transparent;
        border: none;
        padding: 0;
        cursor: default;
    }
    
    /* Highlight, Toolbar, and Notes Styles */
    .hl { background-color: var(--highlight); cursor: pointer; }

    .dark-mode .hl {
        color: #f5f3ff;
    }

    #selbar { 
      position: absolute; 
      display: none; 
      z-index: 6000; 
      background: var(--selbar-bg); 
      color: var(--selbar-text); 
      border-radius: 8px; 
      padding: 6px; 
      box-shadow: var(--shadow); 
      font-size: 13px; 
      gap: 6px; 
      align-items: center; 
    }
    #selbar button { 
      background: transparent; 
      color: var(--selbar-text); 
      border: 1px solid rgba(255,255,255,.25); 
      padding: 4px 8px; 
      border-radius: 6px; 
      cursor: pointer;
      font-size: 12px;
    }
    #selbar button:hover { 
      border-color: var(--selbar-text);
    }

    .practice-nav {
        background: var(--panel);
        padding: 12px 20px;
        display: flex;
        align-items: center;
        gap: 16px;
        box-shadow: 0 -2px 4px rgba(0,0,0,.05);
        flex-wrap: wrap;
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        border-top: 1px solid var(--line);
        z-index: 4000;
    }

    .practice-nav .title {
        font-weight: 600;
        color: var(--muted);
    }

    .practice-nav .questions {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
    }

    .practice-nav .q-item {
        padding: 6px 10px;
        border: 1px solid var(--line);
        border-radius: 6px;
        background: var(--panel);
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
        min-width: 36px;
        text-align: center;
        color: var(--text-color);
    }

    .practice-nav .q-item:hover {
        background: #f1f5f9;
        border-color: var(--accent);
    }

    .dark-mode .practice-nav .q-item:hover {
        background: #334155;
    }

    .practice-nav .q-item.answered {
        background: #e0e7ff;
        border-color: var(--accent);
        color: var(--accent);
        font-weight: 500;
    }

    .dark-mode .practice-nav .q-item.answered {
        background: #3949ab;
        border-color: var(--accent);
        color: #e8eaf6;
    }

    .practice-nav .q-item.active {
        background: var(--accent);
        color: #fff;
        border-color: var(--accent);
    }

    .practice-nav .q-item.correct {
        background: #22C55E;
        color: #fff;
        border-color: #10b981;
        font-weight: 600;
    }

    .practice-nav .q-item.incorrect {
        background: #DC2626;
        color: #fff;
        border-color: #ef4444;
        font-weight: 600;
    }

    .practice-nav .controls {
        margin-left: auto;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .practice-nav .controls button {
        padding: 8px 12px;
        border: 1px solid var(--line);
        border-radius: 6px;
        background: var(--panel);
        cursor: pointer;
        color: var(--text-color);
    }

    .practice-nav .controls button.primary {
        background: var(--accent);
        color: #fff;
        border-color: var(--accent);
    }

    .dark-mode .practice-nav .controls button {
        background: #3a3a3a;
    }

    .dark-mode .practice-nav .controls button.primary {
        background: var(--accent);
        color: #fff;
    }

    /* Toast & Results */
    #toast { position: fixed; left: 50%; transform: translateX(-50%); bottom: 80px; background: #111; color: #fff; padding: 10px 16px; border-radius: 8px; display: none; z-index: 2500; font-size: 14px; }
    #results { margin-top: 16px; padding: 16px; background: #f9fafb; border-radius: 8px; border: 1px solid var(--line); }
    #results h3 { font-size: 16px; font-weight: 600; margin-bottom: 12px; }
    .results-table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    .results-table th, .results-table td { border: 1px solid #e5e7eb; padding: 8px; text-align: center; font-size: 13px; }
    .results-table th { background: #f8fafc; font-weight: 600; }

    /* Buttons */
    .button-group { display: flex; gap: 8px; margin: 20px 0; margin-bottom: 30px; }
    button { padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; border: 1px solid var(--line); }
    .btn-primary { background: var(--accent); color: white; border-color: var(--accent); }
    .btn-primary:hover { background: #2563eb; }
    .btn-secondary { background: white; color: #374151; }
    .btn-secondary:hover { background: #f9fafb; }

    .empty-space {
        height: 24px;
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
        <h1>P3 - Jean Piaget (1896–1980)</h1>
        <div id="timer">00:00</div>
    </div>
    <div class="header-controls">
        <button class="header-btn" id="size-btn">Size</button>
        <button class="header-btn" id="color-btn">Color</button>
        <button class="header-btn" id="note-btn">Note</button>
    </div>
  </header>

  <div id="settings-panel">
    <div class="settings-group">
        <div class="settings-title">Font Size</div>
        <button class="settings-option active" data-size="regular">Regular</button>
        <button class="settings-option" data-size="large">Large</button>
        <button class="settings-option" data-size="xlarge">Extra Large</button>
    </div>
    <div class="settings-group">
        <div class="settings-title">Color Mode</div>
        <button class="settings-option active" data-mode="light">Black on White</button>
        <button class="settings-option" data-mode="dark">White on Black</button>
    </div>
  </div>

  <div id="notes-panel">
    <header>
        <h3>Notes</h3>
        <button id="close-note">Close</button>
    </header>
    <textarea placeholder="Write your notes here..."></textarea>
  </div>

  <div class="overlay"></div>

  <div class="main-container">
    <div class="content-wrapper">
      <div class="passage-pane" id="passage-pane">
        <h2>READING PASSAGE 3</h2>
        <p>You should spend about 20 minutes on Questions 27-40, which are based on Reading Passage 3 below.</p>
        <h3>Jean Piaget (1896–1980)</h3>
        <p><i>Seymour Papert looks at the work of the pioneering Swiss philosopher and psychologist</i></p>
        <div id="passage-text">
            <p>Jean Piaget spent much of his professional life listening to children, watching children and poring over reports of researchers around the world who were doing the same. He found, to put it most succinctly, that children don't think like grown-ups. After thousands of interactions with young people often barely old enough to talk, Piaget began to suspect that behind their cute and seemingly irrational utterances were thought processes that had their own kind of order and their own special logic. Einstein called it "a discovery so simple that only a genius could have thought of it."</p>
            <p>Although not an educational reformer, Piaget championed a way of thinking about children that provided the foundation for today's education-reform movements. It was a shift comparable to the way modern anthropology displaced stories of primitive tribes being 'noble savages' and 'cannibals'. One might say that Piaget was the first to take children's thinking seriously.</p>
            <p>He has been revered by generations of teachers inspired by the belief that children are not empty vessels to be filled with knowledge (as traditional pedagogical theory had it) but active builders of knowledge-little scientists who are constantly creating and testing their own hypotheses about the world. And though he may not be as famous as Sigmund Freud or even B. F. Skinner, his influence on psychology may be longer lasting.</p>
            <p>In 1920, while doing research in a child-psychology laboratory in Paris, Piaget noticed that children of the same age made similar errors on intelligence tests. Fascinated by their reasoning processes, he began to suspect that the key to human knowledge might be discovered by observing how the child's mind develops. On his return to Switzerland he began watching children play, scrupulously recording their words and actions as their minds raced to find reasons for why things are the way they are.</p>
            <p>In one of his most famous experiments, Piaget asked children, 'What makes the wind?' A typical dialogue would be:<br>Piaget: What makes the wind?<br>Julia: The trees.<br>Piaget: How do you know?<br>Julia: I saw them waving their arms.<br>Piaget: How does that make the wind?<br>Julia: (waving her hand in front of his face) Like this. Only they are bigger. And there are lots of trees.</p>
            <p>Piaget recognised that five-year-old Julia's beliefs, while not correct by any adult criterion, are not 'incorrect' either. They are entirely sensible and coherent within the framework of the child's way of knowing. Classifying them as 'true' or 'false' misses the point and shows a lack of respect for the child. What Piaget was after was a theory that the wind dialogue demonstrated coherence, ingenuity and the practice of a kind of explanatory principle (in this case by referring to body actions) that stands young children in very good stead when they don't know enough or don't have enough skill to handle the kind of explanation that grown-ups prefer.</p>
            <p>Piaget was not an educator and never laid down rules about how to intervene in such situations. But his work strongly suggests that the automatic reaction of putting the child right may well be counter-productive. If their theories are always greeted by 'Nice try, but this is how it really is...' they might give up after a while on making theories. As Piaget put it, 'children have real understanding only of that which they invent themselves, and each time that we try to teach them something too quickly, we keep them from inventing it themselves.'</p>
            <p>Disciples of Piaget have a tolerance for indeed a fascination with-children's primitive laws of physics: that things disappear when they are out of sight; that the moon and the sun follow you around; that big things float and small things sink. Einstein was intrigued by Piaget's findings, especially by the idea that seven-year-olds insist that going faster can take more time-perhaps because this, like Einstein's own theories of relativity, runs so contrary to common sense.</p>
            <p>Although every teacher in training still memorises Piaget's successive stages of childhood development, the greater part of Piaget's work is less well known, perhaps because schools of education regard it as 'too deep' for teachers. Piaget never thought of himself as a child psychologist. His real interest was epistemology-the theory of knowledge-which, like physics, was considered a branch of philosophy until Piaget came along and made it a science.</p>
            <p>Through epistemology, Piaget explored multiple ways of knowing. He acknowledged them and examined them non-judgementally, yet with a philosopher's analytic rigour. Since Piaget, the territory has been widely colonised by those who write about women's ways of knowing, Afrocentric ways of knowing, even the computer's ways of knowing. Indeed, artificial intelligence and the information-processing model of the mind owe more to Piaget than its proponents may realise.</p>
            <p>The core of Piaget is his belief that looking carefully at how knowledge develops in children will elucidate the nature of knowledge in general. Whether this has in fact led to deeper understanding remains, like everything about Piaget, controversial. In the past decade, Piaget has been vigorously challenged by the current fashion of viewing knowledge as an intrinsic property of the brain. Ingenious experiments have demonstrated that newborn infants already have some of the knowledge that Piaget believed children constructed. But for those, like me, who still see Piaget as the giant in the field of cognitive theory, the difference between what the baby brings and what the adult has is so immense that the new discoveries do not significantly reduce the gap, but only increase the mystery.</p>
        </div>
      </div>

      <div id="divider"></div>

      <div class="questions-pane" id="questions-pane">
        <h2>Questions</h2>

        <div class="question-group" id="q27-31-section">
          <h3>Questions 27–31</h3>
          <p style="margin-bottom: 12px;">Choose the correct letter, <strong>A, B, C or D</strong>.</p>
          <div class="question-item">
              <p><strong>27</strong> In the second paragraph, the writer mentions the example of modern anthropology to illustrate</p>
              <div style="display:flex; flex-wrap:wrap; gap:10px; margin:10px 0 4px 0;">
                <label style="margin:0;"><input name="q27" type="radio" value="A"> A the universality of Piaget's insights into the workings of the mind.</label>
                <label style="margin:0;"><input name="q27" type="radio" value="B"> B the similarity between children's thought-processing in different cultures.</label>
                <label style="margin:0;"><input name="q27" type="radio" value="C"> C how Piaget's work represents a crucial turning-point in our approach to education.</label>
                <label style="margin:0;"><input name="q27" type="radio" value="D"> D how Piaget's work has aided our understanding of humankind's evolution from primitive origins.</label>
              </div>
          </div>
          <div class="question-item">
              <p><strong>28</strong> According to the writer, what point is illustrated by the dialogue about the wind?</p>
              <div style="display:flex; flex-wrap:wrap; gap:10px; margin:10px 0 4px 0;">
                <label style="margin:0;"><input name="q28" type="radio" value="A"> A The factual accuracy of what children say is of minor significance.</label>
                <label style="margin:0;"><input name="q28" type="radio" value="B"> B Children want to learn about scientific principles.</label>
                <label style="margin:0;"><input name="q28" type="radio" value="C"> C Children's reasoning processes can be amusing to adults.</label>
                <label style="margin:0;"><input name="q28" type="radio" value="D"> D Children often pretend that they know the answers to questions.</label>
              </div>
          </div>
          <div class="question-item">
              <p><strong>29</strong> Piaget believed in the importance of</p>
              <div style="display:flex; flex-wrap:wrap; gap:10px; margin:10px 0 4px 0;">
                <label style="margin:0;"><input name="q29" type="radio" value="A"> A preventing children from making false assumptions.</label>
                <label style="margin:0;"><input name="q29" type="radio" value="B"> B giving children honest feedback on their hypotheses.</label>
                <label style="margin:0;"><input name="q29" type="radio" value="C"> C showing children how to formulate their own ideas about the world.</label>
                <label style="margin:0;"><input name="q29" type="radio" value="D"> D maintaining children's confidence in their ability to interpret the world.</label>
              </div>
          </div>
          <div class="question-item">
              <p><strong>30</strong> What does the writer suggest in the seventh paragraph?</p>
              <div style="display:flex; flex-wrap:wrap; gap:10px; margin:10px 0 4px 0;">
                <label style="margin:0;"><input name="q30" type="radio" value="A"> A Children's sense of their surroundings changes as they get older.</label>
                <label style="margin:0;"><input name="q30" type="radio" value="B"> B Children are able to grasp certain complex ideas as well as adults are.</label>
                <label style="margin:0;"><input name="q30" type="radio" value="C"> C Even apparently irrational ideas can be worthy of interest.</label>
                <label style="margin:0;"><input name="q30" type="radio" value="D"> D Sometimes the simplest explanations are the best.</label>
              </div>
          </div>
          <div class="question-item">
              <p><strong>31</strong> The writer's main purpose is to</p>
              <div style="display:flex; flex-wrap:wrap; gap:10px; margin:10px 0 4px 0;">
                <label style="margin:0;"><input name="q31" type="radio" value="A"> A outline Piaget's contribution to a range of scientific fields.</label>
                <label style="margin:0;"><input name="q31" type="radio" value="B"> B summarise how education has benefited from Piaget's findings.</label>
                <label style="margin:0;"><input name="q31" type="radio" value="C"> C discuss Piaget's role in the development of 20th-century psychology.</label>
                <label style="margin:0;"><input name="q31" type="radio" value="D"> D express doubts about a number of Piaget's theories.</label>
              </div>
          </div>
        </div>

        <div class="question-group" id="q32-36-section">
          <h3>Questions 32–36</h3>
          <p style="margin-bottom: 12px;">Complete the summary using the list of words below. Drag a word from the list and drop it into the correct blank.</p>
          <div class="summary-text">
            <p>
              Piaget maintained that children's mental processes were far more <span id="q32-target" class="drop-target-summary"></span> than they might appear. He encouraged the view that a child was not a 'blank slate' waiting to be filled with information, but rather a systematic builder of knowledge who regularly tries out his or her own <span id="q33-target" class="drop-target-summary"></span> about the world. Piaget's impact on the area of <span id="q34-target" class="drop-target-summary"></span> could well outlast that of more celebrated pioneers of this discipline. Despite doubts cast over his ideas by the current view associating knowledge exclusively with the <span id="q35-target" class="drop-target-summary"></span>, the effects of his work are still strong today. His principles are still widely used in the professional development of <span id="q36-target" class="drop-target-summary"></span>.
            </p>
          </div>
          <div id="word-options">
            <div id="word-A" class="draggable-word" draggable="true" data-word="correct">A correct</div>
            <div id="word-B" class="draggable-word" draggable="true" data-word="theories">B theories</div>
            <div id="word-C" class="draggable-word" draggable="true" data-word="brain">C brain</div>
            <div id="word-D" class="draggable-word" draggable="true" data-word="simple">D simple</div>
            <div id="word-E" class="draggable-word" draggable="true" data-word="teachers">E teachers</div>
            <div id="word-F" class="draggable-word" draggable="true" data-word="psychology">F psychology</div>
            <div id="word-G" class="draggable-word" draggable="true" data-word="logical">G logical</div>
            <div id="word-H" class="draggable-word" draggable="true" data-word="thought">H thought</div>
            <div id="word-I" class="draggable-word" draggable="true" data-word="philosophers">I philosophers</div>
          </div>
        </div>

        <div class="question-group" id="q37-40-section">
            <h3>Questions 37–40</h3>
            <p>Do the following statements agree with the claims of the writer? Write <strong>YES</strong>, <strong>NO</strong>, or <strong>NOT GIVEN</strong>.</p>
            <div class="question-item">
                <p><strong>37</strong> Piaget's early work in Paris involved innovative research techniques.</p>
                <div style="display:flex; flex-wrap:wrap; gap:10px; margin:10px 0 4px 0;">
                  <label style="margin:0;"><input name="q37" type="radio" value="YES"> YES</label>
                  <label style="margin:0;"><input name="q37" type="radio" value="NO"> NO</label>
                  <label style="margin:0;"><input name="q37" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
                </div>
            </div>
            <div class="question-item">
                <p><strong>38</strong> Piaget gave clear guidelines as to how adults should give information to children.</p>
                <div style="display:flex; flex-wrap:wrap; gap:10px; margin:10px 0 4px 0;">
                  <label style="margin:0;"><input name="q38" type="radio" value="YES"> YES</label>
                  <label style="margin:0;"><input name="q38" type="radio" value="NO"> NO</label>
                  <label style="margin:0;"><input name="q38" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
                </div>
            </div>
            <div class="question-item">
                <p><strong>39</strong> Piaget made a significant contribution to the field of epistemology.</p>
                <div style="display:flex; flex-wrap:wrap; gap:10px; margin:10px 0 4px 0;">
                  <label style="margin:0;"><input name="q39" type="radio" value="YES"> YES</label>
                  <label style="margin:0;"><input name="q39" type="radio" value="NO"> NO</label>
                  <label style="margin:0;"><input name="q39" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
                </div>
            </div>
            <div class="question-item">
                <p><strong>40</strong> We still have much to learn about the nature of knowledge.</p>
                <div style="display:flex; flex-wrap:wrap; gap:10px; margin:10px 0 4px 0;">
                  <label style="margin:0;"><input name="q40" type="radio" value="YES"> YES</label>
                  <label style="margin:0;"><input name="q40" type="radio" value="NO"> NO</label>
                  <label style="margin:0;"><input name="q40" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
                </div>
            </div>
        </div>
        
        <div class="button-group">
          <button onclick="submitAnswers()" class="btn-primary">Submit Answers</button>
          <button onclick="resetAll()" class="btn-secondary">Reset</button>
          <button onclick="toggleNotes()" class="btn-secondary">Notes</button> 
        </div>

        <div id="results"></div>
      </div>
    </div>
  </div>

  <div class="practice-nav">
    <div class="title">Questions</div>
    <div class="questions">
        <div class="q-item" id="q27-nav" onclick="scrollToQuestion('q27-31')">27</div>
        <div class="q-item" id="q28-nav" onclick="scrollToQuestion('q27-31')">28</div>
        <div class="q-item" id="q29-nav" onclick="scrollToQuestion('q27-31')">29</div>
        <div class="q-item" id="q30-nav" onclick="scrollToQuestion('q27-31')">30</div>
        <div class="q-item" id="q31-nav" onclick="scrollToQuestion('q27-31')">31</div>
        <div class="q-item" id="q32-nav" onclick="scrollToQuestion('q32-36')">32</div>
        <div class="q-item" id="q33-nav" onclick="scrollToQuestion('q32-36')">33</div>
        <div class="q-item" id="q34-nav" onclick="scrollToQuestion('q32-36')">34</div>
        <div class="q-item" id="q35-nav" onclick="scrollToQuestion('q32-36')">35</div>
        <div class="q-item" id="q36-nav" onclick="scrollToQuestion('q32-36')">36</div>
        <div class="q-item" id="q37-nav" onclick="scrollToQuestion('q37-40')">37</div>
        <div class="q-item" id="q38-nav" onclick="scrollToQuestion('q37-40')">38</div>
        <div class="q-item" id="q39-nav" onclick="scrollToQuestion('q37-40')">39</div>
        <div class="q-item" id="q40-nav" onclick="scrollToQuestion('q37-40')">40</div>
    </div>
    <div class="controls">
        <button id="submit-btn" class="primary">Submit</button>
        <button id="reset-btn">Reset</button>
        <button id="pause-btn">Pause</button>
    </div>
  </div>

  <div aria-label="Selection tools" id="selbar" role="toolbar">
    <button id="btnHL">Highlight</button>
    <button id="btnUH">Remove</button>
    <button id="btnNote">Note</button>
  </div>
  
  <div id="toast"></div>

  <script>
    (function() {
      // Global variables
      let settingsOpen = false, notesOpen = false;
      let timerRunning = true, seconds = 0, timer;
      let isResizing = false;
      let userAnswers = {};

      // --- STATE & CONFIG ---
      let timeLeft = 20 * 60;
      let timerInterval;
      const correctAnswers = { "q27": "C", "q28": "A", "q29": "D", "q30": "C", "q31": "A", "q32": "logical", "q33": "theories", "q34": "psychology", "q35": "brain", "q36": "teachers", "q37": "NOT GIVEN", "q38": "NO", "q39": "YES", "q40": "YES" };
      
      // --- DOM ELEMENTS ---
      const passagePane = document.getElementById('passage-pane');
      const questionsPane = document.getElementById('questions-pane');
      const notesPanel = document.getElementById('notes-panel');
      const noteArea = notesPanel.querySelector('textarea');
      const selbar = document.getElementById('selbar');

      // --- SELECTION STATE ---
      let lastRange = null;
      let currentHlNode = null;
      let keepToolbar = false;

      // Timer functionality - Updated to use the pyramid timer style
      function startTimer() {
          timer = setInterval(() => {
              if (timerRunning) {
                  seconds++;
                  updateTimer();
              }
          }, 1000);
      }

      function updateTimer() {
          const minutes = String(Math.floor(seconds / 60)).padStart(2, '0');
          const secs = String(seconds % 60).padStart(2, '0');
          document.getElementById('timer').textContent = `${minutes}:${secs}`;
      }

      // --- HELPER FUNCTIONS ---
      function showToast(msg) {
        const el = document.getElementById('toast');
        el.textContent = msg;
        el.style.display = 'block';
        setTimeout(() => { el.style.display = 'none'; }, 2000);
      }

      // Panel management
      function closeAllPanels() {
          notesOpen = false;
          settingsOpen = false;
          document.getElementById('notes-panel').style.display = 'none';
          document.getElementById('settings-panel').style.display = 'none';
          document.querySelector('.overlay').style.display = 'none';
      }
      
      window.scrollToQuestion = function(qid) {
        const element = document.getElementById(`${qid}-section`);
        if (element && questionsPane) {
            const top = element.offsetTop - questionsPane.offsetTop - 20;
            questionsPane.scrollTo({ top, behavior: 'smooth' });
        }

        // Update navigation
        document.querySelectorAll('.practice-nav .q-item').forEach(n => n.classList.remove('active'));
        const btn = document.getElementById(qid.replace('-section', '') + '-nav');
        if (btn) {
            btn.classList.add('active');
            setTimeout(() => btn.classList.remove('active'), 800);
        }
      }
      
      window.toggleNotes = function() {
        closeAllPanels();
        notesOpen = true;
        document.getElementById('notes-panel').style.display = 'flex';
        document.querySelector('.overlay').style.display = 'block';
      }

      function positionSelbarForRect(rect) {
        selbar.style.display = 'flex';
        requestAnimationFrame(() => {
          const top = window.scrollY + rect.top - selbar.offsetHeight - 8;
          const left = window.scrollX + rect.left + rect.width / 2 - selbar.offsetWidth / 2;
          selbar.style.top = `${(top > 0) ? top : (window.scrollY + rect.bottom + 8)}px`;
          selbar.style.left = `${Math.max(8, left)}px`;
        });
      }

      function updateSelbar() {
        const sel = window.getSelection();
        if (!sel || sel.rangeCount === 0 || sel.isCollapsed) {
            if (!keepToolbar && !currentHlNode) {
                selbar.style.display = 'none';
                currentHlNode = null;
            }
            return;
        }
        const range = sel.getRangeAt(0);
        
        // Check if selected text is within the left or right panel
        const container = range.commonAncestorContainer;
        const containerElement = container.nodeType === Node.TEXT_NODE ? container.parentElement : container;
        
        const isInPassage = passagePane.contains(containerElement);
        const isInQuestions = questionsPane.contains(containerElement);
        const isHighlighted = containerElement.classList?.contains('hl') || 
                             containerElement.closest('.hl') !== null ||
                             range.toString().trim().length > 0;
        
        if ((!isInPassage && !isInQuestions) && !isHighlighted) {
            selbar.style.display = 'none';
            return;
        }
        
        // Check if the selection touches any highlighted text
        const highlightedElements = document.querySelectorAll('.hl');
        let touchesHighlight = false;
        
        highlightedElements.forEach(hlElement => {
            if (range.intersectsNode(hlElement)) {
                touchesHighlight = true;
            }
        });
        
        lastRange = range.cloneRange();
        currentHlNode = touchesHighlight ? range.startContainer.parentElement?.closest('.hl') : null;
        positionSelbarForRect(range.getBoundingClientRect());
      }

      // --- CORE LOGIC FUNCTIONS ---
      function updateAnsweredState() {
        for (let i = 27; i <= 40; i++) {
          const qid = 'q' + i;
          const navItem = document.getElementById(qid + '-nav');
          if (!navItem || navItem.classList.contains('correct') || navItem.classList.contains('incorrect')) continue;

          let hasAnswer = false;
          if (i >= 32 && i <= 36) {
            const placeholder = document.getElementById(`${qid}-target`);
            hasAnswer = !!placeholder.firstChild;
          } else {
            const radio = document.querySelector(`input[name="${qid}"]:checked`);
            hasAnswer = !!radio;
          }
          navItem.classList.toggle('answered', hasAnswer);
        }
      }
      
      window.submitAnswers = function() {
        clearInterval(timerInterval);
        timerRunning = false;
        let score = 0;
        const totalQuestions = 14;
        const resultsData = [];

        for (let i = 27; i <= 40; i++) {
          const qid = 'q' + i;
          let userAnswer = '—';
          if (i >= 32 && i <= 36) {
            const placeholder = document.getElementById(`${qid}-target`);
            if (placeholder.firstChild) {
              userAnswer = placeholder.firstChild.dataset.word;
            }
          } else {
            const radio = document.querySelector(`input[name="${qid}"]:checked`);
            if (radio) userAnswer = radio.value;
          }
          
          const isCorrect = userAnswer.toLowerCase() === (correctAnswers[qid] || '').toLowerCase();
          if (isCorrect) score++;
          resultsData.push({ num: i, userAnswer, correctAnswer: correctAnswers[qid], isCorrect, navId: qid + '-nav' });
        }
        
        resultsData.forEach(result => {
          const nav = document.getElementById(result.navId);
          if (nav) {
            nav.classList.remove('answered');
            nav.classList.add(result.isCorrect ? 'correct' : 'incorrect');
          }
        });

        const percentage = Math.round((score / totalQuestions) * 100);
        const resultsDiv = document.getElementById('results');
        const tableRows = resultsData.map(r => `
          <tr>
            <td>${r.num}</td>
            <td>${r.userAnswer}</td>
            <td>${r.correctAnswer}</td>
            <td style="color: ${r.isCorrect ? '#22C55E' : '#DC2626'};">${r.isCorrect ? '✓ Correct' : '✗ Incorrect'}</td>
          </tr>`).join('');
        
        resultsDiv.innerHTML = `<h3>Results</h3>
          <p><b>Score: ${score}/${totalQuestions} (${percentage}%)</b></p>
          <table class="results-table"><thead><tr><th>Question</th><th>Your Answer</th><th>Correct Answer</th><th>Result</th></tr></thead><tbody>${tableRows}</tbody></table>`;
        resultsDiv.scrollIntoView({ behavior: 'smooth' });

        // Update timer display
        document.getElementById('pause-btn').textContent = 'Continue';
      }

      window.resetAll = function() {
        document.querySelectorAll('input[type="radio"]').forEach(i => i.checked = false);
        const wordOptionsContainer = document.getElementById('word-options');
        document.querySelectorAll('.draggable-word').forEach(word => {
            wordOptionsContainer.appendChild(word);
        });
        document.querySelectorAll('.q-item').forEach(nav => nav.className = 'q-item');
        document.getElementById('results').innerHTML = '';
        document.querySelectorAll('.hl').forEach(h => {
            const parent = h.parentNode;
            while(h.firstChild) parent.insertBefore(h.firstChild, h);
            parent.removeChild(h);
            parent.normalize();
        });
        if (noteArea) noteArea.value = '';
        
        // Reset timer
        seconds = 0;
        updateTimer();
        timerRunning = true;
        document.getElementById('pause-btn').textContent = 'Pause';
        startTimer();
        
        showToast('Test has been reset.');
        updateAnsweredState();
      }
      
      // --- EVENT LISTENERS ---
      document.addEventListener('DOMContentLoaded', () => {
        startTimer();
        updateAnsweredState();

        // Header button events
        document.getElementById('size-btn').addEventListener('click', () => {
            settingsOpen = !settingsOpen;
            document.getElementById('settings-panel').style.display = settingsOpen ? 'block' : 'none';
        });

        document.getElementById('color-btn').addEventListener('click', () => {
            settingsOpen = !settingsOpen;
            document.getElementById('settings-panel').style.display = settingsOpen ? 'block' : 'none';
        });

        document.getElementById('note-btn').addEventListener('click', () => {
            closeAllPanels();
            notesOpen = true;
            document.getElementById('notes-panel').style.display = 'flex';
            document.querySelector('.overlay').style.display = 'block';
        });

        // Settings options
        document.querySelectorAll('.settings-option[data-size]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.documentElement.className = `font-${this.dataset.size}`;
                document.querySelectorAll('.settings-option[data-size]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            });
        });

        document.querySelectorAll('.settings-option[data-mode]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.body.classList.toggle('dark-mode', this.dataset.mode === 'dark');
                document.querySelectorAll('.settings-option[data-mode]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // Panel close events
        document.getElementById('close-note').addEventListener('click', closeAllPanels);
        document.querySelector('.overlay').addEventListener('click', closeAllPanels);

        // Click outside to close panels
        document.addEventListener('click', (e) => {
            const panels = [
                document.getElementById('notes-panel'),
                document.getElementById('settings-panel')
            ];
            const buttons = [
                document.getElementById('size-btn'),
                document.getElementById('color-btn'),
                document.getElementById('note-btn')
            ];
            
            const isClickInside = panels.some(p => p.contains(e.target)) || 
                                buttons.some(b => b.contains(e.target));
            
            if (!isClickInside) {
                closeAllPanels();
            }
        });

        // Control buttons
        document.getElementById('submit-btn').addEventListener('click', submitAnswers);
        document.getElementById('reset-btn').addEventListener('click', resetAll);
        document.getElementById('pause-btn').addEventListener('click', function() {
            timerRunning = !timerRunning;
            this.textContent = timerRunning ? 'Pause' : 'Continue';
        });

        questionsPane.addEventListener('change', updateAnsweredState);

        // --- HIGHLIGHT & SELECTION LISTENERS ---
        document.addEventListener('mouseup', () => {
            setTimeout(updateSelbar, 10);
        });
        
        document.addEventListener('selectionchange', () => {
            setTimeout(() => {
                const sel = window.getSelection();
                if (!sel || sel.rangeCount === 0 || sel.isCollapsed) {
                    if (!keepToolbar && !currentHlNode) {
                        selbar.style.display = 'none';
                    }
                } else {
                    updateSelbar();
                }
            }, 10);
        });

        document.addEventListener('mousedown', (e) => {
            keepToolbar = e.target.classList?.contains('hl');
        }, true);

        document.addEventListener('click', (e) => {
            const target = e.target;
            if (target.classList?.contains('hl')) {
                currentHlNode = target;
                lastRange = null;
                positionSelbarForRect(target.getBoundingClientRect());
                window.getSelection()?.removeAllRanges();
                setTimeout(() => { keepToolbar = false; }, 0);
            } else if (!selbar.contains(e.target)) {
                selbar.style.display = 'none';
                currentHlNode = null;
            }
        }, true);
        
        document.getElementById('btnHL').addEventListener('click', () => {
            if (currentHlNode || !lastRange || lastRange.collapsed) return;

            const sel = window.getSelection();
            let range = lastRange.cloneRange();

            try {
                const span = document.createElement('span');
                span.className = 'hl';
                range.surroundContents(span);
            } catch (e) {
                try {
                    range = lastRange.cloneRange();
                    const ancestor = range.commonAncestorContainer;
                    const walker = document.createTreeWalker(ancestor, NodeFilter.SHOW_TEXT);
                    let nodesToWrap = [];
                    
                    while (walker.nextNode()) {
                        if (range.intersectsNode(walker.currentNode)) {
                            nodesToWrap.push(walker.currentNode);
                        }
                    }
                    
                    nodesToWrap.forEach(node => {
                        let nodeToWrap = node;
                        if (node === range.endContainer && range.endOffset < node.length) {
                            node.splitText(range.endOffset);
                        }
                        if (node === range.startContainer && range.startOffset > 0) {
                            nodeToWrap = node.splitText(range.startOffset);
                        }
                        if (nodeToWrap.parentNode && nodeToWrap.nodeValue.trim()) {
                            const span = document.createElement('span');
                            span.className = 'hl';
                            nodeToWrap.parentNode.insertBefore(span, nodeToWrap);
                            span.appendChild(nodeToWrap);
                        }
                    });
                    
                    if (ancestor.normalize) ancestor.normalize();
                } catch (e2) {
                    console.error("Highlighting failed:", e, e2);
                    showToast('Highlighting failed');
                    return;
                }
            }
            
            sel?.removeAllRanges();
            selbar.style.display = 'none';
            showToast('Highlighted');
        });

        document.getElementById('btnUH').addEventListener('click', () => {
            const sel = window.getSelection();
            if (currentHlNode) {
                const p = currentHlNode.parentNode;
                while (currentHlNode.firstChild) {
                    p.insertBefore(currentHlNode.firstChild, currentHlNode);
                }
                p.removeChild(currentHlNode);
                p.normalize();
            } else if (lastRange) {
                const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_ELEMENT);
                let toRemove = [];
                while (walker.nextNode()) {
                    const n = walker.currentNode;
                    if (n.classList?.contains('hl') && lastRange.intersectsNode(n)) {
                        toRemove.push(n);
                    }
                }
                toRemove.forEach(el => {
                    const p = el.parentNode;
                    while (el.firstChild) {
                        p.insertBefore(el.firstChild, el);
                    }
                    p.removeChild(el);
                    p.normalize();
                });
            }
            
            currentHlNode = null;
            sel?.removeAllRanges();
            selbar.style.display = 'none';
            showToast('Highlight removed');
        });
        
        document.getElementById('btnNote').addEventListener('click', () => {
            let text = '';
            if (currentHlNode) {
                text = (currentHlNode.textContent || '').trim();
            } else if (lastRange) {
                text = (lastRange.cloneContents().textContent || '').trim();
            }
            if (text) {
                closeAllPanels();
                notesOpen = true;
                document.getElementById('notes-panel').style.display = 'flex';
                document.querySelector('.overlay').style.display = 'block';
                const noteAreaEl = document.querySelector('#notes-panel textarea');
                noteAreaEl.value += (noteAreaEl.value ? '\n\n' : '') + '> ' + text;
                noteAreaEl.scrollTop = noteAreaEl.scrollHeight;
            }
            selbar.style.display = 'none';
        });

        // --- DRAG AND DROP LISTENERS ---
        const draggables = document.querySelectorAll('.draggable-word');
        const dropTargets = document.querySelectorAll('.drop-target-summary');
        const wordOptionsContainer = document.getElementById('word-options');

        draggables.forEach(draggable => {
            draggable.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', e.target.id);
                setTimeout(() => e.target.classList.add('dragging'), 0);
                selbar.style.display = 'none';
            });
            draggable.addEventListener('dragend', (e) => {
                e.target.classList.remove('dragging');
            });
        });

        dropTargets.forEach(target => {
            target.addEventListener('dragover', e => { e.preventDefault(); target.classList.add('drag-over'); });
            target.addEventListener('dragleave', () => target.classList.remove('drag-over'));
            target.addEventListener('drop', e => {
                e.preventDefault();
                target.classList.remove('drag-over');
                const id = e.dataTransfer.getData('text/plain');
                const draggable = document.getElementById(id);
                if (target.firstChild) {
                    wordOptionsContainer.appendChild(target.firstChild);
                }
                target.appendChild(draggable);
                updateAnsweredState();
            });
        });
        
        wordOptionsContainer.addEventListener('dragover', e => e.preventDefault());
        wordOptionsContainer.addEventListener('drop', e => {
            e.preventDefault();
            const id = e.dataTransfer.getData('text/plain');
            const draggable = document.getElementById(id);
            wordOptionsContainer.appendChild(draggable);
            updateAnsweredState();
        });
      });
    })();
  </script>


\n
  <script>
/**
 * 练习页面增强器 - 统一版本
 * 整合了原有的practicePageManager功能，解决数据收集和正确答案提取问题
 */

if (!window.practicePageEnhancer) {
    console.log('[PracticeEnhancer] 初始化增强器');

    // 内嵌CorrectAnswerExtractor功能，确保在练习页面中可用
    if (!window.CorrectAnswerExtractor) {
        window.CorrectAnswerExtractor = class {
            constructor() {
                this.extractionStrategies = [
                    this.extractFromAnswersObject.bind(this),
                    this.extractFromResultsTable.bind(this),
                    this.extractFromDOM.bind(this),
                    this.extractFromScripts.bind(this)
                ];
            }

            extractFromPage(document = window.document) {
                console.log('[CorrectAnswerExtractor] 开始提取正确答案');
                
                for (const strategy of this.extractionStrategies) {
                    try {
                        const answers = strategy(document);
                        if (answers && Object.keys(answers).length > 0) {
                            console.log('[CorrectAnswerExtractor] 提取成功:', strategy.name, answers);
                            return this.normalizeAnswers(answers);
                        }
                    } catch (error) {
                        console.warn(`[CorrectAnswerExtractor] 策略 ${strategy.name} 失败:`, error);
                    }
                }
                
                console.warn('[CorrectAnswerExtractor] 所有提取策略都失败了');
                return {};
            }

            extractFromAnswersObject(document = window.document) {
                const win = document.defaultView || window;
                
                const possibleAnswerObjects = [
                    'answers', 'correctAnswers', 'examAnswers', 'questionAnswers', 'solutionAnswers'
                ];
                
                for (const objName of possibleAnswerObjects) {
                    if (win[objName] && typeof win[objName] === 'object') {
                        console.log(`[CorrectAnswerExtractor] 找到全局对象: ${objName}`);
                        return win[objName];
                    }
                }
                
                return this.extractFromScriptVariables(document);
            }

            extractFromScriptVariables(document = window.document) {
                const scripts = document.querySelectorAll('script');
                
                for (const script of scripts) {
                    const content = script.textContent || script.innerHTML;
                    
                    const correctAnswersMatch = content.match(/(?:const|let|var)\s+correctAnswers\s*=\s*(\{[^}]+\})/s);
                    if (correctAnswersMatch) {
                        try {
                            const answersStr = correctAnswersMatch[1];
                            const answers = this.parseAnswersObject(answersStr);
                            if (answers && Object.keys(answers).length > 0) {
                                console.log('[CorrectAnswerExtractor] 从脚本变量提取答案:', answers);
                                return answers;
                            }
                        } catch (error) {
                            console.warn('[CorrectAnswerExtractor] 解析脚本变量失败:', error);
                        }
                    }
                }
                
                return null;
            }

            parseAnswersObject(objectStr) {
                try {
                    let cleanStr = objectStr
                        .replace(/\/\/.*$/gm, '')
                        .replace(/\/\*[\s\S]*?\*\//g, '')
                        .trim();
                    
                    if (cleanStr.startsWith('{') && cleanStr.endsWith('}')) {
                        cleanStr = cleanStr.replace(/([{,]\s*)([a-zA-Z_$][a-zA-Z0-9_$]*)\s*:/g, '$1"$2":');
                        return JSON.parse(cleanStr);
                    }
                } catch (error) {
                    console.warn('[CorrectAnswerExtractor] JSON解析失败，尝试其他方法:', error);
                }
                
                return this.manualParseAnswers(objectStr);
            }

            manualParseAnswers(objectStr) {
                const answers = {};
                const keyValuePattern = /([a-zA-Z0-9_]+)\s*:\s*['"`]([^'"`]+)['"`]/g;
                let match;
                
                while ((match = keyValuePattern.exec(objectStr)) !== null) {
                    const key = match[1];
                    const value = match[2];
                    answers[key] = value;
                }
                
                return Object.keys(answers).length > 0 ? answers : null;
            }

            extractFromResultsTable(document = window.document) {
                const selectors = [
                    '.results-table', '.answer-table', '.score-table',
                    'table[class*="result"]', 'table[class*="answer"]',
                    '.exam-results table', '#results table'
                ];
                
                for (const selector of selectors) {
                    const table = document.querySelector(selector);
                    if (table) {
                        return this.parseAnswersFromTable(table);
                    }
                }
                
                return null;
            }

            extractFromDOM(document = window.document) {
                const answers = {};
                const answerSelectors = [
                    '[data-correct-answer]', '.correct-answer', '.solution',
                    '[class*="correct"]', '[id*="correct"]'
                ];
                
                for (const selector of answerSelectors) {
                    const elements = document.querySelectorAll(selector);
                    elements.forEach((el, index) => {
                        const questionId = this.extractQuestionId(el) || `q${index + 1}`;
                        const answer = this.extractAnswerFromElement(el);
                        if (answer) {
                            answers[questionId] = answer;
                        }
                    });
                }
                
                return Object.keys(answers).length > 0 ? answers : null;
            }

            extractFromScripts(document = window.document) {
                const scripts = document.querySelectorAll('script');
                
                for (const script of scripts) {
                    const content = script.textContent || script.innerHTML;
                    if (content.includes('answer') || content.includes('correct')) {
                        try {
                            const jsonMatch = content.match(/(?:answers?|correct)\s*[:=]\s*(\{[^}]+\}|\[[^\]]+\])/i);
                            if (jsonMatch) {
                                const answers = JSON.parse(jsonMatch[1]);
                                if (answers && typeof answers === 'object') {
                                    return answers;
                                }
                            }
                        } catch (error) {
                            // 继续尝试其他方法
                        }
                    }
                }
                
                return null;
            }

            parseAnswersFromTable(table) {
                const answers = {};
                const rows = table.querySelectorAll('tr');
                
                for (const row of rows) {
                    const cells = row.querySelectorAll('td, th');
                    if (cells.length >= 2) {
                        const questionCell = cells[0];
                        const answerCell = this.findAnswerCell(cells);
                        
                        if (answerCell) {
                            const questionId = this.extractQuestionId(questionCell);
                            const answer = this.extractAnswerFromElement(answerCell);
                            
                            if (questionId && answer) {
                                answers[questionId] = answer;
                            }
                        }
                    }
                }
                
                return Object.keys(answers).length > 0 ? answers : null;
            }

            findAnswerCell(cells) {
                for (let i = 1; i < cells.length; i++) {
                    const cell = cells[i];
                    const text = cell.textContent.toLowerCase();
                    const className = cell.className.toLowerCase();
                    
                    if (text.includes('correct') || text.includes('answer') || 
                        className.includes('correct') || className.includes('answer') ||
                        text.includes('正确') || text.includes('答案')) {
                        return cell;
                    }
                }
                
                return cells[1];
            }

            extractQuestionId(element) {
                if (element.dataset.questionId) {
                    return element.dataset.questionId;
                }
                
                if (element.id) {
                    const match = element.id.match(/q(\d+)|question[_-]?(\d+)/i);
                    if (match) {
                        return `q${match[1] || match[2]}`;
                    }
                }
                
                const text = element.textContent;
                const match = text.match(/(?:问题|题目|Question)\s*[#:]?\s*(\d+)|^(\d+)[.)]/);
                if (match) {
                    return `q${match[1] || match[2]}`;
                }
                
                return null;
            }

            extractAnswerFromElement(element) {
                if (element.dataset.correctAnswer) {
                    return element.dataset.correctAnswer;
                }
                
                if (element.dataset.answer) {
                    return element.dataset.answer;
                }
                
                let text = element.textContent.trim();
                text = text.replace(/^(?:正确答案[:：]?|答案[:：]?|Correct Answer[:：]?|Answer[:：]?)\s*/i, '');
                
                if (/^(true|false)$/i.test(text)) {
                    return text.toUpperCase();
                }
                
                if (/^[A-Z]$/i.test(text)) {
                    return text.toUpperCase();
                }
                
                return text;
            }

            normalizeAnswers(answers) {
                const normalized = {};
                
                for (const [key, value] of Object.entries(answers)) {
                    const normalizedKey = key.toString().toLowerCase().startsWith('q') 
                        ? key 
                        : `q${key}`;
                    
                    let normalizedValue = value;
                    if (typeof value === 'string') {
                        normalizedValue = value.trim();
                        
                        if (/^(true|t|yes|y|正确|是)$/i.test(normalizedValue)) {
                            normalizedValue = 'TRUE';
                        } else if (/^(false|f|no|n|错误|否)$/i.test(normalizedValue)) {
                            normalizedValue = 'FALSE';
                        }
                        
                        if (/^[A-Z]$/i.test(normalizedValue)) {
                            normalizedValue = normalizedValue.toUpperCase();
                        }
                    }
                    
                    normalized[normalizedKey] = normalizedValue;
                }
                
                return normalized;
            }
        };
    }

    window.practicePageEnhancer = {
        sessionId: null,
        parentWindow: null,
        answers: {},
        correctAnswers: {},
        interactions: [],
        startTime: Date.now(),
        isInitialized: false,

        initialize: function () {
            if (this.isInitialized) {
                console.log('[PracticeEnhancer] 已经初始化，跳过');
                return;
            }
            console.log('[PracticeEnhancer] 开始初始化');
            this.setupCommunication();
            this.setupAnswerListeners();
            this.extractCorrectAnswers(); // 新增：提取正确答案
            this.interceptSubmit();
            this.setupInteractionTracking();
            this.isInitialized = true;
            console.log('[PracticeEnhancer] 初始化完成');
            
            // 页面加载完成后进行一次初始收集
            if (document.readyState === 'complete') {
                setTimeout(() => this.collectAllAnswers(), 1000);
            } else {
                window.addEventListener('load', () => {
                    setTimeout(() => this.collectAllAnswers(), 1000);
                });
            }
        },

        cleanup: function() {
            console.log('[PracticeEnhancer] 清理资源');
            if (this.answerCollectionInterval) {
                clearInterval(this.answerCollectionInterval);
                this.answerCollectionInterval = null;
            }
        },

        setupCommunication: function () {
            this.parentWindow = window.opener || window.parent;
            if (!this.parentWindow || this.parentWindow === window) {
                console.warn('[PracticeEnhancer] 未检测到父窗口');
                return;
            }
            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'INIT_SESSION') {
                    this.sessionId = event.data.data.sessionId;
                    console.log('[PracticeEnhancer] 收到会话初始化:', this.sessionId);
                    this.sendMessage('SESSION_READY', {
                        pageType: this.detectPageType(),
                        url: window.location.href,
                        title: document.title
                    });
                }
            });
            console.log('[PracticeEnhancer] 通信设置完成');
        },

        detectPageType: function () {
            const title = document.title || '';
            const url = window.location.href || '';
            if (title.includes('P1') || url.includes('P1')) return 'P1';
            if (title.includes('P2') || url.includes('P2')) return 'P2';
            if (title.includes('P3') || url.includes('P3')) return 'P3';
            const pathParts = url.split('/');
            for (let part of pathParts) {
                if (part.match(/^P[123]$/i)) {
                    return part.toUpperCase();
                }
            }
            return 'unknown';
        },

        extractCorrectAnswers: function () {
            console.log('[PracticeEnhancer] 开始提取正确答案');
            
            // 使用CorrectAnswerExtractor如果可用
            if (window.CorrectAnswerExtractor) {
                try {
                    const extractor = new CorrectAnswerExtractor();
                    const extractedAnswers = extractor.extractFromPage(document);
                    
                    if (extractedAnswers && Object.keys(extractedAnswers).length > 0) {
                        this.correctAnswers = extractedAnswers;
                        console.log('[PracticeEnhancer] 使用提取器成功获得正确答案:', this.correctAnswers);
                    } else {
                        console.warn('[PracticeEnhancer] 提取器未找到答案，使用备用方法');
                        this.extractCorrectAnswersBackup();
                    }
                } catch (error) {
                    console.warn('[PracticeEnhancer] 提取器失败，使用备用方法:', error);
                    this.extractCorrectAnswersBackup();
                }
            } else {
                console.warn('[PracticeEnhancer] CorrectAnswerExtractor未加载，使用备用方法');
                this.extractCorrectAnswersBackup();
            }
            
            // 延迟提取，在页面完全加载后再次尝试
            setTimeout(function() {
                this.extractFromResultsTable();
            }.bind(this), 2000);
            
            // 定期检查是否有新的正确答案数据
            this.startCorrectAnswerMonitoring();
        },

        extractCorrectAnswersBackup: function () {
            // 多种备用提取方法
            const sources = ['answers', 'correctAnswers', 'answerKey', 'solutions'];
            
            for (const source of sources) {
                if (window[source] && typeof window[source] === 'object') {
                    Object.keys(window[source]).forEach(key => {
                        const value = window[source][key];
                        if (value !== undefined && value !== null) {
                            let normalizedKey = key;
                            if (!normalizedKey.startsWith('q') && /^\d+$/.test(normalizedKey)) {
                                normalizedKey = 'q' + normalizedKey;
                            }
                            this.correctAnswers[normalizedKey] = String(value).trim();
                        }
                    });
                }
            }
            
            // 尝试从DOM中提取
            this.extractFromDOM();
            
            console.log('[PracticeEnhancer] 备用方法提取正确答案:', this.correctAnswers);
        },

        extractFromDOM: function () {
            // 查找包含正确答案的元素
            const selectors = [
                '[data-correct-answer]',
                '.correct-answer',
                '.answer-key',
                '[data-answer]'
            ];
            
            const self = this;
            for (let i = 0; i < selectors.length; i++) {
                const selector = selectors[i];
                const elements = document.querySelectorAll(selector);
                for (let j = 0; j < elements.length; j++) {
                    const element = elements[j];
                    const questionId = element.dataset.question || 
                                     element.dataset.for || 
                                     element.dataset.questionId;
                    const correctAnswer = element.dataset.correctAnswer || 
                                        element.dataset.answer || 
                                        element.textContent.trim();
                    
                    if (questionId && correctAnswer) {
                        self.correctAnswers[questionId] = correctAnswer;
                    }
                }
            }
        },

        extractFromResultsTable: function () {
            console.log('[PracticeEnhancer] 尝试从结果表格提取正确答案');
            
            // 查找结果显示区域
            const resultsEl = document.getElementById('results');
            if (!resultsEl) {
                console.log('[PracticeEnhancer] 未找到results元素');
                return;
            }
            
            // 查找表格
            const tables = resultsEl.querySelectorAll('table');
            console.log('[PracticeEnhancer] 找到表格数量:', tables.length);
            
            for (let i = 0; i < tables.length; i++) {
                const table = tables[i];
                const rows = table.querySelectorAll('tr');
                console.log('[PracticeEnhancer] 表格', i, '行数:', rows.length);
                
                for (let j = 1; j < rows.length; j++) { // 跳过表头
                    const row = rows[j];
                    const cells = row.querySelectorAll('td');
                    
                    if (cells.length >= 3) {
                        const questionCell = cells[0];
                        const userAnswerCell = cells[1];
                        const correctAnswerCell = cells[2];
                        
                        const questionText = questionCell.textContent.trim();
                        const userAnswer = userAnswerCell.textContent.trim();
                        const correctAnswer = correctAnswerCell.textContent.trim();
                        
                        console.log('[PracticeEnhancer] 处理行:', questionText, userAnswer, correctAnswer);
                        
                        // 提取问题编号
                        const questionMatch = questionText.match(/(\d+)/);
                        if (questionMatch && correctAnswer && correctAnswer !== 'N/A' && correctAnswer !== '') {
                            const questionNum = questionMatch[1];
                            const questionKey = 'q' + questionNum;
                            this.correctAnswers[questionKey] = correctAnswer;
                            
                            // 同时更新用户答案，确保数据一致性
                            if (userAnswer && userAnswer !== 'No Answer') {
                                this.answers[questionKey] = userAnswer;
                            }
                            
                            console.log('[PracticeEnhancer] 从表格提取:', questionKey, '用户答案:', userAnswer, '正确答案:', correctAnswer);
                        }
                    }
                }
            }
            
            console.log('[PracticeEnhancer] 表格提取完成，正确答案:', this.correctAnswers);
            console.log('[PracticeEnhancer] 表格提取完成，用户答案:', this.answers);
        },

        setupAnswerListeners: function () {
            const self = this;
            
            // 增强的change事件监听
            document.addEventListener('change', function(e) {
                self.recordAnswer(e.target);
            });

            // 增强的input事件监听
            document.addEventListener('input', function(e) {
                self.recordAnswer(e.target);
            });

            // 点击事件监听（用于单选框、复选框）
            document.addEventListener('click', function(e) {
                if (e.target.type === 'radio' || e.target.type === 'checkbox') {
                    setTimeout(() => self.recordAnswer(e.target), 10);
                }
            });

            // 拖拽事件监听
            document.addEventListener('drop', function(e) {
                setTimeout(function() {
                    self.collectDropzoneAnswers();
                    self.collectAllAnswers(); // 全面收集一次
                }, 100);
            });

            // 页面可见性变化时收集答案（替代定期收集）
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    console.log('[PracticeEnhancer] 页面隐藏，收集答案');
                    self.collectAllAnswers();
                } else {
                    console.log('[PracticeEnhancer] 页面显示，准备收集答案');
                }
            });

            // 页面卸载前收集答案和清理
            window.addEventListener('beforeunload', function() {
                console.log('[PracticeEnhancer] 页面卸载，收集答案并清理');
                self.collectAllAnswers();
                self.cleanup();
            });

            // 页面失去焦点时收集答案
            window.addEventListener('blur', function() {
                console.log('[PracticeEnhancer] 页面失去焦点，收集答案');
                self.collectAllAnswers();
            });

            console.log('[PracticeEnhancer] 增强答案监听器设置完成');
        },

        recordAnswer: function(element) {
            if (!element) return;

            let questionId = null;
            let value = null;

            // 获取问题ID
            if (element.name) {
                questionId = element.name;
            } else if (element.id) {
                questionId = element.id.replace(/_input$|-input$|_answer$/, '');
            } else if (element.dataset.question) {
                questionId = element.dataset.question;
            }

            // 获取答案值
            if (element.type === 'radio' || element.type === 'checkbox') {
                if (element.checked) {
                    value = element.value;
                }
            } else {
                value = element.value;
            }

            // 记录答案
            if (questionId && value !== null && value !== '') {
                this.answers[questionId] = value;
                console.log('[PracticeEnhancer] 记录答案:', questionId, '=', value);
                
                // 记录交互
                this.interactions.push({
                    type: 'answer',
                    questionId: questionId,
                    value: value,
                    timestamp: Date.now(),
                    elementType: element.type || element.tagName.toLowerCase()
                });
            }
        },

        collectDropzoneAnswers: function () {
            // 收集拖拽填空题答案
            const dropzones = document.querySelectorAll('.dropzone');
            for (let i = 0; i < dropzones.length; i++) {
                const zone = dropzones[i];
                const qName = zone.dataset.target;
                const card = zone.querySelector('.card');
                if (qName && card) {
                    this.answers[qName] = card.dataset.value || card.textContent.trim();
                }
            }

            // 收集段落匹配题答案
            const paragraphZones = document.querySelectorAll('.paragraph-dropzone');
            for (let i = 0; i < paragraphZones.length; i++) {
                const zone = paragraphZones[i];
                const paragraph = zone.dataset.paragraph;
                const items = zone.querySelectorAll('.drag-item');
                if (paragraph && items.length > 0) {
                    const itemTexts = [];
                    for (let j = 0; j < items.length; j++) {
                        const item = items[j];
                        itemTexts.push(item.dataset.heading || item.textContent.trim());
                    }
                    this.answers['q' + paragraph.toLowerCase()] = itemTexts.join(',');
                }
            }

            // 收集匹配题答案
            const matchZones = document.querySelectorAll('.match-dropzone');
            for (let i = 0; i < matchZones.length; i++) {
                const zone = matchZones[i];
                const qName = zone.dataset.question;
                const item = zone.querySelector('.drag-item-clone');
                if (qName && item) {
                    this.answers[qName] = item.dataset.country || item.textContent.trim();
                }
            }
        },

        interceptSubmit: function () {
            // 延迟拦截，确保页面完全加载
            setTimeout(function() {
                // 拦截gradeAnswers函数
                if (typeof window.gradeAnswers === 'function') {
                    const originalGradeAnswers = window.gradeAnswers;
                    const self = this;
                    window.gradeAnswers = function() {
                        console.log('[PracticeEnhancer] 拦截到gradeAnswers调用');
                        self.collectAllAnswers();
                        const result = originalGradeAnswers();
                        self.handleSubmit();
                        return result;
                    };
                    console.log('[PracticeEnhancer] gradeAnswers函数拦截成功');
                } else {
                    console.warn('[PracticeEnhancer] 未找到gradeAnswers函数');
                }

                // 拦截grade函数
                if (typeof window.grade === 'function') {
                    const originalGrade = window.grade;
                    const self = this;
                    window.grade = function() {
                        console.log('[PracticeEnhancer] 拦截到grade调用');
                        self.collectAllAnswers();
                        const result = originalGrade();
                        self.handleSubmit();
                        return result;
                    };
                    console.log('[PracticeEnhancer] grade函数拦截成功');
                }
            }.bind(this), 1000);

            // 监听表单提交
            document.addEventListener('submit', (e) => {
                console.log('[PracticeEnhancer] 拦截到表单提交');
                this.collectAllAnswers();
                this.handleSubmit();
            });

            // 监听提交按钮点击 - 增强版
            const self = this;
            document.addEventListener('click', function(e) {
                console.log('[PracticeEnhancer] 点击事件:', e.target.tagName, e.target.id, e.target.className);

                if (e.target.tagName === 'BUTTON' &&
                    (e.target.textContent.includes('Submit') ||
                        e.target.textContent.includes('提交') ||
                        e.target.textContent.includes('完成') ||
                        e.target.textContent.includes('Check') ||
                        e.target.classList.contains('primary') ||
                        e.target.id === 'submit-btn' ||
                        (e.target.onclick && e.target.onclick.toString().includes('grade')))) {
                    console.log('[PracticeEnhancer] 检测到提交按钮点击:', e.target);
                    self.collectAllAnswers();
                    self.handleSubmit();
                }
            });

            // 定期检查结果是否出现
            this.startResultsMonitoring();

            console.log('[PracticeEnhancer] 提交拦截设置完成');
        },

        startCorrectAnswerMonitoring: function() {
            let checkCount = 0;
            const maxChecks = 30;
            const self = this;

            function checkForCorrectAnswers() {
                checkCount++;
                
                // 尝试从结果表格提取
                const resultsEl = document.getElementById('results');
                if (resultsEl && resultsEl.style.display !== 'none') {
                    const tables = resultsEl.querySelectorAll('table');
                    if (tables.length > 0) {
                        const firstTable = tables[0];
                        const rows = firstTable.querySelectorAll('tr');
                        if (rows.length > 1) { // 有数据行
                            console.log('[PracticeEnhancer] 检测到结果表格，提取正确答案');
                            self.extractFromResultsTable();
                        }
                    }
                }
                
                // 继续检查直到达到最大次数
                if (checkCount < maxChecks && Object.keys(self.correctAnswers).length === 0) {
                    setTimeout(checkForCorrectAnswers, 1000);
                }
            }

            setTimeout(checkForCorrectAnswers, 3000);
        },

        startResultsMonitoring: function() {
            let checkCount = 0;
            const maxChecks = 60;
            const self = this;

            function checkResults() {
                checkCount++;
                const resultsEl = document.getElementById('results');

                if (resultsEl && resultsEl.style.display !== 'none' && resultsEl.textContent.includes('Final Score')) {
                    console.log('[PracticeEnhancer] 检测到结果显示，自动提取分数');
                    self.collectAllAnswers();
                    // 不需要额外延迟，handleSubmit内部已经有延迟处理
                    self.handleSubmit();
                    return;
                }

                if (checkCount < maxChecks) {
                    setTimeout(checkResults, 500);
                }
            }

            setTimeout(checkResults, 2000);
        },

        collectAllAnswers: function () {
            console.log('[PracticeEnhancer] 开始全面收集答案...');
            
            const beforeCount = Object.keys(this.answers).length;

            // 1. 收集所有输入元素（更广泛的选择器）
            const allInputs = document.querySelectorAll('input, textarea, select');
            console.log('[PracticeEnhancer] 找到输入元素总数:', allInputs.length);
            
            allInputs.forEach((input, index) => {
                const questionId = this.getQuestionId(input);
                const value = this.getInputValue(input);

                if (input.type === 'text') {
                    console.log(`[DEBUG] Text Input Found: id='${input.id}', name='${input.name}', derived_questionId='${questionId}', value='${value}'`);
                }
                
                console.log(`[PracticeEnhancer] 输入元素 ${index}: type=${input.type}, name=${input.name}, id=${input.id}, value=${value}, questionId=${questionId}`);
                
                if (questionId && value !== null && value !== '') {
                    this.answers[questionId] = value;
                    console.log(`[PracticeEnhancer] 记录答案: ${questionId} = ${value}`);
                }
            });

            // 2. 收集拖拽答案
            this.collectDropzoneAnswers();

            // 3. 收集特殊格式的答案（通过data属性）
            const answerElements = document.querySelectorAll('[data-answer], [data-user-answer], [data-value]');
            console.log('[PracticeEnhancer] 找到data答案元素:', answerElements.length);
            
            answerElements.forEach(element => {
                const questionId = element.dataset.question || element.dataset.for || element.id;
                const answer = element.dataset.answer || element.dataset.userAnswer || element.dataset.value;
                if (questionId && answer) {
                    this.answers[questionId] = answer;
                    console.log(`[PracticeEnhancer] 记录data答案: ${questionId} = ${answer}`);
                }
            });

            // 4. 收集匹配题答案
            this.collectMatchingAnswers();

            // 5. 收集排序题答案
            this.collectOrderingAnswers();

            // 6. 尝试从页面特定结构收集答案
            this.collectFromPageStructure();

            const afterCount = Object.keys(this.answers).length;
            console.log(`[PracticeEnhancer] 全面收集完成，答案数量从 ${beforeCount} 增加到 ${afterCount}`);
            console.log('[PracticeEnhancer] 收集到的所有答案:', this.answers);
        },

        getQuestionId: function(input) {
            // 尝试多种方式获取问题ID
            if (input.name) return input.name;
            if (input.id) return input.id.replace(/_input$|-input$|_answer$/, '');
            if (input.dataset.question) return input.dataset.question;
            if (input.dataset.for) return input.dataset.for;
            
            // 尝试从父元素获取
            let parent = input.parentElement;
            while (parent && parent !== document.body) {
                if (parent.dataset.question) return parent.dataset.question;
                if (parent.id && parent.id.includes('q')) return parent.id;
                parent = parent.parentElement;
            }
            
            // 尝试从相邻元素获取
            const label = document.querySelector(`label[for="${input.id}"]`);
            if (label && label.textContent) {
                const match = label.textContent.match(/(\d+)/);
                if (match) return 'q' + match[1];
            }
            
            return null;
        },

        getInputValue: function(input) {
            if (input.type === 'radio' || input.type === 'checkbox') {
                return input.checked ? input.value : null;
            }
            return input.value;
        },

        collectFromPageStructure: function() {
            console.log('[PracticeEnhancer] 尝试从页面结构收集答案...');
            
            // 查找所有可能包含问题的容器
            const questionContainers = document.querySelectorAll(
                '.question, .quiz-question, [class*="question"], [id*="question"], [data-question]'
            );
            
            console.log('[PracticeEnhancer] 找到问题容器:', questionContainers.length);
            
            questionContainers.forEach((container, index) => {
                console.log(`[PracticeEnhancer] 处理问题容器 ${index}:`, container.className, container.id);
                
                // 在容器内查找输入元素
                const inputs = container.querySelectorAll('input, textarea, select');
                inputs.forEach(input => {
                    const questionId = this.getQuestionId(input) || `q${index + 1}`;
                    const value = this.getInputValue(input);
                    
                    if (value !== null && value !== '') {
                        this.answers[questionId] = value;
                        console.log(`[PracticeEnhancer] 从容器收集答案: ${questionId} = ${value}`);
                    }
                });
            });
        },

        collectMatchingAnswers: function() {
            // 收集匹配题的答案
            const matchContainers = document.querySelectorAll('.matching-container, .match-exercise, [class*="match"]');
            matchContainers.forEach(container => {
                const pairs = container.querySelectorAll('.match-pair, .matched-item');
                pairs.forEach(pair => {
                    const questionId = pair.dataset.question || pair.dataset.left;
                    const answer = pair.dataset.answer || pair.dataset.right;
                    if (questionId && answer) {
                        this.answers[questionId] = answer;
                    }
                });
            });
        },

        collectOrderingAnswers: function() {
            // 收集排序题的答案
            const orderContainers = document.querySelectorAll('.ordering-container, .sort-exercise, [class*="order"]');
            orderContainers.forEach(container => {
                const items = container.querySelectorAll('.order-item, .sortable-item');
                const orderedAnswers = [];
                items.forEach((item, index) => {
                    const value = item.dataset.value || item.textContent.trim();
                    if (value) {
                        orderedAnswers.push(value);
                    }
                });
                
                if (orderedAnswers.length > 0) {
                    const questionId = container.dataset.question || 'ordering';
                    this.answers[questionId] = orderedAnswers.join(',');
                }
            });
        },

        setupInteractionTracking: function () {
            const self = this;
            document.addEventListener('click', function(e) {
                self.interactions.push({
                    type: 'click',
                    target: e.target.tagName + (e.target.className ? '.' + e.target.className : ''),
                    timestamp: Date.now()
                });
            });

            let scrollTimeout;
            document.addEventListener('scroll', function() {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(function() {
                    self.interactions.push({
                        type: 'scroll',
                        scrollY: window.scrollY,
                        timestamp: Date.now()
                    });
                }, 500);
            });
        },

        handleSubmit: function () {
            if (!this.sessionId) {
                console.warn('[PracticeEnhancer] 无会话ID，无法发送数据');
                return;
            }

            const self = this;
            
            // 延迟发送数据，确保有足够时间提取正确答案
            setTimeout(function() {
                // 最后一次尝试提取正确答案
                self.extractFromResultsTable();
                
                // 再次延迟，等待异步提取完成
                setTimeout(function() {
                    // 如果仍然没有正确答案，尝试其他方法
                    if (Object.keys(self.correctAnswers).length === 0) {
                        self.extractCorrectAnswersBackup();
                    }

                    const endTime = Date.now();
                    const duration = Math.round((endTime - self.startTime) / 1000);

                    // 生成答案比较数据
                    const answerComparison = self.generateAnswerComparison();

                    const results = {
                        sessionId: self.sessionId,
                        examId: self.sessionId.split('_')[0] || 'unknown',
                        startTime: self.startTime,
                        endTime: endTime,
                        duration: duration,
                        answers: self.answers,
                        correctAnswers: self.correctAnswers, // 新增：正确答案
                        answerComparison: answerComparison, // 新增：答案比较
                        interactions: self.interactions,
                        scoreInfo: self.extractScore(),
                        pageType: self.detectPageType(),
                        url: window.location.href,
                        title: document.title
                    };

                    console.log('[PracticeEnhancer] 发送练习完成数据:', results);
                    self.sendMessage('PRACTICE_COMPLETE', results);
                }, 1000); // 再等1秒确保异步提取完成
            }, 500); // 先等0.5秒让结果表格完全显示
        },

        generateAnswerComparison: function () {
            const comparison = {};
            
            // 获取所有问题的键
            const userKeys = Object.keys(this.answers);
            const correctKeys = Object.keys(this.correctAnswers);
            const allQuestions = {};
            
            // 合并所有问题键
            for (let i = 0; i < userKeys.length; i++) {
                allQuestions[userKeys[i]] = true;
            }
            for (let i = 0; i < correctKeys.length; i++) {
                allQuestions[correctKeys[i]] = true;
            }
            
            const questionKeys = Object.keys(allQuestions);
            for (let i = 0; i < questionKeys.length; i++) {
                const questionKey = questionKeys[i];
                const userAnswer = this.answers[questionKey];
                const correctAnswer = this.correctAnswers[questionKey];
                
                comparison[questionKey] = {
                    userAnswer: userAnswer || null,
                    correctAnswer: correctAnswer || null,
                    isCorrect: this.compareAnswers(userAnswer, correctAnswer)
                };
            }
            
            console.log('[PracticeEnhancer] 生成答案比较:', comparison);
            return comparison;
        },

        compareAnswers: function (userAnswer, correctAnswer) {
            if (!userAnswer || !correctAnswer) {
                return false;
            }
            
            // 标准化答案进行比较
            const normalize = (str) => String(str).trim().toLowerCase();
            return normalize(userAnswer) === normalize(correctAnswer);
        },

        extractScore: function () {
            const resultsEl = document.getElementById('results');
            if (!resultsEl) {
                console.warn('[PracticeEnhancer] 未找到结果元素');
                return null;
            }

            const text = resultsEl.textContent || '';
            console.log('[PracticeEnhancer] 结果文本:', text);

            // 匹配 "Final Score: 85% (11/13)" 格式 - 66号文件格式
            const finalScoreMatch = text.match(/Final\s+Score:\s*(\d+)%\s*\((\d+)\/(\d+)\)/i);
            if (finalScoreMatch) {
                const percentage = parseInt(finalScoreMatch[1]);
                const correct = parseInt(finalScoreMatch[2]);
                const total = parseInt(finalScoreMatch[3]);
                const accuracy = total > 0 ? correct / total : 0;

                console.log('[PracticeEnhancer] 提取Final Score成绩:', { correct, total, accuracy, percentage });

                return {
                    correct: correct,
                    total: total,
                    accuracy: accuracy,
                    percentage: percentage,
                    source: 'final_score_extraction'
                };
            }

            // 匹配 "Score: 11/13" 格式
            const scoreMatch = text.match(/Score:\s*(\d+)\/(\d+)/i);
            if (scoreMatch) {
                const correct = parseInt(scoreMatch[1]);
                const total = parseInt(scoreMatch[2]);
                const accuracy = total > 0 ? correct / total : 0;
                const percentage = Math.round(accuracy * 100);

                console.log('[PracticeEnhancer] 提取Score成绩:', { correct, total, accuracy, percentage });

                return {
                    correct: correct,
                    total: total,
                    accuracy: accuracy,
                    percentage: percentage,
                    source: 'score_extraction'
                };
            }

            // 匹配 "Accuracy: 85%" 格式
            const accuracyPercentMatch = text.match(/Accuracy:\s*(\d+)%/i);
            if (accuracyPercentMatch) {
                const percentage = parseInt(accuracyPercentMatch[1]);
                return {
                    correct: 0,
                    total: 0,
                    accuracy: percentage / 100,
                    percentage: percentage,
                    source: 'accuracy_percentage_extraction'
                };
            }

            // 匹配单独的百分比 "85%" 格式
            const percentageMatch = text.match(/(\d+)%/);
            if (percentageMatch) {
                const percentage = parseInt(percentageMatch[1]);

                console.log('[PracticeEnhancer] 提取百分比成绩:', { percentage });

                return {
                    correct: 0,
                    total: 0,
                    accuracy: percentage / 100,
                    percentage: percentage,
                    source: 'percentage_extraction'
                };
            }

            // 匹配 "Accuracy 85%" 格式（无冒号）
            const accuracyMatch = text.match(/Accuracy\s+(\d+)%/i);
            if (accuracyMatch) {
                const percentage = parseInt(accuracyMatch[1]);
                return {
                    correct: 0,
                    total: 0,
                    accuracy: percentage / 100,
                    percentage: percentage,
                    source: 'accuracy_extraction'
                };
            }

            // 尝试从表格中提取成绩信息
            const correctCells = resultsEl.querySelectorAll('.result-correct');
            const incorrectCells = resultsEl.querySelectorAll('.result-incorrect');
            if (correctCells.length > 0 || incorrectCells.length > 0) {
                const correct = correctCells.length;
                const total = correctCells.length + incorrectCells.length;
                const accuracy = total > 0 ? correct / total : 0;
                const percentage = Math.round(accuracy * 100);

                console.log('[PracticeEnhancer] 从表格提取成绩:', { correct, total, accuracy, percentage });

                return {
                    correct: correct,
                    total: total,
                    accuracy: accuracy,
                    percentage: percentage,
                    source: 'table_extraction'
                };
            }

            console.warn('[PracticeEnhancer] 无法提取成绩信息，结果文本:', text);
            return null;
        },

        sendMessage: function (type, data) {
            if (!this.parentWindow) {
                console.warn('[PracticeEnhancer] 无父窗口，无法发送消息');
                return;
            }

            const message = {
                type: type,
                data: data,
                source: 'practice_page',
                timestamp: Date.now()
            };

            try {
                this.parentWindow.postMessage(message, '*');
                console.log('[PracticeEnhancer] 消息已发送:', type);
            } catch (error) {
                console.error('[PracticeEnhancer] 发送消息失败:', error);
            }
        },

        getStatus: function () {
            return {
                isInitialized: this.isInitialized,
                sessionId: this.sessionId,
                hasParentWindow: !!this.parentWindow,
                answersCount: Object.keys(this.answers).length,
                correctAnswersCount: Object.keys(this.correctAnswers).length, // 新增
                interactionsCount: this.interactions.length,
                pageType: this.detectPageType()
            };
        }
    };

    // 添加全局方法供调试和手动触发使用
    window.collectAnswersNow = function() {
        console.log('[PracticeEnhancer] 手动触发答案收集');
        window.practicePageEnhancer.collectAllAnswers();
        return window.practicePageEnhancer.answers;
    };

    window.getCorrectAnswers = function() {
        console.log('[PracticeEnhancer] 获取正确答案');
        window.practicePageEnhancer.extractCorrectAnswers();
        return window.practicePageEnhancer.correctAnswers;
    };

    // 自动初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            window.practicePageEnhancer.initialize();
        });
    } else {
        window.practicePageEnhancer.initialize();
    }

    // 调试函数
    window.debugPracticeEnhancer = () => {
        console.log('=== 练习页面增强器调试信息 ===');
        console.log('状态:', window.practicePageEnhancer.getStatus());
        console.log('用户答案:', window.practicePageEnhancer.answers);
        console.log('正确答案:', window.practicePageEnhancer.correctAnswers); // 新增
        console.log('答案比较:', window.practicePageEnhancer.generateAnswerComparison()); // 新增
        console.log('交互记录:', window.practicePageEnhancer.interactions);

        // 测试成绩提取
        const scoreInfo = window.practicePageEnhancer.extractScore();
        console.log('成绩提取测试:', scoreInfo);
    };
}
</script>
</body>
</html>