<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Reading Practice - Flower Power</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --line: #e5e7eb;
            --bg: #f6f7fb;
            --panel: #fff;
            --accent: #3b82f6;
            --muted: #6b7280;
            --shadow: 0 6px 20px rgba(0,0,0,.12);
            --text-color: #333;
            --highlight: #fff3a3;
            --selbar-bg: #111;
            --selbar-text: #fff;
        }

        body.dark-mode {
            --line: #4a4a4a;
            --bg: #1a1a1a;
            --panel: #2a2a2a;
            --muted: #bbb;
            --text-color: #f0f0f0;
            --highlight: #5b21b6;
            --selbar-bg: #1f2937;
            --selbar-text: #e5e7eb;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        html { font-size: 16px; }
        html.font-regular { font-size: 16px; }
        html.font-large { font-size: 18px; }
        html.font-xlarge { font-size: 20px; }

        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            background: var(--bg);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s ease;
            padding-bottom: 64px;
        }

        .header {
            background-color: var(--panel);
            padding: 12px 20px;
            border-bottom: 1px solid var(--line);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 100;
        }

        .dark-mode .header {
            background-color: #2a2a2a;
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header h1 {
            font-size: 1.2rem;
            font-weight: 500;
            color: var(--text-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #timer {
            font-size: 1rem;
            font-weight: 500;
            background: var(--bg);
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid var(--line);
            min-width: 90px;
            text-align: center;
            color: var(--text-color);
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-btn {
            background: var(--panel);
            border: 1px solid var(--line);
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            color: var(--text-color);
        }
        
        .header-btn:hover {
            background: var(--bg);
            border-color: var(--accent);
        }
        
        #settings-panel {
            position: absolute;
            top: 60px;
            right: 20px;
            width: 200px;
            background: var(--panel);
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--line);
            z-index: 1000;
            padding: 8px;
            display: none;
        }

        .settings-group {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--line);
        }
        .settings-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .settings-title {
            font-size: 0.85rem;
            color: var(--muted);
            margin-bottom: 8px;
            padding-left: 12px;
        }

        .settings-option {
            display: block;
            width: 100%;
            text-align: left;
            padding: 8px 12px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 0.9rem;
            border-radius: 6px;
            color: var(--text-color);
        }

        .settings-option.active {
            background: #e9effd;
            color: var(--accent);
            font-weight: 500;
        }

        .dark-mode .settings-option.active {
            background: #1e3a8a;
        }

        #notes-panel {
            position: fixed;
            right: 12px;
            bottom: 76px;
            width: 320px;
            height: 45vh;
            background: var(--panel);
            border: 1px solid var(--line);
            border-radius: 12px;
            display: none;
            flex-direction: column;
            z-index: 900;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        #notes-panel header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid var(--line);
            background-color: var(--bg);
        }

        #notes-panel h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-color);
            margin: 0;
        }

        #notes-panel textarea {
            flex: 1;
            border: 0;
            padding: 16px;
            resize: none;
            font-size: 0.95rem;
            background: transparent;
            color: var(--text-color);
            line-height: 1.6;
        }

        #notes-panel textarea:focus {
            outline: none;
        }

        #close-note {
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid var(--line);
            background: transparent;
            cursor: pointer;
            color: var(--text-color);
            transition: background-color 0.2s;
        }

        #close-note:hover {
            background-color: rgba(0,0,0,0.1);
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.08);
            z-index: 800;
            display: none;
            backdrop-filter: blur(2px);
        }

        .dark-mode .overlay {
            background: rgba(0, 0, 0, 0.3);
        }

        .shell {
            display: flex;
            height: calc(100vh - 58px - 64px);
            width: 100%;
            overflow: hidden;
        }

        .pane {
            background: var(--panel);
            overflow: auto;
            padding: 24px;
            transition: width 0.1s ease;
        }

        #left {
            min-width: 280px;
            max-width: calc(100% - 280px);
            width: 50%;
        }

        #right {
            min-width: 280px;
            flex: 1;
            background: var(--bg);
            border-left: 1px solid var(--line);
        }
        .dark-mode #right {
            background: #1a1a1a;
        }

        #divider {
            flex: 0 0 8px;
            background: var(--bg);
            cursor: ew-resize;
            user-select: none;
            position: relative;
        }
        .dark-mode #divider {
             background: #111827;
        }


        #divider::before {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 4px;
            height: 30px;
            border-radius: 2px;
            background: rgba(100, 100, 100, 0.3);
        }

        #divider:hover {
            background: #dbeafe;
        }
        .dark-mode #divider:hover {
             background: #1e40af;
        }

        h2, h3, h4 {
            margin: 0 0 16px;
            color: var(--text-color);
        }

        #left p, #right p {
            margin: 0 0 16px;
            line-height: 1.7;
        }
        
        #left strong {
            font-weight: bold;
        }

        .group {
            background: var(--panel);
            border: 1px solid var(--line);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .question-item {
            padding: 12px 0;
            border-bottom: 1px dashed var(--line);
        }

        .question-item:last-child {
            border-bottom: none;
        }

        .radio-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 8px;
        }

        .radio-options label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        input.blank {
            border: none;
            border-bottom: 1px solid #9ca3af;
            padding: 2px 8px;
            font-size: 1em;
            background: transparent;
            color: var(--text-color);
            min-width: 150px;
            text-align: center;
        }

        .dark-mode input.blank {
            border-bottom-color: #666;
        }

        input.blank:focus {
            outline: none;
            border-bottom: 2px solid var(--accent);
        }

        #results {
            background: var(--panel);
            border: 1px solid var(--line);
            border-radius: 10px;
            padding: 16px;
            margin-top: 16px;
            display: none;
        }

        .result-correct { color: #10b981; }
        .result-incorrect { color: #ef4444; }

        .hl {
            background: var(--highlight);
            box-shadow: inset 0 -2px 0 rgba(0,0,0,.05);
            cursor: pointer;
        }

        .dark-mode .hl {
            color: #f5f3ff;
        }

        #selbar {
            position: absolute;
            display: none;
            z-index: 6000;
            background: var(--selbar-bg);
            color: var(--selbar-text);
            border-radius: 8px;
            padding: 6px;
            box-shadow: var(--shadow);
            font-size: 13px;
            gap: 6px;
            align-items: center;
        }

        #selbar button {
            background: transparent;
            color: var(--selbar-text);
            border: 1px solid rgba(255,255,255,.25);
            padding: 4px 8px;
            border-radius: 6px;
            cursor: pointer;
        }

        #selbar button:hover {
            border-color: var(--selbar-text);
        }

        .practice-nav {
            background: var(--panel);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 -2px 4px rgba(0,0,0,.05);
            flex-wrap: wrap;
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            border-top: 1px solid var(--line);
            z-index: 4000;
        }

        .practice-nav .title {
            font-weight: 600;
            color: var(--muted);
        }

        .practice-nav .questions {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .practice-nav .q-item {
            padding: 6px 10px;
            border: 1px solid var(--line);
            border-radius: 6px;
            background: var(--panel);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            min-width: 36px;
            text-align: center;
            color: var(--text-color);
        }

        .practice-nav .q-item:hover {
            background: var(--bg);
            border-color: var(--accent);
        }

        .practice-nav .q-item.answered {
            background: #e0e7ff;
            border-color: var(--accent);
            color: var(--accent);
            font-weight: 500;
        }

        .dark-mode .practice-nav .q-item.answered {
            background: #3949ab;
            border-color: var(--accent);
            color: #e8eaf6;
        }

        .practice-nav .q-item.active {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }

        .practice-nav .controls {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .practice-nav .controls button {
            padding: 8px 12px;
            border: 1px solid var(--line);
            border-radius: 6px;
            background: var(--panel);
            cursor: pointer;
            color: var(--text-color);
        }

        .practice-nav .controls button.primary {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }

        .empty-space {
            height: 40px;
        }

        /* Drag and Drop Styles for Headings */
        .paragraph-wrapper { 
            position: relative; 
            margin-bottom: 1rem; 
        }
        .paragraph-dropzone { 
            min-height: 40px; 
            background: #f0f9ff; 
            border: 2px dashed #93c5fd; 
            border-radius: 8px; 
            margin-bottom: 8px; 
            padding: 6px 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
        }
        .dark-mode .paragraph-dropzone {
            background: #1e3a8a;
            border-color: #3b82f6;
        }
        .paragraph-dropzone.drag-over { 
            background: #dbeafe; 
            border-color: #3b82f6; 
        }
        .dark-mode .paragraph-dropzone.drag-over {
            background: #1e40af;
        }
        .paragraph-label { 
            font-weight: bold; 
            color: #64748b; 
            font-size: 0.9rem;
            min-width: 110px;
        }
        .dark-mode .paragraph-label {
            color: #94a3b8;
        }
        .dropped-items {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            flex: 1;
        }
        .headings-pool {
            background: #fafbfc;
            border: 1px solid var(--line);
            border-radius: 8px;
            padding: 12px;
            margin: 16px 0;
        }
        .dark-mode .headings-pool {
            background: #334155;
        }
        .pool-items {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .drag-item {
            padding: 6px 12px;
            background-color: #eef2ff;
            border: 1px solid #c7d2fe;
            border-radius: 6px;
            cursor: grab;
            user-select: none;
            font-size: 14px;
            transition: all 0.2s;
            color: #333;
        }
        .dark-mode .drag-item {
            background-color: #4f46e5;
            border-color: #6366f1;
            color: #fff;
        }
        .drag-item.dragging {
            opacity: 0.5;
        }
        .dropped-items .drag-item {
            background: transparent;
            border: none;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            cursor: default;
            padding: 0;
            color: var(--text-color);
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <h1>P3 - Flower Power</h1>
            <div id="timer">00:00</div>
        </div>
        <div class="header-controls">
            <button class="header-btn" id="size-btn">Size</button>
            <button class="header-btn" id="color-btn">Color</button>
            <button class="header-btn" id="note-btn">Note</button>
        </div>
    </header>

    <div id="settings-panel">
        <div class="settings-group">
            <div class="settings-title">Font Size</div>
            <button class="settings-option active" data-size="regular">Regular</button>
            <button class="settings-option" data-size="large">Large</button>
            <button class="settings-option" data-size="xlarge">Extra Large</button>
        </div>
        <div class="settings-group">
            <div class="settings-title">Color Mode</div>
            <button class="settings-option active" data-mode="light">Black on White</button>
            <button class="settings-option" data-mode="dark">White on Black</button>
        </div>
    </div>

    <div id="notes-panel">
        <header>
            <h3>Notes</h3>
            <button id="close-note">Close</button>
        </header>
        <textarea placeholder="Write your notes here..."></textarea>
    </div>

    <div class="overlay"></div>

    <div class="shell">
        <section class="pane" id="left">
            <h2>READING PASSAGE 3</h2>
            <p>You should spend about 20 minutes on Questions 27–40, which are based on Reading Passage 3 below.</p>
            
            <h3>Flower Power</h3>
            
            <div class="paragraph-wrapper">
                <div class="paragraph-dropzone" data-paragraph="A" id="q27-dropzone">
                    <span class="paragraph-label">Question 27 (A):</span>
                    <div class="dropped-items"></div>
                </div>
                <p><strong>A</strong> Why do we give people flowers? To offer condolence to those who are grieving. To celebrate. To woo. To ask for forgiveness. We all know intuitively that there is a universal emotional response. In the US alone, the flower industry is now worth about $5 billion a year, which suggests that, at the very least, they service a compelling human need.</p>
            </div>
            <div class="paragraph-wrapper">
                <div class="paragraph-dropzone" data-paragraph="B" id="q28-dropzone">
                    <span class="paragraph-label">Question 28 (B):</span>
                    <div class="dropped-items"></div>
                </div>
                <p><strong>B</strong> Recent studies at the Department of Psychology at Rutgers State University of New Jersey investigated claims that flowers are unique among living organisms in their ability to induce profound changes in our emotional state. As the first part of their research, the Rutgers team visited 150 women in their homes. Each was presented with a variety of gifts such as flowers, fruit or sweets. The women were unaware that the study was about the effect of the flowers on their emotions. They were told that it was a study about their daily moods, and that they would receive a gift in return for taking part. Following the presentation of the gift, those receiving flowers were assessed as displaying a much more positive mood than those who got other gifts, and this effect lasted for several days. After receiving flowers, they were also more willing to answer questions concerning their social circle and intimate conversations with friends and family. The results suggest that flowers influence our secondary socio-emotional behaviours, as well as having a strong effect on our immediate emotional expression.</p>
            </div>
            <div class="paragraph-wrapper">
                 <div class="paragraph-dropzone" data-paragraph="C" id="q29-dropzone">
                    <span class="paragraph-label">Question 29 (C):</span>
                    <div class="dropped-items"></div>
                </div>
                <p><strong>C</strong> In the second study, the psychologists observed participants being handed single flowers, or alternative gifts, in a constrained and stressful situation – inside an elevator. Contrary to predictions regarding gender differences, both men and women presented with flowers were more likely to smile, to stand closer and to initiate conversation. Several subjects who were given the alternative gift then learnt that flowers were also being handed out, and returned to the elevator and demanded a flower. The scientists used elevators for this study precisely because the most typical behaviour in sparsely occupied elevators is for people to retreat to opposite corners. The subjects who received flowers, however, closed up that space to a considerable extent – indicating that the flowers not only induced a strong positive mood, but brought a significant affiliation among people who had never previously met.</p>
            </div>
            <div class="paragraph-wrapper">
                <div class="paragraph-dropzone" data-paragraph="D" id="q30-dropzone">
                    <span class="paragraph-label">Question 30 (D):</span>
                    <div class="dropped-items"></div>
                </div>
                <p><strong>D</strong> The third study involved regularly sending flowers to a selected sample of men and women. The researchers found not only a profound elevation of mood, but also reliable improvements in other measures of cognitive function, like memory. In this series of experiments, some participants produced such extraordinary emotional displays that the psychologists were totally unprepared for them. Subjects gave spontaneous hugs and kisses to the people who delivered the flowers, and sent invitations to the psychologists to come to their homes for refreshments.</p>
            </div>
            <div class="paragraph-wrapper">
                 <div class="paragraph-dropzone" data-paragraph="E" id="q31-dropzone">
                    <span class="paragraph-label">Question 31 (E):</span>
                    <div class="dropped-items"></div>
                </div>
                <p><strong>E</strong> Various evolutionary hypotheses attempt to explain the remarkably powerful psychological effect of flowers. One is that our aesthetic preferences for fertile locations and growing things stem from prehistory, when these clues in our environment could mean the difference between starvation and survival. We may have become hardwired to respond positively to flowers because for early man, finding them in a particular location predicted future food supplies and possibly a better place to rear children. Yet the flaw in this argument is that the showy flowers which humans seem to find most visually attractive are generally found on those plants which yield no edible products.</p>
            </div>
            <div class="paragraph-wrapper">
                 <div class="paragraph-dropzone" data-paragraph="F" id="q32-dropzone">
                    <span class="paragraph-label">Question 32 (F):</span>
                    <div class="dropped-items"></div>
                </div>
                <p><strong>F</strong> The Rutgers psychologists' findings show that the various physical attributes of flowers combine to directly affect our emotions through multi-channel interactions. We have evolved preferences for the particular colours, textures, patterned symmetries and specific floral odours which influence our moods. Indeed, previous research has established that popular perfumes, which often have a floral ‘top-note', will actually reduce depression. The origins of these inclinations may well be as the evolutionary theories suggest: the patterned symmetries of flowers can be detected easily as a recognisable signal within a wide variety of visual arrays, and a response to certain colour tones is important in finding ripe fruit against a leafy background. But, claim the Rutgers team, these preferences have long been separated from their primary evolutionary use, and become rewarding to us more generally. Thus plants with preferred colours, shapes and odours – despite having no other products – would therefore be protected and dispersed.</p>
            </div>
            <div class="paragraph-wrapper">
                 <div class="paragraph-dropzone" data-paragraph="G" id="q33-dropzone">
                    <span class="paragraph-label">Question 33 (G):</span>
                    <div class="dropped-items"></div>
                </div>
                <p><strong>G</strong> The Rutgers study suggests that flowers may have actually evolved to exploit their peculiar impact on humans. The team's theory proposes a plant-human co-evolution, or even domestication, based on the intense emotional rewards that flowers provide. The idea that flowering plants, with no known food or other basic survival value to man, have co-evolved with us by exploiting an emotional niche instead, is very much like the scenario presented for the evolution of dogs. Flowers may be the plant equivalent of 'companion animals'. If this is true, then there is a very real sense in which, when you next give flowers, they are using you just as much as you are using them.</p>
            </div>
            
            <div class="empty-space"></div>
        </section>
        
        <div id="divider"></div>
        
        <section class="pane" id="right">
            <h3>Questions</h3>
            
            <div class="group" id="q27-33-anchor">
                <h4>Questions 27–33</h4>
                <p>Reading Passage 3 has seven paragraphs, <strong>A–G</strong>.</p>
                <p>Choose the correct heading for each paragraph from the list of headings below.</p>
                <p><em>Drag a heading from this list and drop it onto the correct paragraph's answer box on the left.</em></p>
                <div class="headings-pool" id="headings-pool-container">
                    <strong>List of Headings</strong>
                    <div class="pool-items">
                        <div class="drag-item" draggable="true" data-heading="i">i. A negative reaction to receiving flowers</div>
                        <div class="drag-item" draggable="true" data-heading="ii">ii. Some surprisingly strong responses to flowers</div>
                        <div class="drag-item" draggable="true" data-heading="iii">iii. A mutually beneficial relationship?</div>
                        <div class="drag-item" draggable="true" data-heading="iv">iv. Becoming more open about personal matters</div>
                        <div class="drag-item" draggable="true" data-heading="v">v. Some common social functions of flowers</div>
                        <div class="drag-item" draggable="true" data-heading="vi">vi. Sensory appeal versus practical purpose of flowers</div>
                        <div class="drag-item" draggable="true" data-heading="vii">vii. Bridging the gap between strangers in an enclosed space</div>
                        <div class="drag-item" draggable="true" data-heading="viii">viii. An imperfect theory</div>
                    </div>
                </div>
            </div>

            <div class="group" id="q34-37-anchor">
                <h4>Questions 34–37</h4>
                <p>Look at the following statements (Questions 34–37) and the list of studies below.</p>
                <p>Match each statement with the correct studies, <strong>A-C</strong>.</p>
                <p><em>NB You may use any letter more than once.</em></p>

                <div class="question-item" id="q34-anchor">
                    <p><strong>34</strong> The study focused on participants' short-term reaction to receiving flowers.</p>
                    <div class="radio-options">
                        <label><input name="q34" type="radio" value="A"> A the first study</label>
                        <label><input name="q34" type="radio" value="B"> B the second study</label>
                        <label><input name="q34" type="radio" value="C"> C the third study</label>
                    </div>
                </div>
                
                <div class="question-item" id="q35-anchor">
                    <p><strong>35</strong> Participants were deliberately misled as to the aim of the study.</p>
                    <div class="radio-options">
                        <label><input name="q35" type="radio" value="A"> A the first study</label>
                        <label><input name="q35" type="radio" value="B"> B the second study</label>
                        <label><input name="q35" type="radio" value="C"> C the third study</label>
                    </div>
                </div>

                <div class="question-item" id="q36-anchor">
                    <p><strong>36</strong> Receiving flowers had a notable effect on participants' mental capacities.</p>
                    <div class="radio-options">
                        <label><input name="q36" type="radio" value="A"> A the first study</label>
                        <label><input name="q36" type="radio" value="B"> B the second study</label>
                        <label><input name="q36" type="radio" value="C"> C the third study</label>
                    </div>
                </div>
                
                <div class="question-item" id="q37-anchor">
                    <p><strong>37</strong> Male and female responses were more uniform than expected.</p>
                    <div class="radio-options">
                        <label><input name="q37" type="radio" value="A"> A the first study</label>
                        <label><input name="q37" type="radio" value="B"> B the second study</label>
                        <label><input name="q37" type="radio" value="C"> C the third study</label>
                    </div>
                </div>
            </div>
            
            <div class="group" id="q38-40-anchor">
                <h4>Questions 38–40</h4>
                <p>Complete the summary below.</p>
                <p>Choose <strong>ONE WORD ONLY</strong> from the passage for each answer.</p>
                 <p style="line-height: 2.5;"><strong>A possible explanation for the appeal of flowers</strong></p>
                <p style="line-height: 2.5;">It has been suggested that our intense response to flowers originates in prehistoric times. The presence of flowers might indicate a potential source of <strong>38</strong> <input class="blank" name="q38"> in a particular location, and primitive humans would search for such signs when looking for a suitable site to raise their <strong>39</strong> <input class="blank" name="q39">. The interpretation of these signs was essential for the survival of our ancestors. However, the problem with this idea is that the plants producing the most attractive flowers do not usually have fruit which is <strong>40</strong> <input class="blank" name="q40">.</p>
                <div id="q39-anchor"></div>
                <div id="q40-anchor"></div>
            </div>
            
            <div id="results"></div>
        </section>
    </div>
    
    <div class="practice-nav">
        <div class="title">Questions</div>
        <div class="questions">
            <div class="q-item" id="q27-nav" onclick="scrollToElement('q27-dropzone')">27</div>
            <div class="q-item" id="q28-nav" onclick="scrollToElement('q28-dropzone')">28</div>
            <div class="q-item" id="q29-nav" onclick="scrollToElement('q29-dropzone')">29</div>
            <div class="q-item" id="q30-nav" onclick="scrollToElement('q30-dropzone')">30</div>
            <div class="q-item" id="q31-nav" onclick="scrollToElement('q31-dropzone')">31</div>
            <div class="q-item" id="q32-nav" onclick="scrollToElement('q32-dropzone')">32</div>
            <div class="q-item" id="q33-nav" onclick="scrollToElement('q33-dropzone')">33</div>
            <div class="q-item" id="q34-nav" onclick="scrollToElement('q34-anchor')">34</div>
            <div class="q-item" id="q35-nav" onclick="scrollToElement('q35-anchor')">35</div>
            <div class="q-item" id="q36-nav" onclick="scrollToElement('q36-anchor')">36</div>
            <div class="q-item" id="q37-nav" onclick="scrollToElement('q37-anchor')">37</div>
            <div class="q-item" id="q38-nav" onclick="scrollToElement('q38-40-anchor')">38</div>
            <div class="q-item" id="q39-nav" onclick="scrollToElement('q39-anchor')">39</div>
            <div class="q-item" id="q40-nav" onclick="scrollToElement('q40-anchor')">40</div>
        </div>
        <div class="controls">
            <button id="submit-btn" class="primary">Submit</button>
            <button id="reset-btn">Reset</button>
            <button id="pause-btn">Pause</button>
        </div>
    </div>

    <div aria-label="Selection tools" id="selbar" role="toolbar">
        <button id="btnHL">Highlight</button>
        <button id="btnUH">Remove</button>
        <button id="btnNote">Note</button>
    </div>

    <script>
        // Global variables
        let settingsOpen = false, notesOpen = false;
        let timerRunning = true, seconds = 0, timer;
        let isResizing = false;
        let userAnswers = {};
        let draggedElement = null;
        var selbar = document.getElementById('selbar');
        var lastRange = null, currentHlNode = null, keepToolbar = false;

        // Timer functionality
        function startTimer() {
            timer = setInterval(() => {
                if (timerRunning) {
                    seconds++;
                    updateTimer();
                }
            }, 1000);
        }

        function updateTimer() {
            const minutes = String(Math.floor(seconds / 60)).padStart(2, '0');
            const secs = String(seconds % 60).padStart(2, '0');
            document.getElementById('timer').textContent = `${minutes}:${secs}`;
        }

        // Panel management
        function closeAllPanels() {
            notesOpen = false;
            settingsOpen = false;
            document.getElementById('notes-panel').style.display = 'none';
            document.getElementById('settings-panel').style.display = 'none';
            document.querySelector('.overlay').style.display = 'none';
        }

        // Resizer functionality
        const divider = document.getElementById('divider');
        const leftPane = document.getElementById('left');
        divider.addEventListener('mousedown', (e) => {
            isResizing = true;
            document.body.style.cursor = 'ew-resize';
            e.preventDefault();
        });
        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            const shellRect = document.querySelector('.shell').getBoundingClientRect();
            let leftWidth = (e.clientX - shellRect.left) / shellRect.width * 100;
            leftPane.style.width = `${Math.max(20, Math.min(80, leftWidth))}%`;
        });
        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                document.body.style.cursor = '';
            }
        });

        // Question navigation
        window.scrollToElement = function(id) {
            const element = document.getElementById(id);
            const pane = element.closest('.pane');
            if (element && pane) {
                const top = element.offsetTop - 20;
                pane.scrollTo({ top, behavior: 'smooth' });
            }
        }
        
        // Drag and Drop Logic
        function setupDragAndDrop() {
            const draggables = document.querySelectorAll('.drag-item');
            const dropTargets = document.querySelectorAll('.paragraph-dropzone');
            const pool = document.querySelector('.pool-items');

            draggables.forEach(draggable => {
                draggable.addEventListener('dragstart', () => {
                    draggedElement = draggable;
                    setTimeout(() => draggable.classList.add('dragging'), 0);
                });
                draggable.addEventListener('dragend', () => {
                    if (draggedElement) {
                       draggedElement.classList.remove('dragging');
                    }
                    draggedElement = null;
                });
            });

            const handleDragOver = (e) => {
                e.preventDefault();
                const target = e.target.closest('.paragraph-dropzone, .headings-pool');
                if (target) {
                    target.classList.add('drag-over');
                }
            };

            const handleDragLeave = (e) => {
                const target = e.target.closest('.paragraph-dropzone, .headings-pool');
                if (target) {
                    target.classList.remove('drag-over');
                }
            };

            const handleDrop = (e) => {
                e.preventDefault();
                const target = e.target.closest('.paragraph-dropzone, .headings-pool');
                if (!target || !draggedElement) return;
                
                target.classList.remove('drag-over');
                const droppedItemsContainer = target.querySelector('.dropped-items');

                if(droppedItemsContainer) { // Dropped on a paragraph dropzone
                    if (droppedItemsContainer.children.length > 0) {
                        pool.appendChild(droppedItemsContainer.firstElementChild);
                    }
                    droppedItemsContainer.appendChild(draggedElement);
                } else { // Dropped on the pool
                    pool.appendChild(draggedElement);
                }
                updateAnsweredStateForDragDrop();
            };

            [...dropTargets, document.getElementById('headings-pool-container')].forEach(container => {
                container.addEventListener('dragover', handleDragOver);
                container.addEventListener('dragleave', handleDragLeave);
                container.addEventListener('drop', handleDrop);
            });
        }

        function updateAnsweredStateForDragDrop() {
            for (let i = 27; i <= 33; i++) {
                const dropzone = document.getElementById(`q${i}-dropzone`);
                const navItem = document.getElementById(`q${i}-nav`);
                if(dropzone && navItem) {
                    const isAnswered = dropzone.querySelector('.dropped-items').children.length > 0;
                    navItem.classList.toggle('answered', isAnswered);
                }
            }
        }

        function setupAnswerTracking() {
            document.querySelectorAll('input[type="radio"], input.blank').forEach(input => {
                const eventType = input.type === 'radio' ? 'change' : 'input';
                input.addEventListener(eventType, function() {
                    const questionName = this.name;
                    userAnswers[questionName] = this.value;
                    const navItem = document.getElementById(`${questionName}-nav`);
                    if (navItem) {
                        if ((this.value && this.value.trim()) || this.checked) {
                            navItem.classList.add('answered');
                        } else {
                            navItem.classList.remove('answered');
                        }
                    }
                });
            });
        }

        function grade() {
            const correctAnswers = {
                q27: 'v', q28: 'iv', q29: 'vii', q30: 'ii', q31: 'viii', q32: 'vi', q33: 'iii',
                q34: 'B', q35: 'A', q36: 'C', q37: 'B',
                q38: 'food', q39: 'children', q40: 'edible'
            };
            
            let correct = 0;
            const total = 14;
            let resultsHTML = '<h4>Results</h4>';

            // Grade Headings (Q27-33)
            for (let i = 27; i <= 33; i++) {
                const qId = `q${i}`;
                const dropTarget = document.getElementById(`${qId}-dropzone`);
                const droppedItem = dropTarget.querySelector('.drag-item');
                const userAnswer = droppedItem ? droppedItem.dataset.heading : 'No answer';
                const isCorrect = userAnswer === correctAnswers[qId];
                if (isCorrect) correct++;
                resultsHTML += `<div class="${isCorrect ? 'result-correct' : 'result-incorrect'}">
                    Q${i}: ${userAnswer.toUpperCase()} ${isCorrect ? '✓' : '✗ (Correct: ' + correctAnswers[qId].toUpperCase() + ')'}
                </div>`;
            }

            // Grade Matching (Q34-37)
            for (let i = 34; i <= 37; i++) {
                const qId = `q${i}`;
                const userAnswer = userAnswers[qId] || 'No answer';
                const isCorrect = userAnswer === correctAnswers[qId];
                if (isCorrect) correct++;
                resultsHTML += `<div class="${isCorrect ? 'result-correct' : 'result-incorrect'}">
                    Q${i}: ${userAnswer} ${isCorrect ? '✓' : '✗ (Correct: ' + correctAnswers[qId] + ')'}
                </div>`;
            }

            // Grade Summary Completion (Q38-40)
            for (let i = 38; i <= 40; i++) {
                const qId = `q${i}`;
                const userAnswer = (userAnswers[qId] || 'No answer').trim().toLowerCase();
                const isCorrect = userAnswer === correctAnswers[qId];
                if (isCorrect) correct++;
                resultsHTML += `<div class="${isCorrect ? 'result-correct' : 'result-incorrect'}">
                    Q${i}: ${userAnswers[qId] || 'No answer'} ${isCorrect ? '✓' : '✗ (Correct: ' + correctAnswers[qId] + ')'}
                </div>`;
            }

            const score = Math.round((correct / total) * 100);
            resultsHTML += `<div style="font-weight:bold; margin-top:16px; font-size:1.1em;">
                Final Score: ${score}% (${correct}/${total})
            </div>`;

            document.getElementById('results').innerHTML = resultsHTML;
            document.getElementById('results').style.display = 'block';
            scrollToElement('results');

            timerRunning = false;
            document.getElementById('pause-btn').textContent = 'Continue';
        }

        function resetQuiz() {
            document.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);
            document.querySelectorAll('input.blank').forEach(input => input.value = '');
            
            const pool = document.querySelector('.pool-items');
            document.querySelectorAll('.dropped-items .drag-item').forEach(heading => {
                pool.appendChild(heading);
            });

            document.querySelectorAll('.q-item').forEach(item => item.classList.remove('answered'));
            document.getElementById('results').style.display = 'none';
            document.getElementById('results').innerHTML = '';
            
            seconds = 0;
            updateTimer();
            timerRunning = true;
            document.getElementById('pause-btn').textContent = 'Pause';
            userAnswers = {};
        }
        
        // Highlighting functionality
        function showToast(msg) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed; bottom: 80px; left: 50%; 
                transform: translateX(-50%); background: var(--selbar-bg); 
                color: var(--selbar-text); padding: 8px 16px; 
                border-radius: 8px; z-index: 7000; font-size: 14px;
            `;
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 1200);
        }

        function positionSelbarForRect(rect) {
            selbar.style.display = 'flex';
            requestAnimationFrame(() => {
                const top = window.scrollY + rect.top - selbar.offsetHeight - 8;
                const left = window.scrollX + rect.left + rect.width / 2 - selbar.offsetWidth / 2;
                selbar.style.top = `${(top > 0) ? top : (window.scrollY + rect.bottom + 8)}px`;
                selbar.style.left = `${Math.max(8, left)}px`;
            });
        }

        function updateSelbar() {
            const sel = window.getSelection();
            if (!sel || sel.rangeCount === 0 || sel.isCollapsed) {
                if (!keepToolbar && !currentHlNode) {
                    selbar.style.display = 'none';
                    currentHlNode = null;
                }
                return;
            }
            const range = sel.getRangeAt(0);
            
            const leftPane = document.getElementById('left');
            const rightPane = document.getElementById('right');
            let container = range.commonAncestorContainer;
            if (container.nodeType === Node.TEXT_NODE) {
                container = container.parentElement;
            }

            const isInLeftPane = leftPane.contains(container);
            const isInRightPane = rightPane.contains(container);
            const isHighlighted = container.classList?.contains('hl') || container.closest('.hl') !== null;
            
            if (!isInLeftPane && !isInRightPane && !isHighlighted) {
                selbar.style.display = 'none';
                return;
            }
            
            lastRange = range.cloneRange();
            currentHlNode = isHighlighted ? container.closest('.hl') : null;
            positionSelbarForRect(range.getBoundingClientRect());
        }

        function doHighlight() {
            if (currentHlNode || !lastRange || lastRange.collapsed) return;

            const sel = window.getSelection();
            let range = lastRange.cloneRange();
            try {
                const span = document.createElement('span');
                span.className = 'hl';
                range.surroundContents(span);
            } catch (e) {
                console.error("Highlighting failed:", e);
                showToast('Highlighting failed');
                return;
            }
            
            sel?.removeAllRanges();
            selbar.style.display = 'none';
            showToast('Highlighted');
        }

        function removeHighlight() {
            const sel = window.getSelection();
            let targetNode = currentHlNode;
            
            if (!targetNode && lastRange) {
                let container = lastRange.commonAncestorContainer;
                if (container.nodeType === Node.TEXT_NODE) {
                    container = container.parentElement;
                }
                targetNode = container.closest('.hl');
            }

            if (targetNode) {
                const p = targetNode.parentNode;
                while (targetNode.firstChild) {
                    p.insertBefore(targetNode.firstChild, targetNode);
                }
                p.removeChild(targetNode);
                p.normalize();
            }
            
            currentHlNode = null;
            sel?.removeAllRanges();
            selbar.style.display = 'none';
            showToast('Highlight removed');
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            startTimer();
            setupAnswerTracking();
            setupDragAndDrop();

            document.getElementById('size-btn').addEventListener('click', (e) => {
                 e.stopPropagation();
                 settingsOpen = !settingsOpen;
                 document.getElementById('settings-panel').style.display = settingsOpen ? 'block' : 'none';
            });
            document.getElementById('color-btn').addEventListener('click', (e) => {
                 e.stopPropagation();
                 settingsOpen = !settingsOpen;
                 document.getElementById('settings-panel').style.display = settingsOpen ? 'block' : 'none';
            });
            document.getElementById('note-btn').addEventListener('click', () => {
                closeAllPanels();
                notesOpen = true;
                document.getElementById('notes-panel').style.display = 'flex';
                document.querySelector('.overlay').style.display = 'block';
            });

            document.querySelectorAll('.settings-option[data-size]').forEach(btn => btn.addEventListener('click', function() {
                document.documentElement.className = `font-${this.dataset.size}`;
                document.querySelectorAll('.settings-option[data-size]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            }));
            document.querySelectorAll('.settings-option[data-mode]').forEach(btn => btn.addEventListener('click', function() {
                document.body.classList.toggle('dark-mode', this.dataset.mode === 'dark');
                document.querySelectorAll('.settings-option[data-mode]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            }));

            document.getElementById('close-note').addEventListener('click', closeAllPanels);
            document.querySelector('.overlay').addEventListener('click', closeAllPanels);
            document.addEventListener('click', (e) => {
                const settingsPanel = document.getElementById('settings-panel');
                const headerControls = document.querySelector('.header-controls');
                if (!settingsPanel.contains(e.target) && !headerControls.contains(e.target)) {
                    settingsPanel.style.display = 'none';
                    settingsOpen = false;
                }
            });

            document.getElementById('submit-btn').addEventListener('click', grade);
            document.getElementById('reset-btn').addEventListener('click', resetQuiz);
            document.getElementById('pause-btn').addEventListener('click', function() {
                timerRunning = !timerRunning;
                this.textContent = timerRunning ? 'Pause' : 'Continue';
            });

            document.addEventListener('mouseup', () => setTimeout(updateSelbar, 10));
            document.addEventListener('selectionchange', () => setTimeout(updateSelbar, 10));
            document.addEventListener('mousedown', (e) => { keepToolbar = !!e.target.closest('#selbar, .hl'); }, true);

            document.addEventListener('click', (e) => {
                const target = e.target;
                if (target.classList.contains('hl')) {
                    currentHlNode = target;
                    lastRange = null;
                    positionSelbarForRect(target.getBoundingClientRect());
                    window.getSelection()?.removeAllRanges();
                    setTimeout(() => { keepToolbar = false; }, 0);
                } else if (!selbar.contains(e.target)) {
                    selbar.style.display = 'none';
                    currentHlNode = null;
                }
            }, true);
            
            document.getElementById('btnHL').addEventListener('click', doHighlight);
            document.getElementById('btnUH').addEventListener('click', removeHighlight);
            document.getElementById('btnNote').addEventListener('click', function() {
                let text = '';
                if (currentHlNode) {
                    text = (currentHlNode.textContent || '').trim();
                } else if (lastRange) {
                    text = (lastRange.cloneContents().textContent || '').trim();
                }
                if (text) {
                    const noteArea = document.querySelector('#notes-panel textarea');
                    noteArea.value += (noteArea.value ? '\n\n' : '') + '> ' + text;
                    closeAllPanels();
                    notesOpen = true;
                    document.getElementById('notes-panel').style.display = 'flex';
                    document.querySelector('.overlay').style.display = 'block';
                    noteArea.scrollTop = noteArea.scrollHeight;
                }
                selbar.style.display = 'none';
            });
        });
    </script>


\n
  <script>
/**
 * 练习页面增强器 - 统一版本
 * 整合了原有的practicePageManager功能，解决数据收集和正确答案提取问题
 */

if (!window.practicePageEnhancer) {
    console.log('[PracticeEnhancer] 初始化增强器');

    // 内嵌CorrectAnswerExtractor功能，确保在练习页面中可用
    if (!window.CorrectAnswerExtractor) {
        window.CorrectAnswerExtractor = class {
            constructor() {
                this.extractionStrategies = [
                    this.extractFromAnswersObject.bind(this),
                    this.extractFromResultsTable.bind(this),
                    this.extractFromDOM.bind(this),
                    this.extractFromScripts.bind(this)
                ];
            }

            extractFromPage(document = window.document) {
                console.log('[CorrectAnswerExtractor] 开始提取正确答案');
                
                for (const strategy of this.extractionStrategies) {
                    try {
                        const answers = strategy(document);
                        if (answers && Object.keys(answers).length > 0) {
                            console.log('[CorrectAnswerExtractor] 提取成功:', strategy.name, answers);
                            return this.normalizeAnswers(answers);
                        }
                    } catch (error) {
                        console.warn(`[CorrectAnswerExtractor] 策略 ${strategy.name} 失败:`, error);
                    }
                }
                
                console.warn('[CorrectAnswerExtractor] 所有提取策略都失败了');
                return {};
            }

            extractFromAnswersObject(document = window.document) {
                const win = document.defaultView || window;
                
                const possibleAnswerObjects = [
                    'answers', 'correctAnswers', 'examAnswers', 'questionAnswers', 'solutionAnswers'
                ];
                
                for (const objName of possibleAnswerObjects) {
                    if (win[objName] && typeof win[objName] === 'object') {
                        console.log(`[CorrectAnswerExtractor] 找到全局对象: ${objName}`);
                        return win[objName];
                    }
                }
                
                return this.extractFromScriptVariables(document);
            }

            extractFromScriptVariables(document = window.document) {
                const scripts = document.querySelectorAll('script');
                
                for (const script of scripts) {
                    const content = script.textContent || script.innerHTML;
                    
                    const correctAnswersMatch = content.match(/(?:const|let|var)\s+correctAnswers\s*=\s*(\{[^}]+\})/s);
                    if (correctAnswersMatch) {
                        try {
                            const answersStr = correctAnswersMatch[1];
                            const answers = this.parseAnswersObject(answersStr);
                            if (answers && Object.keys(answers).length > 0) {
                                console.log('[CorrectAnswerExtractor] 从脚本变量提取答案:', answers);
                                return answers;
                            }
                        } catch (error) {
                            console.warn('[CorrectAnswerExtractor] 解析脚本变量失败:', error);
                        }
                    }
                }
                
                return null;
            }

            parseAnswersObject(objectStr) {
                try {
                    let cleanStr = objectStr
                        .replace(/\/\/.*$/gm, '')
                        .replace(/\/\*[\s\S]*?\*\//g, '')
                        .trim();
                    
                    if (cleanStr.startsWith('{') && cleanStr.endsWith('}')) {
                        cleanStr = cleanStr.replace(/([{,]\s*)([a-zA-Z_$][a-zA-Z0-9_$]*)\s*:/g, '$1"$2":');
                        return JSON.parse(cleanStr);
                    }
                } catch (error) {
                    console.warn('[CorrectAnswerExtractor] JSON解析失败，尝试其他方法:', error);
                }
                
                return this.manualParseAnswers(objectStr);
            }

            manualParseAnswers(objectStr) {
                const answers = {};
                const keyValuePattern = /([a-zA-Z0-9_]+)\s*:\s*['"`]([^'"`]+)['"`]/g;
                let match;
                
                while ((match = keyValuePattern.exec(objectStr)) !== null) {
                    const key = match[1];
                    const value = match[2];
                    answers[key] = value;
                }
                
                return Object.keys(answers).length > 0 ? answers : null;
            }

            extractFromResultsTable(document = window.document) {
                const selectors = [
                    '.results-table', '.answer-table', '.score-table',
                    'table[class*="result"]', 'table[class*="answer"]',
                    '.exam-results table', '#results table'
                ];
                
                for (const selector of selectors) {
                    const table = document.querySelector(selector);
                    if (table) {
                        return this.parseAnswersFromTable(table);
                    }
                }
                
                return null;
            }

            extractFromDOM(document = window.document) {
                const answers = {};
                const answerSelectors = [
                    '[data-correct-answer]', '.correct-answer', '.solution',
                    '[class*="correct"]', '[id*="correct"]'
                ];
                
                for (const selector of answerSelectors) {
                    const elements = document.querySelectorAll(selector);
                    elements.forEach((el, index) => {
                        const questionId = this.extractQuestionId(el) || `q${index + 1}`;
                        const answer = this.extractAnswerFromElement(el);
                        if (answer) {
                            answers[questionId] = answer;
                        }
                    });
                }
                
                return Object.keys(answers).length > 0 ? answers : null;
            }

            extractFromScripts(document = window.document) {
                const scripts = document.querySelectorAll('script');
                
                for (const script of scripts) {
                    const content = script.textContent || script.innerHTML;
                    if (content.includes('answer') || content.includes('correct')) {
                        try {
                            const jsonMatch = content.match(/(?:answers?|correct)\s*[:=]\s*(\{[^}]+\}|\[[^\]]+\])/i);
                            if (jsonMatch) {
                                const answers = JSON.parse(jsonMatch[1]);
                                if (answers && typeof answers === 'object') {
                                    return answers;
                                }
                            }
                        } catch (error) {
                            // 继续尝试其他方法
                        }
                    }
                }
                
                return null;
            }

            parseAnswersFromTable(table) {
                const answers = {};
                const rows = table.querySelectorAll('tr');
                
                for (const row of rows) {
                    const cells = row.querySelectorAll('td, th');
                    if (cells.length >= 2) {
                        const questionCell = cells[0];
                        const answerCell = this.findAnswerCell(cells);
                        
                        if (answerCell) {
                            const questionId = this.extractQuestionId(questionCell);
                            const answer = this.extractAnswerFromElement(answerCell);
                            
                            if (questionId && answer) {
                                answers[questionId] = answer;
                            }
                        }
                    }
                }
                
                return Object.keys(answers).length > 0 ? answers : null;
            }

            findAnswerCell(cells) {
                for (let i = 1; i < cells.length; i++) {
                    const cell = cells[i];
                    const text = cell.textContent.toLowerCase();
                    const className = cell.className.toLowerCase();
                    
                    if (text.includes('correct') || text.includes('answer') || 
                        className.includes('correct') || className.includes('answer') ||
                        text.includes('正确') || text.includes('答案')) {
                        return cell;
                    }
                }
                
                return cells[1];
            }

            extractQuestionId(element) {
                if (element.dataset.questionId) {
                    return element.dataset.questionId;
                }
                
                if (element.id) {
                    const match = element.id.match(/q(\d+)|question[_-]?(\d+)/i);
                    if (match) {
                        return `q${match[1] || match[2]}`;
                    }
                }
                
                const text = element.textContent;
                const match = text.match(/(?:问题|题目|Question)\s*[#:]?\s*(\d+)|^(\d+)[.)]/);
                if (match) {
                    return `q${match[1] || match[2]}`;
                }
                
                return null;
            }

            extractAnswerFromElement(element) {
                if (element.dataset.correctAnswer) {
                    return element.dataset.correctAnswer;
                }
                
                if (element.dataset.answer) {
                    return element.dataset.answer;
                }
                
                let text = element.textContent.trim();
                text = text.replace(/^(?:正确答案[:：]?|答案[:：]?|Correct Answer[:：]?|Answer[:：]?)\s*/i, '');
                
                if (/^(true|false)$/i.test(text)) {
                    return text.toUpperCase();
                }
                
                if (/^[A-Z]$/i.test(text)) {
                    return text.toUpperCase();
                }
                
                return text;
            }

            normalizeAnswers(answers) {
                const normalized = {};
                
                for (const [key, value] of Object.entries(answers)) {
                    const normalizedKey = key.toString().toLowerCase().startsWith('q') 
                        ? key 
                        : `q${key}`;
                    
                    let normalizedValue = value;
                    if (typeof value === 'string') {
                        normalizedValue = value.trim();
                        
                        if (/^(true|t|yes|y|正确|是)$/i.test(normalizedValue)) {
                            normalizedValue = 'TRUE';
                        } else if (/^(false|f|no|n|错误|否)$/i.test(normalizedValue)) {
                            normalizedValue = 'FALSE';
                        }
                        
                        if (/^[A-Z]$/i.test(normalizedValue)) {
                            normalizedValue = normalizedValue.toUpperCase();
                        }
                    }
                    
                    normalized[normalizedKey] = normalizedValue;
                }
                
                return normalized;
            }
        };
    }

    window.practicePageEnhancer = {
        sessionId: null,
        parentWindow: null,
        answers: {},
        correctAnswers: {},
        interactions: [],
        startTime: Date.now(),
        isInitialized: false,

        initialize: function () {
            if (this.isInitialized) {
                console.log('[PracticeEnhancer] 已经初始化，跳过');
                return;
            }
            console.log('[PracticeEnhancer] 开始初始化');
            this.setupCommunication();
            this.setupAnswerListeners();
            this.extractCorrectAnswers(); // 新增：提取正确答案
            this.interceptSubmit();
            this.setupInteractionTracking();
            this.isInitialized = true;
            console.log('[PracticeEnhancer] 初始化完成');
            
            // 页面加载完成后进行一次初始收集
            if (document.readyState === 'complete') {
                setTimeout(() => this.collectAllAnswers(), 1000);
            } else {
                window.addEventListener('load', () => {
                    setTimeout(() => this.collectAllAnswers(), 1000);
                });
            }
        },

        cleanup: function() {
            console.log('[PracticeEnhancer] 清理资源');
            if (this.answerCollectionInterval) {
                clearInterval(this.answerCollectionInterval);
                this.answerCollectionInterval = null;
            }
        },

        setupCommunication: function () {
            this.parentWindow = window.opener || window.parent;
            if (!this.parentWindow || this.parentWindow === window) {
                console.warn('[PracticeEnhancer] 未检测到父窗口');
                return;
            }
            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'INIT_SESSION') {
                    this.sessionId = event.data.data.sessionId;
                    console.log('[PracticeEnhancer] 收到会话初始化:', this.sessionId);
                    this.sendMessage('SESSION_READY', {
                        pageType: this.detectPageType(),
                        url: window.location.href,
                        title: document.title
                    });
                }
            });
            console.log('[PracticeEnhancer] 通信设置完成');
        },

        detectPageType: function () {
            const title = document.title || '';
            const url = window.location.href || '';
            if (title.includes('P1') || url.includes('P1')) return 'P1';
            if (title.includes('P2') || url.includes('P2')) return 'P2';
            if (title.includes('P3') || url.includes('P3')) return 'P3';
            const pathParts = url.split('/');
            for (let part of pathParts) {
                if (part.match(/^P[123]$/i)) {
                    return part.toUpperCase();
                }
            }
            return 'unknown';
        },

        extractCorrectAnswers: function () {
            console.log('[PracticeEnhancer] 开始提取正确答案');
            
            // 使用CorrectAnswerExtractor如果可用
            if (window.CorrectAnswerExtractor) {
                try {
                    const extractor = new CorrectAnswerExtractor();
                    const extractedAnswers = extractor.extractFromPage(document);
                    
                    if (extractedAnswers && Object.keys(extractedAnswers).length > 0) {
                        this.correctAnswers = extractedAnswers;
                        console.log('[PracticeEnhancer] 使用提取器成功获得正确答案:', this.correctAnswers);
                    } else {
                        console.warn('[PracticeEnhancer] 提取器未找到答案，使用备用方法');
                        this.extractCorrectAnswersBackup();
                    }
                } catch (error) {
                    console.warn('[PracticeEnhancer] 提取器失败，使用备用方法:', error);
                    this.extractCorrectAnswersBackup();
                }
            } else {
                console.warn('[PracticeEnhancer] CorrectAnswerExtractor未加载，使用备用方法');
                this.extractCorrectAnswersBackup();
            }
            
            // 延迟提取，在页面完全加载后再次尝试
            setTimeout(function() {
                this.extractFromResultsTable();
            }.bind(this), 2000);
            
            // 定期检查是否有新的正确答案数据
            this.startCorrectAnswerMonitoring();
        },

        extractCorrectAnswersBackup: function () {
            // 多种备用提取方法
            const sources = ['answers', 'correctAnswers', 'answerKey', 'solutions'];
            
            for (const source of sources) {
                if (window[source] && typeof window[source] === 'object') {
                    Object.keys(window[source]).forEach(key => {
                        const value = window[source][key];
                        if (value !== undefined && value !== null) {
                            let normalizedKey = key;
                            if (!normalizedKey.startsWith('q') && /^\d+$/.test(normalizedKey)) {
                                normalizedKey = 'q' + normalizedKey;
                            }
                            this.correctAnswers[normalizedKey] = String(value).trim();
                        }
                    });
                }
            }
            
            // 尝试从DOM中提取
            this.extractFromDOM();
            
            console.log('[PracticeEnhancer] 备用方法提取正确答案:', this.correctAnswers);
        },

        extractFromDOM: function () {
            // 查找包含正确答案的元素
            const selectors = [
                '[data-correct-answer]',
                '.correct-answer',
                '.answer-key',
                '[data-answer]'
            ];
            
            const self = this;
            for (let i = 0; i < selectors.length; i++) {
                const selector = selectors[i];
                const elements = document.querySelectorAll(selector);
                for (let j = 0; j < elements.length; j++) {
                    const element = elements[j];
                    const questionId = element.dataset.question || 
                                     element.dataset.for || 
                                     element.dataset.questionId;
                    const correctAnswer = element.dataset.correctAnswer || 
                                        element.dataset.answer || 
                                        element.textContent.trim();
                    
                    if (questionId && correctAnswer) {
                        self.correctAnswers[questionId] = correctAnswer;
                    }
                }
            }
        },

        extractFromResultsTable: function () {
            console.log('[PracticeEnhancer] 尝试从结果表格提取正确答案');
            
            // 查找结果显示区域
            const resultsEl = document.getElementById('results');
            if (!resultsEl) {
                console.log('[PracticeEnhancer] 未找到results元素');
                return;
            }
            
            // 查找表格
            const tables = resultsEl.querySelectorAll('table');
            console.log('[PracticeEnhancer] 找到表格数量:', tables.length);
            
            for (let i = 0; i < tables.length; i++) {
                const table = tables[i];
                const rows = table.querySelectorAll('tr');
                console.log('[PracticeEnhancer] 表格', i, '行数:', rows.length);
                
                for (let j = 1; j < rows.length; j++) { // 跳过表头
                    const row = rows[j];
                    const cells = row.querySelectorAll('td');
                    
                    if (cells.length >= 3) {
                        const questionCell = cells[0];
                        const userAnswerCell = cells[1];
                        const correctAnswerCell = cells[2];
                        
                        const questionText = questionCell.textContent.trim();
                        const userAnswer = userAnswerCell.textContent.trim();
                        const correctAnswer = correctAnswerCell.textContent.trim();
                        
                        console.log('[PracticeEnhancer] 处理行:', questionText, userAnswer, correctAnswer);
                        
                        // 提取问题编号
                        const questionMatch = questionText.match(/(\d+)/);
                        if (questionMatch && correctAnswer && correctAnswer !== 'N/A' && correctAnswer !== '') {
                            const questionNum = questionMatch[1];
                            const questionKey = 'q' + questionNum;
                            this.correctAnswers[questionKey] = correctAnswer;
                            
                            // 同时更新用户答案，确保数据一致性
                            if (userAnswer && userAnswer !== 'No Answer') {
                                this.answers[questionKey] = userAnswer;
                            }
                            
                            console.log('[PracticeEnhancer] 从表格提取:', questionKey, '用户答案:', userAnswer, '正确答案:', correctAnswer);
                        }
                    }
                }
            }
            
            console.log('[PracticeEnhancer] 表格提取完成，正确答案:', this.correctAnswers);
            console.log('[PracticeEnhancer] 表格提取完成，用户答案:', this.answers);
        },

        setupAnswerListeners: function () {
            const self = this;
            
            // 增强的change事件监听
            document.addEventListener('change', function(e) {
                self.recordAnswer(e.target);
            });

            // 增强的input事件监听
            document.addEventListener('input', function(e) {
                self.recordAnswer(e.target);
            });

            // 点击事件监听（用于单选框、复选框）
            document.addEventListener('click', function(e) {
                if (e.target.type === 'radio' || e.target.type === 'checkbox') {
                    setTimeout(() => self.recordAnswer(e.target), 10);
                }
            });

            // 拖拽事件监听
            document.addEventListener('drop', function(e) {
                setTimeout(function() {
                    self.collectDropzoneAnswers();
                    self.collectAllAnswers(); // 全面收集一次
                }, 100);
            });

            // 页面可见性变化时收集答案（替代定期收集）
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    console.log('[PracticeEnhancer] 页面隐藏，收集答案');
                    self.collectAllAnswers();
                } else {
                    console.log('[PracticeEnhancer] 页面显示，准备收集答案');
                }
            });

            // 页面卸载前收集答案和清理
            window.addEventListener('beforeunload', function() {
                console.log('[PracticeEnhancer] 页面卸载，收集答案并清理');
                self.collectAllAnswers();
                self.cleanup();
            });

            // 页面失去焦点时收集答案
            window.addEventListener('blur', function() {
                console.log('[PracticeEnhancer] 页面失去焦点，收集答案');
                self.collectAllAnswers();
            });

            console.log('[PracticeEnhancer] 增强答案监听器设置完成');
        },

        recordAnswer: function(element) {
            if (!element) return;

            let questionId = null;
            let value = null;

            // 获取问题ID
            if (element.name) {
                questionId = element.name;
            } else if (element.id) {
                questionId = element.id.replace(/_input$|-input$|_answer$/, '');
            } else if (element.dataset.question) {
                questionId = element.dataset.question;
            }

            // 获取答案值
            if (element.type === 'radio' || element.type === 'checkbox') {
                if (element.checked) {
                    value = element.value;
                }
            } else {
                value = element.value;
            }

            // 记录答案
            if (questionId && value !== null && value !== '') {
                this.answers[questionId] = value;
                console.log('[PracticeEnhancer] 记录答案:', questionId, '=', value);
                
                // 记录交互
                this.interactions.push({
                    type: 'answer',
                    questionId: questionId,
                    value: value,
                    timestamp: Date.now(),
                    elementType: element.type || element.tagName.toLowerCase()
                });
            }
        },

        collectDropzoneAnswers: function () {
            // 收集拖拽填空题答案
            const dropzones = document.querySelectorAll('.dropzone');
            for (let i = 0; i < dropzones.length; i++) {
                const zone = dropzones[i];
                const qName = zone.dataset.target;
                const card = zone.querySelector('.card');
                if (qName && card) {
                    this.answers[qName] = card.dataset.value || card.textContent.trim();
                }
            }

            // 收集段落匹配题答案
            const paragraphZones = document.querySelectorAll('.paragraph-dropzone');
            for (let i = 0; i < paragraphZones.length; i++) {
                const zone = paragraphZones[i];
                const paragraph = zone.dataset.paragraph;
                const items = zone.querySelectorAll('.drag-item');
                if (paragraph && items.length > 0) {
                    const itemTexts = [];
                    for (let j = 0; j < items.length; j++) {
                        const item = items[j];
                        itemTexts.push(item.dataset.heading || item.textContent.trim());
                    }
                    this.answers['q' + paragraph.toLowerCase()] = itemTexts.join(',');
                }
            }

            // 收集匹配题答案
            const matchZones = document.querySelectorAll('.match-dropzone');
            for (let i = 0; i < matchZones.length; i++) {
                const zone = matchZones[i];
                const qName = zone.dataset.question;
                const item = zone.querySelector('.drag-item-clone');
                if (qName && item) {
                    this.answers[qName] = item.dataset.country || item.textContent.trim();
                }
            }
        },

        interceptSubmit: function () {
            // 延迟拦截，确保页面完全加载
            setTimeout(function() {
                // 拦截gradeAnswers函数
                if (typeof window.gradeAnswers === 'function') {
                    const originalGradeAnswers = window.gradeAnswers;
                    const self = this;
                    window.gradeAnswers = function() {
                        console.log('[PracticeEnhancer] 拦截到gradeAnswers调用');
                        self.collectAllAnswers();
                        const result = originalGradeAnswers();
                        self.handleSubmit();
                        return result;
                    };
                    console.log('[PracticeEnhancer] gradeAnswers函数拦截成功');
                } else {
                    console.warn('[PracticeEnhancer] 未找到gradeAnswers函数');
                }

                // 拦截grade函数
                if (typeof window.grade === 'function') {
                    const originalGrade = window.grade;
                    const self = this;
                    window.grade = function() {
                        console.log('[PracticeEnhancer] 拦截到grade调用');
                        self.collectAllAnswers();
                        const result = originalGrade();
                        self.handleSubmit();
                        return result;
                    };
                    console.log('[PracticeEnhancer] grade函数拦截成功');
                }
            }.bind(this), 1000);

            // 监听表单提交
            document.addEventListener('submit', (e) => {
                console.log('[PracticeEnhancer] 拦截到表单提交');
                this.collectAllAnswers();
                this.handleSubmit();
            });

            // 监听提交按钮点击 - 增强版
            const self = this;
            document.addEventListener('click', function(e) {
                console.log('[PracticeEnhancer] 点击事件:', e.target.tagName, e.target.id, e.target.className);

                if (e.target.tagName === 'BUTTON' &&
                    (e.target.textContent.includes('Submit') ||
                        e.target.textContent.includes('提交') ||
                        e.target.textContent.includes('完成') ||
                        e.target.textContent.includes('Check') ||
                        e.target.classList.contains('primary') ||
                        e.target.id === 'submit-btn' ||
                        (e.target.onclick && e.target.onclick.toString().includes('grade')))) {
                    console.log('[PracticeEnhancer] 检测到提交按钮点击:', e.target);
                    self.collectAllAnswers();
                    self.handleSubmit();
                }
            });

            // 定期检查结果是否出现
            this.startResultsMonitoring();

            console.log('[PracticeEnhancer] 提交拦截设置完成');
        },

        startCorrectAnswerMonitoring: function() {
            let checkCount = 0;
            const maxChecks = 30;
            const self = this;

            function checkForCorrectAnswers() {
                checkCount++;
                
                // 尝试从结果表格提取
                const resultsEl = document.getElementById('results');
                if (resultsEl && resultsEl.style.display !== 'none') {
                    const tables = resultsEl.querySelectorAll('table');
                    if (tables.length > 0) {
                        const firstTable = tables[0];
                        const rows = firstTable.querySelectorAll('tr');
                        if (rows.length > 1) { // 有数据行
                            console.log('[PracticeEnhancer] 检测到结果表格，提取正确答案');
                            self.extractFromResultsTable();
                        }
                    }
                }
                
                // 继续检查直到达到最大次数
                if (checkCount < maxChecks && Object.keys(self.correctAnswers).length === 0) {
                    setTimeout(checkForCorrectAnswers, 1000);
                }
            }

            setTimeout(checkForCorrectAnswers, 3000);
        },

        startResultsMonitoring: function() {
            let checkCount = 0;
            const maxChecks = 60;
            const self = this;

            function checkResults() {
                checkCount++;
                const resultsEl = document.getElementById('results');

                if (resultsEl && resultsEl.style.display !== 'none' && resultsEl.textContent.includes('Final Score')) {
                    console.log('[PracticeEnhancer] 检测到结果显示，自动提取分数');
                    self.collectAllAnswers();
                    // 不需要额外延迟，handleSubmit内部已经有延迟处理
                    self.handleSubmit();
                    return;
                }

                if (checkCount < maxChecks) {
                    setTimeout(checkResults, 500);
                }
            }

            setTimeout(checkResults, 2000);
        },

        collectAllAnswers: function () {
            console.log('[PracticeEnhancer] 开始全面收集答案...');
            
            const beforeCount = Object.keys(this.answers).length;

            // 1. 收集所有输入元素（更广泛的选择器）
            const allInputs = document.querySelectorAll('input, textarea, select');
            console.log('[PracticeEnhancer] 找到输入元素总数:', allInputs.length);
            
            allInputs.forEach((input, index) => {
                const questionId = this.getQuestionId(input);
                const value = this.getInputValue(input);

                if (input.type === 'text') {
                    console.log(`[DEBUG] Text Input Found: id='${input.id}', name='${input.name}', derived_questionId='${questionId}', value='${value}'`);
                }
                
                console.log(`[PracticeEnhancer] 输入元素 ${index}: type=${input.type}, name=${input.name}, id=${input.id}, value=${value}, questionId=${questionId}`);
                
                if (questionId && value !== null && value !== '') {
                    this.answers[questionId] = value;
                    console.log(`[PracticeEnhancer] 记录答案: ${questionId} = ${value}`);
                }
            });

            // 2. 收集拖拽答案
            this.collectDropzoneAnswers();

            // 3. 收集特殊格式的答案（通过data属性）
            const answerElements = document.querySelectorAll('[data-answer], [data-user-answer], [data-value]');
            console.log('[PracticeEnhancer] 找到data答案元素:', answerElements.length);
            
            answerElements.forEach(element => {
                const questionId = element.dataset.question || element.dataset.for || element.id;
                const answer = element.dataset.answer || element.dataset.userAnswer || element.dataset.value;
                if (questionId && answer) {
                    this.answers[questionId] = answer;
                    console.log(`[PracticeEnhancer] 记录data答案: ${questionId} = ${answer}`);
                }
            });

            // 4. 收集匹配题答案
            this.collectMatchingAnswers();

            // 5. 收集排序题答案
            this.collectOrderingAnswers();

            // 6. 尝试从页面特定结构收集答案
            this.collectFromPageStructure();

            const afterCount = Object.keys(this.answers).length;
            console.log(`[PracticeEnhancer] 全面收集完成，答案数量从 ${beforeCount} 增加到 ${afterCount}`);
            console.log('[PracticeEnhancer] 收集到的所有答案:', this.answers);
        },

        getQuestionId: function(input) {
            // 尝试多种方式获取问题ID
            if (input.name) return input.name;
            if (input.id) return input.id.replace(/_input$|-input$|_answer$/, '');
            if (input.dataset.question) return input.dataset.question;
            if (input.dataset.for) return input.dataset.for;
            
            // 尝试从父元素获取
            let parent = input.parentElement;
            while (parent && parent !== document.body) {
                if (parent.dataset.question) return parent.dataset.question;
                if (parent.id && parent.id.includes('q')) return parent.id;
                parent = parent.parentElement;
            }
            
            // 尝试从相邻元素获取
            const label = document.querySelector(`label[for="${input.id}"]`);
            if (label && label.textContent) {
                const match = label.textContent.match(/(\d+)/);
                if (match) return 'q' + match[1];
            }
            
            return null;
        },

        getInputValue: function(input) {
            if (input.type === 'radio' || input.type === 'checkbox') {
                return input.checked ? input.value : null;
            }
            return input.value;
        },

        collectFromPageStructure: function() {
            console.log('[PracticeEnhancer] 尝试从页面结构收集答案...');
            
            // 查找所有可能包含问题的容器
            const questionContainers = document.querySelectorAll(
                '.question, .quiz-question, [class*="question"], [id*="question"], [data-question]'
            );
            
            console.log('[PracticeEnhancer] 找到问题容器:', questionContainers.length);
            
            questionContainers.forEach((container, index) => {
                console.log(`[PracticeEnhancer] 处理问题容器 ${index}:`, container.className, container.id);
                
                // 在容器内查找输入元素
                const inputs = container.querySelectorAll('input, textarea, select');
                inputs.forEach(input => {
                    const questionId = this.getQuestionId(input) || `q${index + 1}`;
                    const value = this.getInputValue(input);
                    
                    if (value !== null && value !== '') {
                        this.answers[questionId] = value;
                        console.log(`[PracticeEnhancer] 从容器收集答案: ${questionId} = ${value}`);
                    }
                });
            });
        },

        collectMatchingAnswers: function() {
            // 收集匹配题的答案
            const matchContainers = document.querySelectorAll('.matching-container, .match-exercise, [class*="match"]');
            matchContainers.forEach(container => {
                const pairs = container.querySelectorAll('.match-pair, .matched-item');
                pairs.forEach(pair => {
                    const questionId = pair.dataset.question || pair.dataset.left;
                    const answer = pair.dataset.answer || pair.dataset.right;
                    if (questionId && answer) {
                        this.answers[questionId] = answer;
                    }
                });
            });
        },

        collectOrderingAnswers: function() {
            // 收集排序题的答案
            const orderContainers = document.querySelectorAll('.ordering-container, .sort-exercise, [class*="order"]');
            orderContainers.forEach(container => {
                const items = container.querySelectorAll('.order-item, .sortable-item');
                const orderedAnswers = [];
                items.forEach((item, index) => {
                    const value = item.dataset.value || item.textContent.trim();
                    if (value) {
                        orderedAnswers.push(value);
                    }
                });
                
                if (orderedAnswers.length > 0) {
                    const questionId = container.dataset.question || 'ordering';
                    this.answers[questionId] = orderedAnswers.join(',');
                }
            });
        },

        setupInteractionTracking: function () {
            const self = this;
            document.addEventListener('click', function(e) {
                self.interactions.push({
                    type: 'click',
                    target: e.target.tagName + (e.target.className ? '.' + e.target.className : ''),
                    timestamp: Date.now()
                });
            });

            let scrollTimeout;
            document.addEventListener('scroll', function() {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(function() {
                    self.interactions.push({
                        type: 'scroll',
                        scrollY: window.scrollY,
                        timestamp: Date.now()
                    });
                }, 500);
            });
        },

        handleSubmit: function () {
            if (!this.sessionId) {
                console.warn('[PracticeEnhancer] 无会话ID，无法发送数据');
                return;
            }

            const self = this;
            
            // 延迟发送数据，确保有足够时间提取正确答案
            setTimeout(function() {
                // 最后一次尝试提取正确答案
                self.extractFromResultsTable();
                
                // 再次延迟，等待异步提取完成
                setTimeout(function() {
                    // 如果仍然没有正确答案，尝试其他方法
                    if (Object.keys(self.correctAnswers).length === 0) {
                        self.extractCorrectAnswersBackup();
                    }

                    const endTime = Date.now();
                    const duration = Math.round((endTime - self.startTime) / 1000);

                    // 生成答案比较数据
                    const answerComparison = self.generateAnswerComparison();

                    const results = {
                        sessionId: self.sessionId,
                        examId: self.sessionId.split('_')[0] || 'unknown',
                        startTime: self.startTime,
                        endTime: endTime,
                        duration: duration,
                        answers: self.answers,
                        correctAnswers: self.correctAnswers, // 新增：正确答案
                        answerComparison: answerComparison, // 新增：答案比较
                        interactions: self.interactions,
                        scoreInfo: self.extractScore(),
                        pageType: self.detectPageType(),
                        url: window.location.href,
                        title: document.title
                    };

                    console.log('[PracticeEnhancer] 发送练习完成数据:', results);
                    self.sendMessage('PRACTICE_COMPLETE', results);
                }, 1000); // 再等1秒确保异步提取完成
            }, 500); // 先等0.5秒让结果表格完全显示
        },

        generateAnswerComparison: function () {
            const comparison = {};
            
            // 获取所有问题的键
            const userKeys = Object.keys(this.answers);
            const correctKeys = Object.keys(this.correctAnswers);
            const allQuestions = {};
            
            // 合并所有问题键
            for (let i = 0; i < userKeys.length; i++) {
                allQuestions[userKeys[i]] = true;
            }
            for (let i = 0; i < correctKeys.length; i++) {
                allQuestions[correctKeys[i]] = true;
            }
            
            const questionKeys = Object.keys(allQuestions);
            for (let i = 0; i < questionKeys.length; i++) {
                const questionKey = questionKeys[i];
                const userAnswer = this.answers[questionKey];
                const correctAnswer = this.correctAnswers[questionKey];
                
                comparison[questionKey] = {
                    userAnswer: userAnswer || null,
                    correctAnswer: correctAnswer || null,
                    isCorrect: this.compareAnswers(userAnswer, correctAnswer)
                };
            }
            
            console.log('[PracticeEnhancer] 生成答案比较:', comparison);
            return comparison;
        },

        compareAnswers: function (userAnswer, correctAnswer) {
            if (!userAnswer || !correctAnswer) {
                return false;
            }
            
            // 标准化答案进行比较
            const normalize = (str) => String(str).trim().toLowerCase();
            return normalize(userAnswer) === normalize(correctAnswer);
        },

        extractScore: function () {
            const resultsEl = document.getElementById('results');
            if (!resultsEl) {
                console.warn('[PracticeEnhancer] 未找到结果元素');
                return null;
            }

            const text = resultsEl.textContent || '';
            console.log('[PracticeEnhancer] 结果文本:', text);

            // 匹配 "Final Score: 85% (11/13)" 格式 - 66号文件格式
            const finalScoreMatch = text.match(/Final\s+Score:\s*(\d+)%\s*\((\d+)\/(\d+)\)/i);
            if (finalScoreMatch) {
                const percentage = parseInt(finalScoreMatch[1]);
                const correct = parseInt(finalScoreMatch[2]);
                const total = parseInt(finalScoreMatch[3]);
                const accuracy = total > 0 ? correct / total : 0;

                console.log('[PracticeEnhancer] 提取Final Score成绩:', { correct, total, accuracy, percentage });

                return {
                    correct: correct,
                    total: total,
                    accuracy: accuracy,
                    percentage: percentage,
                    source: 'final_score_extraction'
                };
            }

            // 匹配 "Score: 11/13" 格式
            const scoreMatch = text.match(/Score:\s*(\d+)\/(\d+)/i);
            if (scoreMatch) {
                const correct = parseInt(scoreMatch[1]);
                const total = parseInt(scoreMatch[2]);
                const accuracy = total > 0 ? correct / total : 0;
                const percentage = Math.round(accuracy * 100);

                console.log('[PracticeEnhancer] 提取Score成绩:', { correct, total, accuracy, percentage });

                return {
                    correct: correct,
                    total: total,
                    accuracy: accuracy,
                    percentage: percentage,
                    source: 'score_extraction'
                };
            }

            // 匹配 "Accuracy: 85%" 格式
            const accuracyPercentMatch = text.match(/Accuracy:\s*(\d+)%/i);
            if (accuracyPercentMatch) {
                const percentage = parseInt(accuracyPercentMatch[1]);
                return {
                    correct: 0,
                    total: 0,
                    accuracy: percentage / 100,
                    percentage: percentage,
                    source: 'accuracy_percentage_extraction'
                };
            }

            // 匹配单独的百分比 "85%" 格式
            const percentageMatch = text.match(/(\d+)%/);
            if (percentageMatch) {
                const percentage = parseInt(percentageMatch[1]);

                console.log('[PracticeEnhancer] 提取百分比成绩:', { percentage });

                return {
                    correct: 0,
                    total: 0,
                    accuracy: percentage / 100,
                    percentage: percentage,
                    source: 'percentage_extraction'
                };
            }

            // 匹配 "Accuracy 85%" 格式（无冒号）
            const accuracyMatch = text.match(/Accuracy\s+(\d+)%/i);
            if (accuracyMatch) {
                const percentage = parseInt(accuracyMatch[1]);
                return {
                    correct: 0,
                    total: 0,
                    accuracy: percentage / 100,
                    percentage: percentage,
                    source: 'accuracy_extraction'
                };
            }

            // 尝试从表格中提取成绩信息
            const correctCells = resultsEl.querySelectorAll('.result-correct');
            const incorrectCells = resultsEl.querySelectorAll('.result-incorrect');
            if (correctCells.length > 0 || incorrectCells.length > 0) {
                const correct = correctCells.length;
                const total = correctCells.length + incorrectCells.length;
                const accuracy = total > 0 ? correct / total : 0;
                const percentage = Math.round(accuracy * 100);

                console.log('[PracticeEnhancer] 从表格提取成绩:', { correct, total, accuracy, percentage });

                return {
                    correct: correct,
                    total: total,
                    accuracy: accuracy,
                    percentage: percentage,
                    source: 'table_extraction'
                };
            }

            console.warn('[PracticeEnhancer] 无法提取成绩信息，结果文本:', text);
            return null;
        },

        sendMessage: function (type, data) {
            if (!this.parentWindow) {
                console.warn('[PracticeEnhancer] 无父窗口，无法发送消息');
                return;
            }

            const message = {
                type: type,
                data: data,
                source: 'practice_page',
                timestamp: Date.now()
            };

            try {
                this.parentWindow.postMessage(message, '*');
                console.log('[PracticeEnhancer] 消息已发送:', type);
            } catch (error) {
                console.error('[PracticeEnhancer] 发送消息失败:', error);
            }
        },

        getStatus: function () {
            return {
                isInitialized: this.isInitialized,
                sessionId: this.sessionId,
                hasParentWindow: !!this.parentWindow,
                answersCount: Object.keys(this.answers).length,
                correctAnswersCount: Object.keys(this.correctAnswers).length, // 新增
                interactionsCount: this.interactions.length,
                pageType: this.detectPageType()
            };
        }
    };

    // 添加全局方法供调试和手动触发使用
    window.collectAnswersNow = function() {
        console.log('[PracticeEnhancer] 手动触发答案收集');
        window.practicePageEnhancer.collectAllAnswers();
        return window.practicePageEnhancer.answers;
    };

    window.getCorrectAnswers = function() {
        console.log('[PracticeEnhancer] 获取正确答案');
        window.practicePageEnhancer.extractCorrectAnswers();
        return window.practicePageEnhancer.correctAnswers;
    };

    // 自动初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            window.practicePageEnhancer.initialize();
        });
    } else {
        window.practicePageEnhancer.initialize();
    }

    // 调试函数
    window.debugPracticeEnhancer = () => {
        console.log('=== 练习页面增强器调试信息 ===');
        console.log('状态:', window.practicePageEnhancer.getStatus());
        console.log('用户答案:', window.practicePageEnhancer.answers);
        console.log('正确答案:', window.practicePageEnhancer.correctAnswers); // 新增
        console.log('答案比较:', window.practicePageEnhancer.generateAnswerComparison()); // 新增
        console.log('交互记录:', window.practicePageEnhancer.interactions);

        // 测试成绩提取
        const scoreInfo = window.practicePageEnhancer.extractScore();
        console.log('成绩提取测试:', scoreInfo);
    };
}
</script>
</body>
</html>