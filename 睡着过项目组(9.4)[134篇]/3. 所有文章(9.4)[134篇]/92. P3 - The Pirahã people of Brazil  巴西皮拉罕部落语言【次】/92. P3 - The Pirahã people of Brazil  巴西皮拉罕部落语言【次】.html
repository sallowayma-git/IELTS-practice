<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IELTS Reading Practice - The Pirahã people of Brazil</title>
  <style>
    :root { 
      --line:#e5e7eb; 
      --bg:#f6f7fb; 
      --panel:#fff; 
      --accent:#3b82f6; 
      --muted:#6b7280; 
      --shadow:0 6px 20px rgba(0,0,0,.12); 
      --text-color: #333;
      --highlight: #fff3a3;
      --selbar-bg: #111;
      --selbar-text: #fff;
    }

    body.dark-mode {
        --line: #4a4a4a;
        --bg: #1a1a1a;
        --panel: #2a2a2a;
        --muted: #bbb;
        --text-color: #f0f0f0;
        --highlight: #5b21b6;
        --selbar-bg: #1f2937;
        --selbar-text: #e5e7eb;
    }
    
    * { 
      box-sizing: border-box; 
      margin: 0;
      padding: 0;
    }

    html { font-size: 16px; }
    html.font-regular { font-size: 16px; }
    html.font-large { font-size: 18px; }
    html.font-xlarge { font-size: 20px; }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
      background: var(--bg);
      color: var(--text-color); 
      overflow: hidden;
      height: 100vh;
      transition: background-color 0.3s ease;
      padding-bottom: 64px;
    }

    .header {
        background-color: var(--panel);
        padding: 12px 20px;
        border-bottom: 1px solid var(--line);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        z-index: 100;
    }

    .header-content {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .header h1 {
        font-size: 1.2rem;
        font-weight: 500;
        color: var(--text-color);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    #timer {
        font-size: 1rem;
        font-weight: 500;
        background: var(--bg);
        padding: 6px 12px;
        border-radius: 6px;
        border: 1px solid var(--line);
        min-width: 90px;
        text-align: center;
        color: var(--text-color);
    }

    .header-controls {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .header-btn {
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: 6px;
        padding: 6px 12px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.2s ease;
        color: var(--text-color);
    }

    .header-btn:hover {
        background: var(--bg);
        border-color: var(--accent);
    }

    #settings-panel {
        position: absolute;
        top: 60px;
        right: 20px;
        width: 200px;
        background: var(--panel);
        border-radius: 12px;
        box-shadow: var(--shadow);
        border: 1px solid var(--line);
        z-index: 1000;
        padding: 8px;
        display: none;
    }

    .settings-group {
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--line);
    }
     .settings-group:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }

    .settings-title {
        font-size: 0.85rem;
        color: var(--muted);
        margin-bottom: 8px;
        padding-left: 12px;
    }

    .settings-option {
        display: block;
        width: 100%;
        text-align: left;
        padding: 8px 12px;
        border: none;
        background: none;
        cursor: pointer;
        font-size: 0.9rem;
        border-radius: 6px;
        color: var(--text-color);
    }

    .settings-option.active {
        background: #e9effd;
        color: var(--accent);
        font-weight: 500;
    }

    .dark-mode .settings-option.active {
        background: #1e3a8a;
    }

    #notes-panel {
        position: fixed;
        right: 12px;
        bottom: 76px;
        width: 320px;
        height: 45vh;
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: 12px;
        display: none;
        flex-direction: column;
        z-index: 900;
        box-shadow: var(--shadow);
        overflow: hidden;
    }

    #notes-panel header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        border-bottom: 1px solid var(--line);
        background-color: var(--bg);
    }

    #notes-panel h3 {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-color);
        margin: 0;
    }

    #notes-panel textarea {
        flex: 1;
        border: 0;
        padding: 16px;
        resize: none;
        font-size: 0.95rem;
        background: transparent;
        color: var(--text-color);
        line-height: 1.6;
    }

    #notes-panel textarea:focus {
        outline: none;
    }

    #close-note {
        padding: 4px 8px;
        border-radius: 4px;
        border: 1px solid var(--line);
        background: transparent;
        cursor: pointer;
        color: var(--text-color);
        transition: background-color 0.2s;
    }

    #close-note:hover {
        background-color: rgba(0,0,0,0.1);
    }

    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.08);
        z-index: 800;
        display: none;
        backdrop-filter: blur(2px);
    }

    .dark-mode .overlay {
        background: rgba(0, 0, 0, 0.3);
    }
    
    /* Main Layout */
    .main-container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 58px - 64px);
    }
    
    .content-wrapper {
      flex: 1;
      display: flex;
      overflow: hidden;
      position: relative;
    }
    
    .passage-pane {
      background: var(--panel);
      overflow-y: auto;
      padding: 24px;
      padding-bottom: 100px;
      flex: 0 0 50%;
      min-width: 300px;
    }
    
    #divider {
      width: 12px;
      background: var(--bg);
      cursor: ew-resize;
      position: relative;
      user-select: none;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s ease;
      border-left: 1px solid var(--line);
      border-right: 1px solid var(--line);
    }
    
    #divider::before {
      content: '⋮';
      position: absolute;
      color: #d1d5db;
      font-size: 20px;
      letter-spacing: -2px;
      font-weight: bold;
    }

    #divider:hover {
        background: #dbeafe;
    }
    
    .questions-pane {
      background: var(--bg);
      overflow-y: auto;
      padding: 24px;
      padding-bottom: 100px;
      flex: 1;
      min-width: 300px;
    }
    
    /* Text Styles */
    .passage-pane p {
      line-height: 1.7;
      margin-bottom: 16px;
      text-align: justify;
      color: var(--text-color);
    }
    
    .questions-pane h3 {
      font-size: 16px;
      font-weight: 600;
      margin: 20px 0 8px;
      color: var(--text-color);
    }
    
    .question-group {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }
    
    .question-item {
        padding: 12px 0;
        border-bottom: 1px dashed var(--line);
    }
    .question-item:last-child {
        border-bottom: none;
    }
    
    /* Form Elements */
    .radio-options-list {
        list-style-type: none;
        padding-left: 0;
        margin-top: 10px;
    }
    .radio-options-list li {
        margin-bottom: 8px;
    }
    .radio-options-list label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
    }

    /* --- DRAG AND DROP STYLES --- */
    .summary-text p {
        line-height: 2.5;
    }
    .drop-target-summary {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 120px;
        height: 32px;
        border: 2px dashed var(--line);
        border-radius: 6px;
        vertical-align: middle;
        transition: background-color 0.2s, border-color 0.2s;
        position: relative;
        top: 8px;
    }
    .drop-target-summary.drag-over {
        background-color: #dbeafe;
        border-color: var(--accent);
    }
    #word-options {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        padding: 12px;
        border: 1px solid var(--line);
        border-radius: 8px;
        margin-top: 16px;
        background-color: var(--bg);
    }
    .draggable-word {
        padding: 6px 12px;
        background-color: #eef2ff;
        border: 1px solid #c7d2fe;
        border-radius: 6px;
        cursor: grab;
        transition: all 0.2s;
        font-size: 14px;
        user-select: none;
        color: #333;
    }
    .draggable-word.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }
    .drop-target-summary .draggable-word {
        background: transparent;
        border: none;
        padding: 0;
        cursor: default;
        color: var(--text-color);
    }
    
    /* Highlight, Toolbar, and Notes Styles */
    .hl { background-color: var(--highlight); cursor: pointer; }

    .dark-mode .hl {
        color: #f5f3ff;
    }

    #selbar { 
      position: absolute; 
      display: none; 
      z-index: 6000; 
      background: var(--selbar-bg); 
      color: var(--selbar-text); 
      border-radius: 8px; 
      padding: 6px; 
      box-shadow: var(--shadow); 
      font-size: 13px; 
      gap: 6px; 
      align-items: center; 
    }
    #selbar button { 
      background: transparent; 
      color: var(--selbar-text); 
      border: 1px solid rgba(255,255,255,.25); 
      padding: 4px 8px; 
      border-radius: 6px; 
      cursor: pointer;
      font-size: 12px;
    }
    #selbar button:hover { 
      border-color: var(--selbar-text);
    }

    .practice-nav {
        background: var(--panel);
        padding: 12px 20px;
        display: flex;
        align-items: center;
        gap: 16px;
        box-shadow: 0 -2px 4px rgba(0,0,0,.05);
        flex-wrap: wrap;
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        border-top: 1px solid var(--line);
        z-index: 4000;
    }

    .practice-nav .title {
        font-weight: 600;
        color: var(--muted);
    }

    .practice-nav .questions {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
    }

    .practice-nav .q-item {
        padding: 6px 10px;
        border: 1px solid var(--line);
        border-radius: 6px;
        background: var(--panel);
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
        min-width: 36px;
        text-align: center;
        color: var(--text-color);
    }

    .practice-nav .q-item:hover {
        background: var(--bg);
        border-color: var(--accent);
    }

    .practice-nav .q-item.answered {
        background: #e0e7ff;
        border-color: var(--accent);
        color: var(--accent);
        font-weight: 500;
    }

    .dark-mode .practice-nav .q-item.answered {
        background: #3949ab;
        border-color: var(--accent);
        color: #e8eaf6;
    }

    .practice-nav .q-item.correct {
        background: #dcfce7;
        color: #166534;
        border-color: #4ade80;
        font-weight: 600;
    }

    .dark-mode .practice-nav .q-item.correct {
        background: #166534;
        border-color: #4ade80;
        color: #dcfce7;
    }

    .practice-nav .q-item.incorrect {
        background: #fee2e2;
        color: #b91c1c;
        border-color: #f87171;
        font-weight: 600;
    }
    
    .dark-mode .practice-nav .q-item.incorrect {
        background: #991b1b;
        border-color: #f87171;
        color: #fee2e2;
    }

    .practice-nav .controls {
        margin-left: auto;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .practice-nav .controls button {
        padding: 8px 12px;
        border: 1px solid var(--line);
        border-radius: 6px;
        background: var(--panel);
        cursor: pointer;
        color: var(--text-color);
    }

    .practice-nav .controls button.primary {
        background: var(--accent);
        color: #fff;
        border-color: var(--accent);
    }

    /* Toast & Results */
    #toast { position: fixed; left: 50%; transform: translateX(-50%); bottom: 80px; background: #111; color: #fff; padding: 10px 16px; border-radius: 8px; display: none; z-index: 2500; font-size: 14px; }
    #results { margin-top: 16px; padding: 16px; background: var(--panel); border-radius: 8px; border: 1px solid var(--line); }
    #results h3 { font-size: 16px; font-weight: 600; margin-bottom: 12px; }
    .results-table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    .results-table th, .results-table td { border: 1px solid var(--line); padding: 8px; text-align: center; font-size: 13px; }
    .results-table th { background: var(--bg); font-weight: 600; }

    .empty-space {
        height: 24px;
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
        <h1>Reading Passage 3 - The Pirahã people of Brazil</h1>
        <div id="timer">00:00</div>
    </div>
    <div class="header-controls">
        <button class="header-btn" id="size-btn">Size</button>
        <button class="header-btn" id="color-btn">Color</button>
        <button class="header-btn" id="note-btn">Note</button>
    </div>
  </header>

  <div id="settings-panel">
    <div class="settings-group">
        <div class="settings-title">Font Size</div>
        <button class="settings-option active" data-size="regular">Regular</button>
        <button class="settings-option" data-size="large">Large</button>
        <button class="settings-option" data-size="xlarge">Extra Large</button>
    </div>
    <div class="settings-group">
        <div class="settings-title">Color Mode</div>
        <button class="settings-option active" data-mode="light">Black on White</button>
        <button class="settings-option" data-mode="dark">White on Black</button>
    </div>
  </div>

  <div id="notes-panel">
    <header>
        <h3>Notes</h3>
        <button id="close-note">Close</button>
    </header>
    <textarea placeholder="Write your notes here..."></textarea>
  </div>

  <div class="overlay"></div>

  <div class="main-container">
    <div class="content-wrapper">
      <div class="passage-pane" id="passage-pane">
        <h2>READING PASSAGE 3</h2>
        <p>You should spend about 20 minutes on Questions 27-40, which are based on Reading Passage 3 below.</p>
        <h3>The Pirahã people of Brazil</h3>
        <p><i>The Pirahã language has stirred up debate among experts</i></p>
        <div id="passage-text">
            <p>The Pirahã tribe live deep in Brazil's Amazon forest, and their language is hotly debated by linguists. Since 1977, the ethnologist Daniel Everett has spent a total of seven years living with the Pirahã and has committed his career to studying their puzzling speech. Indeed, he was uncertain for so long about what he was actually hearing while living among the Pirahã that he waited nearly three decades before publishing his findings.</p>
            <p>The debate over the Pirahã language goes right to the core of the riddle regarding how Homo sapiens managed to develop vocal communication. Although bees dance, birds sing and whales even sing with syntax, human language is unique, if only for the reason that it enables humans to piece together never-before-constructed thoughts, and be infinitely imaginative - think of Shakespeare's plays or Einstein's theory of relativity.</p>
            <p>Linguistics generally focuses on what features all human languages have in common, but the Pirahã language departs from what some academics have long maintained are essential and inalienable features of all human languages. Most of all, it may be unique for not employing subordinate clauses. Instead of saying, ‘When I have finished eating, I will speak to you,' the Pirahã say, 'I finish eating, I speak with you.' Equally perplexing, the Pirahã appear not to use numbers. During the time he spent with them, Everett never heard words like 'all', 'every' and 'more'. There is one word, ‘hoi', that comes close to the numeral 1, but it can also mean 'small'. And they were never observed to count without language, on their fingers for example, in order to determine important tasks in village life like how many pieces of meat to grill.</p>
            <p>Everett's findings among the Pirahã have brought new life to a controversial theory by the linguist Benjamin Whorf, who suggested that people are only capable of constructing thoughts for which they possess actual words. Or to put it another way, because they have no words for numbers, they cannot even begin to understand the concept of numbers or arithmetic.</p>
            <p>The Warlpiri language - spoken by a group of Australian Aborigines - like that of the Pirahã, features only the most rudimentary system of counting. However, the Warlpiri people had no difficulty counting farther than three in a foreign language, in this case English, but when Everett attempted to teach the Pirahã how to count in Portuguese, like other Brazilians, not a single person could count to 10.</p>
            <p>Everett is at pains to point out that the Pirahã are not unintelligent, for their thinking is not any slower than that of the average university student. And although they reside in a remote part of the forest, they do not live in complete genetic isolation, but mix with people from the surrounding populations and share similar intellectual capacities with their neighbours whose languages do contain numbers.</p>
            <p>Eventually, after some 30 years of research, Everett has come up with a surprising explanation for the peculiarities of the Pirahã language. Language, he believes, is created by a people's way of life, their belief system and values. In this way, variety in human language is almost limitless, a function of the human capacity to live in different ways, such as in the forest. What Everett's research has revealed is that the central tenet of the Pirahã culture is to live in the here and now. The only thing of importance that is worth communicating to others is what is being experienced at that very moment, though this can often be described with great care and detail. In consequence, the language has no means to conjugate verbs in order to describe ‘yesterday' or 'last week' or 'when I was a child'. Their very literal view of the world curtails abstract thought, and many features taken for granted among other peoples are absent among the Pirahã, such as a creation myth, storytelling and painting. One manifestation of their beliefs is that by tradition the names they give their children are not particularly imaginative. Often they are named after other members of the tribe with whom they share similar character traits. Standing out or being different is not encouraged by the Pirahã, and this is reflected in their perhaps colourless choice of names.</p>
            <p>Everett anticipated that these findings would be controversial and the reaction came as expected. Until this point, many linguists had defended the theories of Noam Chomsky, according to which all human languages have a universal grammar. What exactly makes up this universal grammar is the subject of debate, but at its heart is the concept of 'recursion', which is defined as replication of a structure within its single parts. Without it, humans would not be able to view separate thoughts as subordinate parts of a complex whole. And, most pertinent to Everett's work, there would not be subordinate clauses, which are responsible for translating the concept of recursion into grammar. But if the Pirahã do not form subordinate clauses, then recursion cannot explain the uniqueness of human language, and this would negate Chomsky's theories.</p>
            <p>The logical way forward now would be to try to prove that the Pirahã can think in a recursive fashion. The only problem is, nobody can confirm or deny Everett's observations since no other researcher can speak Pirahã as well as he does. Despite this, several researchers - including two of Chomsky's colleagues - will soon travel to Brazil to check his claims. My concern is that soon the Pirahã will simply become one more scientific oddity with every aspect of their lives being exploited and analysed.</p>
            <div class="empty-space"></div>
        </div>
      </div>

      <div id="divider"></div>

      <div class="questions-pane" id="questions-pane">
        <h2>Questions</h2>

        <div class="question-group" id="q27-32-section">
          <h3>Questions 27–32</h3>
          <p style="margin-bottom: 12px;">Choose the correct letter, <strong>A, B, C or D</strong>.</p>
          <div class="question-item">
              <p><strong>27</strong> What are we told about Daniel Everett in the first paragraph?</p>
              <div style="display:flex; flex-direction: column; gap:10px; margin:10px 0 4px 0;">
                <label><input name="q27" type="radio" value="A"> A He has lived among the Pirahã since 1977.</label>
                <label><input name="q27" type="radio" value="B"> B It took him seven years to learn the Pirahã language.</label>
                <label><input name="q27" type="radio" value="C"> C No one would publish his research for three decades.</label>
                <label><input name="q27" type="radio" value="D"> D Studying the Pirahã language is the focus of his work.</label>
              </div>
          </div>
          <div class="question-item">
              <p><strong>28</strong> Which of the following is the best summary of the second paragraph?</p>
              <div style="display:flex; flex-direction: column; gap:10px; margin:10px 0 4px 0;">
                <label><input name="q28" type="radio" value="A"> A Humans are the only species to be linguistically creative.</label>
                <label><input name="q28" type="radio" value="B"> B Humans, bees, birds and whales share a characteristic.</label>
                <label><input name="q28" type="radio" value="C"> C Human language is not fully understood by scientists.</label>
                <label><input name="q28" type="radio" value="D"> D Humans are the only species to use syntax.</label>
              </div>
          </div>
          <div class="question-item">
              <p><strong>29</strong> Why does the writer refer to subordinate clauses?</p>
              <div style="display:flex; flex-direction: column; gap:10px; margin:10px 0 4px 0;">
                <label><input name="q29" type="radio" value="A"> A to criticise the general approach of linguistics</label>
                <label><input name="q29" type="radio" value="B"> B to compare two features of the Pirahã language</label>
                <label><input name="q29" type="radio" value="C"> C to explain why the Pirahã language is difficult to learn</label>
                <label><input name="q29" type="radio" value="D"> D to exemplify an unusual feature of the Pirahã language</label>
              </div>
          </div>
          <div class="question-item">
              <p><strong>30</strong> What point does the writer make about the work of Whorf?</p>
              <div style="display:flex; flex-direction: column; gap:10px; margin:10px 0 4px 0;">
                <label><input name="q30" type="radio" value="A"> A He thought that numbers were common to all human languages.</label>
                <label><input name="q30" type="radio" value="B"> B His theory might be supported by Everett's research.</label>
                <label><input name="q30" type="radio" value="C"> C His research enabled him to find a new life among the Pirahã.</label>
                <label><input name="q30" type="radio" value="D"> D He predicted that people like the Pirahã would never be found.</label>
              </div>
          </div>
          <div class="question-item">
              <p><strong>31</strong> The writer refers to the Warlpiri people in order to</p>
              <div style="display:flex; flex-direction: column; gap:10px; margin:10px 0 4px 0;">
                <label><input name="q31" type="radio" value="A"> A suggest that the Pirahã be taught to count in English.</label>
                <label><input name="q31" type="radio" value="B"> B show how tribal peoples learn a foreign language.</label>
                <label><input name="q31" type="radio" value="C"> C compare counting in English and Portuguese.</label>
                <label><input name="q31" type="radio" value="D"> D illustrate the uniqueness of the Pirahã.</label>
              </div>
          </div>
           <div class="question-item">
              <p><strong>32</strong> What is Everett's point about the Pirahã's intellectual capacities?</p>
              <div style="display:flex; flex-direction: column; gap:10px; margin:10px 0 4px 0;">
                <label><input name="q32" type="radio" value="A"> A Pirahã students have not graduated from universities.</label>
                <label><input name="q32" type="radio" value="B"> B He does not want people to criticise their intelligence.</label>
                <label><input name="q32" type="radio" value="C"> C Their isolation makes it difficult to evaluate their intelligence.</label>
                <label><input name="q32" type="radio" value="D"> D He believes their language is more complex than their neighbours'.</label>
              </div>
          </div>
        </div>

        <div class="question-group" id="q33-36-section">
          <h3>Questions 33–36</h3>
          <p style="margin-bottom: 12px;">Complete the summary using the list of words, <strong>A–I</strong>, below.</p>
          <div class="summary-text">
            <h4>Everett's explanation</h4>
            <p>
              Everett believes that a group's language is a product of their <strong>33</strong> <span id="q33-target" class="drop-target-summary"></span> and thus language is infinitely varied. During the time he spent living among them, he observed that the Pirahã only place value on the <strong>34</strong> <span id="q34-target" class="drop-target-summary"></span> and have no <strong>35</strong> <span id="q35-target" class="drop-target-summary"></span> to describe completed events. Similarly, the types of names they use reflect the fact that they do not celebrate <strong>36</strong> <span id="q36-target" class="drop-target-summary"></span>.
            </p>
          </div>
          <div id="word-options">
            <div id="word-A" class="draggable-word" draggable="true" data-word="present">A present</div>
            <div id="word-B" class="draggable-word" draggable="true" data-word="past">B past</div>
            <div id="word-C" class="draggable-word" draggable="true" data-word="time">C time</div>
            <div id="word-D" class="draggable-word" draggable="true" data-word="future">D future</div>
            <div id="word-E" class="draggable-word" draggable="true" data-word="culture">E culture</div>
            <div id="word-F" class="draggable-word" draggable="true" data-word="grammar">F grammar</div>
            <div id="word-G" class="draggable-word" draggable="true" data-word="art">G art</div>
            <div id="word-H" class="draggable-word" draggable="true" data-word="individuality">H individuality</div>
            <div id="word-I" class="draggable-word" draggable="true" data-word="children">I children</div>
          </div>
        </div>

        <div class="question-group" id="q37-40-section">
            <h3>Questions 37–40</h3>
            <p>Do the following statements agree with the views of the writer in Reading Passage 3? Write <strong>YES</strong>, <strong>NO</strong>, or <strong>NOT GIVEN</strong>.</p>
            <div class="question-item">
                <p><strong>37</strong> Everett was surprised by the way his research was greeted.</p>
                <div style="display:flex; flex-wrap:wrap; gap:10px; margin:10px 0 4px 0;">
                  <label><input name="q37" type="radio" value="YES"> YES</label>
                  <label><input name="q37" type="radio" value="NO"> NO</label>
                  <label><input name="q37" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
                </div>
            </div>
            <div class="question-item">
                <p><strong>38</strong> Chomsky has been critical of Everett's research methodology.</p>
                <div style="display:flex; flex-wrap:wrap; gap:10px; margin:10px 0 4px 0;">
                  <label><input name="q38" type="radio" value="YES"> YES</label>
                  <label><input name="q38" type="radio" value="NO"> NO</label>
                  <label><input name="q38" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
                </div>
            </div>
            <div class="question-item">
                <p><strong>39</strong> If 'recursion' as a universal concept is disproved, Chomsky's ideas about language would be wrong.</p>
                <div style="display:flex; flex-wrap:wrap; gap:10px; margin:10px 0 4px 0;">
                  <label><input name="q39" type="radio" value="YES"> YES</label>
                  <label><input name="q39" type="radio" value="NO"> NO</label>
                  <label><input name="q39" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
                </div>
            </div>
            <div class="question-item">
                <p><strong>40</strong> The Pirahã will benefit from their new-found status among academics.</p>
                <div style="display:flex; flex-wrap:wrap; gap:10px; margin:10px 0 4px 0;">
                  <label><input name="q40" type="radio" value="YES"> YES</label>
                  <label><input name="q40" type="radio" value="NO"> NO</label>
                  <label><input name="q40" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
                </div>
            </div>
        </div>
        
        <div id="results"></div>
      </div>
    </div>
  </div>

  <div class="practice-nav">
    <div class="title">Questions</div>
    <div class="questions">
        <div class="q-item" id="q27-nav" onclick="scrollToQuestion('q27-32')">27</div>
        <div class="q-item" id="q28-nav" onclick="scrollToQuestion('q27-32')">28</div>
        <div class="q-item" id="q29-nav" onclick="scrollToQuestion('q27-32')">29</div>
        <div class="q-item" id="q30-nav" onclick="scrollToQuestion('q27-32')">30</div>
        <div class="q-item" id="q31-nav" onclick="scrollToQuestion('q27-32')">31</div>
        <div class="q-item" id="q32-nav" onclick="scrollToQuestion('q27-32')">32</div>
        <div class="q-item" id="q33-nav" onclick="scrollToQuestion('q33-36')">33</div>
        <div class="q-item" id="q34-nav" onclick="scrollToQuestion('q33-36')">34</div>
        <div class="q-item" id="q35-nav" onclick="scrollToQuestion('q33-36')">35</div>
        <div class="q-item" id="q36-nav" onclick="scrollToQuestion('q33-36')">36</div>
        <div class="q-item" id="q37-nav" onclick="scrollToQuestion('q37-40')">37</div>
        <div class="q-item" id="q38-nav" onclick="scrollToQuestion('q37-40')">38</div>
        <div class="q-item" id="q39-nav" onclick="scrollToQuestion('q37-40')">39</div>
        <div class="q-item" id="q40-nav" onclick="scrollToQuestion('q37-40')">40</div>
    </div>
    <div class="controls">
        <button id="submit-btn" class="primary">Submit</button>
        <button id="reset-btn">Reset</button>
        <button id="pause-btn">Pause</button>
    </div>
  </div>

  <div aria-label="Selection tools" id="selbar" role="toolbar">
    <button id="btnHL">Highlight</button>
    <button id="btnUH">Remove</button>
    <button id="btnNote">Note</button>
  </div>
  
  <div id="toast"></div>

  <script>
    (function() {
      // Global variables
      let settingsOpen = false, notesOpen = false;
      let timerRunning = true, seconds = 0, timer;
      let isResizing = false;

      // --- STATE & CONFIG ---
      const correctAnswers = { 
        "q27": "D", "q28": "A", "q29": "D", "q30": "B", "q31": "D", "q32": "B", 
        "q33": "culture", "q34": "present", "q35": "grammar", "q36": "individuality", 
        "q37": "NO", "q38": "NOT GIVEN", "q39": "YES", "q40": "NO" 
      };
      
      // --- DOM ELEMENTS ---
      const passagePane = document.getElementById('passage-pane');
      const questionsPane = document.getElementById('questions-pane');
      const notesPanel = document.getElementById('notes-panel');
      const noteArea = notesPanel.querySelector('textarea');
      const selbar = document.getElementById('selbar');
      const divider = document.getElementById('divider');

      // --- SELECTION STATE ---
      let lastRange = null;
      let currentHlNode = null;
      let keepToolbar = false;

      // Timer functionality
      function startTimer() {
          timer = setInterval(() => {
              if (timerRunning) {
                  seconds++;
                  updateTimer();
              }
          }, 1000);
      }

      function updateTimer() {
          const minutes = String(Math.floor(seconds / 60)).padStart(2, '0');
          const secs = String(seconds % 60).padStart(2, '0');
          document.getElementById('timer').textContent = `${minutes}:${secs}`;
      }

      // --- HELPER FUNCTIONS ---
      function showToast(msg) {
        const el = document.getElementById('toast');
        el.textContent = msg;
        el.style.display = 'block';
        setTimeout(() => { el.style.display = 'none'; }, 2000);
      }

      function closeAllPanels() {
          notesOpen = false;
          settingsOpen = false;
          document.getElementById('notes-panel').style.display = 'none';
          document.getElementById('settings-panel').style.display = 'none';
          document.querySelector('.overlay').style.display = 'none';
      }
      
      window.scrollToQuestion = function(qidPrefix) {
        const element = document.getElementById(`${qidPrefix}-section`);
        if (element && questionsPane) {
            const top = element.offsetTop - 20; // Adjust for padding/margin
            questionsPane.scrollTo({ top, behavior: 'smooth' });
        }
      }
      
      function positionSelbarForRect(rect) {
        selbar.style.display = 'flex';
        requestAnimationFrame(() => {
          const top = window.scrollY + rect.top - selbar.offsetHeight - 8;
          const left = window.scrollX + rect.left + rect.width / 2 - selbar.offsetWidth / 2;
          selbar.style.top = `${(top > 0) ? top : (window.scrollY + rect.bottom + 8)}px`;
          selbar.style.left = `${Math.max(8, left)}px`;
        });
      }

      function updateSelbar() {
        const sel = window.getSelection();
        if (!sel || sel.rangeCount === 0 || sel.isCollapsed) {
            if (!keepToolbar && !currentHlNode) {
                selbar.style.display = 'none';
                currentHlNode = null;
            }
            return;
        }
        const range = sel.getRangeAt(0);
        
        const container = range.commonAncestorContainer;
        const containerElement = container.nodeType === Node.TEXT_NODE ? container.parentElement : container;
        
        const isInPassage = passagePane.contains(containerElement);
        const isInQuestions = questionsPane.contains(containerElement);
        const isHighlighted = containerElement.classList?.contains('hl') || containerElement.closest('.hl');
        
        if (!isInPassage && !isInQuestions && !isHighlighted) {
            selbar.style.display = 'none';
            return;
        }
        
        lastRange = range.cloneRange();
        currentHlNode = isHighlighted ? containerElement.closest('.hl') : null;
        positionSelbarForRect(range.getBoundingClientRect());
      }

      // --- CORE LOGIC FUNCTIONS ---
      function updateAnsweredState() {
        for (let i = 27; i <= 40; i++) {
          const qid = 'q' + i;
          const navItem = document.getElementById(qid + '-nav');
          if (!navItem || navItem.classList.contains('correct') || navItem.classList.contains('incorrect')) continue;

          let hasAnswer = false;
          if (i >= 33 && i <= 36) {
            const placeholder = document.getElementById(`${qid}-target`);
            hasAnswer = !!placeholder.firstChild;
          } else {
            const radio = document.querySelector(`input[name="${qid}"]:checked`);
            hasAnswer = !!radio;
          }
          navItem.classList.toggle('answered', hasAnswer);
        }
      }
      
      function submitAnswers() {
        clearInterval(timer);
        timerRunning = false;
        let score = 0;
        const totalQuestions = 14;
        const resultsData = [];

        for (let i = 27; i <= 40; i++) {
          const qid = 'q' + i;
          let userAnswer = '—';
          if (i >= 33 && i <= 36) {
            const placeholder = document.getElementById(`${qid}-target`);
            if (placeholder.firstChild) {
              userAnswer = placeholder.firstChild.dataset.word;
            }
          } else {
            const radio = document.querySelector(`input[name="${qid}"]:checked`);
            if (radio) userAnswer = radio.value;
          }
          
          const isCorrect = userAnswer.toLowerCase() === (correctAnswers[qid] || '').toLowerCase();
          if (isCorrect) score++;
          resultsData.push({ num: i, userAnswer, correctAnswer: correctAnswers[qid], isCorrect, navId: qid + '-nav' });
        }
        
        resultsData.forEach(result => {
          const nav = document.getElementById(result.navId);
          if (nav) {
            nav.classList.remove('answered');
            nav.classList.add(result.isCorrect ? 'correct' : 'incorrect');
          }
        });

        const percentage = Math.round((score / totalQuestions) * 100);
        const resultsDiv = document.getElementById('results');
        const tableRows = resultsData.map(r => `
          <tr>
            <td>${r.num}</td>
            <td>${r.userAnswer}</td>
            <td>${r.correctAnswer}</td>
            <td style="color: ${r.isCorrect ? '#16a34a' : '#dc2626'}; font-weight: bold;">${r.isCorrect ? '✓ Correct' : '✗ Incorrect'}</td>
          </tr>`).join('');
        
        resultsDiv.innerHTML = `<h3>Results</h3>
          <p><b>Score: ${score}/${totalQuestions} (${percentage}%)</b></p>
          <table class="results-table"><thead><tr><th>Question</th><th>Your Answer</th><th>Correct Answer</th><th>Result</th></tr></thead><tbody>${tableRows}</tbody></table>`;
        resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        document.getElementById('pause-btn').textContent = 'Continue';
      }

      function resetAll() {
        document.querySelectorAll('input[type="radio"]').forEach(i => i.checked = false);
        const wordOptionsContainer = document.getElementById('word-options');
        document.querySelectorAll('.drop-target-summary .draggable-word').forEach(word => {
            wordOptionsContainer.appendChild(word);
        });
        document.querySelectorAll('.q-item').forEach(nav => nav.className = 'q-item');
        document.getElementById('results').innerHTML = '';
        document.querySelectorAll('.hl').forEach(h => {
            const parent = h.parentNode;
            while(h.firstChild) parent.insertBefore(h.firstChild, h);
            parent.removeChild(h);
            parent.normalize();
        });
        if (noteArea) noteArea.value = '';
        
        seconds = 0;
        updateTimer();
        if(timer) clearInterval(timer);
        timerRunning = true;
        document.getElementById('pause-btn').textContent = 'Pause';
        startTimer();
        
        showToast('Test has been reset.');
        updateAnsweredState();
      }
      
      // --- EVENT LISTENERS ---
      document.addEventListener('DOMContentLoaded', () => {
        startTimer();
        updateAnsweredState();

        // Header button events
        document.getElementById('size-btn').addEventListener('click', (e) => { e.stopPropagation(); settingsOpen = !settingsOpen; document.getElementById('settings-panel').style.display = settingsOpen ? 'block' : 'none'; });
        document.getElementById('color-btn').addEventListener('click', (e) => { e.stopPropagation(); settingsOpen = !settingsOpen; document.getElementById('settings-panel').style.display = settingsOpen ? 'block' : 'none'; });
        document.getElementById('note-btn').addEventListener('click', (e) => { e.stopPropagation(); closeAllPanels(); notesOpen = true; document.getElementById('notes-panel').style.display = 'flex'; document.querySelector('.overlay').style.display = 'block'; });

        // Settings options
        document.querySelectorAll('.settings-option[data-size]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.documentElement.className = `font-${this.dataset.size}`;
                document.querySelectorAll('.settings-option[data-size]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            });
        });
        document.querySelectorAll('.settings-option[data-mode]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.body.classList.toggle('dark-mode', this.dataset.mode === 'dark');
                document.querySelectorAll('.settings-option[data-mode]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // Panel close events
        document.getElementById('close-note').addEventListener('click', closeAllPanels);
        document.querySelector('.overlay').addEventListener('click', closeAllPanels);
        document.addEventListener('click', (e) => {
            const isClickInsidePanel = e.target.closest('#settings-panel, #notes-panel');
            const isClickOnButton = e.target.closest('.header-btn');
            if (!isClickInsidePanel && !isClickOnButton) closeAllPanels();
        });

        // Control buttons
        document.getElementById('submit-btn').addEventListener('click', submitAnswers);
        document.getElementById('reset-btn').addEventListener('click', resetAll);
        document.getElementById('pause-btn').addEventListener('click', function() {
            timerRunning = !timerRunning;
            this.textContent = timerRunning ? 'Pause' : 'Continue';
        });

        questionsPane.addEventListener('change', updateAnsweredState);

        // --- HIGHLIGHT & SELECTION LISTENERS ---
        document.addEventListener('mouseup', () => setTimeout(updateSelbar, 10));
        document.addEventListener('selectionchange', () => setTimeout(updateSelbar, 10));
        document.addEventListener('mousedown', (e) => { keepToolbar = !!e.target.closest('#selbar, .hl'); }, true);
        document.addEventListener('click', (e) => {
            const target = e.target;
            if (target.classList?.contains('hl')) {
                currentHlNode = target;
                lastRange = null;
                positionSelbarForRect(target.getBoundingClientRect());
                window.getSelection()?.removeAllRanges();
                setTimeout(() => { keepToolbar = false; }, 0);
            } else if (!selbar.contains(e.target)) {
                selbar.style.display = 'none';
                currentHlNode = null;
            }
        }, true);
        
        document.getElementById('btnHL').addEventListener('click', () => {
            if (!lastRange || lastRange.collapsed) return;
            const sel = window.getSelection();
            try {
                const span = document.createElement('span');
                span.className = 'hl';
                lastRange.surroundContents(span);
            } catch (e) { console.error("Highlighting failed:", e); showToast('Highlighting failed'); return; }
            sel?.removeAllRanges();
            selbar.style.display = 'none';
            showToast('Highlighted');
        });

        document.getElementById('btnUH').addEventListener('click', () => {
            let nodeToRemove = currentHlNode;
            if (!nodeToRemove && lastRange) {
                 const commonAncestor = lastRange.commonAncestorContainer;
                 nodeToRemove = commonAncestor.nodeType === Node.TEXT_NODE ? commonAncestor.parentElement.closest('.hl') : commonAncestor.closest('.hl');
            }
            if (nodeToRemove) {
                const p = nodeToRemove.parentNode;
                while (nodeToRemove.firstChild) p.insertBefore(nodeToRemove.firstChild, nodeToRemove);
                p.removeChild(nodeToRemove);
                p.normalize();
            }
            currentHlNode = null;
            window.getSelection()?.removeAllRanges();
            selbar.style.display = 'none';
            showToast('Highlight removed');
        });
        
        document.getElementById('btnNote').addEventListener('click', () => {
            let text = (currentHlNode ? currentHlNode.textContent : (lastRange ? lastRange.cloneContents().textContent : '')).trim();
            if (text) {
                closeAllPanels();
                notesOpen = true;
                document.getElementById('notes-panel').style.display = 'flex';
                document.querySelector('.overlay').style.display = 'block';
                const noteAreaEl = document.querySelector('#notes-panel textarea');
                noteAreaEl.value += (noteAreaEl.value ? '\n\n' : '') + '> ' + text;
                noteAreaEl.scrollTop = noteAreaEl.scrollHeight;
            }
            selbar.style.display = 'none';
        });

        // --- DRAG AND DROP LISTENERS ---
        const draggables = document.querySelectorAll('.draggable-word');
        const dropTargets = document.querySelectorAll('.drop-target-summary');
        const wordOptionsContainer = document.getElementById('word-options');

        draggables.forEach(draggable => {
            draggable.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', e.target.id);
                setTimeout(() => e.target.classList.add('dragging'), 0);
            });
            draggable.addEventListener('dragend', (e) => e.target.classList.remove('dragging'));
        });

        dropTargets.forEach(target => {
            target.addEventListener('dragover', e => { e.preventDefault(); target.classList.add('drag-over'); });
            target.addEventListener('dragleave', () => target.classList.remove('drag-over'));
            target.addEventListener('drop', e => {
                e.preventDefault();
                target.classList.remove('drag-over');
                const id = e.dataTransfer.getData('text/plain');
                const draggable = document.getElementById(id);
                if (target.firstChild) wordOptionsContainer.appendChild(target.firstChild);
                target.appendChild(draggable);
                updateAnsweredState();
            });
        });
        
        wordOptionsContainer.addEventListener('dragover', e => e.preventDefault());
        wordOptionsContainer.addEventListener('drop', e => {
            e.preventDefault();
            const id = e.dataTransfer.getData('text/plain');
            const draggable = document.getElementById(id);
            wordOptionsContainer.appendChild(draggable);
            updateAnsweredState();
        });
        
        // --- RESIZE DIVIDER ---
        divider.addEventListener('mousedown', () => { isResizing = true; document.body.style.cursor = 'ew-resize'; });
        document.addEventListener('mousemove', (e) => {
          if (!isResizing) return;
          const leftWidth = e.clientX;
          passagePane.style.flexBasis = leftWidth + 'px';
        });
        document.addEventListener('mouseup', () => { isResizing = false; document.body.style.cursor = 'default'; });
      });
    })();
  </script>


\n
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Global State ---
            let settingsOpen = false, notesOpen = false;
            let timerRunning = true, seconds = 0, timer;
            let isResizing = false;
            let selbar = document.getElementById('selbar');
            let lastRange = null, currentHlNode = null, keepToolbar = false;
            
            
            
            

            // --- Core Functions ---
            function startTimer() {
                timer = setInterval(() => {
                    if (timerRunning) {
                        seconds++;
                        const minutes = String(Math.floor(seconds / 60)).padStart(2, '0');
                        const secs = String(seconds % 60).padStart(2, '0');
                        document.getElementById('timer').textContent = `${minutes}:${secs}`;
                    }
                }, 1000);
            }

            function closeAllPanels() {
                notesOpen = false; settingsOpen = false;
                document.getElementById('notes-panel').style.display = 'none';
                document.getElementById('settings-panel').style.display = 'none';
                document.querySelector('.overlay').style.display = 'none';
            }

            window.scrollToElement = function(id) {
                const element = document.getElementById(id);
                const pane = element.closest('.pane');
                if (element && pane) {
                    const top = element.offsetTop - 20;
                    pane.scrollTo({ top, behavior: 'smooth' });
                }
            }
            
            // --- Grading and State Update ---
            function updateAnsweredState() {
                // 动态检测题目范围
                const allInputs = document.querySelectorAll('input[type="text"], input[type="radio"]:checked');
                const questionNumbers = [];
                
                allInputs.forEach(input => {
                    const match = input.id?.match(/q(d+)/) || input.name?.match(/q(d+)/);
                    if (match) {
                        questionNumbers.push(parseInt(match[1]));
                    }
                });
                
                const minQ = Math.min(...questionNumbers) || 1;
                const maxQ = Math.max(...questionNumbers) || 13;
                
                for (let i = minQ; i <= maxQ; i++) {
                    const navItem = document.getElementById(`q${i}-nav`);
                    if (!navItem || navItem.classList.contains('correct') || navItem.classList.contains('incorrect')) continue;

                    let answered = false;
                    const textInput = document.getElementById(`q${i}_input`) || document.getElementById(`q${i}-input`);
                    const radioInput = document.querySelector(`input[name="q${i}"]:checked`);
                    
                    if (textInput) {
                        answered = textInput.value.trim() !== "";
                    } else if (radioInput) {
                        answered = true;
                    }
                    
                    navItem.classList.toggle('answered', answered);
                }
            }
            
            function gradeAnswers() {
                timerRunning = false;
                const pauseBtn = document.getElementById('pause-btn');
                if (pauseBtn) pauseBtn.textContent = 'Continue';
                
                let correctCount = 0;
                let totalQuestions = 0;
                let resultsHTML = '<h4>Results</h4><table class="results-table"><thead><tr><th>Question</th><th>Your Answer</th><th>Correct Answer</th><th>Result</th></tr></thead><tbody>';

                // 动态检测所有题目
                const allInputs = document.querySelectorAll('input[type="text"], input[name^="q"]');
                const questionNumbers = new Set();
                
                allInputs.forEach(input => {
                    const match = input.id?.match(/q(d+)/) || input.name?.match(/q(d+)/);
                    if (match) {
                        questionNumbers.add(parseInt(match[1]));
                    }
                });
                
                const sortedQuestions = Array.from(questionNumbers).sort((a, b) => a - b);
                totalQuestions = sortedQuestions.length;

                sortedQuestions.forEach(i => {
                    let userAnswer, isCorrect = false;
                    const correctAnswer = correctAnswers[`q${i}`] || 'Not Available';
                    const navItem = document.getElementById(`q${i}-nav`);
                    if (navItem) navItem.classList.remove('answered');

                    // 检查文本输入
                    const textInput = document.getElementById(`q${i}_input`) || document.getElementById(`q${i}-input`);
                    if (textInput) {
                        userAnswer = textInput.value.trim() || 'No Answer';
                    } else {
                        // 检查单选按钮
                        const radioInput = document.querySelector(`input[name="q${i}"]:checked`);
                        userAnswer = radioInput ? radioInput.value : 'No Answer';
                    }

                    // 检查拖拽答案
                    if (userAnswer === 'No Answer') {
                        const dropzone = document.querySelector(`[data-question="q${i}"], [data-paragraph="${String.fromCharCode(64 + i)}"]`);
                        if (dropzone) {
                            const dragItem = dropzone.querySelector('.drag-item-clone, .drag-item');
                            if (dragItem) {
                                userAnswer = dragItem.dataset.country || dragItem.dataset.heading || dragItem.textContent.trim();
                            }
                        }
                    }

                    if (correctAnswer !== 'Not Available') {
                        isCorrect = userAnswer.toLowerCase() === correctAnswer.toLowerCase();
                        if (isCorrect) correctCount++;
                    }
                    
                    if (navItem) navItem.classList.add(isCorrect ? 'correct' : 'incorrect');
                    resultsHTML += `<tr><td>${i}</td><td>${userAnswer}</td><td>${correctAnswer}</td><td class="${isCorrect ? 'result-correct' : 'result-incorrect'}">${isCorrect ? '✓' : '✗'}</td></tr>`;
                });
                
                const score = totalQuestions > 0 ? Math.round((correctCount / totalQuestions) * 100) : 0;
                const summary = `<div style="font-weight:bold; margin-bottom:16px; font-size:1.1em;">Final Score: ${score}% (${correctCount}/${totalQuestions})</div>`;
                
                const resultsDiv = document.getElementById('results');
                if (resultsDiv) {
                    resultsDiv.innerHTML = summary + resultsHTML + '</tbody></table>';
                    resultsDiv.style.display = 'block';
                    scrollToElement('results');
                }
            }

            function resetQuiz() {
                document.querySelectorAll('input[type="radio"]').forEach(el => el.checked = false);
                document.querySelectorAll('input[type="text"]').forEach(el => el.value = '');
                document.querySelectorAll('.q-item').forEach(item => item.className = 'q-item');
                
                // 清理拖拽区域
                document.querySelectorAll('.dropzone, .paragraph-dropzone, .match-dropzone').forEach(zone => {
                    zone.innerHTML = zone.innerHTML.replace(/<div class="drag-item[^>]*>.*?</div>/g, '');
                });
                
                const resultsDiv = document.getElementById('results');
                if (resultsDiv) {
                    resultsDiv.style.display = 'none';
                    resultsDiv.innerHTML = '';
                }
                
                seconds = 0;
                document.getElementById('timer').textContent = '00:00';
                timerRunning = true;
                const pauseBtn = document.getElementById('pause-btn');
                if (pauseBtn) pauseBtn.textContent = 'Pause';
                updateAnsweredState();
            }

            // --- Highlighter & Selection Toolbar ---
            function positionSelbarForRect(rect) {
                if (!selbar) return;
                selbar.style.display = 'flex';
                requestAnimationFrame(() => {
                    const top = window.scrollY + rect.top - selbar.offsetHeight - 8;
                    const left = window.scrollX + rect.left + rect.width / 2 - selbar.offsetWidth / 2;
                    selbar.style.top = `${(top > 0) ? top : (window.scrollY + rect.bottom + 8)}px`;
                    selbar.style.left = `${Math.max(8, left)}px`;
                });
            }

            function updateSelbar() {
                if (!selbar) return;
                const sel = window.getSelection();
                if (!sel || sel.rangeCount === 0 || sel.isCollapsed) {
                    if (!keepToolbar && !currentHlNode) { selbar.style.display = 'none'; currentHlNode = null; }
                    return;
                }
                const range = sel.getRangeAt(0);
                let container = range.commonAncestorContainer;
                if (container.nodeType === Node.TEXT_NODE) container = container.parentElement;
                
                const isInAllowedPane = document.getElementById('left')?.contains(container) || document.getElementById('right')?.contains(container);
                const isHighlighted = container.classList?.contains('hl') || container.closest('.hl');
                if (!isInAllowedPane && !isHighlighted) { selbar.style.display = 'none'; return; }
                
                lastRange = range.cloneRange();
                currentHlNode = isHighlighted ? container.closest('.hl') : null;
                positionSelbarForRect(range.getBoundingClientRect());
            }

            function doHighlight() {
                if (currentHlNode || !lastRange || lastRange.collapsed) return;
                const sel = window.getSelection();
                try {
                    const span = document.createElement('span');
                    span.className = 'hl';
                    lastRange.surroundContents(span);
                } catch (e) { console.error("Highlighting failed:", e); return; }
                sel?.removeAllRanges();
                if (selbar) selbar.style.display = 'none';
            }

            function removeHighlight() {
                const sel = window.getSelection();
                let targetNode = currentHlNode;
                if (!targetNode && lastRange) {
                    const ancestor = lastRange.commonAncestorContainer;
                    targetNode = ancestor.nodeType === Node.TEXT_NODE ? ancestor.parentElement.closest('.hl') : ancestor.closest('.hl');
                }
                if (targetNode) {
                    const p = targetNode.parentNode;
                    while (targetNode.firstChild) p.insertBefore(targetNode.firstChild, targetNode);
                    if(p) p.removeChild(targetNode);
                    p?.normalize();
                }
                currentHlNode = null; sel?.removeAllRanges(); 
                if (selbar) selbar.style.display = 'none';
            }

            // --- Event Listeners Setup ---
            startTimer();

            // Header controls
            const sizeBtn = document.getElementById('size-btn');
            const colorBtn = document.getElementById('color-btn');
            const noteBtn = document.getElementById('note-btn');
            
            if (sizeBtn) sizeBtn.addEventListener('click', (e) => { e.stopPropagation(); settingsOpen = !settingsOpen; document.getElementById('settings-panel').style.display = settingsOpen ? 'block' : 'none'; });
            if (colorBtn) colorBtn.addEventListener('click', (e) => { e.stopPropagation(); settingsOpen = !settingsOpen; document.getElementById('settings-panel').style.display = settingsOpen ? 'block' : 'none'; });
            if (noteBtn) noteBtn.addEventListener('click', () => { closeAllPanels(); notesOpen = true; document.getElementById('notes-panel').style.display = 'flex'; document.querySelector('.overlay').style.display = 'block'; });
            
            document.querySelectorAll('.settings-option[data-size]').forEach(btn => btn.addEventListener('click', function() { document.documentElement.className = `font-${this.dataset.size}`; document.querySelectorAll('.settings-option[data-size]').forEach(b => b.classList.remove('active')); this.classList.add('active'); }));
            document.querySelectorAll('.settings-option[data-mode]').forEach(btn => btn.addEventListener('click', function() { document.body.classList.toggle('dark-mode', this.dataset.mode === 'dark'); document.querySelectorAll('.settings-option[data-mode]').forEach(b => b.classList.remove('active')); this.classList.add('active'); }));
            
            const closeNoteBtn = document.getElementById('close-note');
            if (closeNoteBtn) closeNoteBtn.addEventListener('click', closeAllPanels);
            
            const overlay = document.querySelector('.overlay');
            if (overlay) overlay.addEventListener('click', closeAllPanels);
            
            document.addEventListener('click', (e) => {
                const settingsPanel = document.getElementById('settings-panel');
                const headerControls = document.querySelector('.header-controls');
                if (settingsPanel && headerControls && !settingsPanel.contains(e.target) && !headerControls.contains(e.target)) { 
                    settingsPanel.style.display = 'none'; settingsOpen = false; 
                }
            });

            // Bottom nav controls
            const submitBtn = document.getElementById('submit-btn');
            const resetBtn = document.getElementById('reset-btn');
            const pauseBtn = document.getElementById('pause-btn');
            
            if (submitBtn) submitBtn.addEventListener('click', gradeAnswers);
            if (resetBtn) resetBtn.addEventListener('click', resetQuiz);
            if (pauseBtn) pauseBtn.addEventListener('click', function() { timerRunning = !timerRunning; this.textContent = timerRunning ? 'Pause' : 'Continue'; });

            // Pane resizing
            const divider = document.getElementById('divider');
            const leftPane = document.getElementById('left');
            if (divider && leftPane) {
                divider.addEventListener('mousedown', (e) => { isResizing = true; document.body.style.cursor = 'ew-resize'; e.preventDefault(); });
                document.addEventListener('mousemove', (e) => { if (!isResizing) return; const shellRect = document.querySelector('.shell').getBoundingClientRect(); let leftWidth = (e.clientX - shellRect.left) / shellRect.width * 100; leftPane.style.width = `${Math.max(20, Math.min(80, leftWidth))}%`; });
                document.addEventListener('mouseup', () => { if (isResizing) { isResizing = false; document.body.style.cursor = ''; } });
            }
            
            // Update answered state on input
            const rightPane = document.getElementById('right');
            if (rightPane) {
                rightPane.addEventListener('change', updateAnsweredState);
                rightPane.addEventListener('input', updateAnsweredState);
            }

            // Selection toolbar events
            if (selbar) {
                document.addEventListener('mouseup', () => setTimeout(updateSelbar, 10));
                document.addEventListener('selectionchange', () => setTimeout(updateSelbar, 10));
                document.addEventListener('mousedown', (e) => { keepToolbar = !!e.target.closest('#selbar, .hl'); }, true);
                document.addEventListener('click', (e) => {
                    const target = e.target;
                    if (target.classList.contains('hl')) {
                        currentHlNode = target; lastRange = null; positionSelbarForRect(target.getBoundingClientRect());
                        window.getSelection()?.removeAllRanges(); setTimeout(() => { keepToolbar = false; }, 0);
                    } else if (!selbar.contains(e.target)) { selbar.style.display = 'none'; currentHlNode = null; }
                }, true);
                
                const btnHL = document.getElementById('btnHL');
                const btnUH = document.getElementById('btnUH');
                const btnNote = document.getElementById('btnNote');
                
                if (btnHL) btnHL.addEventListener('click', doHighlight);
                if (btnUH) btnUH.addEventListener('click', removeHighlight);
                if (btnNote) btnNote.addEventListener('click', function() {
                    let text = (currentHlNode ? currentHlNode.textContent : (lastRange ? lastRange.cloneContents().textContent : '')).trim();
                    if (text) {
                        const noteArea = document.querySelector('#notes-panel textarea');
                        if (noteArea) {
                            noteArea.value += (noteArea.value ? '

' : '') + '> ' + text;
                            closeAllPanels(); notesOpen = true; document.getElementById('notes-panel').style.display = 'flex';
                            document.querySelector('.overlay').style.display = 'block'; noteArea.scrollTop = noteArea.scrollHeight;
                        }
                    }
                    selbar.style.display = 'none';
                });
            }

            // 拖拽功能初始化
            initializeDragAndDrop();
            
            function initializeDragAndDrop() {
                // 拖拽功能实现
                let draggedElement = null;

                document.addEventListener('dragstart', function(e) {
                    if (e.target.classList.contains('drag-item')) {
                        draggedElement = e.target;
                        e.target.classList.add('dragging');
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('text/html', e.target.outerHTML);
                    }
                });

                document.addEventListener('dragend', function(e) {
                    if (e.target.classList.contains('drag-item')) {
                        e.target.classList.remove('dragging');
                        draggedElement = null;
                    }
                });

                document.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    const dropzone = e.target.closest('.paragraph-dropzone, .match-dropzone');
                    if (dropzone) {
                        dropzone.classList.add('drag-over');
                    }
                });

                document.addEventListener('dragleave', function(e) {
                    const dropzone = e.target.closest('.paragraph-dropzone, .match-dropzone');
                    if (dropzone && !dropzone.contains(e.relatedTarget)) {
                        dropzone.classList.remove('drag-over');
                    }
                });

                document.addEventListener('drop', function(e) {
                    e.preventDefault();
                    const dropzone = e.target.closest('.paragraph-dropzone, .match-dropzone');
                    
                    if (dropzone && draggedElement) {
                        dropzone.classList.remove('drag-over');
                        
                        if (dropzone.classList.contains('paragraph-dropzone')) {
                            const droppedItems = dropzone.querySelector('.dropped-items');
                            if (droppedItems) {
                                const clone = draggedElement.cloneNode(true);
                                clone.draggable = false;
                                droppedItems.appendChild(clone);
                            }
                        } else if (dropzone.classList.contains('match-dropzone')) {
                            dropzone.innerHTML = '';
                            const clone = draggedElement.cloneNode(true);
                            clone.classList.add('drag-item-clone');
                            clone.draggable = false;
                            dropzone.appendChild(clone);
                        }
                        
                        updateAnsweredState();
                    }
                });
            }
        });
    </script>



  <script>
/**
 * 练习页面增强器 - 统一版本
 * 整合了原有的practicePageManager功能，解决数据收集和正确答案提取问题
 */

if (!window.practicePageEnhancer) {
    console.log('[PracticeEnhancer] 初始化增强器');

    // 内嵌CorrectAnswerExtractor功能，确保在练习页面中可用
    if (!window.CorrectAnswerExtractor) {
        window.CorrectAnswerExtractor = class {
            constructor() {
                this.extractionStrategies = [
                    this.extractFromAnswersObject.bind(this),
                    this.extractFromResultsTable.bind(this),
                    this.extractFromDOM.bind(this),
                    this.extractFromScripts.bind(this)
                ];
            }

            extractFromPage(document = window.document) {
                console.log('[CorrectAnswerExtractor] 开始提取正确答案');
                
                for (const strategy of this.extractionStrategies) {
                    try {
                        const answers = strategy(document);
                        if (answers && Object.keys(answers).length > 0) {
                            console.log('[CorrectAnswerExtractor] 提取成功:', strategy.name, answers);
                            return this.normalizeAnswers(answers);
                        }
                    } catch (error) {
                        console.warn(`[CorrectAnswerExtractor] 策略 ${strategy.name} 失败:`, error);
                    }
                }
                
                console.warn('[CorrectAnswerExtractor] 所有提取策略都失败了');
                return {};
            }

            extractFromAnswersObject(document = window.document) {
                const win = document.defaultView || window;
                
                const possibleAnswerObjects = [
                    'answers', 'correctAnswers', 'examAnswers', 'questionAnswers', 'solutionAnswers'
                ];
                
                for (const objName of possibleAnswerObjects) {
                    if (win[objName] && typeof win[objName] === 'object') {
                        console.log(`[CorrectAnswerExtractor] 找到全局对象: ${objName}`);
                        return win[objName];
                    }
                }
                
                return this.extractFromScriptVariables(document);
            }

            extractFromScriptVariables(document = window.document) {
                const scripts = document.querySelectorAll('script');
                
                for (const script of scripts) {
                    const content = script.textContent || script.innerHTML;
                    
                    const correctAnswersMatch = content.match(/(?:const|let|var)\s+correctAnswers\s*=\s*(\{[^}]+\})/s);
                    if (correctAnswersMatch) {
                        try {
                            const answersStr = correctAnswersMatch[1];
                            const answers = this.parseAnswersObject(answersStr);
                            if (answers && Object.keys(answers).length > 0) {
                                console.log('[CorrectAnswerExtractor] 从脚本变量提取答案:', answers);
                                return answers;
                            }
                        } catch (error) {
                            console.warn('[CorrectAnswerExtractor] 解析脚本变量失败:', error);
                        }
                    }
                }
                
                return null;
            }

            parseAnswersObject(objectStr) {
                try {
                    let cleanStr = objectStr
                        .replace(/\/\/.*$/gm, '')
                        .replace(/\/\*[\s\S]*?\*\//g, '')
                        .trim();
                    
                    if (cleanStr.startsWith('{') && cleanStr.endsWith('}')) {
                        cleanStr = cleanStr.replace(/([{,]\s*)([a-zA-Z_$][a-zA-Z0-9_$]*)\s*:/g, '$1"$2":');
                        return JSON.parse(cleanStr);
                    }
                } catch (error) {
                    console.warn('[CorrectAnswerExtractor] JSON解析失败，尝试其他方法:', error);
                }
                
                return this.manualParseAnswers(objectStr);
            }

            manualParseAnswers(objectStr) {
                const answers = {};
                const keyValuePattern = /([a-zA-Z0-9_]+)\s*:\s*['"`]([^'"`]+)['"`]/g;
                let match;
                
                while ((match = keyValuePattern.exec(objectStr)) !== null) {
                    const key = match[1];
                    const value = match[2];
                    answers[key] = value;
                }
                
                return Object.keys(answers).length > 0 ? answers : null;
            }

            extractFromResultsTable(document = window.document) {
                const selectors = [
                    '.results-table', '.answer-table', '.score-table',
                    'table[class*="result"]', 'table[class*="answer"]',
                    '.exam-results table', '#results table'
                ];
                
                for (const selector of selectors) {
                    const table = document.querySelector(selector);
                    if (table) {
                        return this.parseAnswersFromTable(table);
                    }
                }
                
                return null;
            }

            extractFromDOM(document = window.document) {
                const answers = {};
                const answerSelectors = [
                    '[data-correct-answer]', '.correct-answer', '.solution',
                    '[class*="correct"]', '[id*="correct"]'
                ];
                
                for (const selector of answerSelectors) {
                    const elements = document.querySelectorAll(selector);
                    elements.forEach((el, index) => {
                        const questionId = this.extractQuestionId(el) || `q${index + 1}`;
                        const answer = this.extractAnswerFromElement(el);
                        if (answer) {
                            answers[questionId] = answer;
                        }
                    });
                }
                
                return Object.keys(answers).length > 0 ? answers : null;
            }

            extractFromScripts(document = window.document) {
                const scripts = document.querySelectorAll('script');
                
                for (const script of scripts) {
                    const content = script.textContent || script.innerHTML;
                    if (content.includes('answer') || content.includes('correct')) {
                        try {
                            const jsonMatch = content.match(/(?:answers?|correct)\s*[:=]\s*(\{[^}]+\}|\[[^\]]+\])/i);
                            if (jsonMatch) {
                                const answers = JSON.parse(jsonMatch[1]);
                                if (answers && typeof answers === 'object') {
                                    return answers;
                                }
                            }
                        } catch (error) {
                            // 继续尝试其他方法
                        }
                    }
                }
                
                return null;
            }

            parseAnswersFromTable(table) {
                const answers = {};
                const rows = table.querySelectorAll('tr');
                
                for (const row of rows) {
                    const cells = row.querySelectorAll('td, th');
                    if (cells.length >= 2) {
                        const questionCell = cells[0];
                        const answerCell = this.findAnswerCell(cells);
                        
                        if (answerCell) {
                            const questionId = this.extractQuestionId(questionCell);
                            const answer = this.extractAnswerFromElement(answerCell);
                            
                            if (questionId && answer) {
                                answers[questionId] = answer;
                            }
                        }
                    }
                }
                
                return Object.keys(answers).length > 0 ? answers : null;
            }

            findAnswerCell(cells) {
                for (let i = 1; i < cells.length; i++) {
                    const cell = cells[i];
                    const text = cell.textContent.toLowerCase();
                    const className = cell.className.toLowerCase();
                    
                    if (text.includes('correct') || text.includes('answer') || 
                        className.includes('correct') || className.includes('answer') ||
                        text.includes('正确') || text.includes('答案')) {
                        return cell;
                    }
                }
                
                return cells[1];
            }

            extractQuestionId(element) {
                if (element.dataset.questionId) {
                    return element.dataset.questionId;
                }
                
                if (element.id) {
                    const match = element.id.match(/q(\d+)|question[_-]?(\d+)/i);
                    if (match) {
                        return `q${match[1] || match[2]}`;
                    }
                }
                
                const text = element.textContent;
                const match = text.match(/(?:问题|题目|Question)\s*[#:]?\s*(\d+)|^(\d+)[.)]/);
                if (match) {
                    return `q${match[1] || match[2]}`;
                }
                
                return null;
            }

            extractAnswerFromElement(element) {
                if (element.dataset.correctAnswer) {
                    return element.dataset.correctAnswer;
                }
                
                if (element.dataset.answer) {
                    return element.dataset.answer;
                }
                
                let text = element.textContent.trim();
                text = text.replace(/^(?:正确答案[:：]?|答案[:：]?|Correct Answer[:：]?|Answer[:：]?)\s*/i, '');
                
                if (/^(true|false)$/i.test(text)) {
                    return text.toUpperCase();
                }
                
                if (/^[A-Z]$/i.test(text)) {
                    return text.toUpperCase();
                }
                
                return text;
            }

            normalizeAnswers(answers) {
                const normalized = {};
                
                for (const [key, value] of Object.entries(answers)) {
                    const normalizedKey = key.toString().toLowerCase().startsWith('q') 
                        ? key 
                        : `q${key}`;
                    
                    let normalizedValue = value;
                    if (typeof value === 'string') {
                        normalizedValue = value.trim();
                        
                        if (/^(true|t|yes|y|正确|是)$/i.test(normalizedValue)) {
                            normalizedValue = 'TRUE';
                        } else if (/^(false|f|no|n|错误|否)$/i.test(normalizedValue)) {
                            normalizedValue = 'FALSE';
                        }
                        
                        if (/^[A-Z]$/i.test(normalizedValue)) {
                            normalizedValue = normalizedValue.toUpperCase();
                        }
                    }
                    
                    normalized[normalizedKey] = normalizedValue;
                }
                
                return normalized;
            }
        };
    }

    window.practicePageEnhancer = {
        sessionId: null,
        parentWindow: null,
        answers: {},
        correctAnswers: {},
        interactions: [],
        startTime: Date.now(),
        isInitialized: false,

        initialize: function () {
            if (this.isInitialized) {
                console.log('[PracticeEnhancer] 已经初始化，跳过');
                return;
            }
            console.log('[PracticeEnhancer] 开始初始化');
            this.setupCommunication();
            this.setupAnswerListeners();
            this.extractCorrectAnswers(); // 新增：提取正确答案
            this.interceptSubmit();
            this.setupInteractionTracking();
            this.isInitialized = true;
            console.log('[PracticeEnhancer] 初始化完成');
            
            // 页面加载完成后进行一次初始收集
            if (document.readyState === 'complete') {
                setTimeout(() => this.collectAllAnswers(), 1000);
            } else {
                window.addEventListener('load', () => {
                    setTimeout(() => this.collectAllAnswers(), 1000);
                });
            }
        },

        cleanup: function() {
            console.log('[PracticeEnhancer] 清理资源');
            if (this.answerCollectionInterval) {
                clearInterval(this.answerCollectionInterval);
                this.answerCollectionInterval = null;
            }
        },

        setupCommunication: function () {
            this.parentWindow = window.opener || window.parent;
            if (!this.parentWindow || this.parentWindow === window) {
                console.warn('[PracticeEnhancer] 未检测到父窗口');
                return;
            }
            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'INIT_SESSION') {
                    this.sessionId = event.data.data.sessionId;
                    console.log('[PracticeEnhancer] 收到会话初始化:', this.sessionId);
                    this.sendMessage('SESSION_READY', {
                        pageType: this.detectPageType(),
                        url: window.location.href,
                        title: document.title
                    });
                }
            });
            console.log('[PracticeEnhancer] 通信设置完成');
        },

        detectPageType: function () {
            const title = document.title || '';
            const url = window.location.href || '';
            if (title.includes('P1') || url.includes('P1')) return 'P1';
            if (title.includes('P2') || url.includes('P2')) return 'P2';
            if (title.includes('P3') || url.includes('P3')) return 'P3';
            const pathParts = url.split('/');
            for (let part of pathParts) {
                if (part.match(/^P[123]$/i)) {
                    return part.toUpperCase();
                }
            }
            return 'unknown';
        },

        extractCorrectAnswers: function () {
            console.log('[PracticeEnhancer] 开始提取正确答案');
            
            // 使用CorrectAnswerExtractor如果可用
            if (window.CorrectAnswerExtractor) {
                try {
                    const extractor = new CorrectAnswerExtractor();
                    const extractedAnswers = extractor.extractFromPage(document);
                    
                    if (extractedAnswers && Object.keys(extractedAnswers).length > 0) {
                        this.correctAnswers = extractedAnswers;
                        console.log('[PracticeEnhancer] 使用提取器成功获得正确答案:', this.correctAnswers);
                    } else {
                        console.warn('[PracticeEnhancer] 提取器未找到答案，使用备用方法');
                        this.extractCorrectAnswersBackup();
                    }
                } catch (error) {
                    console.warn('[PracticeEnhancer] 提取器失败，使用备用方法:', error);
                    this.extractCorrectAnswersBackup();
                }
            } else {
                console.warn('[PracticeEnhancer] CorrectAnswerExtractor未加载，使用备用方法');
                this.extractCorrectAnswersBackup();
            }
            
            // 延迟提取，在页面完全加载后再次尝试
            setTimeout(function() {
                this.extractFromResultsTable();
            }.bind(this), 2000);
            
            // 定期检查是否有新的正确答案数据
            this.startCorrectAnswerMonitoring();
        },

        extractCorrectAnswersBackup: function () {
            // 多种备用提取方法
            const sources = ['answers', 'correctAnswers', 'answerKey', 'solutions'];
            
            for (const source of sources) {
                if (window[source] && typeof window[source] === 'object') {
                    Object.keys(window[source]).forEach(key => {
                        const value = window[source][key];
                        if (value !== undefined && value !== null) {
                            let normalizedKey = key;
                            if (!normalizedKey.startsWith('q') && /^\d+$/.test(normalizedKey)) {
                                normalizedKey = 'q' + normalizedKey;
                            }
                            this.correctAnswers[normalizedKey] = String(value).trim();
                        }
                    });
                }
            }
            
            // 尝试从DOM中提取
            this.extractFromDOM();
            
            console.log('[PracticeEnhancer] 备用方法提取正确答案:', this.correctAnswers);
        },

        extractFromDOM: function () {
            // 查找包含正确答案的元素
            const selectors = [
                '[data-correct-answer]',
                '.correct-answer',
                '.answer-key',
                '[data-answer]'
            ];
            
            const self = this;
            for (let i = 0; i < selectors.length; i++) {
                const selector = selectors[i];
                const elements = document.querySelectorAll(selector);
                for (let j = 0; j < elements.length; j++) {
                    const element = elements[j];
                    const questionId = element.dataset.question || 
                                     element.dataset.for || 
                                     element.dataset.questionId;
                    const correctAnswer = element.dataset.correctAnswer || 
                                        element.dataset.answer || 
                                        element.textContent.trim();
                    
                    if (questionId && correctAnswer) {
                        self.correctAnswers[questionId] = correctAnswer;
                    }
                }
            }
        },

        extractFromResultsTable: function () {
            console.log('[PracticeEnhancer] 尝试从结果表格提取正确答案');
            
            // 查找结果显示区域
            const resultsEl = document.getElementById('results');
            if (!resultsEl) {
                console.log('[PracticeEnhancer] 未找到results元素');
                return;
            }
            
            // 查找表格
            const tables = resultsEl.querySelectorAll('table');
            console.log('[PracticeEnhancer] 找到表格数量:', tables.length);
            
            for (let i = 0; i < tables.length; i++) {
                const table = tables[i];
                const rows = table.querySelectorAll('tr');
                console.log('[PracticeEnhancer] 表格', i, '行数:', rows.length);
                
                for (let j = 1; j < rows.length; j++) { // 跳过表头
                    const row = rows[j];
                    const cells = row.querySelectorAll('td');
                    
                    if (cells.length >= 3) {
                        const questionCell = cells[0];
                        const userAnswerCell = cells[1];
                        const correctAnswerCell = cells[2];
                        
                        const questionText = questionCell.textContent.trim();
                        const userAnswer = userAnswerCell.textContent.trim();
                        const correctAnswer = correctAnswerCell.textContent.trim();
                        
                        console.log('[PracticeEnhancer] 处理行:', questionText, userAnswer, correctAnswer);
                        
                        // 提取问题编号
                        const questionMatch = questionText.match(/(\d+)/);
                        if (questionMatch && correctAnswer && correctAnswer !== 'N/A' && correctAnswer !== '') {
                            const questionNum = questionMatch[1];
                            const questionKey = 'q' + questionNum;
                            this.correctAnswers[questionKey] = correctAnswer;
                            
                            // 同时更新用户答案，确保数据一致性
                            if (userAnswer && userAnswer !== 'No Answer') {
                                this.answers[questionKey] = userAnswer;
                            }
                            
                            console.log('[PracticeEnhancer] 从表格提取:', questionKey, '用户答案:', userAnswer, '正确答案:', correctAnswer);
                        }
                    }
                }
            }
            
            console.log('[PracticeEnhancer] 表格提取完成，正确答案:', this.correctAnswers);
            console.log('[PracticeEnhancer] 表格提取完成，用户答案:', this.answers);
        },

        setupAnswerListeners: function () {
            const self = this;
            
            // 增强的change事件监听
            document.addEventListener('change', function(e) {
                self.recordAnswer(e.target);
            });

            // 增强的input事件监听
            document.addEventListener('input', function(e) {
                self.recordAnswer(e.target);
            });

            // 点击事件监听（用于单选框、复选框）
            document.addEventListener('click', function(e) {
                if (e.target.type === 'radio' || e.target.type === 'checkbox') {
                    setTimeout(() => self.recordAnswer(e.target), 10);
                }
            });

            // 拖拽事件监听
            document.addEventListener('drop', function(e) {
                setTimeout(function() {
                    self.collectDropzoneAnswers();
                    self.collectAllAnswers(); // 全面收集一次
                }, 100);
            });

            // 页面可见性变化时收集答案（替代定期收集）
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    console.log('[PracticeEnhancer] 页面隐藏，收集答案');
                    self.collectAllAnswers();
                } else {
                    console.log('[PracticeEnhancer] 页面显示，准备收集答案');
                }
            });

            // 页面卸载前收集答案和清理
            window.addEventListener('beforeunload', function() {
                console.log('[PracticeEnhancer] 页面卸载，收集答案并清理');
                self.collectAllAnswers();
                self.cleanup();
            });

            // 页面失去焦点时收集答案
            window.addEventListener('blur', function() {
                console.log('[PracticeEnhancer] 页面失去焦点，收集答案');
                self.collectAllAnswers();
            });

            console.log('[PracticeEnhancer] 增强答案监听器设置完成');
        },

        recordAnswer: function(element) {
            if (!element) return;

            let questionId = null;
            let value = null;

            // 获取问题ID
            if (element.name) {
                questionId = element.name;
            } else if (element.id) {
                questionId = element.id.replace(/_input$|-input$|_answer$/, '');
            } else if (element.dataset.question) {
                questionId = element.dataset.question;
            }

            // 获取答案值
            if (element.type === 'radio' || element.type === 'checkbox') {
                if (element.checked) {
                    value = element.value;
                }
            } else {
                value = element.value;
            }

            // 记录答案
            if (questionId && value !== null && value !== '') {
                this.answers[questionId] = value;
                console.log('[PracticeEnhancer] 记录答案:', questionId, '=', value);
                
                // 记录交互
                this.interactions.push({
                    type: 'answer',
                    questionId: questionId,
                    value: value,
                    timestamp: Date.now(),
                    elementType: element.type || element.tagName.toLowerCase()
                });
            }
        },

        collectDropzoneAnswers: function () {
            // 收集拖拽填空题答案
            const dropzones = document.querySelectorAll('.dropzone');
            for (let i = 0; i < dropzones.length; i++) {
                const zone = dropzones[i];
                const qName = zone.dataset.target;
                const card = zone.querySelector('.card');
                if (qName && card) {
                    this.answers[qName] = card.dataset.value || card.textContent.trim();
                }
            }

            // 收集段落匹配题答案
            const paragraphZones = document.querySelectorAll('.paragraph-dropzone');
            for (let i = 0; i < paragraphZones.length; i++) {
                const zone = paragraphZones[i];
                const paragraph = zone.dataset.paragraph;
                const items = zone.querySelectorAll('.drag-item');
                if (paragraph && items.length > 0) {
                    const itemTexts = [];
                    for (let j = 0; j < items.length; j++) {
                        const item = items[j];
                        itemTexts.push(item.dataset.heading || item.textContent.trim());
                    }
                    this.answers['q' + paragraph.toLowerCase()] = itemTexts.join(',');
                }
            }

            // 收集匹配题答案
            const matchZones = document.querySelectorAll('.match-dropzone');
            for (let i = 0; i < matchZones.length; i++) {
                const zone = matchZones[i];
                const qName = zone.dataset.question;
                const item = zone.querySelector('.drag-item-clone');
                if (qName && item) {
                    this.answers[qName] = item.dataset.country || item.textContent.trim();
                }
            }
        },

        interceptSubmit: function () {
            // 延迟拦截，确保页面完全加载
            setTimeout(function() {
                // 拦截gradeAnswers函数
                if (typeof window.gradeAnswers === 'function') {
                    const originalGradeAnswers = window.gradeAnswers;
                    const self = this;
                    window.gradeAnswers = function() {
                        console.log('[PracticeEnhancer] 拦截到gradeAnswers调用');
                        self.collectAllAnswers();
                        const result = originalGradeAnswers();
                        self.handleSubmit();
                        return result;
                    };
                    console.log('[PracticeEnhancer] gradeAnswers函数拦截成功');
                } else {
                    console.warn('[PracticeEnhancer] 未找到gradeAnswers函数');
                }

                // 拦截grade函数
                if (typeof window.grade === 'function') {
                    const originalGrade = window.grade;
                    const self = this;
                    window.grade = function() {
                        console.log('[PracticeEnhancer] 拦截到grade调用');
                        self.collectAllAnswers();
                        const result = originalGrade();
                        self.handleSubmit();
                        return result;
                    };
                    console.log('[PracticeEnhancer] grade函数拦截成功');
                }
            }.bind(this), 1000);

            // 监听表单提交
            document.addEventListener('submit', (e) => {
                console.log('[PracticeEnhancer] 拦截到表单提交');
                this.collectAllAnswers();
                this.handleSubmit();
            });

            // 监听提交按钮点击 - 增强版
            const self = this;
            document.addEventListener('click', function(e) {
                console.log('[PracticeEnhancer] 点击事件:', e.target.tagName, e.target.id, e.target.className);

                if (e.target.tagName === 'BUTTON' &&
                    (e.target.textContent.includes('Submit') ||
                        e.target.textContent.includes('提交') ||
                        e.target.textContent.includes('完成') ||
                        e.target.textContent.includes('Check') ||
                        e.target.classList.contains('primary') ||
                        e.target.id === 'submit-btn' ||
                        (e.target.onclick && e.target.onclick.toString().includes('grade')))) {
                    console.log('[PracticeEnhancer] 检测到提交按钮点击:', e.target);
                    self.collectAllAnswers();
                    self.handleSubmit();
                }
            });

            // 定期检查结果是否出现
            this.startResultsMonitoring();

            console.log('[PracticeEnhancer] 提交拦截设置完成');
        },

        startCorrectAnswerMonitoring: function() {
            let checkCount = 0;
            const maxChecks = 30;
            const self = this;

            function checkForCorrectAnswers() {
                checkCount++;
                
                // 尝试从结果表格提取
                const resultsEl = document.getElementById('results');
                if (resultsEl && resultsEl.style.display !== 'none') {
                    const tables = resultsEl.querySelectorAll('table');
                    if (tables.length > 0) {
                        const firstTable = tables[0];
                        const rows = firstTable.querySelectorAll('tr');
                        if (rows.length > 1) { // 有数据行
                            console.log('[PracticeEnhancer] 检测到结果表格，提取正确答案');
                            self.extractFromResultsTable();
                        }
                    }
                }
                
                // 继续检查直到达到最大次数
                if (checkCount < maxChecks && Object.keys(self.correctAnswers).length === 0) {
                    setTimeout(checkForCorrectAnswers, 1000);
                }
            }

            setTimeout(checkForCorrectAnswers, 3000);
        },

        startResultsMonitoring: function() {
            let checkCount = 0;
            const maxChecks = 60;
            const self = this;

            function checkResults() {
                checkCount++;
                const resultsEl = document.getElementById('results');

                if (resultsEl && resultsEl.style.display !== 'none' && resultsEl.textContent.includes('Final Score')) {
                    console.log('[PracticeEnhancer] 检测到结果显示，自动提取分数');
                    self.collectAllAnswers();
                    // 不需要额外延迟，handleSubmit内部已经有延迟处理
                    self.handleSubmit();
                    return;
                }

                if (checkCount < maxChecks) {
                    setTimeout(checkResults, 500);
                }
            }

            setTimeout(checkResults, 2000);
        },

        collectAllAnswers: function () {
            console.log('[PracticeEnhancer] 开始全面收集答案...');
            
            const beforeCount = Object.keys(this.answers).length;

            // 1. 收集所有输入元素（更广泛的选择器）
            const allInputs = document.querySelectorAll('input, textarea, select');
            console.log('[PracticeEnhancer] 找到输入元素总数:', allInputs.length);
            
            allInputs.forEach((input, index) => {
                const questionId = this.getQuestionId(input);
                const value = this.getInputValue(input);

                if (input.type === 'text') {
                    console.log(`[DEBUG] Text Input Found: id='${input.id}', name='${input.name}', derived_questionId='${questionId}', value='${value}'`);
                }
                
                console.log(`[PracticeEnhancer] 输入元素 ${index}: type=${input.type}, name=${input.name}, id=${input.id}, value=${value}, questionId=${questionId}`);
                
                if (questionId && value !== null && value !== '') {
                    this.answers[questionId] = value;
                    console.log(`[PracticeEnhancer] 记录答案: ${questionId} = ${value}`);
                }
            });

            // 2. 收集拖拽答案
            this.collectDropzoneAnswers();

            // 3. 收集特殊格式的答案（通过data属性）
            const answerElements = document.querySelectorAll('[data-answer], [data-user-answer], [data-value]');
            console.log('[PracticeEnhancer] 找到data答案元素:', answerElements.length);
            
            answerElements.forEach(element => {
                const questionId = element.dataset.question || element.dataset.for || element.id;
                const answer = element.dataset.answer || element.dataset.userAnswer || element.dataset.value;
                if (questionId && answer) {
                    this.answers[questionId] = answer;
                    console.log(`[PracticeEnhancer] 记录data答案: ${questionId} = ${answer}`);
                }
            });

            // 4. 收集匹配题答案
            this.collectMatchingAnswers();

            // 5. 收集排序题答案
            this.collectOrderingAnswers();

            // 6. 尝试从页面特定结构收集答案
            this.collectFromPageStructure();

            const afterCount = Object.keys(this.answers).length;
            console.log(`[PracticeEnhancer] 全面收集完成，答案数量从 ${beforeCount} 增加到 ${afterCount}`);
            console.log('[PracticeEnhancer] 收集到的所有答案:', this.answers);
        },

        getQuestionId: function(input) {
            // 尝试多种方式获取问题ID
            if (input.name) return input.name;
            if (input.id) return input.id.replace(/_input$|-input$|_answer$/, '');
            if (input.dataset.question) return input.dataset.question;
            if (input.dataset.for) return input.dataset.for;
            
            // 尝试从父元素获取
            let parent = input.parentElement;
            while (parent && parent !== document.body) {
                if (parent.dataset.question) return parent.dataset.question;
                if (parent.id && parent.id.includes('q')) return parent.id;
                parent = parent.parentElement;
            }
            
            // 尝试从相邻元素获取
            const label = document.querySelector(`label[for="${input.id}"]`);
            if (label && label.textContent) {
                const match = label.textContent.match(/(\d+)/);
                if (match) return 'q' + match[1];
            }
            
            return null;
        },

        getInputValue: function(input) {
            if (input.type === 'radio' || input.type === 'checkbox') {
                return input.checked ? input.value : null;
            }
            return input.value;
        },

        collectFromPageStructure: function() {
            console.log('[PracticeEnhancer] 尝试从页面结构收集答案...');
            
            // 查找所有可能包含问题的容器
            const questionContainers = document.querySelectorAll(
                '.question, .quiz-question, [class*="question"], [id*="question"], [data-question]'
            );
            
            console.log('[PracticeEnhancer] 找到问题容器:', questionContainers.length);
            
            questionContainers.forEach((container, index) => {
                console.log(`[PracticeEnhancer] 处理问题容器 ${index}:`, container.className, container.id);
                
                // 在容器内查找输入元素
                const inputs = container.querySelectorAll('input, textarea, select');
                inputs.forEach(input => {
                    const questionId = this.getQuestionId(input) || `q${index + 1}`;
                    const value = this.getInputValue(input);
                    
                    if (value !== null && value !== '') {
                        this.answers[questionId] = value;
                        console.log(`[PracticeEnhancer] 从容器收集答案: ${questionId} = ${value}`);
                    }
                });
            });
        },

        collectMatchingAnswers: function() {
            // 收集匹配题的答案
            const matchContainers = document.querySelectorAll('.matching-container, .match-exercise, [class*="match"]');
            matchContainers.forEach(container => {
                const pairs = container.querySelectorAll('.match-pair, .matched-item');
                pairs.forEach(pair => {
                    const questionId = pair.dataset.question || pair.dataset.left;
                    const answer = pair.dataset.answer || pair.dataset.right;
                    if (questionId && answer) {
                        this.answers[questionId] = answer;
                    }
                });
            });
        },

        collectOrderingAnswers: function() {
            // 收集排序题的答案
            const orderContainers = document.querySelectorAll('.ordering-container, .sort-exercise, [class*="order"]');
            orderContainers.forEach(container => {
                const items = container.querySelectorAll('.order-item, .sortable-item');
                const orderedAnswers = [];
                items.forEach((item, index) => {
                    const value = item.dataset.value || item.textContent.trim();
                    if (value) {
                        orderedAnswers.push(value);
                    }
                });
                
                if (orderedAnswers.length > 0) {
                    const questionId = container.dataset.question || 'ordering';
                    this.answers[questionId] = orderedAnswers.join(',');
                }
            });
        },

        setupInteractionTracking: function () {
            const self = this;
            document.addEventListener('click', function(e) {
                self.interactions.push({
                    type: 'click',
                    target: e.target.tagName + (e.target.className ? '.' + e.target.className : ''),
                    timestamp: Date.now()
                });
            });

            let scrollTimeout;
            document.addEventListener('scroll', function() {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(function() {
                    self.interactions.push({
                        type: 'scroll',
                        scrollY: window.scrollY,
                        timestamp: Date.now()
                    });
                }, 500);
            });
        },

        handleSubmit: function () {
            if (!this.sessionId) {
                console.warn('[PracticeEnhancer] 无会话ID，无法发送数据');
                return;
            }

            const self = this;
            
            // 延迟发送数据，确保有足够时间提取正确答案
            setTimeout(function() {
                // 最后一次尝试提取正确答案
                self.extractFromResultsTable();
                
                // 再次延迟，等待异步提取完成
                setTimeout(function() {
                    // 如果仍然没有正确答案，尝试其他方法
                    if (Object.keys(self.correctAnswers).length === 0) {
                        self.extractCorrectAnswersBackup();
                    }

                    const endTime = Date.now();
                    const duration = Math.round((endTime - self.startTime) / 1000);

                    // 生成答案比较数据
                    const answerComparison = self.generateAnswerComparison();

                    const results = {
                        sessionId: self.sessionId,
                        examId: self.sessionId.split('_')[0] || 'unknown',
                        startTime: self.startTime,
                        endTime: endTime,
                        duration: duration,
                        answers: self.answers,
                        correctAnswers: self.correctAnswers, // 新增：正确答案
                        answerComparison: answerComparison, // 新增：答案比较
                        interactions: self.interactions,
                        scoreInfo: self.extractScore(),
                        pageType: self.detectPageType(),
                        url: window.location.href,
                        title: document.title
                    };

                    console.log('[PracticeEnhancer] 发送练习完成数据:', results);
                    self.sendMessage('PRACTICE_COMPLETE', results);
                }, 1000); // 再等1秒确保异步提取完成
            }, 500); // 先等0.5秒让结果表格完全显示
        },

        generateAnswerComparison: function () {
            const comparison = {};
            
            // 获取所有问题的键
            const userKeys = Object.keys(this.answers);
            const correctKeys = Object.keys(this.correctAnswers);
            const allQuestions = {};
            
            // 合并所有问题键
            for (let i = 0; i < userKeys.length; i++) {
                allQuestions[userKeys[i]] = true;
            }
            for (let i = 0; i < correctKeys.length; i++) {
                allQuestions[correctKeys[i]] = true;
            }
            
            const questionKeys = Object.keys(allQuestions);
            for (let i = 0; i < questionKeys.length; i++) {
                const questionKey = questionKeys[i];
                const userAnswer = this.answers[questionKey];
                const correctAnswer = this.correctAnswers[questionKey];
                
                comparison[questionKey] = {
                    userAnswer: userAnswer || null,
                    correctAnswer: correctAnswer || null,
                    isCorrect: this.compareAnswers(userAnswer, correctAnswer)
                };
            }
            
            console.log('[PracticeEnhancer] 生成答案比较:', comparison);
            return comparison;
        },

        compareAnswers: function (userAnswer, correctAnswer) {
            if (!userAnswer || !correctAnswer) {
                return false;
            }
            
            // 标准化答案进行比较
            const normalize = (str) => String(str).trim().toLowerCase();
            return normalize(userAnswer) === normalize(correctAnswer);
        },

        extractScore: function () {
            const resultsEl = document.getElementById('results');
            if (!resultsEl) {
                console.warn('[PracticeEnhancer] 未找到结果元素');
                return null;
            }

            const text = resultsEl.textContent || '';
            console.log('[PracticeEnhancer] 结果文本:', text);

            // 匹配 "Final Score: 85% (11/13)" 格式 - 66号文件格式
            const finalScoreMatch = text.match(/Final\s+Score:\s*(\d+)%\s*\((\d+)\/(\d+)\)/i);
            if (finalScoreMatch) {
                const percentage = parseInt(finalScoreMatch[1]);
                const correct = parseInt(finalScoreMatch[2]);
                const total = parseInt(finalScoreMatch[3]);
                const accuracy = total > 0 ? correct / total : 0;

                console.log('[PracticeEnhancer] 提取Final Score成绩:', { correct, total, accuracy, percentage });

                return {
                    correct: correct,
                    total: total,
                    accuracy: accuracy,
                    percentage: percentage,
                    source: 'final_score_extraction'
                };
            }

            // 匹配 "Score: 11/13" 格式
            const scoreMatch = text.match(/Score:\s*(\d+)\/(\d+)/i);
            if (scoreMatch) {
                const correct = parseInt(scoreMatch[1]);
                const total = parseInt(scoreMatch[2]);
                const accuracy = total > 0 ? correct / total : 0;
                const percentage = Math.round(accuracy * 100);

                console.log('[PracticeEnhancer] 提取Score成绩:', { correct, total, accuracy, percentage });

                return {
                    correct: correct,
                    total: total,
                    accuracy: accuracy,
                    percentage: percentage,
                    source: 'score_extraction'
                };
            }

            // 匹配 "Accuracy: 85%" 格式
            const accuracyPercentMatch = text.match(/Accuracy:\s*(\d+)%/i);
            if (accuracyPercentMatch) {
                const percentage = parseInt(accuracyPercentMatch[1]);
                return {
                    correct: 0,
                    total: 0,
                    accuracy: percentage / 100,
                    percentage: percentage,
                    source: 'accuracy_percentage_extraction'
                };
            }

            // 匹配单独的百分比 "85%" 格式
            const percentageMatch = text.match(/(\d+)%/);
            if (percentageMatch) {
                const percentage = parseInt(percentageMatch[1]);

                console.log('[PracticeEnhancer] 提取百分比成绩:', { percentage });

                return {
                    correct: 0,
                    total: 0,
                    accuracy: percentage / 100,
                    percentage: percentage,
                    source: 'percentage_extraction'
                };
            }

            // 匹配 "Accuracy 85%" 格式（无冒号）
            const accuracyMatch = text.match(/Accuracy\s+(\d+)%/i);
            if (accuracyMatch) {
                const percentage = parseInt(accuracyMatch[1]);
                return {
                    correct: 0,
                    total: 0,
                    accuracy: percentage / 100,
                    percentage: percentage,
                    source: 'accuracy_extraction'
                };
            }

            // 尝试从表格中提取成绩信息
            const correctCells = resultsEl.querySelectorAll('.result-correct');
            const incorrectCells = resultsEl.querySelectorAll('.result-incorrect');
            if (correctCells.length > 0 || incorrectCells.length > 0) {
                const correct = correctCells.length;
                const total = correctCells.length + incorrectCells.length;
                const accuracy = total > 0 ? correct / total : 0;
                const percentage = Math.round(accuracy * 100);

                console.log('[PracticeEnhancer] 从表格提取成绩:', { correct, total, accuracy, percentage });

                return {
                    correct: correct,
                    total: total,
                    accuracy: accuracy,
                    percentage: percentage,
                    source: 'table_extraction'
                };
            }

            console.warn('[PracticeEnhancer] 无法提取成绩信息，结果文本:', text);
            return null;
        },

        sendMessage: function (type, data) {
            if (!this.parentWindow) {
                console.warn('[PracticeEnhancer] 无父窗口，无法发送消息');
                return;
            }

            const message = {
                type: type,
                data: data,
                source: 'practice_page',
                timestamp: Date.now()
            };

            try {
                this.parentWindow.postMessage(message, '*');
                console.log('[PracticeEnhancer] 消息已发送:', type);
            } catch (error) {
                console.error('[PracticeEnhancer] 发送消息失败:', error);
            }
        },

        getStatus: function () {
            return {
                isInitialized: this.isInitialized,
                sessionId: this.sessionId,
                hasParentWindow: !!this.parentWindow,
                answersCount: Object.keys(this.answers).length,
                correctAnswersCount: Object.keys(this.correctAnswers).length, // 新增
                interactionsCount: this.interactions.length,
                pageType: this.detectPageType()
            };
        }
    };

    // 添加全局方法供调试和手动触发使用
    window.collectAnswersNow = function() {
        console.log('[PracticeEnhancer] 手动触发答案收集');
        window.practicePageEnhancer.collectAllAnswers();
        return window.practicePageEnhancer.answers;
    };

    window.getCorrectAnswers = function() {
        console.log('[PracticeEnhancer] 获取正确答案');
        window.practicePageEnhancer.extractCorrectAnswers();
        return window.practicePageEnhancer.correctAnswers;
    };

    // 自动初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            window.practicePageEnhancer.initialize();
        });
    } else {
        window.practicePageEnhancer.initialize();
    }

    // 调试函数
    window.debugPracticeEnhancer = () => {
        console.log('=== 练习页面增强器调试信息 ===');
        console.log('状态:', window.practicePageEnhancer.getStatus());
        console.log('用户答案:', window.practicePageEnhancer.answers);
        console.log('正确答案:', window.practicePageEnhancer.correctAnswers); // 新增
        console.log('答案比较:', window.practicePageEnhancer.generateAnswerComparison()); // 新增
        console.log('交互记录:', window.practicePageEnhancer.interactions);

        // 测试成绩提取
        const scoreInfo = window.practicePageEnhancer.extractScore();
        console.log('成绩提取测试:', scoreInfo);
    };
}
</script>
</body>
</html>
</html>