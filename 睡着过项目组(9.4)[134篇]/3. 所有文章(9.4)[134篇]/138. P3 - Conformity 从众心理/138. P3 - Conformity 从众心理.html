<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IELTS Reading Practice - Conformity</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --line: #e5e7eb;
            --bg: #f6f7fb;
            --panel: #fff;
            --accent: #3b82f6;
            --muted: #6b7280;
            --shadow: 0 6px 20px rgba(0,0,0,.12);
            --text-color: #333;
            --highlight: #fff3a3;
            --selbar-bg: #111;
            --selbar-text: #fff;
        }

        body.dark-mode {
            --line: #4a4a4a;
            --bg: #1a1a1a;
            --panel: #2a2a2a;
            --muted: #bbb;
            --text-color: #f0f0f0;
            --highlight: #5b21b6;
            --selbar-bg: #1f2937;
            --selbar-text: #e5e7eb;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        html { font-size: 16px; scroll-behavior: smooth; }
        html.font-regular { font-size: 16px; }
        html.font-large { font-size: 18px; }
        html.font-xlarge { font-size: 20px; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background: var(--bg);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s ease;
            padding-bottom: 64px;
        }

        .header {
            background-color: var(--panel);
            padding: 12px 20px;
            border-bottom: 1px solid var(--line);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 100;
            box-shadow: 0 1px 3px rgba(0,0,0,.05);
        }

        .header-content { display: flex; align-items: center; gap: 16px; }
        .header h1 { font-size: 1.2rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-color); }
        #timer { font-size: 1rem; font-weight: 500; background: var(--bg); padding: 6px 12px; border-radius: 6px; border: 1px solid var(--line); min-width: 90px; text-align: center; color: var(--text-color); }
        .header-controls { display: flex; align-items: center; gap: 10px; }
        .header-btn { background: var(--panel); border: 1px solid var(--line); border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s ease; color: var(--text-color); }
        .header-btn:hover { background: var(--bg); border-color: var(--accent); }

        #settings-panel {
            position: absolute; top: 60px; right: 20px; width: 200px; background: var(--panel); border-radius: 12px;
            box-shadow: var(--shadow); border: 1px solid var(--line); z-index: 1000; padding: 8px; display: none;
        }
        .settings-group { margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--line); }
        .settings-group:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .settings-title { font-size: 0.85rem; color: var(--muted); margin-bottom: 8px; padding-left: 12px; }
        .settings-option { display: block; width: 100%; text-align: left; padding: 8px 12px; border: none; background: none; cursor: pointer; font-size: 0.9rem; border-radius: 6px; color: var(--text-color); }
        .settings-option.active { background: #e9effd; color: var(--accent); font-weight: 500; }
        .dark-mode .settings-option.active { background: #1e3a8a; }

        #notes-panel {
            position: fixed; right: 12px; bottom: 76px; width: 320px; height: 45vh; background: var(--panel); border: 1px solid var(--line); border-radius: 12px;
            display: none; flex-direction: column; z-index: 900; box-shadow: var(--shadow); overflow: hidden;
        }
        #notes-panel header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid var(--line); background-color: var(--bg); }
        #notes-panel h3 { font-size: 1rem; font-weight: 600; color: var(--text-color); margin: 0; }
        #notes-panel textarea { flex: 1; border: 0; padding: 16px; resize: none; font-size: 0.95rem; background: transparent; color: var(--text-color); line-height: 1.6; }
        #notes-panel textarea:focus { outline: none; }
        #close-note { padding: 4px 8px; border-radius: 4px; border: 1px solid var(--line); background: transparent; cursor: pointer; color: var(--text-color); transition: background-color 0.2s; }
        #close-note:hover { background-color: rgba(0,0,0,0.05); }
        .dark-mode #close-note:hover { background-color: rgba(255,255,255,0.1); }

        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.08); z-index: 800; display: none; backdrop-filter: blur(2px); }
        .dark-mode .overlay { background: rgba(0, 0, 0, 0.3); }

        .shell { display: flex; height: calc(100vh - 58px - 64px); width: 100%; overflow: hidden; }
        .pane { background: var(--panel); overflow: auto; padding: 24px; }
        #left { min-width: 280px; max-width: calc(100% - 280px); width: 50%; }
        #right { min-width: 280px; flex: 1; background: var(--bg); border-left: 1px solid var(--line); }
        .dark-mode #right { background: #1a1a1a; }

        #divider { flex: 0 0 8px; background: var(--bg); cursor: ew-resize; user-select: none; position: relative; border-left: 1px solid var(--line); border-right: 1px solid var(--line); }
        #divider::before { content: ""; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 4px; height: 30px; border-radius: 2px; background: rgba(100, 100, 100, 0.2); }
        #divider:hover { background: #dbeafe; }
        .dark-mode #divider { border-color: #4a4a4a; }
        .dark-mode #divider:hover { background: #1e40af; }

        h2, h3, h4 { margin: 0 0 16px; color: var(--text-color); }
        #left p, #right p { margin: 0 0 16px; line-height: 1.7; }
        #left strong, #right strong { font-weight: 600; }
        .empty-space { height: 40px; }

        .group { background: var(--panel); border: 1px solid var(--line); border-radius: 10px; padding: 20px; margin-bottom: 20px; }
        .group ul { margin-left: 20px; margin-bottom: 16px; }
        .question-item { padding: 12px 0; border-bottom: 1px dashed var(--line); }
        .question-item p { margin-bottom: 8px; }
        .question-item:last-child { border-bottom: none; }
        .radio-options { display: flex; gap: 16px; flex-wrap: wrap; }
        .radio-options label { display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 0.9rem; }
        .summary-notes p { line-height: 2.2; }
        .summary-notes input { border: none; border-bottom: 1px solid #9ca3af; padding: 2px 8px; font-size: 1em; background: transparent; color: var(--text-color); min-width: 120px; text-align: center; }
        .dark-mode .summary-notes input { border-bottom-color: #666; }
        .summary-notes input:focus { outline: none; border-bottom: 2px solid var(--accent); }
        .kelman-notes ul { list-style: none; padding-left: 0; }
        .kelman-notes li { margin-bottom: 1rem; }
        .kelman-notes h5 { font-size: 1.1em; margin-bottom: 0.5rem; display: flex; align-items: center; }
        .kelman-notes .sub-point { padding-left: 20px; line-height: 2.2; }
        

        #results { background: var(--panel); border: 1px solid var(--line); border-radius: 10px; padding: 20px; margin-top: 20px; display: none; line-height: 1.8; }
        .results-table { width: 100%; border-collapse: collapse; margin-top: 12px; font-size: 0.9rem; }
        .results-table th, .results-table td { border: 1px solid var(--line); padding: 8px; text-align: center; }
        .results-table th { background: var(--bg); }
        .result-correct { color: #10b981; font-weight: bold; }
        .result-incorrect { color: #ef4444; font-weight: bold; }

        .hl { background: var(--highlight); box-shadow: inset 0 -2px 0 rgba(0,0,0,.05); cursor: pointer; }
        .dark-mode .hl { color: #f5f3ff; }

        #selbar { position: absolute; display: none; z-index: 6000; background: var(--selbar-bg); color: var(--selbar-text); border-radius: 8px; padding: 6px; box-shadow: var(--shadow); font-size: 13px; gap: 6px; align-items: center; }
        #selbar button { background: transparent; color: var(--selbar-text); border: 1px solid rgba(255,255,255,.25); padding: 4px 8px; border-radius: 6px; cursor: pointer; }
        #selbar button:hover { border-color: var(--selbar-text); }

        .practice-nav { background: var(--panel); padding: 12px 20px; display: flex; align-items: center; gap: 16px; box-shadow: 0 -2px 4px rgba(0,0,0,.05); flex-wrap: wrap; position: fixed; left: 0; right: 0; bottom: 0; border-top: 1px solid var(--line); z-index: 4000; }
        .practice-nav .title { font-weight: 600; color: var(--muted); }
        .practice-nav .questions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        .practice-nav .q-item { padding: 6px 10px; border: 1px solid var(--line); border-radius: 6px; background: var(--panel); cursor: pointer; font-size: 14px; transition: all 0.2s; min-width: 36px; text-align: center; color: var(--text-color); }
        .practice-nav .q-item:hover { background: var(--bg); border-color: var(--accent); }
        .practice-nav .q-item.answered { background: #e0e7ff; border-color: var(--accent); color: var(--accent); font-weight: 500; }
        .dark-mode .practice-nav .q-item.answered { background: #3949ab; border-color: var(--accent); color: #e8eaf6; }
        .practice-nav .q-item.correct { background: #dcfce7; border-color: #4ade80; color: #15803d; font-weight: bold;}
        .dark-mode .practice-nav .q-item.correct { background: #166534; border-color: #4ade80; color: #dcfce7; }
        .practice-nav .q-item.incorrect { background: #fee2e2; border-color: #f87171; color: #b91c1c; font-weight: bold; }
        .dark-mode .practice-nav .q-item.incorrect { background: #991b1b; border-color: #f87171; color: #fee2e2; }
        .practice-nav .controls { margin-left: auto; display: flex; align-items: center; gap: 12px; }
        .practice-nav .controls button { padding: 8px 12px; border: 1px solid var(--line); border-radius: 6px; background: var(--panel); cursor: pointer; color: var(--text-color); }
        .practice-nav .controls button.primary { background: var(--accent); color: #fff; border-color: var(--accent); }
        
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <h1>Conformity</h1>
            <div id="timer">00:00</div>
        </div>
        <div class="header-controls">
            <button class="header-btn" id="size-btn">Size</button>
            <button class="header-btn" id="color-btn">Color</button>
            <button class="header-btn" id="note-btn">Note</button>
        </div>
    </header>

    <div id="settings-panel">
        <div class="settings-group">
            <div class="settings-title">Font Size</div>
            <button class="settings-option active" data-size="regular">Regular</button>
            <button class="settings-option" data-size="large">Large</button>
            <button class="settings-option" data-size="xlarge">Extra Large</button>
        </div>
        <div class="settings-group">
            <div class="settings-title">Color Mode</div>
            <button class="settings-option active" data-mode="light">Black on White</button>
            <button class="settings-option" data-mode="dark">White on Black</button>
        </div>
    </div>

    <div id="notes-panel">
        <header>
            <h3>Notes</h3>
            <button id="close-note">Close</button>
        </header>
        <textarea placeholder="Write your notes here..."></textarea>
    </div>

    <div class="overlay"></div>

    <div class="shell">
        <section class="pane" id="left">
            <h2>READING PASSAGE 3</h2>
            <p>You should spend about 20 minutes on Questions 27-40, which are based on Reading Passage 3 below.</p>

            <h3>Conformity</h3>
            <h4>A review of conformity and some of the studies that have been done on it</h4>
            
            <p>During your childhood, there will have been some kind of craze which affected all the people in your school. It may have been to do with a particular toy or possibly a must-have item of clothing. It may have been something as simple as a type of pen or as expensive as an electronic games console. Fashion designers, toy manufacturers and anyone else involved in the retail trade love conformity. Set up a craze, especially in the young, and everyone will go for it. In fact, it's an ideal way to sell huge quantities of merchandise. The levels of conformity in consumerism are phenomenal. When you actually stand back and consider how easily we are persuaded that having certain items is the only way we can ensure peace of mind, you see what an important concept conformity is.</p>
            <p>Conformity has been described as “yielding to group pressure” (Crutchfield, 1962). However, this implies that other people put pressure on us to make us conform and this is not always the case. A better definition is given by Aronson (1976) who said it was a "change in a person's behaviour or opinions as a result of real or imagined pressure from a person or group of people”. This would make more sense, as often the pressure we feel is imagined. The person or group he refers to would have to be important to us at the time, regardless of their status.</p>
            <p>There has been considerable research on conformity. One of the first studies looked at the answers people gave when asked to estimate the number of beans in a bottle (Jenness, 1932). If you have ever entered a “guess the number" competition, you probably looked at the previous estimates made and based your judgment on what other people had guessed. This is more or less what happened in the Jenness study. First of all, he asked the respondents to give their own estimates, and then he asked them to decide a group estimate. Finally, he asked them alone again and discovered that they had stayed with the group answer.</p>
            <p>Probably the most famous study on conformity was undertaken by Asch (1951) when he created a situation where many of his subjects gave answers which were blatantly untrue, rather than contradict the people they were with. He did this by getting his subject to sit round a table with six stooges (colleagues of the experimenter) so that the subject was second to last. He showed them all a large card which had three lines of different lengths drawn on it, labelled A, B and C. He then gave them a card with a single line and asked them to match this in terms of length to one of the lines A, B or C.</p>
            <p>The stooges gave untrue responses in a number of the trials and the subjects were left in the situation where they either reported what they saw with their own eyes or conformed to the norm of the group. When the results were assessed, Asch found that in one out of every three trials where the wrong answer was given, the subject gave the same wrong answer as the stooges. This led to an average level of conformity of 32 per cent. Asch interviewed his subjects after the trials to try to find out why they conformed to an answer which was so obviously wrong. Most of them said that they did not want to cause problems within the group, although they also stated that when they did give wrong answers it made them anxious. (Asch found that when there was just one other person present who did not go along with the majority, no matter how many others there were, it was sufficient to make the subject give the right answer.)</p>
            <p>Kelman (1953) outlined three processes which can explain social conformity. The first is compliance, where subjects go along with the crowd to prevent any in-group hostility or bad feeling and to maintain group harmony. However, they do not change their own private belief. If we look back to the Asch study, we can see that the subjects were simply complying with the demands of the experimental situation but hadn't actually internalized the group's norms. They agreed in public, but dissented in private. In a process known as internalization, however, subjects do actually see the view of the group as the more valid one. They may be able to do this, for example, by convincing themselves that their eyesight is poor. Sometimes, however, subjects actually seem to change their beliefs because they want to become more like their heroes. If they really want to become part of an in-group, they will start to identify with that group and take on the group's values and beliefs, even if they are different to their own. Kelman calls this identification. It frequently happens with teenagers who want to become more like a peer group in order to be accepted, and suddenly seem to go against all the values and beliefs of their parents.</p>
            <p>So why is it that we have to conform? Some people feel confident most of the time, have high self-esteem and do not have to go along with the majority. For most of us, though, how confident we feel varies from day to day, depending on the situation we are in, and this can influence behaviour.</p>

            <div class="empty-space"></div>
        </section>
        
        <div id="divider"></div>
        
        <section class="pane" id="right">
            <h3>Questions</h3>
            
            <div class="group" id="q27-30-anchor">
                <h4>Questions 27–30</h4>
                <p>Do the following statements agree with the claims of the writer in Reading Passage 3? In boxes 27–30 on your answer sheet, write:</p>
                <ul>
                    <li><strong>YES</strong> if the statement agrees with the claims of the writer</li>
                    <li><strong>NO</strong> if the statement contradicts the claims of the writer</li>
                    <li><strong>NOT GIVEN</strong> if it is impossible to say what the writer thinks about this</li>
                </ul>
                <div class="question-item">
                    <p><strong>27</strong> Childhood crazes can centre on items of any value.</p>
                    <div class="radio-options">
                        <label><input name="q27" type="radio" value="YES"> YES</label>
                        <label><input name="q27" type="radio" value="NO"> NO</label>
                        <label><input name="q27" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
                    </div>
                </div>
                <div class="question-item">
                    <p><strong>28</strong> Children are more vulnerable to crazes now than they used to be.</p>
                     <div class="radio-options">
                        <label><input name="q28" type="radio" value="YES"> YES</label>
                        <label><input name="q28" type="radio" value="NO"> NO</label>
                        <label><input name="q28" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
                    </div>
                </div>
                <div class="question-item">
                    <p><strong>29</strong> Consumers make too many quick decisions in shops.</p>
                     <div class="radio-options">
                        <label><input name="q29" type="radio" value="YES"> YES</label>
                        <label><input name="q29" type="radio" value="NO"> NO</label>
                        <label><input name="q29" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
                    </div>
                </div>
                <div class="question-item">
                    <p><strong>30</strong> Crutchfield's definition of conformity is the most reliable.</p>
                     <div class="radio-options">
                        <label><input name="q30" type="radio" value="YES"> YES</label>
                        <label><input name="q30" type="radio" value="NO"> NO</label>
                        <label><input name="q30" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
                    </div>
                </div>
            </div>

            <div class="group" id="q31-35-anchor">
                 <h4>Questions 31–35</h4>
                <p>Complete the summary below.</p>
                <p>Choose <strong>ONE WORD ONLY</strong> from the passage for each answer.</p>
                <div class="summary-notes">
                    <h4>Studies on conformity</h4>
                    <p>
                    In the Jenness study, people had to guess how many <strong>31</strong> <input type="text" id="q31_input"> were in a container. Jenness found that, in most cases, people opted for an estimate given by a <strong>32</strong> <input type="text" id="q32_input">.
                    </p>
                    <p>
                    Asch asked his subjects to <strong>33</strong> <input type="text" id="q33_input"> line lengths. To test the extent to which people would conform, he placed his subjects with colleagues who gave <strong>34</strong> <input type="text" id="q34_input"> responses. He found that his subjects agreed with his colleagues 32% of the time, although they admitted to feeling <strong>35</strong> <input type="text" id="q35_input"> about giving their answer.
                    </p>
                </div>
            </div>
            
            <div class="group" id="q36-40-anchor">
                 <h4>Questions 36–40</h4>
                <p>Complete the notes below.</p>
                <p>Choose <strong>ONE WORD ONLY</strong> from the passage for each answer.</p>
                <div class="kelman-notes">
                    <h4>Kelman's processes of social conformity</h4>
                    <ul>
                        <li>
                            <h5>Compliance</h5>
                            <div class="sub-point">– people support the majority view despite their own ideas</div>
                            <div class="sub-point">– social harmony is maintained</div>
                            <div class="sub-point">– illustrated by the results of the research conducted by <strong>36</strong> <input type="text" id="q36_input"></div>
                        </li>
                        <li>
                            <h5><strong>37</strong> <input type="text" id="q37_input"></h5>
                            <div class="sub-point">– majority view is considered most <strong>38</strong> <input type="text" id="q38_input"> view</div>
                            <div class="sub-point">– people persuade themselves despite their own ideas</div>
                        </li>
                        <li>
                            <h5><strong>39</strong> <input type="text" id="q39_input"></h5>
                             <div class="sub-point">– people change their ideas to those of the majority</div>
                             <div class="sub-point">– typical of <strong>40</strong> <input type="text" id="q40_input"></div>
                        </li>
                    </ul>
                </div>
            </div>
            
            <div id="results"></div>
        </section>
    </div>
    
    <div class="practice-nav">
        <div class="title">Questions</div>
        <div class="questions">
            <div class="q-item" id="q27-nav" onclick="scrollToElement('q27-30-anchor')">27</div>
            <div class="q-item" id="q28-nav" onclick="scrollToElement('q27-30-anchor')">28</div>
            <div class="q-item" id="q29-nav" onclick="scrollToElement('q27-30-anchor')">29</div>
            <div class="q-item" id="q30-nav" onclick="scrollToElement('q27-30-anchor')">30</div>
            <div class="q-item" id="q31-nav" onclick="scrollToElement('q31-35-anchor')">31</div>
            <div class="q-item" id="q32-nav" onclick="scrollToElement('q31-35-anchor')">32</div>
            <div class="q-item" id="q33-nav" onclick="scrollToElement('q31-35-anchor')">33</div>
            <div class="q-item" id="q34-nav" onclick="scrollToElement('q31-35-anchor')">34</div>
            <div class="q-item" id="q35-nav" onclick="scrollToElement('q31-35-anchor')">35</div>
            <div class="q-item" id="q36-nav" onclick="scrollToElement('q36-40-anchor')">36</div>
            <div class="q-item" id="q37-nav" onclick="scrollToElement('q36-40-anchor')">37</div>
            <div class="q-item" id="q38-nav" onclick="scrollToElement('q36-40-anchor')">38</div>
            <div class="q-item" id="q39-nav" onclick="scrollToElement('q36-40-anchor')">39</div>
            <div class="q-item" id="q40-nav" onclick="scrollToElement('q36-40-anchor')">40</div>
        </div>
        <div class="controls">
            <button id="submit-btn" class="primary">Submit</button>
            <button id="reset-btn">Reset</button>
            <button id="pause-btn">Pause</button>
        </div>
    </div>

    <div aria-label="Selection tools" id="selbar" role="toolbar">
        <button id="btnHL">Highlight</button>
        <button id="btnUH">Remove</button>
        <button id="btnNote">Note</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Global State ---
            let settingsOpen = false, notesOpen = false;
            let timerRunning = true, seconds = 0, timer;
            let isResizing = false;
            let selbar = document.getElementById('selbar');
            let lastRange = null, currentHlNode = null, keepToolbar = false;
            const questionNumbers = Array.from({length: 14}, (_, i) => i + 27);
            
            const correctAnswers = {
                q27: 'YES', q28: 'NOT GIVEN', q29: 'NOT GIVEN', q30: 'NO',
                q31: 'beans', q32: 'group', q33: 'match', q34: 'untrue', q35: 'anxious',
                q36: 'Asch', q37: 'internalization', q38: 'valid', q39: 'identification', q40: 'teenagers'
            };

            // --- Core Functions ---
            function startTimer() {
                timer = setInterval(() => {
                    if (timerRunning) {
                        seconds++;
                        const minutes = String(Math.floor(seconds / 60)).padStart(2, '0');
                        const secs = String(seconds % 60).padStart(2, '0');
                        document.getElementById('timer').textContent = `${minutes}:${secs}`;
                    }
                }, 1000);
            }

            function closeAllPanels() {
                notesOpen = false; settingsOpen = false;
                document.getElementById('notes-panel').style.display = 'none';
                document.getElementById('settings-panel').style.display = 'none';
                document.querySelector('.overlay').style.display = 'none';
            }

            window.scrollToElement = function(id) {
                const element = document.getElementById(id);
                const pane = element.closest('.pane');
                if (element && pane) {
                    const top = element.offsetTop - 20;
                    pane.scrollTo({ top, behavior: 'smooth' });
                }
            }
            
            // --- Grading and State Update ---
            function updateAnsweredState() {
                questionNumbers.forEach(i => {
                    const navItem = document.getElementById(`q${i}-nav`);
                    if (!navItem || navItem.classList.contains('correct') || navItem.classList.contains('incorrect')) return;

                    let answered = false;
                    if (i >= 27 && i <= 30) {
                        answered = !!document.querySelector(`input[name="q${i}"]:checked`);
                    } else {
                        answered = document.getElementById(`q${i}_input`).value.trim() !== "";
                    }
                    navItem.classList.toggle('answered', answered);
                });
            }
            
            function gradeAnswers() {
                timerRunning = false;
                document.getElementById('pause-btn').textContent = 'Continue';
                let correctCount = 0;
                const totalQuestions = questionNumbers.length;
                let resultsHTML = '<h4>Results</h4><table class="results-table"><thead><tr><th>Question</th><th>Your Answer</th><th>Correct Answer</th><th>Result</th></tr></thead><tbody>';

                questionNumbers.forEach(i => {
                    let userAnswer, isCorrect;
                    const correctAnswer = correctAnswers[`q${i}`];
                    const navItem = document.getElementById(`q${i}-nav`);

                    if (i >= 27 && i <= 30) {
                        const userAnswerEl = document.querySelector(`input[name="q${i}"]:checked`);
                        userAnswer = userAnswerEl ? userAnswerEl.value : 'No Answer';
                    } else {
                        const input = document.getElementById(`q${i}_input`);
                        userAnswer = input.value.trim() || 'No Answer';
                    }

                    isCorrect = userAnswer.toLowerCase() === correctAnswer.toLowerCase();
                    if (isCorrect) correctCount++;
                    
                    if(navItem) {
                        navItem.classList.remove('answered');
                        navItem.classList.add(isCorrect ? 'correct' : 'incorrect');
                    }
                    resultsHTML += `<tr><td>${i}</td><td>${userAnswer}</td><td>${correctAnswer}</td><td class="${isCorrect ? 'result-correct' : 'result-incorrect'}">${isCorrect ? '✓' : '✗'}</td></tr>`;
                });
                
                const score = Math.round((correctCount / totalQuestions) * 100);
                const summary = `<div style="font-weight:bold; margin-top:16px; font-size:1.1em;">Final Score: ${score}% (${correctCount}/${totalQuestions})</div>`;
                resultsHTML += `</tbody></table>`;
                
                document.getElementById('results').innerHTML = summary + resultsHTML;
                document.getElementById('results').style.display = 'block';
                scrollToElement('results');
            }

            function resetQuiz() {
                document.querySelectorAll('input[type="radio"]').forEach(el => el.checked = false);
                document.querySelectorAll('input[type="text"]').forEach(el => el.value = '');
                document.querySelectorAll('.q-item').forEach(item => item.className = 'q-item');
                const resultsDiv = document.getElementById('results');
                resultsDiv.style.display = 'none';
                resultsDiv.innerHTML = '';
                
                seconds = 0;
                if (timer) clearInterval(timer);
                startTimer();
                timerRunning = true;
                document.getElementById('pause-btn').textContent = 'Pause';
                updateAnsweredState();
            }

            // --- Highlighter & Selection Toolbar ---
            function positionSelbarForRect(rect) {
                selbar.style.display = 'flex';
                requestAnimationFrame(() => {
                    const top = window.scrollY + rect.top - selbar.offsetHeight - 8;
                    const left = window.scrollX + rect.left + rect.width / 2 - selbar.offsetWidth / 2;
                    selbar.style.top = `${(top > 0) ? top : (window.scrollY + rect.bottom + 8)}px`;
                    selbar.style.left = `${Math.max(8, left)}px`;
                });
            }

            function updateSelbar() {
                const sel = window.getSelection();
                if (!sel || sel.rangeCount === 0 || sel.isCollapsed) {
                    if (!keepToolbar && !currentHlNode) { selbar.style.display = 'none'; currentHlNode = null; }
                    return;
                }
                const range = sel.getRangeAt(0);
                let container = range.commonAncestorContainer;
                if (container.nodeType === Node.TEXT_NODE) container = container.parentElement;
                
                const isInAllowedPane = document.getElementById('left').contains(container) || document.getElementById('right').contains(container);
                const isHighlighted = container.classList?.contains('hl') || container.closest('.hl');
                if (!isInAllowedPane && !isHighlighted) { selbar.style.display = 'none'; return; }
                
                lastRange = range.cloneRange();
                currentHlNode = isHighlighted ? container.closest('.hl') : null;
                positionSelbarForRect(range.getBoundingClientRect());
            }

            function doHighlight() {
                if (currentHlNode || !lastRange || lastRange.collapsed) return;
                const sel = window.getSelection();
                try {
                    const span = document.createElement('span');
                    span.className = 'hl';
                    lastRange.surroundContents(span);
                } catch (e) { console.error("Highlighting failed:", e); return; }
                sel?.removeAllRanges();
                selbar.style.display = 'none';
            }

            function removeHighlight() {
                const sel = window.getSelection();
                let targetNode = currentHlNode;
                if (!targetNode && lastRange) {
                    const ancestor = lastRange.commonAncestorContainer;
                    targetNode = ancestor.nodeType === Node.TEXT_NODE ? ancestor.parentElement.closest('.hl') : ancestor.closest('.hl');
                }
                if (targetNode) {
                    const p = targetNode.parentNode;
                    while (targetNode.firstChild) p.insertBefore(targetNode.firstChild, targetNode);
                    if(p) p.removeChild(targetNode);
                    p?.normalize();
                }
                currentHlNode = null; sel?.removeAllRanges(); selbar.style.display = 'none';
            }

            // --- Event Listeners Setup ---
            startTimer();

            // Header controls
            document.getElementById('size-btn').addEventListener('click', (e) => { e.stopPropagation(); settingsOpen = !settingsOpen; document.getElementById('settings-panel').style.display = settingsOpen ? 'block' : 'none'; });
            document.getElementById('color-btn').addEventListener('click', (e) => { e.stopPropagation(); settingsOpen = !settingsOpen; document.getElementById('settings-panel').style.display = settingsOpen ? 'block' : 'none'; });
            document.getElementById('note-btn').addEventListener('click', () => { closeAllPanels(); notesOpen = true; document.getElementById('notes-panel').style.display = 'flex'; document.querySelector('.overlay').style.display = 'block'; });
            document.querySelectorAll('.settings-option[data-size]').forEach(btn => btn.addEventListener('click', function() { document.documentElement.className = `font-${this.dataset.size}`; document.querySelectorAll('.settings-option[data-size]').forEach(b => b.classList.remove('active')); this.classList.add('active'); }));
            document.querySelectorAll('.settings-option[data-mode]').forEach(btn => btn.addEventListener('click', function() { document.body.classList.toggle('dark-mode', this.dataset.mode === 'dark'); document.querySelectorAll('.settings-option[data-mode]').forEach(b => b.classList.remove('active')); this.classList.add('active'); }));
            document.getElementById('close-note').addEventListener('click', closeAllPanels);
            document.querySelector('.overlay').addEventListener('click', closeAllPanels);
            document.addEventListener('click', (e) => {
                const settingsPanel = document.getElementById('settings-panel');
                const headerControls = document.querySelector('.header-controls');
                if (!settingsPanel.contains(e.target) && !headerControls.contains(e.target)) { settingsPanel.style.display = 'none'; settingsOpen = false; }
            });

            // Bottom nav controls
            document.getElementById('submit-btn').addEventListener('click', gradeAnswers);
            document.getElementById('reset-btn').addEventListener('click', resetQuiz);
            document.getElementById('pause-btn').addEventListener('click', function() { timerRunning = !timerRunning; this.textContent = timerRunning ? 'Pause' : 'Continue'; });

            // Pane resizing
            const divider = document.getElementById('divider');
            const leftPane = document.getElementById('left');
            divider.addEventListener('mousedown', (e) => { isResizing = true; document.body.style.cursor = 'ew-resize'; e.preventDefault(); });
            document.addEventListener('mousemove', (e) => { if (!isResizing) return; const shellRect = document.querySelector('.shell').getBoundingClientRect(); let leftWidth = (e.clientX - shellRect.left) / shellRect.width * 100; leftPane.style.width = `${Math.max(20, Math.min(80, leftWidth))}%`; });
            document.addEventListener('mouseup', () => { if (isResizing) { isResizing = false; document.body.style.cursor = ''; } });
            
            // Update answered state on input
            document.getElementById('right').addEventListener('change', updateAnsweredState);
            document.getElementById('right').addEventListener('input', updateAnsweredState);

            // Selection toolbar events
            document.addEventListener('mouseup', () => setTimeout(updateSelbar, 10));
            document.addEventListener('selectionchange', () => setTimeout(updateSelbar, 10));
            document.addEventListener('mousedown', (e) => { keepToolbar = !!e.target.closest('#selbar, .hl'); }, true);
            document.addEventListener('click', (e) => {
                const target = e.target;
                if (target.classList.contains('hl')) {
                    currentHlNode = target; lastRange = null; positionSelbarForRect(target.getBoundingClientRect());
                    window.getSelection()?.removeAllRanges(); setTimeout(() => { keepToolbar = false; }, 0);
                } else if (!selbar.contains(e.target)) { selbar.style.display = 'none'; currentHlNode = null; }
            }, true);
            document.getElementById('btnHL').addEventListener('click', doHighlight);
            document.getElementById('btnUH').addEventListener('click', removeHighlight);
            document.getElementById('btnNote').addEventListener('click', function() {
                let text = (currentHlNode ? currentHlNode.textContent : (lastRange ? lastRange.cloneContents().textContent : '')).trim();
                if (text) {
                    const noteArea = document.querySelector('#notes-panel textarea');
                    noteArea.value += (noteArea.value ? '\n\n' : '') + '> ' + text;
                    closeAllPanels(); notesOpen = true; document.getElementById('notes-panel').style.display = 'flex';
                    document.querySelector('.overlay').style.display = 'block'; noteArea.scrollTop = noteArea.scrollHeight;
                }
                selbar.style.display = 'none';
            });
        });
    </script>
</body>
</html>