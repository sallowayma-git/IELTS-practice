<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IELTS Reading Practice - The Early History of Olive Oil</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --line: #e5e7eb;
            --bg: #f6f7fb;
            --panel: #fff;
            --accent: #3b82f6;
            --muted: #6b7280;
            --shadow: 0 6px 20px rgba(0,0,0,.12);
            --text-color: #333;
            --highlight: #fff3a3;
            --selbar-bg: #111;
            --selbar-text: #fff;
        }

        body.dark-mode {
            --line: #4a4a4a;
            --bg: #1a1a1a;
            --panel: #2a2a2a;
            --muted: #bbb;
            --text-color: #f0f0f0;
            --highlight: #5b21b6;
            --selbar-bg: #1f2937;
            --selbar-text: #e5e7eb;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        html { font-size: 16px; }
        html.font-regular { font-size: 16px; }
        html.font-large { font-size: 18px; }
        html.font-xlarge { font-size: 20px; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background: var(--bg);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s ease;
            padding-bottom: 64px;
        }

        .header {
            background-color: var(--panel);
            padding: 12px 20px;
            border-bottom: 1px solid var(--line);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 100;
            box-shadow: 0 1px 3px rgba(0,0,0,.05);
        }

        .header-content { display: flex; align-items: center; gap: 16px; }
        .header h1 { font-size: 1.2rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-color); }
        #timer { font-size: 1rem; font-weight: 500; background: var(--bg); padding: 6px 12px; border-radius: 6px; border: 1px solid var(--line); min-width: 90px; text-align: center; color: var(--text-color); }
        .header-controls { display: flex; align-items: center; gap: 10px; }
        .header-btn { background: var(--panel); border: 1px solid var(--line); border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s ease; color: var(--text-color); }
        .header-btn:hover { background: var(--bg); border-color: var(--accent); }

        #settings-panel {
            position: absolute; top: 60px; right: 20px; width: 200px; background: var(--panel); border-radius: 12px;
            box-shadow: var(--shadow); border: 1px solid var(--line); z-index: 1000; padding: 8px; display: none;
        }
        .settings-group { margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--line); }
        .settings-group:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .settings-title { font-size: 0.85rem; color: var(--muted); margin-bottom: 8px; padding-left: 12px; }
        .settings-option { display: block; width: 100%; text-align: left; padding: 8px 12px; border: none; background: none; cursor: pointer; font-size: 0.9rem; border-radius: 6px; color: var(--text-color); }
        .settings-option.active { background: #e9effd; color: var(--accent); font-weight: 500; }
        .dark-mode .settings-option.active { background: #1e3a8a; }

        #notes-panel {
            position: fixed; right: 12px; bottom: 76px; width: 320px; height: 45vh; background: var(--panel); border: 1px solid var(--line); border-radius: 12px;
            display: none; flex-direction: column; z-index: 900; box-shadow: var(--shadow); overflow: hidden;
        }
        #notes-panel header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid var(--line); background-color: var(--bg); }
        #notes-panel h3 { font-size: 1rem; font-weight: 600; color: var(--text-color); margin: 0; }
        #notes-panel textarea { flex: 1; border: 0; padding: 16px; resize: none; font-size: 0.95rem; background: transparent; color: var(--text-color); line-height: 1.6; }
        #notes-panel textarea:focus { outline: none; }
        #close-note { padding: 4px 8px; border-radius: 4px; border: 1px solid var(--line); background: transparent; cursor: pointer; color: var(--text-color); transition: background-color 0.2s; }
        #close-note:hover { background-color: rgba(0,0,0,0.05); }
        .dark-mode #close-note:hover { background-color: rgba(255,255,255,0.1); }

        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.08); z-index: 800; display: none; backdrop-filter: blur(2px); }
        .dark-mode .overlay { background: rgba(0, 0, 0, 0.3); }

        .shell { display: flex; height: calc(100vh - 58px - 64px); width: 100%; overflow: hidden; }
        .pane { background: var(--panel); overflow: auto; padding: 24px; }
        #left { min-width: 280px; max-width: calc(100% - 280px); width: 50%; }
        #right { min-width: 280px; flex: 1; background: var(--bg); border-left: 1px solid var(--line); }
        .dark-mode #right { background: #1a1a1a; }

        #divider { flex: 0 0 8px; background: var(--bg); cursor: ew-resize; user-select: none; position: relative; border-left: 1px solid var(--line); border-right: 1px solid var(--line); }
        #divider::before { content: ""; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 4px; height: 30px; border-radius: 2px; background: rgba(100, 100, 100, 0.2); }
        #divider:hover { background: #dbeafe; }
        .dark-mode #divider { border-color: #4a4a4a; }
        .dark-mode #divider:hover { background: #1e40af; }

        h2, h3, h4 { margin: 0 0 16px; color: var(--text-color); }
        #left p, #right p { margin: 0 0 16px; line-height: 1.7; }
        #left strong, #right strong { font-weight: 600; }
        .empty-space { height: 40px; }

        .group { background: var(--panel); border: 1px solid var(--line); border-radius: 10px; padding: 20px; margin-bottom: 20px; }
        .question-item { padding: 12px 0; border-bottom: 1px dashed var(--line); }
        .question-item:last-child { border-bottom: none; }
        .radio-options { display: flex; gap: 16px; margin-top: 8px; flex-wrap: wrap; }
        .radio-options label { display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 0.9rem; }
        .notes-completion { border: 1px solid var(--line); border-radius: 8px; padding: 20px; }
        .notes-completion h4 { margin-top: 0; text-align: center; margin-bottom: 20px; font-size: 1.2em; font-weight: 600;}
        .notes-completion p, .notes-completion li, .flowchart-box { line-height: 2.2; }
        .notes-completion input { border: none; border-bottom: 1px solid #9ca3af; padding: 2px 8px; font-size: 1em; background: transparent; color: var(--text-color); min-width: 120px; text-align: center; }
        .dark-mode .notes-completion input { border-bottom-color: #666; }
        .notes-completion input:focus { outline: none; border-bottom: 2px solid var(--accent); }
        .notes-completion ul { list-style-position: inside; padding-left: 0; list-style-type: none;}
        .flowchart-box { border: 1px solid var(--line); padding: 12px; border-radius: 6px; text-align: center; margin-bottom: 8px;}
        .flowchart-arrow { text-align: center; font-size: 1.5em; font-weight: bold; margin: -8px 0; }


        #results { background: var(--panel); border: 1px solid var(--line); border-radius: 10px; padding: 20px; margin-top: 20px; display: none; line-height: 1.8; }
        .results-table { width: 100%; border-collapse: collapse; margin-top: 12px; font-size: 0.9rem; }
        .results-table th, .results-table td { border: 1px solid var(--line); padding: 8px; text-align: center; }
        .results-table th { background: var(--bg); }
        .result-correct { color: #10b981; font-weight: bold; }
        .result-incorrect { color: #ef4444; font-weight: bold; }

        .hl { background: var(--highlight); box-shadow: inset 0 -2px 0 rgba(0,0,0,.05); cursor: pointer; }
        .dark-mode .hl { color: #f5f3ff; }

        #selbar { position: absolute; display: none; z-index: 6000; background: var(--selbar-bg); color: var(--selbar-text); border-radius: 8px; padding: 6px; box-shadow: var(--shadow); font-size: 13px; gap: 6px; align-items: center; }
        #selbar button { background: transparent; color: var(--selbar-text); border: 1px solid rgba(255,255,255,.25); padding: 4px 8px; border-radius: 6px; cursor: pointer; }
        #selbar button:hover { border-color: var(--selbar-text); }

        .practice-nav { background: var(--panel); padding: 12px 20px; display: flex; align-items: center; gap: 16px; box-shadow: 0 -2px 4px rgba(0,0,0,.05); flex-wrap: wrap; position: fixed; left: 0; right: 0; bottom: 0; border-top: 1px solid var(--line); z-index: 4000; }
        .practice-nav .title { font-weight: 600; color: var(--muted); }
        .practice-nav .questions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        .practice-nav .q-item { padding: 6px 10px; border: 1px solid var(--line); border-radius: 6px; background: var(--panel); cursor: pointer; font-size: 14px; transition: all 0.2s; min-width: 36px; text-align: center; color: var(--text-color); }
        .practice-nav .q-item:hover { background: var(--bg); border-color: var(--accent); }
        .practice-nav .q-item.answered { background: #e0e7ff; border-color: var(--accent); color: var(--accent); font-weight: 500; }
        .dark-mode .practice-nav .q-item.answered { background: #3949ab; border-color: var(--accent); color: #e8eaf6; }
        .practice-nav .q-item.correct { background: #dcfce7; border-color: #4ade80; color: #15803d; font-weight: bold; }
        .dark-mode .practice-nav .q-item.correct { background: #166534; border-color: #4ade80; color: #dcfce7; }
        .practice-nav .q-item.incorrect { background: #fee2e2; border-color: #f87171; color: #b91c1c; font-weight: bold; }
        .dark-mode .practice-nav .q-item.incorrect { background: #991b1b; border-color: #f87171; color: #fee2e2; }
        .practice-nav .controls { margin-left: auto; display: flex; align-items: center; gap: 12px; }
        .practice-nav .controls button { padding: 8px 12px; border: 1px solid var(--line); border-radius: 6px; background: var(--panel); cursor: pointer; color: var(--text-color); }
        .practice-nav .controls button.primary { background: var(--accent); color: #fff; border-color: var(--accent); }
        
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <h1>P1 - The Early History of Olive Oil</h1>
            <div id="timer">00:00</div>
        </div>
        <div class="header-controls">
            <button class="header-btn" id="size-btn">Size</button>
            <button class="header-btn" id="color-btn">Color</button>
            <button class="header-btn" id="note-btn">Note</button>
        </div>
    </header>

    <div id="settings-panel">
        <div class="settings-group">
            <div class="settings-title">Font Size</div>
            <button class="settings-option active" data-size="regular">Regular</button>
            <button class="settings-option" data-size="large">Large</button>
            <button class="settings-option" data-size="xlarge">Extra Large</button>
        </div>
        <div class="settings-group">
            <div class="settings-title">Color Mode</div>
            <button class="settings-option active" data-mode="light">Black on White</button>
            <button class="settings-option" data-mode="dark">White on Black</button>
        </div>
    </div>

    <div id="notes-panel">
        <header>
            <h3>Notes</h3>
            <button id="close-note">Close</button>
        </header>
        <textarea placeholder="Write your notes here..."></textarea>
    </div>

    <div class="overlay"></div>

    <div class="shell">
        <section class="pane" id="left">
            <h2>READING PASSAGE 1</h2>
            <p>You should spend about 20 minutes on Questions 1–13, which are based on Reading Passage 1 below.</p>
            
            <h3>The Early History of Olive Oil</h3>
            
            <p>Olive oil is produced from the fruit of the olive tree, which is a member of the Oleaceae plant family. The trees require some cold weather during the year, but also tolerate hot, dry conditions, and do not like moisture when they are flowering. They actually produce better when subjected to these stressful conditions, and as a result, olive trees have traditionally been grown on land where little else will survive.</p>
            <p>Archaeologists today are divided over exactly where the first domestication of the olive occurred: some say it was in the area which is now Iran, Syria, Jordan and Egypt, while others contend it was in mainland Greece or on the island of Crete. The one thing that can be said with certainty is that cultivation began at least 6,000 years ago and spread slowly westward across the lands bordering on the Mediterranean Sea. Olive oil was used for a variety of purposes during these early times, including as a pharmacological ointment and in rituals for anointing royalty.</p>
            <p>The ancient Greeks believed the olive tree was a priceless gift from the goddess Athena and used its oil in sacred religious rituals. In fact, the Greek poet Homer called olive oil 'liquid gold', and during the 6th and 7th centuries BC, Greek law forbade the cutting down of olive trees and made it punishable by death. The ancient Middle Eastern ruler King David valued his groves of olive trees and his olive oil warehouses so much that he posted guards around the clock to protect them.</p>
            <p>Over the years, olive oil developed other uses. Its employment in cooking dates at least as far back as the 5th century BC, as described by the Greek philosopher Plato. Its use as an aid to beauty and health later became ingrained in many Mediterranean cultures. The Romans, for example, are said to have used generous amounts on their bodies to moisturise their skin after bathing. With the spread of the Roman Empire, olive oil became a major commodity, and its trade promoted commerce throughout the ancient world. It is generally believed that in the 1st-2nd centuries BC, olive trees were taken to North Africa and then to Spain, which was later to become the world's largest producer of olive oil. Artefacts found at various Mediterranean archaeological sites include olive oil storage vessels with olive plant residue still in them. Historical evidence still in existence in the form of wall paintings and ancient manuscripts (including the works of the Roman naturalist and philosopher, Pliny the Elder) all record production techniques and the various uses of olive oil.</p>
            <p>Making olive oil in those early days was a laborious process accomplished without mechanisation. Processing or milling the fruit involved several distinct stages to extract the liquid. The olives were harvested from the trees by hand or by beating the fruit from the trees with long sticks. The olives were then rinsed and crushed to separate out the large seed found in the centre of each. The remaining seedless flesh was put in woven bags and pressed. Hot water was then poured over the bags to separate the oil from the solid bits of olive. The liquid produced in this process, consisting of oil and water, was drained into stone basins or tanks, where it was allowed to settle and separate. In cold weather, a bit of salt was added to speed up the process. As much oil as possible was drawn off the water, but the result was still not pure oil. Therefore, this impure mixture was allowed once more to settle in vats and then separated in order to refine the product.</p>
            <p>The waste water from the milling process, which is called amurca, is a bitter-tasting and foul-smelling liquid. In many ancient civilisations it was often simply discarded, causing serious pollution because of its acidity and high salt content. However, in the Roman period it was regarded as a very useful substance. When spread on surfaces, amurca forms a hard finish and therefore it was often applied to the floors of grain storage buildings where it hardened, keeping out water, mud and pests. When boiled down, amurca was applied to leather to soften it so that it was easier to shape into articles of clothing and shoes. It could also be eaten by farm animals and was, in fact, fed to livestock suffering from malnutrition. According to ancient texts, amurca was also utilised in moderate amounts by farmers as a fertiliser or as a pesticide, helping them to protect their crops from insects and even small rodents.</p>

            <div class="empty-space"></div>
        </section>
        
        <div id="divider"></div>
        
        <section class="pane" id="right">
            <h3>Questions 1–6</h3>
            <div class="group" id="q1-6-anchor">
                <h4>Do the following statements agree with the information given in Reading Passage 1?</h4>
                <p>In boxes 1–6 on your answer sheet, write:</p>
                <ul style="list-style-position: inside; padding-left: 0; margin-bottom: 1rem;">
                    <li><strong>TRUE</strong> if the statement agrees with the information</li>
                    <li><strong>FALSE</strong> if the statement contradicts the information</li>
                    <li><strong>NOT GIVEN</strong> if there is no information on this</li>
                </ul>
                
                <div class="question-item">
                    <p><strong>1</strong> In the cultivation of olives, a period without rain is advantageous.</p>
                    <div class="radio-options">
                        <label><input name="q1" type="radio" value="TRUE"> TRUE</label>
                        <label><input name="q1" type="radio" value="FALSE"> FALSE</label>
                        <label><input name="q1" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
                    </div>
                </div>
                <div class="question-item">
                    <p><strong>2</strong> The most fertile fields are usually chosen for growing olives.</p>
                    <div class="radio-options">
                        <label><input name="q2" type="radio" value="TRUE"> TRUE</label>
                        <label><input name="q2" type="radio" value="FALSE"> FALSE</label>
                        <label><input name="q2" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
                    </div>
                </div>
                <div class="question-item">
                    <p><strong>3</strong> In ancient Greece, the olive tree was said to have divine origins.</p>
                    <div class="radio-options">
                        <label><input name="q3" type="radio" value="TRUE"> TRUE</label>
                        <label><input name="q3" type="radio" value="FALSE"> FALSE</label>
                        <label><input name="q3" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
                    </div>
                </div>
                <div class="question-item">
                    <p><strong>4</strong> Olive oil was more costly to buy in Greece than gold.</p>
                    <div class="radio-options">
                        <label><input name="q4" type="radio" value="TRUE"> TRUE</label>
                        <label><input name="q4" type="radio" value="FALSE"> FALSE</label>
                        <label><input name="q4" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
                    </div>
                </div>
                <div class="question-item">
                    <p><strong>5</strong> Plato mentions the use of olive oil in the preparation of food.</p>
                    <div class="radio-options">
                        <label><input name="q5" type="radio" value="TRUE"> TRUE</label>
                        <label><input name="q5" type="radio" value="FALSE"> FALSE</label>
                        <label><input name="q5" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
                    </div>
                </div>
                <div class="question-item">
                    <p><strong>6</strong> North African farmers initially resisted the introduction of olive trees.</p>
                    <div class="radio-options">
                        <label><input name="q6" type="radio" value="TRUE"> TRUE</label>
                        <label><input name="q6" type="radio" value="FALSE"> FALSE</label>
                        <label><input name="q6" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
                    </div>
                </div>
            </div>

            <h3>Questions 7–9</h3>
             <div class="group" id="q7-9-anchor">
                <h4>Complete the flow-chart below.</h4>
                <p>Write <strong>ONE WORD ONLY</strong> from the passage for each answer.</p>
                <div class="notes-completion">
                    <h4>Ancient olive oil processing</h4>
                    <div class="flowchart-box">olives are harvested by picking them or <strong>7</strong><input type="text" id="q7_input"> the trees</div>
                    <div class="flowchart-arrow">↓</div>
                    <div class="flowchart-box">milling stage</div>
                    <div class="flowchart-arrow">↓</div>
                    <div class="flowchart-box">olives are washed and crushed, and seeds removed</div>
                    <div class="flowchart-arrow">↓</div>
                    <div class="flowchart-box">olive flesh is placed in <strong>8</strong><input type="text" id="q8_input"> and pressed</div>
                    <div class="flowchart-arrow">↓</div>
                    <div class="flowchart-box">water is poured over the mixture</div>
                    <div class="flowchart-arrow">↓</div>
                    <div class="flowchart-box">resulting liquid is given time to settle and separate, and <strong>9</strong><input type="text" id="q9_input"> is used to aid the process</div>
                    <div class="flowchart-arrow">↓</div>
                    <div class="flowchart-box">oil is drawn off and separation repeated</div>
                </div>
            </div>

            <h3>Questions 10–13</h3>
            <div class="group" id="q10-13-anchor">
                <h4>Complete the notes below.</h4>
                <p>Write <strong>ONE WORD ONLY</strong> from the passage for each answer.</p>
                <div class="notes-completion">
                    <h4 style="text-align: left;">Amurca</h4>
                    <p>In ancient times, this waste liquid was usually thrown away, which led to <strong>10</strong><input type="text" id="q10_input">.</p>
                    <p>However, Romans had practical applications for amurca:</p>
                    <ul>
                        <li>• when dried, created a hard surface, so used on <strong>11</strong><input type="text" id="q11_input"> of certain buildings</li>
                        <li>• used when making <strong>12</strong><input type="text" id="q12_input"></li>
                        <li>• fed to livestock</li>
                        <li>• used on farms as a <strong>13</strong><input type="text" id="q13_input"> to stop insects or animals from damaging crops</li>
                    </ul>
                </div>
            </div>
            
            <div id="results"></div>
        </section>
    </div>
    
    <div class="practice-nav">
        <div class="title">Questions</div>
        <div class="questions">
            <div class="q-item" id="q1-nav" onclick="scrollToElement('q1-6-anchor')">1</div>
            <div class="q-item" id="q2-nav" onclick="scrollToElement('q1-6-anchor')">2</div>
            <div class="q-item" id="q3-nav" onclick="scrollToElement('q1-6-anchor')">3</div>
            <div class="q-item" id="q4-nav" onclick="scrollToElement('q1-6-anchor')">4</div>
            <div class="q-item" id="q5-nav" onclick="scrollToElement('q1-6-anchor')">5</div>
            <div class="q-item" id="q6-nav" onclick="scrollToElement('q1-6-anchor')">6</div>
            <div class="q-item" id="q7-nav" onclick="scrollToElement('q7-9-anchor')">7</div>
            <div class="q-item" id="q8-nav" onclick="scrollToElement('q7-9-anchor')">8</div>
            <div class="q-item" id="q9-nav" onclick="scrollToElement('q7-9-anchor')">9</div>
            <div class="q-item" id="q10-nav" onclick="scrollToElement('q10-13-anchor')">10</div>
            <div class="q-item" id="q11-nav" onclick="scrollToElement('q10-13-anchor')">11</div>
            <div class="q-item" id="q12-nav" onclick="scrollToElement('q10-13-anchor')">12</div>
            <div class="q-item" id="q13-nav" onclick="scrollToElement('q10-13-anchor')">13</div>
        </div>
        <div class="controls">
            <button id="submit-btn" class="primary">Submit</button>
            <button id="reset-btn">Reset</button>
            <button id="pause-btn">Pause</button>
        </div>
    </div>

    <div aria-label="Selection tools" id="selbar" role="toolbar">
        <button id="btnHL">Highlight</button>
        <button id="btnUH">Remove</button>
        <button id="btnNote">Note</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Global State ---
            let settingsOpen = false, notesOpen = false;
            let timerRunning = true, seconds = 0, timer;
            let isResizing = false;
            let selbar = document.getElementById('selbar');
            let lastRange = null, currentHlNode = null, keepToolbar = false;
            
            const correctAnswers = {
                q1: 'TRUE', q2: 'FALSE', q3: 'TRUE', q4: 'NOT GIVEN', q5: 'TRUE', q6: 'NOT GIVEN',
                q7: 'beating', q8: 'bags', q9: 'salt', q10: 'pollution', q11: 'floors', 
                q12: 'leather', q13: 'pesticide'
            };

            // --- Core Functions ---
            function startTimer() {
                timer = setInterval(() => {
                    if (timerRunning) {
                        seconds++;
                        const minutes = String(Math.floor(seconds / 60)).padStart(2, '0');
                        const secs = String(seconds % 60).padStart(2, '0');
                        document.getElementById('timer').textContent = `${minutes}:${secs}`;
                    }
                }, 1000);
            }

            function closeAllPanels() {
                notesOpen = false; settingsOpen = false;
                document.getElementById('notes-panel').style.display = 'none';
                document.getElementById('settings-panel').style.display = 'none';
                document.querySelector('.overlay').style.display = 'none';
            }

            window.scrollToElement = function(id) {
                const element = document.getElementById(id);
                const pane = element.closest('.pane');
                if (element && pane) {
                    const top = element.offsetTop - 20;
                    pane.scrollTo({ top, behavior: 'smooth' });
                }
            }
            
            // --- Grading and State Update ---
            function updateAnsweredState() {
                for (let i = 1; i <= 13; i++) {
                    const navItem = document.getElementById(`q${i}-nav`);
                    if (navItem.classList.contains('correct') || navItem.classList.contains('incorrect')) continue;

                    let answered = false;
                    if (i <= 6) {
                        answered = !!document.querySelector(`input[name="q${i}"]:checked`);
                    } else {
                        answered = document.getElementById(`q${i}_input`).value.trim() !== "";
                    }
                    navItem.classList.toggle('answered', answered);
                }
            }
            
            function gradeAnswers() {
                timerRunning = false;
                document.getElementById('pause-btn').textContent = 'Continue';
                let correctCount = 0;
                const totalQuestions = 13;
                let resultsHTML = '<h4>Results</h4><table class="results-table"><thead><tr><th>Question</th><th>Your Answer</th><th>Correct Answer</th><th>Result</th></tr></thead><tbody>';

                for (let i = 1; i <= 13; i++) {
                    let userAnswer, isCorrect;
                    const correctAnswer = correctAnswers[`q${i}`];
                    const navItem = document.getElementById(`q${i}-nav`);

                    if (i <= 6) {
                        const userAnswerEl = document.querySelector(`input[name="q${i}"]:checked`);
                        userAnswer = userAnswerEl ? userAnswerEl.value : 'No Answer';
                    } else {
                        const input = document.getElementById(`q${i}_input`);
                        userAnswer = input.value.trim() || 'No Answer';
                    }

                    isCorrect = userAnswer.toLowerCase() === correctAnswer.toLowerCase();
                    if (isCorrect) correctCount++;
                    
                    navItem.classList.remove('answered');
                    navItem.classList.add(isCorrect ? 'correct' : 'incorrect');
                    resultsHTML += `<tr><td>${i}</td><td>${userAnswer}</td><td>${correctAnswer}</td><td class="${isCorrect ? 'result-correct' : 'result-incorrect'}">${isCorrect ? '✓' : '✗'}</td></tr>`;
                }
                
                const score = Math.round((correctCount / totalQuestions) * 100);
                const summary = `<div style="font-weight:bold; margin-top:16px; font-size:1.1em;">Final Score: ${score}% (${correctCount}/${totalQuestions})</div>`;
                resultsHTML += `</tbody></table>`;
                
                document.getElementById('results').innerHTML = summary + resultsHTML;
                document.getElementById('results').style.display = 'block';
                scrollToElement('results');
            }

            function resetQuiz() {
                document.querySelectorAll('input[type="radio"]').forEach(el => el.checked = false);
                document.querySelectorAll('input[type="text"]').forEach(el => el.value = '');
                document.querySelectorAll('.q-item').forEach(item => item.className = 'q-item');
                const resultsDiv = document.getElementById('results');
                resultsDiv.style.display = 'none';
                resultsDiv.innerHTML = '';
                
                document.querySelectorAll('.hl').forEach(h => {
                    const parent = h.parentNode;
                    while(h.firstChild) parent.insertBefore(h.firstChild, h);
                    if (parent) parent.removeChild(h);
                    if (parent) parent.normalize();
                });
                
                seconds = 0;
                if (timer) clearInterval(timer);
                document.getElementById('timer').textContent = '00:00';
                startTimer();
                timerRunning = true;
                document.getElementById('pause-btn').textContent = 'Pause';
                updateAnsweredState();
            }

            // --- Highlighter & Selection Toolbar ---
            function positionSelbarForRect(rect) {
                selbar.style.display = 'flex';
                requestAnimationFrame(() => {
                    const top = window.scrollY + rect.top - selbar.offsetHeight - 8;
                    const left = window.scrollX + rect.left + rect.width / 2 - selbar.offsetWidth / 2;
                    selbar.style.top = `${(top > 0) ? top : (window.scrollY + rect.bottom + 8)}px`;
                    selbar.style.left = `${Math.max(8, left)}px`;
                });
            }

            function updateSelbar() {
                const sel = window.getSelection();
                if (!sel || sel.rangeCount === 0 || sel.isCollapsed) {
                    if (!keepToolbar && !currentHlNode) { selbar.style.display = 'none'; currentHlNode = null; }
                    return;
                }
                const range = sel.getRangeAt(0);
                let container = range.commonAncestorContainer;
                if (container.nodeType === Node.TEXT_NODE) container = container.parentElement;
                
                const isInAllowedPane = document.getElementById('left').contains(container) || document.getElementById('right').contains(container);
                const isHighlighted = container.classList?.contains('hl') || container.closest('.hl');
                if ((!isInAllowedPane && !isHighlighted) || range.toString().trim() === '') { selbar.style.display = 'none'; return; }
                
                lastRange = range.cloneRange();
                currentHlNode = isHighlighted ? container.closest('.hl') : null;
                positionSelbarForRect(range.getBoundingClientRect());
            }

            function doHighlight() {
                if (currentHlNode || !lastRange || lastRange.collapsed) return;
                const sel = window.getSelection();
                try {
                    const span = document.createElement('span');
                    span.className = 'hl';
                    lastRange.surroundContents(span);
                } catch (e) { console.error("Highlighting failed:", e); return; }
                sel?.removeAllRanges();
                selbar.style.display = 'none';
            }

            function removeHighlight() {
                const sel = window.getSelection();
                let targetNode = currentHlNode;
                if (!targetNode && lastRange) {
                    const ancestor = lastRange.commonAncestorContainer;
                    targetNode = ancestor.nodeType === Node.TEXT_NODE ? ancestor.parentElement.closest('.hl') : ancestor.closest('.hl');
                }
                if (targetNode) {
                    const p = targetNode.parentNode;
                    while (targetNode.firstChild) p.insertBefore(targetNode.firstChild, targetNode);
                    if(p) p.removeChild(targetNode);
                    p?.normalize();
                }
                currentHlNode = null; sel?.removeAllRanges(); selbar.style.display = 'none';
            }

            // --- Event Listeners Setup ---
            startTimer();

            // Header controls
            document.getElementById('size-btn').addEventListener('click', (e) => { e.stopPropagation(); settingsOpen = !settingsOpen; document.getElementById('settings-panel').style.display = settingsOpen ? 'block' : 'none'; });
            document.getElementById('color-btn').addEventListener('click', (e) => { e.stopPropagation(); settingsOpen = !settingsOpen; document.getElementById('settings-panel').style.display = settingsOpen ? 'block' : 'none'; });
            document.getElementById('note-btn').addEventListener('click', () => { closeAllPanels(); notesOpen = true; document.getElementById('notes-panel').style.display = 'flex'; document.querySelector('.overlay').style.display = 'block'; });
            document.querySelectorAll('.settings-option[data-size]').forEach(btn => btn.addEventListener('click', function() { document.documentElement.className = `font-${this.dataset.size}`; document.querySelectorAll('.settings-option[data-size]').forEach(b => b.classList.remove('active')); this.classList.add('active'); }));
            document.querySelectorAll('.settings-option[data-mode]').forEach(btn => btn.addEventListener('click', function() { document.body.classList.toggle('dark-mode', this.dataset.mode === 'dark'); document.querySelectorAll('.settings-option[data-mode]').forEach(b => b.classList.remove('active')); this.classList.add('active'); }));
            document.getElementById('close-note').addEventListener('click', closeAllPanels);
            document.querySelector('.overlay').addEventListener('click', closeAllPanels);
            document.addEventListener('click', (e) => {
                const settingsPanel = document.getElementById('settings-panel');
                const headerControls = document.querySelector('.header-controls');
                if (settingsOpen && !settingsPanel.contains(e.target) && !headerControls.contains(e.target)) {
                     settingsPanel.style.display = 'none'; settingsOpen = false;
                }
            });

            // Bottom nav controls
            document.getElementById('submit-btn').addEventListener('click', gradeAnswers);
            document.getElementById('reset-btn').addEventListener('click', resetQuiz);
            document.getElementById('pause-btn').addEventListener('click', function() { timerRunning = !timerRunning; this.textContent = timerRunning ? 'Pause' : 'Continue'; });

            // Pane resizing
            const divider = document.getElementById('divider');
            const leftPane = document.getElementById('left');
            divider.addEventListener('mousedown', (e) => { isResizing = true; document.body.style.cursor = 'ew-resize'; e.preventDefault(); });
            document.addEventListener('mousemove', (e) => { if (!isResizing) return; const shellRect = document.querySelector('.shell').getBoundingClientRect(); let leftWidth = (e.clientX - shellRect.left) / shellRect.width * 100; leftPane.style.width = `${Math.max(20, Math.min(80, leftWidth))}%`; });
            document.addEventListener('mouseup', () => { if (isResizing) { isResizing = false; document.body.style.cursor = ''; } });
            
            // Update answered state on input
            document.getElementById('right').addEventListener('change', updateAnsweredState);
            document.getElementById('right').addEventListener('input', updateAnsweredState);

            // Selection toolbar events
            document.addEventListener('mouseup', () => setTimeout(updateSelbar, 10));
            document.addEventListener('selectionchange', () => setTimeout(updateSelbar, 10));
            document.addEventListener('mousedown', (e) => { keepToolbar = !!e.target.closest('#selbar, .hl'); }, true);
            document.addEventListener('click', (e) => {
                const target = e.target;
                if (target.classList.contains('hl')) {
                    currentHlNode = target; lastRange = null; positionSelbarForRect(target.getBoundingClientRect());
                    window.getSelection()?.removeAllRanges(); setTimeout(() => { keepToolbar = false; }, 0);
                } else if (!selbar.contains(e.target)) { selbar.style.display = 'none'; currentHlNode = null; }
            }, true);
            document.getElementById('btnHL').addEventListener('click', doHighlight);
            document.getElementById('btnUH').addEventListener('click', removeHighlight);
            document.getElementById('btnNote').addEventListener('click', function() {
                let text = (currentHlNode ? currentHlNode.textContent : (lastRange ? lastRange.cloneContents().textContent : '')).trim();
                if (text) {
                    const noteArea = document.querySelector('#notes-panel textarea');
                    noteArea.value += (noteArea.value ? '\n\n' : '') + '> ' + text;
                    closeAllPanels(); notesOpen = true; document.getElementById('notes-panel').style.display = 'flex';
                    document.querySelector('.overlay').style.display = 'block'; noteArea.scrollTop = noteArea.scrollHeight;
                }
                selbar.style.display = 'none';
            });
        });
    </script>
</body>
</html>