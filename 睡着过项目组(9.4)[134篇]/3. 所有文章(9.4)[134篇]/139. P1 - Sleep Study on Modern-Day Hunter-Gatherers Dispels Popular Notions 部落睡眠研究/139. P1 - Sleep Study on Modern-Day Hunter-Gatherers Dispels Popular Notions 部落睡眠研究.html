<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IELTS Reading Practice - Sleep Study on Hunter-Gatherers</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --line: #e5e7eb;
            --bg: #f6f7fb;
            --panel: #fff;
            --accent: #3b82f6;
            --muted: #6b7280;
            --shadow: 0 6px 20px rgba(0,0,0,.12);
            --text-color: #333;
            --highlight: #fff3a3;
            --selbar-bg: #111;
            --selbar-text: #fff;
        }

        body.dark-mode {
            --line: #4a4a4a;
            --bg: #1a1a1a;
            --panel: #2a2a2a;
            --muted: #bbb;
            --text-color: #f0f0f0;
            --highlight: #5b21b6;
            --selbar-bg: #1f2937;
            --selbar-text: #e5e7eb;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        html { font-size: 16px; scroll-behavior: smooth;}
        html.font-regular { font-size: 16px; }
        html.font-large { font-size: 18px; }
        html.font-xlarge { font-size: 20px; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background: var(--bg);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s ease;
            padding-bottom: 64px;
        }

        .header {
            background-color: var(--panel);
            padding: 12px 20px;
            border-bottom: 1px solid var(--line);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 100;
        }

        .header-content { display: flex; align-items: center; gap: 16px; }
        .header h1 { font-size: 1.2rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-color); }
        #timer { font-size: 1rem; font-weight: 500; background: var(--bg); padding: 6px 12px; border-radius: 6px; border: 1px solid var(--line); min-width: 90px; text-align: center; color: var(--text-color); }
        .header-controls { display: flex; align-items: center; gap: 10px; }
        .header-btn { background: var(--panel); border: 1px solid var(--line); border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s ease; color: var(--text-color); }
        .header-btn:hover { background: var(--bg); border-color: var(--accent); }

        #settings-panel { position: absolute; top: 60px; right: 20px; width: 200px; background: var(--panel); border-radius: 12px; box-shadow: var(--shadow); border: 1px solid var(--line); z-index: 1000; padding: 8px; display: none; }
        .settings-group { margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--line); }
        .settings-group:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .settings-title { font-size: 0.85rem; color: var(--muted); margin-bottom: 8px; padding-left: 12px; }
        .settings-option { display: block; width: 100%; text-align: left; padding: 8px 12px; border: none; background: none; cursor: pointer; font-size: 0.9rem; border-radius: 6px; color: var(--text-color); }
        .settings-option.active { background: #e9effd; color: var(--accent); font-weight: 500; }
        .dark-mode .settings-option.active { background: #1e3a8a; }

        #notes-panel { position: fixed; right: 12px; bottom: 76px; width: 320px; height: 45vh; background: var(--panel); border: 1px solid var(--line); border-radius: 12px; display: none; flex-direction: column; z-index: 900; box-shadow: var(--shadow); overflow: hidden; }
        #notes-panel header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid var(--line); background-color: var(--bg); }
        #notes-panel h3 { font-size: 1rem; font-weight: 600; color: var(--text-color); margin: 0; }
        #notes-panel textarea { flex: 1; border: 0; padding: 16px; resize: none; font-size: 0.95rem; background: transparent; color: var(--text-color); line-height: 1.6; }
        #notes-panel textarea:focus { outline: none; }
        #close-note { padding: 4px 8px; border-radius: 4px; border: 1px solid var(--line); background: transparent; cursor: pointer; color: var(--text-color); transition: background-color 0.2s; }

        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.08); z-index: 800; display: none; backdrop-filter: blur(2px); }
        .dark-mode .overlay { background: rgba(0, 0, 0, 0.3); }

        .shell { display: flex; height: calc(100vh - 58px - 64px); width: 100%; overflow: hidden; }
        .pane { background: var(--panel); overflow: auto; padding: 24px; transition: width 0.1s ease; }
        #left { min-width: 280px; max-width: calc(100% - 280px); width: 50%; }
        #right { min-width: 280px; flex: 1; background: var(--bg); border-left: 1px solid var(--line); }
        .dark-mode #right { background: #1e293b; }

        #divider { flex: 0 0 8px; background: var(--bg); cursor: ew-resize; user-select: none; position: relative; border-left: 1px solid var(--line); border-right: 1px solid var(--line); }
        #divider::before { content: ""; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 4px; height: 30px; border-radius: 2px; background: rgba(100, 100, 100, 0.2); }
        #divider:hover { background: #dbeafe; }

        h2, h3, h4, h5 { margin: 0 0 16px; color: var(--text-color); }
        #left p, #right p { margin: 0 0 16px; line-height: 1.7; }
        #left strong, #right strong { font-weight: 600; }
        .empty-space { height: 40px; }
        
        .group { background: var(--panel); border: 1px solid var(--line); border-radius: 10px; padding: 20px; margin-bottom: 20px; }
        .group ul { margin-left: 20px; margin-bottom: 16px; }
        .question-item { padding: 12px 0; border-bottom: 1px dashed var(--line); }
        .question-item:last-child { border-bottom: none; padding-bottom: 0; }
        .radio-options { display: flex; gap: 16px; margin-top: 8px; flex-wrap: wrap; }
        .radio-options label { display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 0.9rem; }
        .notes-completion { border: 1px solid var(--line); border-radius: 8px; padding: 20px; }
        .notes-completion h4 { margin-top: 0; }
        .notes-completion p, .notes-completion li { line-height: 2.5; }
        .notes-completion input { border: none; border-bottom: 1px solid #9ca3af; padding: 2px 8px; font-size: 1em; background: transparent; color: var(--text-color); min-width: 120px; text-align: center; }
        .dark-mode .notes-completion input { border-bottom-color: #666; }
        .notes-completion input:focus { outline: none; border-bottom: 2px solid var(--accent); }
        .notes-completion ul { list-style-position: inside; padding-left: 0; margin-bottom: 0;}
        .notes-completion li { margin-left: 20px; }

        #results { background: var(--panel); border: 1px solid var(--line); border-radius: 10px; padding: 20px; margin-top: 20px; display: none; line-height: 1.8; }
        .results-table { width: 100%; border-collapse: collapse; margin-top: 12px; font-size: 0.9rem; }
        .results-table th, .results-table td { border: 1px solid var(--line); padding: 8px; text-align: center; }
        .results-table th { background: var(--bg); }
        .result-correct { color: #10b981; font-weight: bold; }
        .result-incorrect { color: #ef4444; font-weight: bold; }

        .hl { background: var(--highlight); box-shadow: inset 0 -2px 0 rgba(0,0,0,.05); cursor: pointer; }
        .dark-mode .hl { color: #f5f3ff; }

        #selbar { position: absolute; display: none; z-index: 6000; background: var(--selbar-bg); color: var(--selbar-text); border-radius: 8px; padding: 6px; box-shadow: var(--shadow); font-size: 13px; gap: 6px; align-items: center; }
        #selbar button { background: transparent; color: var(--selbar-text); border: 1px solid rgba(255,255,255,.25); padding: 4px 8px; border-radius: 6px; cursor: pointer; }
        #selbar button:hover { border-color: var(--selbar-text); }

        .practice-nav { background: var(--panel); padding: 12px 20px; display: flex; align-items: center; gap: 16px; box-shadow: 0 -2px 4px rgba(0,0,0,.05); flex-wrap: wrap; position: fixed; left: 0; right: 0; bottom: 0; border-top: 1px solid var(--line); z-index: 4000; }
        .practice-nav .title { font-weight: 600; color: var(--muted); }
        .practice-nav .questions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        .practice-nav .q-item { padding: 6px 10px; border: 1px solid var(--line); border-radius: 6px; background: var(--panel); cursor: pointer; font-size: 14px; transition: all 0.2s; min-width: 36px; text-align: center; color: var(--text-color); }
        .practice-nav .q-item:hover { background: var(--bg); border-color: var(--accent); }
        .practice-nav .q-item.answered { background: #e0e7ff; border-color: var(--accent); color: var(--accent); font-weight: 500; }
        .dark-mode .practice-nav .q-item.answered { background: #3949ab; border-color: var(--accent); color: #e8eaf6; }
        .practice-nav .q-item.correct { background: #dcfce7; border-color: #4ade80; color: #15803d; }
        .dark-mode .practice-nav .q-item.correct { background: #166534; border-color: #4ade80; color: #dcfce7; }
        .practice-nav .q-item.incorrect { background: #fee2e2; border-color: #f87171; color: #b91c1c; }
        .dark-mode .practice-nav .q-item.incorrect { background: #991b1b; border-color: #f87171; color: #fee2e2; }
        .practice-nav .controls { margin-left: auto; display: flex; align-items: center; gap: 12px; }
        .practice-nav .controls button { padding: 8px 12px; border: 1px solid var(--line); border-radius: 6px; background: var(--panel); cursor: pointer; color: var(--text-color); }
        .practice-nav .controls button.primary { background: var(--accent); color: #fff; border-color: var(--accent); }
        
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <h1>Reading Passage 1</h1>
            <div id="timer">00:00</div>
        </div>
        <div class="header-controls">
            <button class="header-btn" id="size-btn">Size</button>
            <button class="header-btn" id="color-btn">Color</button>
            <button class="header-btn" id="note-btn">Note</button>
        </div>
    </header>

    <div id="settings-panel">
        <div class="settings-group">
            <div class="settings-title">Font Size</div>
            <button class="settings-option active" data-size="regular">Regular</button>
            <button class="settings-option" data-size="large">Large</button>
            <button class="settings-option" data-size="xlarge">Extra Large</button>
        </div>
        <div class="settings-group">
            <div class="settings-title">Color Mode</div>
            <button class="settings-option active" data-mode="light">Black on White</button>
            <button class="settings-option" data-mode="dark">White on Black</button>
        </div>
    </div>

    <div id="notes-panel">
        <header>
            <h3>Notes</h3>
            <button id="close-note">Close</button>
        </header>
        <textarea placeholder="Write your notes here..."></textarea>
    </div>

    <div class="overlay"></div>

    <div class="shell">
        <section class="pane" id="left">
            <h2>READING PASSAGE 1</h2>
            <p>You should spend about 20 minutes on Questions 1–13, which are based on Reading Passage 1 below.</p>
            
            <h3>Sleep Study on Modern-Day Hunter-Gatherers Dispels Popular Notions</h3>
            
            <p>The sleep troubles common in modern life have long been blamed on our industrial society, from the city lights, long work hours and commutes, to caffeine and the Internet. Sleep researchers often look back on a time when humans were able to get more rest by sleeping and waking to the rhythms of the sun. It turns out that this may not be quite right. In fact, our ancestors may not have been getting the recommended eight hours of sleep, either.</p>
            <p>In a recent study, researchers traveled all over the world to examine sleep in some of the world's last remaining hunter-gatherer societies – the Hadza of Tanzania, the San of Namibia, and the Tsimane of Bolivia. Cut off from media, electricity and other distractions, these pre-industrial societies are thought to sleep the way humans did more than 10,000 years ago. Traveling to where they lived, often in humid, remote locations, researchers used medical devices to record the sleeping habits of 94 of these tribespeople and ended up collecting data representing 1,165 days.</p>
            <p>They found very similar sleep patterns despite their geographic isolation. On average, all three groups sleep a little less than 6.5 hours a night, do not take naps, and don't go to sleep when it gets dark. Like many of us, the Hadza, San, and Tsimane spend more time in bed - from 6.9 to 8.5 hours – than they do actually sleeping. This adds up to a sleep efficiency that is very similar to today's industrial populations.</p>
            <p>According to Jerome Siegel, director of the University of California's Center for Sleep Research, evidence suggests sleep habits may not be environmental or cultural, but central to the physical makeup of humans. These findings question the millions of dollars that have been spent on research that tries to explain why some sleepers get only about six hours of sleep a night. Also, such findings question whether lack of sleep is a cause of obesity, mood disorders, and other physical and mental illnesses which have become so common in recent decades. Scientists have documented that people's energy often falls in the mid-afternoon. Some have suggested that it's because we've managed to suppress a natural desire for a nap.</p>
            <p>However, the new study provides evidence that this is unlikely, and that napping was actually rare in hunter-gatherer societies. The researchers estimated that naps may have occurred on up to 7 percent of winter days and 22 percent of summer days. They noted that their devices were only good at detecting longer naps, so it is possible that some of the study subjects took naps that were short, perhaps 15 minutes or less.</p>
            <p>Another fascinating finding from the study had to do with the circadian rhythms, our daily activity cycles related to sunlight. Instead of going to sleep right at dusk, tribespeople were staying awake an average of between 2.5 and 4.4 hours after sunset. All three tribes had fires going, but the light itself was much lower than you might get from a light bulb. They did, however, have a tendency to wake up anywhere between an hour before and an hour after sunrise.</p>
            <p>Siegel and his co-authors investigated this further by looking into the significance of temperature. They found that it also played a big role, though it was somewhat less important than light in influencing sleep patterns. They wrote that “sleep in both the winter and summer usually occurred during the period of cooling and that waking times usually occurred near the height of the daily warming trend."</p>
            <p>The tribespeople that were studied are different from people living in modern conditions in a number of respects. Importantly, almost none of them were troubled by sleeplessness. In interviews with the researchers conducted through interpreters, only 1.5 to 2.5 percent of the study subjects said they had severe difficulties sleeping more than once a year. This figure is far lower than the 10 to 30 percent recorded in many industrialized countries today. Siegel suggested that “mimicking aspects of the natural environment” may therefore help treat some sleep disorders.</p>
            <p>The tribespeople are also much healthier. Not a single one is overweight, indicating their overall higher levels of physical fitness. They also tended to have healthier hearts. Thus comes a critical question. If we can't blame our health problems on our lack of sleep, could it be that the reason we feel so unrested is because of poor health?</p>

            <div class="empty-space"></div>
        </section>
        
        <div id="divider"></div>
        
        <section class="pane" id="right">
            <h3>Questions</h3>
            
            <div class="group" id="q1-4-anchor">
                <h4>Questions 1–4</h4>
                <p>Do the following statements agree with the information given in Reading Passage 1?</p>
                <p>In boxes 1–4 on your answer sheet, write</p>
                <ul>
                    <li><strong>TRUE</strong> if the statement agrees with the information</li>
                    <li><strong>FALSE</strong> if the statement contradicts the information</li>
                    <li><strong>NOT GIVEN</strong> if there is no information on this</li>
                </ul>
                
                <div class="question-item">
                    <p><strong>1</strong> Scientists studied hunter-gatherer societies because their sleep patterns are assumed to be similar to those of humans more than 10,000 years ago.</p>
                    <div class="radio-options">
                        <label><input name="q1" type="radio" value="TRUE"> TRUE</label>
                        <label><input name="q1" type="radio" value="FALSE"> FALSE</label>
                        <label><input name="q1" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
                    </div>
                </div>
                <div class="question-item">
                    <p><strong>2</strong> The medical devices used in the research were specially designed for humid conditions.</p>
                    <div class="radio-options">
                        <label><input name="q2" type="radio" value="TRUE"> TRUE</label>
                        <label><input name="q2" type="radio" value="FALSE"> FALSE</label>
                        <label><input name="q2" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
                    </div>
                </div>
                <div class="question-item">
                    <p><strong>3</strong> Researchers found that tribespeople stayed longer in bed than inhabitants of industrialised regions.</p>
                    <div class="radio-options">
                        <label><input name="q3" type="radio" value="TRUE"> TRUE</label>
                        <label><input name="q3" type="radio" value="FALSE"> FALSE</label>
                        <label><input name="q3" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
                    </div>
                </div>
                <div class="question-item">
                    <p><strong>4</strong> Jerome Siegel believes that environment and culture have little effect on sleep patterns.</p>
                    <div class="radio-options">
                        <label><input name="q4" type="radio" value="TRUE"> TRUE</label>
                        <label><input name="q4" type="radio" value="FALSE"> FALSE</label>
                        <label><input name="q4" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
                    </div>
                </div>
            </div>
            
            <div class="group" id="q5-13-anchor">
                <h4>Questions 5–13</h4>
                <p>Complete the notes below.</p>
                <p>Choose <strong>ONE WORD ONLY</strong> from the passage for each answer.</p>
                
                <div class="notes-completion">
                    <h4>New Evidence on Sleep Patterns</h4>
                    
                    <h5>New ideas about napping</h5>
                    <ul>
                        <li>scientists have recorded an afternoon drop in <strong>5</strong> <input type="text" id="q5_input"></li>
                        <li>studies of hunter-gatherer societies show that napping was rare and occurred more often during the <strong>6</strong> <input type="text" id="q6_input"></li>
                        <li>the devices may not have detected <strong>7</strong> <input type="text" id="q7_input"> naps</li>
                    </ul>
                    
                    <h5>Daily activity cycles</h5>
                    <ul>
                        <li>the tribespeople went to sleep several hours after sunset</li>
                        <li>even with <strong>8</strong> <input type="text" id="q8_input"> there was little light</li>
                        <li>tribespeople usually woke up around <strong>9</strong> <input type="text" id="q9_input"></li>
                        <li>scientists found that <strong>10</strong> <input type="text" id="q10_input"> had almost as much influence on sleep patterns as light</li>
                    </ul>

                    <h5>Differences between tribespeople and people in industrialised regions</h5>
                    <ul>
                        <li><strong>11</strong> <input type="text" id="q11_input"> is something that very few of the tribespeople suffered from</li>
                        <li>the environment of tribespeople may have been more suitable for sleep</li>
                        <li>tribespeople had better fitness than industrialised populations and were not <strong>12</strong> <input type="text" id="q12_input"></li>
                        <li>tribespeople also had stronger <strong>13</strong> <input type="text" id="q13_input"></li>
                    </ul>
                </div>
            </div>
            
            <div id="results"></div>
        </section>
    </div>
    
    <div class="practice-nav">
        <div class="title">Questions</div>
        <div class="questions">
            <div class="q-item" id="q1-nav" onclick="scrollToElement('q1-4-anchor')">1</div>
            <div class="q-item" id="q2-nav" onclick="scrollToElement('q1-4-anchor')">2</div>
            <div class="q-item" id="q3-nav" onclick="scrollToElement('q1-4-anchor')">3</div>
            <div class="q-item" id="q4-nav" onclick="scrollToElement('q1-4-anchor')">4</div>
            <div class="q-item" id="q5-nav" onclick="scrollToElement('q5-13-anchor')">5</div>
            <div class="q-item" id="q6-nav" onclick="scrollToElement('q5-13-anchor')">6</div>
            <div class="q-item" id="q7-nav" onclick="scrollToElement('q5-13-anchor')">7</div>
            <div class="q-item" id="q8-nav" onclick="scrollToElement('q5-13-anchor')">8</div>
            <div class="q-item" id="q9-nav" onclick="scrollToElement('q5-13-anchor')">9</div>
            <div class="q-item" id="q10-nav" onclick="scrollToElement('q5-13-anchor')">10</div>
            <div class="q-item" id="q11-nav" onclick="scrollToElement('q5-13-anchor')">11</div>
            <div class="q-item" id="q12-nav" onclick="scrollToElement('q5-13-anchor')">12</div>
            <div class="q-item" id="q13-nav" onclick="scrollToElement('q5-13-anchor')">13</div>
        </div>
        <div class="controls">
            <button id="submit-btn" class="primary">Submit</button>
            <button id="reset-btn">Reset</button>
            <button id="pause-btn">Pause</button>
        </div>
    </div>

    <div aria-label="Selection tools" id="selbar" role="toolbar">
        <button id="btnHL">Highlight</button>
        <button id="btnUH">Remove</button>
        <button id="btnNote">Note</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Global State ---
            let settingsOpen = false, notesOpen = false;
            let timerRunning = true, seconds = 0, timer;
            let isResizing = false;
            let selbar = document.getElementById('selbar');
            let lastRange = null, currentHlNode = null, keepToolbar = false;
            
            const correctAnswers = {
                q1: 'TRUE', q2: 'NOT GIVEN', q3: 'NOT GIVEN', q4: 'TRUE', 
                q5: 'energy', q6: 'summer', q7: 'short', q8: 'fires', q9: 'sunrise', 
                q10: 'temperature', q11: 'sleeplessness', q12: 'overweight', q13: 'hearts'
            };

            // --- Core Functions ---
            function startTimer() {
                timer = setInterval(() => {
                    if (timerRunning) {
                        seconds++;
                        const minutes = String(Math.floor(seconds / 60)).padStart(2, '0');
                        const secs = String(seconds % 60).padStart(2, '0');
                        document.getElementById('timer').textContent = `${minutes}:${secs}`;
                    }
                }, 1000);
            }

            function closeAllPanels() {
                notesOpen = false; settingsOpen = false;
                document.getElementById('notes-panel').style.display = 'none';
                document.getElementById('settings-panel').style.display = 'none';
                document.querySelector('.overlay').style.display = 'none';
            }

            window.scrollToElement = function(id) {
                const element = document.getElementById(id);
                const pane = element.closest('.pane');
                if (element && pane) {
                    const top = element.offsetTop - 20;
                    pane.scrollTo({ top, behavior: 'smooth' });
                }
            }
            
            // --- Grading and State Update ---
            function updateAnsweredState() {
                for (let i = 1; i <= 13; i++) {
                    const navItem = document.getElementById(`q${i}-nav`);
                    if (navItem.classList.contains('correct') || navItem.classList.contains('incorrect')) continue;

                    let answered = false;
                    if (i <= 4) {
                        answered = !!document.querySelector(`input[name="q${i}"]:checked`);
                    } else {
                        answered = document.getElementById(`q${i}_input`).value.trim() !== "";
                    }
                    navItem.classList.toggle('answered', answered);
                }
            }
            
            function gradeAnswers() {
                timerRunning = false;
                document.getElementById('pause-btn').textContent = 'Continue';
                let correctCount = 0;
                const totalQuestions = 13;
                let resultsHTML = '<h4>Results</h4><table class="results-table"><thead><tr><th>Question</th><th>Your Answer</th><th>Correct Answer</th><th>Result</th></tr></thead><tbody>';

                for (let i = 1; i <= 13; i++) {
                    let userAnswer, isCorrect;
                    const correctAnswer = correctAnswers[`q${i}`];
                    const navItem = document.getElementById(`q${i}-nav`);

                    if (i <= 4) {
                        const userAnswerEl = document.querySelector(`input[name="q${i}"]:checked`);
                        userAnswer = userAnswerEl ? userAnswerEl.value : 'No Answer';
                    } else {
                        const input = document.getElementById(`q${i}_input`);
                        userAnswer = input.value.trim() || 'No Answer';
                    }

                    isCorrect = userAnswer.toLowerCase() === correctAnswer.toLowerCase();
                    if (isCorrect) correctCount++;
                    
                    navItem.classList.remove('answered');
                    navItem.classList.add(isCorrect ? 'correct' : 'incorrect');
                    resultsHTML += `<tr><td>${i}</td><td>${userAnswer}</td><td>${correctAnswer}</td><td class="${isCorrect ? 'result-correct' : 'result-incorrect'}">${isCorrect ? '✓' : '✗'}</td></tr>`;
                }
                
                const score = Math.round((correctCount / totalQuestions) * 100);
                const summary = `<div style="font-weight:bold; margin-top:16px; font-size:1.1em;">Final Score: ${score}% (${correctCount}/${totalQuestions})</div>`;
                resultsHTML += `</tbody></table>`;
                
                document.getElementById('results').innerHTML = summary + resultsHTML;
                document.getElementById('results').style.display = 'block';
                scrollToElement('results');
            }

            function resetQuiz() {
                document.querySelectorAll('input[type="radio"]').forEach(el => el.checked = false);
                document.querySelectorAll('input[type="text"]').forEach(el => el.value = '');
                document.querySelectorAll('.q-item').forEach(item => item.className = 'q-item');
                const resultsDiv = document.getElementById('results');
                resultsDiv.style.display = 'none';
                resultsDiv.innerHTML = '';
                
                seconds = 0;
                if (timer) clearInterval(timer);
                document.getElementById('timer').textContent = "00:00";
                startTimer();
                timerRunning = true;
                document.getElementById('pause-btn').textContent = 'Pause';
                updateAnsweredState();
            }

            // --- Highlighter & Selection Toolbar ---
            function positionSelbarForRect(rect) {
                selbar.style.display = 'flex';
                requestAnimationFrame(() => {
                    const top = window.scrollY + rect.top - selbar.offsetHeight - 8;
                    const left = window.scrollX + rect.left + rect.width / 2 - selbar.offsetWidth / 2;
                    selbar.style.top = `${(top > 0) ? top : (window.scrollY + rect.bottom + 8)}px`;
                    selbar.style.left = `${Math.max(8, left)}px`;
                });
            }

            function updateSelbar() {
                const sel = window.getSelection();
                if (!sel || sel.rangeCount === 0 || sel.isCollapsed) {
                    if (!keepToolbar && !currentHlNode) { selbar.style.display = 'none'; currentHlNode = null; }
                    return;
                }
                const range = sel.getRangeAt(0);
                let container = range.commonAncestorContainer;
                if (container.nodeType === Node.TEXT_NODE) container = container.parentElement;
                
                const isInLeftPane = document.getElementById('left').contains(container);
                const isInRightPane = document.getElementById('right').contains(container);
                const isHighlighted = container.classList?.contains('hl') || container.closest('.hl');
                
                if ((!isInLeftPane && !isInRightPane) && !isHighlighted) {
                    selbar.style.display = 'none'; 
                    return; 
                }
                
                lastRange = range.cloneRange();
                currentHlNode = isHighlighted ? container.closest('.hl') : null;
                positionSelbarForRect(range.getBoundingClientRect());
            }

            function doHighlight() {
                if (currentHlNode || !lastRange || lastRange.collapsed) return;
                const sel = window.getSelection();
                try {
                    const span = document.createElement('span');
                    span.className = 'hl';
                    lastRange.surroundContents(span);
                } catch (e) { console.error("Highlighting failed:", e); }
                sel?.removeAllRanges();
                selbar.style.display = 'none';
            }

            function removeHighlight() {
                const sel = window.getSelection();
                let targetNode = currentHlNode;
                if (!targetNode && lastRange) {
                    const ancestor = lastRange.commonAncestorContainer;
                    targetNode = ancestor.nodeType === Node.TEXT_NODE ? ancestor.parentElement.closest('.hl') : ancestor.closest('.hl');
                }
                if (targetNode) {
                    const p = targetNode.parentNode;
                    while (targetNode.firstChild) p.insertBefore(targetNode.firstChild, targetNode);
                    if(p) p.removeChild(targetNode);
                    p?.normalize();
                }
                currentHlNode = null; sel?.removeAllRanges(); selbar.style.display = 'none';
            }

            // --- Event Listeners Setup ---
            startTimer();

            // Header controls
            document.getElementById('size-btn').addEventListener('click', (e) => { e.stopPropagation(); settingsOpen = !settingsOpen; document.getElementById('settings-panel').style.display = settingsOpen ? 'block' : 'none'; });
            document.getElementById('color-btn').addEventListener('click', (e) => { e.stopPropagation(); settingsOpen = !settingsOpen; document.getElementById('settings-panel').style.display = settingsOpen ? 'block' : 'none'; });
            document.getElementById('note-btn').addEventListener('click', () => { closeAllPanels(); notesOpen = true; document.getElementById('notes-panel').style.display = 'flex'; document.querySelector('.overlay').style.display = 'block'; });
            document.querySelectorAll('.settings-option[data-size]').forEach(btn => btn.addEventListener('click', function() { document.documentElement.className = `font-${this.dataset.size}`; document.querySelectorAll('.settings-option[data-size]').forEach(b => b.classList.remove('active')); this.classList.add('active'); }));
            document.querySelectorAll('.settings-option[data-mode]').forEach(btn => btn.addEventListener('click', function() { document.body.classList.toggle('dark-mode', this.dataset.mode === 'dark'); document.querySelectorAll('.settings-option[data-mode]').forEach(b => b.classList.remove('active')); this.classList.add('active'); }));
            document.getElementById('close-note').addEventListener('click', closeAllPanels);
            document.querySelector('.overlay').addEventListener('click', closeAllPanels);
            document.addEventListener('click', (e) => {
                const settingsPanel = document.getElementById('settings-panel');
                const headerControls = document.querySelector('.header-controls');
                if (settingsOpen && !settingsPanel.contains(e.target) && !headerControls.contains(e.target)) { settingsPanel.style.display = 'none'; settingsOpen = false; }
            });

            // Bottom nav controls
            document.getElementById('submit-btn').addEventListener('click', gradeAnswers);
            document.getElementById('reset-btn').addEventListener('click', resetQuiz);
            document.getElementById('pause-btn').addEventListener('click', function() { timerRunning = !timerRunning; this.textContent = timerRunning ? 'Pause' : 'Continue'; });

            // Pane resizing
            const divider = document.getElementById('divider');
            const leftPane = document.getElementById('left');
            divider.addEventListener('mousedown', (e) => { isResizing = true; document.body.style.cursor = 'ew-resize'; e.preventDefault(); });
            document.addEventListener('mousemove', (e) => { if (!isResizing) return; const shellRect = document.querySelector('.shell').getBoundingClientRect(); let leftWidth = (e.clientX - shellRect.left) / shellRect.width * 100; leftPane.style.width = `${Math.max(20, Math.min(80, leftWidth))}%`; });
            document.addEventListener('mouseup', () => { if (isResizing) { isResizing = false; document.body.style.cursor = ''; } });
            
            // Update answered state on input
            document.getElementById('right').addEventListener('change', updateAnsweredState);
            document.getElementById('right').addEventListener('input', updateAnsweredState);

            // Selection toolbar events
            document.addEventListener('mouseup', () => setTimeout(updateSelbar, 10));
            document.addEventListener('selectionchange', () => setTimeout(updateSelbar, 10));
            document.addEventListener('mousedown', (e) => { keepToolbar = !!e.target.closest('#selbar, .hl'); }, true);
            document.addEventListener('click', (e) => {
                const target = e.target;
                if (target.classList.contains('hl')) {
                    currentHlNode = target; lastRange = null; positionSelbarForRect(target.getBoundingClientRect());
                    window.getSelection()?.removeAllRanges(); setTimeout(() => { keepToolbar = false; }, 0);
                } else if (!selbar.contains(e.target)) { selbar.style.display = 'none'; currentHlNode = null; }
            }, true);
            document.getElementById('btnHL').addEventListener('click', doHighlight);
            document.getElementById('btnUH').addEventListener('click', removeHighlight);
            document.getElementById('btnNote').addEventListener('click', function() {
                let text = (currentHlNode ? currentHlNode.textContent : (lastRange ? lastRange.cloneContents().textContent : '')).trim();
                if (text) {
                    const noteArea = document.querySelector('#notes-panel textarea');
                    noteArea.value += (noteArea.value ? '\n\n' : '') + '> ' + text;
                    closeAllPanels(); notesOpen = true; document.getElementById('notes-panel').style.display = 'flex';
                    document.querySelector('.overlay').style.display = 'block'; noteArea.scrollTop = noteArea.scrollHeight;
                }
                selbar.style.display = 'none';
            });
        });
    </script>
</body>
</html>