<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>P2 – Biomimicry</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<style>
  :root { --line:#e5e7eb; --bg:#f6f7fb; --panel:#fff; --accent:#3b82f6; --muted:#6b7280; --shadow:0 6px 20px rgba(0,0,0,.12); }
  * { box-sizing: border-box; }
  html,body { height:100%; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); }
  #timer { position: static; display: inline-block; margin-left: 8px; background:#fff; border:1px solid var(--line); border-radius:10px; padding:2px 8px; font-size:14px; vertical-align: middle; }
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:var(--panel); overflow:auto; padding:20px; }
  #left { flex: 0 0 50%; min-width: 280px; }
  #right { flex: 1 1 auto; min-width: 320px; background:#fbfbff; border-left:1px solid var(--line); }
  #divider { flex: 0 0 8px; background: linear-gradient(90deg,#e5e7eb,#d1d5db); cursor: ew-resize; position:relative; z-index: 5; user-select:none; }
  h2,h3,h4 { margin:0 0 10px; }
  #left p { margin: 0 0 12px; line-height: 1.6; word-break: normal; overflow-wrap: normal; hyphens: none; }
  .group { background:#fff; border:1px solid var(--line); border-radius:10px; padding:12px; margin-bottom:14px; }
  table { border-collapse: collapse; width:100%; }
  th, td { border:1px solid var(--line); padding:6px; text-align:center; font-size:14px; }
  th:first-child, td:first-child { width:92px; }
  button { padding:8px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; cursor:pointer; }
  button.primary { background:var(--accent); color:#fff; border-color:#3b82f6; }
  #results { background:#fff; border:1px solid var(--line); border-radius:10px; padding:10px; }
  .hl { background:#fff3a3; box-shadow: inset 0 -2px 0 rgba(0,0,0,.05); cursor: pointer; }
  .hl:hover { filter: brightness(0.98); }
  #selbar { position: absolute; display:none; z-index: 2000; background:#111; color:#fff; border-radius: 8px; padding: 6px; box-shadow: var(--shadow); font-size: 13px; gap:6px; align-items: center; }
  #selbar button { background: transparent; color:#fff; border: 1px solid rgba(255,255,255,.25); padding: 4px 8px; border-radius: 6px; cursor:pointer; }
  #selbar button:hover { border-color:#fff; }
  #notes { position: fixed; right: 12px; bottom: 12px; width: 320px; height: 42vh; background:#fff; border:1px solid var(--line); border-radius: 12px; display:none; flex-direction: column; z-index:1500; box-shadow: var(--shadow); }
  #notes header { display:flex; align-items:center; justify-content: space-between; padding:8px 10px; border-bottom:1px solid var(--line); }
  #notes textarea { flex:1; border:0; padding:10px; resize:none; font-size:14px; line-height:1.5; }
  #toast { position: fixed; left:50%; transform: translateX(-50%); bottom: 24px; background:#111; color:#fff; padding:8px 12px; border-radius: 8px; display:none; z-index:2500; }
  details.answerbox summary { cursor: pointer; user-select:none; list-style: none; }
  details.answerbox { border:1px dashed var(--line); border-radius:10px; padding:8px 10px; background:#fff; }
  .badge { display:inline-block; background:#eef2ff; color:#4338ca; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:6px; }
  body { padding-bottom: 82px; }
  .practice-nav { background:#fff; border-bottom:2px solid var(--line); padding:12px 20px; display:flex; align-items:center; gap:20px; box-shadow:0 2px 4px rgba(0,0,0,.05); flex-wrap:wrap; position:fixed; left:0; right:0; bottom:0; border-top:2px solid var(--line); border-bottom:0; z-index:4000; }
  .practice-nav .title { font-weight:600; color:var(--muted); }
  .practice-nav .questions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .practice-nav .q-item { padding:6px 10px; border:1px solid var(--line); border-radius:6px; background:#fff; cursor:pointer; font-size:14px; transition:all 0.2s; min-width:36px; text-align:center; }
  .practice-nav .q-item:hover { background:#f1f5f9; border-color:var(--accent); }
  .practice-nav .q-item.answered { background:#e0e7ff; border-color:var(--accent); color:var(--accent); font-weight:500; }
  .practice-nav .q-item.active { background:var(--accent); color:#fff; border-color:var(--accent); }
  #selbar { z-index: 6000 !important; }
</style>
</head>
<body>
<div class="practice-nav">
  <div class="title">Questions</div>
  <div class="questions">
    <div class="q-item" id="q14-nav" onclick="scrollToElement('q14-anchor')">14</div>
    <div class="q-item" id="q15-nav" onclick="scrollToElement('q15-anchor')">15</div>
    <div class="q-item" id="q16-nav" onclick="scrollToElement('q16-anchor')">16</div>
    <div class="q-item" id="q17-nav" onclick="scrollToElement('q17-anchor')">17</div>
    <div class="q-item" id="q18-nav" onclick="scrollToElement('q18-anchor')">18</div>
    <div class="q-item" id="q19-nav" onclick="scrollToElement('q19-anchor')">19</div>
    <div class="q-item" id="q20-nav" onclick="scrollToElement('q20-anchor')">20</div>
    <div class="q-item" id="q21-nav" onclick="scrollToElement('q21-anchor')">21</div>
    <div class="q-item" id="q22-nav" onclick="scrollToElement('q22-anchor')">22</div>
    <div class="q-item" id="q23-nav" onclick="scrollToElement('q23-anchor')">23</div>
    <div class="q-item" id="q24-nav" onclick="scrollToElement('q24-anchor')">24</div>
    <div class="q-item" id="q25-nav" onclick="scrollToElement('q25-anchor')">25</div>
    <div class="q-item" id="q26-nav" onclick="scrollToElement('q26-anchor')">26</div>
  </div>
</div>
<div class="shell">
<section class="pane" id="left">
  <h2>READING PASSAGE 2 <span id="timer">00:00</span></h2>
  <p>You should spend about 20 minutes on Questions 14–26, which are based on Reading Passage 2 below.</p>
  <h3>Biomimicry</h3>
  
  <h4>Paragraph A</h4>
  <p>Velcro, now commonly used instead of buttons and zippers, is probably the most famous example of ‘biomimicry’, where technologists turn to nature for inspiration. In 1948, scientist Georges de Mestral was walking through long grass when he noticed that dozens of seeds had attached themselves to his trousers. Under a microscope, de Mestral noted the hook-and-loop system the seed cases used to stick so firmly, and was inspired.</p>
  
  <h4>Paragraph B</h4>
  <p>US biologist Janine Benyus wrote a book on the subject called <em>Biomimicry: Innovation Inspired by Nature</em>. Published in 1997, the book set off the current wave of technology modelled on nature. According to Benyus, our ancestors were practised in the art of biomimicry. ‘I think it’s an old impulse for humans to take their cues from other organisms,’ she says, referring to African tribes that found edible plants by observing the dining habits of chimpanzees. But lately we’ve become more focused on what we can make ourselves. Benyus thinks our drift away from nature started with the advent of agriculture: ‘When we broke free from the challenges of hunting and gathering and learnt to stock our cupboards, we fooled ourselves into believing that we didn’t need other organisms at all,’ she says.</p>
  
  <h4>Paragraph C</h4>
  <p>The scientific, industrial, petrochemical and genetic engineering revolutions have repeatedly reinforced the idea that we are liberated from biological constraints. In recent years, however, the illusion that we are independent of nature has been shattered by the spectre of global warming and the looming end to fossil fuel supplies. Since few of us would be willing to forgo the products and services we’ve grown accustomed to – food, water, shelter, the conveniences that modern technology brings – the challenge is to meet the complex demands of civilisation within the bounds of sustainability. ‘Nature has learnt to fly, live in the depths of the ocean and craft miracle materials,’ writes Benyus. ‘Living creatures have done everything we want to do, without guzzling fossil fuel or polluting the planet. What better models could there be?’</p>
  
  <h4>Paragraph D</h4>
  <p>There are no better models, according to Tim Finnigan, a marine engineer at the University of Sydney. In his quest to harness the world’s waves and tides for renewable energy more efficiently, Finnigan has taken his cues from aquatic life. With their streamlined bodies and stiff, high tail fins, sharks convert up to 90 per cent of their body energy into forward thrust. Inspired by such efficient hydrodynamics, but turning the theory on its head, Finnigan designed his tidal stream generator: an 18-metre-long biomimetic shark tail with a fin spanning 15 metres. ‘Rather than have a body moving through a stationary fluid, we have fluid that’s moving past a stationary body,’ says Finnigan.</p>
  
  <h4>Paragraph E</h4>
  <p>Then there’s Finnigan’s biomimetic forest of giant seaweed. ‘As a diver I’ve looked at the way motions occur under water in the presence of waves,’ he says. ‘I see plants that move quite dramatically and yet they never seem to be pulled out, even in the most dramatic waves.’ The trouble with conventional designs, according to Finnigan, is that they’re made to stand rigidly against the power of the ocean. ‘The structures we try to build in the ocean just never end up being strong enough to survive out there,’ says Finnigan. In the manner of aquatic plants and animals, Finnigan’s designs respond to changing current or wave conditions by reorienting to maximise energy capture. And in severe weather, to avoid a battering, his wave energy generator will lie flat against the ocean floor.</p>
  
  <h4>Paragraph F</h4>
  <p>While conventional architects were designing buildings dependent on expensive air conditioning systems, when Mick Pearce tried to do the same, he struck a problem. ‘We were building office blocks for a client in Zimbabwe and we ran out of funds. So we looked for ways to make a building without traditional air conditioning.’ One day, driving through the grasslands, he saw a large mound created by termites, the ant-like insect common in Africa. He noticed that air entering at the base of the mound was mixed with water drawn from subterranean levels by the termites, causing evaporative cooling. Pearce wanted to reproduce this principle but he needed an alternative system, and in his building massive fans were employed at the base of the structure to lower the temperature of the circulating air. Pearce’s termite-inspired cooling system cut energy use to 10 per cent of a similar air-conditioned building.</p>
  
  <h4>Paragraph G</h4>
  <p>Photosynthesis is the process by which green plants use energy from the sun to convert water and carbon dioxide into carbohydrates and oxygen. Plants can manage it with humbling ease. But, as the 40 researchers from 11 institutes who have collaborated to form the Australian Artificial Photosynthesis Network have realised, it is very complex. However, there is one aspect working in our favour. In nature, environmental variables like temperature, carbon dioxide and light availability limit the rate of photosynthesis. In a laboratory these variables can be optimized. ‘We don’t have to cope with drought or frost. We can work with a highly controlled, specified set of conditions,’ says Tom Collings, the group’s spokesman.</p>
  
  <p>&nbsp;</p> <!-- 空白行防止加载不完全 -->
  <p>&nbsp;</p>
</section>
<div id="divider" title="Drag to resize"></div>
<section class="pane" id="right">
  <h3>Questions</h3>
  
  <div class="group">
    <h4>Questions 14–18</h4>
    <p>Reading Passage 2 has seven paragraphs, A–G.</p>
    <p>Which paragraph contains the following information?</p>
    <p>NB You may use any letter more than once.</p>
    <p>Write the correct letter, A–G, in boxes 14–18 on your answer sheet.</p>
    
    <a id="q14-anchor"></a>
    <div id="q14-section" style="padding:8px 0;border-top:1px dashed var(--line);">
      <p>14 a reference to a natural process that appears simpler than it actually is</p>
      <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
        <label style="margin:0;"><input name="q14" type="radio" value="A"> A</label>
        <label style="margin:0;"><input name="q14" type="radio" value="B"> B</label>
        <label style="margin:0;"><input name="q14" type="radio" value="C"> C</label>
        <label style="margin:0;"><input name="q14" type="radio" value="D"> D</label>
        <label style="margin:0;"><input name="q14" type="radio" value="E"> E</label>
        <label style="margin:0;"><input name="q14" type="radio" value="F"> F</label>
        <label style="margin:0;"><input name="q14" type="radio" value="G"> G</label>
      </div>
    </div>
    
    <a id="q15-anchor"></a>
    <div id="q15-section" style="padding:8px 0;border-top:1px dashed var(--line);">
      <p>15 a description of an invention that can protect itself under extreme conditions</p>
      <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
        <label style="margin:0;"><input name="q15" type="radio" value="A"> A</label>
        <label style="margin:0;"><input name="q15" type="radio" value="B"> B</label>
        <label style="margin:0;"><input name="q15" type="radio" value="C"> C</label>
        <label style="margin:0;"><input name="q15" type="radio" value="D"> D</label>
        <label style="margin:0;"><input name="q15" type="radio" value="E"> E</label>
        <label style="margin:0;"><input name="q15" type="radio" value="F"> F</label>
        <label style="margin:0;"><input name="q15" type="radio" value="G"> G</label>
      </div>
    </div>
    
    <a id="q16-anchor"></a>
    <div id="q16-section" style="padding:8px 0;border-top:1px dashed var(--line);">
      <p>16 the reasons why humans no longer feel they are free from nature</p>
      <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
        <label style="margin:0;"><input name="q16" type="radio" value="A"> A</label>
        <label style="margin:0;"><input name="q16" type="radio" value="B"> B</label>
        <label style="margin:0;"><input name="q16" type="radio" value="C"> C</label>
        <label style="margin:0;"><input name="q16" type="radio" value="D"> D</label>
        <label style="margin:0;"><input name="q16" type="radio" value="E"> E</label>
        <label style="margin:0;"><input name="q16" type="radio" value="F"> F</label>
        <label style="margin:0;"><input name="q16" type="radio" value="G"> G</label>
      </div>
    </div>
    
    <a id="q17-anchor"></a>
    <div id="q17-section" style="padding:8px 0;border-top:1px dashed var(--line);">
      <p>17 a reference to an animal that influenced the diet of some humans</p>
      <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
        <label style="margin:0;"><input name="q17" type="radio" value="A"> A</label>
        <label style="margin:0;"><input name="q17" type="radio" value="B"> B</label>
        <label style="margin:0;"><input name="q17" type="radio" value="C"> C</label>
        <label style="margin:0;"><input name="q17" type="radio" value="D"> D</label>
        <label style="margin:0;"><input name="q17" type="radio" value="E"> E</label>
        <label style="margin:0;"><input name="q17" type="radio" value="F"> F</label>
        <label style="margin:0;"><input name="q17" type="radio" value="G"> G</label>
      </div>
    </div>
    
    <a id="q18-anchor"></a>
    <div id="q18-section" style="padding:8px 0;border-top:1px dashed var(--line);">
      <p>18 specific reasons why science should copy nature</p>
      <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
        <label style="margin:0;"><input name="q18" type="radio" value="A"> A</label>
        <label style="margin:0;"><input name="q18" type="radio" value="B"> B</label>
        <label style="margin:0;"><input name="q18" type="radio" value="C"> C</label>
        <label style="margin:0;"><input name="q18" type="radio" value="D"> D</label>
        <label style="margin:0;"><input name="q18" type="radio" value="E"> E</label>
        <label style="margin:0;"><input name="q18" type="radio" value="F"> F</label>
        <label style="margin:0;"><input name="q18" type="radio" value="G"> G</label>
      </div>
    </div>
  </div>
  
  <div class="group">
    <h4>Questions 19–23</h4>
    <p>Look at the following statements (Questions 19–23) and the list of researchers below.</p>
    <p>Match each statement with the correct researcher, A–E.</p>
    <p>NB You may use any letter more than once.</p>
    <p>Write the correct letter, A–E, in boxes 19–23 on your answer sheet.</p>
    <p><strong>List of Researchers</strong></p>
    <ul>
      <li>A Georges de Mestral</li>
      <li>B Janine Benyus</li>
      <li>C Tim Finnigan</li>
      <li>D Mick Pearce</li>
      <li>E Tom Collings</li>
    </ul>
    
    <a id="q19-anchor"></a>
    <div id="q19-section" style="padding:8px 0;border-top:1px dashed var(--line);">
      <p>19 Designs often fail when they try to resist natural forces.</p>
      <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
        <label style="margin:0;"><input name="q19" type="radio" value="A"> A</label>
        <label style="margin:0;"><input name="q19" type="radio" value="B"> B</label>
        <label style="margin:0;"><input name="q19" type="radio" value="C"> C</label>
        <label style="margin:0;"><input name="q19" type="radio" value="D"> D</label>
        <label style="margin:0;"><input name="q19" type="radio" value="E"> E</label>
      </div>
    </div>
    
    <a id="q20-anchor"></a>
    <div id="q20-section" style="padding:8px 0;border-top:1px dashed var(--line);">
      <p>20 Science has certain key advantages over nature.</p>
      <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
        <label style="margin:0;"><input name="q20" type="radio" value="A"> A</label>
        <label style="margin:0;"><input name="q20" type="radio" value="B"> B</label>
        <label style="margin:0;"><input name="q20" type="radio" value="C"> C</label>
        <label style="margin:0;"><input name="q20" type="radio" value="D"> D</label>
        <label style="margin:0;"><input name="q20" type="radio" value="E"> E</label>
      </div>
    </div>
    
    <a id="q21-anchor"></a>
    <div id="q21-section" style="padding:8px 0;border-top:1px dashed var(--line);">
      <p>21 People have been copying nature for thousands of years.</p>
      <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
        <label style="margin:0;"><input name="q21" type="radio" value="A"> A</label>
        <label style="margin:0;"><input name="q21" type="radio" value="B"> B</label>
        <label style="margin:0;"><input name="q21" type="radio" value="C"> C</label>
        <label style="margin:0;"><input name="q21" type="radio" value="D"> D</label>
        <label style="margin:0;"><input name="q21" type="radio" value="E"> E</label>
      </div>
    </div>
    
    <a id="q22-anchor"></a>
    <div id="q22-section" style="padding:8px 0;border-top:1px dashed var(--line);">
      <p>22 A shortage of money can inspire innovative design.</p>
      <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
        <label style="margin:0;"><input name="q22" type="radio" value="A"> A</label>
        <label style="margin:0;"><input name="q22" type="radio" value="B"> B</label>
        <label style="margin:0;"><input name="q22" type="radio" value="C"> C</label>
        <label style="margin:0;"><input name="q22" type="radio" value="D"> D</label>
        <label style="margin:0;"><input name="q22" type="radio" value="E"> E</label>
      </div>
    </div>
    
    <a id="q23-anchor"></a>
    <div id="q23-section" style="padding:8px 0;border-top:1px dashed var(--line);">
      <p>23 The discovery that humans could produce food themselves caused them to turn away from nature.</p>
      <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
        <label style="margin:0;"><input name="q23" type="radio" value="A"> A</label>
        <label style="margin:0;"><input name="q23" type="radio" value="B"> B</label>
        <label style="margin:0;"><input name="q23" type="radio" value="C"> C</label>
        <label style="margin:0;"><input name="q23" type="radio" value="D"> D</label>
        <label style="margin:0;"><input name="q23" type="radio" value="E"> E</label>
      </div>
    </div>
  </div>
  
  <div class="group">
    <h4>Questions 24–26</h4>
    <p>Complete the summary below.</p>
    <p>Choose ONE WORD ONLY from the passage for each answer.</p>
    <p>Write your answers in boxes 24–26 on your answer sheet.</p>
    <p><strong>A building project in Zimbabwe</strong></p>
    <p>Mick Pearce designed a cooling system radically different from those usually used by architects. The design of his office block can be compared to that of a termite’s <a id="q24-anchor"></a><input type="text" name="q24" class="blank" style="width:100px; padding:4px; border:1px solid var(--line); border-radius:6px; margin:0 4px;">. Termites use <a id="q25-anchor"></a><input type="text" name="q25" class="blank" style="width:100px; padding:4px; border:1px solid var(--line); border-radius:6px; margin:0 4px;"> to cool the air, but in Pearce’s system this cooling effect was produced by <a id="q26-anchor"></a><input type="text" name="q26" class="blank" style="width:100px; padding:4px; border:1px solid var(--line); border-radius:6px; margin:0 4px;">.</p>
  </div>
  
  <div style="display:flex;gap:8px;margin-bottom:10px;">
    <button class="primary" onclick="grade()">Submit</button>
    <button onclick="resetForm()">Reset</button>
    <button onclick="toggleNotes()">Notes</button>
  </div>
  
  <div id="results"></div>
  
  <details class="answerbox" id="answerBox">
    <summary>Show answers (click to toggle) <span class="badge">hidden</span></summary>
    <div id="answerContent"></div>
  </details>
</section>
</div>
<div aria-label="Selection tools" id="selbar" role="toolbar">
  <button id="btnHL">Highlight</button>
  <button id="btnUH">Remove</button>
  <button id="btnNote">Note</button>
</div>
<div id="notes">
  <header>
    <strong>Notes</strong>
    <div>
      <button id="btnCopy">Copy</button>
      <button id="btnClose">Close</button>
    </div>
  </header>
  <textarea id="noteArea" placeholder="Type your notes here..."></textarea>
</div>
<div id="toast"></div>
<script>
// Timer
let _t=0; const _timerEl=document.getElementById('timer');
setInterval(function(){ 
  _t++; 
  var m=String(Math.floor(_t/60)).padStart(2,'0'); 
  var s=String(_t%60).padStart(2,'0'); 
  _timerEl.textContent=m+':'+s; 
},1000);
// Drag divider
var divider = document.getElementById('divider');
var left = document.getElementById('left');
var right = document.getElementById('right');
var dragging=false;
function startDrag(e){ 
  dragging=true; 
  document.body.style.cursor='ew-resize'; 
  if(e.preventDefault) e.preventDefault(); 
}
function endDrag(){ 
  dragging=false; 
  document.body.style.cursor=''; 
}
function onMove(clientX){
  var container = document.querySelector('.shell').getBoundingClientRect();
  var x = clientX - container.left;
  x = Math.max(280, Math.min(container.width-320, x));
  left.style.flex = '0 0 ' + x + 'px';
  right.style.flex = '1 1 auto';
}
divider.addEventListener('mousedown', function(e){ startDrag(e); });
window.addEventListener('mousemove', function(e){ if(dragging) onMove(e.clientX); });
window.addEventListener('mouseup', endDrag);
divider.addEventListener('touchstart', function(e){ startDrag(e.touches[0]); }, {passive:false});
window.addEventListener('touchmove', function(e){ if(dragging) onMove(e.touches[0].clientX); }, {passive:false});
window.addEventListener('touchend', endDrag);
// Highlight toolbar
var selbar = document.getElementById('selbar');
var btnHL = document.getElementById('btnHL');
var btnUH = document.getElementById('btnUH');
var btnNote = document.getElementById('btnNote');
var lastRange=null;
var currentHlNode=null;
var keepToolbar=false;
function positionSelbarForRect(rect){
  selbar.style.display='flex';
  requestAnimationFrame(function(){
    var top = window.scrollY + rect.top - selbar.offsetHeight - 8;
    var leftPos = window.scrollX + rect.left + rect.width/2 - selbar.offsetWidth/2;
    selbar.style.top = ((top>0)?top:(window.scrollY + rect.bottom + 8)) + 'px';
    selbar.style.left = Math.max(8, leftPos) + 'px';
  });
}
function updateSelbar(){
  var sel=window.getSelection();
  if(!sel || sel.rangeCount===0 || sel.isCollapsed) { 
    selbar.style.display='none'; 
    currentHlNode=null; 
    return; 
  }
  var range = sel.getRangeAt(0);
  lastRange = range.cloneRange();
  currentHlNode=null;
  positionSelbarForRect(range.getBoundingClientRect());
}
document.getElementById('left').addEventListener('mouseup', updateSelbar);
document.getElementById('right').addEventListener('mouseup', updateSelbar);
document.addEventListener('selectionchange', function(){ 
  var sel=window.getSelection(); 
  if(!sel || sel.rangeCount===0 || sel.isCollapsed){ 
    if(!keepToolbar && !currentHlNode){ 
      selbar.style.display='none'; 
    } 
  } 
});
document.addEventListener('scroll', function(){ 
  if(selbar.style.display==='flex') updateSelbar(); 
});
document.addEventListener('mousedown', function(e){
  var t = e.target;
  if(t.classList && t.classList.contains('hl')){
    keepToolbar = true;
  } else {
    keepToolbar = false;
  }
}, true);
document.addEventListener('click', function(e){
  var target = e.target;
  if(target.classList && target.classList.contains('hl')){
    currentHlNode = target;
    lastRange = null;
    positionSelbarForRect(target.getBoundingClientRect());
    var sel=window.getSelection();
    if(sel) sel.removeAllRanges();
    setTimeout(function(){ keepToolbar=false; }, 0);
  }
}, true);
function doHighlight(){
  if(currentHlNode) return;
  if(!lastRange || lastRange.collapsed) return;
  var span=document.createElement('span'); span.className='hl';
  try { lastRange.surroundContents(span); }
  catch(e){
    var wrap=document.createElement('span'); wrap.className='hl';
    wrap.appendChild(lastRange.cloneContents());
    lastRange.deleteContents();
    lastRange.insertNode(wrap);
  }
  selbar.style.display='none';
  showToast('Highlighted');
}
function removeHighlight(){
  if(currentHlNode){
    var p = currentHlNode.parentNode;
    while(currentHlNode.firstChild) p.insertBefore(currentHlNode.firstChild, currentHlNode);
    p.removeChild(currentHlNode); p.normalize();
    currentHlNode = null;
    selbar.style.display='none';
    showToast('Highlight removed');
    return;
  }
  if(!lastRange) return;
  var selRect = lastRange.getBoundingClientRect();
  var walker=document.createTreeWalker(document.body, NodeFilter.SHOW_ELEMENT);
  var toRemove=[];
  while(walker.nextNode()){
    var n=walker.currentNode;
    if(n.classList && n.classList.contains('hl')) {
      var r = n.getBoundingClientRect();
      if(!(r.right < selRect.left || r.left > selRect.right || r.bottom < selRect.top || r.top > selRect.bottom)) toRemove.push(n);
    }
  }
  toRemove.forEach(function(el){ var p=el.parentNode; while(el.firstChild) p.insertBefore(el.firstChild, el); p.removeChild(el); p.normalize(); });
  selbar.style.display='none';
  showToast('Highlight removed');
}
btnHL.addEventListener('click', doHighlight);
btnUH.addEventListener('click', removeHighlight);
// Notes
var notes = document.getElementById('notes');
var noteArea = document.getElementById('noteArea');
var btnCopy=document.getElementById('btnCopy');
var btnClose=document.getElementById('btnClose');
function toggleNotes(){ 
  notes.style.display = (notes.style.display==='flex'?'none':'flex'); 
}
window.toggleNotes = toggleNotes;
btnClose.addEventListener('click', toggleNotes);
btnCopy.addEventListener('click', async function(){ 
  await navigator.clipboard.writeText(noteArea.value||''); 
  showToast('Copied'); 
});
btnNote.addEventListener('click', function(){
  var text = '';
  if(currentHlNode){ text = (currentHlNode.textContent||'').trim(); }
  else if(lastRange){ var frag = lastRange.cloneContents(); text = (frag.textContent||'').trim(); }
  toggleNotes();
  if(text) noteArea.value = (noteArea.value? noteArea.value+'\n':'') + '> ' + text + '\n';
  selbar.style.display='none';
});
// Toast
var toastEl=document.getElementById('toast');
function showToast(msg){
  toastEl.textContent=msg; 
  toastEl.style.display='block';
  setTimeout(function(){ toastEl.style.display='none'; }, 1200);
}
// Answer key and grading
var answers = {
  "q14":"G", "q15":"E", "q16":"C", "q17":"B", "q18":"C",
  "q19":"C", "q20":"E", "q21":"B", "q22":"D", "q23":"B",
  "q24":"mound", "q25":"water", "q26":"fans"
};
function markBlank(q, user){
  var u = String(user||'').trim().toLowerCase();
  var key = String(answers[q]).trim().toLowerCase();
  return u === key;
}
function grade(){
  var total=0, correct=0, lines=[];
  function push(q, ok, user){
    total++; if(ok) correct++;
    lines.push(q.toUpperCase()+": "+(user||'None')+" "+(ok?'✓':'✗'));
  }
  // 14–18 paragraph matching
  for(var n=14;n<=18;n++){
    var sel=document.querySelector('input[name="q'+n+'"]:checked');
    var val=sel?sel.value:'';
    push('q'+n, val===answers['q'+n], val);
  }
  // 19–23 researcher matching
  for(var n=19;n<=23;n++){
    var sel=document.querySelector('input[name="q'+n+'"]:checked');
    var val=sel?sel.value:'';
    push('q'+n, val===answers['q'+n], val);
  }
  // 24–26 blank filling
  for(var n=24;n<=26;n++){
    var input=document.querySelector('input[name="q'+n+'"]');
    var val=input?input.value:'';
    push('q'+n, markBlank('q'+n, val), val);
  }
  var acc = (total? Math.round(100*correct/total):0);
  var html = '<p><strong>Score:</strong> '+correct+'/'+total+' <span class="badge">Accuracy '+acc+'%</span></p>';
  html += '<pre>'+lines.join('\n')+'</pre>';
  document.getElementById('results').innerHTML = html;
  var ahtml = '<ol>';
  ahtml += '<li>14 → G</li>';
  ahtml += '<li>15 → E</li>';
  ahtml += '<li>16 → C</li>';
  ahtml += '<li>17 → B</li>';
  ahtml += '<li>18 → C</li>';
  ahtml += '<li>19 → C (Tim Finnigan)</li>';
  ahtml += '<li>20 → E (Tom Collings)</li>';
  ahtml += '<li>21 → B (Janine Benyus)</li>';
  ahtml += '<li>22 → D (Mick Pearce)</li>';
  ahtml += '<li>23 → B (Janine Benyus)</li>';
  ahtml += '<li>24 → mound</li>';
  ahtml += '<li>25 → water</li>';
  ahtml += '<li>26 → fans</li>';
  ahtml += '</ol>';
  document.getElementById('answerContent').innerHTML = ahtml;
  document.querySelector('#answerBox .badge').textContent='tap to view';
}
function resetForm(){
  document.querySelectorAll('input[type="radio"]').forEach(el=>el.checked=false);
  document.querySelectorAll('input.blank').forEach(el=>el.value="");
  document.getElementById('results').innerHTML='';
  document.getElementById('answerContent').innerHTML='';
  document.querySelector('#answerBox .badge').textContent = 'hidden';
  document.querySelectorAll('.q-item').forEach(item => {
    item.classList.remove('answered');
  });
}
function scrollToElement(id){
  var el = document.getElementById(id);
  if(el){ 
    el.scrollIntoView({behavior:'smooth', block:'center'}); 
  }
  var navs = document.querySelectorAll('.practice-nav .q-item');
  navs.forEach(n => n.classList.remove('active'));
  var btn = document.getElementById(id.replace('-anchor','-nav'));
  if(btn){ 
    btn.classList.add('active'); 
    setTimeout(() => btn.classList.remove('active'), 800); 
  }
}
(function(){
  function mark(qn){
    var nav = document.getElementById('q'+qn+'-nav');
    if(!nav) return;
    var radios = document.querySelectorAll('input[name="q'+qn+'"]');
    var text = document.querySelector('input[name="q'+qn+'"].blank');
    var answered=false;
    if(radios.length){ radios.forEach(function(r){ if(r.checked) answered=true; }); }
    if(text){ answered = answered || (text.value && text.value.trim().length>0); }
    if(answered) nav.classList.add('answered'); else nav.classList.remove('answered');
  }
  for(var q=14;q<=26;q++){
    (function(n){
      var radios = document.querySelectorAll('input[name="q'+n+'"]');
      radios.forEach(function(r){ r.addEventListener('change', function(){ mark(n); }); });
      var text = document.querySelector('input[name="q'+n+'"].blank');
      if(text){ text.addEventListener('input', function(){ mark(n); }); }
    })(q);
  }
  for(var q=14;q<=26;q++){ mark(q); }
})();
</script>

<script>
// 检查是否已经有增强脚本
if (!window.practicePageEnhancer) {
    // 动态加载增强脚本
    const script = document.createElement('script');
    script.src = '../../../js/practice-page-enhancer.js';
    script.onload = function() {
        console.log('[PracticePageEnhancer] 外部脚本加载成功');
        if (window.practicePageEnhancer) {
            window.practicePageEnhancer.initialize();
        }
    };
    script.onerror = function() {
        console.log('[PracticePageEnhancer] 外部脚本加载失败，使用内联版本');
        loadInlineEnhancer();
    };
    document.head.appendChild(script);
    
    // 超时降级
    setTimeout(function() {
        if (!window.practicePageEnhancer) {
            console.log('[PracticePageEnhancer] 超时降级到内联版本');
            loadInlineEnhancer();
        }
    }, 2000);
}

// 内联增强器（降级方案）
function loadInlineEnhancer() {
    if (window.practicePageEnhancer) return;
    
    window.practicePageEnhancer = {
        initialize: function() {
            console.log('[InlineEnhancer] 内联增强器已初始化');
            this.setupCommunication();
            this.setupAnswerListeners();
            this.interceptSubmit();
        },
        
        setupCommunication: function() {
            this.parentWindow = window.opener || window.parent;
            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'INIT_SESSION') {
                    this.sessionId = event.data.data.sessionId;
                    this.sendMessage('SESSION_READY', {
                        pageType: this.detectPageType(),
                        url: window.location.href
                    });
                }
            });
        },
        
        detectPageType: function() {
            const title = document.title || '';
            if (title.includes('P1')) return 'P1';
            if (title.includes('P2')) return 'P2';
            if (title.includes('P3')) return 'P3';
            return 'unknown';
        },
        
        setupAnswerListeners: function() {
            this.answers = {};
            this.startTime = Date.now();
            
            document.addEventListener('change', (e) => {
                if (e.target.name && e.target.name.startsWith('q')) {
                    this.answers[e.target.name] = e.target.value;
                }
            });
        },
        
        interceptSubmit: function() {
            // 拦截grade函数
            if (typeof window.grade === 'function') {
                const originalGrade = window.grade;
                window.grade = () => {
                    const result = originalGrade();
                    setTimeout(() => this.handleSubmit(), 200);
                    return result;
                };
            }
            
            // 监听提交按钮
            document.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' && 
                    (e.target.textContent.includes('Submit') || 
                     e.target.textContent.includes('提交') ||
                     e.target.textContent.includes('完成') ||
                     e.target.textContent.includes('Check') ||
                     e.target.onclick && e.target.onclick.toString().includes('grade'))) {
                    setTimeout(() => this.handleSubmit(), 300);
                }
            });
        },
        
        handleSubmit: function() {
            const results = {
                sessionId: this.sessionId,
                startTime: this.startTime,
                endTime: Date.now(),
                duration: Math.round((Date.now() - this.startTime) / 1000),
                answers: this.answers,
                scoreInfo: this.extractScore(),
                pageType: this.detectPageType(),
                url: window.location.href
            };
            
            this.sendMessage('PRACTICE_COMPLETE', results);
        },
        
        extractScore: function() {
            const resultsEl = document.getElementById('results');
            if (!resultsEl) return null;
            
            const text = resultsEl.textContent || '';
            const scoreMatch = text.match(/Score:\s*(\d+)\/(\d+)/i);
            if (scoreMatch) {
                const correct = parseInt(scoreMatch[1]);
                const total = parseInt(scoreMatch[2]);
                return {
                    correct: correct,
                    total: total,
                    accuracy: total > 0 ? correct / total : 0,
                    percentage: Math.round((correct / total) * 100),
                    source: 'inline_extraction'
                };
            }
            return null;
        },
        
        sendMessage: function(type, data) {
            if (this.parentWindow) {
                this.parentWindow.postMessage({
                    type: type,
                    data: data,
                    source: 'practice_page'
                }, '*');
            }
        }
    };
    
    // 初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            window.practicePageEnhancer.initialize();
        });
    } else {
        window.practicePageEnhancer.initialize();
    }
}
</script></body>
</html>
