<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>P2 – The Importance of Law</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<style>
  :root { --line:#e5e7eb; --bg:#f6f7fb; --panel:#fff; --accent:#3b82f6; --muted:#6b7280; --shadow:0 6px 20px rgba(0,0,0,.12); }
  * { box-sizing: border-box; }
  html,body { height:100%; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); }
  #timer { position: static; display: inline-block; margin-left: 8px; background:#fff; border:1px solid var(--line); border-radius:10px; padding:2px 8px; font-size:14px; vertical-align: middle; }
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:var(--panel); overflow:auto; padding:20px; }
  #left { flex: 0 0 50%; min-width: 280px; }
  #right { flex: 1 1 auto; min-width: 320px; background:#fbfbff; border-left:1px solid var(--line); }
  #divider { flex: 0 0 8px; background: linear-gradient(90deg,#e5e7eb,#d1d5db); cursor: ew-resize; position:relative; z-index: 5; user-select:none; }
  h2,h3,h4 { margin:0 0 10px; }
  #left p { margin: 0 0 12px; line-height: 1.6; word-break: normal; overflow-wrap: normal; hyphens: none; }
  .group { background:#fff; border:1px solid var(--line); border-radius:10px; padding:12px; margin-bottom:14px; }
  table { border-collapse: collapse; width:100%; }
  th, td { border:1px solid var(--line); padding:6px; text-align:center; font-size:14px; }
  th:first-child, td:first-child { width:92px; }
  button { padding:8px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; cursor:pointer; }
  button.primary { background:var(--accent); color:#fff; border-color:#3b82f6; }
  #results { background:#fff; border:1px solid var(--line); border-radius:10px; padding:10px; }
  .hl { background:#fff3a3; box-shadow: inset 0 -2px 0 rgba(0,0,0,.05); cursor: pointer; }
  .hl:hover { filter: brightness(0.98); }
  #selbar { position: absolute; display:none; z-index: 2000; background:#111; color:#fff; border-radius: 8px; padding: 6px; box-shadow: var(--shadow); font-size: 13px; gap:6px; align-items: center; }
  #selbar button { background: transparent; color:#fff; border: 1px solid rgba(255,255,255,.25); padding: 4px 8px; border-radius: 6px; cursor:pointer; }
  #selbar button:hover { border-color:#fff; }
  #notes { position: fixed; right: 12px; bottom: 12px; width: 320px; height: 42vh; background:#fff; border:1px solid var(--line); border-radius: 12px; display:none; flex-direction: column; z-index:1500; box-shadow: var(--shadow); }
  #notes header { display:flex; align-items:center; justify-content: space-between; padding:8px 10px; border-bottom:1px solid var(--line); }
  #notes textarea { flex:1; border:0; padding:10px; resize:none; font-size:14px; line-height:1.5; }
  #toast { position: fixed; left:50%; transform: translateX(-50%); bottom: 24px; background:#111; color:#fff; padding:8px 12px; border-radius: 8px; display:none; z-index:2500; }
  .dropzone { border:2px dashed #cbd5e1; background:#f8fafc; border-radius:10px; min-height:40px; padding:4px 8px; display:inline-flex; align-items:center; justify-content:space-between; gap:8px; width: auto; min-width: 120px; max-width: 200px; vertical-align: middle; }
  .droplabel { color:#64748b; font-size:14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .cardpool { background:#f1f5f9; border-radius:10px; padding:12px; display:flex; flex-wrap:wrap; gap:8px; }
  .pool-slot { min-height:40px; }
  .card { background:#fff; border:1px solid #e5e7eb; border-radius:8px; padding:8px 10px; display:inline-flex; gap:8px; align-items:center; cursor:grab; box-shadow:0 1px 0 rgba(0,0,0,.03); white-space: nowrap; }
  .card:active { cursor:grabbing; }
  .tag { background:#eef2ff; color:#4338ca; padding:2px 8px; border-radius:999px; font-size:12px; }
  .btn-clear { border:1px solid #e5e7eb; background:#fff; border-radius:8px; padding:6px 8px; cursor:pointer; }
  .ghost { opacity: .5; }
  .over { outline:2px dashed #3b82f6; }
  details.answerbox summary { cursor: pointer; user-select:none; list-style: none; }
  details.answerbox { border:1px dashed var(--line); border-radius:10px; padding:8px 10px; background:#fff; }
  .badge { display:inline-block; background:#eef2ff; color:#4338ca; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:6px; }
  body { padding-bottom: 82px; }
  .practice-nav { background:#fff; border-bottom:2px solid var(--line); padding:12px 20px; display:flex; align-items:center; gap:20px; box-shadow:0 2px 4px rgba(0,0,0,.05); flex-wrap:wrap; position:fixed; left:0; right:0; bottom:0; border-top:2px solid var(--line); border-bottom:0; z-index:4000; }
  .practice-nav .title { font-weight:600; color:var(--muted); }
  .practice-nav .questions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .practice-nav .q-item { padding:6px 10px; border:1px solid var(--line); border-radius:6px; background:#fff; cursor:pointer; font-size:14px; transition:all 0.2s; min-width:36px; text-align:center; }
  .practice-nav .q-item:hover { background:#f1f5f9; border-color:var(--accent); }
  .practice-nav .q-item.answered { background:#e0e7ff; border-color:var(--accent); color:var(--accent); font-weight:500; }
  .practice-nav .q-item.active { background:var(--accent); color:#fff; border-color:var(--accent); }
  #selbar { z-index: 6000 !important; }
</style>
</head>
<body>
<div class="practice-nav">
  <div class="title">Questions</div>
  <div class="questions">
    <div class="q-item" id="q14-nav" onclick="scrollToElement('q14-anchor')">14</div>
    <div class="q-item" id="q15-nav" onclick="scrollToElement('q15-anchor')">15</div>
    <div class="q-item" id="q16-nav" onclick="scrollToElement('q16-anchor')">16</div>
    <div class="q-item" id="q17-nav" onclick="scrollToElement('q17-anchor')">17</div>
    <div class="q-item" id="q18-nav" onclick="scrollToElement('q18-anchor')">18</div>
    <div class="q-item" id="q19-nav" onclick="scrollToElement('q19-anchor')">19</div>
    <div class="q-item" id="q20-nav" onclick="scrollToElement('q20-anchor')">20</div>
    <div class="q-item" id="q21-nav" onclick="scrollToElement('q21-anchor')">21</div>
    <div class="q-item" id="q22-nav" onclick="scrollToElement('q22-anchor')">22</div>
    <div class="q-item" id="q23-nav" onclick="scrollToElement('q23-anchor')">23</div>
    <div class="q-item" id="q24-nav" onclick="scrollToElement('q24-anchor')">24</div>
    <div class="q-item" id="q25-nav" onclick="scrollToElement('q25-anchor')">25</div>
    <div class="q-item" id="q26-nav" onclick="scrollToElement('q26-anchor')">26</div>
  </div>
</div>
<div class="shell">
<section class="pane" id="left">
  <h2>READING PASSAGE 2 <span id="timer">00:00</span></h2>
  <p>You should spend about 20 minutes on Questions 14–26, which are based on Reading Passage 2 below.</p>
  <h3>The Importance of Law</h3>
  
  <h4>Paragraph A</h4>
  <p>The law influences all of us virtually all the time. It governs almost all aspects of our behaviour, and even what happens to us when we are no longer alive. It affects us from the embryo onwards. It governs the air we breathe, the food and drink we consume, our travel, family relationships, and our property. It applies at the bottom of the ocean and in space. Each time we examine a label on a food product, engage in work as an employee or employer, travel on the roads, go to school to learn or to teach, stay in a hotel, borrow a library book, create or dissolve a commercial company, play sports, or engage the services of someone for anything from plumbing a sink to planning a city, we are in the world of law.</p>
  
  <h4>Paragraph B</h4>
  <p>Law has also become much more widely recognised as the standard by which behaviour needs to be judged. A very telling development in recent history is the way in which the idea of law has permeated all parts of social life. The universal standard of whether something is socially tolerated is progressively becoming whether it is legal, rather than something that has always been considered acceptable. In earlier times, most people were illiterate. Today, by contrast, a vast number of people can read, and it is becoming easier for people to take an interest in law, and for the general population to help actually shape the law in many countries. However, law is a versatile instrument that can be used equally well for the improvement or the degradation of humanity.</p>
  
  <h4>Paragraph C</h4>
  <p>This, of course, puts law in a very significant position. In our rapidly developing world, all sorts of skills and knowledge are valuable. Those people, for example, with knowledge of computers, the internet, and communications technology are relied upon by the rest of us. There is now someone with IT skills or an IT help desk in every UK school, every company, every hospital, every local and central government office. Without their knowledge, many parts of commercial and social life today would seize up in minutes. But legal understanding is just as vital and as universally needed. The American comedian Jerry Seinfeld put it like this, ‘We are all throwing the dice, playing the game, moving our pieces around the board, but if there is a problem, the lawyer is the only person who has read the inside of the top of the box.’ In other words, the lawyer is the only person who has read and made sense of the rules.</p>
  
  <h4>Paragraph D</h4>
  <p>The number of laws has never been greater. In the UK alone, about 35 new Acts of Parliament are produced every year, thereby delivering thousands of new rules. The legislative output of the British Parliament has more than doubled in recent times from 1,100 pages a year in the early 1970s, to over 2,500 pages a year today. Between 1997 and 2006, the legislature passed 365 Acts of Parliament and more than 32,000 legally binding statutory instruments. In a system with so much law, lawyers do a great deal not just to vindicate the rights of citizens and organisations but also to help develop the law through legal arguments, some of which are adapted by judges to become laws. Law courts can and do produce new law and revise old law, but they do so having heard the arguments of lawyers.</p>
  
  <h4>Paragraph E</h4>
  <p>However, despite their important role in developing the rules, lawyers are not universally admired. Anti-lawyer jokes have a long history going back to the ancient Greeks. More recently, the son of a famous Hollywood actor was asked at his junior school what his father did for a living, to which he replied, ‘My daddy is a movie actor, and sometimes he plays the good guy, and sometimes, he plays the lawyer.’ For balance, though, it is worth remembering that there are and have been many heroic and revered lawyers such as the Roman philosopher and politician Cicero, and Mahatma Gandhi, the Indian campaigner for Independence.</p>
  
  <h4>Paragraph F</h4>
  <p>People sometimes make comments that characterise lawyers as professionals whose concerns put personal reward above truth, or who gain financially from misfortune. There are undoubtedly lawyers that would fit that bill, just as there are some scientists, journalists and others in that category. But, in general, it is no more just to say that lawyers are bad because they make a living from people’s problems than it is to make the same accusation in respect of nurses or IT consultants. A great many lawyers are involved in public law work, such as that involving civil liberties, housing and other issues. Such work is not lavishly remunerated and the quality of the service provided by these lawyers relies on considerable professional dedication. Moreover, much legal work has nothing to do with conflict or misfortune, but is primarily concerned with drafting documents. Another source of social disaffection for lawyers, and disaffection for the law, is a limited public understanding of how law works and how it could be changed. Greater clarity about these issues, maybe as a result of better public relations, would reduce many aspects of public dissatisfaction with the law.</p>
  
  <p>&nbsp;</p> <!-- 新增空白行防止加载不完全 -->
</section>
<div id="divider" title="Drag to resize"></div>
<section class="pane" id="right">
  <h3>Questions</h3>
  
  <div class="group">
    <h4>Questions 14–19</h4>
    <p>Reading Passage 2 has six paragraphs, A–F.</p>
    <p>Choose the correct heading for each paragraph from the list of headings below.</p>
    <p>Write the correct number, i–viii, in boxes 14–19 on your answer sheet.</p>
    <div class="headings">
      <p>List of Headings</p>
      <ol type="i">
        <li>Different areas of professional expertise</li>
        <li>Reasons why it is unfair to criticise lawyers</li>
        <li>The disadvantages of the legal system</li>
        <li>The law applies throughout our lives</li>
        <li>The law has affected historical events</li>
        <li>A negative regard for lawyers</li>
        <li>The public’s increasing ability to influence the law</li>
        <li>Growth in laws</li>
      </ol>
    </div>
    <table>
      <tr>
        <th>Paragraph</th>
        <th>i</th>
        <th>ii</th>
        <th>iii</th>
        <th>iv</th>
        <th>v</th>
        <th>vi</th>
        <th>vii</th>
        <th>viii</th>
      </tr>
      <a id="q14-anchor"></a>
      <tr id="q14-row">
        <td>A (14)</td>
        <td><label><input name="q14" type="radio" value="i"/></label></td>
        <td><label><input name="q14" type="radio" value="ii"/></label></td>
        <td><label><input name="q14" type="radio" value="iii"/></label></td>
        <td><label><input name="q14" type="radio" value="iv"/></label></td>
        <td><label><input name="q14" type="radio" value="v"/></label></td>
        <td><label><input name="q14" type="radio" value="vi"/></label></td>
        <td><label><input name="q14" type="radio" value="vii"/></label></td>
        <td><label><input name="q14" type="radio" value="viii"/></label></td>
      </tr>
      <a id="q15-anchor"></a>
      <tr id="q15-row">
        <td>B (15)</td>
        <td><label><input name="q15" type="radio" value="i"/></label></td>
        <td><label><input name="q15" type="radio" value="ii"/></label></td>
        <td><label><input name="q15" type="radio" value="iii"/></label></td>
        <td><label><input name="q15" type="radio" value="iv"/></label></td>
        <td><label><input name="q15" type="radio" value="v"/></label></td>
        <td><label><input name="q15" type="radio" value="vi"/></label></td>
        <td><label><input name="q15" type="radio" value="vii"/></label></td>
        <td><label><input name="q15" type="radio" value="viii"/></label></td>
      </tr>
      <a id="q16-anchor"></a>
      <tr id="q16-row">
        <td>C (16)</td>
        <td><label><input name="q16" type="radio" value="i"/></label></td>
        <td><label><input name="q16" type="radio" value="ii"/></label></td>
        <td><label><input name="q16" type="radio" value="iii"/></label></td>
        <td><label><input name="q16" type="radio" value="iv"/></label></td>
        <td><label><input name="q16" type="radio" value="v"/></label></td>
        <td><label><input name="q16" type="radio" value="vi"/></label></td>
        <td><label><input name="q16" type="radio" value="vii"/></label></td>
        <td><label><input name="q16" type="radio" value="viii"/></label></td>
      </tr>
      <a id="q17-anchor"></a>
      <tr id="q17-row">
        <td>D (17)</td>
        <td><label><input name="q17" type="radio" value="i"/></label></td>
        <td><label><input name="q17" type="radio" value="ii"/></label></td>
        <td><label><input name="q17" type="radio" value="iii"/></label></td>
        <td><label><input name="q17" type="radio" value="iv"/></label></td>
        <td><label><input name="q17" type="radio" value="v"/></label></td>
        <td><label><input name="q17" type="radio" value="vi"/></label></td>
        <td><label><input name="q17" type="radio" value="vii"/></label></td>
        <td><label><input name="q17" type="radio" value="viii"/></label></td>
      </tr>
      <a id="q18-anchor"></a>
      <tr id="q18-row">
        <td>E (18)</td>
        <td><label><input name="q18" type="radio" value="i"/></label></td>
        <td><label><input name="q18" type="radio" value="ii"/></label></td>
        <td><label><input name="q18" type="radio" value="iii"/></label></td>
        <td><label><input name="q18" type="radio" value="iv"/></label></td>
        <td><label><input name="q18" type="radio" value="v"/></label></td>
        <td><label><input name="q18" type="radio" value="vi"/></label></td>
        <td><label><input name="q18" type="radio" value="vii"/></label></td>
        <td><label><input name="q18" type="radio" value="viii"/></label></td>
      </tr>
      <a id="q19-anchor"></a>
      <tr id="q19-row">
        <td>F (19)</td>
        <td><label><input name="q19" type="radio" value="i"/></label></td>
        <td><label><input name="q19" type="radio" value="ii"/></label></td>
        <td><label><input name="q19" type="radio" value="iii"/></label></td>
        <td><label><input name="q19" type="radio" value="iv"/></label></td>
        <td><label><input name="q19" type="radio" value="v"/></label></td>
        <td><label><input name="q19" type="radio" value="vi"/></label></td>
        <td><label><input name="q19" type="radio" value="vii"/></label></td>
        <td><label><input name="q19" type="radio" value="viii"/></label></td>
      </tr>
    </table>
  </div>
  
  <div class="group">
    <a id="q20-anchor"></a>
    <h4>Questions 20–21</h4>
    <p>Choose TWO letters, A–E.</p>
    <p>Write the correct letters in boxes 20–21 on your answer sheet.</p>
    <p>Which TWO of the following statements does the writer make about legal skills in today’s world?</p>
    <div id="q20-21-section" style="padding:8px 0;border-top:1px dashed var(--line);">
      <label style="display:block;margin:4px 0;"><input name="q20-21" type="checkbox" value="A"/> A There should be a person with legal training in every hospital.</label>
      <label style="display:block;margin:4px 0;"><input name="q20-21" type="checkbox" value="B"/> B Lawyers with experience in commercial law are the most in demand.</label>
      <label style="display:block;margin:4px 0;"><input name="q20-21" type="checkbox" value="C"/> C Knowledge of the law is as important as having computer skills.</label>
      <label style="display:block;margin:4px 0;"><input name="q20-21" type="checkbox" value="D"/> D Society could not function effectively without legal experts.</label>
      <label style="display:block;margin:4px 0;"><input name="q20-21" type="checkbox" value="E"/> E Schools should teach students about the law.</label>
    </div>
  </div>
  
  <div class="group">
    <a id="q22-anchor"></a>
    <h4>Questions 22–26</h4>
    <p>Complete the summary below.</p>
    <p>Choose ONE WORD ONLY from passage for each answer.</p>
    <p>Write your answers in boxes 22–26 on your answer sheet.</p>
    <p>Lawyers as professionals</p>
    <p>People sometimes say that <input class="blank" maxlength="40" name="q22" placeholder="22"/> is of little interest to lawyers, who are more concerned with making money. This may well be the case with some individuals, in the same way that some <a id="q23-anchor"></a><input class="blank" maxlength="40" name="q23" placeholder="23"/> or scientific experts may also be driven purely by financial greed. However, criticising lawyers because their work is concerned with people’s problems would be similar to attacking IT staff or <a id="q24-anchor"></a><input class="blank" maxlength="40" name="q24" placeholder="24"/> for the same reason. In fact, many lawyers focus on questions relating, for example, to housing or civil liberties, which requires them to have <a id="q25-anchor"></a><input class="blank" maxlength="40" name="q25" placeholder="25"/> to their work. What’s more, a lot of lawyers’ time is spent writing <a id="q26-anchor"></a><input class="blank" maxlength="40" name="q26" placeholder="26"/> rather than dealing with people’s misfortunes.</p>
  </div>
  
  <div style="display:flex;gap:8px;margin-bottom:10px;">
    <button class="primary" onclick="grade()">Submit</button>
    <button onclick="resetForm()">Reset</button>
    <button onclick="toggleNotes()">Notes</button>
  </div>
  <div id="results"></div>
  <details class="answerbox" id="answerBox">
    <summary>Show answers (click to toggle) <span class="badge">hidden</span></summary>
    <div id="answerContent"></div>
  </details>
</section>
</div>
<div aria-label="Selection tools" id="selbar" role="toolbar">
  <button id="btnHL">Highlight</button>
  <button id="btnUH">Remove</button>
  <button id="btnNote">Note</button>
</div>
<div id="notes">
  <header>
    <strong>Notes</strong>
    <div>
      <button id="btnCopy">Copy</button>
      <button id="btnClose">Close</button>
    </div>
  </header>
  <textarea id="noteArea" placeholder="Type your notes here..."></textarea>
</div>
<div id="toast"></div>
<script>
// Timer
let _t=0; const _timerEl=document.getElementById('timer');
setInterval(function(){ 
  _t++; 
  var m=String(Math.floor(_t/60)).padStart(2,'0'); 
  var s=String(_t%60).padStart(2,'0'); 
  _timerEl.textContent=m+':'+s; 
},1000);
// Drag divider
var divider = document.getElementById('divider');
var left = document.getElementById('left');
var right = document.getElementById('right');
var dragging=false;
function startDrag(e){ 
  dragging=true; 
  document.body.style.cursor='ew-resize'; 
  if(e.preventDefault) e.preventDefault(); 
}
function endDrag(){ 
  dragging=false; 
  document.body.style.cursor=''; 
}
function onMove(clientX){
  var container = document.querySelector('.shell').getBoundingClientRect();
  var x = clientX - container.left;
  x = Math.max(280, Math.min(container.width-320, x));
  left.style.flex = '0 0 ' + x + 'px';
  right.style.flex = '1 1 auto';
}
divider.addEventListener('mousedown', function(e){ startDrag(e); });
window.addEventListener('mousemove', function(e){ if(dragging) onMove(e.clientX); });
window.addEventListener('mouseup', endDrag);
divider.addEventListener('touchstart', function(e){ startDrag(e.touches[0]); }, {passive:false});
window.addEventListener('touchmove', function(e){ if(dragging) onMove(e.touches[0].clientX); }, {passive:false});
window.addEventListener('touchend', endDrag);
// Highlight toolbar
var selbar = document.getElementById('selbar');
var btnHL = document.getElementById('btnHL');
var btnUH = document.getElementById('btnUH');
var btnNote = document.getElementById('btnNote');
var lastRange=null;
var currentHlNode=null;
var keepToolbar=false;
function positionSelbarForRect(rect){
  selbar.style.display='flex';
  requestAnimationFrame(function(){
    var top = window.scrollY + rect.top - selbar.offsetHeight - 8;
    var leftPos = window.scrollX + rect.left + rect.width/2 - selbar.offsetWidth/2;
    selbar.style.top = ((top>0)?top:(window.scrollY + rect.bottom + 8)) + 'px';
    selbar.style.left = Math.max(8, leftPos) + 'px';
  });
}
function updateSelbar(){
  var sel=window.getSelection();
  if(!sel || sel.rangeCount===0 || sel.isCollapsed) { 
    selbar.style.display='none'; 
    currentHlNode=null; 
    return; 
  }
  var range = sel.getRangeAt(0);
  lastRange = range.cloneRange();
  currentHlNode=null;
  positionSelbarForRect(range.getBoundingClientRect());
}
document.getElementById('left').addEventListener('mouseup', updateSelbar);
document.getElementById('right').addEventListener('mouseup', updateSelbar);
document.addEventListener('selectionchange', function(){ 
  var sel=window.getSelection(); 
  if(!sel || sel.rangeCount===0 || sel.isCollapsed){ 
    if(!keepToolbar && !currentHlNode){ 
      selbar.style.display='none'; 
    } 
  } 
});
document.addEventListener('scroll', function(){ 
  if(selbar.style.display==='flex') updateSelbar(); 
});
document.addEventListener('mousedown', function(e){
  var t = e.target;
  if(t.classList && t.classList.contains('hl')){
    keepToolbar = true;
  } else {
    keepToolbar = false;
  }
}, true);
document.addEventListener('click', function(e){
  var target = e.target;
  if(target.classList && target.classList.contains('hl')){
    currentHlNode = target;
    lastRange = null;
    positionSelbarForRect(target.getBoundingClientRect());
    var sel=window.getSelection();
    if(sel) sel.removeAllRanges();
    setTimeout(function(){ keepToolbar=false; }, 0);
  }
}, true);
function doHighlight(){
  if(currentHlNode) return;
  if(!lastRange || lastRange.collapsed) return;
  var span=document.createElement('span'); span.className='hl';
  try { lastRange.surroundContents(span); }
  catch(e){
    var wrap=document.createElement('span'); wrap.className='hl';
    wrap.appendChild(lastRange.cloneContents());
    lastRange.deleteContents();
    lastRange.insertNode(wrap);
  }
  selbar.style.display='none';
  showToast('Highlighted');
}
function removeHighlight(){
  if(currentHlNode){
    var p = currentHlNode.parentNode;
    while(currentHlNode.firstChild) p.insertBefore(currentHlNode.firstChild, currentHlNode);
    p.removeChild(currentHlNode); p.normalize();
    currentHlNode = null;
    selbar.style.display='none';
    showToast('Highlight removed');
    return;
  }
  if(!lastRange) return;
  var selRect = lastRange.getBoundingClientRect();
  var walker=document.createTreeWalker(document.body, NodeFilter.SHOW_ELEMENT);
  var toRemove=[];
  while(walker.nextNode()){
    var n=walker.currentNode;
    if(n.classList && n.classList.contains('hl')) {
      var r = n.getBoundingClientRect();
      if(!(r.right < selRect.left || r.left > selRect.right || r.bottom < selRect.top || r.top > selRect.bottom)) toRemove.push(n);
    }
  }
  toRemove.forEach(function(el){ var p=el.parentNode; while(el.firstChild) p.insertBefore(el.firstChild, el); p.removeChild(el); p.normalize(); });
  selbar.style.display='none';
  showToast('Highlight removed');
}
btnHL.addEventListener('click', doHighlight);
btnUH.addEventListener('click', removeHighlight);
// Notes
var notes = document.getElementById('notes');
var noteArea = document.getElementById('noteArea');
var btnCopy=document.getElementById('btnCopy');
var btnClose=document.getElementById('btnClose');
function toggleNotes(){ 
  notes.style.display = (notes.style.display==='flex'?'none':'flex'); 
}
window.toggleNotes = toggleNotes;
btnClose.addEventListener('click', toggleNotes);
btnCopy.addEventListener('click', async function(){ 
  await navigator.clipboard.writeText(noteArea.value||''); 
  showToast('Copied'); 
});
btnNote.addEventListener('click', function(){
  var text = '';
  if(currentHlNode){ text = (currentHlNode.textContent||'').trim(); }
  else if(lastRange){ var frag = lastRange.cloneContents(); text = (frag.textContent||'').trim(); }
  toggleNotes();
  if(text) noteArea.value = (noteArea.value? noteArea.value+'\n':'') + '> ' + text + '\n';
  selbar.style.display='none';
});
// Toast
var toastEl=document.getElementById('toast');
function showToast(msg){
  toastEl.textContent=msg; 
  toastEl.style.display='block';
  setTimeout(function(){ toastEl.style.display='none'; }, 1200);
}
// Answer key and grading
var answers = {
  "q14":"iv", "q15":"vii", "q16":"i", "q17":"viii", "q18":"vi", "q19":"ii",
  "q20-21":["C","D"],
  "q22":"truth", "q23":"journalists", "q24":"nurses", "q25":"dedication", "q26":"documents"
};
function grade(){
  var total=0, correct=0, lines=[];
  function push(q, ok, user){
    total++; if(ok) correct++;
    lines.push(q.toUpperCase()+": "+(user||'None')+" "+(ok?'✅':'❌'));
  }
  // 14–19 headings
  for(var n=14;n<=19;n++){
    var sel=document.querySelector('input[name="q'+n+'"]:checked');
    var val=sel?sel.value:'';
    push('q'+n, val === answers['q'+n], val);
  }
  // 20–21 multiple choice (checkbox)
  var checkboxes=document.querySelectorAll('input[name="q20-21"]:checked');
  var userChoices=Array.from(checkboxes).map(c=>c.value).sort();
  var correctChoices=answers["q20-21"].sort();
  var is2021Correct=JSON.stringify(userChoices)===JSON.stringify(correctChoices);
  push('q20-21', is2021Correct, userChoices.join(', '));
  total++; // 20-21算1题
  if(is2021Correct) correct++;

  // 22–26 blanks
  for(var n=22;n<=26;n++){
    var el=document.querySelector('input[name="q'+n+'"]');
    var val=el?el.value.trim().toLowerCase():'';
    var key=answers['q'+n].toLowerCase();
    push('q'+n, val === key, val);
  }

  var acc = (total? Math.round(100*correct/total):0);
  var html = '<p><strong>Score:</strong> '+correct+'/'+total+' <span class="badge">Accuracy '+acc+'%</span></p>';
  html += '<pre>'+lines.join('\n')+'</pre>';
  document.getElementById('results').innerHTML = html;
  
  var ahtml = '<ol>';
  ahtml += '<li>14 → iv (The law applies throughout our lives)</li>';
  ahtml += '<li>15 → vii (The public’s increasing ability to influence the law)</li>';
  ahtml += '<li>16 → i (Different areas of professional expertise)</li>';
  ahtml += '<li>17 → viii (Growth in laws)</li>';
  ahtml += '<li>18 → vi (A negative regard for lawyers)</li>';
  ahtml += '<li>19 → ii (Reasons why it is unfair to criticise lawyers)</li>';
  ahtml += '<li>20-21 → C, D (Knowledge of the law is as important as having computer skills; Society could not function effectively without legal experts)</li>';
  ahtml += '<li>22 → truth</li>';
  ahtml += '<li>23 → journalists</li>';
  ahtml += '<li>24 → nurses</li>';
  ahtml += '<li>25 → dedication</li>';
  ahtml += '<li>26 → documents</li>';
  ahtml += '</ol>';
  document.getElementById('answerContent').innerHTML = ahtml;
  document.querySelector('#answerBox .badge').textContent='tap to view';
}
function resetForm(){
  document.querySelectorAll('input[type="radio"]').forEach(el=>el.checked=false);
  document.querySelectorAll('input[type="checkbox"]').forEach(el=>el.checked=false);
  document.querySelectorAll('input.blank').forEach(el=>el.value="");
  document.getElementById('results').innerHTML='';
  document.getElementById('answerContent').innerHTML='';
  document.querySelector('#answerBox .badge').textContent = 'hidden';
  document.querySelectorAll('.q-item').forEach(item => {
    item.classList.remove('answered');
  });
}
function scrollToElement(id){
  var el = document.getElementById(id);
  if(el){ 
    el.scrollIntoView({behavior:'smooth', block:'center'}); 
  }
  var navs = document.querySelectorAll('.practice-nav .q-item');
  navs.forEach(n => n.classList.remove('active'));
  var btn = document.getElementById(id.replace('-anchor','-nav'));
  if(btn){ 
    btn.classList.add('active'); 
    setTimeout(() => btn.classList.remove('active'), 800); 
  }
}
(function(){
  function mark(qn){
    var nav = document.getElementById('q'+qn+'-nav');
    if(!nav) return;
    var answered=false;
    
    // 处理14-19单选题
    if(qn >=14 && qn <=19){
      var radios = document.querySelectorAll('input[name="q'+qn+'"]');
      radios.forEach(function(r){ if(r.checked) answered=true; });
    }
    // 处理20-21多选题
    else if(qn ===20 || qn ===21){
      var checkboxes=document.querySelectorAll('input[name="q20-21"]:checked');
      answered=checkboxes.length>0;
      document.getElementById('q20-nav').classList.toggle('answered', answered);
      document.getElementById('q21-nav').classList.toggle('answered', answered);
      return;
    }
    // 处理22-26填空题
    else if(qn >=22 && qn <=26){
      var el=document.querySelector('input[name="q'+qn+'"]');
      answered = el && el.value.trim().length>0;
    }
    
    if(answered) nav.classList.add('answered'); else nav.classList.remove('answered');
  }
  
  // 监听单选按钮
  for(var q=14;q<=19;q++){
    (function(n){
      var radios = document.querySelectorAll('input[name="q'+n+'"]');
      radios.forEach(function(r){ r.addEventListener('change', function(){ mark(n); }); });
    })(q);
  }
  
  // 监听多选按钮
  document.querySelectorAll('input[name="q20-21"]').forEach(cb=>{
    cb.addEventListener('change', function(){
      mark(20);
      mark(21);
    });
  });
  
  // 监听填空题
  for(var q=22;q<=26;q++){
    (function(n){
      var el=document.querySelector('input[name="q'+n+'"]');
      if(el) el.addEventListener('input', function(){ mark(n); });
    })(q);
  }
  
  // 初始化标记
  for(var q=14;q<=26;q++){
    mark(q);
  }
})();
</script>

<script>
// 检查是否已经有增强脚本
if (!window.practicePageEnhancer) {
    // 动态加载增强脚本
    const script = document.createElement('script');
    script.src = '../../../js/practice-page-enhancer.js';
    script.onload = function() {
        console.log('[PracticePageEnhancer] 外部脚本加载成功');
        if (window.practicePageEnhancer) {
            window.practicePageEnhancer.initialize();
        }
    };
    script.onerror = function() {
        console.log('[PracticePageEnhancer] 外部脚本加载失败，使用内联版本');
        loadInlineEnhancer();
    };
    document.head.appendChild(script);
    
    // 超时降级
    setTimeout(function() {
        if (!window.practicePageEnhancer) {
            console.log('[PracticePageEnhancer] 超时降级到内联版本');
            loadInlineEnhancer();
        }
    }, 2000);
}

// 内联增强器（降级方案）
function loadInlineEnhancer() {
    if (window.practicePageEnhancer) return;
    
    window.practicePageEnhancer = {
        initialize: function() {
            console.log('[InlineEnhancer] 内联增强器已初始化');
            this.setupCommunication();
            this.setupAnswerListeners();
            this.interceptSubmit();
        },
        
        setupCommunication: function() {
            this.parentWindow = window.opener || window.parent;
            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'INIT_SESSION') {
                    this.sessionId = event.data.data.sessionId;
                    this.sendMessage('SESSION_READY', {
                        pageType: this.detectPageType(),
                        url: window.location.href
                    });
                }
            });
        },
        
        detectPageType: function() {
            const title = document.title || '';
            if (title.includes('P1')) return 'P1';
            if (title.includes('P2')) return 'P2';
            if (title.includes('P3')) return 'P3';
            return 'unknown';
        },
        
        setupAnswerListeners: function() {
            this.answers = {};
            this.startTime = Date.now();
            
            document.addEventListener('change', (e) => {
                if (e.target.name && e.target.name.startsWith('q')) {
                    this.answers[e.target.name] = e.target.value;
                }
            });
        },
        
        interceptSubmit: function() {
            // 拦截grade函数
            if (typeof window.grade === 'function') {
                const originalGrade = window.grade;
                window.grade = () => {
                    const result = originalGrade();
                    setTimeout(() => this.handleSubmit(), 200);
                    return result;
                };
            }
            
            // 监听提交按钮
            document.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' && 
                    (e.target.textContent.includes('Submit') || 
                     e.target.textContent.includes('提交') ||
                     e.target.textContent.includes('完成') ||
                     e.target.textContent.includes('Check') ||
                     e.target.onclick && e.target.onclick.toString().includes('grade'))) {
                    setTimeout(() => this.handleSubmit(), 300);
                }
            });
        },
        
        handleSubmit: function() {
            const results = {
                sessionId: this.sessionId,
                startTime: this.startTime,
                endTime: Date.now(),
                duration: Math.round((Date.now() - this.startTime) / 1000),
                answers: this.answers,
                scoreInfo: this.extractScore(),
                pageType: this.detectPageType(),
                url: window.location.href
            };
            
            this.sendMessage('PRACTICE_COMPLETE', results);
        },
        
        extractScore: function() {
            const resultsEl = document.getElementById('results');
            if (!resultsEl) return null;
            
            const text = resultsEl.textContent || '';
            const scoreMatch = text.match(/Score:\s*(\d+)\/(\d+)/i);
            if (scoreMatch) {
                const correct = parseInt(scoreMatch[1]);
                const total = parseInt(scoreMatch[2]);
                return {
                    correct: correct,
                    total: total,
                    accuracy: total > 0 ? correct / total : 0,
                    percentage: Math.round((correct / total) * 100),
                    source: 'inline_extraction'
                };
            }
            return null;
        },
        
        sendMessage: function(type, data) {
            if (this.parentWindow) {
                this.parentWindow.postMessage({
                    type: type,
                    data: data,
                    source: 'practice_page'
                }, '*');
            }
        }
    };
    
    // 初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            window.practicePageEnhancer.initialize();
        });
    } else {
        window.practicePageEnhancer.initialize();
    }
}
</script></body>
</html>
