<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>How Well Do We Concentrate?</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<style>
  :root { --line:#e5e7eb; --bg:#f6f7fb; --panel:#fff; --accent:#3b82f6; --muted:#6b7280; --shadow:0 6px 20px rgba(0,0,0,.12); }
  * { box-sizing: border-box; }
  html,body { height:100%; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); }
  #timer { position: static; display: inline-block; margin-left: 8px; background:#fff; border:1px solid var(--line); border-radius:10px; padding:2px 8px; font-size:14px; vertical-align: middle; }
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:var(--panel); overflow:auto; padding:20px; }
  #left { flex: 0 0 50%; min-width: 280px; }
  #right { flex: 1 1 auto; min-width: 320px; background:#fbfbff; border-left:1px solid var(--line); }
  #divider { flex: 0 0 8px; background: linear-gradient(90deg,#e5e7eb,#d1d5db); cursor: ew-resize; position:relative; z-index: 5; user-select:none; }
  h2,h3,h4 { margin:0 0 10px; }
  #left p { margin: 0 0 12px; line-height: 1.6; word-break: normal; overflow-wrap: normal; hyphens: none; }
  .group { background:#fff; border:1px solid var(--line); border-radius:10px; padding:12px; margin-bottom:14px; }
  table { border-collapse: collapse; width:100%; }
  th, td { border:1px solid var(--line); padding:6px; text-align:center; font-size:14px; }
  th:first-child, td:first-child { width:92px; }
  button { padding:8px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; cursor:pointer; }
  button.primary { background:var(--accent); color:#fff; border-color:#3b82f6; }
  #results { background:#fff; border:1px solid var(--line); border-radius:10px; padding:10px; }
  .hl { background:#fff3a3; box-shadow: inset 0 -2px 0 rgba(0,0,0,.05); cursor: pointer; }
  .hl:hover { filter: brightness(0.98); }
  #selbar { position: absolute; display:none; z-index: 2000; background:#111; color:#fff; border-radius: 8px; padding: 6px; box-shadow: var(--shadow); font-size: 13px; gap:6px; align-items: center; }
  #selbar button { background: transparent; color:#fff; border: 1px solid rgba(255,255,255,.25); padding: 4px 8px; border-radius: 6px; cursor:pointer; }
  #selbar button:hover { border-color:#fff; }
  #notes { position: fixed; right: 12px; bottom: 12px; width: 320px; height: 42vh; background:#fff; border:1px solid var(--line); border-radius: 12px; display:none; flex-direction: column; z-index:1500; box-shadow: var(--shadow); }
  #notes header { display:flex; align-items:center; justify-content: space-between; padding:8px 10px; border-bottom:1px solid var(--line); }
  #notes textarea { flex:1; border:0; padding:10px; resize:none; font-size:14px; line-height:1.5; }
  #toast { position: fixed; left:50%; transform: translateX(-50%); bottom: 24px; background:#111; color:#fff; padding:8px 12px; border-radius: 8px; display:none; z-index:2500; }
  .dropzone { border:2px dashed #cbd5e1; background:#f8fafc; border-radius:10px; min-height:54px; padding:8px; display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .droplabel { color:#64748b; }
  .cardpool { background:#f1f5f9; border-radius:10px; padding:12px; display:grid; gap:8px; }
  .pool-slot { min-height:40px; }
  .card { background:#fff; border:1px solid #e5e7eb; border-radius:8px; padding:8px 10px; display:inline-flex; gap:8px; align-items:center; cursor:grab; box-shadow:0 1px 0 rgba(0,0,0,.03); }
  .card:active { cursor:grabbing; }
  .tag { background:#eef2ff; color:#4338ca; padding:2px 8px; border-radius:999px; font-size:12px; }
  .btn-clear { border:1px solid #e5e7eb; background:#fff; border-radius:8px; padding:6px 8px; cursor:pointer; }
  .ghost { opacity: .5; }
  .over { outline:2px dashed #3b82f6; }
  details.answerbox summary { cursor: pointer; user-select:none; list-style: none; }
  details.answerbox { border:1px dashed var(--line); border-radius:10px; padding:8px 10px; background:#fff; }
  .badge { display:inline-block; background:#eef2ff; color:#4338ca; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:6px; }
  body { padding-bottom: 82px; }
  .practice-nav { background:#fff; border-bottom:2px solid var(--line); padding:12px 20px; display:flex; align-items:center; gap:20px; box-shadow:0 2px 4px rgba(0,0,0,.05); flex-wrap:wrap; position:fixed; left:0; right:0; bottom:0; border-top:2px solid var(--line); border-bottom:0; z-index:4000; }
  .practice-nav .title { font-weight:600; color:var(--muted); }
  .practice-nav .questions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .practice-nav .q-item { padding:6px 10px; border:1px solid var(--line); border-radius:6px; background:#fff; cursor:pointer; font-size:14px; transition:all 0.2s; min-width:36px; text-align:center; }
  .practice-nav .q-item:hover { background:#f1f5f9; border-color:var(--accent); }
  .practice-nav .q-item.answered { background:#e0e7ff; border-color:var(--accent); color:var(--accent); font-weight:500; }
  .practice-nav .q-item.active { background:var(--accent); color:#fff; border-color:var(--accent); }
  #selbar { z-index: 6000 !important; }
</style>
</head>
<body>
<div class="practice-nav">
  <div class="title">Questions</div>
  <div class="questions">
    <div class="q-item" id="q14-nav" onclick="scrollToElement('q14-anchor')">14</div>
    <div class="q-item" id="q15-nav" onclick="scrollToElement('q15-anchor')">15</div>
    <div class="q-item" id="q16-nav" onclick="scrollToElement('q16-anchor')">16</div>
    <div class="q-item" id="q17-nav" onclick="scrollToElement('q17-anchor')">17</div>
    <div class="q-item" id="q18-nav" onclick="scrollToElement('q18-anchor')">18</div>
    <div class="q-item" id="q19-nav" onclick="scrollToElement('q19-anchor')">19</div>
    <div class="q-item" id="q20-nav" onclick="scrollToElement('q20-anchor')">20</div>
    <div class="q-item" id="q21-nav" onclick="scrollToElement('q21-anchor')">21</div>
    <div class="q-item" id="q22-nav" onclick="scrollToElement('q22-anchor')">22</div>
    <div class="q-item" id="q23-nav" onclick="scrollToElement('q23-anchor')">23</div>
    <div class="q-item" id="q24-nav" onclick="scrollToElement('q24-anchor')">24</div>
    <div class="q-item" id="q25-nav" onclick="scrollToElement('q25-anchor')">25</div>
    <div class="q-item" id="q26-nav" onclick="scrollToElement('q26-anchor')">26</div>
  </div>
</div>
<div class="shell">
<section class="pane" id="left">
  <h2>READING PASSAGE 2 <span id="timer">00:00</span></h2>
  <p>You should spend about 20 minutes on Questions 14–26, which are based on Reading Passage 2 below.</p>
  <h3>How Well Do We Concentrate?</h3>
  
  <h4>Paragraph A</h4>
  <p>Do you read while listening to music? Do you like to watch TV while finishing your homework? People who have these kinds of habits are called multitaskers. Multitaskers are able to complete two tasks at the same time by dividing their focus. However, Thomas Lehman, a researcher in psychology, believes people never really do multiple things simultaneously. Maybe a person is reading while listening to music, but in reality the brain can only focus on one task. Reading the words in a book will cause you to ignore some of the words of the music. When people think they are accomplishing two different tasks efficiently, what they are really doing is dividing their focus. While listening to music, people become less able to focus on their surroundings. For example, we all have experienced times when we talk with friends and they are not responding properly. Maybe they are listening to someone else talk, or maybe they are reading a text on their smartphone and don’t hear what you are saying. Lehman called this phenomenon “email voice.”</p>
  
  <h4>Paragraph B</h4>
  <p>The world has been changed by computers and their spin-offs such as smartphones or cellphones. Now that most individuals have a personal device, like a smartphone or a laptop, they are frequently reading, watching or listening to virtual information. This increases the occurrence of multitasking in our day-to-day life. Nowadays, when you work, you may use your typewriter, your cellphone, and speak with colleagues who may drop by at any time. In professional meetings, when one would normally focus on and listen to one another, people are more likely to have a cellphone in their lap, reading or communicating silently with more people than ever. Even inventions such as the cordless phone have increased multitasking. In the old days, a traditional wall phone would ring, and the housewife would have to stop her activities to answer it. When it rang, the housewife would sit down with her legs up and chat, with no laundry, sweeping or answering the door. In the modern era, our technology is convenient enough not to interrupt our daily tasks.</p>
  
  <h4>Paragraph C</h4>
  <p>Earl Miller, an expert at the Massachusetts Institute of Technology, studied the prefrontal cortex, which guides the brain while a person is multitasking. According to his studies, the size of this cortex varies between species. He found that for humans, it constitutes one-third of the brain, whereas it is only 4 – 5 percent in dogs and about 15 percent in monkeys. Because this cortex is larger in humans, it allows a person to be more flexible and accurate in multitasking. However, Miller wanted to know whether the cortex was truly processing information about two different tasks simultaneously. He designed an experiment in which he presented visual stimuli to his subjects in a way that mimicked multitasking. Miller then attached sensors to the patients’ heads to pick up the electrical patterns of the brain. These sensors would show whether the neurons were truly processing two different tasks. What he found was that the brain neurons lit up in singular areas one at a time-never simultaneously.</p>
  
  <h4>Paragraph D</h4>
  <p>David Meyer, a professor at the University of Michigan, studied young adults in a similar experiment. He instructed them to solve math problems while simultaneously classifying simple words into different categories. Meyer found that when you think you are doing several jobs at the same time, you are actually switching between jobs. Even though the participants tried to do the tasks at the same time and both tasks were eventually accomplished, overall the task took more time than if the person had focused on a single task.</p>
  
  <h4>Paragraph E</h4>
  <p>People sacrifice efficiency when multitasking. Gloria Mark used office workers as her subjects. She found that they were constantly multitasking. She observed that nearly every 11 minutes people at work were disrupted. She found that doing different jobs at the same time may actually save time. However, despite the fact that they are faster, it does not mean they are more efficient. We are equally likely to self-interrupt as to be interrupted by outside sources. She found that in the office nearly every 12 minutes an employee would stop and, with no reason at all, check a website on their computer, call someone or write an email. If they concentrated for more than 20 minutes, they would feel distressed. She suggested that the average person may suffer from a short concentration span. This short attention span might be natural, but others suggest that new technology may be the problem. With cellphones and computers at our sides at all times, people will never run out of distractions. The format of media-such as advertisements, music, news articles and TV shows-is also shortening, so people are used to paying attention to information for a very short time.</p>
  
  <h4>Paragraph F</h4>
  <p>Even though focusing on a single task is the most efficient way for our brains to work, it is not always practical in real life. According to human nature, people feel more comfortable and efficient in environments with a variety of tasks. Edward Hallowell said that people are losing a lot of efficiency in the workplace due to multitasking, outside distractions and self-distractions. In fact, the changes made to the workplace do not have to be dramatic. No one is suggesting we ban e-mail or make employees focus on only one task. However, certain common workplace situations-such as group meetings-would be more efficient if we banned cellphones, a common distraction. A person can also apply these tips to prevent selfdistraction. Instead of arriving at the office and checking all of your e-mails for new tasks-a common ritual-you could dedicate an hour to a single task first thing in the morning. Selftiming is a great way to reduce distraction and finish tasks one by one, instead of slowing ourselves down with multitasking.</p>
  
  <p>&nbsp;</p>
  <p>&nbsp;</p> <!-- 增加空白行防止加载不完全 -->
</section>
<div id="divider" title="Drag to resize"></div>
<section class="pane" id="right">
  <h3>Questions</h3>
  
  <div class="group">
    <h4>Questions 14–18</h4>
    <p>Reading Passage 2 has six paragraphs, A–F.</p>
    <p>Which paragraph contains the following information?</p>
    <p>Write the correct letter, A–F, in boxes 14–18 on your answer sheet.</p>
    
    <a id="q14-anchor"></a>
    <div id="q14-section" style="padding:8px 0;border-top:1px dashed var(--line);">
      <p>14 a reference to a domestic situation that does not require multitasking</p>
      <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
        <label style="margin:0;"><input name="q14" type="radio" value="A"> A</label>
        <label style="margin:0;"><input name="q14" type="radio" value="B"> B</label>
        <label style="margin:0;"><input name="q14" type="radio" value="C"> C</label>
        <label style="margin:0;"><input name="q14" type="radio" value="D"> D</label>
        <label style="margin:0;"><input name="q14" type="radio" value="E"> E</label>
        <label style="margin:0;"><input name="q14" type="radio" value="F"> F</label>
      </div>
    </div>
    
    <a id="q15-anchor"></a>
    <div id="q15-section" style="padding:8px 0;border-top:1px dashed var(--line);">
      <p>15 a possible explanation of why we always multitask</p>
      <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
        <label style="margin:0;"><input name="q15" type="radio" value="A"> A</label>
        <label style="margin:0;"><input name="q15" type="radio" value="B"> B</label>
        <label style="margin:0;"><input name="q15" type="radio" value="C"> C</label>
        <label style="margin:0;"><input name="q15" type="radio" value="D"> D</label>
        <label style="margin:0;"><input name="q15" type="radio" value="E"> E</label>
        <label style="margin:0;"><input name="q15" type="radio" value="F"> F</label>
      </div>
    </div>
    
    <a id="q16-anchor"></a>
    <div id="q16-section" style="padding:8px 0;border-top:1px dashed var(--line);">
      <p>16 a practical solution to multitasking in the work environment</p>
      <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
        <label style="margin:0;"><input name="q16" type="radio" value="A"> A</label>
        <label style="margin:0;"><input name="q16" type="radio" value="B"> B</label>
        <label style="margin:0;"><input name="q16" type="radio" value="C"> C</label>
        <label style="margin:0;"><input name="q16" type="radio" value="D"> D</label>
        <label style="margin:0;"><input name="q16" type="radio" value="E"> E</label>
        <label style="margin:0;"><input name="q16" type="radio" value="F"> F</label>
      </div>
    </div>
    
    <a id="q17-anchor"></a>
    <div id="q17-section" style="padding:8px 0;border-top:1px dashed var(--line);">
      <p>17 relating multitasking to the size of the prefrontal cortex</p>
      <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
        <label style="margin:0;"><input name="q17" type="radio" value="A"> A</label>
        <label style="margin:0;"><input name="q17" type="radio" value="B"> B</label>
        <label style="margin:0;"><input name="q17" type="radio" value="C"> C</label>
        <label style="margin:0;"><input name="q17" type="radio" value="D"> D</label>
        <label style="margin:0;"><input name="q17" type="radio" value="E"> E</label>
        <label style="margin:0;"><input name="q17" type="radio" value="F"> F</label>
      </div>
    </div>
    
    <a id="q18-anchor"></a>
    <div id="q18-section" style="padding:8px 0;border-top:1px dashed var(--line);">
      <p>18 more time spent doing two tasks at the same time than doing one task at a time</p>
      <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
        <label style="margin:0;"><input name="q18" type="radio" value="A"> A</label>
        <label style="margin:0;"><input name="q18" type="radio" value="B"> B</label>
        <label style="margin:0;"><input name="q18" type="radio" value="C"> C</label>
        <label style="margin:0;"><input name="q18" type="radio" value="D"> D</label>
        <label style="margin:0;"><input name="q18" type="radio" value="E"> E</label>
        <label style="margin:0;"><input name="q18" type="radio" value="F"> F</label>
      </div>
    </div>
  </div>
  
  <div class="group">
    <h4>Questions 19–23</h4>
    <p>Look at the following statements (Questions 19–23) and the list of scientists below.</p>
    <p>Match each statement with the correct scientist, A–E.</p>
    <p>Write the correct letter, A–E, in boxes 19–23 on your answer sheet.</p>
    <p>NB You may use any letter more than once.</p>
    
    <p><strong>List of Scientists</strong></p>
    <ul>
      <li>A Thomas Lehman</li>
      <li>B Earl Miller</li>
      <li>C David Meyer</li>
      <li>D Gloria Mark</li>
      <li>E Edward Hallowell</li>
    </ul>
    
    <a id="q19-anchor"></a>
    <div id="q19-section" style="padding:8px 0;border-top:1px dashed var(--line);">
      <p>19 When faced with multiple visual stimuli, one can only concentrate on one of them.</p>
      <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
        <label style="margin:0;"><input name="q19" type="radio" value="A"> A</label>
        <label style="margin:0;"><input name="q19" type="radio" value="B"> B</label>
        <label style="margin:0;"><input name="q19" type="radio" value="C"> C</label>
        <label style="margin:0;"><input name="q19" type="radio" value="D"> D</label>
        <label style="margin:0;"><input name="q19" type="radio" value="E"> E</label>
      </div>
    </div>
    
    <a id="q20-anchor"></a>
    <div id="q20-section" style="padding:8px 0;border-top:1px dashed var(--line);">
      <p>20 Doing two things together may be faster but not better.</p>
      <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
        <label style="margin:0;"><input name="q20" type="radio" value="A"> A</label>
        <label style="margin:0;"><input name="q20" type="radio" value="B"> B</label>
        <label style="margin:0;"><input name="q20" type="radio" value="C"> C</label>
        <label style="margin:0;"><input name="q20" type="radio" value="D"> D</label>
        <label style="margin:0;"><input name="q20" type="radio" value="E"> E</label>
      </div>
    </div>
    
    <a id="q21-anchor"></a>
    <div id="q21-section" style="padding:8px 0;border-top:1px dashed var(--line);">
      <p>21 People never really do two things together even if you think you do.</p>
      <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
        <label style="margin:0;"><input name="q21" type="radio" value="A"> A</label>
        <label style="margin:0;"><input name="q21" type="radio" value="B"> B</label>
        <label style="margin:0;"><input name="q21" type="radio" value="C"> C</label>
        <label style="margin:0;"><input name="q21" type="radio" value="D"> D</label>
        <label style="margin:0;"><input name="q21" type="radio" value="E"> E</label>
      </div>
    </div>
    
    <a id="q22-anchor"></a>
    <div id="q22-section" style="padding:8px 0;border-top:1px dashed var(--line);">
      <p>22 The causes of multitasking lie in the environment.</p>
      <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
        <label style="margin:0;"><input name="q22" type="radio" value="A"> A</label>
        <label style="margin:0;"><input name="q22" type="radio" value="B"> B</label>
        <label style="margin:0;"><input name="q22" type="radio" value="C"> C</label>
        <label style="margin:0;"><input name="q22" type="radio" value="D"> D</label>
        <label style="margin:0;"><input name="q22" type="radio" value="E"> E</label>
      </div>
    </div>
    
    <a id="q23-anchor"></a>
    <div id="q23-section" style="padding:8px 0;border-top:1px dashed var(--line);">
      <p>23 Even minor changes in the workplace will improve work efficiency.</p>
      <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
        <label style="margin:0;"><input name="q23" type="radio" value="A"> A</label>
        <label style="margin:0;"><input name="q23" type="radio" value="B"> B</label>
        <label style="margin:0;"><input name="q23" type="radio" value="C"> C</label>
        <label style="margin:0;"><input name="q23" type="radio" value="D"> D</label>
        <label style="margin:0;"><input name="q23" type="radio" value="E"> E</label>
      </div>
    </div>
  </div>
  
  <div class="group">
    <h4>Questions 24–26</h4>
    <p>Complete the sentences below.</p>
    <p>Choose NO MORE THAN TWO WORDS from the passage for each answer.</p>
    <p>Write your answers in boxes 24–26 on your answer sheet.</p>
    
    <a id="q24-anchor"></a>
    <div id="q24-section" style="padding:8px 0;border-top:1px dashed var(--line);">
      <p>24 A term used to refer to a situation when you are reading a text and cannot focus on your surroundings is ________.</p>
      <input class="blank" maxlength="40" name="q24" placeholder="Write your answer here">
    </div>
    
    <a id="q25-anchor"></a>
    <div id="q25-section" style="padding:8px 0;border-top:1px dashed var(--line);">
      <p>25 The ________ part of the brain controls multitasking.</p>
      <input class="blank" maxlength="40" name="q25" placeholder="Write your answer here">
    </div>
    
    <a id="q26-anchor"></a>
    <div id="q26-section" style="padding:8px 0;border-top:1px dashed var(--line);">
      <p>26 The practical solution to multitasking at work is not to allow the use of cellphones in ________.</p>
      <input class="blank" maxlength="40" name="q26" placeholder="Write your answer here">
    </div>
  </div>
  
  <div style="display:flex;gap:8px;margin-bottom:10px;">
    <button class="primary" onclick="grade()">Submit</button>
    <button onclick="resetForm()">Reset</button>
    <button onclick="toggleNotes()">Notes</button>
  </div>
  <div id="results"></div>
  <details class="answerbox" id="answerBox">
    <summary>Show answers (click to toggle) <span class="badge">hidden</span></summary>
    <div id="answerContent"></div>
  </details>
</section>
</div>
<div aria-label="Selection tools" id="selbar" role="toolbar">
  <button id="btnHL">Highlight</button>
  <button id="btnUH">Remove</button>
  <button id="btnNote">Note</button>
</div>
<div id="notes">
  <header>
    <strong>Notes</strong>
    <div>
      <button id="btnCopy">Copy</button>
      <button id="btnClose">Close</button>
    </div>
  </header>
  <textarea id="noteArea" placeholder="Type your notes here..."></textarea>
</div>
<div id="toast"></div>
<script>
// Timer
let _t=0; const _timerEl=document.getElementById('timer');
setInterval(function(){ 
  _t++; 
  var m=String(Math.floor(_t/60)).padStart(2,'0'); 
  var s=String(_t%60).padStart(2,'0'); 
  _timerEl.textContent=m+':'+s; 
},1000);
// Drag divider
var divider = document.getElementById('divider');
var left = document.getElementById('left');
var right = document.getElementById('right');
var dragging=false;
function startDrag(e){ 
  dragging=true; 
  document.body.style.cursor='ew-resize'; 
  if(e.preventDefault) e.preventDefault(); 
}
function endDrag(){ 
  dragging=false; 
  document.body.style.cursor=''; 
}
function onMove(clientX){
  var container = document.querySelector('.shell').getBoundingClientRect();
  var x = clientX - container.left;
  x = Math.max(280, Math.min(container.width-320, x));
  left.style.flex = '0 0 ' + x + 'px';
  right.style.flex = '1 1 auto';
}
divider.addEventListener('mousedown', function(e){ startDrag(e); });
window.addEventListener('mousemove', function(e){ if(dragging) onMove(e.clientX); });
window.addEventListener('mouseup', endDrag);
divider.addEventListener('touchstart', function(e){ startDrag(e.touches[0]); }, {passive:false});
window.addEventListener('touchmove', function(e){ if(dragging) onMove(e.touches[0].clientX); }, {passive:false});
window.addEventListener('touchend', endDrag);
// Highlight toolbar
var selbar = document.getElementById('selbar');
var btnHL = document.getElementById('btnHL');
var btnUH = document.getElementById('btnUH');
var btnNote = document.getElementById('btnNote');
var lastRange=null;
var currentHlNode=null;
var keepToolbar=false;
function positionSelbarForRect(rect){
  selbar.style.display='flex';
  requestAnimationFrame(function(){
    var top = window.scrollY + rect.top - selbar.offsetHeight - 8;
    var leftPos = window.scrollX + rect.left + rect.width/2 - selbar.offsetWidth/2;
    selbar.style.top = ((top>0)?top:(window.scrollY + rect.bottom + 8)) + 'px';
    selbar.style.left = Math.max(8, leftPos) + 'px';
  });
}
function updateSelbar(){
  var sel=window.getSelection();
  if(!sel || sel.rangeCount===0 || sel.isCollapsed) { 
    selbar.style.display='none'; 
    currentHlNode=null; 
    return; 
  }
  var range = sel.getRangeAt(0);
  lastRange = range.cloneRange();
  currentHlNode=null;
  positionSelbarForRect(range.getBoundingClientRect());
}
document.getElementById('left').addEventListener('mouseup', updateSelbar);
document.getElementById('right').addEventListener('mouseup', updateSelbar);
document.addEventListener('selectionchange', function(){ 
  var sel=window.getSelection(); 
  if(!sel || sel.rangeCount===0 || sel.isCollapsed){ 
    if(!keepToolbar && !currentHlNode){ 
      selbar.style.display='none'; 
    } 
  } 
});
document.addEventListener('scroll', function(){ 
  if(selbar.style.display==='flex') updateSelbar(); 
});
document.addEventListener('mousedown', function(e){
  var t = e.target;
  if(t.classList && t.classList.contains('hl')){
    keepToolbar = true;
  } else {
    keepToolbar = false;
  }
}, true);
document.addEventListener('click', function(e){
  var target = e.target;
  if(target.classList && target.classList.contains('hl')){
    currentHlNode = target;
    lastRange = null;
    positionSelbarForRect(target.getBoundingClientRect());
    var sel=window.getSelection();
    if(sel) sel.removeAllRanges();
    setTimeout(function(){ keepToolbar=false; }, 0);
  }
}, true);
function doHighlight(){
  if(currentHlNode) return;
  if(!lastRange || lastRange.collapsed) return;
  var span=document.createElement('span'); span.className='hl';
  try { lastRange.surroundContents(span); }
  catch(e){
    var wrap=document.createElement('span'); wrap.className='hl';
    wrap.appendChild(lastRange.cloneContents());
    lastRange.deleteContents();
    lastRange.insertNode(wrap);
  }
  selbar.style.display='none';
  showToast('Highlighted');
}
function removeHighlight(){
  if(currentHlNode){
    var p = currentHlNode.parentNode;
    while(currentHlNode.firstChild) p.insertBefore(currentHlNode.firstChild, currentHlNode);
    p.removeChild(currentHlNode); p.normalize();
    currentHlNode = null;
    selbar.style.display='none';
    showToast('Highlight removed');
    return;
  }
  if(!lastRange) return;
  var selRect = lastRange.getBoundingClientRect();
  var walker=document.createTreeWalker(document.body, NodeFilter.SHOW_ELEMENT);
  var toRemove=[];
  while(walker.nextNode()){
    var n=walker.currentNode;
    if(n.classList && n.classList.contains('hl')) {
      var r = n.getBoundingClientRect();
      if(!(r.right < selRect.left || r.left > selRect.right || r.bottom < selRect.top || r.top > selRect.bottom)) toRemove.push(n);
    }
  }
  toRemove.forEach(function(el){ var p=el.parentNode; while(el.firstChild) p.insertBefore(el.firstChild, el); p.removeChild(el); p.normalize(); });
  selbar.style.display='none';
  showToast('Highlight removed');
}
btnHL.addEventListener('click', doHighlight);
btnUH.addEventListener('click', removeHighlight);
// Notes
var notes = document.getElementById('notes');
var noteArea = document.getElementById('noteArea');
var btnCopy=document.getElementById('btnCopy');
var btnClose=document.getElementById('btnClose');
function toggleNotes(){ 
  notes.style.display = (notes.style.display==='flex'?'none':'flex'); 
}
window.toggleNotes = toggleNotes;
btnClose.addEventListener('click', toggleNotes);
btnCopy.addEventListener('click', async function(){ 
  await navigator.clipboard.writeText(noteArea.value||''); 
  showToast('Copied'); 
});
btnNote.addEventListener('click', function(){
  var text = '';
  if(currentHlNode){ text = (currentHlNode.textContent||'').trim(); }
  else if(lastRange){ var frag = lastRange.cloneContents(); text = (frag.textContent||'').trim(); }
  toggleNotes();
  if(text) noteArea.value = (noteArea.value? noteArea.value+'\n':'') + '> ' + text + '\n';
  selbar.style.display='none';
});
// Toast
var toastEl=document.getElementById('toast');
function showToast(msg){
  toastEl.textContent=msg; 
  toastEl.style.display='block';
  setTimeout(function(){ toastEl.style.display='none'; }, 1200);
}
// Answer key and grading
var answers = {
  "q14":"B", "q15":"E", "q16":"F", "q17":"C", "q18":"D",
  "q19":"B", "q20":"D", "q21":"A", "q22":"D", "q23":"E",
  "q24":"email voice", "q25":"prefrontal cortex", "q26":"group meetings"
};
var acceptable = {
  "q25": ["prefrontal cortex", "Prefrontal cortex"]
};
function markHeading(q, user){
  return String(user||'').toLowerCase() === String(answers[q]).toLowerCase();
}
function markChoice(q, user){
  return String(user||'').toUpperCase() === String(answers[q]).toUpperCase();
}
function markBlank(q, user){
  var u = String(user||'').trim().toLowerCase();
  var key = String(answers[q]).trim().toLowerCase();
  if(acceptable[q]){
    return acceptable[q].map(a => a.toLowerCase()).indexOf(u) >= 0;
  }
  return u === key;
}
function grade(){
  var total=0, correct=0, lines=[];
  function push(q, ok, user){
    total++; if(ok) correct++;
    lines.push(q.toUpperCase()+": "+(user||'None')+" "+(ok?'✓':'✗'));
  }
  // 14–18 paragraph matching
  for(var n=14;n<=18;n++){
    var sel=document.querySelector('input[name="q'+n+'"]:checked');
    var val=sel?sel.value:'';
    push('q'+n, markChoice('q'+n, val), val);
  }
  // 19–23 scientist matching
  for(var n=19;n<=23;n++){
    var sel=document.querySelector('input[name="q'+n+'"]:checked');
    var val=sel?sel.value:'';
    push('q'+n, markChoice('q'+n, val), val);
  }
  // 24–26 blanks
  for(var n=24;n<=26;n++){
    var el=document.querySelector('input[name="q'+n+'"]');
    var val=el?el.value:'';
    push('q'+n, markBlank('q'+n, val), val);
  }
  var acc = (total? Math.round(100*correct/total):0);
  var html = '<p><strong>Score:</strong> '+correct+'/'+total+' <span class="badge">Accuracy '+acc+'%</span></p>';
  html += '<pre>'+lines.join('\n')+'</pre>';
  document.getElementById('results').innerHTML = html;
  var ahtml = '<ol>';
  ahtml += '<li>14 → B</li>';
  ahtml += '<li>15 → E</li>';
  ahtml += '<li>16 → F</li>';
  ahtml += '<li>17 → C</li>';
  ahtml += '<li>18 → D</li>';
  ahtml += '<li>19 → B (Earl Miller)</li>';
  ahtml += '<li>20 → D (Gloria Mark)</li>';
  ahtml += '<li>21 → A (Thomas Lehman)</li>';
  ahtml += '<li>22 → D (Gloria Mark)</li>';
  ahtml += '<li>23 → E (Edward Hallowell)</li>';
  ahtml += '<li>24 → email voice</li>';
  ahtml += '<li>25 → prefrontal cortex</li>';
  ahtml += '<li>26 → group meetings</li>';
  ahtml += '</ol>';
  document.getElementById('answerContent').innerHTML = ahtml;
  document.querySelector('#answerBox .badge').textContent='tap to view';
}
function resetForm(){
  document.querySelectorAll('input[type="radio"]').forEach(el=>el.checked=false);
  document.querySelectorAll('input.blank').forEach(el=>el.value="");
  document.getElementById('results').innerHTML='';
  document.getElementById('answerContent').innerHTML='';
  document.querySelector('#answerBox .badge').textContent = 'hidden';
  document.querySelectorAll('.q-item').forEach(item => {
    item.classList.remove('answered');
  });
}
function scrollToElement(id){
  var el = document.getElementById(id);
  if(el){ 
    el.scrollIntoView({behavior:'smooth', block:'center'}); 
  }
  var navs = document.querySelectorAll('.practice-nav .q-item');
  navs.forEach(n => n.classList.remove('active'));
  var btn = document.getElementById(id.replace('-anchor','-nav'));
  if(btn){ 
    btn.classList.add('active'); 
    setTimeout(() => btn.classList.remove('active'), 800); 
  }
}
(function(){
  function mark(qn){
    var nav = document.getElementById('q'+qn+'-nav');
    if(!nav) return;
    var radios = document.querySelectorAll('input[name="q'+qn+'"]');
    var text = document.querySelector('input[name="q'+qn+'"].blank');
    var answered=false;
    if(radios.length){ radios.forEach(function(r){ if(r.checked) answered=true; }); }
    if(text){ answered = answered || (text.value && text.value.trim().length>0); }
    if(answered) nav.classList.add('answered'); else nav.classList.remove('answered');
  }
  for(var q=14;q<=26;q++){
    (function(n){
      var radios = document.querySelectorAll('input[name="q'+n+'"]');
      radios.forEach(function(r){ r.addEventListener('change', function(){ mark(n); }); });
      var text = document.querySelector('input[name="q'+n+'"].blank');
      if(text){ text.addEventListener('input', function(){ mark(n); }); }
    })(q);
  }
  for(var q=14;q<=26;q++){ mark(q); }
})();
</script>

<!-- 练习页面数据传输增强脚本 -->
<script>
// 检查是否已经有增强脚本
if (!window.practicePageEnhancer) {
    // 动态加载增强脚本
    const script = document.createElement('script');
    script.src = '../../js/practice-page-enhancer.js';
    script.onload = function() {
        console.log('练习页面增强脚本已加载');
    };
    script.onerror = function() {
        console.error('练习页面增强脚本加载失败');
        // 降级到内联增强
        loadInlineEnhancer();
    };
    document.head.appendChild(script);
}

// 内联增强器（降级方案）
function loadInlineEnhancer() {
    if (window.practicePageEnhancer) return;
    
    window.practicePageEnhancer = {
        initialize: function() {
            console.log('[InlineEnhancer] 内联增强器已初始化');
            this.setupCommunication();
            this.setupAnswerListeners();
            this.interceptSubmit();
        },
        
        setupCommunication: function() {
            this.parentWindow = window.opener || window.parent;
            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'INIT_SESSION') {
                    this.sessionId = event.data.data.sessionId;
                    this.sendMessage('SESSION_READY', {
                        pageType: this.detectPageType(),
                        url: window.location.href
                    });
                }
            });
        },
        
        detectPageType: function() {
            const title = document.title || '';
            if (title.includes('P1')) return 'P1';
            if (title.includes('P2')) return 'P2';
            if (title.includes('P3')) return 'P3';
            return 'unknown';
        },
        
        setupAnswerListeners: function() {
            this.answers = {};
            this.startTime = Date.now();
            
            document.addEventListener('change', (e) => {
                if (e.target.name && e.target.name.startsWith('q')) {
                    this.answers[e.target.name] = e.target.value;
                }
            });
        },
        
        interceptSubmit: function() {
            // 拦截grade函数
            if (typeof window.grade === 'function') {
                const originalGrade = window.grade;
                window.grade = () => {
                    const result = originalGrade();
                    setTimeout(() => this.handleSubmit(), 200);
                    return result;
                };
            }
            
            // 监听提交按钮
            document.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' && 
                    (e.target.textContent.includes('Submit') || 
                     e.target.onclick && e.target.onclick.toString().includes('grade'))) {
                    setTimeout(() => this.handleSubmit(), 300);
                }
            });
        },
        
        handleSubmit: function() {
            const results = {
                sessionId: this.sessionId,
                startTime: this.startTime,
                endTime: Date.now(),
                duration: Math.round((Date.now() - this.startTime) / 1000),
                answers: this.answers,
                scoreInfo: this.extractScore(),
                pageType: this.detectPageType(),
                url: window.location.href
            };
            
            this.sendMessage('PRACTICE_COMPLETE', results);
        },
        
        extractScore: function() {
            const resultsEl = document.getElementById('results');
            if (!resultsEl) return null;
            
            const text = resultsEl.textContent || '';
            const scoreMatch = text.match(/Score:\s*(\d+)\/(\d+)/i);
            if (scoreMatch) {
                const correct = parseInt(scoreMatch[1]);
                const total = parseInt(scoreMatch[2]);
                return {
                    correct: correct,
                    total: total,
                    accuracy: total > 0 ? correct / total : 0,
                    percentage: Math.round((correct / total) * 100),
                    source: 'inline_extraction'
                };
            }
            return null;
        },
        
        sendMessage: function(type, data) {
            if (this.parentWindow) {
                this.parentWindow.postMessage({
                    type: type,
                    data: data,
                    source: 'practice_page'
                }, '*');
            }
        }
    };
    
    // 初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            window.practicePageEnhancer.initialize();
        });
    } else {
        window.practicePageEnhancer.initialize();
    }
}
</script>

</body>
</html>