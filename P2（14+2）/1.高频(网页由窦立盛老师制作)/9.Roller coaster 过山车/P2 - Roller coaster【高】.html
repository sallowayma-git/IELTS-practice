<html lang="en"><head>
<meta charset="utf-8">
<title>Roller coaster: the great fairground attraction - Reading Passage 2</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport">
<style>
  :root { --line:#e5e7eb; --bg:#f6f7fb; --panel:#fff; --accent:#3b82f6; --muted:#6b7280; --shadow:0 6px 20px rgba(0,0,0,.12); }
  * { box-sizing: border-box; }
  html,body { height:100%; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); }
  #timer { position: static; display: inline-block; margin-left: 8px; background:#fff; border:1px solid var(--line); border-radius:10px; padding:2px 8px; font-size:14px; vertical-align: middle; }
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:var(--panel); overflow:auto; padding:20px; }
  #left { flex: 0 0 50%; min-width: 280px; }
  #right { flex: 1 1 auto; min-width: 320px; background:#fbfbff; border-left:1px solid var(--line); }
  #divider { flex: 0 0 8px; background: linear-gradient(90deg,#e5e7eb,#d1d5db); cursor: ew-resize; position:relative; z-index: 5; user-select:none; }
  h2,h3,h4 { margin:0 0 10px; }
  #left p { margin: 0 0 12px; line-height: 1.6; word-break: normal; overflow-wrap: normal; hyphens: none; }
  .group { background:#fff; border:1px solid var(--line); border-radius:10px; padding:12px; margin-bottom:14px; }
  table { border-collapse: collapse; width:100%; }
  th, td { border:1px solid var(--line); padding:6px; text-align:center; font-size:14px; }
  th:first-child, td:first-child { width:92px; }
  button { padding:8px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; cursor:pointer; }
  button.primary { background:var(--accent); color:#fff; border-color:#3b82f6; }
  #results { background:#fff; border:1px solid var(--line); border-radius:10px; padding:10px; }
  .hl { background:#fff3a3; box-shadow: inset 0 -2px 0 rgba(0,0,0,.05); cursor: pointer; }
  .hl:hover { filter: brightness(0.98); }
  #selbar { position: absolute; display:none; z-index: 2000; background:#111; color:#fff; border-radius: 8px; padding: 6px; box-shadow: var(--shadow); font-size: 13px; gap:6px; align-items: center; }
  #selbar button { background: transparent; color:#fff; border: 1px solid rgba(255,255,255,.25); padding: 4px 8px; border-radius: 6px; cursor:pointer; }
  #selbar button:hover { border-color:#fff; }
  #notes { position: fixed; right: 12px; bottom: 12px; width: 320px; height: 42vh; background:#fff; border:1px solid var(--line); border-radius: 12px; display:none; flex-direction: column; z-index:1500; box-shadow: var(--shadow); }
  #notes header { display:flex; align-items:center; justify-content: space-between; padding:8px 10px; border-bottom:1px solid var(--line); }
  #notes textarea { flex:1; border:0; padding:10px; resize:none; font-size:14px; line-height:1.5; }
  #toast { position: fixed; left:50%; transform: translateX(-50%); bottom: 24px; background:#111; color:#fff; padding:8px 12px; border-radius: 8px; display:none; z-index:2500; }
  .dropzone { border:2px dashed #cbd5e1; background:#f8fafc; border-radius:10px; min-height:54px; padding:8px; display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .droplabel { color:#64748b; }
  .cardpool { background:#f1f5f9; border-radius:10px; padding:12px; display:grid; gap:8px; }
  .pool-slot { min-height:40px; }
  .card { background:#fff; border:1px solid #e5e7eb; border-radius:8px; padding:8px 10px; display:inline-flex; gap:8px; align-items:center; cursor:grab; box-shadow:0 1px 0 rgba(0,0,0,.03); }
  .card:active { cursor:grabbing; }
  .tag { background:#eef2ff; color:#4338ca; padding:2px 8px; border-radius:999px; font-size:12px; }
  .btn-clear { border:1px solid #e5e7eb; background:#fff; border-radius:8px; padding:6px 8px; cursor:pointer; }
  .ghost { opacity: .5; }
  .over { outline:2px dashed #3b82f6; }
  details.answerbox summary { cursor: pointer; user-select:none; list-style: none; }
  details.answerbox { border:1px dashed var(--line); border-radius:10px; padding:8px 10px; background:#fff; }
  .badge { display:inline-block; background:#eef2ff; color:#4338ca; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:6px; }
  body { padding-bottom: 82px; }
  .practice-nav { background:#fff; border-bottom:2px solid var(--line); padding:12px 20px; display:flex; align-items:center; gap:20px; box-shadow:0 2px 4px rgba(0,0,0,.05); flex-wrap:wrap; position:fixed; left:0; right:0; bottom:0; border-top:2px solid var(--line); border-bottom:0; z-index:4000; }
  .practice-nav .title { font-weight:600; color:var(--muted); }
  .practice-nav .questions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .practice-nav .q-item { padding:6px 10px; border:1px solid var(--line); border-radius:6px; background:#fff; cursor:pointer; font-size:14px; transition:all 0.2s; min-width:36px; text-align:center; }
  .practice-nav .q-item:hover { background:#f1f5f9; border-color:var(--accent); }
  .practice-nav .q-item.answered { background:#e0e7ff; border-color:var(--accent); color:var(--accent); font-weight:500; }
  .practice-nav .q-item.active { background:var(--accent); color:#fff; border-color:var(--accent); }
  #selbar { z-index: 6000 !important; }
  
  /* Diagram styling */
  .diagram {
    border: 1px solid var(--line);
    border-radius: 10px;
    padding: 15px;
    margin: 15px 0;
    background-color: #fff;
    text-align: center;
  }
  .diagram img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
  }
  .diagram-caption {
    margin-top: 10px;
    font-size: 14px;
    color: var(--muted);
  }
</style>
</head>
<body>
<div class="practice-nav">
  <div class="title">Questions</div>
  <div class="questions">
    <div class="q-item" id="q14-nav" onclick="scrollToElement('q14-anchor')">14</div>
    <div class="q-item" id="q15-nav" onclick="scrollToElement('q15-anchor')">15</div>
    <div class="q-item" id="q16-nav" onclick="scrollToElement('q16-anchor')">16</div>
    <div class="q-item" id="q17-nav" onclick="scrollToElement('q17-anchor')">17</div>
    <div class="q-item" id="q18-nav" onclick="scrollToElement('q18-anchor')">18</div>
    <div class="q-item" id="q19-nav" onclick="scrollToElement('q19-anchor')">19</div>
    <div class="q-item" id="q20-nav" onclick="scrollToElement('q20-anchor')">20</div>
    <div class="q-item" id="q21-nav" onclick="scrollToElement('q21-anchor')">21</div>
    <div class="q-item" id="q22-nav" onclick="scrollToElement('q22-anchor')">22</div>
    <div class="q-item" id="q23-nav" onclick="scrollToElement('q23-anchor')">23</div>
    <div class="q-item" id="q24-nav" onclick="scrollToElement('q24-anchor')">24</div>
    <div class="q-item" id="q25-nav" onclick="scrollToElement('q25-anchor')">25</div>
    <div class="q-item" id="q26-nav" onclick="scrollToElement('q26-anchor')">26</div>
  </div>
</div>
<div class="shell">
<section class="pane" id="left">
  <h2>READING PASSAGE 2 <span id="timer">00:00</span></h2>
  <p>You should spend about 20 minutes on Questions 14–26, which are based on Reading Passage 2 below.</p>
  <h3>Roller coaster: the great fairground attraction</h3>
  
  <h4>How they move</h4>
  <p>Like a passenger train, a roller coaster consists of a series of connected cars that move on a track. But unlike a passenger train, it has no engine or power source of its own. For most of the ride, it is moved only by the forces of inertia and gravity. The only exertion of energy occurs at the very beginning of the ride when the coaster train is pulled up the lift hill.</p>
  
  <p>The traditional lifting mechanism is a long length of chain running up the hill under the track. The chain is fastened in a loop, which is wound around a gear at the top of the hill and another one at the bottom. The gear at the bottom of the hill is turned by a motor. This turns the chain so that it continually moves up the hill like a long conveyor belt. The coaster cars grip onto the chain, which simply pulls them to the top. At the summit, the train is released and starts its descent.</p>
  
  <p>The purpose of this initial ascent is to build up a sort of reservoir of potential energy, which simply means that as the coaster gets higher in the air, there is a greater distance gravity can pull it down.</p>
  
  <p>As the train starts coasting down the hill, this potential energy is converted into kinetic energy (energy of motion), and the train speeds up. At the bottom of the hill, this has reached its maximum, and this propels the train up the second hill, again building up the potential-energy level.</p>
  
  <p>In this way, the course of the track is constantly converting energy from kinetic to potential and back again. This fluctuation in acceleration is what makes roller coasters so much fun. At its most basic level, this is all a roller coaster is – a machine that uses gravity and inertia to send a train along a winding track.</p>
  
  <h4>Coasting through history</h4>
  <p>Roller coasters have a long, fascinating history. Their direct ancestors were ice slides, popular in Russia in the 16th and 17th centuries. They consisted of a long, steep, wooden slide covered in ice. Riders walked up a ladder or set of stairs to the top of the slide, as high as 21 metres up. At the top, they climbed into sleds made of wood or blocks of ice and shot down the slope. At the base, the sleds would crash-land in a sand pile.</p>
  
  <p>It seems that the idea was then imported into France. For most of the year, the warmer climate would melt the ice, so the French started building waxed slides instead. To help the sleds move down these slides, they added wheels, and in 1817, for the first time, a train was attached to the track. The French continued to expand on this idea, coming up with more complex track layouts, with multiple cars and all sorts of twists and turns.</p>
  
  <p>The first American roller coaster was built in the mountains of Pennsylvania in the mid-1800s, originally to provide an easy way to send coal to the railway 29 km down the mountain. When the track was first built, a crew at the bottom of the mountain would attach the cart to a team of mules after emptying the load, and the mules would drag it back up to the top. They were eventually replaced with steam engines to make the system more efficient.</p>
  
  <p>Soon after these improvements were made, the railway company built a new tunnel that brought the freight trains much closer to the coal mine. No longer required for its original purpose, the roller coaster was configured as a ‘scenic tour’. For one dollar, tourists got a leisurely ride up to the top of the mountain, followed by a wild, bumpy ride straight down. This was soon a resounding success, attracting thousands of tourists every year.</p>
  
  <p>Scenic rides like this continued to thrive and were joined by wooden roller coasters similar to the ones we know today. These coasters were the main attraction at popular amusement parks throughout the United States, such as the many parks of Coney Island in New York. By the 1920s, roller coasters were in full swing, with some 2,000 rides in operation around the country.</p>
  
  <p>Following the Great Depression, a decline in roller-coaster production began in the early 1930s, but a second roller-coaster boom in the 1970s and the beginning of the 1980s revitalised the amusement-park industry and introduced a slew of innovative tubular steel coasters.</p>
  
  <p>This was followed by a decline in interest for the rest of the decade, but since the early 1990s the amusement-park industry has experienced another coaster boom of sorts. New launching techniques and other technological developments have opened up a world of options for designers, so in some rides you feel as if you are flying. In the next few years we can expect to see many faster, taller and more twisted rides popping up in amusement parks around the world.</p>
  
  <p>&nbsp;</p> <!-- 增加空白行防止加载不完全 -->
  <p>&nbsp;</p>
  <p>&nbsp;</p>
</section>
<div id="divider" title="Drag to resize"></div>
<section class="pane" id="right">
  <h3>Questions</h3>
  
  <div class="group">
    <h4>Questions 14–16</h4>
    <p>Label the diagram below.</p>
    <p>Choose ONE WORD ONLY from the passage for each answer.</p>
    <p>Write your answers in boxes 14–16 on your answer sheet.</p>
    
    <div class="diagram">
      <!-- 替换为您提供的图片 -->
      <img src="https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/code_assistant/e831d341f42d407180b0ae47ccdefdd0~tplv-a9rns2rl98-image.image?rcl=20250812025907D009A2E004E903589DD6&amp;rk3s=8e244e95&amp;rrcfp=e75484ac&amp;x-expires=1755543548&amp;x-signature=%2F4n%2BXk5baZ4wrc7eo0g3eG3Lgac%3D" alt="Roller coaster mechanism diagram with numbered labels for parts">
      <div class="diagram-caption">Roller coaster lifting mechanism with parts labeled 14, 15, and 16</div>
    </div>
    
    <a id="q14-anchor"></a>
    <div id="q14-section" style="padding:8px 0;border-top:1px dashed var(--line);">
      <p>14 _________________</p>
      <input class="blank" maxlength="40" name="q14" placeholder="Write your answer here">
    </div>
    
    <a id="q15-anchor"></a>
    <div id="q15-section" style="padding:8px 0;border-top:1px dashed var(--line);">
      <p>15 _________________</p>
      <input class="blank" maxlength="40" name="q15" placeholder="Write your answer here">
    </div>
    
    <a id="q16-anchor"></a>
    <div id="q16-section" style="padding:8px 0;border-top:1px dashed var(--line);">
      <p>16 _________________</p>
      <input class="blank" maxlength="40" name="q16" placeholder="Write your answer here">
    </div>
  </div>
  
  <div class="group">
    <h4>Questions 17–21</h4>
    <p>Complete the summary below.</p>
    <p>Choose NO MORE THAN TWO WORDS from the passage for each answer.</p>
    <p>Write your answers in boxes 17–21 on your answer sheet.</p>
    <p><strong>History of roller coasters</strong></p>
    <p>Modern roller coasters are descended from 16th-century Russian slides with a surface of <a id="q17-anchor"></a><input class="blank" maxlength="40" name="q17" placeholder="17">.</p>
    
    <p>In France, because of the higher temperatures, the wooden surface on the slides was <a id="q18-anchor"></a><input class="blank" maxlength="40" name="q18" placeholder="18">, and <a id="q19-anchor"></a><input class="blank" maxlength="40" name="q19" placeholder="19"> were attached to the cars to ease the descent.</p>
    
    <p>The first US roller coaster was used for transporting <a id="q20-anchor"></a><input class="blank" maxlength="40" name="q20" placeholder="20"> down a mountainside in carts.</p>
    
    <p>Initially, these were pulled by mules, but in time power was produced by <a id="q21-anchor"></a><input class="blank" maxlength="40" name="q21" placeholder="21">.</p>
  </div>
  
  <div class="group">
    <h4>Questions 22–26</h4>
    <p>Do the following statements agree with the information given in Reading Passage 2?</p>
    <p>In boxes 22–26 on your answer sheet, write</p>
    <ul>
      <li>TRUE if the statement agrees with the information</li>
      <li>FALSE if the statement contradicts the information</li>
      <li>NOT GIVEN if there is no information on this</li>
    </ul>
    
    <a id="q22-anchor"></a>
    <div id="q22-section" style="padding:8px 0;border-top:1px dashed var(--line);">
      <p>22 The earliest modifications to the basic slide were made in France.</p>
      <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
        <label style="margin:0;"><input name="q22" type="radio" value="TRUE"> TRUE</label>
        <label style="margin:0;"><input name="q22" type="radio" value="FALSE"> FALSE</label>
        <label style="margin:0;"><input name="q22" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
      </div>
    </div>
    
    <a id="q23-anchor"></a>
    <div id="q23-section" style="padding:8px 0;border-top:1px dashed var(--line);">
      <p>23 Roller coasters continued to increase in popularity throughout the 1920s and 1930s.</p>
      <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
        <label style="margin:0;"><input name="q23" type="radio" value="TRUE"> TRUE</label>
        <label style="margin:0;"><input name="q23" type="radio" value="FALSE"> FALSE</label>
        <label style="margin:0;"><input name="q23" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
      </div>
    </div>
    
    <a id="q24-anchor"></a>
    <div id="q24-section" style="padding:8px 0;border-top:1px dashed var(--line);">
      <p>24 New roller-coaster technology was introduced in the 1970s in response to public demand.</p>
      <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
        <label style="margin:0;"><input name="q24" type="radio" value="TRUE"> TRUE</label>
        <label style="margin:0;"><input name="q24" type="radio" value="FALSE"> FALSE</label>
        <label style="margin:0;"><input name="q24" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
      </div>
    </div>
    
    <a id="q25-anchor"></a>
    <div id="q25-section" style="padding:8px 0;border-top:1px dashed var(--line);">
      <p>25 Roller coasters were less popular for most of the 1980s than in the 1970s and 1990s.</p>
      <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
        <label style="margin:0;"><input name="q25" type="radio" value="TRUE"> TRUE</label>
        <label style="margin:0;"><input name="q25" type="radio" value="FALSE"> FALSE</label>
        <label style="margin:0;"><input name="q25" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
      </div>
    </div>
    
    <a id="q26-anchor"></a>
    <div id="q26-section" style="padding:8px 0;border-top:1px dashed var(--line);">
      <p>26 The design of roller-coaster rides became more varied in the 1990s.</p>
      <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
        <label style="margin:0;"><input name="q26" type="radio" value="TRUE"> TRUE</label>
        <label style="margin:0;"><input name="q26" type="radio" value="FALSE"> FALSE</label>
        <label style="margin:0;"><input name="q26" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
      </div>
    </div>
  </div>
  
  <div style="display:flex;gap:8px;margin-bottom:10px;">
    <button class="primary" onclick="grade()">Submit</button>
    <button onclick="resetForm()">Reset</button>
    <button onclick="toggleNotes()">Notes</button>
  </div>
  <div id="results"></div>
  <details class="answerbox" id="answerBox">
    <summary>Show answers (click to toggle) <span class="badge">hidden</span></summary>
    <div id="answerContent"></div>
  </details>
</section>
</div>
<div aria-label="Selection tools" id="selbar" role="toolbar">
  <button id="btnHL">Highlight</button>
  <button id="btnUH">Remove</button>
  <button id="btnNote">Note</button>
</div>
<div id="notes">
  <header>
    <strong>Notes</strong>
    <div>
      <button id="btnCopy">Copy</button>
      <button id="btnClose">Close</button>
    </div>
  </header>
  <textarea id="noteArea" placeholder="Type your notes here..."></textarea>
</div>
<div id="toast"></div>
<script>
// Timer
let _t=0; const _timerEl=document.getElementById('timer');
setInterval(function(){ 
  _t++; 
  var m=String(Math.floor(_t/60)).padStart(2,'0'); 
  var s=String(_t%60).padStart(2,'0'); 
  _timerEl.textContent=m+':'+s; 
},1000);
// Drag divider
var divider = document.getElementById('divider');
var left = document.getElementById('left');
var right = document.getElementById('right');
var dragging=false;
function startDrag(e){ 
  dragging=true; 
  document.body.style.cursor='ew-resize'; 
  if(e.preventDefault) e.preventDefault(); 
}
function endDrag(){ 
  dragging=false; 
  document.body.style.cursor=''; 
}
function onMove(clientX){
  var container = document.querySelector('.shell').getBoundingClientRect();
  var x = clientX - container.left;
  x = Math.max(280, Math.min(container.width-320, x));
  left.style.flex = '0 0 ' + x + 'px';
  right.style.flex = '1 1 auto';
}
divider.addEventListener('mousedown', function(e){ startDrag(e); });
window.addEventListener('mousemove', function(e){ if(dragging) onMove(e.clientX); });
window.addEventListener('mouseup', endDrag);
divider.addEventListener('touchstart', function(e){ startDrag(e.touches[0]); }, {passive:false});
window.addEventListener('touchmove', function(e){ if(dragging) onMove(e.touches[0].clientX); }, {passive:false});
window.addEventListener('touchend', endDrag);
// Highlight toolbar
var selbar = document.getElementById('selbar');
var btnHL = document.getElementById('btnHL');
var btnUH = document.getElementById('btnUH');
var btnNote = document.getElementById('btnNote');
var lastRange=null;
var currentHlNode=null;
var keepToolbar=false;
function positionSelbarForRect(rect){
  selbar.style.display='flex';
  requestAnimationFrame(function(){
    var top = window.scrollY + rect.top - selbar.offsetHeight - 8;
    var leftPos = window.scrollX + rect.left + rect.width/2 - selbar.offsetWidth/2;
    selbar.style.top = ((top>0)?top:(window.scrollY + rect.bottom + 8)) + 'px';
    selbar.style.left = Math.max(8, leftPos) + 'px';
  });
}
function updateSelbar(){
  var sel=window.getSelection();
  if(!sel || sel.rangeCount===0 || sel.isCollapsed) { 
    selbar.style.display='none'; 
    currentHlNode=null; 
    return; 
  }
  var range = sel.getRangeAt(0);
  lastRange = range.cloneRange();
  currentHlNode=null;
  positionSelbarForRect(range.getBoundingClientRect());
}
document.getElementById('left').addEventListener('mouseup', updateSelbar);
document.getElementById('right').addEventListener('mouseup', updateSelbar);
document.addEventListener('selectionchange', function(){ 
  var sel=window.getSelection(); 
  if(!sel || sel.rangeCount===0 || sel.isCollapsed){ 
    if(!keepToolbar && !currentHlNode){ 
      selbar.style.display='none'; 
    } 
  } 
});
document.addEventListener('scroll', function(){ 
  if(selbar.style.display==='flex') updateSelbar(); 
});
document.addEventListener('mousedown', function(e){
  var t = e.target;
  if(t.classList && t.classList.contains('hl')){
    keepToolbar = true;
  } else {
    keepToolbar = false;
  }
}, true);
document.addEventListener('click', function(e){
  var target = e.target;
  if(target.classList && target.classList.contains('hl')){
    currentHlNode = target;
    lastRange = null;
    positionSelbarForRect(target.getBoundingClientRect());
    var sel=window.getSelection();
    if(sel) sel.removeAllRanges();
    setTimeout(function(){ keepToolbar=false; }, 0);
  }
}, true);
function doHighlight(){
  if(currentHlNode) return;
  if(!lastRange || lastRange.collapsed) return;
  var span=document.createElement('span'); span.className='hl';
  try { lastRange.surroundContents(span); }
  catch(e){
    var wrap=document.createElement('span'); wrap.className='hl';
    wrap.appendChild(lastRange.cloneContents());
    lastRange.deleteContents();
    lastRange.insertNode(wrap);
  }
  selbar.style.display='none';
  showToast('Highlighted');
}
function removeHighlight(){
  if(currentHlNode){
    var p = currentHlNode.parentNode;
    while(currentHlNode.firstChild) p.insertBefore(currentHlNode.firstChild, currentHlNode);
    p.removeChild(currentHlNode); p.normalize();
    currentHlNode = null;
    selbar.style.display='none';
    showToast('Highlight removed');
    return;
  }
  if(!lastRange) return;
  var selRect = lastRange.getBoundingClientRect();
  var walker=document.createTreeWalker(document.body, NodeFilter.SHOW_ELEMENT);
  var toRemove=[];
  while(walker.nextNode()){
    var n=walker.currentNode;
    if(n.classList && n.classList.contains('hl')) {
      var r = n.getBoundingClientRect();
      if(!(r.right < selRect.left || r.left > selRect.right || r.bottom < selRect.top || r.top > selRect.bottom)) toRemove.push(n);
    }
  }
  toRemove.forEach(function(el){ var p=el.parentNode; while(el.firstChild) p.insertBefore(el.firstChild, el); p.removeChild(el); p.normalize(); });
  selbar.style.display='none';
  showToast('Highlight removed');
}
btnHL.addEventListener('click', doHighlight);
btnUH.addEventListener('click', removeHighlight);
// Notes
var notes = document.getElementById('notes');
var noteArea = document.getElementById('noteArea');
var btnCopy=document.getElementById('btnCopy');
var btnClose=document.getElementById('btnClose');
function toggleNotes(){ 
  notes.style.display = (notes.style.display==='flex'?'none':'flex'); 
}
window.toggleNotes = toggleNotes;
btnClose.addEventListener('click', toggleNotes);
btnCopy.addEventListener('click', async function(){ 
  await navigator.clipboard.writeText(noteArea.value||''); 
  showToast('Copied'); 
});
btnNote.addEventListener('click', function(){
  var text = '';
  if(currentHlNode){ text = (currentHlNode.textContent||'').trim(); }
  else if(lastRange){ var frag = lastRange.cloneContents(); text = (frag.textContent||'').trim(); }
  toggleNotes();
  if(text) noteArea.value = (noteArea.value? noteArea.value+'\n':'') + '> ' + text + '\n';
  selbar.style.display='none';
});
// Toast
var toastEl=document.getElementById('toast');
function showToast(msg){
  toastEl.textContent=msg; 
  toastEl.style.display='block';
  setTimeout(function(){ toastEl.style.display='none'; }, 1200);
}
// Answer key and grading
var answers = {
  "q14":"chain", "q15":"gear", "q16":"motor",
  "q17":"ice", "q18":"waxed", "q19":"wheels", "q20":"coal", "q21":"steam engines",
  "q22":"TRUE", "q23":"FALSE", "q24":"NOT GIVEN", "q25":"TRUE", "q26":"TRUE"
};
var acceptable = {
  // 可接受的答案变体
};
function markBlank(q, user){
  var u = String(user||'').trim().toLowerCase();
  var key = String(answers[q]).trim().toLowerCase();
  if(acceptable[q]){
    return acceptable[q].map(a => a.toLowerCase()).indexOf(u) >= 0;
  }
  return u === key;
}
function markChoice(q, user){
  return String(user||'').toUpperCase() === String(answers[q]).toUpperCase();
}
function grade(){
  var total=0, correct=0, lines=[];
  function push(q, ok, user){
    total++; if(ok) correct++;
    lines.push(q.toUpperCase()+": "+(user||'None')+" "+(ok?'✓':'✗'));
  }
  // 14–16 图表标签
  for(var n=14;n<=16;n++){
    var el=document.querySelector('input[name="q'+n+'"]');
    var val=el?el.value:'';
    push('q'+n, markBlank('q'+n, val), val);
  }
  // 17–21 摘要填空
  for(var n=17;n<=21;n++){
    var el=document.querySelector('input[name="q'+n+'"]');
    var val=el?el.value:'';
    push('q'+n, markBlank('q'+n, val), val);
  }
  // 22–26 判断对错
  for(var n=22;n<=26;n++){
    var sel=document.querySelector('input[name="q'+n+'"]:checked');
    var val=sel?sel.value:'';
    push('q'+n, markChoice('q'+n, val), val);
  }
  var acc = (total? Math.round(100*correct/total):0);
  var html = '<p><strong>Score:</strong> '+correct+'/'+total+' <span class="badge">Accuracy '+acc+'%</span></p>';
  html += '<pre>'+lines.join('\n')+'</pre>';
  document.getElementById('results').innerHTML = html;
  var ahtml = '<ol>';
  ahtml += '<li>14 → chain</li>';
  ahtml += '<li>15 → gear</li>';
  ahtml += '<li>16 → motor</li>';
  ahtml += '<li>17 → ice</li>';
  ahtml += '<li>18 → waxed</li>';
  ahtml += '<li>19 → wheels</li>';
  ahtml += '<li>20 → coal</li>';
  ahtml += '<li>21 → steam engines</li>';
  ahtml += '<li>22 → TRUE</li>';
  ahtml += '<li>23 → FALSE</li>';
  ahtml += '<li>24 → NOT GIVEN</li>';
  ahtml += '<li>25 → TRUE</li>';
  ahtml += '<li>26 → TRUE</li>';
  ahtml += '</ol>';
  document.getElementById('answerContent').innerHTML = ahtml;
  document.querySelector('#answerBox .badge').textContent='tap to view';
}
function resetForm(){
  document.querySelectorAll('input[type="radio"]').forEach(el=>el.checked=false);
  document.querySelectorAll('input.blank').forEach(el=>el.value="");
  document.getElementById('results').innerHTML='';
  document.getElementById('answerContent').innerHTML='';
  document.querySelector('#answerBox .badge').textContent = 'hidden';
  document.querySelectorAll('.q-item').forEach(item => {
    item.classList.remove('answered');
  });
}
function scrollToElement(id){
  var el = document.getElementById(id);
  if(el){ 
    el.scrollIntoView({behavior:'smooth', block:'center'}); 
  }
  var navs = document.querySelectorAll('.practice-nav .q-item');
  navs.forEach(n => n.classList.remove('active'));
  var btn = document.getElementById(id.replace('-anchor','-nav'));
  if(btn){ 
    btn.classList.add('active'); 
    setTimeout(() => btn.classList.remove('active'), 800); 
  }
}
(function(){
  function mark(qn){
    var nav = document.getElementById('q'+qn+'-nav');
    if(!nav) return;
    var radios = document.querySelectorAll('input[name="q'+qn+'"]');
    var text = document.querySelector('input[name="q'+qn+'"].blank');
    var answered=false;
    if(radios.length){ radios.forEach(function(r){ if(r.checked) answered=true; }); }
    if(text){ answered = answered || (text.value && text.value.trim().length>0); }
    if(answered) nav.classList.add('answered'); else nav.classList.remove('answered');
  }
  for(var q=14;q<=26;q++){
    (function(n){
      var radios = document.querySelectorAll('input[name="q'+n+'"]');
      radios.forEach(function(r){ r.addEventListener('change', function(){ mark(n); }); });
      var text = document.querySelector('input[name="q'+n+'"].blank');
      if(text){ text.addEventListener('input', function(){ mark(n); }); }
    })(q);
  }
  for(var q=14;q<=26;q++){ mark(q); }
})();
</script>



<!-- 练习页面数据传输增强脚本 -->
<script>
// 检查是否已经有增强脚本
if (!window.practicePageEnhancer) {
    // 动态加载增强脚本
    const script = document.createElement('script');
    script.src = '../../js/practice-page-enhancer.js';
    script.onload = function() {
        console.log('练习页面增强脚本已加载');
    };
    script.onerror = function() {
        console.error('练习页面增强脚本加载失败');
        // 降级到内联增强
        loadInlineEnhancer();
    };
    document.head.appendChild(script);
}

// 内联增强器（降级方案）
function loadInlineEnhancer() {
    if (window.practicePageEnhancer) return;
    
    window.practicePageEnhancer = {
        initialize: function() {
            console.log('[InlineEnhancer] 内联增强器已初始化');
            this.setupCommunication();
            this.setupAnswerListeners();
            this.interceptSubmit();
        },
        
        setupCommunication: function() {
            this.parentWindow = window.opener || window.parent;
            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'INIT_SESSION') {
                    this.sessionId = event.data.data.sessionId;
                    this.sendMessage('SESSION_READY', {
                        pageType: this.detectPageType(),
                        url: window.location.href
                    });
                }
            });
        },
        
        detectPageType: function() {
            const title = document.title || '';
            if (title.includes('P1')) return 'P1';
            if (title.includes('P2')) return 'P2';
            if (title.includes('P3')) return 'P3';
            return 'unknown';
        },
        
        setupAnswerListeners: function() {
            this.answers = {};
            this.startTime = Date.now();
            
            document.addEventListener('change', (e) => {
                if (e.target.name && e.target.name.startsWith('q')) {
                    this.answers[e.target.name] = e.target.value;
                }
            });
        },
        
        interceptSubmit: function() {
            // 拦截grade函数
            if (typeof window.grade === 'function') {
                const originalGrade = window.grade;
                window.grade = () => {
                    const result = originalGrade();
                    setTimeout(() => this.handleSubmit(), 200);
                    return result;
                };
            }
            
            // 监听提交按钮
            document.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' && 
                    (e.target.textContent.includes('Submit') || 
                     e.target.onclick && e.target.onclick.toString().includes('grade'))) {
                    setTimeout(() => this.handleSubmit(), 300);
                }
            });
        },
        
        handleSubmit: function() {
            const results = {
                sessionId: this.sessionId,
                startTime: this.startTime,
                endTime: Date.now(),
                duration: Math.round((Date.now() - this.startTime) / 1000),
                answers: this.answers,
                scoreInfo: this.extractScore(),
                pageType: this.detectPageType(),
                url: window.location.href
            };
            
            this.sendMessage('PRACTICE_COMPLETE', results);
        },
        
        extractScore: function() {
            const resultsEl = document.getElementById('results');
            if (!resultsEl) return null;
            
            const text = resultsEl.textContent || '';
            const scoreMatch = text.match(/Score:\s*(\d+)\/(\d+)/i);
            if (scoreMatch) {
                const correct = parseInt(scoreMatch[1]);
                const total = parseInt(scoreMatch[2]);
                return {
                    correct: correct,
                    total: total,
                    accuracy: total > 0 ? correct / total : 0,
                    percentage: Math.round((correct / total) * 100),
                    source: 'inline_extraction'
                };
            }
            return null;
        },
        
        sendMessage: function(type, data) {
            if (this.parentWindow) {
                this.parentWindow.postMessage({
                    type: type,
                    data: data,
                    source: 'practice_page'
                }, '*');
            }
        }
    };
    
    // 初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            window.practicePageEnhancer.initialize();
        });
    } else {
        window.practicePageEnhancer.initialize();
    }
}
</script>

</body></html>