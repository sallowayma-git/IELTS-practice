<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS 学术练习管理系统 - Academic Professional</title>

    <!-- Georgia Serif Font -->
    <link href="https://fonts.googleapis.com/css2?family=Georgia:wght@400;700&family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* ==================== CSS Custom Properties (Design Tokens) ==================== */
        :root {
            /* Academic Blue Color Palette */
            --color-primary: #1e3a8a;        /* Deep Navy Blue */
            --color-primary-light: #2563eb;   /* Bright Blue */
            --color-primary-dark: #1e293b;   /* Dark Blue */
            --color-secondary: #3b82f6;      /* Medium Blue */
            --color-accent: #60a5fa;         /* Light Blue */

            /* Neutral Colors */
            --color-white: #ffffff;
            --color-gray-50: #f8fafc;
            --color-gray-100: #f1f5f9;
            --color-gray-200: #e2e8f0;
            --color-gray-300: #cbd5e1;
            --color-gray-400: #94a3b8;
            --color-gray-500: #64748b;
            --color-gray-600: #475569;
            --color-gray-700: #334155;
            --color-gray-800: #1e293b;
            --color-gray-900: #0f172a;

            /* Academic Colors */
            --color-parchment: #f8f6f0;      /* Paper background */
            --color-ink: #2d3748;            /* Text color */
            --color-highlight: #fef3c7;      /* Yellow highlight */

            /* Semantic Colors */
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-error: #ef4444;
            --color-info: #3b82f6;

            /* 4-Point Grid System (4px base) */
            --space-1: 0.25rem;    /* 4px */
            --space-2: 0.5rem;     /* 8px */
            --space-3: 0.75rem;    /* 12px */
            --space-4: 1rem;       /* 16px */
            --space-5: 1.25rem;    /* 20px */
            --space-6: 1.5rem;     /* 24px */
            --space-7: 2rem;       /* 32px */
            --space-8: 2.5rem;     /* 40px */
            --space-9: 3rem;       /* 48px */
            --space-10: 4rem;      /* 64px */

            /* Border Radius */
            --radius-sm: 0.25rem;   /* 4px */
            --radius-md: 0.375rem;  /* 6px */
            --radius-lg: 0.5rem;    /* 8px */
            --radius-xl: 0.75rem;   /* 12px */
            --radius-2xl: 1rem;     /* 16px */
            --radius-full: 9999px;

            /* Typography Scale */
            --font-size-xs: 0.75rem;     /* 12px */
            --font-size-sm: 0.875rem;    /* 14px */
            --font-size-base: 1rem;      /* 16px */
            --font-size-lg: 1.125rem;    /* 18px */
            --font-size-xl: 1.25rem;     /* 20px */
            --font-size-2xl: 1.5rem;     /* 24px */
            --font-size-3xl: 1.875rem;   /* 30px */
            --font-size-4xl: 2.25rem;    /* 36px */
            --font-size-5xl: 3rem;       /* 48px */

            /* Font Weights */
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;

            /* Line Heights */
            --line-height-tight: 1.25;
            --line-height-normal: 1.5;
            --line-height-relaxed: 1.75;

            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);

            /* Transitions */
            --transition-fast: 150ms ease-out;
            --transition-normal: 200ms ease-out;
            --transition-slow: 300ms ease-out;
        }

        /* ==================== Reset & Base Styles ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background-color: var(--color-parchment);
            color: var(--color-ink);
            line-height: var(--line-height-normal);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* ==================== Sidebar Navigation ==================== */
        .sidebar {
            width: 280px;
            background-color: var(--color-white);
            border-right: 1px solid var(--color-gray-200);
            padding: var(--space-6);
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-md);
        }

        .sidebar-header {
            text-align: center;
            margin-bottom: var(--space-8);
            padding-bottom: var(--space-6);
            border-bottom: 2px solid var(--color-gray-200);
        }

        .sidebar-header h1 {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
            margin-bottom: var(--space-2);
            letter-spacing: -0.025em;
        }

        .sidebar-header p {
            font-size: var(--font-size-sm);
            color: var(--color-gray-600);
            font-style: italic;
        }

        .nav-menu {
            flex: 1;
        }

        .nav-item {
            display: block;
            width: 100%;
            padding: var(--space-4) var(--space-5);
            margin-bottom: var(--space-2);
            background-color: var(--color-gray-50);
            border: 1px solid var(--color-gray-200);
            border-radius: var(--radius-md);
            color: var(--color-gray-700);
            text-decoration: none;
            font-family: 'Source Sans Pro', sans-serif;
            font-weight: var(--font-weight-medium);
            font-size: var(--font-size-base);
            text-align: left;
            transition: all var(--transition-normal);
            cursor: pointer;
        }

        .nav-item:hover {
            background-color: var(--color-primary-light);
            color: var(--color-white);
            border-color: var(--color-primary);
            transform: translateX(4px);
        }

        .nav-item.active {
            background-color: var(--color-primary);
            color: var(--color-white);
            border-color: var(--color-primary);
            box-shadow: var(--shadow-md);
        }

        .nav-item i {
            margin-right: var(--space-3);
            width: 20px;
            text-align: center;
        }

        .sidebar-footer {
            padding-top: var(--space-6);
            border-top: 1px solid var(--color-gray-200);
            font-size: var(--font-size-xs);
            color: var(--color-gray-500);
            text-align: center;
        }

        /* ==================== Main Content Area ==================== */
        .main-content {
            flex: 1;
            padding: var(--space-8);
            background-color: var(--color-parchment);
            overflow-y: auto;
        }

        .content-header {
            margin-bottom: var(--space-8);
            padding-bottom: var(--space-6);
            border-bottom: 2px solid var(--color-gray-200);
        }

        .content-header h2 {
            font-size: var(--font-size-4xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
            margin-bottom: var(--space-2);
            letter-spacing: -0.025em;
        }

        .content-header .breadcrumb {
            font-size: var(--font-size-sm);
            color: var(--color-gray-600);
            font-family: 'Source Sans Pro', sans-serif;
        }

        /* ==================== View Sections ==================== */
        .view {
            display: none;
            animation: fadeIn var(--transition-normal) ease-in-out;
        }

        .view.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ==================== Overview Page ==================== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-6);
            margin-bottom: var(--space-8);
        }

        .stat-card {
            background-color: var(--color-white);
            border: 1px solid var(--color-gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            text-align: center;
            box-shadow: var(--shadow-md);
            transition: all var(--transition-normal);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--color-primary);
        }

        .stat-icon {
            font-size: var(--font-size-3xl);
            color: var(--color-primary);
            margin-bottom: var(--space-4);
        }

        .stat-number {
            font-size: var(--font-size-4xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
            margin-bottom: var(--space-2);
        }

        .stat-label {
            font-size: var(--font-size-sm);
            color: var(--color-gray-600);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-family: 'Source Sans Pro', sans-serif;
            font-weight: var(--font-weight-semibold);
        }

        .categories-section {
            margin-bottom: var(--space-8);
        }

        .section-title {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
            margin-bottom: var(--space-6);
            padding-bottom: var(--space-3);
            border-bottom: 2px solid var(--color-gray-200);
        }

        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--space-6);
        }

        .category-card {
            background-color: var(--color-white);
            border: 1px solid var(--color-gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            box-shadow: var(--shadow-md);
            transition: all var(--transition-normal);
            cursor: pointer;
        }

        .category-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--color-primary);
        }

        .category-header {
            display: flex;
            align-items: center;
            margin-bottom: var(--space-4);
        }

        .category-icon {
            font-size: var(--font-size-2xl);
            color: var(--color-primary);
            margin-right: var(--space-4);
        }

        .category-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-ink);
        }

        .category-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-4);
        }

        .category-stat {
            text-align: center;
            padding: var(--space-3);
            background-color: var(--color-gray-50);
            border-radius: var(--radius-md);
        }

        .category-stat-number {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
        }

        .category-stat-label {
            font-size: var(--font-size-xs);
            color: var(--color-gray-600);
            text-transform: uppercase;
            font-family: 'Source Sans Pro', sans-serif;
        }

        /* ==================== Browse Page ==================== */
        .search-section {
            background-color: var(--color-white);
            border: 1px solid var(--color-gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
            box-shadow: var(--shadow-md);
        }

        .search-row {
            display: flex;
            gap: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .search-input {
            flex: 1;
            padding: var(--space-4);
            border: 1px solid var(--color-gray-300);
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
            font-family: 'Source Sans Pro', sans-serif;
            transition: all var(--transition-normal);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .filter-buttons {
            display: flex;
            gap: var(--space-3);
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: var(--space-3) var(--space-5);
            border: 1px solid var(--color-gray-300);
            border-radius: var(--radius-md);
            background-color: var(--color-white);
            color: var(--color-gray-700);
            font-size: var(--font-size-sm);
            font-family: 'Source Sans Pro', sans-serif;
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .filter-btn:hover {
            background-color: var(--color-primary-light);
            color: var(--color-white);
            border-color: var(--color-primary);
        }

        .filter-btn.active {
            background-color: var(--color-primary);
            color: var(--color-white);
            border-color: var(--color-primary);
        }

        .exam-list {
            display: grid;
            gap: var(--space-4);
        }

        .exam-item {
            background-color: var(--color-white);
            border: 1px solid var(--color-gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            box-shadow: var(--shadow-md);
            transition: all var(--transition-normal);
        }

        .exam-item:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--color-primary);
        }

        .exam-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-4);
        }

        .exam-info h3 {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-bold);
            color: var(--color-ink);
            margin-bottom: var(--space-2);
        }

        .exam-meta {
            display: flex;
            gap: var(--space-4);
            font-size: var(--font-size-sm);
            color: var(--color-gray-600);
            font-family: 'Source Sans Pro', sans-serif;
        }

        .exam-meta-item {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .exam-actions {
            display: flex;
            gap: var(--space-3);
        }

        .btn {
            padding: var(--space-3) var(--space-5);
            border: 1px solid var(--color-gray-300);
            border-radius: var(--radius-md);
            background-color: var(--color-white);
            color: var(--color-gray-700);
            font-size: var(--font-size-sm);
            font-family: 'Source Sans Pro', sans-serif;
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all var(--transition-normal);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
        }

        .btn:hover {
            background-color: var(--color-primary-light);
            color: var(--color-white);
            border-color: var(--color-primary);
            transform: translateY(-1px);
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: var(--color-white);
            border-color: var(--color-primary);
        }

        .btn-primary:hover {
            background-color: var(--color-primary-dark);
            border-color: var(--color-primary-dark);
        }

        .btn-secondary {
            background-color: var(--color-gray-100);
            border-color: var(--color-gray-300);
        }

        .btn-success {
            background-color: var(--color-success);
            color: var(--color-white);
            border-color: var(--color-success);
        }

        .btn-warning {
            background-color: var(--color-warning);
            color: var(--color-white);
            border-color: var(--color-warning);
        }

        /* ==================== Practice Records ==================== */
        .practice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-6);
        }

        .practice-actions {
            display: flex;
            gap: var(--space-3);
        }

        .records-table {
            background-color: var(--color-white);
            border: 1px solid var(--color-gray-200);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Source Sans Pro', sans-serif;
        }

        .table th,
        .table td {
            padding: var(--space-4);
            text-align: left;
            border-bottom: 1px solid var(--color-gray-200);
        }

        .table th {
            background-color: var(--color-gray-50);
            font-weight: var(--font-weight-semibold);
            color: var(--color-gray-700);
            font-size: var(--font-size-sm);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .table tbody tr:hover {
            background-color: var(--color-gray-50);
        }

        .table tbody tr:last-child td {
            border-bottom: none;
        }

        .score-badge {
            display: inline-block;
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-full);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            text-align: center;
            min-width: 60px;
        }

        .score-excellent {
            background-color: #dcfce7;
            color: #166534;
        }

        .score-good {
            background-color: #dbeafe;
            color: #1d4ed8;
        }

        .score-fair {
            background-color: #fef3c7;
            color: #92400e;
        }

        .score-poor {
            background-color: #fee2e2;
            color: #991b1b;
        }

        /* ==================== Settings Page ==================== */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--space-6);
        }

        .settings-card {
            background-color: var(--color-white);
            border: 1px solid var(--color-gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            box-shadow: var(--shadow-md);
        }

        .settings-card h3 {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
            margin-bottom: var(--space-4);
        }

        .settings-card p {
            font-size: var(--font-size-sm);
            color: var(--color-gray-600);
            margin-bottom: var(--space-4);
            line-height: var(--line-height-relaxed);
        }

        .settings-actions {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }

        /* ==================== Message System ==================== */
        .message-container {
            position: fixed;
            top: var(--space-6);
            right: var(--space-6);
            z-index: 1000;
            max-width: 400px;
        }

        .message {
            background-color: var(--color-white);
            border: 1px solid var(--color-gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-4) var(--space-5);
            margin-bottom: var(--space-3);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: var(--space-3);
            animation: slideIn var(--transition-normal) ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .message-icon {
            font-size: var(--font-size-lg);
        }

        .message.success {
            border-left: 4px solid var(--color-success);
        }

        .message.success .message-icon {
            color: var(--color-success);
        }

        .message.error {
            border-left: 4px solid var(--color-error);
        }

        .message.error .message-icon {
            color: var(--color-error);
        }

        .message.warning {
            border-left: 4px solid var(--color-warning);
        }

        .message.warning .message-icon {
            color: var(--color-warning);
        }

        .message.info {
            border-left: 4px solid var(--color-info);
        }

        .message.info .message-icon {
            color: var(--color-info);
        }

        .message-content {
            flex: 1;
        }

        .message-title {
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--space-1);
        }

        .message-text {
            font-size: var(--font-size-sm);
            color: var(--color-gray-600);
        }

        /* ==================== Loading & Empty States ==================== */
        .loading {
            text-align: center;
            padding: var(--space-10);
            color: var(--color-gray-600);
        }

        .spinner {
            border: 3px solid var(--color-gray-200);
            border-radius: var(--radius-full);
            border-top: 3px solid var(--color-primary);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto var(--space-4);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: var(--space-10);
            color: var(--color-gray-600);
        }

        .empty-state-icon {
            font-size: var(--font-size-5xl);
            margin-bottom: var(--space-4);
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--space-2);
        }

        .empty-state-text {
            font-size: var(--font-size-base);
            color: var(--color-gray-500);
        }

        /* ==================== Responsive Design ==================== */
        @media (max-width: 1024px) {
            .app-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                padding: var(--space-4);
            }

            .sidebar-header {
                margin-bottom: var(--space-4);
            }

            .nav-menu {
                display: flex;
                gap: var(--space-3);
                overflow-x: auto;
            }

            .nav-item {
                flex-shrink: 0;
                margin-bottom: 0;
            }

            .main-content {
                padding: var(--space-4);
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .categories-grid {
                grid-template-columns: 1fr;
            }

            .settings-grid {
                grid-template-columns: 1fr;
            }

            .search-row {
                flex-direction: column;
            }

            .practice-header {
                flex-direction: column;
                gap: var(--space-4);
                align-items: stretch;
            }

            .practice-actions {
                justify-content: center;
            }

            .records-table {
                overflow-x: auto;
            }

            .table {
                min-width: 600px;
            }

            .message-container {
                left: var(--space-4);
                right: var(--space-4);
                max-width: none;
            }
        }

        /* ==================== Print Styles ==================== */
        @media print {
            .sidebar,
            .message-container,
            .btn {
                display: none !important;
            }

            .main-content {
                padding: 0;
            }

            .stat-card,
            .category-card,
            .exam-item,
            .settings-card {
                break-inside: avoid;
                box-shadow: none;
                border: 1px solid var(--color-gray-300);
            }
        }

        /* ==================== Accessibility ==================== */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus styles */
        button:focus,
        input:focus,
        select:focus,
        textarea:focus {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            :root {
                --color-gray-200: #999999;
                --color-gray-300: #666666;
                --color-gray-600: #333333;
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
    <!-- 练习记录详情弹窗样式（引用现有库，不修改库文件） -->
    <link rel="stylesheet" href="../../css/practice-record-modal.css">
    <style>
        /* ==================== Design Adapt Overrides ==================== */
        /* 4) 小圆点对齐：相对上移 1px，使与题目文本更居中 */
        .completion-dot { position: relative; top: -1px; }

        /* 弹窗风格适配 Academic */
        .modal-header { background: var(--color-gray-50); border-bottom: 1px solid var(--color-gray-200); }
        .modal-title { color: var(--color-primary); }
        .modal-footer { background: var(--color-gray-50); border-top: 1px solid var(--color-gray-200); }
        .record-summary h4 { background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%); }
        .meta-item { background: var(--color-gray-50); border-left-color: var(--color-accent); }
        .meta-label { color: var(--color-gray-600); }
        .meta-value { color: var(--color-primary-dark); }

        /* 练习记录行选择（批量删除模式） */
        .record-row.selected { background: #fef2f2 !important; }
        .records-table tbody tr.selected { background: #fef2f2 !important; }
        #practice-view.bulk-mode .record-row { cursor: pointer; }
        #practice-view.bulk-mode .record-row:hover { background: #fee2e2; }

        /* 主题切换弹窗居中定位和学术风格设计 */
        #theme-switcher.modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(30, 58, 138, 0.15);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(2px);
        }

        #theme-switcher .modal-container {
            background: var(--color-white);
            border: 1px solid var(--color-gray-200);
            border-radius: var(--radius-lg);
            box-shadow:
                0 20px 25px -5px rgba(0, 0, 0, 0.1),
                0 10px 10px -5px rgba(0, 0, 0, 0.04),
                0 0 0 1px rgba(30, 58, 138, 0.05);
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            margin: 0;
            overflow: hidden;
        }

        #theme-switcher .modal-header {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
            color: var(--color-white);
            padding: var(--space-4) var(--space-6);
            border-bottom: 1px solid var(--color-gray-200);
        }

        #theme-switcher .modal-title {
            color: var(--color-white);
            font-family: 'Georgia', serif;
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            margin: 0;
            letter-spacing: -0.025em;
        }

        #theme-switcher .modal-body {
            padding: var(--space-6);
            background: var(--color-parchment);
        }

        #theme-switcher .theme-card {
            background: var(--color-white);
            border: 1px solid var(--color-gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            margin-bottom: var(--space-4);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        #theme-switcher .theme-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--color-primary);
            transition: width var(--transition-normal);
        }

        #theme-switcher .theme-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--color-primary);
        }

        #theme-switcher .theme-card:hover::before {
            width: 6px;
        }

        #theme-switcher .theme-card.active {
            border-color: var(--color-primary);
            background: linear-gradient(135deg, rgba(30, 58, 138, 0.02) 0%, rgba(59, 130, 246, 0.05) 100%);
        }

        #theme-switcher .theme-card.active::before {
            width: 6px;
            background: var(--color-primary);
        }

        #theme-switcher .theme-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #theme-switcher .theme-details h4 {
            color: var(--color-primary);
            font-family: 'Georgia', serif;
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-bold);
            margin: 0 0 var(--space-2) 0;
            letter-spacing: -0.025em;
        }

        #theme-switcher .theme-details p {
            color: var(--color-gray-600);
            font-family: 'Source Sans Pro', sans-serif;
            font-size: var(--font-size-sm);
            margin: 0;
            line-height: var(--line-height-normal);
        }

        #theme-switcher .theme-actions {
            display: flex;
            gap: var(--space-3);
            align-items: center;
        }

        #theme-switcher .current-badge {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
            color: var(--color-white);
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-family: 'Source Sans Pro', sans-serif;
        }

        #theme-switcher .modal-footer {
            background: var(--color-gray-50);
            border-top: 1px solid var(--color-gray-200);
            padding: var(--space-3) var(--space-6);
            display: flex;
            justify-content: flex-end;
        }

        #theme-switcher .theme-description {
            background: var(--color-gray-50);
            border-left: 3px solid var(--color-accent);
            padding: var(--space-4);
            border-radius: 0 var(--radius-md) var(--radius-md) 0;
            margin-bottom: var(--space-5);
            font-family: 'Source Sans Pro', sans-serif;
        }

        #theme-switcher .theme-description p {
            color: var(--color-gray-700);
            font-size: var(--font-size-sm);
            margin: 0;
            line-height: var(--line-height-relaxed);
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1>IELTS 学术</h1>
                <p>专业练习管理系统</p>
            </div>

            <div class="nav-menu">
                <button class="nav-item active" onclick="showView('overview')">
                    <i class="fas fa-chart-line"></i>
                    <span>学习总览</span>
                </button>
                <button class="nav-item" onclick="showView('browse')">
                    <i class="fas fa-book-open"></i>
                    <span>题库浏览</span>
                </button>
                <button class="nav-item" onclick="showView('practice')">
                    <i class="fas fa-history"></i>
                    <span>练习记录</span>
                </button>
                <button class="nav-item" onclick="showView('settings')">
                    <i class="fas fa-cogs"></i>
                    <span>系统设置</span>
                </button>
            </div>

            <div class="sidebar-footer">
                <p>© 2024 IELTS Academic</p>
                <p>专业 · 高效 · 可靠</p>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Overview View -->
            <div id="overview-view" class="view active">
                <div class="content-header">
                    <h2>学习总览</h2>
                    <div class="breadcrumb">首页 / 学习总览</div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-book-reader"></i>
                        </div>
                        <div class="stat-number" id="total-exams-count">0</div>
                        <div class="stat-label">总题目数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-number" id="completed-count">0</div>
                        <div class="stat-label">已完成</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-percentage"></i>
                        </div>
                        <div class="stat-number" id="average-score">0%</div>
                        <div class="stat-label">平均正确率</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-number" id="study-hours">0</div>
                        <div class="stat-label">学习时长(小时)</div>
                    </div>
                </div>

                <div class="categories-section">
                    <h3 class="section-title">学科分类</h3>
                    <div class="categories-grid" id="categories-grid">
                        <!-- Categories will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Browse View -->
            <div id="browse-view" class="view">
                <div class="content-header">
                    <h2>题库浏览</h2>
                    <div class="breadcrumb">首页 / 题库浏览</div>
                </div>

                <div class="search-section">
                    <div class="search-row">
                        <input type="text" class="search-input" placeholder="搜索题目..." onkeyup="searchExams(this.value)">
                        <button class="btn btn-primary" onclick="refreshExamList()">
                            <i class="fas fa-sync-alt"></i>
                            刷新
                        </button>
                    </div>
                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="filterByType('all')">全部</button>
                        <button class="filter-btn" onclick="filterByType('reading')">阅读</button>
                        <button class="filter-btn" onclick="filterByType('listening')">听力</button>
                    </div>
                </div>

                <div class="exam-list" id="exam-list-container">
                    <!-- Exam items will be populated by JavaScript -->
                </div>

                <div class="loading" id="browse-loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>正在加载题目列表...</p>
                </div>

                <div class="empty-state" id="browse-empty" style="display: none;">
                    <div class="empty-state-icon">
                        <i class="fas fa-book-open"></i>
                    </div>
                    <div class="empty-state-title">暂无题目</div>
                    <div class="empty-state-text">请检查题库配置或联系管理员</div>
                </div>
            </div>

            <!-- Practice View -->
            <div id="practice-view" class="view">
                <div class="content-header">
                    <h2>练习记录</h2>
                    <div class="breadcrumb">首页 / 练习记录</div>
                </div>

                <div class="practice-header">
                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="filterRecordsByType('all')">全部记录</button>
                        <button class="filter-btn" onclick="filterRecordsByType('reading')">阅读记录</button>
                        <button class="filter-btn" onclick="filterRecordsByType('listening')">听力记录</button>
                    </div>
                    <div class="practice-actions">
                        <button class="btn btn-secondary" onclick="exportPracticeData()">
                            <i class="fas fa-download"></i>
                            导出记录
                        </button>
                        <button class="btn" onclick="bulkDeleteAction()" id="bulk-delete-btn">
                            <i class="fas fa-trash"></i>
                            批量删除
                        </button>
                        <button class="btn btn-warning" onclick="clearPracticeData()">
                            <i class="fas fa-trash"></i>
                            清除记录
                        </button>
                    </div>
                </div>

                <div class="records-table">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>题目名称</th>
                                <th>类型</th>
                                <th>得分</th>
                                <th>用时</th>
                                <th>完成时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="practice-records-tbody">
                            <!-- Practice records will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <div class="empty-state" id="practice-empty" style="display: none;">
                    <div class="empty-state-icon">
                        <i class="fas fa-history"></i>
                    </div>
                    <div class="empty-state-title">暂无练习记录</div>
                    <div class="empty-state-text">开始练习后，您的记录将显示在这里</div>
                </div>
            </div>

            <!-- Settings View -->
            <div id="settings-view" class="view">
                <div class="content-header">
                    <h2>系统设置</h2>
                    <div class="breadcrumb">首页 / 系统设置</div>
                </div>

                <div class="settings-grid">
                    <div class="settings-card">
                        <h3><i class="fas fa-broom"></i> 系统清理</h3>
                        <p>清理系统缓存和临时文件，提高系统运行效率</p>
                        <div class="settings-actions">
                            <button class="btn btn-primary" onclick="fixedClearCache()">
                                <i class="fas fa-broom"></i>
                                清除缓存和记录
                            </button>
                            <button class="btn btn-secondary" onclick="clearTemporaryFiles()">
                                <i class="fas fa-file-archive"></i>
                                清理临时文件
                            </button>
                        </div>
                    </div>

                    <div class="settings-card">
                        <h3><i class="fas fa-database"></i> 题库管理</h3>
                        <p>管理题库数据，包括重新加载和更新题库</p>
                        <div class="settings-actions">
                            <button class="btn btn-primary" onclick="forceReloadLibrary()">
                                <i class="fas fa-sync-alt"></i>
                                强制刷新题库
                            </button>
                            <button class="btn btn-secondary" onclick="checkLibraryUpdates()">
                                <i class="fas fa-download"></i>
                                检查更新
                            </button>
                        </div>
                    </div>

                    <div class="settings-card">
                        <h3><i class="fas fa-save"></i> 数据管理</h3>
                        <p>备份、恢复和迁移学习数据</p>
                        <div class="settings-actions">
                            <button class="btn btn-success" onclick="showBackupList()">
                                <i class="fas fa-list"></i>
                                备份列表
                            </button>
                            <!-- Use compatibility importer to support newer export schema -->
                            <input type="file" id="compat-import-input" accept=".json" style="display:none" onchange="(function(e){try{var f=e.target.files&&e.target.files[0];if(!f)return; if(window.dataIntegrityManager&&typeof window.dataIntegrityManager.importData==='function'){ Promise.resolve(window.dataIntegrityManager.importData(f)).then(function(){ try{ (window.syncPracticeRecords||window.fixedSyncPracticeRecords||function(){})(); }catch(_){} try{ showMessage&&showMessage('数据导入成功','success'); }catch(_){} }).catch(function(err){ try{ showMessage&&showMessage('数据导入失败: '+(err&&err.message||err),'error'); }catch(_){} }); } else if (typeof window.importData==='function'){ window.importData(); } }catch(err){ try{ alert('导入失败: '+err); }catch(_){} }})(event)" />
                            <button class="btn btn-primary" onclick="(function(){ var i=document.getElementById('compat-import-input'); if(i) i.click(); else if (typeof window.importData==='function') window.importData(); })()">
                                <i class="fas fa-upload"></i>
                                导入数据
                            </button>
                            <button class="btn btn-secondary" onclick="exportAllData()">
                                <i class="fas fa-file-export"></i>
                                导出全部数据
                            </button>
                        </div>
                    </div>

                    <div class="settings-card">
                        <h3><i class="fas fa-info-circle"></i> 系统信息</h3>
                        <p>查看系统版本、题库统计和使用统计</p>
                        <div class="settings-actions">
                            <button class="btn btn-primary" onclick="showSystemInfo()">
                                <i class="fas fa-info"></i>
                                系统信息
                            </button>
                            <button class="btn btn-secondary" onclick="showUsageStatistics()">
                                <i class="fas fa-chart-bar"></i>
                                使用统计
                            </button>
                            <button class="btn btn-secondary" onclick="showThemeSwitcher()">
                                <i class="fas fa-palette"></i>
                                主题切换
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Message Container -->
    <div class="message-container" id="message-container"></div>

    <!-- Hidden file input for folder selection -->
    <input type="file" id="folder-picker" webkitdirectory style="display: none;">

    <!-- Load existing JavaScript files -->
    <script src="../../assets/scripts/complete-exam-data.js"></script>
    <script src="../../assets/scripts/listening-exam-data.js"></script>

    <!-- 加载工具函数 -->
    <script src="../../js/utils/storage.js"></script>

    <!-- 加载核心组件 -->
    <script src="../../js/core/scoreStorage.js"></script>
    <script src="../../js/core/practiceRecorder.js"></script>
    <script src="../../js/components/PDFHandler.js"></script>

    <script src="../../js/components/IndexValidator.js"></script>
    <script src="../../js/components/CommunicationTester.js"></script>
    <script src="../../js/components/ErrorFixer.js"></script>
    <script src="../../js/components/CommunicationRecovery.js"></script>
    <script src="../../js/components/PerformanceOptimizer.js"></script>
    <script src="../../js/components/DataIntegrityManager.js"></script>
    <script src="../../js/components/BrowseStateManager.js"></script>

    <!-- 新增的 Markdown 导出和记录详情功能 -->
    <script src="../../js/utils/dataConsistencyManager.js"></script>
    <script src="../../js/utils/markdownExporter.js"></script>
    <script src="../../js/components/practiceRecordModal.js"></script>
    <script src="../../js/components/practiceHistoryEnhancer.js"></script>
    <script src="../../js/utils/dom.js"></script>
    <script src="../../js/views/legacyViewBundle.js"></script>
    <script src="../../js/utils/componentChecker.js"></script>
    <script src="../../js/theme-switcher.js"></script>

    <!-- 加载主脚本 -->
    <!-- Path helpers for nested design pages -->
    <script src="../../js/plugins/hp/hp-path-prefix.js"></script>
    <script src="../../js/plugins/hp/hp-path-map.js"></script>
    <script src="../../js/main.js"></script>
    <script src="../../js/boot-fallbacks.js"></script>
    <script>
      // Page-level normalization to handle mojibake characters in paths from data scripts
      (function(){
        try {
          var installed = false;
          function normalizePath(p){
            try {
              var s = String(p || '');
              // Fix replacement char before extensions
              s = s.replace(/\uFFFDhtml/gi, '.html').replace(/\uFFFDpdf/gi, '.pdf');
              // Fix bracket pairs like 【高� -> 【高】, 【次� -> 【次】, etc.
              s = s.replace(/【([^】]{0,6})\uFFFD/g, '【$1】');
              return s;
            } catch(_) { return p; }
          }
          function wrap(){
            if (installed) return; installed = true;
            var orig = window.buildResourcePath;
            if (typeof orig !== 'function') { installed = false; return; }
            if (orig.__pageNormalized) return;
            function wrapped(exam, kind){
              var out = orig.apply(this, arguments);
              try { out = normalizePath(out); } catch(_){}
              return out;
            }
            wrapped.__pageNormalized = true;
            window.buildResourcePath = wrapped;
            try { console.log('[Academic Page] buildResourcePath normalized wrapper installed'); } catch(_){ }
          }
          if (document.readyState === 'loading'){
            document.addEventListener('DOMContentLoaded', wrap);
          } else {
            wrap();
          }
        } catch (err) { try { console.warn('[Academic Page] normalizePath install failed', err); } catch(_){ } }
      })();
    </script>
    <!-- 运行时修复补丁（异步存储/恢复兼容、本地file环境增强） -->
    <script src="../../js/patches/runtime-fixes.js"></script>

    <!-- 加载主应用（最后加载） -->
    <script src="../../js/app.js"></script>

    <script>
        // Global variables are defined in js/main.js
        // let examIndex = [];
        // let currentCategory = 'all';
        // let currentExamType = 'all';
        // let filteredExams = [];
        // let practiceRecords = [];
        // 选择性批量删除所用集合（仅本页使用）
        let selectedRecordIds = new Set();

        const STORAGE_KEYS = {
            PRACTICE: 'practice_records',
            EXAM: 'exam_index'
        };
        const STORAGE_META_KEY = '__storage_bridge_meta__';

        function loadBridgeMeta() {
            try {
                const raw = localStorage.getItem(STORAGE_META_KEY);
                if (raw) {
                    const parsed = JSON.parse(raw);
                    if (parsed && typeof parsed === 'object') {
                        return parsed;
                    }
                }
            } catch (e) {
                console.warn('[StorageBridge] Failed to load bridge meta:', e);
            }
            return {};
        }

        function persistBridgeMeta(meta) {
            try {
                localStorage.setItem(STORAGE_META_KEY, JSON.stringify(meta));
            } catch (e) {
                console.warn('[StorageBridge] Failed to persist bridge meta:', e);
            }
        }

        function readBridgeMeta(key) {
            const meta = loadBridgeMeta();
            return meta[key] || {};
        }

        function updateBridgeMeta(key, updater) {
            const meta = loadBridgeMeta();
            const current = meta[key] || {};
            const next = updater ? updater({ ...current }) : current;

            if (next && Object.keys(next).length > 0) {
                meta[key] = next;
            } else {
                delete meta[key];
            }

            persistBridgeMeta(meta);
            return next;
        }

        function hasSharedStorage() {
            return !!(window.storage && typeof window.storage.get === 'function' && typeof window.storage.set === 'function');
        }

        function readLocalArray(key) {
            try {
                const raw = localStorage.getItem(key);
                if (raw) {
                    const parsed = JSON.parse(raw);
                    if (Array.isArray(parsed)) {
                        return parsed;
                    }
                }
            } catch (e) {
                console.warn('[StorageBridge] Failed to read', key, 'from localStorage:', e);
            }

            return [];
        }

        async function readSharedArray(key) {
            const supportsShared = hasSharedStorage();
            const meta = readBridgeMeta(key);

            if (supportsShared && meta.sharedDirty !== true) {
                try {
                    const data = await window.storage.get(key, []);
                    if (Array.isArray(data)) {
                        try { localStorage.setItem(key, JSON.stringify(data)); } catch (e) {
                            console.warn('[StorageBridge] Failed to mirror', key, 'to localStorage:', e);
                        }
                        updateBridgeMeta(key, (prev) => ({
                            ...prev,
                            sharedDirty: false,
                            lastSharedRead: Date.now()
                        }));
                        return data;
                    }
                    console.warn('[StorageBridge] Shared storage returned non-array data for', key);
                    updateBridgeMeta(key, (prev) => ({
                        ...prev,
                        sharedDirty: true
                    }));
                } catch (e) {
                    console.warn('[StorageBridge] Failed to read', key, 'from shared storage:', e);
                    updateBridgeMeta(key, (prev) => ({
                        ...prev,
                        sharedDirty: true
                    }));
                }
            }

            return readLocalArray(key);
        }

        async function writeSharedArray(key, value) {
            const normalized = Array.isArray(value) ? value : [];
            const supportsShared = hasSharedStorage();
            const now = Date.now();
            let sharedSucceeded = false;

            try {
                localStorage.setItem(key, JSON.stringify(normalized));
            } catch (e) {
                console.warn('[StorageBridge] Failed to persist', key, 'to localStorage:', e);
            }

            if (supportsShared) {
                try {
                    await window.storage.set(key, normalized);
                    sharedSucceeded = true;
                } catch (e) {
                    console.warn('[StorageBridge] Failed to write', key, 'to shared storage:', e);
                }
            }

            updateBridgeMeta(key, (prev) => {
                const next = { ...prev, lastLocalWrite: now };
                if (supportsShared) {
                    if (sharedSucceeded) {
                        next.lastSharedWrite = now;
                        next.sharedDirty = false;
                    } else {
                        next.sharedDirty = true;
                    }
                } else {
                    next.sharedDirty = false;
                }
                return next;
            });

            if (!supportsShared) {
                try {
                    window.dispatchEvent(new CustomEvent('storage-sync', { detail: { key } }));
                } catch (e) {
                    console.warn('[StorageBridge] Failed to dispatch storage-sync for', key, e);
                }
            }

            return normalized;
        }

        async function clearSharedKey(key) {
            if (hasSharedStorage()) {
                try {
                    if (typeof window.storage.remove === 'function') {
                        await window.storage.remove(key);
                    } else {
                        await window.storage.set(key, []);
                    }
                } catch (e) {
                    console.warn('[StorageBridge] Failed to clear', key, 'from shared storage:', e);
                }
            }

            try {
                localStorage.removeItem(key);
            } catch (e) {
                console.warn('[StorageBridge] Failed to remove', key, 'from localStorage:', e);
            }
        }

        async function clearSharedNamespace() {
            if (hasSharedStorage() && typeof window.storage.clear === 'function') {
                try {
                    await window.storage.clear();
                } catch (e) {
                    console.warn('[StorageBridge] Failed to clear shared namespace:', e);
                }
            }

            await Promise.all([
                clearSharedKey(STORAGE_KEYS.PRACTICE),
                clearSharedKey(STORAGE_KEYS.EXAM)
            ]);
        }

        async function getPracticeRecordsFromStorage() {
            return await readSharedArray(STORAGE_KEYS.PRACTICE);
        }

        async function savePracticeRecordsToStorage(records) {
            return await writeSharedArray(STORAGE_KEYS.PRACTICE, records);
        }

        async function getExamIndexFromStorage() {
            return await readSharedArray(STORAGE_KEYS.EXAM);
        }

        async function saveExamIndexToStorage(index) {
            return await writeSharedArray(STORAGE_KEYS.EXAM, index);
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
           // 已在主脚本加载后通过设计页适配修正过 PDF 路径，这里避免重复覆盖
           if (window.PDFHandler && window.PDFHandler.prototype) {
               console.log('[OVERRIDE] PDF 路径已通过设计页适配修正，跳过重复覆盖');
           }

           // 如全局已定义 openExam（来自 main.js），则不覆盖；否则提供简化后备实现
           (function(){
               try {
                   if (typeof window.openExam === 'function') {
                       console.log('[OVERRIDE] 检测到全局 openExam，跳过覆盖');
                   } else {
                       window.openExam = function(examId) {
                           var list = (typeof examIndex !== 'undefined' && examIndex) ? examIndex : [];
                           var exam = list.find(function(e){ return e && e.id === examId; });
                           if (!exam) { try { showMessage('未找到题目', 'error'); } catch(_) {} return; }
                           var kind = exam.hasHtml ? 'html' : 'pdf';
                           var url = (typeof window.buildResourcePath === 'function') ? window.buildResourcePath(exam, kind) : '';
                           if (!url) { try { showMessage('无法构建题目路径', 'error'); } catch(_) {} return; }
                           var win = window.open(url, 'exam_' + exam.id, 'width=1200,height=800,scrollbars=yes,resizable=yes');
                           if (win) { try { showMessage('正在打开: ' + (exam.title || exam.name || exam.id), 'success'); } catch(_) {} }
                       };
                       console.log('[OVERRIDE] 已注入简化 openExam 备用实现');
                   }
               } catch (e) { console.warn('[OVERRIDE] openExam 处理异常:', e); }
            })();


            // First try to load data from shared storage
            await loadStoredData();
            initializeApp();
            await loadLibrary();
            await syncPracticeRecords();
        });

        // Load data from shared storage/local fallback
        async function loadStoredData() {
            try {
                const [storedExamIndex, storedPracticeRecords] = await Promise.all([
                    getExamIndexFromStorage(),
                    getPracticeRecordsFromStorage()
                ]);

                if (Array.isArray(storedExamIndex) && storedExamIndex.length > 0) {
                    examIndex = storedExamIndex;
                    console.log('[StorageBridge] Loaded exam index:', examIndex.length, 'items');
                }

                if (Array.isArray(storedPracticeRecords) && storedPracticeRecords.length > 0) {
                    practiceRecords = storedPracticeRecords;
                    console.log('[StorageBridge] Loaded practice records:', practiceRecords.length, 'items');
                }
            } catch (error) {
                console.error('[StorageBridge] Failed to load data from storage:', error);
            }
        }

        // 防重复消息显示机制
        window._welcomeMessageShown = false;
        window._initializationInProgress = false;
        window._messageHistory = new Set(); // 记录已显示的消息
        window._lastMessageTime = 0; // 记录上一条消息的时间

        // 优化 showMessage 函数，防止短时间内重复显示相同消息
        const originalShowMessage = window.showMessage || function() {};
        window.showMessage = function(message, type = 'info', duration = 3000) {
            const now = Date.now();
            const messageKey = `${message}-${type}`;

            // 如果在2秒内显示过相同的消息，则跳过
            if (window._messageHistory.has(messageKey) && (now - window._lastMessageTime) < 2000) {
                console.log('[Message] 跳过重复消息:', message);
                return;
            }

            // 记录消息
            window._messageHistory.add(messageKey);
            window._lastMessageTime = now;

            // 3秒后清理消息记录
            setTimeout(() => {
                window._messageHistory.delete(messageKey);
            }, 3000);

            // 调用原始函数
            return originalShowMessage(message, type, duration);
        };

        function initializeApp() {
            // 防止重复初始化
            if (window._initializationInProgress) {
                console.log('[App] 初始化已在进行中，跳过重复初始化');
                return;
            }
            window._initializationInProgress = true;

            // Initialize existing components
            if (typeof initializeLegacyComponents === 'function') {
                initializeLegacyComponents();
            }

            // Initialize UI components
            updateOverview();
            updateBrowseView();
            updatePracticeView();
            updateSettingsView();

            // 只显示一次欢迎消息
            if (!window._welcomeMessageShown) {
                showMessage('系统初始化完成', 'success');
                window._welcomeMessageShown = true;
            }

            // 标记初始化完成
            window._initializationInProgress = false;
        }

        // View management
        function showView(viewName) {
            // Hide all views
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });

            // Show selected view
            document.getElementById(viewName + '-view').classList.add('active');

            // Update navigation buttons
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.classList.remove('active');
            });

            // Find and activate the corresponding nav button
            const navButtons = document.querySelectorAll('.nav-item');
            navButtons.forEach(btn => {
                const btnText = btn.textContent.trim();
                if ((viewName === 'overview' && btnText.includes('总览')) ||
                    (viewName === 'browse' && btnText.includes('题库')) ||
                    (viewName === 'practice' && btnText.includes('记录')) ||
                    (viewName === 'settings' && btnText.includes('设置'))) {
                    btn.classList.add('active');
                }
            });

            // Update view-specific content
            switch(viewName) {
                case 'overview':
                    updateOverview();
                    break;
                case 'browse':
                    updateBrowseView();
                    break;
                case 'practice':
                    updatePracticeView();
                    break;
                case 'settings':
                    updateSettingsView();
                    break;
            }
        }

        // Update overview view
        function updateOverview() {
            // Update statistics
            const totalExamsCount = document.getElementById('total-exams-count');
            const completedCount = document.getElementById('completed-count');
            const averageScore = document.getElementById('average-score');
            const studyHours = document.getElementById('study-hours');

            // Null check for examIndex
            const safeExamIndex = examIndex || [];
            const safePracticeRecords = practiceRecords || [];

            if (safeExamIndex.length > 0) {
                totalExamsCount.textContent = safeExamIndex.length;

                let completed = 0;
                let totalScore = 0;
                let totalDuration = 0;

                if (safePracticeRecords.length > 0) {
                    completed = new Set(safePracticeRecords.map(record => record.examId)).size;
                    totalScore = safePracticeRecords.reduce((sum, record) => sum + (record.score || 0), 0);
                    totalDuration = safePracticeRecords.reduce((sum, record) => sum + (record.duration || 0), 0);
                }

                completedCount.textContent = completed;
                averageScore.textContent = safePracticeRecords.length > 0 ? Math.round(totalScore / safePracticeRecords.length) + '%' : '0%';
                studyHours.textContent = Math.round(totalDuration / 3600 * 10) / 10;
            } else {
                totalExamsCount.textContent = '0';
                completedCount.textContent = '0';
                averageScore.textContent = '0%';
                studyHours.textContent = '0';
            }

            // Update categories
            updateCategories();
        }

        // Update categories section
        function updateCategories() {
            const categoriesGrid = document.getElementById('categories-grid');

            const categories = [
                {
                    name: '阅读理解',
                    icon: 'fas fa-book-open',
                    total: 0,
                    completed: 0,
                    averageScore: 0
                },
                {
                    name: '听力练习',
                    icon: 'fas fa-headphones',
                    total: 0,
                    completed: 0,
                    averageScore: 0
                }
            ];

            // Null check for examIndex
            const safeExamIndex = examIndex || [];
            const safePracticeRecords = practiceRecords || [];

            // Calculate statistics
            if (safeExamIndex.length > 0) {
                const readingExams = safeExamIndex.filter(exam => exam.type === 'reading');
                const listeningExams = safeExamIndex.filter(exam => exam.type === 'listening');

                categories[0].total = readingExams.length;
                categories[1].total = listeningExams.length;

                if (safePracticeRecords.length > 0) {
                    const readingRecords = safePracticeRecords.filter(record => record.type === 'reading');
                    const listeningRecords = safePracticeRecords.filter(record => record.type === 'listening');

                    categories[0].completed = new Set(readingRecords.map(record => record.examId)).size;
                    categories[1].completed = new Set(listeningRecords.map(record => record.examId)).size;

                    categories[0].averageScore = readingRecords.length > 0 ?
                        Math.round(readingRecords.reduce((sum, record) => sum + (record.score || 0), 0) / readingRecords.length) : 0;
                    categories[1].averageScore = listeningRecords.length > 0 ?
                        Math.round(listeningRecords.reduce((sum, record) => sum + (record.score || 0), 0) / listeningRecords.length) : 0;
                }
            }

            categoriesGrid.innerHTML = categories.map(category => `
                <div class="category-card" onclick="startCategoryPractice('${category.name}')">
                    <div class="category-header">
                        <div class="category-icon">
                            <i class="${category.icon}"></i>
                        </div>
                        <div class="category-title">${category.name}</div>
                    </div>
                    <div class="category-stats">
                        <div class="category-stat">
                            <div class="category-stat-number">${category.total}</div>
                            <div class="category-stat-label">总题目</div>
                        </div>
                        <div class="category-stat">
                            <div class="category-stat-number">${category.completed}</div>
                            <div class="category-stat-label">已完成</div>
                        </div>
                        <div class="category-stat">
                            <div class="category-stat-number">${category.averageScore}%</div>
                            <div class="category-stat-label">平均分</div>
                        </div>
                        <div class="category-stat">
                            <div class="category-stat-number">${Math.round((category.completed / category.total) * 100) || 0}%</div>
                            <div class="category-stat-label">完成率</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Update browse view
        function updateBrowseView() {
            // Use the global loadExamList function from js/main.js if available
            if (typeof window.loadExamList === 'function') {
                window.loadExamList();
                return;
            }

            // Fallback implementation
            const examList = document.getElementById('exam-list-container');
            const loading = document.getElementById('browse-loading');
            const empty = document.getElementById('browse-empty');

            if (!examIndex || examIndex.length === 0) {
                examList.style.display = 'none';
                loading.style.display = 'none';
                empty.style.display = 'block';
                return;
            }

            // Filter exams based on current type
            let filtered = examIndex;
            if (currentExamType !== 'all') {
                filtered = examIndex.filter(exam => exam.type === currentExamType);
            }

            if (filtered.length === 0) {
                examList.style.display = 'none';
                loading.style.display = 'none';
                empty.style.display = 'block';
                return;
            }

            examList.style.display = 'grid';
            loading.style.display = 'none';
            empty.style.display = 'none';

            examList.innerHTML = filtered.map(exam => `
                <div class="exam-item">
                    <div class="exam-header">
                        <div class="exam-info">
                            <h3>${exam.title || exam.name || '未命名题目'}</h3>
                            <div class="exam-meta">
                                <div class="exam-meta-item">
                                    <i class="fas fa-tag"></i>
                                    <span>${getTypeLabel(exam.type)}</span>
                                </div>
                                <div class="exam-meta-item">
                                    <i class="fas fa-question-circle"></i>
                                    <span>${exam.questionCount || 0} 题</span>
                                </div>
                                <div class="exam-meta-item">
                                    <i class="fas fa-clock"></i>
                                    <span>${exam.estimatedTime || '预计' + (exam.questionCount || 0) * 2 + '分钟'}</span>
                                </div>
                            </div>
                        </div>
                        <div class="exam-actions">
                            <button class="btn btn-primary" onclick="startExam('${exam.id}')">
                                <i class="fas fa-play"></i>
                                开始练习
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Update practice view
        function updatePracticeView() {
            updatePracticeRecords();
        }

        // Update practice records table
        function updatePracticeRecords() {
            const tbody = document.getElementById('practice-records-tbody');
            const empty = document.getElementById('practice-empty');

            if (!practiceRecords || practiceRecords.length === 0) {
                tbody.innerHTML = '';
                empty.style.display = 'block';
                return;
            }

            empty.style.display = 'none';

            // Sort records by date (newest first)
            const sortedRecords = [...practiceRecords].sort((a, b) => {
                const dateA = new Date(a.date || a.timestamp);
                const dateB = new Date(b.date || b.timestamp);
                return dateB - dateA;
            });

            tbody.innerHTML = sortedRecords.map(record => {
                const score = record.score || (record.realData ? record.realData.percentage : 0);
                const duration = record.duration || (record.realData ? record.realData.duration : 0);
                const scoreClass = getScoreClass(score);

                return `
                    <tr>
                        <td>${record.title || record.examName || '未命名练习'}</td>
                        <td>${getTypeLabel(record.type)}</td>
                        <td><span class="score-badge ${scoreClass}">${score}%</span></td>
                        <td>${formatDuration(duration)}</td>
                        <td>${formatDateTime(record.date || record.timestamp)}</td>
                        <td>
                            <button class="btn btn-sm" onclick="viewRecordDetails('${record.id || record.timestamp}')">
                                <i class="fas fa-eye"></i>
                                查看
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Update settings view
        function updateSettingsView() {
            // Settings view doesn't need dynamic updates
        }

        // Helper functions
        function getTypeLabel(type) {
            const labels = {
                'reading': '阅读',
                'listening': '听力',
                'writing': '写作',
                'speaking': '口语'
            };
            return labels[type] || type;
        }

        function getExamTypeFromCategory(category) {
            // Map category to exam type
            if (!category) return 'reading';

            const categoryLower = category.toLowerCase();
            if (categoryLower.includes('p1') || categoryLower.includes('reading')) {
                return 'reading';
            } else if (categoryLower.includes('p2') || categoryLower.includes('listening')) {
                return 'listening';
            } else if (categoryLower.includes('p3') || categoryLower.includes('writing')) {
                return 'reading'; // P3 is typically reading in IELTS
            } else {
                return 'reading'; // Default to reading
            }
        }

        function getExamCategoryFromType(type) {
            // Map exam type to category
            if (!type) return 'P1';

            const typeLower = type.toLowerCase();
            if (typeLower.includes('reading')) {
                return 'P1';
            } else if (typeLower.includes('listening')) {
                return 'P2';
            } else if (typeLower.includes('writing')) {
                return 'P3';
            } else {
                return 'P1'; // Default to P1
            }
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN') + ' ' + date.toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;

            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }

        function getScoreClass(score) {
            if (score >= 90) return 'score-excellent';
            if (score >= 80) return 'score-good';
            if (score >= 60) return 'score-fair';
            return 'score-poor';
        }

        // Action functions
        function startCategoryPractice(categoryName) {
            showView('browse');
            if (categoryName === '阅读理解') {
                filterByType('reading');
            } else if (categoryName === '听力练习') {
                filterByType('listening');
            }
        }

        function startExam(examId) {
            // Use the global openExam function from js/main.js
            if (typeof window.openExam === 'function') {
                window.openExam(examId);
            } else {
                // Fallback implementation
                const safeExamIndex = examIndex || [];
                const exam = safeExamIndex.find(e => e.id === examId);
                if (exam) {
                    if (exam.hasHtml) {
                        // Open HTML practice - resolve via shared helpers
                        let fullPath = '';
                        if (typeof window.buildResourcePath === 'function') {
                            fullPath = window.buildResourcePath(exam, 'html');
                        } else {
                            const resolveBase = (typeof window.resolveExamBasePath === 'function') ? window.resolveExamBasePath : null;
                            let basePath = resolveBase ? resolveBase(exam) : (exam && exam.path ? String(exam.path) : '');
                            if (basePath && !basePath.endsWith('/')) basePath += '/';
                            const fallbackFile = exam && (exam.filename || exam.htmlFilename) ? (exam.filename || exam.htmlFilename) : `${exam.id}.html`;
                            basePath = basePath.replace(/\\/g, '/').replace(/^\.\//, '');
                            const needsRepoRoot = basePath && !/^(?:\.\.\/|\.\/|\/|[a-z]+:\/\/|[A-Za-z]:[\\/])/i.test(basePath);
                            const prefix = needsRepoRoot ? '../../' : '';
                            fullPath = prefix + basePath + fallbackFile;
                        }

                        console.log('Attempting to open:', fullPath);

                        const examWindow = window.open(fullPath, `exam_${exam.id}`, 'width=1200,height=800,scrollbars=yes,resizable=yes');
                        if (examWindow) {
                            showMessage('正在打开: ' + (exam.title || exam.name) + '（路径：' + fullPath + '）', 'success');
                        } else {
                            showMessage('无法打开窗口，请检查弹窗设置', 'error');
                        }
                    } else if (exam.pdfFilename) {
                        // Open PDF
                        let pdfPath = '';
                        if (typeof window.buildResourcePath === 'function') {
                            pdfPath = window.buildResourcePath(exam, 'pdf');
                        } else {
                            const resolveBase = (typeof window.resolveExamBasePath === 'function') ? window.resolveExamBasePath : null;
                            let basePath = resolveBase ? resolveBase(exam) : (exam && exam.path ? String(exam.path) : '');
                            if (basePath && !basePath.endsWith('/')) basePath += '/';
                            const fallbackPdf = exam && exam.pdfFilename ? exam.pdfFilename : `${exam.id}.pdf`;
                            basePath = basePath.replace(/\\/g, '/').replace(/^\.\//, '');
                            const needsRepoRoot = basePath && !/^(?:\.\.\/|\.\/|\/|[a-z]+:\/\/|[A-Za-z]:[\\/])/i.test(basePath);
                            const prefix = needsRepoRoot ? '../../' : '';
                            pdfPath = prefix + basePath + fallbackPdf;
                        }

                        const pdfWindow = window.open(pdfPath, `pdf_${exam.id}`, 'width=1000,height=800,scrollbars=yes,resizable=yes');
                        if (pdfWindow) {
                            showMessage('正在打开PDF: ' + (exam.title || exam.name) + '（路径：' + pdfPath + '）', 'success');
                        } else {
                            showMessage('PDF 打开失败，请手动打开: ' + pdfPath, 'error');
                        }
                    } else {
                        showMessage('题目文件不存在', 'error');
                    }
                } else {
                    showMessage('未找到题目', 'error');
                }
            }
        }

        function filterByType(type) {
            currentExamType = type;

            // Update filter buttons
            document.querySelectorAll('#browse-view .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            updateBrowseView();
        }

        function filterRecordsByType(type) {
            // Update filter buttons
            document.querySelectorAll('#practice-view .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Filter records
            let filtered = practiceRecords;
            if (type !== 'all') {
                filtered = practiceRecords.filter(record => record.type === type);
            }

            const tbody = document.getElementById('practice-records-tbody');
            const empty = document.getElementById('practice-empty');

            if (filtered.length === 0) {
                tbody.innerHTML = '';
                empty.style.display = 'block';
                return;
            }

            empty.style.display = 'none';

            // Sort and display filtered records
            const sortedRecords = [...filtered].sort((a, b) => {
                const dateA = new Date(a.date || a.timestamp);
                const dateB = new Date(b.date || b.timestamp);
                return dateB - dateA;
            });

            tbody.innerHTML = sortedRecords.map(record => {
                const score = record.score || (record.realData ? record.realData.percentage : 0);
                const duration = record.duration || (record.realData ? record.realData.duration : 0);
                const scoreClass = getScoreClass(score);

                return `
                    <tr>
                        <td>${record.title || record.examName || '未命名练习'}</td>
                        <td>${getTypeLabel(record.type)}</td>
                        <td><span class="score-badge ${scoreClass}">${score}%</span></td>
                        <td>${formatDuration(duration)}</td>
                        <td>${formatDateTime(record.date || record.timestamp)}</td>
                        <td>
                            <button class="btn btn-sm" onclick="viewRecordDetails('${record.id || record.timestamp}')">
                                <i class="fas fa-eye"></i>
                                查看
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function searchExams(query) {
            if (!query || !examIndex) {
                updateBrowseView();
                return;
            }

            const filtered = examIndex.filter(exam => {
                const title = (exam.title || exam.name || '').toLowerCase();
                const searchQuery = query.toLowerCase();
                return title.includes(searchQuery);
            });

            const examList = document.getElementById('exam-list-container');
            const empty = document.getElementById('browse-empty');

            if (filtered.length === 0) {
                examList.style.display = 'none';
                empty.style.display = 'block';
                return;
            }

            examList.style.display = 'grid';
            empty.style.display = 'none';

            examList.innerHTML = filtered.map(exam => `
                <div class="exam-item">
                    <div class="exam-header">
                        <div class="exam-info">
                            <h3>${exam.title || exam.name || '未命名题目'}</h3>
                            <div class="exam-meta">
                                <div class="exam-meta-item">
                                    <i class="fas fa-tag"></i>
                                    <span>${getTypeLabel(exam.type)}</span>
                                </div>
                                <div class="exam-meta-item">
                                    <i class="fas fa-question-circle"></i>
                                    <span>${exam.questionCount || 0} 题</span>
                                </div>
                                <div class="exam-meta-item">
                                    <i class="fas fa-clock"></i>
                                    <span>${exam.estimatedTime || '预计' + (exam.questionCount || 0) * 2 + '分钟'}</span>
                                </div>
                            </div>
                        </div>
                        <div class="exam-actions">
                            <button class="btn btn-primary" onclick="startExam('${exam.id}')">
                                <i class="fas fa-play"></i>
                                开始练习
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function refreshExamList() {
            // Use the global loadLibrary function from js/main.js to refresh
            const loading = document.getElementById('browse-loading');
            const examList = document.getElementById('exam-list-container');

            loading.style.display = 'block';
            examList.style.display = 'none';

            setTimeout(async () => {
                await loadLibrary(true);
                loading.style.display = 'none';
                examList.style.display = 'grid';
                showMessage('题库已刷新', 'success');
            }, 1000);
        }

        function viewRecordDetails(recordId) {
            const record = practiceRecords.find(r => (r.id || r.timestamp) === recordId);
            if (record) {
                // Show record details modal or navigate to detail page
                showMessage(`查看练习记录: ${record.title || record.examName}`, 'info');
                // Implementation for showing detailed record view
            }
        }

        // Settings functions
        async function clearCache() {
            if (confirm('确定要清除所有缓存数据吗？此操作不可撤销。')) {
                try { localStorage.clear(); } catch (e) { console.warn('[StorageBridge] localStorage.clear failed:', e); }
                try { sessionStorage.clear(); } catch (e) { console.warn('[StorageBridge] sessionStorage.clear failed:', e); }
                await clearSharedNamespace();
                showMessage('缓存已清除', 'success');
                setTimeout(() => location.reload(), 1500);
            }
        }

        // Fixed clear cache function that also clears practice records
        async function fixedClearCache() {
            if (confirm('确定要清除所有缓存数据和练习记录吗？此操作不可撤销。')) {
                try { localStorage.clear(); } catch (e) { console.warn('[StorageBridge] localStorage.clear failed:', e); }
                try { sessionStorage.clear(); } catch (e) { console.warn('[StorageBridge] sessionStorage.clear failed:', e); }
                await clearSharedNamespace();
                showMessage('缓存和练习记录已清除', 'success');
                setTimeout(() => location.reload(), 1500);
            }
        }

        function clearTemporaryFiles() {
            showMessage('清理完成', 'success');
        }

        // Load library - 添加防重复加载
        window._libraryLoadingInProgress = false;
        async function loadLibrary(forceReload = false) {
            // 防止重复加载
            if (window._libraryLoadingInProgress && !forceReload) {
                console.log('[Library] 题库加载已在进行中，跳过重复调用');
                return;
            }

            if (forceReload) {
                window._libraryLoadingInProgress = false;
            }

            window._libraryLoadingInProgress = true;

            const startTime = performance.now();

            if (!forceReload) {
                if (Array.isArray(examIndex) && examIndex.length > 0) {
                    finishLibraryLoading(startTime);
                    return;
                }

                try {
                    const stored = await getExamIndexFromStorage();
                    if (Array.isArray(stored) && stored.length > 0) {
                        examIndex = stored;
                        finishLibraryLoading(startTime);
                        return;
                    }
                } catch (error) {
                    console.warn('[Library] Failed to load exam index from shared storage:', error);
                }
            }

            console.log(`[Library] ${forceReload ? 'Force' : 'Normal'} loading library index...`);
            showMessage('正在加载题库索引...', 'info');

            try {
                let readingExams = [];
                if (window.completeExamIndex && Array.isArray(window.completeExamIndex)) {
                    readingExams = window.completeExamIndex.map(exam => ({ ...exam, type: 'reading' }));
                    console.log(`[Library] Loaded reading library: ${readingExams.length} items`);
                }

                let listeningExams = [];
                if (window.listeningExamIndex && Array.isArray(window.listeningExamIndex)) {
                    listeningExams = window.listeningExamIndex;
                    console.log(`[Library] Loaded listening library: ${listeningExams.length} items`);
                }

                if (readingExams.length === 0 && listeningExams.length === 0) {
                    console.warn('[Library] No built-in library data detected, continuing with empty index');
                }

                examIndex = [...readingExams, ...listeningExams];
                await saveExamIndexToStorage(examIndex);

                finishLibraryLoading(startTime);
            } catch (error) {
                console.error('[Library] Failed to load library:', error);
                examIndex = [];
                await saveExamIndexToStorage(examIndex);
                finishLibraryLoading(startTime);
            }
        }
        
        function finishLibraryLoading(startTime) {
            const loadTime = performance.now() - startTime;
            showMessage(`题库加载完成！共 ${examIndex.length} 个题目`, 'success');
            updateOverview();
            updateBrowseView();
            // 重置加载状态
            window._libraryLoadingInProgress = false;
        }

        function checkLibraryUpdates() {
            showMessage('正在检查题库更新...', 'info');
            setTimeout(() => {
                showMessage('已是最新版本', 'success');
            }, 2000);
        }

        function createBackup() {
            const data = {
                examIndex: examIndex,
                practiceRecords: practiceRecords,
                settings: {
                    theme: 'academic',
                    language: 'zh-CN',
                    version: '1.0.0'
                },
                timestamp: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ielts_academic_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showMessage('备份创建成功', 'success');
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        console.log('Import data structure:', data);

                        let importedExamCount = 0;
                        let importedRecordCount = 0;

                        // Handle the exported data format from ielts_data_export_*.json
                        // First, check for top-level practice_records
                        if (data.practice_records && Array.isArray(data.practice_records)) {
                            console.log('Found top-level practice_records:', data.practice_records.length);
                            // Import practice records from exported format
                            const importedRecords = data.practice_records.map(record => {
                                const score = record.realData ? record.realData.percentage : (record.percentage || 0);
                                const duration = record.realData ? record.realData.duration : (record.duration || 0);

                                return {
                                    id: record.id || record.timestamp || Date.now(),
                                    examId: record.examId || '',
                                    title: record.title || record.examName || '未命名练习',
                                    type: record.type || getExamTypeFromCategory(record.category),
                                    category: record.category || getExamCategoryFromType(record.type),
                                    frequency: record.frequency || 'medium',
                                    score: score,
                                    duration: duration,
                                    date: record.date || (record.timestamp ? new Date(record.timestamp).toISOString() : new Date().toISOString()),
                                    timestamp: record.timestamp || record.id || Date.now(),
                                    realData: record.realData || null,
                                    dataSource: record.dataSource || 'imported'
                                };
                            });

                            practiceRecords = importedRecords;
                            await savePracticeRecordsToStorage(practiceRecords);
                            importedRecordCount = importedRecords.length;
                        }
                        // Also check for nested practice_records in data.data
                        else if (data.data && data.data.practice_records && Array.isArray(data.data.practice_records)) {
                            console.log('Found nested practice_records:', data.data.practice_records.length);
                            const importedRecords = data.data.practice_records.map(record => {
                                const score = record.realData ? record.realData.percentage : (record.percentage || 0);
                                const duration = record.realData ? record.realData.duration : (record.duration || 0);

                                return {
                                    id: record.id || record.timestamp || Date.now(),
                                    examId: record.examId || '',
                                    title: record.title || record.examName || '未命名练习',
                                    type: record.type || getExamTypeFromCategory(record.category),
                                    category: record.category || getExamCategoryFromType(record.type),
                                    frequency: record.frequency || 'medium',
                                    score: score,
                                    duration: duration,
                                    date: record.date || (record.timestamp ? new Date(record.timestamp).toISOString() : new Date().toISOString()),
                                    timestamp: record.timestamp || record.id || Date.now(),
                                    realData: record.realData || null,
                                    dataSource: record.dataSource || 'imported'
                                };
                            });

                            practiceRecords = importedRecords;
                            await savePracticeRecordsToStorage(practiceRecords);
                            importedRecordCount = importedRecords.length;
                        }

                        // Handle exam index data from exported format
                        if (data.data && data.data['exam_system_exam_index'] && data.data['exam_system_exam_index'].data) {
                            console.log('Found exam_system_exam_index:', data.data['exam_system_exam_index'].data.length);
                            const importedExams = data.data['exam_system_exam_index'].data.map(exam => ({
                                id: exam.id,
                                title: exam.title,
                                type: exam.type || getExamTypeFromCategory(exam.category),
                                category: exam.category,
                                frequency: exam.frequency,
                                hasHtml: exam.hasHtml,
                                hasPdf: exam.hasPdf,
                                path: exam.path,
                                filename: exam.filename,
                                pdfFilename: exam.pdfFilename,
                                questionCount: exam.questionCount || 14 // Default question count
                            }));

                            examIndex = importedExams;
                            await saveExamIndexToStorage(examIndex);
                            importedExamCount = importedExams.length;
                        }
                        // Fallback to direct format
                        else if (data.examIndex) {
                            examIndex = data.examIndex;
                            await saveExamIndexToStorage(examIndex);
                            importedExamCount = examIndex.length;
                        }

                        // Fallback to direct practice records format
                        if (data.practiceRecords) {
                            practiceRecords = data.practiceRecords;
                            await savePracticeRecordsToStorage(practiceRecords);
                            importedRecordCount = practiceRecords.length;
                        }

                        console.log('Import results:', {
                            examCount: importedExamCount,
                            recordCount: importedRecordCount,
                            totalExams: examIndex.length,
                            totalRecords: practiceRecords.length
                        });

                        updateOverview();
                        updateBrowseView();
                        updatePracticeView();

                        showMessage(`成功导入 ${importedExamCount} 道题目和 ${importedRecordCount} 条练习记录`, 'success');
                    } catch (error) {
                        console.error('Import error:', error);
                        showMessage('导入失败: ' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function exportAllData() {
            createBackup(); // Reuse backup function
        }

        function exportPracticeData() {
            const data = {
                exportId: `${Date.now()}_${Math.random().toString(36).substring(2, 10)}`,
                timestamp: new Date().toISOString(),
                version: "1.0.0",
                data: {
                    practice_records: practiceRecords.map(record => ({
                        id: record.id,
                        examId: record.examId,
                        title: record.title,
                        category: record.category || getExamCategoryFromType(record.type),
                        frequency: record.frequency || 'medium',
                        realData: {
                            score: record.score,
                            totalQuestions: record.realData ? record.realData.totalQuestions : 14,
                            accuracy: record.score / 100,
                            percentage: record.score,
                            duration: record.duration,
                            answers: record.realData ? record.realData.answers : {},
                            correctAnswers: record.realData ? record.realData.correctAnswers : {},
                            interactions: record.realData ? record.realData.interactions : [],
                            isRealData: true,
                            source: "academic_system_export"
                        }
                    })),
                    exam_system_exam_index: {
                        data: examIndex,
                        timestamp: Date.now(),
                        version: "1.0.0"
                    }
                }
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ielts_data_export_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showMessage(`已导出 ${practiceRecords.length} 条练习记录和 ${examIndex.length} 道题目`, 'success');
        }

        async function clearPracticeData() {
            if (confirm('确定要清除所有练习记录吗？此操作不可撤销！')) {
                practiceRecords = [];
                await clearSharedKey(STORAGE_KEYS.PRACTICE);
                updatePracticeView();
                updateOverview();
                showMessage('记录已清除', 'success');
            }
        }

        function showSystemInfo() {
            const info = `
IELTS 学术练习管理系统
=======================================
系统版本: 1.0.0
构建时间: ${new Date().toLocaleString('zh-CN')}

题库信息:
- 总题目数: ${examIndex.length}
- 阅读题目: ${examIndex.filter(e => e.type === 'reading').length}
- 听力题目: ${examIndex.filter(e => e.type === 'listening').length}

学习统计:
- 练习记录: ${practiceRecords.length}
- 总学习时长: ${Math.round(practiceRecords.reduce((sum, r) => sum + (r.duration || 0), 0) / 60)} 分钟
- 平均分数: ${practiceRecords.length > 0 ? Math.round(practiceRecords.reduce((sum, r) => sum + (r.score || 0), 0) / practiceRecords.length) : 0}%

浏览器信息:
- User Agent: ${navigator.userAgent}
- 语言: ${navigator.language}
- 平台: ${navigator.platform}

存储信息:
- LocalStorage: ${(JSON.stringify(localStorage).length / 1024).toFixed(2)} KB
- SessionStorage: ${(JSON.stringify(sessionStorage).length / 1024).toFixed(2)} KB
            `;

            alert(info);
        }

        function showUsageStatistics() {
            showMessage('详细使用统计功能开发中...', 'info');
        }

        // Show message function
        function showMessage(message, type = 'info', duration = 3000) {
            const messageContainer = document.getElementById('message-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;

            const iconMap = {
                'success': 'fas fa-check-circle',
                'error': 'fas fa-exclamation-circle',
                'warning': 'fas fa-exclamation-triangle',
                'info': 'fas fa-info-circle'
            };

            const icon = iconMap[type] || 'fas fa-info-circle';

            messageDiv.innerHTML = `
                <i class="${icon} message-icon"></i>
                <div class="message-content">
                    <div class="message-title">${message}</div>
                </div>
            `;

            messageContainer.appendChild(messageDiv);

            // Auto-remove after duration
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.style.animation = 'slideIn 0.3s ease-out reverse';
                    setTimeout(() => {
                        if (messageDiv.parentNode) {
                            messageDiv.parentNode.removeChild(messageDiv);
                        }
                    }, 300);
                }
            }, duration);
        }

        // Sync practice records with storage - 添加防重复调用
        window._syncInProgress = false;
        async function syncPracticeRecords() {
            // 防止重复同步
            if (window._syncInProgress) {
                console.log('[Sync] 同步已在进行中，跳过重复调用');
                return;
            }
            window._syncInProgress = true;

            try {
                const rawRecords = await getPracticeRecordsFromStorage();
                const records = Array.isArray(rawRecords) ? rawRecords : [];

                // Ensure records have the required fields
                practiceRecords = records.map(record => ({
                    id: record.id || record.timestamp || Date.now(),
                    examId: record.examId || '',
                    title: record.title || record.examName || '未命名练习',
                    type: record.type || 'reading',
                    score: record.score || (record.realData ? record.realData.percentage : 0),
                    duration: record.duration || (record.realData ? record.realData.duration : 0),
                    date: record.date || (record.timestamp ? new Date(record.timestamp).toISOString() : new Date().toISOString()),
                    timestamp: record.timestamp || record.id || Date.now(),
                    realData: record.realData || null
                }));

                await savePracticeRecordsToStorage(practiceRecords);

                updatePracticeView();
                updateOverview();
            } catch (error) {
                console.error('Failed to sync practice records:', error);
                practiceRecords = [];
            } finally {
                window._syncInProgress = false;
            }
        }

        // Listen for practice completion messages
        window.addEventListener('message', function(event) {
            if (event.data && (event.data.type === 'PRACTICE_COMPLETE' || event.data.type === 'practice_completed')) {
                showMessage('练习已完成，正在更新记录...', 'success');
                setTimeout(syncPracticeRecords, 1000);
            }
        });

        window.addEventListener('storage-sync', (event) => {
            console.log('[Theme] 收到存储同步事件，正在更新练习记录...', event.detail);
            syncPracticeRecords();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case '1':
                        e.preventDefault();
                        showView('overview');
                        break;
                    case '2':
                        e.preventDefault();
                        showView('browse');
                        break;
                    case '3':
                        e.preventDefault();
                        showView('practice');
                        break;
                    case '4':
                        e.preventDefault();
                        showView('settings');
                        break;
                    case 's':
                        if (e.shiftKey) {
                            e.preventDefault();
                            createBackup();
                        }
                        break;
                }
            }
        });

        // Auto-save functionality
        setInterval(() => {
            if (practiceRecords.length > 0) {
                savePracticeRecordsToStorage(practiceRecords).catch(e => console.warn('[StorageBridge] Auto-save failed:', e));
            }
        }, 30000); // Auto-save every 30 seconds

        // Handle window unload
        window.addEventListener('beforeunload', function(e) {
            if (practiceRecords.length > 0) {
                savePracticeRecordsToStorage(practiceRecords);
            }
        });

        // Initialize on page load
        window.addEventListener('load', function() {
            console.log('IELTS Academic Practice System initialized');
            showMessage('系统就绪', 'success');
        });
    </script>

    <!-- 页面增强脚本（仅适配本题 HTML，不修改库文件） -->
    <script>
    (function(){
        // 保障兼容：全局集合（若未定义则创建）
        if (!window.selectedRecordIds) window.selectedRecordIds = new Set();

        // 1) 查看详情：调用现有 PracticeRecordModal 显示弹窗
        window.viewRecordDetails = async function(recordId) {
            try {
                if (window.practiceRecordModal && typeof window.practiceRecordModal.showById === 'function') {
                    window.practiceRecordModal.showById(recordId);
                } else if (window.practiceHistoryEnhancer && typeof window.practiceHistoryEnhancer.showRecordDetails === 'function') {
                    window.practiceHistoryEnhancer.showRecordDetails(recordId);
                } else {
                    var recs = await getPracticeRecordsFromStorage();
                    if (!Array.isArray(recs)) recs = [];
                    var r = recs.find(function(x){ return String(x.id||x.timestamp) === String(recordId); });
                    alert(r ? ('题目：' + (r.title||'未知') + '\n分数：' + (r.score||0) + '%\n用时：' + (r.duration||0) + '秒') : '记录不存在');
                }
            } catch (e) {
                console.error('[viewRecordDetails] 失败:', e);
                if (window.showMessage) window.showMessage('无法显示记录详情: ' + e.message, 'error');
            }
        };

        // 2) 注入选择列（用于批量删除）
        window.decoratePracticeTableForSelection = function() {
            try {
                var tbody = document.getElementById('practice-records-tbody');
                if (!tbody) return;
                var rows = Array.prototype.slice.call(tbody.querySelectorAll('tr'));
                rows.forEach(function(row){
                    var firstCell = row.children[0];
                    var hasCheckbox = firstCell && firstCell.querySelector && firstCell.querySelector('input.record-select');
                    if (hasCheckbox) return;
                    // 从“查看”按钮中提取 recordId
                    var actionBtn = row.querySelector('button[onclick^="viewRecordDetails("]');
                    var recordId = '';
                    if (actionBtn) {
                        var oc = actionBtn.getAttribute('onclick') || '';
                        var m = oc.match(/viewRecordDetails\(['\"](.+?)['\"]\)/);
                        if (m) recordId = m[1];
                    }
                    var cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.className = 'record-select';
                    cb.setAttribute('data-id', recordId);
                    cb.checked = window.selectedRecordIds.has(String(recordId));
                    cb.onchange = function(){ window.onRecordCheckboxChange(cb); };
                    var td = document.createElement('td');
                    td.style.textAlign = 'center';
                    td.appendChild(cb);
                    row.insertBefore(td, row.firstChild);
                });
                window.syncSelectAllCheckboxState();
            } catch (e) { console.warn('[SelectionDecor] 渲染失败:', e); }
        };

        window.onRecordCheckboxChange = function(el){
            var id = String(el.getAttribute('data-id'));
            if (el.checked) window.selectedRecordIds.add(id); else window.selectedRecordIds.delete(id);
            window.syncSelectAllCheckboxState();
        };

        window.toggleSelectAll = function(master){
            var check = !!master.checked;
            var cbs = document.querySelectorAll('#practice-records-tbody .record-select');
            Array.prototype.forEach.call(cbs, function(cb){
                cb.checked = check;
                var id = String(cb.getAttribute('data-id'));
                if (check) window.selectedRecordIds.add(id); else window.selectedRecordIds.delete(id);
            });
            window.syncSelectAllCheckboxState();
        };

        window.syncSelectAllCheckboxState = function(){
            var cbs = Array.prototype.slice.call(document.querySelectorAll('#practice-records-tbody .record-select'));
            var master = document.getElementById('select-all-records');
            if (!master) return;
            if (cbs.length === 0) { master.checked = false; master.indeterminate = false; return; }
            var checkedCount = cbs.filter(function(cb){ return cb.checked; }).length;
            master.checked = checkedCount === cbs.length;
            master.indeterminate = checkedCount > 0 && checkedCount < cbs.length;
        };

        window.batchDeleteSelected = async function(){
            var ids = Array.from(window.selectedRecordIds || []);
            if (ids.length === 0) { try { showMessage('请先选择要删除的记录', 'warning'); } catch(_) {} return; }
            if (!confirm('确定要删除选中的 ' + ids.length + ' 条记录吗？此操作不可撤销。')) return;
            try {
                var list = await getPracticeRecordsFromStorage();
                if (!Array.isArray(list)) list = [];
                var idSet = new Set(ids.map(String));
                list = list.filter(function(r){ return !idSet.has(String(r.id||r.timestamp)); });
                await savePracticeRecordsToStorage(list);
                if (window.practiceRecords) window.practiceRecords = list;
            } catch (e) { console.warn('[BatchDelete] 本地存储更新失败:', e); }
            window.selectedRecordIds.clear();
            try { updatePracticeView(); } catch(_) {}
            try { updateOverview(); } catch(_) {}
            try { showMessage('已删除选中记录', 'success'); } catch(_) {}
        };

        // 3) 增强导入：兼容 exam_system_practice_records 结构
        (function(){
            var originalImport = window.importData;
            window.importData = function(){
                var input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = function(e){
                    var file = e.target.files[0]; if (!file) return;
                    var reader = new FileReader();
                    reader.onload = async function(ev){
                        try {
                            var data = JSON.parse(ev.target.result);
                            var importedExamCount = 0, importedRecordCount = 0;

                            function mapRecord(r){
                                var pct = null;
                                if (r.percentage != null) pct = r.percentage;
                                else if (r.realData && r.realData.percentage != null) pct = r.realData.percentage;
                                else if (r.accuracy != null) pct = Math.round(Number(r.accuracy)*100);
                                else if (r.realData && r.realData.accuracy != null) pct = Math.round(Number(r.realData.accuracy)*100);
                                else if (r.score != null && r.totalQuestions) pct = Math.round((Number(r.score)/Number(r.totalQuestions))*100);
                                var dur = r.duration || (r.realData && r.realData.duration) || (r.endTime && r.startTime ? Math.max(0, Math.floor((new Date(r.endTime)-new Date(r.startTime))/1000)) : 0);
                                var dateStr = r.date || (r.timestamp ? new Date(r.timestamp).toISOString() : (r.endTime || r.startTime || new Date().toISOString()));
                                var rd = r.realData || null;
                                if (!rd) {
                                    rd = {
                                        score: r.score != null ? r.score : null,
                                        totalQuestions: r.totalQuestions || (r.scoreInfo && r.scoreInfo.total) || null,
                                        accuracy: (r.accuracy != null ? r.accuracy : (pct != null ? pct/100 : null)),
                                        percentage: pct != null ? pct : null,
                                        duration: dur,
                                        answers: r.answers || (r.scoreInfo && r.scoreInfo.details ? Object.fromEntries(Object.entries(r.scoreInfo.details).map(function(ent){ return [ent[0], (ent[1]&&ent[1].userAnswer)]; })) : {}),
                                        correctAnswers: (r.realData && r.realData.correctAnswers) || (r.scoreInfo && r.scoreInfo.details ? Object.fromEntries(Object.entries(r.scoreInfo.details).map(function(ent){ return [ent[0], (ent[1]&&ent[1].correctAnswer)]; })) : {}),
                                        interactions: r.interactions || [],
                                        isRealData: true,
                                        source: r.dataSource || 'imported'
                                    };
                                }
                                return {
                                    id: r.id || r.timestamp || Date.now(),
                                    examId: r.examId || '',
                                    title: r.title || r.examName || '未命名练习',
                                    type: r.type || (typeof getExamTypeFromCategory === 'function' ? getExamTypeFromCategory(r.category) : 'reading'),
                                    category: r.category || (typeof getExamCategoryFromType === 'function' ? getExamCategoryFromType(r.type) : 'P1'),
                                    frequency: r.frequency || 'medium',
                                    score: pct || 0,
                                    duration: dur,
                                    date: dateStr,
                                    timestamp: r.timestamp || r.id || Date.now(),
                                    realData: rd,
                                    dataSource: r.dataSource || 'imported'
                                };
                            }

                            // exam index sources
                            if (data && data.data && data.data.exam_system_exam_index && Array.isArray(data.data.exam_system_exam_index.data)) {
                                try { await saveExamIndexToStorage(data.data.exam_system_exam_index.data); importedExamCount = data.data.exam_system_exam_index.data.length; } catch(_) {}
                            } else if (data && data.exam_system_exam_index && Array.isArray(data.exam_system_exam_index.data)) {
                                try { await saveExamIndexToStorage(data.exam_system_exam_index.data); importedExamCount = data.exam_system_exam_index.data.length; } catch(_) {}
                            } else if (Array.isArray(data.exam_index)) {
                                try { await saveExamIndexToStorage(data.exam_index); importedExamCount = data.exam_index.length; } catch(_) {}
                            }

                            // practice records sources
                            var importedRecords = null;
                            if (Array.isArray(data.practice_records)) {
                                importedRecords = data.practice_records.map(mapRecord);
                            } else if (data && data.data && Array.isArray(data.data.practice_records)) {
                                importedRecords = data.data.practice_records.map(mapRecord);
                            } else if (data && data.exam_system_practice_records && Array.isArray(data.exam_system_practice_records.data)) {
                                importedRecords = data.exam_system_practice_records.data.map(mapRecord);
                            } else if (Array.isArray(data.practiceRecords)) {
                                importedRecords = data.practiceRecords.map(mapRecord);
                            }

                            if (importedRecords) {
                                await savePracticeRecordsToStorage(importedRecords);
                                if (window.practiceRecords) window.practiceRecords = importedRecords;
                                importedRecordCount = importedRecords.length;
                            }

                            try { updateOverview(); } catch(_) {}
                            try { updateBrowseView(); } catch(_) {}
                            try { updatePracticeView(); } catch(_) {}
                            try { showMessage('成功导入 ' + importedExamCount + ' 道题目和 ' + importedRecordCount + ' 条练习记录', 'success'); } catch(_) {}
                        } catch (err) {
                            console.error('[Import] 失败:', err);
                            if (window.showMessage) window.showMessage('导入失败: ' + err.message, 'error');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            };
        })();

        // 4) 主题切换弹窗
        window.showThemeSwitcher = function(){
            /*
            var html = '\
            <div id="theme-switcher" class="modal-overlay show">\
              <div class="modal-container" style="max-width:560px;">\
                <div class="modal-header">\
                  <h3 class="modal-title"><i class="fas fa-palette"></i> 主题切换</h3>\
                  <button class="modal-close" onclick="document.getElementById(\'theme-switcher\').remove()"><i class="fas fa-times"></i></button>\
                </div>\
                <div class="modal-body">\
                  <div style="display:grid;gap:12px;">\
                    <div style="border:1px solid var(--color-gray-200);border-radius:8px;padding:12px;background:var(--color-gray-50);display:flex;justify-content:space-between;align-items:center;">\
                      <div>\
                        <div style="color:var(--color-primary);font-weight:600;">Academic（专业  高效  可靠）</div>\
                        <div style="color:var(--color-gray-600);font-size:0.9rem;">当前主题</div>\
                      </div>\
                      <span class="score-badge score-good">当前</span>\
                    </div>\
                    <div style="border:1px solid var(--color-gray-200);border-radius:8px;padding:12px;display:flex;justify-content:space-between;align-items:center;">\
                      <div>\
                        <div style="color:#a16207;font-weight:600;">Bloom（秋日  暖阳）</div>\
                        <div style="color:var(--color-gray-600);font-size:0.9rem;">温暖配色，适合放松阅读</div>\
                      </div>\
                      <button class="btn btn-primary" onclick="navigateToThemePortal('../../index.html', { label: 'Bloom', theme: 'bloom' })">切换</button>\
                    </div>\
                  </div>\
                </div>\
                <div class="modal-footer">\
                  <button class="btn btn-secondary" onclick="document.getElementById(\'theme-switcher\').remove()">关闭</button>\
                </div>\
              </div>\
            </div>';
            document.body.insertAdjacentHTML('beforeend', html);
        */
        };

        // 4) 主题切换弹窗
        window.showThemeSwitcher = function(){
            const html = `
            <div id="theme-switcher" class="modal-overlay show">
              <div class="modal-container">
                <div class="modal-header">
                  <h3 class="modal-title">
                    <i class="fas fa-palette" style="margin-right: var(--space-3);"></i>
                    主题切换
                  </h3>
                </div>
                <div class="modal-body">
                  <div class="theme-description">
                    <p><i class="fas fa-info-circle" style="color: var(--color-primary); margin-right: var(--space-2);"></i>
                    选择您喜欢的主题风格，不同的主题提供不同的视觉体验和学习氛围。</p>
                  </div>
                  <div class="theme-card active">
                    <div class="theme-info">
                      <div class="theme-details">
                        <h4><i class="fas fa-graduation-cap" style="margin-right: var(--space-2);"></i>Academic</h4>
                        <p>专业 · 高效 · 可靠<br>
                        <span style="color: var(--color-gray-500); font-size: var(--font-size-xs);">深蓝配色，适合专注学习和专业训练</span></p>
                      </div>
                      <div class="theme-actions">
                        <span class="current-badge">当前主题</span>
                      </div>
                    </div>
                  </div>
                  <div class="theme-card">
                    <div class="theme-info">
                      <div class="theme-details">
                        <h4><i class="fas fa-leaf" style="margin-right: var(--space-2); color: #a16207;"></i>Bloom</h4>
                        <p>秋日 · 暖阳 · 温馨<br>
                        <span style="color: var(--color-gray-500); font-size: var(--font-size-xs);">温暖配色，适合放松阅读</span></p>
                      </div>
                      <div class="theme-actions">
                        <button class="btn btn-primary" onclick="navigateToThemePortal('../../index.html', { label: 'Bloom', theme: 'bloom' })">
                          <i class="fas fa-exchange-alt" style="margin-right: var(--space-2);"></i>
                          切换主题
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="theme-card">
                    <div class="theme-info">
                      <div class="theme-details">
                        <h4><i class="fas fa-heart" style="margin-right: var(--space-2); color: #ec4899;"></i>Melody</h4>
                        <p>美乐蒂 · 可爱 · 温馨<br>
                        <span style="color: var(--color-gray-500); font-size: var(--font-size-xs);">粉色主题，温馨学习体验</span></p>
                      </div>
                      <div class="theme-actions">
                        <button class="btn btn-primary" onclick="navigateToThemePortal('../../.superdesign/design_iterations/my_melody_ielts_1.html', { label: 'MyMelody', theme: 'mymelody' })">
                          <i class="fas fa-exchange-alt" style="margin-right: var(--space-2);"></i>
                          切换主题
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="theme-card">
                    <div class="theme-info">
                      <div class="theme-details">
                        <h4><i class="fas fa-home" style="margin-right: var(--space-2); color: #3b82f6;"></i>主页</h4>
                        <p>主页面 · 综合功能<br>
                        <span style="color: var(--color-gray-500); font-size: var(--font-size-xs);">返回主页面，包含所有功能</span></p>
                      </div>
                      <div class="theme-actions">
                        <button class="btn btn-primary" onclick="navigateToThemePortal('../../index.html', { label: 'Bloom', theme: 'bloom' })">
                          <i class="fas fa-exchange-alt" style="margin-right: var(--space-2);"></i>
                          切换主题
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="theme-card">
                    <div class="theme-info">
                      <div class="theme-details">
                        <h4>🧙 HarryPotter</h4>
                        <p>哈利波特<br>
                        <span style="color: var(--color-gray-500); font-size: var(--font-size-xs);">深紫配色 · 冒险</span></p>
                      </div>
                      <div class="theme-actions">
                        <button class="btn btn-primary" aria-label="哈利波特主题（冒险）" onclick="navigateToThemePortal('../../.superdesign/design_iterations/HarryPoter.html', { label: 'HarryPotter', theme: 'harry' })">
                          <i class="fas fa-exchange-alt" style="margin-right: var(--space-2);"></i>
                          切换主题
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="modal-footer">
                  <button class="btn btn-secondary" onclick="document.getElementById('theme-switcher').remove()">
                    关闭
                  </button>
                </div>
              </div>
            </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
        };

        // —— 批量删除（行点击选择）实现 ——
        // 关闭旧的复选框装饰逻辑
        window.decoratePracticeTableForSelection = function(){};

        // 切换批量删除模式
        window.bulkDeleteAction = async function(){
            if (!window.bulkDeleteMode) {
                setBulkDeleteMode(true);
                try { showMessage('点击记录行可选择；完成后再次点击完成选择', 'info'); } catch(_) {}
            } else {
                // 完成选择 -> 执行删除
                const ids = Array.from(selectedRecordIds || []);
                if (ids.length === 0) { setBulkDeleteMode(false); return; }
                try {
                    let list = await getPracticeRecordsFromStorage();
                    if (!Array.isArray(list)) list = [];
                    const setIds = new Set(ids.map(String));
                    list = list.filter(r => !setIds.has(String(r.id||r.timestamp)));
                    await savePracticeRecordsToStorage(list);
                    if (window.practiceRecords) window.practiceRecords = list;
                } catch(e) { console.warn('[BulkDelete] 更新存储失败:', e); }
                selectedRecordIds.clear();
                try { updatePracticeView(); } catch(_) {}
                try { updateOverview(); } catch(_) {}
                setBulkDeleteMode(false);
                try { showMessage('已删除所选记录', 'success'); } catch(_) {}
            }
        };

        function setBulkDeleteMode(on) {
            window.bulkDeleteMode = !!on;
            const pv = document.getElementById('practice-view');
            if (pv) pv.classList.toggle('bulk-mode', window.bulkDeleteMode);
            updateBulkDeleteButton();
        }

        function updateBulkDeleteButton() {
            const btn = document.getElementById('bulk-delete-btn');
            if (!btn) return;
            if (window.bulkDeleteMode) {
                btn.innerHTML = '<i class="fas fa-check"></i> 完成选择';
            } else {
                btn.innerHTML = '<i class="fas fa-trash"></i> 批量删除';
            }
        }

        // 行点击选择（仅在批量模式下有效），避开“查看”按钮
        (function setupRecordRowClick(){
            const tbody = document.getElementById('practice-records-tbody');
            if (!tbody) return;
            tbody.addEventListener('click', function(e){
                if (!window.bulkDeleteMode) return;
                const btn = e.target.closest && e.target.closest('button');
                if (btn) return; // 不干扰“查看”
                const row = e.target.closest && e.target.closest('tr');
                if (!row) return;
                let id = '';
                try {
                    const actionBtn = row.querySelector('button[onclick^="viewRecordDetails("]');
                    const oc = actionBtn && actionBtn.getAttribute('onclick');
                    const m = oc && oc.match(/viewRecordDetails\(['\"](.+?)['\"]\)/);
                    if (m) id = m[1];
                } catch(_) {}
                if (!id) return;
                const key = String(id);
                if (selectedRecordIds.has(key)) { selectedRecordIds.delete(key); row.classList.remove('selected'); }
                else { selectedRecordIds.add(key); row.classList.add('selected'); }
            });

            // 监听渲染变化，补上行类名并同步选中状态
            const mo = new MutationObserver(() => {
                const rows = Array.from(tbody.querySelectorAll('tr'));
                rows.forEach(row => {
                    row.classList.add('record-row');
                    // 同步选中样式
                    try {
                        const actionBtn = row.querySelector('button[onclick^="viewRecordDetails("]');
                        const oc = actionBtn && actionBtn.getAttribute('onclick');
                        const m = oc && oc.match(/viewRecordDetails\(['\"](.+?)['\"]\)/);
                        const id = m ? String(m[1]) : '';
                        if (id && selectedRecordIds.has(id)) row.classList.add('selected'); else row.classList.remove('selected');
                    } catch(_) {}
                });
            });
            mo.observe(tbody, { childList: true });
            // 首次同步
            setTimeout(() => mo.takeRecords() && null, 0);
        })();

        // 题库打开回退：将 startExam 委托到 openExam
        (function ensureStartExamDelegates(){
            try {
                if (!window.startExam || !window.startExam.__designPatched) {
                    const original = window.startExam;
                    window.startExam = function(examId){
                        if (typeof window.openExam === 'function') return window.openExam(examId);
                        if (typeof original === 'function') return original(examId);
                        try { showMessage('无法打开题目：未找到 openExam', 'error'); } catch(_) {}
                    };
                    window.startExam.__designPatched = true;
                }
            } catch(_) {}
        })();

        // 5) 默认进首页“学习总览”
        try { showView('overview'); } catch(_) {}

        // 6) 监听表格变化，首次装饰
        try {
            var tbody = document.getElementById('practice-records-tbody');
            if (tbody) {
                var observer = new MutationObserver(function(){ decoratePracticeTableForSelection(); });
                observer.observe(tbody, { childList: true });
                setTimeout(decoratePracticeTableForSelection, 0);
            }
        } catch (e) { console.warn('[SelectionDecor] 初始化失败:', e); }
    })();
    </script>
<script>
// 修复函数 - 确保在页面加载早期就可用
function safeGetRecords() {
    if (hasSharedStorage()) {
        try {
            window.storage.get('practice_records', []).then(function(list){
                if (Array.isArray(list)) {
                    try { localStorage.setItem('practice_records', JSON.stringify(list)); } catch (_) {}
                }
            }).catch(function(err){ console.warn('[Fix] storage.get async sync failed:', err); });
        } catch (e) {
            console.warn('[Fix] storage.get failed:', e);
        }
    }
    try {
        return JSON.parse(localStorage.getItem('practice_records') || '[]');
    } catch (e) {
        console.warn('[Fix] localStorage fallback failed:', e);
        return [];
    }
}

function safeSetRecords(list) {
    savePracticeRecordsToStorage(list || []).then(() => {
        console.log('[Fix] Records saved via StorageBridge');
    }).catch(e => {
        console.error('[Fix] All storage methods failed:', e);
    });
}

function normalizeRecord(r) {
    var exam = (Array.isArray(window.examIndex) ? window.examIndex.find(e => String(e.id) === String(r.examId)) : null) || {};
    var percent = (typeof r.accuracy === 'number') ? Math.round(r.accuracy * 100) : (r.score || (r.realData && r.realData.percentage) || 0);
    var dur = r.duration || (r.realData && r.realData.duration) || 0;
    var when = r.endTime || r.createdAt || r.date || r.timestamp || Date.now();
    var title = (r.metadata && r.metadata.examTitle) || r.title || r.examName || exam.title || '未命名练习';
    var type = exam.type || r.type || (typeof getExamTypeFromCategory === 'function' ? getExamTypeFromCategory((r.metadata && r.metadata.category) || r.category) : 'reading');
    return {
        id: r.id || r.timestamp || Date.now(),
        examId: r.examId || '',
        title: title,
        type: type,
        score: percent,
        duration: dur,
        date: new Date(when).toISOString(),
        timestamp: when,
        realData: r.realData || null
    };
}

// 修复清除缓存功能
window.fixedClearCache = async function() {
    console.log('[Fix] fixedClearCache called');
    if (!confirm('确定要清除所有缓存数据吗？此操作不可撤销！')) return;

    try {
        await clearSharedNamespace();
        console.log('[Fix] Storage cleared via StorageBridge');
    } catch (e) {
        console.error('[Fix] Error clearing storage:', e);
    }

    // 确保练习记录被清空
    safeSetRecords([]);
    console.log('[Fix] Practice records cleared');

    // 显示消息
    try {
        if (typeof showMessage === 'function') {
            showMessage('缓存已清除', 'success');
        }
    } catch (e) {
        console.warn('[Fix] showMessage failed:', e);
    }

    // 立即重建题库索引，避免"题目不存在"
    try {
        if (typeof loadLibrary === 'function') {
            loadLibrary(true);
            console.log('[Fix] Library reloaded');
        }
    } catch (e) {
        console.warn('[Fix] loadLibrary failed:', e);
    }

    // 刷新练习记录视图
    setTimeout(function() {
        try {
            if (typeof syncPracticeRecords === 'function') {
                syncPracticeRecords();
                console.log('[Fix] Practice records synced');
            }
        } catch (e) {
            console.warn('[Fix] syncPracticeRecords failed:', e);
        }
    }, 200);
};

// 修复强制刷新题库功能
window.forceReloadLibrary = function() {
    console.log('[Fix] forceReloadLibrary called');
    try {
        if (typeof loadLibrary === 'function') {
            loadLibrary(true);
            console.log('[Fix] Library force reloaded');
            if (typeof showMessage === 'function') {
                showMessage('题库已强制刷新', 'success');
            }
        }
    } catch (e) {
        console.error('[Fix] forceReloadLibrary failed:', e);
    }
};

// 修复练习记录同步功能
window.fixedSyncPracticeRecords = function() {
    console.log('[Fix] fixedSyncPracticeRecords called');
    try {
        var records = safeGetRecords();
        console.log('[Fix] Found', records.length, 'records');
        window.practiceRecords = (records || []).map(normalizeRecord);

        if (typeof updatePracticeView === 'function') {
            updatePracticeView();
            console.log('[Fix] Practice view updated');
        }

        try {
            if (typeof updateOverview === 'function') {
                updateOverview();
            }
        } catch (e) {
            console.warn('[Fix] updateOverview failed:', e);
        }
    } catch (e) {
        console.error('[Fix] fixedSyncPracticeRecords error:', e);
        window.practiceRecords = [];
    }
};

// 修复批量删除功能
window.fixedBulkDeleteAction = function() {
    console.log('[Fix] fixedBulkDeleteAction called');
    if (!window.bulkDeleteMode) {
        console.log('[Fix] Not in bulk delete mode');
        return;
    }

    var ids = Array.from((window.selectedRecordIds || new Set())).map(String);
    console.log('[Fix] Deleting records:', ids);

    if (ids.length === 0) {
        console.log('[Fix] No records selected for deletion');
        return;
    }

    var list = safeGetRecords();
    var setIds = new Set(ids);
    var newList = (list || []).filter(r => !setIds.has(String(r.id || r.timestamp)));

    console.log('[Fix] Records before:', list.length, 'after:', newList.length);

    safeSetRecords(newList);

    // 同步内存并刷新
    try {
        window.practiceRecords = (window.practiceRecords || []).filter(r => !setIds.has(String(r.id || r.timestamp)));
    } catch (e) {
        console.warn('[Fix] Error updating memory records:', e);
    }

    try {
        if (typeof updatePracticeView === 'function') {
            updatePracticeView();
        }
    } catch (e) {
        console.warn('[Fix] updatePracticeView failed:', e);
    }

    try {
        if (typeof updateOverview === 'function') {
            updateOverview();
        }
    } catch (e) {
        console.warn('[Fix] updateOverview failed:', e);
    }

    try {
        (window.selectedRecordIds || new Set()).clear();
    } catch (e) {
        console.warn('[Fix] Error clearing selected IDs:', e);
    }

    window.bulkDeleteMode = false;
    var btn = document.getElementById('bulk-delete-btn');
    if (btn) {
        btn.innerHTML = '<i class="fas fa-trash"></i> 批量删除';
    }

    try {
        showMessage('删除成功', 'success');
    } catch (e) {
        console.warn('[Fix] showMessage failed:', e);
    }
};

// 覆盖原有函数
console.log('[Fix] Applying function overrides...');

// 等待DOM加载完成后覆盖原有函数
document.addEventListener('DOMContentLoaded', function() {
    console.log('[Fix] DOM loaded, applying overrides...');

    // 覆盖练习记录同步
    if (typeof window.syncPracticeRecords === 'function') {
        window.syncPracticeRecords = window.fixedSyncPracticeRecords;
        console.log('[Fix] syncPracticeRecords overridden');
    }

    // 覆盖清除缓存
    if (typeof window.clearCache === 'function') {
        window.clearCache = window.fixedClearCache;
        console.log('[Fix] clearCache overridden');
    }

    // 覆盖批量删除
    if (typeof window.bulkDeleteAction === 'function') {
        window.bulkDeleteAction = window.fixedBulkDeleteAction;
        console.log('[Fix] bulkDeleteAction overridden');
    }

    // 立即同步一次练习记录
    setTimeout(function() {
        try {
            window.fixedSyncPracticeRecords();
        } catch (e) {
            console.warn('[Fix] Initial sync failed:', e);
        }
    }, 500);
});

// 如果DOMContentLoaded已经触发，立即执行
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', arguments.callee);
} else {
    console.log('[Fix] DOM already loaded, applying overrides immediately...');

    // 覆盖练习记录同步
    if (typeof window.syncPracticeRecords === 'function') {
        window.syncPracticeRecords = window.fixedSyncPracticeRecords;
        console.log('[Fix] syncPracticeRecords overridden (immediate)');
    }

    // 覆盖清除缓存
    if (typeof window.clearCache === 'function') {
        window.clearCache = window.fixedClearCache;
        console.log('[Fix] clearCache overridden (immediate)');
    }

    // 覆盖批量删除
    if (typeof window.bulkDeleteAction === 'function') {
        window.bulkDeleteAction = window.fixedBulkDeleteAction;
        console.log('[Fix] bulkDeleteAction overridden (immediate)');
    }

    // 立即同步一次练习记录
    setTimeout(function() {
        try {
            window.fixedSyncPracticeRecords();
        } catch (e) {
            console.warn('[Fix] Initial sync failed:', e);
        }
    }, 500);
}
</script>
</body>

</html>
