<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>IELTS é˜…è¯»ç»ƒä¹ å ä½é¡µ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        :root {
            color-scheme: light dark;
            --bg: #0f172a;
            --panel: #111827;
            --text: #e2e8f0;
            --muted: #94a3b8;
            --accent: #38bdf8;
            --success: #34d399;
            --warn: #facc15;
            --error: #f87171;
        }
        @media (prefers-color-scheme: light) {
            :root {
                --bg: #f8fafc;
                --panel: #ffffff;
                --text: #0f172a;
                --muted: #475569;
                --accent: #2563eb;
                --success: #16a34a;
                --warn: #ca8a04;
                --error: #dc2626;
            }
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: radial-gradient(circle at top, rgba(56,189,248,0.16), transparent 55%), var(--bg);
            color: var(--text);
        }
        header {
            padding: 24px clamp(24px, 5vw, 48px) 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }
        header::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(120deg, rgba(56,189,248,0.18), rgba(129,140,248,0.18));
            opacity: 0.6;
            pointer-events: none;
        }
        header h1 {
            margin: 0;
            font-weight: 600;
            font-size: clamp(20px, 2.6vw, 28px);
            letter-spacing: 0.02em;
            position: relative;
            z-index: 1;
        }
        header p {
            margin: 0;
            color: var(--muted);
            font-size: 15px;
            position: relative;
            z-index: 1;
        }
        main {
            flex: 1;
            display: grid;
            gap: clamp(20px, 4vw, 32px);
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            padding: clamp(24px, 5vw, 48px);
        }
        .panel {
            background: color-mix(in srgb, var(--panel) 92%, transparent);
            border: 1px solid color-mix(in srgb, var(--accent) 22%, transparent);
            border-radius: 18px;
            padding: clamp(20px, 3vw, 32px);
            display: flex;
            flex-direction: column;
            gap: 16px;
            box-shadow: 0 18px 60px rgba(15,23,42,0.28);
            position: relative;
            overflow: hidden;
        }
        .panel::before {
            content: '';
            position: absolute;
            inset: -120px 40% auto -60px;
            height: 220px;
            background: radial-gradient(circle, rgba(56,189,248,0.18), transparent 65%);
            transform: rotate(-8deg);
            pointer-events: none;
        }
        .panel h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            letter-spacing: 0.04em;
        }
        .meta-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
        }
        .meta-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 12px 14px;
            border-radius: 12px;
            background: color-mix(in srgb, var(--panel) 70%, transparent);
            border: 1px solid color-mix(in srgb, var(--accent) 15%, transparent);
        }
        .meta-label { font-size: 13px; color: var(--muted); }
        .meta-value { font-size: 16px; font-weight: 600; word-break: break-word; }
        .status {
            border-radius: 12px;
            padding: 14px 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: color-mix(in srgb, var(--accent) 12%, transparent);
            border: 1px solid color-mix(in srgb, var(--accent) 40%, transparent);
        }
        .status strong { font-size: 14px; letter-spacing: 0.04em; }
        .status span { font-size: 13px; color: var(--muted); }
        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }
        button {
            border: none;
            border-radius: 12px;
            font-size: 15px;
            padding: 12px 18px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.18s ease, filter 0.2s ease;
            color: #0f172a;
            background: linear-gradient(135deg, var(--accent), color-mix(in srgb, var(--accent) 55%, #f1f5f9));
            box-shadow: 0 12px 30px rgba(37, 99, 235, 0.25);
        }
        button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
            transform: none;
            box-shadow: none;
        }
        button:hover:not(:disabled) { transform: translateY(-1px); filter: brightness(1.04); }
        footer {
            padding: 16px 24px 28px;
            font-size: 12px;
            color: var(--muted);
            text-align: center;
        }
        .log-area {
            background: color-mix(in srgb, var(--panel) 78%, transparent);
            border-radius: 12px;
            padding: 12px 14px;
            font-size: 12px;
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            max-height: 160px;
            overflow: auto;
            border: 1px solid color-mix(in srgb, var(--accent) 18%, transparent);
        }
        .log-area div { margin-bottom: 4px; }
        .log-area .info { color: var(--accent); }
        .log-area .warn { color: var(--warn); }
        .log-area .error { color: var(--error); }
        .pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            background: color-mix(in srgb, var(--accent) 18%, transparent);
            color: var(--text);
            font-size: 12px;
            letter-spacing: 0.02em;
        }
    </style>
</head>
<body data-exam-id="" data-exam-state="initial">
<!-- ç¯å¢ƒæ£€æŸ¥è­¦å‘Šè¦†ç›–å±‚ -->
<div id="access-denied-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.95); color: #e2e8f0; z-index: 9999; align-items: center; justify-content: center; flex-direction: column; padding: 40px; text-align: center; font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'PingFang SC', 'Microsoft YaHei', sans-serif;">
    <div style="max-width: 600px; background: rgba(30, 41, 59, 0.9); border-radius: 16px; padding: 32px; border: 1px solid rgba(239, 68, 68, 0.3); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);">
        <div style="font-size: 48px; margin-bottom: 16px;">ğŸš«</div>
        <h1 style="margin: 0 0 16px; font-size: 24px; color: #fecaca; font-weight: 600;">è®¿é—®è¢«æ‹’ç»</h1>
        <p style="margin: 0 0 20px; color: #cbd5e1; line-height: 1.6;">æ­¤é¡µé¢æ˜¯ <strong>æµ‹è¯•ä¸“ç”¨é¡µé¢</strong>ï¼Œä¸¥ç¦åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è®¿é—®ã€‚</p>
        <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 16px; margin: 20px 0; text-align: left;">
            <h3 style="margin: 0 0 8px; font-size: 16px; color: #fca5a5;">é¡µé¢ä¿¡æ¯</h3>
            <ul style="margin: 0; padding-left: 20px; color: #94a3b8; font-size: 14px;">
                <li>æ–‡ä»¶: <code>templates/exam-placeholder.html</code></li>
                <li>ç”¨é€”: IELTS å¥—é¢˜ç»ƒä¹ å ä½é¡µ</li>
                <li>é™åˆ¶: ä»…é™æµ‹è¯•ç¯å¢ƒä½¿ç”¨</li>
            </ul>
        </div>
        <button onclick="window.close()" style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: none; border-radius: 8px; padding: 12px 24px; font-size: 14px; font-weight: 600; cursor: pointer; margin-top: 16px;">å…³é—­é¡µé¢</button>
        <p style="margin: 16px 0 0; font-size: 12px; color: #64748b;">å¦‚æœ‰ç–‘é—®ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿ</p>
    </div>
</div>
<header>
    <h1 id="exam-title">IELTS é˜…è¯»ç»ƒä¹ å ä½é¡µ</h1>
    <p id="exam-subtitle">å½“å‰é¢˜ç›®æ— æ³•åŠ è½½ï¼Œç³»ç»Ÿå·²åˆ‡æ¢åˆ°å ä½ç»ƒä¹ é¡µã€‚å®Œæˆç»ƒä¹ åå°†è‡ªåŠ¨è·³è½¬è‡³ä¸‹ä¸€ç¯‡ã€‚</p>
</header>
<main>
    <section class="panel">
        <h2>å½“å‰é¢˜ç›®ä¿¡æ¯</h2>
        <div class="meta-grid">
            <div class="meta-item">
                <span class="meta-label">é¢˜ç›®ç¼–å·</span>
                <span class="meta-value" id="meta-exam-id">-</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">å¥—é¢˜ç±»åˆ«</span>
                <span class="meta-value" id="meta-category">P1</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">ä¼šè¯ç¼–å·</span>
                <span class="meta-value" id="meta-session">ç­‰å¾…æ¡æ‰‹</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">å¥—é¢˜ä¼šè¯</span>
                <span class="meta-value" id="meta-suite">-</span>
            </div>
        </div>
        <div class="status" id="status-block">
            <strong id="status-title">ç­‰å¾…çˆ¶é¡µé¢æ¡æ‰‹...</strong>
            <span id="status-detail">è‹¥é•¿æ—¶é—´æ— å“åº”ï¼Œè¯·è¿”å›ä¸»é¡µé¢é‡æ–°å¼€å¯å¥—é¢˜æ¨¡å¼ã€‚</span>
        </div>
        <div class="actions">
            <button id="complete-exam-btn" disabled>æäº¤æœ¬ç¯‡æˆç»©</button>
            <button id="force-ready-btn" style="background:linear-gradient(135deg, var(--success), color-mix(in srgb, var(--success) 65%, #f1f5f9)); color:#042f2e;">é‡æ–°å‘é€æ¡æ‰‹</button>
        </div>
    </section>
    <section class="panel">
        <h2>ç»ƒä¹ è¯´æ˜</h2>
        <p>æœ¬é¡µé¢ç”¨äºåœ¨é¢˜ç›® HTML ç¼ºå¤±æˆ–è·¨åŸŸåŠ è½½å¤±è´¥æ—¶ç»§ç»­å¥—é¢˜æµç¨‹ã€‚ç‚¹å‡»â€œæäº¤æœ¬ç¯‡æˆç»©â€å°†æ¨¡æ‹Ÿå½“å‰ç¯‡ç« çš„ä½œç­”ç»“æœï¼Œå¹¶é€šçŸ¥çˆ¶é¡µé¢è¿›å…¥ä¸‹ä¸€ç¯‡ã€‚</p>
        <div class="meta-item" style="margin-top:12px;">
            <span class="meta-label">è‡ªåŠ¨ç”Ÿæˆæˆç»©èŒƒå›´</span>
            <span class="meta-value" id="meta-score">æ­£ç¡® 8 / æ€»é¢˜æ•° 13ï¼ˆ62%ï¼‰</span>
        </div>
        <div class="meta-item">
            <span class="meta-label">é¢„è®¡ç”¨æ—¶</span>
            <span class="meta-value" id="meta-duration">~12 åˆ†é’Ÿ</span>
        </div>
        <div class="log-area" id="event-log"></div>
    </section>
</main>
<footer>
    å ä½é¡µå°†ç»§ç»­å‘çˆ¶é¡µé¢å‘é€ SESSION_READY / PRACTICE_COMPLETE æ¶ˆæ¯ï¼Œä¿éšœå¥—é¢˜ç»ƒä¹ ä¸ç»ƒä¹ è®°å½•èšåˆæµç¨‹æ­£å¸¸æ‰§è¡Œã€‚
</footer>
<script src="../js/utils/environmentDetector.js"></script>
<script>
(function() {
    const opener = window.opener || window.parent;
    const overlay = document.getElementById('access-denied-overlay');
    const detector = window.EnvironmentDetector;
    const isTestEnv = detector && typeof detector.isInTestEnvironment === 'function'
        ? detector.isInTestEnvironment()
        : false;

    if (!isTestEnv) {
        if (overlay) {
            overlay.style.display = 'flex';
        }
        document.body.dataset.examState = 'blocked';
        console.warn('[SuitePlaceholder] éæµ‹è¯•ç¯å¢ƒç¦æ­¢è®¿é—®ï¼Œå ä½é¡µå·²é”å®šã€‚');
        return;
    }

    if (overlay) {
        overlay.style.display = 'none';
    }
    const state = {
        examId: null,
        title: 'IELTS é˜…è¯»ç»ƒä¹ ',
        category: 'P1',
        sessionId: null,
        suiteSessionId: null,
        sequenceIndex: null,
        submitted: false,
        baseDuration: 11 * 60,
        correctCount: 8,
        totalCount: 13
    };

    const dom = {
        title: document.getElementById('exam-title'),
        subtitle: document.getElementById('exam-subtitle'),
        metaExam: document.getElementById('meta-exam-id'),
        metaCategory: document.getElementById('meta-category'),
        metaSession: document.getElementById('meta-session'),
        metaSuite: document.getElementById('meta-suite'),
        metaScore: document.getElementById('meta-score'),
        metaDuration: document.getElementById('meta-duration'),
        statusTitle: document.getElementById('status-title'),
        statusDetail: document.getElementById('status-detail'),
        completeBtn: document.getElementById('complete-exam-btn'),
        forceReadyBtn: document.getElementById('force-ready-btn'),
        log: document.getElementById('event-log')
    };

    function decodeParam(value) {
        if (!value) return '';
        try { return decodeURIComponent(value.replace(/\+/g, ' ')); }
        catch (_) { return value; }
    }

    function parseParams() {
        const params = new URLSearchParams(window.location.search);
        const title = decodeParam(params.get('title')) || state.title;
        const examId = decodeParam(params.get('examId')) || null;
        const category = decodeParam(params.get('category')) || 'P1';
        const seq = params.get('index');

        state.title = title;
        state.examId = examId;
        state.category = category;
        state.sequenceIndex = seq != null ? Number(seq) : null;

        document.body.dataset.examId = examId || '';
        dom.title.textContent = title || 'IELTS é˜…è¯»ç»ƒä¹ å ä½é¡µ';
        dom.subtitle.innerHTML = seq != null
            ? `å½“å‰ä¸ºå¥—é¢˜ç¬¬ <span class="pill">${Number(seq) + 1}</span> ç¯‡ï¼Œè¯·åœ¨å®Œæˆåç‚¹å‡»æäº¤ã€‚`
            : 'å½“å‰é¢˜ç›®æ— æ³•åŠ è½½ï¼Œç³»ç»Ÿå·²åˆ‡æ¢åˆ°å ä½ç»ƒä¹ é¡µã€‚';
        dom.metaExam.textContent = examId || 'æœªæä¾›';
        dom.metaCategory.textContent = category || 'P1';
        dom.metaScore.textContent = `æ­£ç¡® ${state.correctCount} / æ€»é¢˜æ•° ${state.totalCount}ï¼ˆ${Math.round((state.correctCount / state.totalCount) * 100)}%ï¼‰`;
        dom.metaDuration.textContent = '~12 åˆ†é’Ÿ';
    }

    function log(message, level = 'info') {
        if (!dom.log) return;
        const entry = document.createElement('div');
        entry.className = level;
        const timestamp = new Date().toLocaleTimeString();
        entry.textContent = `[${timestamp}] ${message}`;
        dom.log.prepend(entry);
    }

    function buildEnvelope(type, payload) {
        const data = Object.assign({
            examId: state.examId,
            title: state.title,
            category: state.category,
            suiteSessionId: state.suiteSessionId,
            sessionId: state.sessionId,
            source: 'suite_placeholder',
            timestamp: Date.now()
        }, payload || {});
        return { type, data, source: 'suite_placeholder' };
    }

    function postMessage(type, payload) {
        if (!opener || opener === window) {
            log('æœªæ£€æµ‹åˆ°çˆ¶çª—å£ï¼Œæ¶ˆæ¯æœªå‘é€ã€‚', 'warn');
            return;
        }
        try {
            opener.postMessage(buildEnvelope(type, payload), '*');
            log(`å·²å‘é€ ${type} æ¶ˆæ¯`, 'info');
        } catch (error) {
            log(`å‘é€ ${type} æ¶ˆæ¯å¤±è´¥: ${error}`, 'error');
        }
    }

    function markState(stateLabel, detail) {
        document.body.dataset.examState = stateLabel;
        dom.statusTitle.textContent = stateLabel;
        if (detail) {
            dom.statusDetail.textContent = detail;
        }
    }

    function sendSessionReady() {
        markState('å·²ä¸çˆ¶é¡µé¢å»ºç«‹ä¼šè¯', 'ç­‰å¾…å½“å‰ç¯‡ç« ä½œç­”å®Œæˆã€‚');
        dom.completeBtn.disabled = false;
        postMessage('SESSION_READY', {
            url: window.location.href,
            pageType: 'suite-placeholder',
            status: 'ready'
        });
    }

    function submitResults() {
        if (state.submitted) {
            log('å½“å‰ç¯‡ç« å·²æäº¤ï¼Œå¿½ç•¥é‡å¤ç‚¹å‡»ã€‚', 'warn');
            return;
        }
        const duration = state.baseDuration + Math.round(Math.random() * 180);
        const correct = state.correctCount + Math.round(Math.random() * 2 - 1);
        const total = state.totalCount;
        const accuracy = Math.max(0, Math.min(1, correct / total));
        const percentage = Math.round(accuracy * 100);

        const answers = {};
        const comparison = {};
        for (let i = 1; i <= total; i++) {
            const qKey = `Q${i}`;
            answers[qKey] = i <= correct ? 'A' : 'B';
            comparison[qKey] = {
                questionId: qKey,
                correctAnswer: i <= correct ? 'A' : 'B',
                userAnswer: answers[qKey],
                isCorrect: i <= correct
            };
        }

        const payload = {
            completedAt: new Date().toISOString(),
            duration,
            scoreInfo: {
                correct,
                total,
                accuracy,
                percentage,
                source: 'suite_placeholder',
                details: comparison
            },
            answers,
            answerComparison: comparison,
            metadata: {
                category: state.category,
                examTitle: state.title,
                suitePlaceholder: true
            }
        };

        postMessage('PRACTICE_COMPLETE', payload);
        state.submitted = true;
        dom.completeBtn.disabled = true;
        markState('å·²ä¸ŠæŠ¥æˆç»©ï¼Œç­‰å¾…ä¸‹ä¸€ç¯‡...', 'è¯·ç¨å€™ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è·³è½¬è‡³ä¸‹ä¸€ç¯‡å¥—é¢˜ã€‚');
    }

    function handleIncoming(event) {
        const payload = event && event.data ? event.data : null;
        if (!payload || typeof payload !== 'object') {
            return;
        }
        const envelope = payload;
        const rawType = envelope.type || envelope.action;
        if (!rawType) {
            return;
        }
        const type = String(rawType).toUpperCase();
        const data = envelope.data || {};

        if (type === 'INIT_SESSION' || type === 'INIT_EXAM_SESSION') {
            if (data.sessionId) {
                state.sessionId = data.sessionId;
                dom.metaSession.textContent = data.sessionId;
            }
            if (data.suiteSessionId) {
                state.suiteSessionId = data.suiteSessionId;
                dom.metaSuite.textContent = data.suiteSessionId;
            }
            if (data.examId) {
                state.examId = data.examId;
                document.body.dataset.examId = data.examId;
                dom.metaExam.textContent = data.examId;
            }
            markState('æ¡æ‰‹æˆåŠŸï¼Œç­‰å¾…ä½œç­”', 'å¯ç‚¹å‡»â€œæäº¤æœ¬ç¯‡æˆç»©â€æ¨¡æ‹Ÿå®Œæˆã€‚');
            dom.completeBtn.disabled = false;
        }

        if (type === 'INIT_SESSION' || type === 'INIT_EXAM_SESSION') {
            sendSessionReady();
        }

        if (type === 'SUITE_NAVIGATE') {
            log('æ”¶åˆ°å¥—é¢˜å¯¼èˆªæŒ‡ä»¤ï¼Œå‡†å¤‡è·³è½¬ä¸‹ä¸€ç¯‡ã€‚', 'info');
            const nextUrl = data.url || '';
            if (nextUrl) {
                try {
                    window.location.href = nextUrl;
                } catch (error) {
                    log('è·³è½¬ä¸‹ä¸€ç¯‡å¤±è´¥: ' + error, 'error');
                }
            }
        }
    }

    dom.completeBtn.addEventListener('click', submitResults);
    dom.forceReadyBtn.addEventListener('click', () => {
        if (!state.sessionId) {
            log('ä»æœªè·å¾— sessionIdï¼Œå°†å‘é€å ä½ä¼šè¯ã€‚', 'warn');
        }
        sendSessionReady();
    });

    window.addEventListener('message', handleIncoming);

    parseParams();
    log('å ä½é¡µå·²åˆå§‹åŒ–ï¼Œç­‰å¾…çˆ¶çª—å£å‘é€ INIT_SESSIONã€‚');
    setTimeout(() => {
        if (!state.sessionId) {
            log('ä»æœªæ¡æ‰‹ï¼Œå°è¯•ä¸»åŠ¨å‘é€ SESSION_READYã€‚', 'warn');
            sendSessionReady();
        }
    }, 1500);
})();
</script>
</body>
</html>
