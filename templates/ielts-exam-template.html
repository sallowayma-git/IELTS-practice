<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P2/P3 â€“ Template</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root { 
    --line:#e5e7eb; 
    --bg:#f6f7fb; 
    --panel:#fff; 
    --accent:#3b82f6; 
    --muted:#6b7280; 
    --shadow:0 6px 20px rgba(0,0,0,.12); 
  }
  * { box-sizing: border-box; }
  html,body { height:100%; }
  body { 
    margin:0; 
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; 
    background:var(--bg); 
    padding-bottom: 82px; 
  }
  
  /* å¸ƒå±€æ ·å¼ */
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:var(--panel); overflow:auto; padding:20px; }
  #left { flex: 0 0 50%; min-width: 280px; }
  #right { flex: 1 1 auto; min-width: 320px; background:#fbfbff; border-left:1px solid var(--line); }
  #divider { flex: 0 0 8px; background: linear-gradient(90deg,#e5e7eb,#d1d5db); cursor: ew-resize; position:relative; z-index: 5; user-select:none; }
  
  /* æ–‡æœ¬æ ·å¼ */
  h2,h3,h4 { margin:0 0 10px; }
  #left p { margin: 0 0 12px; line-height: 1.6; word-break: normal; overflow-wrap: normal; hyphens: none; }
  
  /* ç»„ä»¶æ ·å¼ */
  .group { background:#fff; border:1px solid var(--line); border-radius:10px; padding:12px; margin-bottom:14px; }
  input.blank { 
    border:none; 
    border-bottom:1px solid #9ca3af; 
    padding:2px 4px; 
    font-size:1em; 
    background:transparent; 
  }
  input.blank:focus { outline:none; border-bottom:2px solid var(--accent); }
  
  /* æŒ‰é’®æ ·å¼ */
  button { 
    padding:8px 12px; 
    border:1px solid var(--line); 
    border-radius:10px; 
    background:#fff; 
    cursor:pointer; 
    transition: all 0.2s;
  }
  button:hover { background:#f1f5f9; border-color:var(--accent); }
  button.primary { background:var(--accent); color:#fff; border-color:#3b82f6; }
  button.primary:hover { background: #2563eb; }
  
  /* ç»“æœæ˜¾ç¤º */
  #results { background:#fff; border:1px solid var(--line); border-radius:10px; padding:10px; }
  
  /* é«˜äº®æ ·å¼ */
  .hl { background:#fff3a3; box-shadow: inset 0 -2px 0 rgba(0,0,0,.05); cursor: pointer; }
  .hl:hover { filter: brightness(0.98); }
  
  /* é€‰æ‹©å·¥å…·æ  */
  #selbar { 
    position: absolute; 
    display:none; 
    z-index: 2000; 
    background:#111; 
    color:#fff; 
    border-radius: 8px; 
    padding: 6px; 
    box-shadow: var(--shadow); 
    font-size: 13px; 
    gap:6px; 
    align-items: center; 
  }
  #selbar button { 
    background: transparent; 
    color:#fff; 
    border: 1px solid rgba(255,255,255,.25); 
    padding: 4px 8px; 
    border-radius: 6px; 
    cursor:pointer; 
  }
  #selbar button:hover { border-color:#fff; }
  
  /* ç¬”è®°é¢æ¿ */
  #notes { 
    position: fixed; 
    right: 12px; 
    bottom: 12px; 
    width: 320px; 
    height: 42vh; 
    background:#fff; 
    border:1px solid var(--line); 
    border-radius: 12px; 
    display:none; 
    flex-direction: column; 
    z-index:1500; 
    box-shadow: var(--shadow); 
  }
  #notes header { 
    display:flex; 
    align-items:center; 
    justify-content: space-between; 
    padding:8px 10px; 
    border-bottom:1px solid var(--line); 
  }
  #notes textarea { 
    flex:1; 
    border:0; 
    padding:10px; 
    resize:none; 
    font-size:14px; 
    line-height:1.5; 
  }
  
  /* æç¤ºæ¶ˆæ¯ */
  #toast { 
    position: fixed; 
    left:50%; 
    transform: translateX(-50%); 
    bottom: 24px; 
    background:#111; 
    color:#fff; 
    padding:8px 12px; 
    border-radius: 8px; 
    display:none; 
    z-index:2500; 
  }
  
  /* ç­”æ¡ˆæ¡† */
  details.answerbox summary { cursor: pointer; user-select:none; list-style: none; }
  details.answerbox { 
    border:1px dashed var(--line); 
    border-radius:10px; 
    padding:8px 10px; 
    background:#fff; 
  }
  .badge { 
    display:inline-block; 
    background:#eef2ff; 
    color:#4338ca; 
    padding:2px 8px; 
    border-radius:999px; 
    font-size:12px; 
    margin-left:6px; 
  }
  
  /* åº•éƒ¨å¯¼èˆªæ  */
  .practice-nav { 
    background:#fff; 
    padding:12px 20px; 
    display:flex; 
    align-items:center; 
    gap:16px; 
    box-shadow:0 2px 4px rgba(0,0,0,.05); 
    flex-wrap:wrap; 
    position:fixed; 
    left:0; 
    right:0; 
    bottom:0; 
    border-top:2px solid var(--line); 
    z-index:4000; 
  }
  .practice-nav .title { font-weight:600; color:var(--muted); }
  .practice-nav .questions { 
    display:flex; 
    gap:8px; 
    align-items:center; 
    flex-wrap:wrap; 
  }
  .practice-nav .q-item { 
    padding:6px 10px; 
    border:1px solid var(--line); 
    border-radius:6px; 
    background:#fff; 
    cursor:pointer; 
    font-size:14px; 
    transition:all 0.2s; 
    min-width:36px; 
    text-align:center; 
  }
  .practice-nav .q-item:hover { 
    background:#f1f5f9; 
    border-color:var(--accent); 
  }
  .practice-nav .q-item.answered { 
    background:#e0e7ff; 
    border-color:var(--accent); 
    color:var(--accent); 
    font-weight:500; 
  }
  .practice-nav .q-item.active { 
    background:var(--accent); 
    color:#fff; 
    border-color:var(--accent); 
  }
  .practice-nav .controls { 
    margin-left: auto; 
    display: flex; 
    align-items: center; 
    gap: 12px; 
  }
  
  /* è®¡æ—¶å™¨æ ·å¼ */
  #timer { 
    display: inline-block; 
    background:#fff; 
    border:1px solid var(--line); 
    border-radius:10px; 
    padding:4px 10px; 
    font-size:14px; 
    font-family: 'SF Mono', Consolas, monospace;
    cursor: pointer;
    transition: all 0.2s ease;
    user-select: none;
  }
  #timer:hover {
    background: #f8fafc;
    border-color: var(--accent);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
  }
  #timer.paused {
    background: #fef3c7;
    border-color: #f59e0b;
    color: #92400e;
    animation: pulse 1.5s infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }
  
  /* ä¸»é¢˜åˆ‡æ¢æŒ‰é’® */
  .theme-toggle { 
    cursor: pointer; 
    background: transparent; 
    border: 1px solid var(--line);
    border-radius: 8px;
    padding: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    font-size: 16px;
    transition: all 0.2s ease;
  }
  .theme-toggle:hover {
    background: var(--accent);
    color: #fff;
    border-color: var(--accent);
    transform: scale(1.05);
  }
  .theme-toggle:active {
    transform: scale(0.95);
  }
  
  /* æ‹–æ‹½ç›¸å…³æ ·å¼ */
  .dropzone { 
    border:2px dashed #cbd5e1; 
    background:#f8fafc; 
    border-radius:10px; 
    min-height:40px; 
    padding:4px 8px; 
    display:inline-flex; 
    align-items:center; 
    justify-content:center; 
    gap:8px; 
    width: 220px; 
    vertical-align: middle; 
  }
  .droplabel { color:#64748b; font-size:14px; }
  .cardpool { 
    background:#f1f5f9; 
    border-radius:10px; 
    padding:12px; 
    display:flex; 
    flex-wrap:wrap; 
    gap:8px; 
  }
  .pool-slot { min-height:40px; }
  .card { 
    background:#fff; 
    border:1px solid #e5e7eb; 
    border-radius:8px; 
    padding:8px 10px; 
    display:inline-flex; 
    gap:8px; 
    align-items:center; 
    cursor:grab; 
    box-shadow:0 1px 0 rgba(0,0,0,.03); 
    white-space: nowrap; 
  }
  .card:active { cursor:grabbing; }
  .tag { 
    background:#eef2ff; 
    color:#4338ca; 
    padding:2px 8px; 
    border-radius:999px; 
    font-size:12px; 
  }
  .btn-clear { 
    border:1px solid #e5e7eb; 
    background:#fff; 
    border-radius:8px; 
    padding:6px 8px; 
    cursor:pointer; 
  }
  .ghost { opacity: .5; }
  .over { outline:2px dashed #3b82f6; }
  
  /* æ·±è‰²æ¨¡å¼æ ·å¼ */
  body.dark { 
    --bg: #0f172a; 
    --panel: #1e293b; 
    --line: #334155; 
    --muted: #94a3b8; 
    color: #e2e8f0; 
  }
  body.dark #right { background: #0f172a; }
  body.dark .group { background: #1e293b; border-color: #334155; }
  body.dark button { background: #1e293b; color: #e2e8f0; border-color: #334155; }
  body.dark button:hover { background: #334155; }
  body.dark button.primary { background: var(--accent); color: #fff; }
  body.dark #results { background: #1e293b; border-color: #334155; }
  body.dark #notes { background: #1e293b; border-color: #334155; color: #e2e8f0; }
  body.dark .practice-nav { background: #1e293b; border-color: #334155; }
  body.dark .q-item { background: #0f172a; color: #e2e8f0; border-color: #334155; }
  body.dark .q-item:hover { background: #334155; }
  body.dark .q-item.answered { background: #1e40af; border-color: var(--accent); color: #93c5fd; }
  body.dark #timer { background: #1e293b; color: #e2e8f0; border-color: #334155; }
  body.dark #timer:hover { background: #334155; border-color: var(--accent); }
  body.dark details.answerbox { background: #1e293b; border-color: #334155; }
  body.dark input.blank { color: #e2e8f0; border-bottom-color: #64748b; }
  body.dark input.blank:focus { border-bottom-color: var(--accent); }
  body.dark .cardpool { background:#1e293b; }
  body.dark .card { background:#334155; border-color: #475569; }
  body.dark .dropzone { background:#1e293b; border-color: #475569; }
  body.dark .tag { background:#334155; color:#93c5fd; }
  body.dark .btn-clear { background:#334155; border-color: #475569; }
  
  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 768px) {
    .shell { flex-direction: column; }
    #left, #right { flex: none; min-width: auto; }
    #divider { display: none; }
    .practice-nav .controls { gap: 8px; }
    #timer { font-size: 12px; padding: 3px 8px; }
    .theme-toggle { width: 32px; height: 32px; font-size: 14px; }
    #notes { width: calc(100vw - 24px); right: 12px; left: 12px; }
  }
</style>
</head>
<body>

<div class="practice-nav">
  <div class="title">Questions</div>
  <div class="questions">
    <div class="q-item" id="q27-nav" onclick="scrollToElement('q27-anchor')">27</div>
    <div class="q-item" id="q28-nav" onclick="scrollToElement('q28-anchor')">28</div>
    <div class="q-item" id="q29-nav" onclick="scrollToElement('q29-anchor')">29</div>
    <div class="q-item" id="q30-nav" onclick="scrollToElement('q30-anchor')">30</div>
    <div class="q-item" id="q31-nav" onclick="scrollToElement('q31-anchor')">31</div>
    <div class="q-item" id="q32-nav" onclick="scrollToElement('q32-anchor')">32</div>
    <div class="q-item" id="q33-nav" onclick="scrollToElement('q33-anchor')">33</div>
    <div class="q-item" id="q34-nav" onclick="scrollToElement('q34-anchor')">34</div>
    <div class="q-item" id="q35-nav" onclick="scrollToElement('q35-anchor')">35</div>
    <div class="q-item" id="q36-nav" onclick="scrollToElement('q36-anchor')">36</div>
    <div class="q-item" id="q37-nav" onclick="scrollToElement('q37-anchor')">37</div>
    <div class="q-item" id="q38-nav" onclick="scrollToElement('q38-anchor')">38</div>
    <div class="q-item" id="q39-nav" onclick="scrollToElement('q39-anchor')">39</div>
    <div class="q-item" id="q40-nav" onclick="scrollToElement('q40-anchor')">40</div>
  </div>
  <div class="controls">
    <span id="timer" onclick="toggleTimer()">00:00</span>
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode">ğŸŒ™</button>
  </div>
</div>

<div class="shell">
  <section class="pane" id="left">
    <h2>READING PASSAGE 3</h2>
    <p>You should spend about 20 minutes on Questions 27â€“40, which are based on Reading Passage 3 below.</p>
    <h3>[æ–‡ç« æ ‡é¢˜]</h3>
    
    <h4>A</h4>
    <p>[æ®µè½å†…å®¹]</p>
    
    <h4>B</h4>
    <p>[æ®µè½å†…å®¹]</p>
    
    <!-- æ›´å¤šæ®µè½... -->
    
  </section>

  <div id="divider"></div>

  <section class="pane" id="right">
    <div class="group">
      <h3>Questions 27â€“31</h3>
      <p>[é¢˜ç›®è¯´æ˜]</p>
      
      <div id="q27-anchor">
        <p><strong>27</strong> [é¢˜ç›®å†…å®¹]</p>
        <!-- é¢˜ç›®é€‰é¡¹æˆ–å¡«ç©º -->
      </div>
      
      <!-- æ›´å¤šé¢˜ç›®... -->
      
    </div>
    
    <div class="group">
      <button class="primary" onclick="grade()">Submit Answers</button>
      <button onclick="toggleNotes()">ğŸ“ Notes</button>
    </div>
    
    <div id="results"></div>
    
    <details class="answerbox">
      <summary>Show answers (click to toggle) <span class="badge">hidden</span></summary>
      <div id="answerContent"></div>
    </details>
  </section>
</div>

<!-- é«˜äº®å·¥å…·æ  -->
<div id="selbar">
  <button id="btnHL">ğŸ–ï¸ Highlight</button>
  <button id="btnUH">âŒ Remove</button>
  <button id="btnNote">ğŸ“ Note</button>
</div>

<!-- ç¬”è®°é¢æ¿ -->
<div id="notes">
  <header>
    <span>ğŸ“ Notes</span>
    <div>
      <button id="btnCopy">ğŸ“‹</button>
      <button id="btnClose">âœ•</button>
    </div>
  </header>
  <textarea id="noteArea" placeholder="Write your notes here..."></textarea>
</div>

<!-- æç¤ºæ¶ˆæ¯ -->
<div id="toast"></div>

<script>
  // è®¡æ—¶å™¨åŠŸèƒ½
  let _t = 0;
  let timerRunning = true;
  let timerInterval;
  const _timerEl = document.getElementById('timer');

  function updateTimer() {
    const m = Math.floor(_t / 60);
    const s = _t % 60;
    _timerEl.textContent = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
  }

  function startTimer() {
    timerInterval = setInterval(() => {
      if (timerRunning) {
        _t++;
        updateTimer();
      }
    }, 1000);
  }

  function toggleTimer() {
    if (timerRunning) {
      clearInterval(timerInterval);
      timerRunning = false;
      _timerEl.classList.add('paused');
      showToast('Timer paused');
    } else {
      startTimer();
      timerRunning = true;
      _timerEl.classList.remove('paused');
      showToast('Timer resumed');
    }
  }

  // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
  function toggleTheme() {
    document.body.classList.toggle('dark');
    const isDark = document.body.classList.contains('dark');
    localStorage.setItem('darkMode', isDark);
    const themeButton = document.querySelector('.theme-toggle');
    themeButton.textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
  }

  // åŠ è½½ä¿å­˜çš„ä¸»é¢˜
  if (localStorage.getItem('darkMode') === 'true') {
    document.body.classList.add('dark');
    document.querySelector('.theme-toggle').textContent = 'â˜€ï¸';
  }

  // å¯¼èˆªåŠŸèƒ½
  function scrollToElement(id) {
    const element = document.getElementById(id);
    if (element) {
      element.scrollIntoView({ behavior: 'smooth', block: 'center' });
      
      // æ›´æ–°å¯¼èˆªçŠ¶æ€
      document.querySelectorAll('.q-item').forEach(item => item.classList.remove('active'));
      const navItem = document.querySelector(`[onclick="scrollToElement('${id}')"]`);
      if (navItem) navItem.classList.add('active');
    }
  }

  // ç­”é¢˜çŠ¶æ€æ›´æ–°
  function updateAnswerStatus() {
    for (let i = 27; i <= 40; i++) {
      const inputs = document.querySelectorAll(`input[name="q${i}"]`);
      const navItem = document.querySelector(`[onclick="scrollToElement('q${i}-anchor')"]`);
      if (navItem) {
        let answered = false;
        inputs.forEach(input => {
          if (input.type === 'radio' && input.checked) {
            answered = true;
          } else if (input.type === 'text' && input.value.trim()) {
            answered = true;
          }
        });
        if (answered) {
          navItem.classList.add('answered');
        } else {
          navItem.classList.remove('answered');
        }
      }
    }
  }

  // ç›‘å¬ç­”æ¡ˆå˜åŒ–
  document.addEventListener('change', updateAnswerStatus);
  document.addEventListener('input', updateAnswerStatus);

  // é«˜äº®åŠŸèƒ½
  let lastRange = null;
  let currentHlNode = null;
  const selbar = document.getElementById('selbar');
  const btnHL = document.getElementById('btnHL');
  const btnUH = document.getElementById('btnUH');
  const btnNote = document.getElementById('btnNote');

  document.addEventListener('mouseup', function (e) {
    const sel = window.getSelection();
    if (sel.rangeCount && !sel.isCollapsed) {
      lastRange = sel.getRangeAt(0);
      const rect = lastRange.getBoundingClientRect();
      selbar.style.left = rect.left + 'px';
      selbar.style.top = (rect.top - 40) + 'px';
      selbar.style.display = 'flex';
    }
  });

  document.addEventListener('click', function (e) {
    if (e.target.classList && e.target.classList.contains('hl')) {
      currentHlNode = e.target;
      const rect = e.target.getBoundingClientRect();
      selbar.style.left = rect.left + 'px';
      selbar.style.top = (rect.top - 40) + 'px';
      selbar.style.display = 'flex';
    } else if (!selbar.contains(e.target)) {
      selbar.style.display = 'none';
      currentHlNode = null;
    }
  });

  function doHighlight() {
    if (currentHlNode) return;
    if (!lastRange) return;
    try {
      const wrap = document.createElement('span');
      wrap.className = 'hl';
      wrap.appendChild(lastRange.cloneContents());
      lastRange.deleteContents();
      lastRange.insertNode(wrap);
    } catch (e) {
      console.error('Highlight failed:', e);
    }
    selbar.style.display = 'none';
    showToast('Highlighted');
  }

  function removeHighlight() {
    if (currentHlNode) {
      const p = currentHlNode.parentNode;
      while (currentHlNode.firstChild) p.insertBefore(currentHlNode.firstChild, currentHlNode);
      p.removeChild(currentHlNode);
      p.normalize();
      currentHlNode = null;
      selbar.style.display = 'none';
      showToast('Highlight removed');
      return;
    }
    
    if (!lastRange) return;
    const selRect = lastRange.getBoundingClientRect();
    const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_ELEMENT);
    const toRemove = [];
    
    while (walker.nextNode()) {
      const n = walker.currentNode;
      if (n.classList && n.classList.contains('hl')) {
        const r = n.getBoundingClientRect();
        if (!(r.right < selRect.left || r.left > selRect.right || r.bottom < selRect.top || r.top > selRect.bottom)) {
          toRemove.push(n);
        }
      }
    }
    
    toRemove.forEach(function (el) {
      const p = el.parentNode;
      while (el.firstChild) p.insertBefore(el.firstChild, el);
      p.removeChild(el);
      p.normalize();
    });
    
    selbar.style.display = 'none';
    showToast('Highlight removed');
  }

  btnHL.addEventListener('click', doHighlight);
  btnUH.addEventListener('click', removeHighlight);

  // ç¬”è®°åŠŸèƒ½
  const notes = document.getElementById('notes');
  const noteArea = document.getElementById('noteArea');
  const btnCopy = document.getElementById('btnCopy');
  const btnClose = document.getElementById('btnClose');

  function toggleNotes() {
    notes.style.display = (notes.style.display === 'flex' ? 'none' : 'flex');
  }

  btnClose.addEventListener('click', toggleNotes);
  btnCopy.addEventListener('click', async function () {
    await navigator.clipboard.writeText(noteArea.value || '');
    showToast('Copied');
  });

  btnNote.addEventListener('click', function () {
    let text = '';
    if (currentHlNode) {
      text = (currentHlNode.textContent || '').trim();
    } else if (lastRange) {
      const frag = lastRange.cloneContents();
      text = (frag.textContent || '').trim();
    }
    toggleNotes();
    if (text) {
      noteArea.value = (noteArea.value ? noteArea.value + '\n' : '') + '> ' + text + '\n';
    }
    selbar.style.display = 'none';
  });

  // Toastæç¤ºåŠŸèƒ½
  const toastEl = document.getElementById('toast');
  function showToast(msg) {
    toastEl.textContent = msg;
    toastEl.style.display = 'block';
    setTimeout(function () { toastEl.style.display = 'none'; }, 1200);
  }

  // æ‹–æ‹½åŠŸèƒ½åˆå§‹åŒ–
  function initDragAndDrop() {
    const cards = document.querySelectorAll('.card');
    const dropzones = document.querySelectorAll('.dropzone');
    let draggedCard = null;

    cards.forEach(card => {
      card.addEventListener('dragstart', (e) => {
        draggedCard = e.target;
        setTimeout(() => e.target.classList.add('ghost'), 0);
      });
      card.addEventListener('dragend', (e) => {
        e.target.classList.remove('ghost');
      });
    });

    dropzones.forEach(zone => {
      zone.addEventListener('dragover', e => {
        e.preventDefault();
        zone.classList.add('over');
      });
      zone.addEventListener('dragleave', () => {
        zone.classList.remove('over');
      });
      zone.addEventListener('drop', e => {
        e.preventDefault();
        zone.classList.remove('over');
        if (draggedCard) {
          if(zone.children.length > 0 && zone.children[0].classList.contains('card')) {
            document.querySelector('.cardpool').appendChild(zone.children[0]);
          }
          zone.innerHTML = '';
          zone.appendChild(draggedCard);
          draggedCard = null;
        }
      });
    });
  }

  // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', function() {
    startTimer();
    initDragAndDrop();
  });

  // ç»ƒä¹ é¡µé¢å¢å¼ºè„šæœ¬é›†æˆ
  function loadPracticePageEnhancer() {
    const script = document.createElement('script');
    script.src = '../../js/practice-page-enhancer.js';
    script.onload = function() {
      console.log('ç»ƒä¹ é¡µé¢å¢å¼ºè„šæœ¬å·²åŠ è½½');
    };
    script.onerror = function() {
      console.error('ç»ƒä¹ é¡µé¢å¢å¼ºè„šæœ¬åŠ è½½å¤±è´¥');
      // é™çº§åˆ°å†…è”å¢å¼º
      loadInlineEnhancer();
    };
    document.head.appendChild(script);
  }

  // å†…è”å¢å¼ºå™¨ï¼ˆé™çº§æ–¹æ¡ˆï¼‰
  function loadInlineEnhancer() {
    if (window.practicePageEnhancer) return;
    
    window.practicePageEnhancer = {
      initialize: function() {
        console.log('[InlineEnhancer] å†…è”å¢å¼ºå™¨å·²åˆå§‹åŒ–');
        this.setupCommunication();
        this.setupAnswerListeners();
        this.interceptSubmit();
      },
      
      setupCommunication: function() {
        this.parentWindow = window.opener || window.parent;
        window.addEventListener('message', (event) => {
          if (event.data && event.data.type === 'INIT_SESSION') {
            this.sessionId = event.data.data.sessionId;
            this.sendMessage('SESSION_READY', {
              pageType: this.detectPageType(),
              url: window.location.href
            });
          }
        });
      },
      
      detectPageType: function() {
        const title = document.title || '';
        if (title.includes('P1')) return 'P1';
        if (title.includes('P2')) return 'P2';
        if (title.includes('P3')) return 'P3';
        return 'unknown';
      },
      
      setupAnswerListeners: function() {
        this.answers = {};
        this.startTime = Date.now();
        
        document.addEventListener('change', (e) => {
          if (e.target.name && e.target.name.startsWith('q')) {
            this.answers[e.target.name] = e.target.value;
          }
        });
      },
      
      interceptSubmit: function() {
        // æ‹¦æˆªgradeå‡½æ•°
        if (typeof window.grade === 'function') {
          const originalGrade = window.grade;
          window.grade = () => {
            const result = originalGrade();
            setTimeout(() => this.handleSubmit(), 200);
            return result;
          };
        }
        
        // ç›‘å¬æäº¤æŒ‰é’®
        document.addEventListener('click', (e) => {
          if (e.target.tagName === 'BUTTON' && 
              (e.target.textContent.includes('Submit') || 
               e.target.onclick && e.target.onclick.toString().includes('grade'))) {
            setTimeout(() => this.handleSubmit(), 300);
          }
        });
      },
      
      handleSubmit: function() {
        const results = {
          sessionId: this.sessionId,
          startTime: this.startTime,
          endTime: Date.now(),
          duration: Math.round((Date.now() - this.startTime) / 1000),
          answers: this.answers,
          scoreInfo: this.extractScore(),
          pageType: this.detectPageType(),
          url: window.location.href
        };
        
        this.sendMessage('PRACTICE_COMPLETE', results);
      },
      
      extractScore: function() {
        const resultsEl = document.getElementById('results');
        if (!resultsEl) return null;
        
        const text = resultsEl.textContent || '';
        const scoreMatch = text.match(/Score:\s*(\d+)\/(\d+)/i);
        if (scoreMatch) {
          const correct = parseInt(scoreMatch[1]);
          const total = parseInt(scoreMatch[2]);
          return {
            correct: correct,
            total: total,
            accuracy: total > 0 ? correct / total : 0,
            percentage: Math.round((correct / total) * 100),
            source: 'inline_extraction'
          };
        }
        return null;
      },
      
      sendMessage: function(type, data) {
        if (this.parentWindow) {
          this.parentWindow.postMessage({
            type: type,
            data: data,
            source: 'practice_page'
          }, '*');
        }
      }
    };
    
    // åˆå§‹åŒ–
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        window.practicePageEnhancer.initialize();
      });
    } else {
      window.practicePageEnhancer.initialize();
    }
  }

  // åŠ è½½å¢å¼ºè„šæœ¬
  loadPracticePageEnhancer();
</script>

</body>
</html>