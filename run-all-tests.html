<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS系统修复测试运行器</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8fafc;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-section {
            background: white;
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: background-color 0.2s;
        }
        
        .test-button:hover {
            background: #2563eb;
        }
        
        .test-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .run-all-button {
            background: #10b981;
            font-size: 16px;
            font-weight: 600;
            padding: 16px 32px;
        }
        
        .run-all-button:hover {
            background: #059669;
        }
        
        .test-output {
            background: #1f2937;
            color: #f9fafb;
            padding: 20px;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.5;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 15px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-pending { background: #6b7280; }
        .status-running { background: #f59e0b; }
        .status-success { background: #10b981; }
        .status-error { background: #ef4444; }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: #10b981;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .summary {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .summary.success {
            background: #f0fdf4;
            border-color: #10b981;
        }
        
        .summary.warning {
            background: #fffbeb;
            border-color: #f59e0b;
        }
        
        .summary.error {
            background: #fef2f2;
            border-color: #ef4444;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🧪 IELTS系统修复测试运行器</h1>
        <p>验证所有修复功能的完整性和协同工作能力</p>
    </div>

    <div class="test-section">
        <h2>📋 测试项目</h2>
        <p>以下测试将验证IELTS系统修复的各个方面：</p>
        
        <div style="margin: 20px 0;">
            <div>
                <span class="status-indicator status-pending" id="status-interaction"></span>
                <button class="test-button" onclick="runSingleTest('interaction')" id="btn-interaction">
                    交互体验改进测试
                </button>
            </div>
            
            <div>
                <span class="status-indicator status-pending" id="status-markdown"></span>
                <button class="test-button" onclick="runSingleTest('markdown')" id="btn-markdown">
                    Markdown导出功能测试
                </button>
            </div>
            
            <div>
                <span class="status-indicator status-pending" id="status-communication"></span>
                <button class="test-button" onclick="runSingleTest('communication')" id="btn-communication">
                    通信错误修复测试
                </button>
            </div>
            
            <div>
                <span class="status-indicator status-pending" id="status-component"></span>
                <button class="test-button" onclick="runSingleTest('component')" id="btn-component">
                    组件加载优化测试
                </button>
            </div>
            
            <div>
                <span class="status-indicator status-pending" id="status-integration"></span>
                <button class="test-button" onclick="runSingleTest('integration')" id="btn-integration">
                    集成测试
                </button>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 30px;">
            <button class="test-button run-all-button" onclick="runAllTests()" id="btn-run-all">
                🚀 运行所有测试
            </button>
        </div>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
    </div>

    <div class="test-section">
        <h2>📊 测试输出</h2>
        <div class="test-output" id="test-output">等待测试开始...</div>
        
        <div id="test-summary" style="display: none;"></div>
    </div>

    <!-- 加载测试脚本 -->
    <script src="test-interaction-improvements.js"></script>
    <script src="test-markdown-export.js"></script>
    <script src="test-communication-fixes.js"></script>
    <script src="test-component-loading.js"></script>
    <script src="test-integration-final.js"></script>

    <script>
        let testResults = {};
        let currentTest = null;
        let totalTests = 5;
        let completedTests = 0;

        // 重定向console.log到测试输出
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        
        function appendToOutput(message, type = 'log') {
            const output = document.getElementById('test-output');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '❌' : type === 'warn' ? '⚠️' : '';
            output.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            output.scrollTop = output.scrollHeight;
        }
        
        console.log = (...args) => {
            originalConsoleLog.apply(console, args);
            appendToOutput(args.join(' '), 'log');
        };
        
        console.error = (...args) => {
            originalConsoleError.apply(console, args);
            appendToOutput(args.join(' '), 'error');
        };
        
        console.warn = (...args) => {
            originalConsoleWarn.apply(console, args);
            appendToOutput(args.join(' '), 'warn');
        };

        function updateStatus(testId, status) {
            const indicator = document.getElementById(`status-${testId}`);
            const button = document.getElementById(`btn-${testId}`);
            
            indicator.className = `status-indicator status-${status}`;
            
            if (status === 'running') {
                button.disabled = true;
                button.textContent = button.textContent.replace('测试', '测试中...');
            } else if (status === 'success' || status === 'error') {
                button.disabled = false;
                button.textContent = button.textContent.replace('测试中...', '测试');
            }
        }

        function updateProgress() {
            const progress = (completedTests / totalTests) * 100;
            document.getElementById('progress-fill').style.width = `${progress}%`;
        }

        async function runSingleTest(testType) {
            if (currentTest) {
                console.log('已有测试在运行中，请等待完成');
                return;
            }

            currentTest = testType;
            updateStatus(testType, 'running');
            
            try {
                let result;
                
                switch (testType) {
                    case 'interaction':
                        console.log('=== 开始交互体验改进测试 ===');
                        result = await testInteractionImprovements();
                        break;
                    case 'markdown':
                        console.log('=== 开始Markdown导出功能测试 ===');
                        result = await testMarkdownExport();
                        break;
                    case 'communication':
                        console.log('=== 开始通信错误修复测试 ===');
                        result = await testCommunicationFixes();
                        break;
                    case 'component':
                        console.log('=== 开始组件加载优化测试 ===');
                        result = await testComponentLoading();
                        break;
                    case 'integration':
                        console.log('=== 开始集成测试 ===');
                        result = await runFinalIntegrationTest();
                        break;
                    default:
                        throw new Error(`未知测试类型: ${testType}`);
                }
                
                testResults[testType] = result;
                updateStatus(testType, result.successRate >= 80 ? 'success' : 'error');
                
                console.log(`${testType} 测试完成: ${result.passed}/${result.total} 通过 (${result.successRate}%)`);
                
            } catch (error) {
                console.error(`${testType} 测试失败:`, error);
                testResults[testType] = { total: 1, passed: 0, failed: 1, successRate: 0, error: error.message };
                updateStatus(testType, 'error');
            } finally {
                currentTest = null;
                completedTests++;
                updateProgress();
            }
        }

        async function runAllTests() {
            if (currentTest) {
                console.log('已有测试在运行中，请等待完成');
                return;
            }

            // 重置状态
            testResults = {};
            completedTests = 0;
            updateProgress();
            
            // 清空输出
            document.getElementById('test-output').textContent = '';
            document.getElementById('test-summary').style.display = 'none';
            
            console.log('🚀 开始运行所有IELTS系统修复测试...\n');
            
            const tests = ['interaction', 'markdown', 'communication', 'component', 'integration'];
            
            for (const test of tests) {
                await runSingleTest(test);
                // 在测试之间添加短暂延迟
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            // 显示最终总结
            showFinalSummary();
        }

        function showFinalSummary() {
            const summaryDiv = document.getElementById('test-summary');
            
            let totalTests = 0;
            let totalPassed = 0;
            let allResults = [];
            
            Object.entries(testResults).forEach(([testType, result]) => {
                totalTests += result.total || 0;
                totalPassed += result.passed || 0;
                allResults.push({
                    name: getTestName(testType),
                    result: result
                });
            });
            
            const overallSuccessRate = totalTests > 0 ? Math.round((totalPassed / totalTests) * 100) : 0;
            
            let summaryClass = 'summary';
            let summaryIcon = '📊';
            let summaryTitle = '测试完成';
            
            if (overallSuccessRate >= 90) {
                summaryClass += ' success';
                summaryIcon = '🎉';
                summaryTitle = '测试优秀';
            } else if (overallSuccessRate >= 80) {
                summaryClass += ' success';
                summaryIcon = '✅';
                summaryTitle = '测试良好';
            } else if (overallSuccessRate >= 70) {
                summaryClass += ' warning';
                summaryIcon = '⚠️';
                summaryTitle = '测试基本通过';
            } else {
                summaryClass += ' error';
                summaryIcon = '❌';
                summaryTitle = '测试需要改进';
            }
            
            let summaryHTML = `
                <div class="${summaryClass}">
                    <h3>${summaryIcon} ${summaryTitle}</h3>
                    <p><strong>整体成功率: ${overallSuccessRate}%</strong> (${totalPassed}/${totalTests} 测试通过)</p>
                    
                    <h4>各测试模块结果:</h4>
                    <ul>
            `;
            
            allResults.forEach(item => {
                const status = item.result.successRate >= 80 ? '✅' : '❌';
                summaryHTML += `<li>${status} ${item.name}: ${item.result.passed}/${item.result.total} (${item.result.successRate}%)</li>`;
            });
            
            summaryHTML += `
                    </ul>
                    
                    <p style="margin-top: 15px; font-size: 14px; color: #6b7280;">
                        测试完成时间: ${new Date().toLocaleString()}
                    </p>
                </div>
            `;
            
            summaryDiv.innerHTML = summaryHTML;
            summaryDiv.style.display = 'block';
            
            console.log(`\n🏁 所有测试完成！整体成功率: ${overallSuccessRate}%`);
        }

        function getTestName(testType) {
            const names = {
                'interaction': '交互体验改进',
                'markdown': 'Markdown导出功能',
                'communication': '通信错误修复',
                'component': '组件加载优化',
                'integration': '集成测试'
            };
            return names[testType] || testType;
        }

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('IELTS系统修复测试运行器已就绪');
            console.log('点击上方按钮开始测试，或点击"运行所有测试"进行完整验证');
        });
    </script>
</body>
</html>