<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safe Mode è‡ªæ£€é¡µé¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }
        .status {
            padding: 5px 10px;
            margin: 5px 0;
            border-radius: 4px;
        }
        .pass { background: #10b981; }
        .fail { background: #ef4444; }
        .info { background: #3b82f6; }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover { background: #2563eb; }
        #results { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>ğŸ”§ Safe Mode è‡ªæ£€é¡µé¢</h1>
    <p>æ­¤é¡µé¢ç”¨äºéªŒè¯ Safe Mode çš„æ ¸å¿ƒåŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ</p>

    <div class="test-section">
        <h2>ğŸ“‹ è‡ªæ£€æ¸…å•</h2>
        <div id="checklist">
            <div class="status info">ç­‰å¾…å¼€å§‹è‡ªæ£€...</div>
        </div>
        <button onclick="startSelfTest()">å¼€å§‹è‡ªæ£€</button>
        <button onclick="clearResults()">æ¸…é™¤ç»“æœ</button>
    </div>

    <div id="results"></div>

    <!-- Safe Mode è„šæœ¬ -->
    <script>
        window.__SAFE_MODE__ = true;
        console.log('[SAFE_MODE] è‡ªæ£€é¡µé¢å¯ç”¨');
    </script>

    <!-- åŠ è½½åŸºç¡€è„šæœ¬ -->
    <script src="assets/scripts/complete-exam-data.js"></script>
    <script src="js/utils/events.js"></script>
    <script src="js/utils/helpers.js"></script>
    <script src="js/utils/storage.js"></script>
    <script src="js/utils/errorDisplay.js"></script>
    <script src="js/stores/AppStore.js"></script>
    <script src="js/stores/ExamStore.js"></script>
    <script src="js/stores/RecordStore.js"></script>
    <script src="js/ui/ExamBrowser.js"></script>
    <script src="js/ui/RecordViewer.js"></script>
    <script src="js/ui/SettingsPanel.js"></script>
    <script src="js/app.js"></script>

    <script>
        let testResults = [];

        function addResult(test, status, message, details = null) {
            testResults.push({ test, status, message, details, timestamp: new Date().toISOString() });
            updateDisplay();
        }

        function updateDisplay() {
            const checklist = document.getElementById('checklist');
            checklist.innerHTML = testResults.map(result => `
                <div class="status ${result.status}">
                    <strong>${result.test}:</strong> ${result.message}
                    ${result.details ? `<br><small>${result.details}</small>` : ''}
                </div>
            `).join('');

            const passCount = testResults.filter(r => r.status === 'pass').length;
            const failCount = testResults.filter(r => r.status === 'fail').length;

            if (testResults.length > 0) {
                checklist.innerHTML += `
                    <div class="status info">
                        <strong>æ€»è®¡:</strong> ${testResults.length} é¡¹æµ‹è¯•,
                        ${passCount} é¡¹é€šè¿‡,
                        ${failCount} é¡¹å¤±è´¥
                    </div>
                `;
            }
        }

        function clearResults() {
            testResults = [];
            updateDisplay();
        }

        async function startSelfTest() {
            console.log('[SelfTest] å¼€å§‹ Safe Mode è‡ªæ£€');
            clearResults();

            try {
                // æµ‹è¯• 1: SAFE_MODE æ ‡å¿—æ£€æŸ¥
                addResult('SAFE_MODE æ ‡å¿—',
                    window.__SAFE_MODE__ ? 'pass' : 'fail',
                    window.__SAFE_MODE__ ? 'SAFE_MODE å·²å¯ç”¨' : 'SAFE_MODE æœªå¯ç”¨'
                );

                // æµ‹è¯• 2: EventEmitter å»é‡æ£€æŸ¥
                addResult('EventEmitter å»é‡',
                    window.EventEmitter && window.globalEventBus ? 'pass' : 'fail',
                    window.EventEmitter && window.globalEventBus ? 'EventEmitter æ­£å¸¸åˆå§‹åŒ–' : 'EventEmitter åˆå§‹åŒ–å¤±è´¥',
                    `listeners: ${window.globalEventBus ? window.globalEventBus.listenerCount('test') : 0}`
                );

                // æµ‹è¯• 3: å­˜å‚¨ç³»ç»Ÿæ£€æŸ¥
                try {
                    localStorage.setItem('test_safe_mode', 'ok');
                    localStorage.removeItem('test_safe_mode');
                    addResult('localStorage å¯ç”¨æ€§', 'pass', 'localStorage æ­£å¸¸å·¥ä½œ');
                } catch (error) {
                    addResult('localStorage å¯ç”¨æ€§', 'fail', `localStorage é”™è¯¯: ${error.message}`);
                }

                // æµ‹è¯• 4: å­˜å‚¨æ¨¡å¼æ£€æŸ¥
                if (window.storage) {
                    const isLocalStorageOnly = window.storage.isLocalStorageOnly || !window.storage.useIndexedDB;
                    addResult('å­˜å‚¨æ¨¡å¼',
                        isLocalStorageOnly ? 'pass' : 'fail',
                        isLocalStorageOnly ? 'local-only æ¨¡å¼å·²å¯ç”¨' : 'å­˜å‚¨æ¨¡å¼é…ç½®å¼‚å¸¸'
                    );
                } else {
                    addResult('å­˜å‚¨ç³»ç»Ÿ', 'fail', 'å­˜å‚¨ç³»ç»Ÿæœªåˆå§‹åŒ–');
                }

                // æµ‹è¯• 5: åŸºç¡€ API æ¡¥æ¥æ£€æŸ¥
                const bridgeAPIs = ['searchExams', 'filterByType', 'filterByCategory', 'loadLibrary', 'showView'];
                const workingAPIs = bridgeAPIs.filter(api => typeof window[api] === 'function');
                addResult('å…¼å®¹æ¡¥æ¥ API',
                    workingAPIs.length >= 3 ? 'pass' : 'fail',
                    `${workingAPIs.length}/${bridgeAPIs.length} ä¸ªæ¡¥æ¥ API å¯ç”¨`,
                    `å¯ç”¨: ${workingAPIs.join(', ')}`
                );

                // æµ‹è¯• 6: App åˆå§‹åŒ–æ£€æŸ¥
                console.time('app-initialization-test');

                if (window.App) {
                    addResult('App ç±»', 'pass', 'App ç±»å·²å®šä¹‰');

                    // æµ‹è¯• App åˆå§‹åŒ–
                    try {
                        await window.App.initialize();
                        addResult('App åˆå§‹åŒ–', 'pass', 'App åˆå§‹åŒ–æˆåŠŸ');
                        console.timeEnd('app-initialization-test');
                    } catch (error) {
                        addResult('App åˆå§‹åŒ–', 'fail', `App åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
                    }
                } else {
                    addResult('App ç±»', 'fail', 'App ç±»æœªå®šä¹‰');
                }

                // æµ‹è¯• 7: DOM å¥‘çº¦æ£€æŸ¥
                const requiredContainers = [
                    'exam-list-container',
                    'total-practiced',
                    'avg-score',
                    'study-time',
                    'streak-days',
                    'practice-history-list'
                ];

                setTimeout(() => {
                    const existingContainers = requiredContainers.filter(id => document.getElementById(id));
                    addResult('DOM æœ€å°å¥‘çº¦',
                        existingContainers.length >= requiredContainers.length / 2 ? 'pass' : 'fail',
                        `${existingContainers.length}/${requiredContainers.length} ä¸ªå¿…è¦å®¹å™¨å­˜åœ¨`,
                        `å­˜åœ¨: ${existingContainers.join(', ')}`
                    );
                }, 1000);

                // æµ‹è¯• 8: æ€§èƒ½ç›‘æ§æ£€æŸ¥
                setTimeout(() => {
                    if (window.App && typeof window.App.debugReport === 'function') {
                        try {
                            const report = window.App.debugReport();
                            addResult('æ€§èƒ½ç›‘æ§', 'pass', 'debugReport åŠŸèƒ½æ­£å¸¸');
                        } catch (error) {
                            addResult('æ€§èƒ½ç›‘æ§', 'fail', `debugReport é”™è¯¯: ${error.message}`);
                        }
                    } else {
                        addResult('æ€§èƒ½ç›‘æ§', 'fail', 'debugReport æ–¹æ³•ä¸å¯ç”¨');
                    }
                }, 1500);

                // æµ‹è¯• 9: é¢˜åº“æ¸²æŸ“æ£€æŸ¥ (Task 64)
                setTimeout(() => {
                    const examContainer = document.getElementById('exam-list-container');
                    if (examContainer && examContainer.children.length > 0) {
                        const examCount = examContainer.querySelectorAll('.exam-item').length;
                        addResult('é¢˜åº“æ¸²æŸ“é™åˆ¶',
                            examCount <= 50 ? 'pass' : 'fail',
                            `æ¸²æŸ“äº† ${examCount} ä¸ªè€ƒè¯•é¡¹ç›®`,
                            examCount <= 50 ? 'ç¬¦åˆ 50 æ¡é™åˆ¶' : 'è¶…å‡ºé™åˆ¶'
                        );
                    } else {
                        addResult('é¢˜åº“æ¸²æŸ“é™åˆ¶', 'fail', 'è€ƒè¯•åˆ—è¡¨å®¹å™¨ä¸ºç©ºæˆ–ä¸å­˜åœ¨');
                    }
                }, 2000);

                // æµ‹è¯• 10: æ¶ˆæ¯è·¯ç”±æ£€æŸ¥
                setTimeout(() => {
                    if (window.App && window.App._messageListenerAttached !== undefined) {
                        addResult('æ¶ˆæ¯è·¯ç”±',
                            window.App._messageListenerAttached ? 'pass' : 'fail',
                            window.App._messageListenerAttached ? 'æ¶ˆæ¯ç›‘å¬å™¨å·²é™„åŠ ' : 'æ¶ˆæ¯ç›‘å¬å™¨æœªé™„åŠ '
                        );
                    } else {
                        addResult('æ¶ˆæ¯è·¯ç”±', 'info', 'æ¶ˆæ¯è·¯ç”±çŠ¶æ€æœªçŸ¥');
                    }
                }, 2500);

                console.log('[SelfTest] è‡ªæ£€å®Œæˆ');

            } catch (error) {
                addResult('è‡ªæ£€è¿‡ç¨‹', 'fail', `è‡ªæ£€è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹æ£€æŸ¥
        window.addEventListener('load', () => {
            console.log('[SelfTest] é¡µé¢åŠ è½½å®Œæˆï¼Œå¯ä»¥å¼€å§‹è‡ªæ£€');
            addResult('é¡µé¢åŠ è½½', 'pass', 'Safe Mode è‡ªæ£€é¡µé¢å·²åŠ è½½');
        });
    </script>
</body>
</html>