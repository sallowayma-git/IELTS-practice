/**
 * ExamBrowseré”™è¯¯æ¢å¤ç»„ä»¶
 * å¤„ç†å¼‚å¸¸æƒ…å†µå¹¶æä¾›è‡ªåŠ¨æ¢å¤åŠŸèƒ½
 */
class ExamBrowserRecovery {
    constructor(examBrowser) {
        this.examBrowser = examBrowser;
        this.errorCount = 0;
        this.maxErrors = 5;
        this.recoveryStrategies = [
            this.reInitializeDOM,
            this.reloadExamData,
            this.fallbackToBasicView,
            this.resetToDefault,
            this.showCriticalError
        ];
        this.lastErrorTime = null;
        this.errorTypes = new Map();
        
        this.initialize();
    }
    
    /**
     * åˆå§‹åŒ–é”™è¯¯æ¢å¤æœºåˆ¶
     */
    initialize() {
        console.log('[ExamBrowserRecovery] åˆå§‹åŒ–é”™è¯¯æ¢å¤æœºåˆ¶');
        
        // ç›‘å¬å…¨å±€é”™è¯¯
        this.setupGlobalErrorHandling();
        
        // å®šæœŸæ£€æŸ¥ç³»ç»Ÿå¥åº·çŠ¶å†µ
        this.setupHealthCheck();
    }
    
    /**
     * è®¾ç½®å…¨å±€é”™è¯¯å¤„ç†
     */
    setupGlobalErrorHandling() {
        // ç›‘å¬JavaScripté”™è¯¯
        window.addEventListener('error', (event) => {
            if (this.isExamBrowserRelated(event)) {
                this.handleError(event.error, 'JavaScript Error', {
                    filename: event.filename,
                    lineno: event.lineno,
                    colno: event.colno
                });
            }
        });
        
        // ç›‘å¬Promiseé”™è¯¯
        window.addEventListener('unhandledrejection', (event) => {
            if (this.isExamBrowserRelated(event)) {\n                this.handleError(event.reason, 'Promise Rejection');\n            }\n        });\n        \n        // ç›‘å¬è‡ªå®šä¹‰é”™è¯¯äº‹ä»¶\n        document.addEventListener('examBrowserError', (event) => {\n            this.handleError(event.detail.error, event.detail.context, event.detail.options);\n        });\n    }\n    \n    /**\n     * æ£€æŸ¥é”™è¯¯æ˜¯å¦ä¸ExamBrowserç›¸å…³\n     */\n    isExamBrowserRelated(event) {\n        const error = event.error || event.reason;\n        const stack = error?.stack || '';\n        const message = error?.message || '';\n        \n        // æ£€æŸ¥å †æ ˆä¿¡æ¯æˆ–é”™è¯¯æ¶ˆæ¯ä¸­æ˜¯å¦åŒ…å«ExamBrowserç›¸å…³å†…å®¹\n        return stack.includes('ExamBrowser') || \n               stack.includes('examBrowser') ||\n               message.includes('exam-list') ||\n               message.includes('browse-view') ||\n               (event.filename && event.filename.includes('examBrowser'));\n    }\n    \n    /**\n     * å¤„ç†é”™è¯¯\n     */\n    handleError(error, context, options = {}) {\n        this.errorCount++;\n        \n        // è®°å½•é”™è¯¯ç±»å‹ç»Ÿè®¡\n        const errorType = error?.name || 'Unknown';\n        this.errorTypes.set(errorType, (this.errorTypes.get(errorType) || 0) + 1);\n        \n        console.error(`[ExamBrowserRecovery] é”™è¯¯ ${this.errorCount}:`, error);\n        console.error(`[ExamBrowserRecovery] ä¸Šä¸‹æ–‡:`, context);\n        console.error(`[ExamBrowserRecovery] é€‰é¡¹:`, options);\n        \n        // è®°å½•é”™è¯¯åˆ°æœ¬åœ°å­˜å‚¨\n        this.logError(error, context, options);\n        \n        // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æœ€å¤§é”™è¯¯æ¬¡æ•°\n        if (this.errorCount > this.maxErrors) {\n            this.handleCriticalFailure();\n            return;\n        }\n        \n        // é€‰æ‹©æ¢å¤ç­–ç•¥\n        const strategyIndex = Math.min(this.errorCount - 1, this.recoveryStrategies.length - 1);\n        const strategy = this.recoveryStrategies[strategyIndex];\n        \n        try {\n            strategy.call(this, error, context, options);\n        } catch (recoveryError) {\n            console.error('[ExamBrowserRecovery] æ¢å¤ç­–ç•¥å¤±è´¥:', recoveryError);\n            // é€’å½’è°ƒç”¨ä¸‹ä¸€ä¸ªç­–ç•¥\n            this.handleError(recoveryError, 'Recovery Strategy Failed');\n        }\n    }\n    \n    /**\n     * æ¢å¤ç­–ç•¥1: é‡æ–°åˆå§‹åŒ–DOMç»“æ„\n     */\n    reInitializeDOM(error, context) {\n        console.log('[ExamBrowserRecovery] ç­–ç•¥1: é‡æ–°åˆå§‹åŒ–DOMç»“æ„');\n        \n        try {\n            // ç¡®ä¿DOMç»“æ„å­˜åœ¨\n            if (this.examBrowser && this.examBrowser.ensureDOMStructure) {\n                this.examBrowser.ensureDOMStructure();\n            }\n            \n            // é‡æ–°åˆå§‹åŒ–ç»„ä»¶\n            if (this.examBrowser && this.examBrowser.initialize) {\n                this.examBrowser.initialize();\n            }\n            \n            this.showRecoveryMessage('DOMç»“æ„å·²é‡æ–°åˆå§‹åŒ–', 'info');\n            \n        } catch (initError) {\n            console.error('[ExamBrowserRecovery] DOMé‡æ–°åˆå§‹åŒ–å¤±è´¥:', initError);\n            throw initError;\n        }\n    }\n    \n    /**\n     * æ¢å¤ç­–ç•¥2: é‡æ–°åŠ è½½é¢˜ç›®æ•°æ®\n     */\n    reloadExamData(error, context) {\n        console.log('[ExamBrowserRecovery] ç­–ç•¥2: é‡æ–°åŠ è½½é¢˜ç›®æ•°æ®');\n        \n        try {\n            // é‡æ–°åŠ è½½é¢˜åº“\n            if (window.loadLibrary) {\n                window.loadLibrary();\n            }\n            \n            // å»¶è¿Ÿåˆ·æ–°åˆ—è¡¨\n            setTimeout(() => {\n                if (this.examBrowser && this.examBrowser.refreshExamList) {\n                    this.examBrowser.refreshExamList();\n                }\n            }, 1000);\n            \n            this.showRecoveryMessage('é¢˜ç›®æ•°æ®å·²é‡æ–°åŠ è½½', 'info');\n            \n        } catch (loadError) {\n            console.error('[ExamBrowserRecovery] æ•°æ®é‡æ–°åŠ è½½å¤±è´¥:', loadError);\n            throw loadError;\n        }\n    }\n    \n    /**\n     * æ¢å¤ç­–ç•¥3: å¯ç”¨åŸºç¡€è§†å›¾æ¨¡å¼\n     */\n    fallbackToBasicView(error, context) {\n        console.log('[ExamBrowserRecovery] ç­–ç•¥3: å¯ç”¨åŸºç¡€è§†å›¾æ¨¡å¼');\n        \n        try {\n            const container = document.getElementById('exam-list-container');\n            if (container) {\n                container.innerHTML = this.generateBasicFallbackHTML();\n            }\n            \n            // ç¦ç”¨é«˜çº§åŠŸèƒ½\n            this.disableAdvancedFeatures();\n            \n            this.showRecoveryMessage('å·²å¯ç”¨åŸºç¡€è§†å›¾æ¨¡å¼', 'warning');\n            \n        } catch (fallbackError) {\n            console.error('[ExamBrowserRecovery] åŸºç¡€è§†å›¾æ¨¡å¼å¯ç”¨å¤±è´¥:', fallbackError);\n            throw fallbackError;\n        }\n    }\n    \n    /**\n     * æ¢å¤ç­–ç•¥4: é‡ç½®åˆ°é»˜è®¤çŠ¶æ€\n     */\n    resetToDefault(error, context) {\n        console.log('[ExamBrowserRecovery] ç­–ç•¥4: é‡ç½®åˆ°é»˜è®¤çŠ¶æ€');\n        \n        try {\n            // æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„æµè§ˆçŠ¶æ€\n            localStorage.removeItem('browse_state');\n            \n            // é‡ç½®ExamBrowserçŠ¶æ€\n            if (this.examBrowser) {\n                this.examBrowser.resetBrowseState();\n            }\n            \n            // é‡æ–°åŠ è½½é¡µé¢ï¼ˆæœ€åæ‰‹æ®µï¼‰\n            setTimeout(() => {\n                if (confirm('ç³»ç»Ÿé‡åˆ°é—®é¢˜ï¼Œæ˜¯å¦é‡æ–°åŠ è½½é¡µé¢ï¼Ÿ')) {\n                    window.location.reload();\n                }\n            }, 2000);\n            \n            this.showRecoveryMessage('ç³»ç»Ÿå·²é‡ç½®åˆ°é»˜è®¤çŠ¶æ€', 'warning');\n            \n        } catch (resetError) {\n            console.error('[ExamBrowserRecovery] é‡ç½®å¤±è´¥:', resetError);\n            throw resetError;\n        }\n    }\n    \n    /**\n     * æ¢å¤ç­–ç•¥5: æ˜¾ç¤ºä¸¥é‡é”™è¯¯\n     */\n    showCriticalError(error, context) {\n        console.log('[ExamBrowserRecovery] ç­–ç•¥5: æ˜¾ç¤ºä¸¥é‡é”™è¯¯');\n        \n        const container = document.getElementById('exam-list-container');\n        if (container) {\n            container.innerHTML = this.generateCriticalErrorHTML(error, context);\n        }\n        \n        this.showRecoveryMessage('ç³»ç»Ÿé‡åˆ°ä¸¥é‡é”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢', 'error');\n    }\n    \n    /**\n     * å¤„ç†å½»åº•å¤±è´¥\n     */\n    handleCriticalFailure() {\n        console.error('[ExamBrowserRecovery] è¾¾åˆ°æœ€å¤§é”™è¯¯æ¬¡æ•°ï¼Œè¿›å…¥å½»åº•å¤±è´¥æ¨¡å¼');\n        \n        // æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯é¡µé¢\n        const container = document.getElementById('exam-list-container');\n        if (container) {\n            container.innerHTML = `\n                <div class=\"critical-failure\">\n                    <div class=\"failure-icon\">âŒ</div>\n                    <h2>ç³»ç»Ÿé‡åˆ°ä¸¥é‡é—®é¢˜</h2>\n                    <p>é¢˜åº“æµè§ˆå™¨é‡åˆ°äº†æ— æ³•è‡ªåŠ¨æ¢å¤çš„é”™è¯¯ã€‚</p>\n                    <div class=\"failure-stats\">\n                        <p>é”™è¯¯æ¬¡æ•°: ${this.errorCount}</p>\n                        <p>é”™è¯¯ç±»å‹: ${Array.from(this.errorTypes.keys()).join(', ')}</p>\n                    </div>\n                    <div class=\"failure-actions\">\n                        <button class=\"btn btn-primary\" onclick=\"window.location.reload()\">\n                            é‡æ–°åŠ è½½é¡µé¢\n                        </button>\n                        <button class=\"btn btn-secondary\" onclick=\"this.exportErrorLog()\">\n                            å¯¼å‡ºé”™è¯¯æ—¥å¿—\n                        </button>\n                    </div>\n                </div>\n            `;\n        }\n        \n        // å¯¼å‡ºé”™è¯¯æ—¥å¿—\n        this.exportErrorLog();\n    }\n    \n    /**\n     * ç”ŸæˆåŸºç¡€é™çº§HTML\n     */\n    generateBasicFallbackHTML() {\n        return `\n            <div class=\"fallback-browser\">\n                <div class=\"fallback-header\">\n                    <h3>ğŸ“š åŸºç¡€é¢˜åº“æµè§ˆ</h3>\n                    <p>ç³»ç»Ÿæ­£åœ¨åŸºç¡€æ¨¡å¼ä¸‹è¿è¡Œ</p>\n                </div>\n                <div class=\"fallback-controls\">\n                    <button class=\"btn\" onclick=\"window.location.reload()\">åˆ·æ–°é¡µé¢</button>\n                    <button class=\"btn btn-secondary\" onclick=\"window.loadLibrary()\">é‡æ–°åŠ è½½é¢˜åº“</button>\n                </div>\n                <div class=\"fallback-list\" id=\"fallback-exam-list\">\n                    <p>æ­£åœ¨åŠ è½½é¢˜ç›®åˆ—è¡¨...</p>\n                </div>\n            </div>\n        `;\n    }\n    \n    /**\n     * ç”Ÿæˆä¸¥é‡é”™è¯¯HTML\n     */\n    generateCriticalErrorHTML(error, context) {\n        return `\n            <div class=\"critical-error\">\n                <div class=\"error-icon\">âš ï¸</div>\n                <h3>ç³»ç»Ÿé”™è¯¯</h3>\n                <p>é”™è¯¯ä¿¡æ¯: ${error?.message || 'æœªçŸ¥é”™è¯¯'}</p>\n                <p>é”™è¯¯ä¸Šä¸‹æ–‡: ${context}</p>\n                <div class=\"error-actions\">\n                    <button class=\"btn\" onclick=\"window.location.reload()\">\n                        é‡æ–°åŠ è½½é¡µé¢\n                    </button>\n                    <button class=\"btn btn-secondary\" onclick=\"console.log('é”™è¯¯è¯¦æƒ…:', '${JSON.stringify({error: error?.message, context})}')\">\n                        æŸ¥çœ‹è¯¦æƒ…\n                    </button>\n                </div>\n            </div>\n        `;\n    }\n    \n    /**\n     * ç¦ç”¨é«˜çº§åŠŸèƒ½\n     */\n    disableAdvancedFeatures() {\n        // ç¦ç”¨è™šæ‹Ÿæ»šåŠ¨\n        if (this.examBrowser && this.examBrowser.virtualScroller) {\n            this.examBrowser.virtualScroller.destroy();\n            this.examBrowser.virtualScroller = null;\n        }\n        \n        // ç¦ç”¨æ€§èƒ½ä¼˜åŒ–\n        if (window.performanceOptimizer) {\n            window.performanceOptimizer.destroy();\n        }\n        \n        console.log('[ExamBrowserRecovery] é«˜çº§åŠŸèƒ½å·²ç¦ç”¨');\n    }\n    \n    /**\n     * è®¾ç½®å¥åº·æ£€æŸ¥\n     */\n    setupHealthCheck() {\n        setInterval(() => {\n            this.performHealthCheck();\n        }, 30000); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡\n    }\n    \n    /**\n     * æ‰§è¡Œå¥åº·æ£€æŸ¥\n     */\n    performHealthCheck() {\n        try {\n            // æ£€æŸ¥å…³é”®DOMå…ƒç´ \n            const criticalElements = [\n                'browse-view',\n                'exam-list-container',\n                'exam-list'\n            ];\n            \n            for (const elementId of criticalElements) {\n                if (!document.getElementById(elementId)) {\n                    throw new Error(`å…³é”®å…ƒç´ ç¼ºå¤±: ${elementId}`);\n                }\n            }\n            \n            // æ£€æŸ¥ExamBrowserå®ä¾‹\n            if (!this.examBrowser || !this.examBrowser.initialized) {\n                throw new Error('ExamBrowserå®ä¾‹æœªæ­£ç¡®åˆå§‹åŒ–');\n            }\n            \n        } catch (healthError) {\n            console.warn('[ExamBrowserRecovery] å¥åº·æ£€æŸ¥å¤±è´¥:', healthError);\n            this.handleError(healthError, 'Health Check Failed');\n        }\n    }\n    \n    /**\n     * è®°å½•é”™è¯¯åˆ°æœ¬åœ°å­˜å‚¨\n     */\n    logError(error, context, options) {\n        try {\n            const errorLog = {\n                id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),\n                timestamp: new Date().toISOString(),\n                error: {\n                    name: error?.name || 'Unknown',\n                    message: error?.message || 'No message',\n                    stack: error?.stack || 'No stack trace'\n                },\n                context,\n                options,\n                userAgent: navigator.userAgent,\n                url: window.location.href,\n                viewport: {\n                    width: window.innerWidth,\n                    height: window.innerHeight\n                }\n            };\n            \n            const existingLogs = JSON.parse(localStorage.getItem('exam_browser_error_log') || '[]');\n            existingLogs.push(errorLog);\n            \n            // åªä¿ç•™æœ€è¿‘50ä¸ªé”™è¯¯\n            if (existingLogs.length > 50) {\n                existingLogs.splice(0, existingLogs.length - 50);\n            }\n            \n            localStorage.setItem('exam_browser_error_log', JSON.stringify(existingLogs));\n            \n        } catch (logError) {\n            console.error('[ExamBrowserRecovery] è®°å½•é”™è¯¯å¤±è´¥:', logError);\n        }\n    }\n    \n    /**\n     * å¯¼å‡ºé”™è¯¯æ—¥å¿—\n     */\n    exportErrorLog() {\n        try {\n            const errorLog = localStorage.getItem('exam_browser_error_log');\n            if (errorLog) {\n                const blob = new Blob([errorLog], { type: 'application/json' });\n                const url = URL.createObjectURL(blob);\n                const a = document.createElement('a');\n                a.href = url;\n                a.download = `exam_browser_errors_${new Date().toISOString().slice(0, 10)}.json`;\n                document.body.appendChild(a);\n                a.click();\n                document.body.removeChild(a);\n                URL.revokeObjectURL(url);\n                \n                console.log('[ExamBrowserRecovery] é”™è¯¯æ—¥å¿—å·²å¯¼å‡º');\n            }\n        } catch (exportError) {\n            console.error('[ExamBrowserRecovery] å¯¼å‡ºé”™è¯¯æ—¥å¿—å¤±è´¥:', exportError);\n        }\n    }\n    \n    /**\n     * æ˜¾ç¤ºæ¢å¤æ¶ˆæ¯\n     */\n    showRecoveryMessage(message, type = 'info') {\n        if (window.showMessage) {\n            window.showMessage(`[æ¢å¤] ${message}`, type);\n        } else {\n            console.log(`[ExamBrowserRecovery] ${message}`);\n        }\n    }\n    \n    /**\n     * è·å–é”™è¯¯ç»Ÿè®¡\n     */\n    getErrorStats() {\n        return {\n            totalErrors: this.errorCount,\n            errorTypes: Object.fromEntries(this.errorTypes),\n            lastErrorTime: this.lastErrorTime,\n            maxErrors: this.maxErrors\n        };\n    }\n    \n    /**\n     * é‡ç½®é”™è¯¯è®¡æ•°\n     */\n    resetErrorCount() {\n        console.log('[ExamBrowserRecovery] é‡ç½®é”™è¯¯è®¡æ•°');\n        this.errorCount = 0;\n        this.errorTypes.clear();\n        this.lastErrorTime = null;\n    }\n    \n    /**\n     * é”€æ¯é”™è¯¯æ¢å¤æœºåˆ¶\n     */\n    destroy() {\n        console.log('[ExamBrowserRecovery] é”€æ¯é”™è¯¯æ¢å¤æœºåˆ¶');\n        \n        // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨\n        // æ³¨æ„ï¼šå…¨å±€é”™è¯¯ç›‘å¬å™¨é€šå¸¸ä¸éœ€è¦ç§»é™¤ï¼Œå› ä¸ºå®ƒä»¬æ˜¯å…¨å±€çš„\n        \n        // æ¸…ç†å¼•ç”¨\n        this.examBrowser = null;\n    }\n}\n\n// å¯¼å‡ºåˆ°å…¨å±€\nwindow.ExamBrowserRecovery = ExamBrowserRecovery;