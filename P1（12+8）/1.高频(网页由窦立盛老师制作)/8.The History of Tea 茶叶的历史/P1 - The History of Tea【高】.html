<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>P1 – The History of Tea (Fixed & Optimized)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root { 
    --line: #e5e7eb; 
    --bg: #f6f7fb; 
    --panel: #fff; 
    --accent: #3b82f6; 
    --muted: #6b7280; 
    --shadow: 0 6px 20px rgba(0,0,0,.12); 
  }
  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body { 
    margin: 0; 
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; 
    background: var(--bg); 
    padding-bottom: 82px; 
  }
  
  /* 布局样式 */
  .shell { display: flex; height: 100vh; width: 100%; }
  .pane { background: var(--panel); overflow: auto; padding: 20px; }
  #left { flex: 0 0 50%; min-width: 280px; }
  #right { flex: 1 1 auto; min-width: 320px; background: #fbfbff; border-left: 1px solid var(--line); }
  #divider { flex: 0 0 8px; background: linear-gradient(90deg, #e5e7eb, #d1d5db); cursor: ew-resize; position: relative; z-index: 5; user-select: none; }
  
  /* 文本样式 */
  h2, h3, h4 { margin: 0 0 10px; }
  #left p { margin: 0 0 12px; line-height: 1.6; word-break: normal; overflow-wrap: normal; hyphens: none; }
  
  /* 组件样式 */
  .group { background: #fff; border: 1px solid var(--line); border-radius: 10px; padding: 12px; margin-bottom: 14px; }
  input.blank { 
    border: none; 
    border-bottom: 1px solid #9ca3af; 
    padding: 2px 4px; 
    font-size: 1em; 
    background: transparent; 
    min-width: 80px;
    margin: 0 4px;
  }
  input.blank:focus { outline: none; border-bottom: 2px solid var(--accent); }
  
  /* 按钮样式 */
  button { 
    padding: 8px 12px; 
    border: 1px solid var(--line); 
    background: #fff; 
    border-radius: 6px; 
    cursor: pointer; 
    transition: all 0.2s; 
    font-size: 14px; 
  }
  button:hover { background: #f8fafc; border-color: #cbd5e1; }
  button.primary { 
    background: var(--accent); 
    color: #fff; 
    border-color: var(--accent); 
  }
  button.primary:hover { background: #2563eb; }
  
  /* 计时器样式 */
  #timer { 
    background: #fff; 
    color: var(--muted); 
    border: 1px solid var(--line); 
    border-radius: 6px; 
    padding: 6px 12px; 
    cursor: pointer; 
    font-family: 'Courier New', monospace; 
    transition: all 0.2s; 
    min-width: 70px;
    text-align: center;
    font-size: 18px;
    font-weight: bold;
  }
  #timer:hover { 
    background: #f1f5f9; 
    border-color: var(--accent); 
  }
  #timer.paused { 
    color: #ef4444; 
    border-color: #fecaca; 
    background: #fef2f2; 
  }
  
  /* 主题切换按钮 */
  .theme-toggle { 
    background: #fff; 
    color: var(--muted); 
    border: 1px solid var(--line); 
    border-radius: 6px; 
    width: 36px;
    height: 36px;
    font-size: 16px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .theme-toggle:hover {
    background: var(--accent);
    color: #fff;
    border-color: var(--accent);
    transform: scale(1.05);
  }
  
  /* 深色模式样式 */
  body.dark { 
    --bg: #0f172a; 
    --panel: #1e293b; 
    --line: #334155; 
    --muted: #94a3b8; 
    color: #e2e8f0; 
  }
  body.dark #right { background: #0f172a; }
  body.dark .group { background: #1e293b; border-color: #334155; }
  body.dark button { background: #1e293b; color: #e2e8f0; border-color: #334155; }
  body.dark button:hover { background: #334155; }
  body.dark button.primary { background: var(--accent); color: #fff; }
  body.dark #results { background: #1e293b; border-color: #334155; }
  body.dark #notes { background: #1e293b; border-color: #334155; color: #e2e8f0; }
  body.dark .practice-nav { background: #1e293b; border-color: #334155; }
  body.dark .q-item { background: #0f172a; color: #e2e8f0; border-color: #334155; }
  body.dark .q-item:hover { background: #334155; }
  body.dark .q-item.answered { background: #1e40af; border-color: var(--accent); color: #93c5fd; }
  body.dark #timer { background: #1e293b; color: #e2e8f0; border-color: #334155; }
  body.dark #timer:hover { background: #334155; border-color: var(--accent); }
  body.dark details.answerbox { background: #1e293b; border-color: #334155; }
  body.dark input.blank { color: #e2e8f0; border-bottom-color: #64748b; }
  body.dark input.blank:focus { border-bottom-color: var(--accent); }
  body.dark table, body.dark th, body.dark td { border-color: var(--line); }

  /* 响应式设计 */
  @media (max-width: 768px) {
    .shell { flex-direction: column; }
    #left, #right { flex: none; min-width: auto; }
    #divider { display: none; }
    .practice-nav .controls { gap: 8px; }
    #timer { font-size: 12px; padding: 3px 8px; }
    .theme-toggle { width: 32px; height: 32px; font-size: 14px; }
    #notes { width: calc(100vw - 24px); right: 12px; left: 12px; }
  }
  
  /* 选择工具栏 */
  #selbar { 
    position: fixed; 
    display: none; 
    z-index: 2000; 
    background: #111; 
    color: #fff; 
    border-radius: 8px; 
    padding: 6px; 
    box-shadow: var(--shadow); 
    font-size: 13px; 
    gap: 6px; 
    align-items: center; 
  }
  #selbar button { 
    background: transparent; 
    color: #fff; 
    border: 1px solid rgba(255,255,255,.25); 
    padding: 4px 8px; 
    border-radius: 6px; 
    cursor: pointer; 
  }
  #selbar button:hover { border-color: #fff; }
  
  /* 笔记面板 */
  #notes { 
    position: fixed; 
    right: 12px; 
    bottom: 12px; 
    width: 320px; 
    height: 42vh; 
    background: #fff; 
    border: 1px solid var(--line); 
    border-radius: 12px; 
    display: none; 
    flex-direction: column; 
    z-index: 1500; 
    box-shadow: var(--shadow); 
  }
  #notes header { 
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
    padding: 8px 10px; 
    border-bottom: 1px solid var(--line); 
  }
  #notes textarea { 
    flex: 1; 
    border: 0; 
    padding: 10px; 
    resize: none; 
    font-size: 14px; 
    line-height: 1.5; 
  }
  
  /* Toast通知 */
  #toast { 
    position: fixed; 
    bottom: 20px; 
    left: 50%; 
    transform: translateX(-50%); 
    background: rgba(0,0,0,0.8); 
    color: #fff; 
    padding: 8px 16px; 
    border-radius: 4px; 
    display: none; 
    z-index: 3000; 
    font-size: 14px; 
  }
  
  /* 答题导航 */
  .practice-nav { 
    background: #fff; 
    padding: 12px 20px; 
    display: flex; 
    align-items: center; 
    gap: 16px; 
    box-shadow: 0 2px 4px rgba(0,0,0,.05); 
    flex-wrap: wrap; 
    position: fixed; 
    left: 0; 
    right: 0; 
    bottom: 0; 
    border-top: 2px solid var(--line); 
    z-index: 4000; 
  }
  .practice-nav .title { font-weight: 600; color: var(--muted); }
  .practice-nav .questions { 
    display: flex; 
    gap: 8px; 
    align-items: center; 
    flex-wrap: wrap; 
  }
  .practice-nav .q-item { 
    padding: 6px 10px; 
    border: 1px solid var(--line); 
    border-radius: 6px; 
    background: #fff; 
    cursor: pointer; 
    font-size: 14px; 
    transition: all 0.2s; 
    min-width: 36px; 
    text-align: center; 
  }
  .practice-nav .q-item:hover { 
    background: #f1f5f9; 
    border-color: var(--accent); 
  }
  .practice-nav .q-item.answered { 
    background: #e0e7ff; 
    border-color: var(--accent); 
    color: var(--accent); 
    font-weight: 500; 
  }
  .practice-nav .q-item.active { 
    background: var(--accent); 
    color: #fff; 
  }
  .practice-nav .controls { 
    display: flex; 
    gap: 12px; 
    margin-left: auto; 
    align-items: center; 
  }
  
  /* 答题结果显示 */
  #results { 
    background: #fff; 
    border: 1px solid var(--line); 
    border-radius: 10px; 
    padding: 12px; 
    margin: 16px 0; 
    font-family: monospace; 
    white-space: pre-wrap; 
  }
  #results p { margin: 0 0 8px; }
  .badge { 
    background: #e0e7ff; 
    color: var(--accent); 
    padding: 2px 8px; 
    border-radius: 999px; 
    font-size: 12px; 
  }
  
  /* 答案框 */
  details.answerbox { 
    background: #fff; 
    border: 1px solid var(--line); 
    border-radius: 10px; 
    padding: 12px; 
    margin-top: 10px; 
  }
  details.answerbox summary { 
    cursor: pointer; 
    font-weight: 600; 
    list-style: none; 
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
  }
  details.answerbox summary::-webkit-details-marker { display: none; }
  #answerContent { margin-top: 10px; }
  #answerContent ol, #answerContent table { margin: 0; padding-left: 0; }
  #answerContent li { margin: 4px 0; }
  .answer-table th, .answer-table td { text-align: left; padding: 8px; border: 1px solid var(--line);}


  /* 高亮样式 */
  .hl { background: #ffeb3b; color: #000; }
  body.dark .hl { background: #8a6d00; color: #fff; }
  
  /* 滚动条样式 */
  ::-webkit-scrollbar { width: 8px; height: 8px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #c5c5d2; border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: #999; }
  body.dark ::-webkit-scrollbar-thumb { background: #4a5568; }
  body.dark ::-webkit-scrollbar-thumb:hover { background: #718096; }
</style>
</head>
<body>

<div class="practice-nav">
  <div class="title">Questions</div>
  <div class="questions">
    <div class="q-item" id="q1-nav" onclick="scrollToElement('q1-anchor')">1</div>
    <div class="q-item" id="q2-nav" onclick="scrollToElement('q2-anchor')">2</div>
    <div class="q-item" id="q3-nav" onclick="scrollToElement('q3-anchor')">3</div>
    <div class="q-item" id="q4-nav" onclick="scrollToElement('q4-anchor')">4</div>
    <div class="q-item" id="q5-nav" onclick="scrollToElement('q5-anchor')">5</div>
    <div class="q-item" id="q6-nav" onclick="scrollToElement('q6-anchor')">6</div>
    <div class="q-item" id="q7-nav" onclick="scrollToElement('q7-anchor')">7</div>
    <div class="q-item" id="q8-nav" onclick="scrollToElement('q8-anchor')">8</div>
    <div class="q-item" id="q9-nav" onclick="scrollToElement('q9-anchor')">9</div>
    <div class="q-item" id="q10-nav" onclick="scrollToElement('q10-anchor')">10</div>
    <div class="q-item" id="q11-nav" onclick="scrollToElement('q11-anchor')">11</div>
    <div class="q-item" id="q12-nav" onclick="scrollToElement('q12-anchor')">12</div>
    <div class="q-item" id="q13-nav" onclick="scrollToElement('q13-anchor')">13</div>
  </div>
  <div class="controls">
    <span id="timer" onclick="toggleTimer()">00:00</span>
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode">🌙</button>
  </div>
</div>

<div class="shell">
  <section class="pane" id="left">
    <h2>READING PASSAGE 1</h2>
    <p>You should spend about 20 minutes on Questions 1–13, which are based on Reading Passage 1 below.</p>
    
    <h3>The History of Tea</h3>
    
    <p>The story of tea begins in China. According to legend, in 2737 BC the Chinese emperor Shen Nung was sitting beneath a tree while his servant boiled drinking water, when some leaves from the tree blew into the water. Shen Nung, a renowned herbalist, decided to try the infusion that his servant had accidentally created. The tree was a Camellia sinensis, and the resulting drink was what we now call tea. It is impossible to know whether there is any truth in this story, but tea-drinking certainly became established in China many centuries before it had even been heard of in the West. Containers for tea have been found in tombs dating from the Han Dynasty (206 BC–220 AD), but it was under the Tang Dynasty (618–906 AD) that tea became firmly established as the national drink of China.</p>
    
    <p>It became such a favourite that during the late eighth century a writer called Lu Yu wrote the first book entirely about tea, the Ch’a Ching, or Tea Classic. It was shortly after this that tea was first introduced to Japan, by Japanese Buddhist monks who had travelled to China to study. Tea received almost instant imperial sponsorship and spread rapidly from the royal court and monasteries to the other sections of Japanese society.</p>
    
    <p>So at this stage in the history of tea, Europe was rather lagging behind. In the latter half of the sixteenth century there are the first brief mentions of tea as a drink among Europeans, mostly from Portuguese who were living in the East as traders and missionaries. But although some of these individuals may have brought back samples of tea to their native country, it was not the Portuguese who were the first to ship back tea as a commercial import.</p>
    
    <p>This was done by the Dutch, who in the last years of the sixteenth century began to encroach on Portuguese trading routes in the East. By the turn of the century they had established a trading post on the island of Java, and it was via Java that in 1606 the first consignment of tea was shipped from China to Holland. Tea soon became a fashionable drink among the Dutch, and from there spread to other countries in continental western Europe, but because of its high price it remained a drink for the wealthy.</p>
    
    <p>Britain, always a little suspicious of continental trends, had yet to become the nation of tea-drinkers that it is today. Starting in 1600, the British East India Company had a monopoly on importing goods from outside Europe, and it is likely that sailors on these ships brought tea home as gifts. The first coffee-house had been established in London in 1652, and tea was still somewhat unfamiliar to most readers, so it is fair to assume that the drink was still something of a curiosity.</p>
    
    <p>Gradually, it became a popular drink in coffee-houses, which were as much locations for the transaction of business as they were for relaxation or pleasure. They were, though, the preserve of middle- and upper-class men; women drank tea in their own homes, and as yet tea was still too expensive to be widespread among the working classes. In part, its high price was due to a punitive system of taxation.</p>
    
    <p>One unforeseen consequence of the taxation of tea was the growth of methods to avoid taxation-smuggling and adulteration. By the eighteenth century many Britons wanted to drink tea but could not afford the high prices, and their enthusiasm for the drink was matched by the enthusiasm of criminal gangs to smuggle it in. What began as a small-time illegal trade, selling a few pounds of tea to personal contacts, developed by the late eighteenth century into an astonishing organised-crime network, perhaps importing as much as seven million lb annually, compared to a legal import of five million lb!</p>
    
    <p>Worse for the drinkers was that taxation also encouraged the adulteration of tea, particularly of smuggled tea which was not quality-controlled through customs and excise. Leaves from other plants, or leaves which had already been brewed and then dried, were added to tea leaves. By 1784, the government realised that enough was enough, and that heavy taxation was creating more problems than it was worth. The new Prime Minister, William Pitt the Younger, slashed the tax from 119 per cent to 12.5 per cent. Suddenly legal tea was affordable, and smuggling stopped virtually overnight.</p>
    
    <p>Another great impetus to tea-drinking resulted from the end of the East India Company’s monopoly on trade with China, in 1834. Before that date, China was the country of origin of the vast majority of the tea imported to Britain, but the end of its monopoly stimulated the East India Company to consider growing tea outside China. India had always been the centre of the Company’s operations, which led to the increased cultivation of tea in India, beginning in Assam. There were a few false starts, including the destruction by cattle of one of the earliest tea nurseries, but by 1888 British tea imports from India were for the first time greater than those from China.</p>
    
    <p>The end of the East India Company’s monopoly on trade with China also had another result, which was more dramatic though less important in the long term: it ushered in the era of the tea clippers. While the Company had had the monopoly on trade, there was no rush to bring the tea from China to Britain, but after 1834 the tea trade became a virtual free-for-all. Individual merchants and sea-captains with their own ships raced to bring home the tea and make the most money, using fast new clippers which had sleek lines, tall masts and huge sails. In particular, there was competition between British and American merchants, leading to the famous clipper races of the 1860s. But these races soon came to an end with the opening of the Suez Canal, which made the trade routes to China viable for steamships for the first time.</p>
    
  </section>
  <div id="divider" title="Drag to resize"></div>
  <section class="pane" id="right">
    <h3>Questions</h3>
    
    <div class="group">
      <h4>Questions 1–7</h4>
      <p>Complete the sentences below.</p>
      <p>Choose <strong>ONE WORD ONLY</strong> from the passage for each answer.</p>
      
      <p id="q1-anchor"><strong>1.</strong> Researchers believe the tea containers detected in<input class="blank" name="q1" type="text"/>from the Han Dynasty were the first evidence of the use of tea.</p>
      <p id="q2-anchor"><strong>2.</strong> Lu Yu wrote a<input class="blank" name="q2" type="text"/>about tea before anyone else in the eighth century.</p>
      <p id="q3-anchor"><strong>3.</strong> It was<input class="blank" name="q3" type="text"/>from Japan who brought tea to their native country from China.</p>
      <p id="q4-anchor"><strong>4.</strong> Tea was carried from China to Europe by the<input class="blank" name="q4" type="text"/>.</p>
      <p id="q5-anchor"><strong>5.</strong> The British government had to cut the taxation on tea because of the serious crime of<input class="blank" name="q5" type="text"/>.</p>
      <p id="q6-anchor"><strong>6.</strong> Tea was planted in<input class="blank" name="q6" type="text"/>besides China in the 19th century.</p>
      <p id="q7-anchor"><strong>7.</strong> In order to compete in shipping speed, traders used<input class="blank" name="q7" type="text"/>for the race.</p>
    </div>
    
    <div class="group">
      <h4>Questions 8–13</h4>
      <p>Do the following statements agree with the information given in Reading Passage 1?</p>
      <p>In boxes 8–13 on your answer sheet, write</p>
      <ul>
        <li><strong>TRUE</strong> if the statement agrees with the information</li>
        <li><strong>FALSE</strong> if the statement contradicts the information</li>
        <li><strong>NOT GIVEN</strong> if there is no information on this</li>
      </ul>
      
      <div id="q8-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;">
        <p><strong>8.</strong> Tea was popular in Britain in the 16th century.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label><input name="q8" type="radio" value="TRUE"> TRUE</label>
          <label><input name="q8" type="radio" value="FALSE"> FALSE</label>
          <label><input name="q8" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <div id="q9-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;">
        <p><strong>9.</strong> Tea was more fashionable than coffee in Europe in the late 16th century.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label><input name="q9" type="radio" value="TRUE"> TRUE</label>
          <label><input name="q9" type="radio" value="FALSE"> FALSE</label>
          <label><input name="q9" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <div id="q10-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;">
        <p><strong>10.</strong> Tea was enjoyed by all classes in Britain in the 17th century.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label><input name="q10" type="radio" value="TRUE"> TRUE</label>
          <label><input name="q10" type="radio" value="FALSE"> FALSE</label>
          <label><input name="q10" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <div id="q11-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;">
        <p><strong>11.</strong> The adulteration of tea also prompted William Pitt the Younger to reduce the tax.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label><input name="q11" type="radio" value="TRUE"> TRUE</label>
          <label><input name="q11" type="radio" value="FALSE"> FALSE</label>
          <label><input name="q11" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <div id="q12-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;">
        <p><strong>12.</strong> Initial problems occurred when tea was planted outside China by the East India Company.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label><input name="q12" type="radio" value="TRUE"> TRUE</label>
          <label><input name="q12" type="radio" value="FALSE"> FALSE</label>
          <label><input name="q12" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <div id="q13-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;">
        <p><strong>13.</strong> The fastest vessels were owned by America during the 19th-century clipper races.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label><input name="q13" type="radio" value="TRUE"> TRUE</label>
          <label><input name="q13" type="radio" value="FALSE"> FALSE</label>
          <label><input name="q13" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
    </div>

    <div style="display:flex;gap:8px;margin-bottom:10px;">
      <button class="primary" onclick="grade()">Submit</button>
      <button onclick="resetForm()">Reset</button>
      <button onclick="toggleNotes()">Notes</button>
    </div>
    <div id="results"></div>
    <details class="answerbox" id="answerBox">
      <summary>Show answers (click to toggle) <span class="badge">hidden</span></summary>
      <div id="answerContent"></div>
    </details>
  </section>
</div>

<div aria-label="Selection tools" id="selbar" role="toolbar">
  <button id="btnHL">Highlight</button>
  <button id="btnUH">Remove</button>
  <button id="btnNote">Note</button>
</div>

<div id="notes">
  <header>
    <strong>Notes</strong>
    <div>
      <button id="btnCopy">Copy</button>
      <button id="btnClose">Close</button>
    </div>
  </header>
  <textarea id="noteArea" placeholder="Type your notes here..."></textarea>
</div>

<div id="toast"></div>

<script>
// 页面滚动功能
function scrollToElement(id) {
  const element = document.getElementById(id);
  if (element) {
    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
    const navItem = document.getElementById(id.replace('-anchor', '-nav'));
    if(navItem) {
      navItem.classList.add('active');
      setTimeout(() => navItem.classList.remove('active'), 1200);
    }
  }
}

// 重置表单功能
function resetForm() {
  document.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);
  document.querySelectorAll('input.blank').forEach(input => input.value = '');
  document.getElementById('results').innerHTML = '';
  document.getElementById('answerContent').innerHTML = '';
  const answerBadge = document.querySelector('#answerBox .badge');
  if (answerBadge) answerBadge.textContent = 'hidden';
  if (document.getElementById('answerBox').hasAttribute('open')) {
      document.getElementById('answerBox').removeAttribute('open');
  }
  updateAnswerStatus();
  showToast('Form reset');
}

// Toast通知功能
function showToast(msg) {
  const toastEl = document.getElementById('toast');
  toastEl.textContent = msg;
  toastEl.style.display = 'block';
  setTimeout(() => { toastEl.style.display = 'none'; }, 1500);
}

// 计时器功能
let timerSeconds = 0;
let timerRunning = false;
let timerInterval;
const timerEl = document.getElementById('timer');

function updateTimerDisplay() {
  const minutes = Math.floor(timerSeconds / 60);
  const seconds = timerSeconds % 60;
  timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function startTimer() {
    if (timerRunning) return;
    timerRunning = true;
    timerEl.classList.remove('paused');
    timerInterval = setInterval(() => {
        timerSeconds++;
        updateTimerDisplay();
    }, 1000);
}

function stopTimer() {
    timerRunning = false;
    timerEl.classList.add('paused');
    clearInterval(timerInterval);
}

function toggleTimer() {
  if (timerRunning) {
    stopTimer();
    showToast('Timer paused');
  } else {
    startTimer();
    showToast('Timer resumed');
  }
}

// 主题切换功能
function toggleTheme() {
  document.body.classList.toggle('dark');
  const isDark = document.body.classList.contains('dark');
  localStorage.setItem('darkMode', isDark);
  document.querySelector('.theme-toggle').textContent = isDark ? '☀️' : '🌙';
}

// 拖拽分栏功能
const divider = document.getElementById('divider');
const leftPane = document.getElementById('left');
let isDragging = false;

divider.addEventListener('mousedown', (e) => {
  isDragging = true;
  document.body.style.cursor = 'ew-resize';
  e.preventDefault();
});

window.addEventListener('mousemove', (e) => {
  if (!isDragging) return;
  const shellRect = document.querySelector('.shell').getBoundingClientRect();
  let newLeftWidth = e.clientX - shellRect.left;
  if (newLeftWidth < 280) newLeftWidth = 280; // min-width
  if (newLeftWidth > shellRect.width - 320) newLeftWidth = shellRect.width - 320; // min-width
  leftPane.style.flexBasis = newLeftWidth + 'px';
});

window.addEventListener('mouseup', () => {
  isDragging = false;
  document.body.style.cursor = 'default';
});

// 高亮和笔记功能
const selbar = document.getElementById('selbar');
let lastRange = null;

function positionSelbar() {
    const selection = window.getSelection();
    if (!selection || selection.rangeCount === 0 || selection.isCollapsed) {
        selbar.style.display = 'none';
        return;
    }
    const range = selection.getRangeAt(0);
    lastRange = range.cloneRange();
    const rect = range.getBoundingClientRect();
    selbar.style.display = 'flex';
    selbar.style.top = `${window.scrollY + rect.top - selbar.offsetHeight - 5}px`;
    selbar.style.left = `${window.scrollX + rect.left + rect.width / 2 - selbar.offsetWidth / 2}px`;
}

document.getElementById('left').addEventListener('mouseup', positionSelbar);

document.getElementById('btnHL').addEventListener('click', () => {
    if (lastRange) {
        const span = document.createElement('span');
        span.className = 'hl';
        try {
            lastRange.surroundContents(span);
        } catch (e) {
            console.warn("Could not surround contents, wrapping instead.", e);
            span.appendChild(lastRange.extractContents());
            lastRange.insertNode(span);
        }
        window.getSelection().removeAllRanges();
        selbar.style.display = 'none';
    }
});

document.getElementById('btnUH').addEventListener('click', () => {
    if (lastRange) {
        const ancestor = lastRange.commonAncestorContainer;
        ancestor.querySelectorAll('.hl').forEach(hl => {
            if (lastRange.intersectsNode(hl)) {
                const parent = hl.parentNode;
                while (hl.firstChild) {
                    parent.insertBefore(hl.firstChild, hl);
                }
                parent.removeChild(hl);
                parent.normalize();
            }
        });
        window.getSelection().removeAllRanges();
        selbar.style.display = 'none';
    }
});

// 笔记功能
const notesPanel = document.getElementById('notes');
const noteArea = document.getElementById('noteArea');

function toggleNotes() {
    notesPanel.style.display = (notesPanel.style.display === 'flex' ? 'none' : 'flex');
}
window.toggleNotes = toggleNotes;

document.getElementById('btnClose').addEventListener('click', toggleNotes);
document.getElementById('btnCopy').addEventListener('click', async () => {
  await navigator.clipboard.writeText(noteArea.value || '');
  showToast('Copied');
});

document.getElementById('btnNote').addEventListener('click', () => {
  const selection = window.getSelection().toString().trim();
  if (selection) {
    noteArea.value += (noteArea.value ? '\n\n' : '') + `> ${selection}`;
    toggleNotes();
    window.getSelection().removeAllRanges();
    selbar.style.display = 'none';
  }
});


// 答题状态更新
function updateAnswerStatus() {
  for (let i = 1; i <= 13; i++) {
    const inputs = document.querySelectorAll(`input[name="q${i}"]`);
    const navItem = document.getElementById(`q${i}-nav`);
    if (navItem) {
      let answered = false;
      inputs.forEach(input => {
        if ((input.type === 'radio' && input.checked) || (input.type === 'text' && input.value.trim())) {
          answered = true;
        }
      });
      navItem.classList.toggle('answered', answered);
    }
  }
}

// 答案和评分系统
const correctAnswers = {
  "q1":"tombs", "q2":"book", "q3":"monks", "q4":"Dutch", "q5":"smuggling", "q6":"India", "q7":"clippers",
  "q8":"FALSE", "q9":"NOT GIVEN", "q10":"FALSE", "q11":"TRUE", "q12":"TRUE", "q13":"NOT GIVEN"
};

function grade() {
  let total = 0, correct = 0, resultLines = [];
  
  for (let i = 1; i <= 13; i++) {
    total++;
    const questionName = `q${i}`;
    const radioChecked = document.querySelector(`input[name="${questionName}"]:checked`);
    const textInput = document.querySelector(`input[name="${questionName}"][type="text"]`);
    let userAnswer = '';
    
    if (radioChecked) {
      userAnswer = radioChecked.value;
    } else if (textInput) {
      userAnswer = textInput.value.trim();
    }
    
    const isCorrect = userAnswer.toLowerCase() === correctAnswers[questionName].toLowerCase();
    
    if (isCorrect) correct++;
    resultLines.push(`${questionName.toUpperCase()}: ${userAnswer || 'None'} ${isCorrect ? '✓' : '✗'}`);
  }
  
  const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;
  document.getElementById('results').innerHTML = `
    <p><strong>Score:</strong> ${correct}/${total} <span class="badge">Accuracy ${accuracy}%</span></p>
    <pre>${resultLines.join('\n')}</pre>
  `;
  
  // Populate the answer key table
  document.getElementById('answerContent').innerHTML = `
    <table class="answer-table">
        <thead>
            <tr><th>Question</th><th>Answer</th></tr>
        </thead>
        <tbody>
            <tr><td>1</td><td>tombs</td></tr>
            <tr><td>2</td><td>book</td></tr>
            <tr><td>3</td><td>monks</td></tr>
            <tr><td>4</td><td>Dutch</td></tr>
            <tr><td>5</td><td>smuggling</td></tr>
            <tr><td>6</td><td>India</td></tr>
            <tr><td>7</td><td>clippers</td></tr>
            <tr><td>8</td><td>FALSE</td></tr>
            <tr><td>9</td><td>NOT GIVEN</td></tr>
            <tr><td>10</td><td>FALSE</td></tr>
            <tr><td>11</td><td>TRUE</td></tr>
            <tr><td>12</td><td>TRUE</td></tr>
            <tr><td>13</td><td>NOT GIVEN</td></tr>
        </tbody>
    </table>
  `;
  document.querySelector('#answerBox .badge').textContent = 'tap to view';
  
  updateAnswerStatus();
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', () => {
  startTimer();
  updateAnswerStatus();
  
  if (localStorage.getItem('darkMode') === 'true') {
    document.body.classList.add('dark');
    document.querySelector('.theme-toggle').textContent = '☀️';
  }
  
  loadPracticePageEnhancer();
});

// 监听答案变化以更新导航栏状态
document.addEventListener('change', updateAnswerStatus);
document.addEventListener('input', updateAnswerStatus);

// ##################################################################
// #               跨窗口数据传输功能 (增强脚本)                      #
// ##################################################################
function loadPracticePageEnhancer() {
  const script = document.createElement('script');
  script.src = '../../../js/practice-page-enhancer.js';
  script.onload = function() {
    console.log('练习页面增强脚本已加载');
  };
  script.onerror = function() {
    console.error('练习页面增强脚本加载失败，降级到内联版本。');
    loadInlineEnhancer();
  };
  document.head.appendChild(script);
}

function loadInlineEnhancer() {
  if (window.practicePageEnhancer) return;
  
  window.practicePageEnhancer = {
    initialize: function() {
      console.log('[InlineEnhancer] 内联增强器已初始化');
      this.setupCommunication();
      this.setupAnswerListeners();
      this.interceptSubmit();
    },
    
    setupCommunication: function() {
      this.parentWindow = window.opener || window.parent;
      window.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'INIT_SESSION') {
          this.sessionId = event.data.data.sessionId;
          this.sendMessage('SESSION_READY', {
            pageType: this.detectPageType(),
            url: window.location.href
          });
        }
      });
    },
    
    detectPageType: function() {
      const title = document.title || '';
      if (title.includes('P1')) return 'P1';
      return 'unknown';
    },
    
    setupAnswerListeners: function() {
      this.answers = {};
      this.startTime = Date.now();
      
      document.addEventListener('change', (e) => {
        if (e.target.name && e.target.name.startsWith('q')) {
          this.answers[e.target.name] = e.target.value;
        }
      });
      
      document.addEventListener('input', (e) => {
        if (e.target.name && e.target.name.startsWith('q')) {
          this.answers[e.target.name] = e.target.value;
        }
      });
    },
    
    interceptSubmit: function() {
      if (typeof window.grade === 'function') {
        const originalGrade = window.grade;
        window.grade = () => {
          originalGrade();
          setTimeout(() => this.handleSubmit(), 200);
        };
      }
    },
    
    handleSubmit: function() {
      const results = {
        sessionId: this.sessionId,
        startTime: this.startTime,
        endTime: Date.now(),
        duration: Math.round((Date.now() - this.startTime) / 1000),
        answers: this.answers,
        scoreInfo: this.extractScore(),
        pageType: this.detectPageType(),
        url: window.location.href
      };
      
      this.sendMessage('PRACTICE_COMPLETE', results);
    },
    
    extractScore: function() {
      const resultsEl = document.getElementById('results');
      if (!resultsEl) return null;
      
      const text = resultsEl.textContent || '';
      const scoreMatch = text.match(/Score:\s*(\d+)\/(\d+)/i);
      if (scoreMatch) {
        const correct = parseInt(scoreMatch[1], 10);
        const total = parseInt(scoreMatch[2], 10);
        return {
          correct: correct,
          total: total,
          accuracy: total > 0 ? correct / total : 0,
          percentage: total > 0 ? Math.round((correct / total) * 100) : 0,
          source: 'inline_extraction'
        };
      }
      return null;
    },
    
    sendMessage: function(type, data) {
      if (this.parentWindow && this.parentWindow !== window) {
        this.parentWindow.postMessage({
          type: type,
          data: data,
          source: 'practice_page'
        }, '*');
      }
    }
  };
  
  window.practicePageEnhancer.initialize();
}
</script>

</body>
</html>