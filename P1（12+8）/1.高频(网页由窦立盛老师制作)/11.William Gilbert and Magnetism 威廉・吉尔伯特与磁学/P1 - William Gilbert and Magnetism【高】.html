<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>P1 – William Gilbert and Magnetism</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<style>
  :root { --line:#e5e7eb; --bg:#f6f7fb; --panel:#fff; --accent:#3b82f6; --muted:#6b7280; --shadow:0 6px 20px rgba(0,0,0,.12); }
  * { box-sizing: border-box; }
  html,body { height:100%; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); }
  #timer { position: static; display: inline-block; margin-left: 8px; background:#fff; border:1px solid var(--line); border-radius:10px; padding:2px 8px; font-size:14px; vertical-align: middle; }
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:var(--panel); overflow:auto; padding:20px; }
  #left { flex: 0 0 50%; min-width: 280px; }
  #right { flex: 1 1 auto; min-width: 320px; background:#fbfbff; border-left:1px solid var(--line); }
  #divider { flex: 0 0 8px; background: linear-gradient(90deg,#e5e7eb,#d1d5db); cursor: ew-resize; position:relative; z-index: 5; user-select:none; }
  h2,h3,h4 { margin:0 0 10px; }
  #left p { margin: 0 0 12px; line-height: 1.6; word-break: normal; overflow-wrap: normal; hyphens: none; }
  .group { background:#fff; border:1px solid var(--line); border-radius:10px; padding:12px; margin-bottom:14px; }
  table { border-collapse: collapse; width:100%; }
  th, td { border:1px solid var(--line); padding:6px; text-align:center; font-size:14px; }
  th:first-child, td:first-child { width:92px; }
  button { padding:8px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; cursor:pointer; }
  button.primary { background:var(--accent); color:#fff; border-color:#3b82f6; }
  #results { background:#fff; border:1px solid var(--line); border-radius:10px; padding:10px; }
  .hl { background:#fff3a3; box-shadow: inset 0 -2px 0 rgba(0,0,0,.05); cursor: pointer; }
  .hl:hover { filter: brightness(0.98); }
  #selbar { position: absolute; display:none; z-index: 2000; background:#111; color:#fff; border-radius: 8px; padding: 6px; box-shadow: var(--shadow); font-size: 13px; gap:6px; align-items: center; }
  #selbar button { background: transparent; color:#fff; border: 1px solid rgba(255,255,255,.25); padding: 4px 8px; border-radius: 6px; cursor:pointer; }
  #selbar button:hover { border-color:#fff; }
  #notes { position: fixed; right: 12px; bottom: 12px; width: 320px; height: 42vh; background:#fff; border:1px solid var(--line); border-radius: 12px; display:none; flex-direction: column; z-index:1500; box-shadow: var(--shadow); }
  #notes header { display:flex; align-items:center; justify-content: space-between; padding:8px 10px; border-bottom:1px solid var(--line); }
  #notes textarea { flex:1; border:0; padding:10px; resize:none; font-size:14px; line-height:1.5; }
  #toast { position: fixed; left:50%; transform: translateX(-50%); bottom: 24px; background:#111; color:#fff; padding:8px 12px; border-radius: 8px; display:none; z-index:2500; }
  .dropzone { border:2px dashed #cbd5e1; background:#f8fafc; border-radius:10px; min-height:54px; padding:8px; display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .droplabel { color:#64748b; }
  .cardpool { background:#f1f5f9; border-radius:10px; padding:12px; display:grid; gap:8px; }
  .pool-slot { min-height:40px; }
  .card { background:#fff; border:1px solid #e5e7eb; border-radius:8px; padding:8px 10px; display:inline-flex; gap:8px; align-items:center; cursor:grab; box-shadow:0 1px 0 rgba(0,0,0,.03); }
  .card:active { cursor:grabbing; }
  .tag { background:#eef2ff; color:#4338ca; padding:2px 8px; border-radius:999px; font-size:12px; }
  .btn-clear { border:1px solid #e5e7eb; background:#fff; border-radius:8px; padding:6px 8px; cursor:pointer; }
  .ghost { opacity: .5; }
  .over { outline:2px dashed #3b82f6; }
  details.answerbox summary { cursor: pointer; user-select:none; list-style: none; }
  details.answerbox { border:1px dashed var(--line); border-radius:10px; padding:8px 10px; background:#fff; }
  .badge { display:inline-block; background:#eef2ff; color:#4338ca; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:6px; }
  body { padding-bottom: 82px; }
  .practice-nav { background:#fff; border-bottom:2px solid var(--line); padding:12px 20px; display:flex; align-items:center; gap:20px; box-shadow:0 2px 4px rgba(0,0,0,.05); flex-wrap:wrap; position:fixed; left:0; right:0; bottom:0; border-top:2px solid var(--line); border-bottom:0; z-index:4000; }
  .practice-nav .title { font-weight:600; color:var(--muted); }
  .practice-nav .questions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .practice-nav .q-item { padding:6px 10px; border:1px solid var(--line); border-radius:6px; background:#fff; cursor:pointer; font-size:14px; transition:all 0.2s; min-width:36px; text-align:center; }
  .practice-nav .q-item:hover { background:#f1f5f9; border-color:var(--accent); }
  .practice-nav .q-item.answered { background:#e0e7ff; border-color:var(--accent); color:var(--accent); font-weight:500; }
  .practice-nav .q-item.active { background:var(--accent); color:#fff; border-color:var(--accent); }
  #selbar { z-index: 6000 !important; }
</style>
</head>
<body>
<div class="practice-nav">
  <div class="title">Questions</div>
  <div class="questions">
    <div class="q-item" id="q1-nav" onclick="scrollToElement('q1-anchor')">1</div>
    <div class="q-item" id="q2-nav" onclick="scrollToElement('q2-anchor')">2</div>
    <div class="q-item" id="q3-nav" onclick="scrollToElement('q3-anchor')">3</div>
    <div class="q-item" id="q4-nav" onclick="scrollToElement('q4-anchor')">4</div>
    <div class="q-item" id="q5-nav" onclick="scrollToElement('q5-anchor')">5</div>
    <div class="q-item" id="q6-nav" onclick="scrollToElement('q6-anchor')">6</div>
    <div class="q-item" id="q7-nav" onclick="scrollToElement('q7-anchor')">7</div>
    <div class="q-item" id="q8-nav" onclick="scrollToElement('q8-anchor')">8</div>
    <div class="q-item" id="q9-nav" onclick="scrollToElement('q9-anchor')">9</div>
    <div class="q-item" id="q10-nav" onclick="scrollToElement('q10-anchor')">10</div>
    <div class="q-item" id="q11-nav" onclick="scrollToElement('q11-anchor')">11</div>
    <div class="q-item" id="q12-nav" onclick="scrollToElement('q12-anchor')">12</div>
    <div class="q-item" id="q13-nav" onclick="scrollToElement('q13-anchor')">13</div>
  </div>
</div>
<div class="shell">
<section class="pane" id="left">
  <h2>READING PASSAGE 1 <span id="timer">00:00</span></h2>
  <p>You should spend about 20 minutes on Questions 1–13, which are based on Reading Passage 1 below.</p>
  <h3>William Gilbert and Magnetism</h3>
  
  <h4>Paragraph A</h4>
  <p>The 16th and 17th centuries saw two great pioneers of modern science: Galileo and Gilbert. The impact of their findings is eminent. Gilbert was the first modern scientist, the accredited father of the science of electricity and magnetism, an Englishman of learning and a physician at the court of Elizabeth. Prior to him, all that was known of electricity and magnetism was what the ancients knew: nothing more than that the lodestone possessed magnetic properties and that amber and jet, when rubbed, would attract bits of paper or other substances of small specific gravity. However, he is less well known than he deserves.</p>
  
  <h4>Paragraph B</h4>
  <p>Gilbert’s birth predated Galileo’s. Born into an eminent local family in Colchester, Essex, on 24 May 1544, he went to grammar school and then studied medicine at St John’s College, Cambridge, graduating in 1573. Later he travelled on the Continent and eventually settled in London.</p>
  
  <h4>Paragraph C</h4>
  <p>He was a very successful and eminent doctor. All this culminated in his election as president of the Royal Society. He was also appointed personal physician to Queen Elizabeth I and was later knighted by her. He faithfully served her until her death. However, he did not outlive the Queen for long and died on 30 November 1603, only a few months after his appointment as personal physician to King James.</p>
  
  <h4>Paragraph D</h4>
  <p>Gilbert was first interested in chemistry but later changed his focus because alchemy contained too great a portion of mysticism (such as the transmutation of metals). He gradually developed an interest in physics, inspired by the great minds of the ancients, particularly the knowledge the ancient Greeks had about lodestones-strange minerals with the power to attract iron. In the meantime, Britain became a major seafaring nation in 1588 when the Spanish Armada was defeated, opening the way to British settlement of America. British ships depended on the magnetic compass, yet no one understood why it worked. Did the Pole Star attract it, as Columbus once speculated; or was there a magnetic mountain at the pole, as described in the Odyssey, which ships would never approach because the sailors thought its pull would yank out all their iron nails and fittings? For nearly 20 years, William Gilbert conducted ingenious experiments to understand magnetism. His works include On the Magnet, Magnetic Bodies, and The Great Magnet of the Earth.</p>
  
  <h4>Paragraph E</h4>
  <p>Gilbert’s discoveries were of great importance to modern physics. He investigated the nature of magnetism and electricity, and he even coined the word “electric”. Early beliefs about magnetism were largely entangled with superstitions-for instance, sailors believed that rubbing garlic on a lodestone could neutralise its magnetism and that even the smell of garlic would interfere with the action of a compass, which is why helmsmen were forbidden to eat it near a ship’s compass. Gilbert also found that metals can be magnetised by rubbing materials such as fur on them. He named the ends of a magnet the “north pole” and “south pole”. The magnetic poles can attract or repel, depending on polarity; ordinary iron, however, is always attracted to a magnet. Though he began to study the relationship between magnetism and electricity, he did not complete this work. His research into static electricity using amber and jet only demonstrated that objects with electrical charges can attract small pieces of paper and the like. It was a French scientist named du Fay who later discovered that there are actually two electrical charges-positive and negative.</p>
  
  <h4>Paragraph F</h4>
  <p>He also questioned traditional astronomical beliefs. Though a Copernican, he did not state explicitly whether the Earth is at the centre of the universe or in orbit around the Sun. However, he believed that stars are not equidistant from the Earth but have their own Earth-like planets orbiting around them. The Earth itself is like a giant magnet, which is also why compasses always point north: they align with the planet’s polarity. He likened the polarity of a magnet to the polarity of the Earth and built an entire magnetic philosophy on this analogy. In his explanation, magnetism is the soul of the Earth. Thus a perfectly spherical lodestone, when aligned with the Earth’s poles, would wobble all by itself in 24 hours. Further, he believed that the Sun and other stars wobble just as the Earth does around a crystal core, and he speculated that the Moon might also be a magnet caused to orbit by its magnetic attraction to the Earth. This was perhaps the first proposal that a force might cause a heavenly orbit.</p>
  
  <h4>Paragraph G</h4>
  <p>His research method was revolutionary in that he used experiments rather than pure logic and reasoning, as the ancient Greek philosophers had done. This represented a new attitude towards scientific investigation; until then, systematic experiments were not in fashion. Because of this scientific attitude, together with his contribution to our knowledge of magnetism, a unit of magnetomotive force-also known as magnetic potential-was named the gilbert in his honour. His approach of careful observation and experimentation, rather than reliance on authoritative opinion or deductive philosophy, laid the very foundation for modern science.</p>
  
  <p>&nbsp;</p> <!-- 添加空白行防止加载不完全 -->
</section>
<div id="divider" title="Drag to resize"></div>
<section class="pane" id="right">
  <h3>Questions</h3>
  
  <div class="group">
    <h4>Questions 1–7</h4>
    <p>Reading Passage 1 has seven paragraphs A–G.</p>
    <p>Choose the correct heading for each paragraph from the list of headings below.</p>
    <p>Write the correct number, i–x, in boxes 1–7 on your answer sheet.</p>
    <div class="headings">
      <p>List of Headings</p>
      <ol type="i">
        <li>Early years of Gilbert</li>
        <li>What was new about his scientific research method</li>
        <li>The development of chemistry</li>
        <li>Questioning traditional astronomy</li>
        <li>Pioneers of early science</li>
        <li>Professional and social recognition</li>
        <li>Becoming the president of the Royal Society</li>
        <li>The great works of Gilbert</li>
        <li>His discovery about magnetism</li>
        <li>His change of focus</li>
      </ol>
    </div>
    <table>
      <tr>
        <th>Paragraph</th>
        <th>i</th>
        <th>ii</th>
        <th>iii</th>
        <th>iv</th>
        <th>v</th>
        <th>vi</th>
        <th>vii</th>
        <th>viii</th>
        <th>ix</th>
        <th>x</th>
      </tr>
      <a id="q1-anchor"></a>
      <tr id="q1-row">
        <td>A (1)</td>
        <td><label><input name="q1" type="radio" value="i"/></label></td>
        <td><label><input name="q1" type="radio" value="ii"/></label></td>
        <td><label><input name="q1" type="radio" value="iii"/></label></td>
        <td><label><input name="q1" type="radio" value="iv"/></label></td>
        <td><label><input name="q1" type="radio" value="v"/></label></td>
        <td><label><input name="q1" type="radio" value="vi"/></label></td>
        <td><label><input name="q1" type="radio" value="vii"/></label></td>
        <td><label><input name="q1" type="radio" value="viii"/></label></td>
        <td><label><input name="q1" type="radio" value="ix"/></label></td>
        <td><label><input name="q1" type="radio" value="x"/></label></td>
      </tr>
      <a id="q2-anchor"></a>
      <tr id="q2-row">
        <td>B (2)</td>
        <td><label><input name="q2" type="radio" value="i"/></label></td>
        <td><label><input name="q2" type="radio" value="ii"/></label></td>
        <td><label><input name="q2" type="radio" value="iii"/></label></td>
        <td><label><input name="q2" type="radio" value="iv"/></label></td>
        <td><label><input name="q2" type="radio" value="v"/></label></td>
        <td><label><input name="q2" type="radio" value="vi"/></label></td>
        <td><label><input name="q2" type="radio" value="vii"/></label></td>
        <td><label><input name="q2" type="radio" value="viii"/></label></td>
        <td><label><input name="q2" type="radio" value="ix"/></label></td>
        <td><label><input name="q2" type="radio" value="x"/></label></td>
      </tr>
      <a id="q3-anchor"></a>
      <tr id="q3-row">
        <td>C (3)</td>
        <td><label><input name="q3" type="radio" value="i"/></label></td>
        <td><label><input name="q3" type="radio" value="ii"/></label></td>
        <td><label><input name="q3" type="radio" value="iii"/></label></td>
        <td><label><input name="q3" type="radio" value="iv"/></label></td>
        <td><label><input name="q3" type="radio" value="v"/></label></td>
        <td><label><input name="q3" type="radio" value="vi"/></label></td>
        <td><label><input name="q3" type="radio" value="vii"/></label></td>
        <td><label><input name="q3" type="radio" value="viii"/></label></td>
        <td><label><input name="q3" type="radio" value="ix"/></label></td>
        <td><label><input name="q3" type="radio" value="x"/></label></td>
      </tr>
      <a id="q4-anchor"></a>
      <tr id="q4-row">
        <td>D (4)</td>
        <td><label><input name="q4" type="radio" value="i"/></label></td>
        <td><label><input name="q4" type="radio" value="ii"/></label></td>
        <td><label><input name="q4" type="radio" value="iii"/></label></td>
        <td><label><input name="q4" type="radio" value="iv"/></label></td>
        <td><label><input name="q4" type="radio" value="v"/></label></td>
        <td><label><input name="q4" type="radio" value="vi"/></label></td>
        <td><label><input name="q4" type="radio" value="vii"/></label></td>
        <td><label><input name="q4" type="radio" value="viii"/></label></td>
        <td><label><input name="q4" type="radio" value="ix"/></label></td>
        <td><label><input name="q4" type="radio" value="x"/></label></td>
      </tr>
      <a id="q5-anchor"></a>
      <tr id="q5-row">
        <td>E (5)</td>
        <td><label><input name="q5" type="radio" value="i"/></label></td>
        <td><label><input name="q5" type="radio" value="ii"/></label></td>
        <td><label><input name="q5" type="radio" value="iii"/></label></td>
        <td><label><input name="q5" type="radio" value="iv"/></label></td>
        <td><label><input name="q5" type="radio" value="v"/></label></td>
        <td><label><input name="q5" type="radio" value="vi"/></label></td>
        <td><label><input name="q5" type="radio" value="vii"/></label></td>
        <td><label><input name="q5" type="radio" value="viii"/></label></td>
        <td><label><input name="q5" type="radio" value="ix"/></label></td>
        <td><label><input name="q5" type="radio" value="x"/></label></td>
      </tr>
      <a id="q6-anchor"></a>
      <tr id="q6-row">
        <td>F (6)</td>
        <td><label><input name="q6" type="radio" value="i"/></label></td>
        <td><label><input name="q6" type="radio" value="ii"/></label></td>
        <td><label><input name="q6" type="radio" value="iii"/></label></td>
        <td><label><input name="q6" type="radio" value="iv"/></label></td>
        <td><label><input name="q6" type="radio" value="v"/></label></td>
        <td><label><input name="q6" type="radio" value="vi"/></label></td>
        <td><label><input name="q6" type="radio" value="vii"/></label></td>
        <td><label><input name="q6" type="radio" value="viii"/></label></td>
        <td><label><input name="q6" type="radio" value="ix"/></label></td>
        <td><label><input name="q6" type="radio" value="x"/></label></td>
      </tr>
      <a id="q7-anchor"></a>
      <tr id="q7-row">
        <td>G (7)</td>
        <td><label><input name="q7" type="radio" value="i"/></label></td>
        <td><label><input name="q7" type="radio" value="ii"/></label></td>
        <td><label><input name="q7" type="radio" value="iii"/></label></td>
        <td><label><input name="q7" type="radio" value="iv"/></label></td>
        <td><label><input name="q7" type="radio" value="v"/></label></td>
        <td><label><input name="q7" type="radio" value="vi"/></label></td>
        <td><label><input name="q7" type="radio" value="vii"/></label></td>
        <td><label><input name="q7" type="radio" value="viii"/></label></td>
        <td><label><input name="q7" type="radio" value="ix"/></label></td>
        <td><label><input name="q7" type="radio" value="x"/></label></td>
      </tr>
    </table>
  </div>
  
  <div class="group">
    <h4>Questions 8–10</h4>
    <p>Do the following statements agree with the information given in Reading Passage 1?</p>
    <p>In boxes 8–10 on your answer sheet, write</p>
    <ul>
      <li>TRUE if the statement agrees with the information</li>
      <li>FALSE if the statement contradicts the information</li>
      <li>NOT GIVEN if there is no information on this</li>
    </ul>
    
    <a id="q8-anchor"></a>
    <div id="q8-section" style="padding:8px 0;border-top:1px dashed var(--line);">
      <p>8 Gilbert is less famous than he should be.</p>
      <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
        <label style="margin:0;"><input name="q8" type="radio" value="TRUE"> TRUE</label>
        <label style="margin:0;"><input name="q8" type="radio" value="FALSE"> FALSE</label>
        <label style="margin:0;"><input name="q8" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
      </div>
    </div>
    
    <a id="q9-anchor"></a>
    <div id="q9-section" style="padding:8px 0;border-top:1px dashed var(--line);">
      <p>9 Gilbert was famous as a doctor before he was employed by the Queen.</p>
      <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
        <label style="margin:0;"><input name="q9" type="radio" value="TRUE"> TRUE</label>
        <label style="margin:0;"><input name="q9" type="radio" value="FALSE"> FALSE</label>
        <label style="margin:0;"><input name="q9" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
      </div>
    </div>
    
    <a id="q10-anchor"></a>
    <div id="q10-section" style="padding:8px 0;border-top:1px dashed var(--line);">
      <p>10 Gilbert lost faith in the medical theories of his time.</p>
      <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
        <label style="margin:0;"><input name="q10" type="radio" value="TRUE"> TRUE</label>
        <label style="margin:0;"><input name="q10" type="radio" value="FALSE"> FALSE</label>
        <label style="margin:0;"><input name="q10" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
      </div>
    </div>
  </div>
  
  <div class="group">
    <a id="q11-anchor"></a>
    <h4>Questions 11–13</h4>
    <p>Choose THREE letters, A–F.</p>
    <p>Write the correct letters in boxes 11–13 on your answer sheet.</p>
    <p>Which THREE of the following are parts of Gilbert’s discovery?</p>
    <div style="padding:8px 0;border-top:1px dashed var(--line);">
      <label style="display:block;margin:4px 0;"><input name="q11" type="checkbox" value="A"/> A Metal can be transformed into another.</label>
      <label style="display:block;margin:4px 0;"><input name="q12" type="checkbox" value="B"/> B Garlic can remove magnetism.</label>
      <label style="display:block;margin:4px 0;"><input name="q13" type="checkbox" value="C"/> C Metals can be magnetised.</label>
      <label style="display:block;margin:4px 0;"><input name="q11" type="checkbox" value="D"/> D Stars are at different distances from the Earth.</label>
      <label style="display:block;margin:4px 0;"><input name="q12" type="checkbox" value="E"/> E The Earth wobbles on its axis.</label>
      <label style="display:block;margin:4px 0;"><input name="q13" type="checkbox" value="F"/> F There are two charges of electricity.</label>
    </div>
  </div>
  
  <div style="display:flex;gap:8px;margin-bottom:10px;">
    <button class="primary" onclick="grade()">Submit</button>
    <button onclick="resetForm()">Reset</button>
    <button onclick="toggleNotes()">Notes</button>
  </div>
  <div id="results"></div>
  <details class="answerbox" id="answerBox">
    <summary>Show answers (click to toggle) <span class="badge">hidden</span></summary>
    <div id="answerContent"></div>
  </details>
</section>
</div>
<div aria-label="Selection tools" id="selbar" role="toolbar">
  <button id="btnHL">Highlight</button>
  <button id="btnUH">Remove</button>
  <button id="btnNote">Note</button>
</div>
<div id="notes">
  <header>
    <strong>Notes</strong>
    <div>
      <button id="btnCopy">Copy</button>
      <button id="btnClose">Close</button>
    </div>
  </header>
  <textarea id="noteArea" placeholder="Type your notes here..."></textarea>
</div>
<div id="toast"></div>
<script>
// Timer
let _t=0; const _timerEl=document.getElementById('timer');
setInterval(function(){ 
  _t++; 
  var m=String(Math.floor(_t/60)).padStart(2,'0'); 
  var s=String(_t%60).padStart(2,'0'); 
  _timerEl.textContent=m+':'+s; 
},1000);
// Drag divider
var divider = document.getElementById('divider');
var left = document.getElementById('left');
var right = document.getElementById('right');
var dragging=false;
function startDrag(e){ 
  dragging=true; 
  document.body.style.cursor='ew-resize'; 
  if(e.preventDefault) e.preventDefault(); 
}
function endDrag(){ 
  dragging=false; 
  document.body.style.cursor=''; 
}
function onMove(clientX){
  var container = document.querySelector('.shell').getBoundingClientRect();
  var x = clientX - container.left;
  x = Math.max(280, Math.min(container.width-320, x));
  left.style.flex = '0 0 ' + x + 'px';
  right.style.flex = '1 1 auto';
}
divider.addEventListener('mousedown', function(e){ startDrag(e); });
window.addEventListener('mousemove', function(e){ if(dragging) onMove(e.clientX); });
window.addEventListener('mouseup', endDrag);
divider.addEventListener('touchstart', function(e){ startDrag(e.touches[0]); }, {passive:false});
window.addEventListener('touchmove', function(e){ if(dragging) onMove(e.touches[0].clientX); }, {passive:false});
window.addEventListener('touchend', endDrag);
// Highlight toolbar
var selbar = document.getElementById('selbar');
var btnHL = document.getElementById('btnHL');
var btnUH = document.getElementById('btnUH');
var btnNote = document.getElementById('btnNote');
var lastRange=null;
var currentHlNode=null;
var keepToolbar=false;
function positionSelbarForRect(rect){
  selbar.style.display='flex';
  requestAnimationFrame(function(){
    var top = window.scrollY + rect.top - selbar.offsetHeight - 8;
    var leftPos = window.scrollX + rect.left + rect.width/2 - selbar.offsetWidth/2;
    selbar.style.top = ((top>0)?top:(window.scrollY + rect.bottom + 8)) + 'px';
    selbar.style.left = Math.max(8, leftPos) + 'px';
  });
}
function updateSelbar(){
  var sel=window.getSelection();
  if(!sel || sel.rangeCount===0 || sel.isCollapsed) { 
    selbar.style.display='none'; 
    currentHlNode=null; 
    return; 
  }
  var range = sel.getRangeAt(0);
  lastRange = range.cloneRange();
  currentHlNode=null;
  positionSelbarForRect(range.getBoundingClientRect());
}
document.getElementById('left').addEventListener('mouseup', updateSelbar);
document.getElementById('right').addEventListener('mouseup', updateSelbar);
document.addEventListener('selectionchange', function(){ 
  var sel=window.getSelection(); 
  if(!sel || sel.rangeCount===0 || sel.isCollapsed){ 
    if(!keepToolbar && !currentHlNode){ 
      selbar.style.display='none'; 
    } 
  } 
});
document.addEventListener('scroll', function(){ 
  if(selbar.style.display==='flex') updateSelbar(); 
});
document.addEventListener('mousedown', function(e){
  var t = e.target;
  if(t.classList && t.classList.contains('hl')){
    keepToolbar = true;
  } else {
    keepToolbar = false;
  }
}, true);
document.addEventListener('click', function(e){
  var target = e.target;
  if(target.classList && target.classList.contains('hl')){
    currentHlNode = target;
    lastRange = null;
    positionSelbarForRect(target.getBoundingClientRect());
    var sel=window.getSelection();
    if(sel) sel.removeAllRanges();
    setTimeout(function(){ keepToolbar=false; }, 0);
  }
}, true);
function doHighlight(){
  if(currentHlNode) return;
  if(!lastRange || lastRange.collapsed) return;
  var span=document.createElement('span'); span.className='hl';
  try { lastRange.surroundContents(span); }
  catch(e){
    var wrap=document.createElement('span'); wrap.className='hl';
    wrap.appendChild(lastRange.cloneContents());
    lastRange.deleteContents();
    lastRange.insertNode(wrap);
  }
  selbar.style.display='none';
  showToast('Highlighted');
}
function removeHighlight(){
  if(currentHlNode){
    var p = currentHlNode.parentNode;
    while(currentHlNode.firstChild) p.insertBefore(currentHlNode.firstChild, currentHlNode);
    p.removeChild(currentHlNode); p.normalize();
    currentHlNode = null;
    selbar.style.display='none';
    showToast('Highlight removed');
    return;
  }
  if(!lastRange) return;
  var selRect = lastRange.getBoundingClientRect();
  var walker=document.createTreeWalker(document.body, NodeFilter.SHOW_ELEMENT);
  var toRemove=[];
  while(walker.nextNode()){
    var n=walker.currentNode;
    if(n.classList && n.classList.contains('hl')) {
      var r = n.getBoundingClientRect();
      if(!(r.right < selRect.left || r.left > selRect.right || r.bottom < selRect.top || r.top > selRect.bottom)) toRemove.push(n);
    }
  }
  toRemove.forEach(function(el){ var p=el.parentNode; while(el.firstChild) p.insertBefore(el.firstChild, el); p.removeChild(el); p.normalize(); });
  selbar.style.display='none';
  showToast('Highlight removed');
}
btnHL.addEventListener('click', doHighlight);
btnUH.addEventListener('click', removeHighlight);
// Notes
var notes = document.getElementById('notes');
var noteArea = document.getElementById('noteArea');
var btnCopy=document.getElementById('btnCopy');
var btnClose=document.getElementById('btnClose');
function toggleNotes(){ 
  notes.style.display = (notes.style.display==='flex'?'none':'flex'); 
}
window.toggleNotes = toggleNotes;
btnClose.addEventListener('click', toggleNotes);
btnCopy.addEventListener('click', async function(){ 
  await navigator.clipboard.writeText(noteArea.value||''); 
  showToast('Copied'); 
});
btnNote.addEventListener('click', function(){
  var text = '';
  if(currentHlNode){ text = (currentHlNode.textContent||'').trim(); }
  else if(lastRange){ var frag = lastRange.cloneContents(); text = (frag.textContent||'').trim(); }
  toggleNotes();
  if(text) noteArea.value = (noteArea.value? noteArea.value+'\n':'') + '> ' + text + '\n';
  selbar.style.display='none';
});
// Toast
var toastEl=document.getElementById('toast');
function showToast(msg){
  toastEl.textContent=msg; 
  toastEl.style.display='block';
  setTimeout(function(){ toastEl.style.display='none'; }, 1200);
}
// Answer key and grading
var answers = {
  "q1":"v", "q2":"i", "q3":"vi", "q4":"x", "q5":"ix", "q6":"iv", "q7":"ii",
  "q8":"TRUE", "q9":"TRUE", "q10":"NOT GIVEN",
  "q11":"C", "q12":"D", "q13":"E"
};
var acceptable = {
  "q11": ["C", "D", "E"],
  "q12": ["C", "D", "E"],
  "q13": ["C", "D", "E"]
};
function markHeading(q, user){
  return String(user||'').toLowerCase() === String(answers[q]).toLowerCase();
}
function markChoice(q, user){
  return String(user||'').toUpperCase() === String(answers[q]).toUpperCase();
}
function markBlank(q, user){
  var u = String(user||'').trim().toLowerCase();
  var key = String(answers[q]).trim().toLowerCase();
  if(acceptable[q]){
    return acceptable[q].map(a => a.toLowerCase()).indexOf(u) >= 0;
  }
  return u === key;
}
function grade(){
  var total=0, correct=0, lines=[];
  function push(q, ok, user){
    total++; if(ok) correct++;
    lines.push(q.toUpperCase()+": "+(user||'None')+" "+(ok?'✅':'❌'));
  }
  // 1–7 headings
  for(var n=1;n<=7;n++){
    var sel=document.querySelector('input[name="q'+n+'"]:checked');
    var val=sel?sel.value:'';
    push('q'+n, markHeading('q'+n, val), val);
  }
  // 8–10 true/false/not given
  for(var n=8;n<=10;n++){
    var sel=document.querySelector('input[name="q'+n+'"]:checked');
    var val=sel?sel.value:'';
    push('q'+n, markChoice('q'+n, val), val);
  }
  // 11–13 multiple selection
  const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
  const selectedValues = Array.from(checkboxes).map(cb => cb.value);
  const correctValues = ["C", "D", "E"];
  const isCorrect11 = selectedValues.includes("C");
  const isCorrect12 = selectedValues.includes("D");
  const isCorrect13 = selectedValues.includes("E");
  const correctCount = [isCorrect11, isCorrect12, isCorrect13].filter(Boolean).length;
  
  push('q11', isCorrect11, "C");
  push('q12', isCorrect12, "D");
  push('q13', isCorrect13, "E");
  
  // Show results
  const acc = (total? Math.round(100*correct/total):0);
  var html = '<p><strong>Score:</strong> '+correct+'/'+total+' <span class="badge">Accuracy '+acc+'%</span></p>';
  html += '<pre>'+lines.join('\n')+'</pre>';
  document.getElementById('results').innerHTML = html;
  
  // Show answer key
  document.getElementById('answerContent').innerHTML = `
    <ol>
      <li>1 → v (Pioneers of early science)</li>
      <li>2 → i (Early years of Gilbert)</li>
      <li>3 → vi (Professional and social recognition)</li>
      <li>4 → x (His change of focus)</li>
      <li>5 → ix (His discovery about magnetism)</li>
      <li>6 → iv (Questioning traditional astronomy)</li>
      <li>7 → ii (What was new about his scientific research method)</li>
      <li>8 → TRUE</li>
      <li>9 → TRUE</li>
      <li>10 → NOT GIVEN</li>
      <li>11 → C (Metals can be magnetised)</li>
      <li>12 → D (Stars are at different distances from the Earth)</li>
      <li>13 → E (The Earth wobbles on its axis)</li>
    </ol>
  `;
  document.querySelector('#answerBox .badge').textContent='tap to view';
}
function resetForm(){
  document.querySelectorAll('input[type="radio"]').forEach(el=>el.checked=false);
  document.querySelectorAll('input[type="checkbox"]').forEach(el=>el.checked=false);
  document.getElementById('results').innerHTML='';
  document.getElementById('answerContent').innerHTML='';
  document.querySelector('#answerBox .badge').textContent = 'hidden';
  document.querySelectorAll('.q-item').forEach(item => {
    item.classList.remove('answered');
  });
}
function scrollToElement(id){
  var el = document.getElementById(id);
  if(el){ 
    el.scrollIntoView({behavior:'smooth', block:'center'}); 
  }
  var navs = document.querySelectorAll('.practice-nav .q-item');
  navs.forEach(n => n.classList.remove('active'));
  var btn = document.getElementById(id.replace('-anchor','-nav'));
  if(btn){ 
    btn.classList.add('active'); 
    setTimeout(() => btn.classList.remove('active'), 800); 
  }
}
(function(){
  function mark(qn){
    var nav = document.getElementById(`q${qn}-nav`);
    if(!nav) return;
    var radios = document.querySelectorAll('input[name="q'+qn+'"]:checked');
    var checkboxes = document.querySelectorAll('input[name="q'+qn+'"]:checked');
    var answered = radios.length > 0 || checkboxes.length > 0;
    
    if(answered) nav.classList.add('answered');
    else nav.classList.remove('answered');
  }
  
  for(var q=1;q<=10;q++){
    (function(n){
      document.querySelectorAll(`input[name="q${n}"]`).forEach(input => {
        input.addEventListener('change', () => mark(n));
      });
    })(q);
  }
  
  // Handle checkboxes for q11-13
  document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
    checkbox.addEventListener('change', function(){
      const qn = this.name.replace('q', '');
      mark(qn);
    });
  });
})();
</script>

<!-- 练习页面数据传输增强脚本 -->
<script>
// 检查是否已经有增强脚本
if (!window.practicePageEnhancer) {
    // 动态加载增强脚本
    const script = document.createElement('script');
    script.src = '../../js/practice-page-enhancer.js';
    script.onload = function() {
        console.log('练习页面增强脚本已加载');
    };
    script.onerror = function() {
        console.error('练习页面增强脚本加载失败');
        // 降级到内联增强
        loadInlineEnhancer();
    };
    document.head.appendChild(script);
}

// 内联增强器（降级方案）
function loadInlineEnhancer() {
    if (window.practicePageEnhancer) return;
    
    window.practicePageEnhancer = {
        initialize: function() {
            console.log('[InlineEnhancer] 内联增强器已初始化');
            this.setupCommunication();
            this.setupAnswerListeners();
            this.interceptSubmit();
        },
        
        setupCommunication: function() {
            this.parentWindow = window.opener || window.parent;
            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'INIT_SESSION') {
                    this.sessionId = event.data.data.sessionId;
                    this.sendMessage('SESSION_READY', {
                        pageType: this.detectPageType(),
                        url: window.location.href
                    });
                }
            });
        },
        
        detectPageType: function() {
            const title = document.title || '';
            if (title.includes('P1')) return 'P1';
            if (title.includes('P2')) return 'P2';
            if (title.includes('P3')) return 'P3';
            return 'unknown';
        },
        
        setupAnswerListeners: function() {
            this.answers = {};
            this.startTime = Date.now();
            
            document.addEventListener('change', (e) => {
                if (e.target.name && e.target.name.startsWith('q')) {
                    this.answers[e.target.name] = e.target.value;
                }
            });
        },
        
        interceptSubmit: function() {
            // 拦截grade函数
            if (typeof window.grade === 'function') {
                const originalGrade = window.grade;
                window.grade = () => {
                    const result = originalGrade();
                    setTimeout(() => this.handleSubmit(), 200);
                    return result;
                };
            }
            
            // 监听提交按钮
            document.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' && 
                    (e.target.textContent.includes('Submit') || 
                     e.target.onclick && e.target.onclick.toString().includes('grade'))) {
                    setTimeout(() => this.handleSubmit(), 300);
                }
            });
        },
        
        handleSubmit: function() {
            const results = {
                sessionId: this.sessionId,
                startTime: this.startTime,
                endTime: Date.now(),
                duration: Math.round((Date.now() - this.startTime) / 1000),
                answers: this.answers,
                scoreInfo: this.extractScore(),
                pageType: this.detectPageType(),
                url: window.location.href
            };
            
            this.sendMessage('PRACTICE_COMPLETE', results);
        },
        
        extractScore: function() {
            const resultsEl = document.getElementById('results');
            if (!resultsEl) return null;
            
            const text = resultsEl.textContent || '';
            const scoreMatch = text.match(/Score:\s*(\d+)\/(\d+)/i);
            if (scoreMatch) {
                const correct = parseInt(scoreMatch[1]);
                const total = parseInt(scoreMatch[2]);
                return {
                    correct: correct,
                    total: total,
                    accuracy: total > 0 ? correct / total : 0,
                    percentage: Math.round((correct / total) * 100),
                    source: 'inline_extraction'
                };
            }
            return null;
        },
        
        sendMessage: function(type, data) {
            if (this.parentWindow) {
                this.parentWindow.postMessage({
                    type: type,
                    data: data,
                    source: 'practice_page'
                }, '*');
            }
        }
    };
    
    // 初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            window.practicePageEnhancer.initialize();
        });
    } else {
        window.practicePageEnhancer.initialize();
    }
}
</script>

</body>
</html>