<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>P1 ‚Äì William Gilbert and Magnetism (Fixed & Optimized)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root { 
    --line: #e5e7eb; 
    --bg: #f6f7fb; 
    --panel: #fff; 
    --accent: #3b82f6; 
    --muted: #6b7280; 
    --shadow: 0 6px 20px rgba(0,0,0,.12); 
  }
  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body { 
    margin: 0; 
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; 
    background: var(--bg); 
    padding-bottom: 82px; 
  }
  
  /* Â∏ÉÂ±ÄÊ†∑Âºè */
  .shell { display: flex; height: 100vh; width: 100%; }
  .pane { background: var(--panel); overflow: auto; padding: 20px; }
  #left { flex: 0 0 50%; min-width: 280px; }
  #right { flex: 1 1 auto; min-width: 320px; background: #fbfbff; border-left: 1px solid var(--line); }
  #divider { flex: 0 0 8px; background: linear-gradient(90deg, #e5e7eb, #d1d5db); cursor: ew-resize; position: relative; z-index: 5; user-select: none; }
  
  /* ÊñáÊú¨Ê†∑Âºè */
  h2, h3, h4 { margin: 0 0 10px; }
  #left p { margin: 0 0 12px; line-height: 1.6; word-break: normal; overflow-wrap: normal; hyphens: none; }
  
  /* ÁªÑ‰ª∂Ê†∑Âºè */
  .group { background: #fff; border: 1px solid var(--line); border-radius: 10px; padding: 12px; margin-bottom: 14px; }
  table { border-collapse: collapse; width: 100%; margin: 12px 0; font-size: 14px; }
  th, td { border: 1px solid var(--line); padding: 8px; text-align: center; }
  th:first-child, td:first-child { text-align: left; padding-left: 10px; font-weight: bold; }
  .headings-list { background: #f8fafc; border: 1px solid var(--line); padding: 12px; border-radius: 8px; margin: 12px 0; }
  .headings-list p { margin-top: 0; }
  .headings-list ol { padding-left: 20px; margin: 0; }

  /* ÊåâÈíÆÊ†∑Âºè */
  button { padding: 8px 12px; border: 1px solid var(--line); background: #fff; border-radius: 6px; cursor: pointer; transition: all 0.2s; font-size: 14px; }
  button:hover { background: #f8fafc; border-color: #cbd5e1; }
  button.primary { background: var(--accent); color: #fff; border-color: var(--accent); }
  button.primary:hover { background: #2563eb; }
  
  /* ËÆ°Êó∂Âô®Ê†∑Âºè */
  #timer { background: #fff; color: var(--muted); border: 1px solid var(--line); border-radius: 6px; padding: 6px 12px; cursor: pointer; font-family: 'Courier New', monospace; transition: all 0.2s; min-width: 70px; text-align: center; font-size: 18px; font-weight: bold; }
  #timer:hover { background: #f1f5f9; border-color: var(--accent); }
  #timer.paused { color: #ef4444; border-color: #fecaca; background: #fef2f2; }
  
  /* ‰∏ªÈ¢òÂàáÊç¢ÊåâÈíÆ */
  .theme-toggle { background: #fff; color: var(--muted); border: 1px solid var(--line); border-radius: 6px; width: 36px; height: 36px; font-size: 16px; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; }
  .theme-toggle:hover { background: var(--accent); color: #fff; border-color: var(--accent); transform: scale(1.05); }
  
  /* Ê∑±Ëâ≤Ê®°ÂºèÊ†∑Âºè */
  body.dark { --bg: #0f172a; --panel: #1e293b; --line: #334155; --muted: #94a3b8; color: #e2e8f0; }
  body.dark #right { background: #0f172a; }
  body.dark .group { background: #1e293b; border-color: #334155; }
  body.dark button { background: #1e293b; color: #e2e8f0; border-color: #334155; }
  body.dark button:hover { background: #334155; }
  body.dark button.primary { background: var(--accent); color: #fff; }
  body.dark #results { background: #1e293b; border-color: #334155; }
  body.dark #notes { background: #1e293b; border-color: #334155; color: #e2e8f0; }
  body.dark .practice-nav { background: #1e293b; border-color: #334155; }
  body.dark .q-item { background: #0f172a; color: #e2e8f0; border-color: #334155; }
  body.dark .q-item:hover { background: #334155; }
  body.dark .q-item.answered { background: #1e40af; border-color: var(--accent); color: #93c5fd; }
  body.dark #timer { background: #1e293b; color: #e2e8f0; border-color: #334155; }
  body.dark #timer:hover { background: #334155; border-color: var(--accent); }
  body.dark details.answerbox { background: #1e293b; border-color: #334155; }
  body.dark table, body.dark th, body.dark td { border-color: var(--line); }
  body.dark .headings-list { background: #0f172a; border-color: var(--line); }
  body.dark input[type="text"] { background: transparent; color: #e2e8f0; border-bottom: 1px solid #64748b;}

  /* ÂìçÂ∫îÂºèËÆæËÆ° */
  @media (max-width: 768px) {
    .shell { flex-direction: column; }
    #left, #right { flex: none; min-width: auto; }
    #divider { display: none; }
    .practice-nav .controls { gap: 8px; }
    #timer { font-size: 12px; padding: 3px 8px; }
    .theme-toggle { width: 32px; height: 32px; font-size: 14px; }
    #notes { width: calc(100vw - 24px); right: 12px; left: 12px; }
  }
  
  /* ÈÄâÊã©Â∑•ÂÖ∑Ê†è */
  #selbar { position: fixed; display: none; z-index: 2000; background: #111; color: #fff; border-radius: 8px; padding: 6px; box-shadow: var(--shadow); font-size: 13px; gap: 6px; align-items: center; }
  #selbar button { background: transparent; color: #fff; border: 1px solid rgba(255,255,255,.25); padding: 4px 8px; border-radius: 6px; cursor: pointer; }
  #selbar button:hover { border-color: #fff; }
  
  /* Á¨îËÆ∞Èù¢Êùø */
  #notes { position: fixed; right: 12px; bottom: 12px; width: 320px; height: 42vh; background: #fff; border: 1px solid var(--line); border-radius: 12px; display: none; flex-direction: column; z-index: 1500; box-shadow: var(--shadow); }
  #notes header { display: flex; align-items: center; justify-content: space-between; padding: 8px 10px; border-bottom: 1px solid var(--line); }
  #notes textarea { flex: 1; border: 0; padding: 10px; resize: none; font-size: 14px; line-height: 1.5; }
  
  /* ToastÈÄöÁü• */
  #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: #fff; padding: 8px 16px; border-radius: 4px; display: none; z-index: 3000; font-size: 14px; }
  
  /* Á≠îÈ¢òÂØºËà™ */
  .practice-nav { background: #fff; padding: 12px 20px; display: flex; align-items: center; gap: 16px; box-shadow: 0 2px 4px rgba(0,0,0,.05); flex-wrap: wrap; position: fixed; left: 0; right: 0; bottom: 0; border-top: 2px solid var(--line); z-index: 4000; }
  .practice-nav .title { font-weight: 600; color: var(--muted); }
  .practice-nav .questions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  .practice-nav .q-item { padding: 6px 10px; border: 1px solid var(--line); border-radius: 6px; background: #fff; cursor: pointer; font-size: 14px; transition: all 0.2s; min-width: 36px; text-align: center; }
  .practice-nav .q-item:hover { background: #f1f5f9; border-color: var(--accent); }
  .practice-nav .q-item.answered { background: #e0e7ff; border-color: var(--accent); color: var(--accent); font-weight: 500; }
  .practice-nav .q-item.active { background: var(--accent); color: #fff; }
  .practice-nav .controls { display: flex; gap: 12px; margin-left: auto; align-items: center; }
  
  /* Á≠îÈ¢òÁªìÊûúÊòæÁ§∫ */
  #results { background: #fff; border: 1px solid var(--line); border-radius: 10px; padding: 12px; margin: 16px 0; font-family: monospace; white-space: pre-wrap; }
  #results p { margin: 0 0 8px; }
  .badge { background: #e0e7ff; color: var(--accent); padding: 2px 8px; border-radius: 999px; font-size: 12px; }
  
  /* Á≠îÊ°àÊ°Ü */
  details.answerbox { background: #fff; border: 1px solid var(--line); border-radius: 10px; padding: 12px; margin-top: 10px; }
  details.answerbox summary { cursor: pointer; font-weight: 600; list-style: none; display: flex; align-items: center; justify-content: space-between; }
  details.answerbox summary::-webkit-details-marker { display: none; }
  #answerContent { margin-top: 10px; }
  #answerContent ol { margin: 0; padding-left: 20px; }
  #answerContent li { margin: 4px 0; }

  /* È´ò‰∫ÆÊ†∑Âºè */
  .hl { background: #ffeb3b; color: #000; }
  body.dark .hl { background: #8a6d00; color: #fff; }
  
  /* ÊªöÂä®Êù°Ê†∑Âºè */
  ::-webkit-scrollbar { width: 8px; height: 8px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #c5c5d2; border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: #999; }
  body.dark ::-webkit-scrollbar-thumb { background: #4a5568; }
  body.dark ::-webkit-scrollbar-thumb:hover { background: #718096; }
</style>
</head>
<body>

<div class="practice-nav">
  <div class="title">Questions</div>
  <div class="questions">
    <div class="q-item" id="q1-nav" onclick="scrollToElement('q1-anchor')">1</div>
    <div class="q-item" id="q2-nav" onclick="scrollToElement('q2-anchor')">2</div>
    <div class="q-item" id="q3-nav" onclick="scrollToElement('q3-anchor')">3</div>
    <div class="q-item" id="q4-nav" onclick="scrollToElement('q4-anchor')">4</div>
    <div class="q-item" id="q5-nav" onclick="scrollToElement('q5-anchor')">5</div>
    <div class="q-item" id="q6-nav" onclick="scrollToElement('q6-anchor')">6</div>
    <div class="q-item" id="q7-nav" onclick="scrollToElement('q7-anchor')">7</div>
    <div class="q-item" id="q8-nav" onclick="scrollToElement('q8-anchor')">8</div>
    <div class="q-item" id="q9-nav" onclick="scrollToElement('q9-anchor')">9</div>
    <div class="q-item" id="q10-nav" onclick="scrollToElement('q10-anchor')">10</div>
    <div class="q-item" id="q11-nav" onclick="scrollToElement('q11-anchor')">11-13</div>
  </div>
  <div class="controls">
    <span id="timer" onclick="toggleTimer()">00:00</span>
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode">üåô</button>
  </div>
</div>

<div class="shell">
  <section class="pane" id="left">
    <h2>READING PASSAGE 1</h2>
    <p>You should spend about 20 minutes on Questions 1‚Äì13, which are based on Reading Passage 1 below.</p>
    
    <h3>William Gilbert and Magnetism</h3>
  
    <h4>Paragraph A</h4>
    <p>The 16th and 17th centuries saw two great pioneers of modern science: Galileo and Gilbert. The impact of their findings is eminent. Gilbert was the first modern scientist, the accredited father of the science of electricity and magnetism, an Englishman of learning and a physician at the court of Elizabeth. Prior to him, all that was known of electricity and magnetism was what the ancients knew: nothing more than that the lodestone possessed magnetic properties and that amber and jet, when rubbed, would attract bits of paper or other substances of small specific gravity. However, he is less well known than he deserves.</p>
    <h4>Paragraph B</h4>
    <p>Gilbert‚Äôs birth predated Galileo‚Äôs. Born into an eminent local family in Colchester, Essex, on 24 May 1544, he went to grammar school and then studied medicine at St John‚Äôs College, Cambridge, graduating in 1573. Later he travelled on the Continent and eventually settled in London.</p>
    <h4>Paragraph C</h4>
    <p>He was a very successful and eminent doctor. All this culminated in his election as president of the Royal Society. He was also appointed personal physician to Queen Elizabeth I and was later knighted by her. He faithfully served her until her death. However, he did not outlive the Queen for long and died on 30 November 1603, only a few months after his appointment as personal physician to King James.</p>
    <h4>Paragraph D</h4>
    <p>Gilbert was first interested in chemistry but later changed his focus because alchemy contained too great a portion of mysticism (such as the transmutation of metals). He gradually developed an interest in physics, inspired by the great minds of the ancients, particularly the knowledge the ancient Greeks had about lodestones-strange minerals with the power to attract iron. In the meantime, Britain became a major seafaring nation in 1588 when the Spanish Armada was defeated, opening the way to British settlement of America. British ships depended on the magnetic compass, yet no one understood why it worked. Did the Pole Star attract it, as Columbus once speculated; or was there a magnetic mountain at the pole, as described in the Odyssey, which ships would never approach because the sailors thought its pull would yank out all their iron nails and fittings? For nearly 20 years, William Gilbert conducted ingenious experiments to understand magnetism. His works include On the Magnet, Magnetic Bodies, and The Great Magnet of the Earth.</p>
    <h4>Paragraph E</h4>
    <p>Gilbert‚Äôs discoveries were of great importance to modern physics. He investigated the nature of magnetism and electricity, and he even coined the word ‚Äúelectric‚Äù. Early beliefs about magnetism were largely entangled with superstitions-for instance, sailors believed that rubbing garlic on a lodestone could neutralise its magnetism and that even the smell of garlic would interfere with the action of a compass, which is why helmsmen were forbidden to eat it near a ship‚Äôs compass. Gilbert also found that metals can be magnetised by rubbing materials such as fur on them. He named the ends of a magnet the ‚Äúnorth pole‚Äù and ‚Äúsouth pole‚Äù. The magnetic poles can attract or repel, depending on polarity; ordinary iron, however, is always attracted to a magnet. Though he began to study the relationship between magnetism and electricity, he did not complete this work. His research into static electricity using amber and jet only demonstrated that objects with electrical charges can attract small pieces of paper and the like. It was a French scientist named du Fay who later discovered that there are actually two electrical charges-positive and negative.</p>
    <h4>Paragraph F</h4>
    <p>He also questioned traditional astronomical beliefs. Though a Copernican, he did not state explicitly whether the Earth is at the centre of the universe or in orbit around the Sun. However, he believed that stars are not equidistant from the Earth but have their own Earth-like planets orbiting around them. The Earth itself is like a giant magnet, which is also why compasses always point north: they align with the planet‚Äôs polarity. He likened the polarity of a magnet to the polarity of the Earth and built an entire magnetic philosophy on this analogy. In his explanation, magnetism is the soul of the Earth. Thus a perfectly spherical lodestone, when aligned with the Earth‚Äôs poles, would wobble all by itself in 24 hours. Further, he believed that the Sun and other stars wobble just as the Earth does around a crystal core, and he speculated that the Moon might also be a magnet caused to orbit by its magnetic attraction to the Earth. This was perhaps the first proposal that a force might cause a heavenly orbit.</p>
    <h4>Paragraph G</h4>
    <p>His research method was revolutionary in that he used experiments rather than pure logic and reasoning, as the ancient Greek philosophers had done. This represented a new attitude towards scientific investigation; until then, systematic experiments were not in fashion. Because of this scientific attitude, together with his contribution to our knowledge of magnetism, a unit of magnetomotive force-also known as magnetic potential-was named the gilbert in his honour. His approach of careful observation and experimentation, rather than reliance on authoritative opinion or deductive philosophy, laid the very foundation for modern science.</p>
    
    <p>&nbsp;</p>
    <p>&nbsp;</p>
    <p>&nbsp;</p>

  </section>
  <div id="divider" title="Drag to resize"></div>
  <section class="pane" id="right">
    <h3>Questions</h3>
    
    <div class="group">
      <h4>Questions 1‚Äì7</h4>
      <p>Reading Passage 1 has seven paragraphs A‚ÄìG. Choose the correct heading for each paragraph from the list of headings below. Write the correct number, i‚Äìx, in boxes 1‚Äì7 on your answer sheet.</p>
      <div class="headings-list">
        <p><strong>List of Headings</strong></p>
        <ol type="i">
          <li>Early years of Gilbert</li>
          <li>What was new about his scientific research method</li>
          <li>The development of chemistry</li>
          <li>Questioning traditional astronomy</li>
          <li>Pioneers of early science</li>
          <li>Professional and social recognition</li>
          <li>Becoming the president of the Royal Society</li>
          <li>The great works of Gilbert</li>
          <li>His discovery about magnetism</li>
          <li>His change of focus</li>
        </ol>
      </div>
      <table id="q1-anchor">
          <thead>
              <tr><th>Paragraph</th><th>Heading (i-x)</th></tr>
          </thead>
          <tbody>
              <tr><td><strong>1.</strong> Paragraph A</td><td><input name="q1" type="text" placeholder="i-x" size="4" style="text-align:center; border:none; border-bottom:1px solid #9ca3af; font-size:1em;"></td></tr>
              <tr id="q2-anchor"><td><strong>2.</strong> Paragraph B</td><td><input name="q2" type="text" placeholder="i-x" size="4" style="text-align:center; border:none; border-bottom:1px solid #9ca3af; font-size:1em;"></td></tr>
              <tr id="q3-anchor"><td><strong>3.</strong> Paragraph C</td><td><input name="q3" type="text" placeholder="i-x" size="4" style="text-align:center; border:none; border-bottom:1px solid #9ca3af; font-size:1em;"></td></tr>
              <tr id="q4-anchor"><td><strong>4.</strong> Paragraph D</td><td><input name="q4" type="text" placeholder="i-x" size="4" style="text-align:center; border:none; border-bottom:1px solid #9ca3af; font-size:1em;"></td></tr>
              <tr id="q5-anchor"><td><strong>5.</strong> Paragraph E</td><td><input name="q5" type="text" placeholder="i-x" size="4" style="text-align:center; border:none; border-bottom:1px solid #9ca3af; font-size:1em;"></td></tr>
              <tr id="q6-anchor"><td><strong>6.</strong> Paragraph F</td><td><input name="q6" type="text" placeholder="i-x" size="4" style="text-align:center; border:none; border-bottom:1px solid #9ca3af; font-size:1em;"></td></tr>
              <tr id="q7-anchor"><td><strong>7.</strong> Paragraph G</td><td><input name="q7" type="text" placeholder="i-x" size="4" style="text-align:center; border:none; border-bottom:1px solid #9ca3af; font-size:1em;"></td></tr>
          </tbody>
      </table>
    </div>
    
    <div class="group">
      <h4>Questions 8‚Äì10</h4>
      <p>Do the following statements agree with the information given in Reading Passage 1? In boxes 8‚Äì10 on your answer sheet, write</p>
      <ul><li><strong>TRUE</strong>, <strong>FALSE</strong>, or <strong>NOT GIVEN</strong></li></ul>
      
      <div id="q8-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;"><p><strong>8.</strong> Gilbert is less famous than he should be.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;"><label><input name="q8" type="radio" value="TRUE"> TRUE</label><label><input name="q8" type="radio" value="FALSE"> FALSE</label><label><input name="q8" type="radio" value="NOT GIVEN"> NOT GIVEN</label></div>
      </div>
      <div id="q9-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;"><p><strong>9.</strong> Gilbert was famous as a doctor before he was employed by the Queen.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;"><label><input name="q9" type="radio" value="TRUE"> TRUE</label><label><input name="q9" type="radio" value="FALSE"> FALSE</label><label><input name="q9" type="radio" value="NOT GIVEN"> NOT GIVEN</label></div>
      </div>
      <div id="q10-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;"><p><strong>10.</strong> Gilbert lost faith in the medical theories of his time.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;"><label><input name="q10" type="radio" value="TRUE"> TRUE</label><label><input name="q10" type="radio" value="FALSE"> FALSE</label><label><input name="q10" type="radio" value="NOT GIVEN"> NOT GIVEN</label></div>
      </div>
    </div>
    
    <div class="group">
      <h4 id="q11-anchor">Questions 11‚Äì13</h4>
      <p>Choose THREE letters, A‚ÄìF. Write the correct letters in boxes 11‚Äì13 on your answer sheet.</p>
      <p>Which THREE of the following are parts of Gilbert‚Äôs discovery?</p>
      <div style="padding-top: 8px; line-height: 1.8;">
        <label style="display:block;"><input type="checkbox" name="q11_13" value="A"> A. Metal can be transformed into another.</label>
        <label style="display:block;"><input type="checkbox" name="q11_13" value="B"> B. Garlic can remove magnetism.</label>
        <label style="display:block;"><input type="checkbox" name="q11_13" value="C"> C. Metals can be magnetised.</label>
        <label style="display:block;"><input type="checkbox" name="q11_13" value="D"> D. Stars are at different distances from the Earth.</label>
        <label style="display:block;"><input type="checkbox" name="q11_13" value="E"> E. The Earth wobbles on its axis.</label>
        <label style="display:block;"><input type="checkbox" name="q11_13" value="F"> F. There are two charges of electricity.</label>
      </div>
    </div>

    <div style="display:flex;gap:8px;margin-bottom:10px;">
      <button class="primary" onclick="grade()">Submit</button>
      <button onclick="resetForm()">Reset</button>
      <button onclick="toggleNotes()">Notes</button>
    </div>
    <div id="results"></div>
    <details class="answerbox" id="answerBox">
      <summary>Show answers (click to toggle) <span class="badge">hidden</span></summary>
      <div id="answerContent"></div>
    </details>
  </section>
</div>

<div aria-label="Selection tools" id="selbar" role="toolbar">
  <button id="btnHL">Highlight</button><button id="btnUH">Remove</button><button id="btnNote">Note</button>
</div>

<div id="notes">
  <header><strong>Notes</strong><div><button id="btnCopy">Copy</button><button id="btnClose">Close</button></div></header>
  <textarea id="noteArea" placeholder="Type your notes here..."></textarea>
</div>

<div id="toast"></div>

<script>
// UI functions: scrollToElement, showToast, Timer, toggleTheme, Divider, Highlighter, Notes
function scrollToElement(id) {
    const element = document.getElementById(id);
    if (element) {
        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
        const navItem = document.getElementById(id.replace('-anchor', '-nav'));
        if (navItem) {
            navItem.classList.add('active');
            setTimeout(() => navItem.classList.remove('active'), 1200);
        }
    }
}

function showToast(msg) {
    const toastEl = document.getElementById('toast');
    toastEl.textContent = msg;
    toastEl.style.display = 'block';
    setTimeout(() => { toastEl.style.display = 'none'; }, 1500);
}

let timerSeconds = 0, timerRunning = false, timerInterval;
const timerEl = document.getElementById('timer');
function updateTimerDisplay() {
    const minutes = Math.floor(timerSeconds / 60);
    const seconds = timerSeconds % 60;
    timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function startTimer() {
    if (!timerRunning) {
        timerRunning = true;
        timerEl.classList.remove('paused');
        timerInterval = setInterval(() => { timerSeconds++; updateTimerDisplay(); }, 1000);
    }
}

function stopTimer() {
    timerRunning = false;
    timerEl.classList.add('paused');
    clearInterval(timerInterval);
}

function toggleTimer() {
    if (timerRunning) { stopTimer(); showToast('Timer paused'); }
    else { startTimer(); showToast('Timer resumed'); }
}

function toggleTheme() {
    document.body.classList.toggle('dark');
    const isDark = document.body.classList.contains('dark');
    localStorage.setItem('darkMode', isDark);
    document.querySelector('.theme-toggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
}

const divider = document.getElementById('divider'), leftPane = document.getElementById('left');
let isDragging = false;
divider.addEventListener('mousedown', (e) => { isDragging = true; document.body.style.cursor = 'ew-resize'; e.preventDefault(); });
window.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    const shellRect = document.querySelector('.shell').getBoundingClientRect();
    let newLeftWidth = e.clientX - shellRect.left;
    if (newLeftWidth < 280) newLeftWidth = 280;
    if (newLeftWidth > shellRect.width - 320) newLeftWidth = shellRect.width - 320;
    leftPane.style.flexBasis = newLeftWidth + 'px';
});
window.addEventListener('mouseup', () => { isDragging = false; document.body.style.cursor = 'default'; });

const selbar = document.getElementById('selbar');
let lastRange = null;
function positionSelbar() {
    const selection = window.getSelection();
    if (!selection || selection.rangeCount === 0 || selection.isCollapsed) { selbar.style.display = 'none'; return; }
    const range = selection.getRangeAt(0);
    lastRange = range.cloneRange();
    const rect = range.getBoundingClientRect();
    selbar.style.display = 'flex';
    selbar.style.top = `${window.scrollY + rect.top - selbar.offsetHeight - 5}px`;
    selbar.style.left = `${window.scrollX + rect.left + rect.width / 2 - selbar.offsetWidth / 2}px`;
}
document.getElementById('left').addEventListener('mouseup', positionSelbar);
document.getElementById('btnHL').addEventListener('click', () => { if (lastRange) { const span = document.createElement('span'); span.className = 'hl'; try { lastRange.surroundContents(span); } catch (e) { span.appendChild(lastRange.extractContents()); lastRange.insertNode(span); } window.getSelection().removeAllRanges(); selbar.style.display = 'none'; } });
document.getElementById('btnUH').addEventListener('click', () => { if (lastRange) { const ancestor = lastRange.commonAncestorContainer; ancestor.querySelectorAll('.hl').forEach(hl => { if (lastRange.intersectsNode(hl)) { const parent = hl.parentNode; while (hl.firstChild) { parent.insertBefore(hl.firstChild, hl); } parent.removeChild(hl); parent.normalize(); } }); window.getSelection().removeAllRanges(); selbar.style.display = 'none'; } });

const notesPanel = document.getElementById('notes'), noteArea = document.getElementById('noteArea');
function toggleNotes() { notesPanel.style.display = (notesPanel.style.display === 'flex' ? 'none' : 'flex'); }
window.toggleNotes = toggleNotes;
document.getElementById('btnClose').addEventListener('click', toggleNotes);
document.getElementById('btnCopy').addEventListener('click', async () => { await navigator.clipboard.writeText(noteArea.value || ''); showToast('Copied'); });
document.getElementById('btnNote').addEventListener('click', () => { const selection = window.getSelection().toString().trim(); if (selection) { noteArea.value += (noteArea.value ? '\n\n' : '') + `> ${selection}`; toggleNotes(); window.getSelection().removeAllRanges(); selbar.style.display = 'none'; } });

// Core Logic: Grading, Resetting, Status Updates
const correctAnswers = { "q1":"v", "q2":"i", "q3":"vi", "q4":"x", "q5":"ix", "q6":"iv", "q7":"ii", "q8":"TRUE", "q9":"TRUE", "q10":"NOT GIVEN", "q11_13": ["C", "D", "E"] };

function updateAnswerStatus() {
    for (let i = 1; i <= 10; i++) {
        const navItem = document.getElementById(`q${i}-nav`);
        if (navItem) {
            let answered = false;
            if (i <= 7) {
                const input = document.querySelector(`input[name="q${i}"]`);
                answered = input && input.value.trim() !== '';
            } else {
                const radio = document.querySelector(`input[name="q${i}"]:checked`);
                answered = !!radio;
            }
            navItem.classList.toggle('answered', answered);
        }
    }
    const checkboxNav = document.getElementById('q11-nav');
    if (checkboxNav) {
        const anyChecked = document.querySelector('input[name="q11_13"]:checked');
        checkboxNav.classList.toggle('answered', !!anyChecked);
    }
}

function grade() {
    let total = 13, correct = 0, resultLines = [];
    
    // Grade Q1-7 (Headings)
    for (let i = 1; i <= 7; i++) {
        const qName = `q${i}`;
        const input = document.querySelector(`input[name="${qName}"]`);
        const userAnswer = input ? input.value.trim().toLowerCase() : '';
        const isCorrect = userAnswer === correctAnswers[qName];
        if (isCorrect) correct++;
        resultLines.push(`${i}. Para ${String.fromCharCode(64 + i)}: ${userAnswer || 'None'} ${isCorrect ? '‚úì' : '‚úó'}`);
    }

    // Grade Q8-10 (T/F/NG)
    for (let i = 8; i <= 10; i++) {
        const qName = `q${i}`;
        const radio = document.querySelector(`input[name="${qName}"]:checked`);
        const userAnswer = radio ? radio.value : '';
        const isCorrect = userAnswer === correctAnswers[qName];
        if (isCorrect) correct++;
        resultLines.push(`${i}. ${userAnswer || 'None'} ${isCorrect ? '‚úì' : '‚úó'}`);
    }

    // Grade Q11-13 (Checkboxes) - Total 3 points available
    const selectedCheckboxes = Array.from(document.querySelectorAll('input[name="q11_13"]:checked')).map(cb => cb.value);
    const correctCheckboxes = correctAnswers["q11_13"];
    let correctSelections = 0;
    
    correctCheckboxes.forEach(correctAnswer => {
        if (selectedCheckboxes.includes(correctAnswer)) {
            correctSelections++;
        }
    });
    correct += correctSelections;
    
    resultLines.push(`11-13. Selected: [${selectedCheckboxes.join(', ') || 'None'}], Correct: [${correctCheckboxes.join(', ')}] (${correctSelections}/${correctCheckboxes.length} correct)`);
    
    // Display results
    const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;
    document.getElementById('results').innerHTML = `<p><strong>Score:</strong> ${correct}/${total} <span class="badge">Accuracy ${accuracy}%</span></p><pre>${resultLines.join('\n')}</pre>`;
    
    document.getElementById('answerContent').innerHTML = `
        <ol style="list-style-type: none; padding-left: 0;">
            <li><strong>1. Paragraph A:</strong> v</li>
            <li><strong>2. Paragraph B:</strong> i</li>
            <li><strong>3. Paragraph C:</strong> vi</li>
            <li><strong>4. Paragraph D:</strong> x</li>
            <li><strong>5. Paragraph E:</strong> ix</li>
            <li><strong>6. Paragraph F:</strong> iv</li>
            <li><strong>7. Paragraph G:</strong> ii</li>
            <li><strong>8.</strong> TRUE</li>
            <li><strong>9.</strong> TRUE</li>
            <li><strong>10.</strong> NOT GIVEN</li>
            <li><strong>11-13.</strong> C, D, E (in any order)</li>
        </ol>
    `;
    document.querySelector('#answerBox .badge').textContent = 'tap to view';
    updateAnswerStatus();
}

function resetForm() {
    document.querySelectorAll('input[type="text"]').forEach(input => input.value = '');
    document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(input => input.checked = false);
    document.getElementById('results').innerHTML = '';
    document.getElementById('answerContent').innerHTML = '';
    const answerBadge = document.querySelector('#answerBox .badge');
    if (answerBadge) answerBadge.textContent = 'hidden';
    if (document.getElementById('answerBox').hasAttribute('open')) {
        document.getElementById('answerBox').removeAttribute('open');
    }
    updateAnswerStatus();
    showToast('Form reset');
}

// Event Listeners and Initialization
document.addEventListener('DOMContentLoaded', () => {
  startTimer();
  updateAnswerStatus();
  if (localStorage.getItem('darkMode') === 'true') {
    document.body.classList.add('dark');
    document.querySelector('.theme-toggle').textContent = '‚òÄÔ∏è';
  }
  loadPracticePageEnhancer();
});
document.addEventListener('input', updateAnswerStatus);

// Practice Page Enhancer Script
function loadPracticePageEnhancer() {
    const script = document.createElement('script');
    script.src = '../../../js/practice-page-enhancer.js';
    script.onload = () => console.log('Practice page enhancer script loaded.');
    script.onerror = () => { console.error('Failed to load practice page enhancer script. Falling back to inline version.'); loadInlineEnhancer(); };
    document.head.appendChild(script);
}

function loadInlineEnhancer() {
    if (window.practicePageEnhancer) return;
    window.practicePageEnhancer = {
        initialize: function() { this.setupCommunication(); this.setupAnswerListeners(); this.interceptSubmit(); },
        setupCommunication: function() {
            this.parentWindow = window.opener || window.parent;
            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'INIT_SESSION') {
                    this.sessionId = event.data.data.sessionId;
                    this.sendMessage('SESSION_READY', { pageType: this.detectPageType(), url: window.location.href });
                }
            });
        },
        detectPageType: () => document.title.includes('P1') ? 'P1' : 'unknown',
        setupAnswerListeners: function() {
            this.answers = {};
            this.startTime = Date.now();
            document.addEventListener('input', (e) => {
                if (e.target.name && e.target.name.startsWith('q')) {
                    if (e.target.type === 'checkbox') {
                        const existing = Array.from(document.querySelectorAll(`input[name="${e.target.name}"]:checked`)).map(cb => cb.value);
                        this.answers[e.target.name] = existing;
                    } else { this.answers[e.target.name] = e.target.value; }
                }
            });
        },
        interceptSubmit: function() { if (typeof window.grade === 'function') { const originalGrade = window.grade; window.grade = () => { originalGrade(); setTimeout(() => this.handleSubmit(), 200); }; } },
        handleSubmit: function() {
            const results = {
                sessionId: this.sessionId,
                startTime: this.startTime,
                endTime: Date.now(),
                duration: Math.round((Date.now() - this.startTime) / 1000),
                answers: this.answers,
                scoreInfo: this.extractScore(),
                pageType: this.detectPageType(),
                url: window.location.href
            };
            this.sendMessage('PRACTICE_COMPLETE', results);
        },
        extractScore: function() {
            const resultsEl = document.getElementById('results');
            if (!resultsEl) return null;
            const text = resultsEl.textContent || '';
            const scoreMatch = text.match(/Score:\s*(\d+)\/(\d+)/i);
            if (scoreMatch) {
                const correct = parseInt(scoreMatch[1], 10);
                const total = parseInt(scoreMatch[2], 10);
                return { correct, total, accuracy: total > 0 ? correct / total : 0, percentage: total > 0 ? Math.round((correct / total) * 100) : 0, source: 'inline_extraction' };
            }
            return null;
        },
        sendMessage: function(type, data) { if (this.parentWindow && this.parentWindow !== window) { this.parentWindow.postMessage({ type, data, source: 'practice_page' }, '*'); } }
    };
    window.practicePageEnhancer.initialize();
}
</script>

</body>
</html>