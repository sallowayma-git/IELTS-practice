<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>P1 ‚Äì Wood: A Valuable Resource in New Zealand's Economy (Fixed & Optimized)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root { 
    --line: #e5e7eb; 
    --bg: #f6f7fb; 
    --panel: #fff; 
    --accent: #3b82f6; 
    --muted: #6b7280; 
    --shadow: 0 6px 20px rgba(0,0,0,.12); 
  }
  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body { 
    margin: 0; 
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; 
    background: var(--bg); 
    padding-bottom: 82px; 
  }
  
  /* Â∏ÉÂ±ÄÊ†∑Âºè */
  .shell { display: flex; height: 100vh; width: 100%; }
  .pane { background: var(--panel); overflow: auto; padding: 20px; }
  #left { flex: 0 0 50%; min-width: 280px; }
  #right { flex: 1 1 auto; min-width: 320px; background: #fbfbff; border-left: 1px solid var(--line); }
  #divider { flex: 0 0 8px; background: linear-gradient(90deg, #e5e7eb, #d1d5db); cursor: ew-resize; position: relative; z-index: 5; user-select: none; }
  
  /* ÊñáÊú¨Ê†∑Âºè */
  h2, h3, h4 { margin: 0 0 10px; }
  #left p { margin: 0 0 12px; line-height: 1.6; word-break: normal; overflow-wrap: normal; hyphens: none; }
  
  /* ÁªÑ‰ª∂Ê†∑Âºè */
  .group { background: #fff; border: 1px solid var(--line); border-radius: 10px; padding: 12px; margin-bottom: 14px; }
  input.blank { border:none; border-bottom:1px solid #9ca3af; padding:4px 2px; font-size:1em; background:transparent; width: 100%; margin-top: 4px; }
  input.blank:focus { outline:none; border-bottom:2px solid var(--accent); }

  /* ÊåâÈíÆÊ†∑Âºè */
  button { padding: 8px 12px; border: 1px solid var(--line); background: #fff; border-radius: 6px; cursor: pointer; transition: all 0.2s; font-size: 14px; }
  button:hover { background: #f8fafc; border-color: #cbd5e1; }
  button.primary { background: var(--accent); color: #fff; border-color: var(--accent); }
  button.primary:hover { background: #2563eb; }
  
  /* ËÆ°Êó∂Âô®Ê†∑Âºè */
  #timer { background: #fff; color: var(--muted); border: 1px solid var(--line); border-radius: 6px; padding: 6px 12px; cursor: pointer; font-family: 'Courier New', monospace; transition: all 0.2s; min-width: 70px; text-align: center; font-size: 18px; font-weight: bold; }
  #timer:hover { background: #f1f5f9; border-color: var(--accent); }
  #timer.paused { color: #ef4444; border-color: #fecaca; background: #fef2f2; }
  
  /* ‰∏ªÈ¢òÂàáÊç¢ÊåâÈíÆ */
  .theme-toggle { background: #fff; color: var(--muted); border: 1px solid var(--line); border-radius: 6px; width: 36px; height: 36px; font-size: 16px; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; }
  .theme-toggle:hover { background: var(--accent); color: #fff; border-color: var(--accent); transform: scale(1.05); }
  
  /* Ê∑±Ëâ≤Ê®°ÂºèÊ†∑Âºè */
  body.dark { --bg: #0f172a; --panel: #1e293b; --line: #334155; --muted: #94a3b8; color: #e2e8f0; }
  body.dark #right { background: #0f172a; }
  body.dark .group { background: #1e293b; border-color: #334155; }
  body.dark button { background: #1e293b; color: #e2e8f0; border-color: #334155; }
  body.dark button:hover { background: #334155; }
  body.dark button.primary { background: var(--accent); color: #fff; }
  body.dark #results { background: #1e293b; border-color: #334155; }
  body.dark #notes { background: #1e293b; border-color: #334155; color: #e2e8f0; }
  body.dark .practice-nav { background: #1e293b; border-color: #334155; }
  body.dark .q-item { background: #0f172a; color: #e2e8f0; border-color: #334155; }
  body.dark .q-item:hover { background: #334155; }
  body.dark .q-item.answered { background: #1e40af; border-color: var(--accent); color: #93c5fd; }
  body.dark #timer { background: #1e293b; color: #e2e8f0; border-color: #334155; }
  body.dark #timer:hover { background: #334155; border-color: var(--accent); }
  body.dark details.answerbox { background: #1e293b; border-color: #334155; }
  body.dark input.blank { color: #e2e8f0; border-bottom-color: #64748b; }
  body.dark input.blank:focus { border-bottom-color: var(--accent); }

  /* ÂìçÂ∫îÂºèËÆæËÆ° */
  @media (max-width: 768px) {
    .shell { flex-direction: column; }
    #left, #right { flex: none; min-width: auto; }
    #divider { display: none; }
    .practice-nav .controls { gap: 8px; }
    #timer { font-size: 12px; padding: 3px 8px; }
    .theme-toggle { width: 32px; height: 32px; font-size: 14px; }
    #notes { width: calc(100vw - 24px); right: 12px; left: 12px; }
  }
  
  /* ÈÄâÊã©Â∑•ÂÖ∑Ê†è */
  #selbar { position: fixed; display: none; z-index: 2000; background: #111; color: #fff; border-radius: 8px; padding: 6px; box-shadow: var(--shadow); font-size: 13px; gap: 6px; align-items: center; }
  #selbar button { background: transparent; color: #fff; border: 1px solid rgba(255,255,255,.25); padding: 4px 8px; border-radius: 6px; cursor: pointer; }
  #selbar button:hover { border-color: #fff; }
  
  /* Á¨îËÆ∞Èù¢Êùø */
  #notes { position: fixed; right: 12px; bottom: 12px; width: 320px; height: 42vh; background: #fff; border: 1px solid var(--line); border-radius: 12px; display: none; flex-direction: column; z-index: 1500; box-shadow: var(--shadow); }
  #notes header { display: flex; align-items: center; justify-content: space-between; padding: 8px 10px; border-bottom: 1px solid var(--line); }
  #notes textarea { flex: 1; border: 0; padding: 10px; resize: none; font-size: 14px; line-height: 1.5; }
  
  /* ToastÈÄöÁü• */
  #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: #fff; padding: 8px 16px; border-radius: 4px; display: none; z-index: 3000; font-size: 14px; }
  
  /* Á≠îÈ¢òÂØºËà™ */
  .practice-nav { background: #fff; padding: 12px 20px; display: flex; align-items: center; gap: 16px; box-shadow: 0 2px 4px rgba(0,0,0,.05); flex-wrap: wrap; position: fixed; left: 0; right: 0; bottom: 0; border-top: 2px solid var(--line); z-index: 4000; }
  .practice-nav .title { font-weight: 600; color: var(--muted); }
  .practice-nav .questions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  .practice-nav .q-item { padding: 6px 10px; border: 1px solid var(--line); border-radius: 6px; background: #fff; cursor: pointer; font-size: 14px; transition: all 0.2s; min-width: 36px; text-align: center; }
  .practice-nav .q-item:hover { background: #f1f5f9; border-color: var(--accent); }
  .practice-nav .q-item.answered { background: #e0e7ff; border-color: var(--accent); color: var(--accent); font-weight: 500; }
  .practice-nav .q-item.active { background: var(--accent); color: #fff; }
  .practice-nav .controls { display: flex; gap: 12px; margin-left: auto; align-items: center; }
  
  /* Á≠îÈ¢òÁªìÊûúÊòæÁ§∫ */
  #results { background: #fff; border: 1px solid var(--line); border-radius: 10px; padding: 12px; margin: 16px 0; font-family: monospace; white-space: pre-wrap; }
  #results p { margin: 0 0 8px; }
  .badge { background: #e0e7ff; color: var(--accent); padding: 2px 8px; border-radius: 999px; font-size: 12px; }
  
  /* Á≠îÊ°àÊ°Ü */
  details.answerbox { background: #fff; border: 1px solid var(--line); border-radius: 10px; padding: 12px; margin-top: 10px; }
  details.answerbox summary { cursor: pointer; font-weight: 600; list-style: none; display: flex; align-items: center; justify-content: space-between; }
  details.answerbox summary::-webkit-details-marker { display: none; }
  #answerContent { margin-top: 10px; }
  #answerContent ol { margin: 0; padding-left: 20px; }
  #answerContent li { margin: 4px 0; }

  /* È´ò‰∫ÆÊ†∑Âºè */
  .hl { background: #ffeb3b; color: #000; }
  body.dark .hl { background: #8a6d00; color: #fff; }
  
  /* ÊªöÂä®Êù°Ê†∑Âºè */
  ::-webkit-scrollbar { width: 8px; height: 8px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #c5c5d2; border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: #999; }
  body.dark ::-webkit-scrollbar-thumb { background: #4a5568; }
  body.dark ::-webkit-scrollbar-thumb:hover { background: #718096; }
</style>
</head>
<body>

<div class="practice-nav">
  <div class="title">Questions</div>
  <div class="questions">
    <div class="q-item" id="q1-nav" onclick="scrollToElement('q1-anchor')">1</div>
    <div class="q-item" id="q2-nav" onclick="scrollToElement('q2-anchor')">2</div>
    <div class="q-item" id="q3-nav" onclick="scrollToElement('q3-anchor')">3</div>
    <div class="q-item" id="q4-nav" onclick="scrollToElement('q4-anchor')">4</div>
    <div class="q-item" id="q5-nav" onclick="scrollToElement('q5-anchor')">5</div>
    <div class="q-item" id="q6-nav" onclick="scrollToElement('q6-anchor')">6</div>
    <div class="q-item" id="q7-nav" onclick="scrollToElement('q7-anchor')">7</div>
    <div class="q-item" id="q8-nav" onclick="scrollToElement('q8-anchor')">8</div>
    <div class="q-item" id="q9-nav" onclick="scrollToElement('q9-anchor')">9</div>
    <div class="q-item" id="q10-nav" onclick="scrollToElement('q10-anchor')">10</div>
    <div class="q-item" id="q11-nav" onclick="scrollToElement('q11-anchor')">11</div>
    <div class="q-item" id="q12-nav" onclick="scrollToElement('q12-anchor')">12</div>
    <div class="q-item" id="q13-nav" onclick="scrollToElement('q13-anchor')">13</div>
  </div>
  <div class="controls">
    <span id="timer" onclick="toggleTimer()">00:00</span>
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode">üåô</button>
  </div>
</div>

<div class="shell">
  <section class="pane" id="left">
    <h2>READING PASSAGE 1</h2>
    <p>You should spend about 20 minutes on Questions 1‚Äì13, which are based on Reading Passage 1 below.</p>
    
    <h3>Wood: A Valuable Resource in New Zealand's Economy</h3>
    
    <p>During the settlement of New Zealand by European immigrants, natural timbers played a major role. Wood was easily accessible and relatively cheap. A tradition of wooden houses arose, supported by the recognition that they were less likely to collapse suddenly during earthquakes, a not-infrequent event in this part of the world. But in addition to demand from the domestic market, there was also demand for forest products from overseas.</p>
    <p>Early explorers recognised the suitability of the tall, straight trunks of the kauri for constructing sailing vessels. The kauri is a species of coniferous tree found only in small areas of the southern hemisphere. So, from the early 1800s, huge amounts of this type of wood were sold to Australia and the UK for that purpose. For a period, the forestry industry was the country's major export earner, but the rate of harvest was unsustainable and, by the beginning of the 20th century, indigenous timber exports were rapidly declining.</p>
    <p>From the 1940s, newly established plantations of an imported species of tree called radiata pine supplied timber and other wood products in increasing quantities. By the 1960s, plantation-grown timber was providing most of the country's sawn-timber needs, especially for construction. Today, less than two percent of timber is cut from indigenous forests, and almost all of that is used for higher-value end uses such as furniture and fittings. As the pine industry developed, it became apparent that this type of wood was also well suited for many uses. It makes excellent pulp*, and is frequently used for posts, poles, furnishings and mouldings, particleboard, fibreboard, and for plywood and ‚Äòengineered' wood products. Pine by-products are used in the chemical and pharmaceutical industries and residues are consumed for fuel. This amazing versatility has encouraged the development of an integrated forest-products industry which is almost unique in the world.</p>
    <p>Exporters of wood products have largely targeted the rapidly growing markets of South and East Asia and Australia. Eighty percent of exports by value go to only five markets: Japan, Korea, China, the United States and Australia. The product mix remains heavily biased towards raw materials, with logs, sawn wood, pulp and paper comprising 75 percent of export value. However, finished wood products such as panels and furniture components are exported to more than 50 countries.</p>
    <p>In New Zealand itself, the construction industry is the principal user of solid wood products, servicing around 20,000 new-house starts annually. However, the small size of New Zealand's population (just over four million), plus its small manufacturing and remanufacturing base, limits the forestry industry's domestic opportunities. For the last few years local wood consumption has been around only four million cubic metres. Accordingly, the development of the export market is the key to the industry's growth and contribution to the national economy in decades to come.</p>
    <p>In 2004, forestry export receipts were about 11 percent of the country's total export income, their value having increased steadily for ten years, until affected by the exchange fluctuations and shipping costs of recent years. The forestry industry is New Zealand's third-largest export sector, generating around $3.3 billion annually from logs and processed wood products. But it is generally agreed that it is operating well below its capacity and, with the domestic market already at its peak, almost all of the extra wood produced in future will have to be marketed overseas. That presents a major marketing challenge for the industry.</p>
    <p>Although the export of logs will continue to provide valuable earnings for forest owners, there is broad acceptance that the industry must be based on value-added products in future. So the industry is investigating various processing, infrastructure and investment strategies with a view to increasing the level of local manufacturing before export. The keys to future success will depend on a variety of factors better international marketing, product innovation, internationally competitive processing, improved infrastructure and a suitable political, regulatory and investment environment. The industry claims that, given the right conditions, by 2025 the forestry sector could be the country's biggest export earner, generating $20 billion a year and employing 60,000 people.</p>
    <p>One competitive advantage that New Zealand has is its ability to source large quantities of softwood from renewable forests. Consumers in several key wood markets are becoming more worried about sustainability, and the industry is supporting the development of national standards as well as the recognition of these internationally. However, New Zealand is not the only country with a plantation-style forestry industry; Chile, Brazil, Argentina, South Africa and Australia all have extensive plantings of fast-growing species (hardwood and softwood), and in the northern hemisphere, Scandinavian countries have all expanded their forests or controlled their use in the interests of future production.</p>
    <p>Finally, in addition to competition from other wood producers, New Zealand faces competition from goods such as wood substitutes. These include steel framing for houses. This further underlines the necessity for globally competitive production and marketing strategies.</p>
    <p><em>*pulp: wood which is crushed until soft enough to form the basis of paper</em></p>

    <p>&nbsp;</p>
    <p>&nbsp;</p>
    <p>&nbsp;</p>

  </section>
  <div id="divider" title="Drag to resize"></div>
  <section class="pane" id="right">
    <h3>Questions</h3>
    
    <div class="group">
      <h4>Questions 1‚Äì6</h4>
      <p>Do the following statements agree with the information given in Reading Passage 1? In boxes 1‚Äì6 on your answer sheet, write</p>
      <ul><li><strong>TRUE</strong>, <strong>FALSE</strong>, or <strong>NOT GIVEN</strong></li></ul>
      
      <div id="q1-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;"><p><strong>1.</strong> Settlers realised that wooden houses were more dangerous than other types of structure.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;"><label><input name="q1" type="radio" value="TRUE"> TRUE</label><label><input name="q1" type="radio" value="FALSE"> FALSE</label><label><input name="q1" type="radio" value="NOT GIVEN"> NOT GIVEN</label></div>
      </div>
      <div id="q2-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;"><p><strong>2.</strong> During the 1800s, New Zealand exported wood for use in boat-building.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;"><label><input name="q2" type="radio" value="TRUE"> TRUE</label><label><input name="q2" type="radio" value="FALSE"> FALSE</label><label><input name="q2" type="radio" value="NOT GIVEN"> NOT GIVEN</label></div>
      </div>
      <div id="q3-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;"><p><strong>3.</strong> Plantation-grown wood is generally better for construction than native forest wood.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;"><label><input name="q3" type="radio" value="TRUE"> TRUE</label><label><input name="q3" type="radio" value="FALSE"> FALSE</label><label><input name="q3" type="radio" value="NOT GIVEN"> NOT GIVEN</label></div>
      </div>
      <div id="q4-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;"><p><strong>4.</strong> Compared with other types of wood, pine has a narrow range of uses.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;"><label><input name="q4" type="radio" value="TRUE"> TRUE</label><label><input name="q4" type="radio" value="FALSE"> FALSE</label><label><input name="q4" type="radio" value="NOT GIVEN"> NOT GIVEN</label></div>
      </div>
      <div id="q5-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;"><p><strong>5.</strong> Demand for housing in New Zealand is predicted to fall in the next few years.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;"><label><input name="q5" type="radio" value="TRUE"> TRUE</label><label><input name="q5" type="radio" value="FALSE"> FALSE</label><label><input name="q5" type="radio" value="NOT GIVEN"> NOT GIVEN</label></div>
      </div>
      <div id="q6-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;"><p><strong>6.</strong> In future, the expansion of New Zealand's wood industry will depend on its exports.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;"><label><input name="q6" type="radio" value="TRUE"> TRUE</label><label><input name="q6" type="radio" value="FALSE"> FALSE</label><label><input name="q6" type="radio" value="NOT GIVEN"> NOT GIVEN</label></div>
      </div>
    </div>
    
    <div class="group">
      <h4>Questions 7‚Äì13</h4>
      <p>Answer the questions below. Choose <strong>NO MORE THAN TWO WORDS AND/OR A NUMBER</strong> from the passage for each answer.</p>
      
      <div id="q7-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;"><p><strong>7.</strong> Apart from exchange rates, which factor has had a negative impact on New Zealand's forestry exports?<input name="q7" type="text" class="blank"></p></div>
      <div id="q8-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;"><p><strong>8.</strong> Which part of New Zealand's economy does the forestry industry rank third in?<input name="q8" type="text" class="blank"></p></div>
      <div id="q9-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;"><p><strong>9.</strong> According to the New Zealand forestry industry, what could be the size of its workforce by 2025?<input name="q9" type="text" class="blank"></p></div>
      <div id="q10-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;"><p><strong>10.</strong> What kind of timber product is available in large amounts from renewable forests in New Zealand?<input name="q10" type="text" class="blank"></p></div>
      <div id="q11-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;"><p><strong>11.</strong> Which aspect of timber production are New Zealand's main customers increasingly concerned about?<input name="q11" type="text" class="blank"></p></div>
      <div id="q12-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;"><p><strong>12.</strong> Outside the Southern Hemisphere, who are New Zealand forestry's main competitors?<input name="q12" type="text" class="blank"></p></div>
      <div id="q13-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;"><p><strong>13.</strong> Which group of products is New Zealand's forestry industry now having to compete with?<input name="q13" type="text" class="blank"></p></div>
    </div>

    <div style="display:flex;gap:8px;margin-bottom:10px;">
      <button class="primary" onclick="grade()">Submit</button>
      <button onclick="resetForm()">Reset</button>
      <button onclick="toggleNotes()">Notes</button>
    </div>
    <div id="results"></div>
    <details class="answerbox" id="answerBox">
      <summary>Show answers (click to toggle) <span class="badge">hidden</span></summary>
      <div id="answerContent"></div>
    </details>
  </section>
</div>

<div aria-label="Selection tools" id="selbar" role="toolbar">
  <button id="btnHL">Highlight</button><button id="btnUH">Remove</button><button id="btnNote">Note</button>
</div>

<div id="notes">
  <header><strong>Notes</strong><div><button id="btnCopy">Copy</button><button id="btnClose">Close</button></div></header>
  <textarea id="noteArea" placeholder="Type your notes here..."></textarea>
</div>

<div id="toast"></div>

<script>
// UI functions: scrollToElement, showToast, Timer, toggleTheme, Divider, Highlighter, Notes
function scrollToElement(id) {
    const element = document.getElementById(id);
    if (element) {
        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
        const navItem = document.getElementById(id.replace('-anchor', '-nav'));
        if (navItem) {
            navItem.classList.add('active');
            setTimeout(() => navItem.classList.remove('active'), 1200);
        }
    }
}

function showToast(msg) {
    const toastEl = document.getElementById('toast');
    toastEl.textContent = msg;
    toastEl.style.display = 'block';
    setTimeout(() => { toastEl.style.display = 'none'; }, 1500);
}

let timerSeconds = 0, timerRunning = false, timerInterval;
const timerEl = document.getElementById('timer');
function updateTimerDisplay() {
    const minutes = Math.floor(timerSeconds / 60);
    const seconds = timerSeconds % 60;
    timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function startTimer() {
    if (!timerRunning) {
        timerRunning = true;
        timerEl.classList.remove('paused');
        timerInterval = setInterval(() => { timerSeconds++; updateTimerDisplay(); }, 1000);
    }
}

function stopTimer() {
    timerRunning = false;
    timerEl.classList.add('paused');
    clearInterval(timerInterval);
}

function toggleTimer() {
    if (timerRunning) { stopTimer(); showToast('Timer paused'); }
    else { startTimer(); showToast('Timer resumed'); }
}

function toggleTheme() {
    document.body.classList.toggle('dark');
    const isDark = document.body.classList.contains('dark');
    localStorage.setItem('darkMode', isDark);
    document.querySelector('.theme-toggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
}

const divider = document.getElementById('divider'), leftPane = document.getElementById('left');
let isDragging = false;
divider.addEventListener('mousedown', (e) => { isDragging = true; document.body.style.cursor = 'ew-resize'; e.preventDefault(); });
window.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    const shellRect = document.querySelector('.shell').getBoundingClientRect();
    let newLeftWidth = e.clientX - shellRect.left;
    if (newLeftWidth < 280) newLeftWidth = 280;
    if (newLeftWidth > shellRect.width - 320) newLeftWidth = shellRect.width - 320;
    leftPane.style.flexBasis = newLeftWidth + 'px';
});
window.addEventListener('mouseup', () => { isDragging = false; document.body.style.cursor = 'default'; });

const selbar = document.getElementById('selbar');
let lastRange = null;
function positionSelbar() {
    const selection = window.getSelection();
    if (!selection || selection.rangeCount === 0 || selection.isCollapsed) { selbar.style.display = 'none'; return; }
    const range = selection.getRangeAt(0);
    lastRange = range.cloneRange();
    const rect = range.getBoundingClientRect();
    selbar.style.display = 'flex';
    selbar.style.top = `${window.scrollY + rect.top - selbar.offsetHeight - 5}px`;
    selbar.style.left = `${window.scrollX + rect.left + rect.width / 2 - selbar.offsetWidth / 2}px`;
}
document.getElementById('left').addEventListener('mouseup', positionSelbar);
document.getElementById('btnHL').addEventListener('click', () => { if (lastRange) { const span = document.createElement('span'); span.className = 'hl'; try { lastRange.surroundContents(span); } catch (e) { span.appendChild(lastRange.extractContents()); lastRange.insertNode(span); } window.getSelection().removeAllRanges(); selbar.style.display = 'none'; } });
document.getElementById('btnUH').addEventListener('click', () => { if (lastRange) { const ancestor = lastRange.commonAncestorContainer; ancestor.querySelectorAll('.hl').forEach(hl => { if (lastRange.intersectsNode(hl)) { const parent = hl.parentNode; while (hl.firstChild) { parent.insertBefore(hl.firstChild, hl); } parent.removeChild(hl); parent.normalize(); } }); window.getSelection().removeAllRanges(); selbar.style.display = 'none'; } });

const notesPanel = document.getElementById('notes'), noteArea = document.getElementById('noteArea');
function toggleNotes() { notesPanel.style.display = (notesPanel.style.display === 'flex' ? 'none' : 'flex'); }
window.toggleNotes = toggleNotes;
document.getElementById('btnClose').addEventListener('click', toggleNotes);
document.getElementById('btnCopy').addEventListener('click', async () => { await navigator.clipboard.writeText(noteArea.value || ''); showToast('Copied'); });
document.getElementById('btnNote').addEventListener('click', () => { const selection = window.getSelection().toString().trim(); if (selection) { noteArea.value += (noteArea.value ? '\n\n' : '') + `> ${selection}`; toggleNotes(); window.getSelection().removeAllRanges(); selbar.style.display = 'none'; } });

// Core Logic: Grading, Resetting, Status Updates
const correctAnswers = {
    q1: "FALSE", q2: "TRUE", q3: "NOT GIVEN", q4: "FALSE", q5: "NOT GIVEN", q6: "TRUE",
    q7: "shipping costs", q8: "export sector", q9: "60,000", q10: "softwood",
    q11: "sustainability", q12: "scandinavian countries", q13: "wood substitutes"
};

function updateAnswerStatus() {
    for (let i = 1; i <= 13; i++) {
        const navItem = document.getElementById(`q${i}-nav`);
        if (navItem) {
            let answered = false;
            const radio = document.querySelector(`input[name="q${i}"]:checked`);
            const textInput = document.querySelector(`input[name="q${i}"].blank`);
            if (radio) {
                answered = true;
            } else if (textInput && textInput.value.trim() !== '') {
                answered = true;
            }
            navItem.classList.toggle('answered', answered);
        }
    }
}

function grade() {
    let total = 13, correct = 0, resultLines = [];
    
    // Grade Q1-6 (T/F/NG) and Q7-13 (Short Answer)
    for (let i = 1; i <= 13; i++) {
        const qName = `q${i}`;
        let userAnswer = '';
        const radio = document.querySelector(`input[name="${qName}"]:checked`);
        const textInput = document.querySelector(`input[name="${qName}"].blank`);

        if (radio) {
            userAnswer = radio.value;
        } else if (textInput) {
            userAnswer = textInput.value.trim().toLowerCase();
        }

        const isCorrect = userAnswer === correctAnswers[qName].toLowerCase();
        if (isCorrect) correct++;
        resultLines.push(`${i}. ${userAnswer || 'None'} ${isCorrect ? '‚úì' : '‚úó'}`);
    }

    const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;
    document.getElementById('results').innerHTML = `<p><strong>Score:</strong> ${correct}/${total} <span class="badge">Accuracy ${accuracy}%</span></p><pre>${resultLines.join('\n')}</pre>`;
    
    document.getElementById('answerContent').innerHTML = `
        <ol>
            ${Object.values(correctAnswers).map(answer => `<li>${answer}</li>`).join('')}
        </ol>
    `;
    document.querySelector('#answerBox .badge').textContent = 'tap to view';
    updateAnswerStatus();
}

function resetForm() {
    document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(input => input.checked = false);
    document.querySelectorAll('input.blank').forEach(input => input.value = '');
    document.getElementById('results').innerHTML = '';
    document.getElementById('answerContent').innerHTML = '';
    const answerBadge = document.querySelector('#answerBox .badge');
    if (answerBadge) answerBadge.textContent = 'hidden';
    if (document.getElementById('answerBox').hasAttribute('open')) {
        document.getElementById('answerBox').removeAttribute('open');
    }
    updateAnswerStatus();
    showToast('Form reset');
}

// Event Listeners and Initialization
document.addEventListener('DOMContentLoaded', () => {
    startTimer();
    updateAnswerStatus();
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark');
        document.querySelector('.theme-toggle').textContent = '‚òÄÔ∏è';
    }
    loadPracticePageEnhancer();
});
document.addEventListener('input', updateAnswerStatus);

// Practice Page Enhancer Script
function loadPracticePageEnhancer() {
    const script = document.createElement('script');
    script.src = '../../../js/practice-page-enhancer.js';
    script.onload = () => console.log('Practice page enhancer script loaded.');
    script.onerror = () => { console.error('Failed to load practice page enhancer script. Falling back to inline version.'); loadInlineEnhancer(); };
    document.head.appendChild(script);
}

function loadInlineEnhancer() {
    if (window.practicePageEnhancer) return;
    window.practicePageEnhancer = {
        initialize: function() { this.setupCommunication(); this.setupAnswerListeners(); this.interceptSubmit(); },
        setupCommunication: function() {
            this.parentWindow = window.opener || window.parent;
            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'INIT_SESSION') {
                    this.sessionId = event.data.data.sessionId;
                    this.sendMessage('SESSION_READY', { pageType: this.detectPageType(), url: window.location.href });
                }
            });
        },
        detectPageType: () => document.title.includes('P1') ? 'P1' : 'unknown',
        setupAnswerListeners: function() {
            this.answers = {};
            this.startTime = Date.now();
            document.addEventListener('input', (e) => {
                if (e.target.name && e.target.name.startsWith('q')) {
                    this.answers[e.target.name] = e.target.value;
                }
            });
        },
        interceptSubmit: function() { if (typeof window.grade === 'function') { const originalGrade = window.grade; window.grade = () => { originalGrade(); setTimeout(() => this.handleSubmit(), 200); }; } },
        handleSubmit: function() {
            const results = {
                sessionId: this.sessionId,
                startTime: this.startTime,
                endTime: Date.now(),
                duration: Math.round((Date.now() - this.startTime) / 1000),
                answers: this.answers,
                scoreInfo: this.extractScore(),
                pageType: this.detectPageType(),
                url: window.location.href
            };
            this.sendMessage('PRACTICE_COMPLETE', results);
        },
        extractScore: function() {
            const resultsEl = document.getElementById('results');
            if (!resultsEl) return null;
            const text = resultsEl.textContent || '';
            const scoreMatch = text.match(/Score:\s*(\d+)\/(\d+)/i);
            if (scoreMatch) {
                const correct = parseInt(scoreMatch[1], 10);
                const total = parseInt(scoreMatch[2], 10);
                return { correct, total, accuracy: total > 0 ? correct / total : 0, percentage: total > 0 ? Math.round((correct / total) * 100) : 0, source: 'inline_extraction' };
            }
            return null;
        },
        sendMessage: function(type, data) { if (this.parentWindow && this.parentWindow !== window) { this.parentWindow.postMessage({ type, data, source: 'practice_page' }, '*'); } }
    };
    window.practicePageEnhancer.initialize();
}
</script>

</body>
</html>