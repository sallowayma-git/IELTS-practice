<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>P1 – The Pearls (Fixed & Optimized)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root { 
    --line: #e5e7eb; 
    --bg: #f6f7fb; 
    --panel: #fff; 
    --accent: #3b82f6; 
    --muted: #6b7280; 
    --shadow: 0 6px 20px rgba(0,0,0,.12); 
  }
  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body { 
    margin: 0; 
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; 
    background: var(--bg); 
    padding-bottom: 82px; 
  }
  
  /* 布局样式 */
  .shell { display: flex; height: 100vh; width: 100%; }
  .pane { background: var(--panel); overflow: auto; padding: 20px; }
  #left { flex: 0 0 50%; min-width: 280px; }
  #right { flex: 1 1 auto; min-width: 320px; background: #fbfbff; border-left: 1px solid var(--line); }
  #divider { flex: 0 0 8px; background: linear-gradient(90deg, #e5e7eb, #d1d5db); cursor: ew-resize; position: relative; z-index: 5; user-select: none; }
  
  /* 文本样式 */
  h2, h3, h4 { margin: 0 0 10px; }
  #left p { margin: 0 0 12px; line-height: 1.6; word-break: normal; overflow-wrap: normal; hyphens: none; }
  
  /* 组件样式 */
  .group { background: #fff; border: 1px solid var(--line); border-radius: 10px; padding: 12px; margin-bottom: 14px; }
  
  /* 按钮样式 */
  button { 
    padding: 8px 12px; 
    border: 1px solid var(--line); 
    background: #fff; 
    border-radius: 6px; 
    cursor: pointer; 
    transition: all 0.2s; 
    font-size: 14px; 
  }
  button:hover { background: #f8fafc; border-color: #cbd5e1; }
  button.primary { 
    background: var(--accent); 
    color: #fff; 
    border-color: var(--accent); 
  }
  button.primary:hover { background: #2563eb; }
  
  /* 计时器样式 */
  #timer { 
    background: #fff; 
    color: var(--muted); 
    border: 1px solid var(--line); 
    border-radius: 6px; 
    padding: 6px 12px; 
    cursor: pointer; 
    font-family: 'Courier New', monospace; 
    transition: all 0.2s; 
    min-width: 70px;
    text-align: center;
    font-size: 18px;
    font-weight: bold;
  }
  #timer:hover { 
    background: #f1f5f9; 
    border-color: var(--accent); 
  }
  #timer.paused { 
    color: #ef4444; 
    border-color: #fecaca; 
    background: #fef2f2; 
  }
  
  /* 主题切换按钮 */
  .theme-toggle { 
    background: #fff; 
    color: var(--muted); 
    border: 1px solid var(--line); 
    border-radius: 6px; 
    width: 36px;
    height: 36px;
    font-size: 16px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .theme-toggle:hover {
    background: var(--accent);
    color: #fff;
    border-color: var(--accent);
    transform: scale(1.05);
  }
  
  /* 深色模式样式 */
  body.dark { 
    --bg: #0f172a; 
    --panel: #1e293b; 
    --line: #334155; 
    --muted: #94a3b8; 
    color: #e2e8f0; 
  }
  body.dark #right { background: #0f172a; }
  body.dark .group { background: #1e293b; border-color: #334155; }
  body.dark button { background: #1e293b; color: #e2e8f0; border-color: #334155; }
  body.dark button:hover { background: #334155; }
  body.dark button.primary { background: var(--accent); color: #fff; }
  body.dark #results { background: #1e293b; border-color: #334155; }
  body.dark #notes { background: #1e293b; border-color: #334155; color: #e2e8f0; }
  body.dark .practice-nav { background: #1e293b; border-color: #334155; }
  body.dark .q-item { background: #0f172a; color: #e2e8f0; border-color: #334155; }
  body.dark .q-item:hover { background: #334155; }
  body.dark .q-item.answered { background: #1e40af; border-color: var(--accent); color: #93c5fd; }
  body.dark #timer { background: #1e293b; color: #e2e8f0; border-color: #334155; }
  body.dark #timer:hover { background: #334155; border-color: var(--accent); }
  body.dark details.answerbox { background: #1e293b; border-color: #334155; }
  body.dark .card { background: #334155; border-color: #475569; }
  body.dark .cardpool { background: #0f172a; }
  body.dark .dropzone { border-color: #475569; background: #1e293b; }

  /* 响应式设计 */
  @media (max-width: 768px) {
    .shell { flex-direction: column; }
    #left, #right { flex: none; min-width: auto; }
    #divider { display: none; }
    .practice-nav .controls { gap: 8px; }
    #timer { font-size: 12px; padding: 3px 8px; }
    .theme-toggle { width: 32px; height: 32px; font-size: 14px; }
    #notes { width: calc(100vw - 24px); right: 12px; left: 12px; }
  }
  
  /* 选择工具栏 */
  #selbar { position: fixed; display: none; z-index: 2000; background: #111; color: #fff; border-radius: 8px; padding: 6px; box-shadow: var(--shadow); font-size: 13px; gap: 6px; align-items: center; }
  #selbar button { background: transparent; color: #fff; border: 1px solid rgba(255,255,255,.25); padding: 4px 8px; border-radius: 6px; cursor: pointer; }
  #selbar button:hover { border-color: #fff; }
  
  /* 笔记面板 */
  #notes { position: fixed; right: 12px; bottom: 12px; width: 320px; height: 42vh; background: #fff; border: 1px solid var(--line); border-radius: 12px; display: none; flex-direction: column; z-index: 1500; box-shadow: var(--shadow); }
  #notes header { display: flex; align-items: center; justify-content: space-between; padding: 8px 10px; border-bottom: 1px solid var(--line); }
  #notes textarea { flex: 1; border: 0; padding: 10px; resize: none; font-size: 14px; line-height: 1.5; }
  
  /* Toast通知 */
  #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: #fff; padding: 8px 16px; border-radius: 4px; display: none; z-index: 3000; font-size: 14px; }
  
  /* 答题导航 */
  .practice-nav { background: #fff; padding: 12px 20px; display: flex; align-items: center; gap: 16px; box-shadow: 0 2px 4px rgba(0,0,0,.05); flex-wrap: wrap; position: fixed; left: 0; right: 0; bottom: 0; border-top: 2px solid var(--line); z-index: 4000; }
  .practice-nav .title { font-weight: 600; color: var(--muted); }
  .practice-nav .questions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  .practice-nav .q-item { padding: 6px 10px; border: 1px solid var(--line); border-radius: 6px; background: #fff; cursor: pointer; font-size: 14px; transition: all 0.2s; min-width: 36px; text-align: center; }
  .practice-nav .q-item:hover { background: #f1f5f9; border-color: var(--accent); }
  .practice-nav .q-item.answered { background: #e0e7ff; border-color: var(--accent); color: var(--accent); font-weight: 500; }
  .practice-nav .q-item.active { background: var(--accent); color: #fff; }
  .practice-nav .controls { display: flex; gap: 12px; margin-left: auto; align-items: center; }
  
  /* 答题结果显示 */
  #results { background: #fff; border: 1px solid var(--line); border-radius: 10px; padding: 12px; margin: 16px 0; font-family: monospace; white-space: pre-wrap; }
  #results p { margin: 0 0 8px; }
  .badge { background: #e0e7ff; color: var(--accent); padding: 2px 8px; border-radius: 999px; font-size: 12px; }
  
  /* 答案框 */
  details.answerbox { background: #fff; border: 1px solid var(--line); border-radius: 10px; padding: 12px; margin-top: 10px; }
  details.answerbox summary { cursor: pointer; font-weight: 600; list-style: none; display: flex; align-items: center; justify-content: space-between; }
  details.answerbox summary::-webkit-details-marker { display: none; }
  #answerContent { margin-top: 10px; }
  #answerContent ol { margin: 0; padding-left: 20px; }
  #answerContent li { margin: 4px 0; }
  
  /* Drag and Drop 样式 */
  .dropzone { border: 2px dashed #cbd5e1; background: #f8fafc; border-radius: 10px; min-height: 42px; padding: 4px 8px; display: inline-flex; align-items: center; justify-content: center; gap: 8px; width: auto; min-width: 140px; vertical-align: middle; margin: 0 4px; }
  .droplabel { color: #64748b; font-size: 14px; }
  .cardpool { background: #f1f5f9; border-radius: 10px; padding: 12px; display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
  .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px 10px; display: inline-flex; align-items: center; cursor: grab; box-shadow: 0 2px 4px rgba(0,0,0,.05); user-select: none; }
  .card.dragging { opacity: 0.5; }
  .dropzone.over { outline: 2px solid var(--accent); background: #eff6ff; }
  
  /* 高亮样式 */
  .hl { background: #ffeb3b; color: #000; }
  body.dark .hl { background: #8a6d00; color: #fff; }
  
  /* 滚动条样式 */
  ::-webkit-scrollbar { width: 8px; height: 8px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #c5c5d2; border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: #999; }
  body.dark ::-webkit-scrollbar-thumb { background: #4a5568; }
  body.dark ::-webkit-scrollbar-thumb:hover { background: #718096; }
</style>
</head>
<body>

<div class="practice-nav">
  <div class="title">Questions</div>
  <div class="questions">
    <div class="q-item" id="q1-nav" onclick="scrollToElement('q1-anchor')">1</div>
    <div class="q-item" id="q2-nav" onclick="scrollToElement('q2-anchor')">2</div>
    <div class="q-item" id="q3-nav" onclick="scrollToElement('q3-anchor')">3</div>
    <div class="q-item" id="q4-nav" onclick="scrollToElement('q4-anchor')">4</div>
    <div class="q-item" id="q5-nav" onclick="scrollToElement('q5-anchor')">5</div>
    <div class="q-item" id="q6-nav" onclick="scrollToElement('q6-anchor')">6</div>
    <div class="q-item" id="q7-nav" onclick="scrollToElement('q7-anchor')">7</div>
    <div class="q-item" id="q8-nav" onclick="scrollToElement('q8-anchor')">8</div>
    <div class="q-item" id="q9-nav" onclick="scrollToElement('q9-anchor')">9</div>
    <div class="q-item" id="q10-nav" onclick="scrollToElement('q10-anchor')">10</div>
    <div class="q-item" id="q11-nav" onclick="scrollToElement('q11-anchor')">11</div>
    <div class="q-item" id="q12-nav" onclick="scrollToElement('q12-anchor')">12</div>
    <div class="q-item" id="q13-nav" onclick="scrollToElement('q13-anchor')">13</div>
  </div>
  <div class="controls">
    <span id="timer" onclick="toggleTimer()">00:00</span>
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode">🌙</button>
  </div>
</div>

<div class="shell">
  <section class="pane" id="left">
    <h2>READING PASSAGE 1</h2>
    <p>You should spend about 20 minutes on Questions 1–13, which are based on Reading Passage 1 below.</p>
    
    <h3>Pearls</h3>
    
    <p><strong>A</strong> Long known as the “Queen of Gems”, pearls possess a history and allure far beyond what today’s wearer may recognize. Throughout much of recorded history, a natural pearl necklace comprised of matched spheres was a treasure of almost incomparable value, in fact, the most expensive jewelry in the world. Before the creation of cultured pearls in the early 1900s, natural pearls were so rare and expensive that they were reserved almost exclusively for the noble and very rich. The ancient Egyptians were particularly fond of their pearls. Many Egyptian leaders treasured pearls so much that they were often buried along with their cherished pearl collection. In the Orient and Persian Empire, pearls were ground into costly powders to cure anything from heart disease to epilepsy, with possible aphrodisiac uses as well. China’s long recorded history also provides ample evidence of the importance of pearls.</p>
    <p><strong>B</strong> Pearls usually fall into three categories-natural pearls, cultured pearls and simulated pearls. A natural pearl forms when an irritant, such as a piece of sand, works its way into a particular species of oyster, mussel, or clam. As a defense mechanism, the mollusk secretes a fluid to coat the irritant. Layer upon layer of this coating is deposited on the irritant until a lustrous pearl is formed. A cultured pearl undergoes the same process. The only difference between natural pearls and cultured pearls is that the irritant is a surgically implanted bead or piece of shell called Mother of Pearl. Often, these shells are ground oyster shells that are worth significant amounts of money in their own right as irritant-catalysts for quality pearls. The resulting core is much larger than in a natural pearl. Imitation pearls are a different story altogether. In most cases, a glass bead is dipped into a solution made from fish scales. This coating is thin and may eventually wear off. One can usually tell an imitation by biting on it. The island of Mallorca in Spain is known for its imitation pearl industry.</p>
    <p><strong>C</strong> Regardless of the method used to acquire a pearl, the process usually takes several years. Mussels must reach a mature age, which can take up to 3 years, and then be implanted or naturally receive an irritant. Once the irritant is in place, it can take up to another 3 years for the pearl to reach its full size. Often, the irritant may be rejected, the pearl will be terrifically misshapen, or the oyster may simply die from disease or countless other complications. By the end of a 5 to 10 year cycle, only 50% of the oysters will have survived. And of the pearls produced, only approximately 5% are of a quality substantial enough for top jewelry makers.</p>
    <p><strong>D</strong> How can untrained eyes determine a pearl’s worth? Luster and size are generally considered the two main factors to look for. Luster, for instance, depends on the fineness and evenness of the layers. The deeper the glow, the more perfect the shape and surface, the more valuable they are. Size, on the other hand, has to do with the age of the oyster that created the pearl (the more mature oysters produce larger pearls) and the location in which the pearl was cultured. The South Sea waters of Australia tend to produce the larger pearls; probably because the water along the coastline is supplied with rich nutrients from the ocean floor. Also, the type of mussel being common to the area seems to possess a predilection for producing comparatively large pearls.</p>
    <p><strong>E</strong> In general, cultured pearls are less valuable than natural pearls, whereas imitation pearls have almost no value. One way that jewelers can determine whether a pearl is cultured or natural is to have a gem lab perform an X-ray of the pearl. If the X-ray reveals a nucleus, the pearl is likely a bead nucleated saltwater pearl. If no nucleus is present, but irregular and small dark inner spots indicating a cavity are visible, combined with concentric rings of organic substance, the pearl is likely a cultured freshwater pearl. Among cultured pearls, Akoya pearls from Japan are some of the most lustrous. Although imitation pearls look the part, they do not have the same weight or smoothness as real pearls, and their luster will also dim greatly.</p>
    <p><strong>F</strong> Historically, the world’s best pearls came from the Persian Gulf, especially around what is now Bahrain. The pearls of the Persian Gulf were naturally created and collected by breath-hold divers. Unfortunately, the natural pearl industry of the Persian Gulf ended abruptly in the early 1930s with the discovery of large deposits of oil. The water pollution resulting from spilled oil and indiscriminate overfishing of oysters essentially ruined the pristine waters of the Gulf that once produced pearls. Still, Bahrain remains one of the foremost trading centers for high quality pearls. In fact, cultured pearls are banned from the Bahrain pearl market, in an effort to preserve the location’s heritage. Nowadays, the largest stock of natural pearls probably resides in India. Ironically, much of India’s stock of natural pearls came originally from Bahrain. Unlike Bahrain, which has essentially lost its pearl resource, traditional pearl fishing is still practiced on a small scale in India.</p>
    <p><strong>G</strong> Pearls also come in many colours. The most popular colours are white, cream, and pink. Silver, black, and gold are also gaining interest. In fact, a deep lustrous black pearl is one of the rarest finds in the pearling industry, usually only being found in the South Sea near Australia. Thus, they can be one of the more costly items. Nowadays, pearls predominantly come from Japan, Australia, Indonesia, Myanmar, China, India, the Philippines, and Tahiti. Japan, however, controls roughly 80% of the world pearl market, with Australia and China coming in second and third, respectively.</p>

  </section>
  <div id="divider" title="Drag to resize"></div>
  <section class="pane" id="right">
    <h3>Questions</h3>
    
    <div class="group">
      <h4>Questions 1–4</h4>
      <p>Reading Passage 1 has seven paragraphs, A–G. Which paragraph contains the following information? Write the correct letter, A–G, in boxes 1–4 on your answer sheet.</p>
      
      <div id="q1-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;">
        <p><strong>1.</strong> difficulties in the cultivation process</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label><input name="q1" type="radio" value="A"> A</label> <label><input name="q1" type="radio" value="B"> B</label> <label><input name="q1" type="radio" value="C"> C</label> <label><input name="q1" type="radio" value="D"> D</label> <label><input name="q1" type="radio" value="E"> E</label> <label><input name="q1" type="radio" value="F"> F</label> <label><input name="q1" type="radio" value="G"> G</label>
        </div>
      </div>
      <div id="q2-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;">
        <p><strong>2.</strong> causes affecting the size of natural pearls</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label><input name="q2" type="radio" value="A"> A</label> <label><input name="q2" type="radio" value="B"> B</label> <label><input name="q2" type="radio" value="C"> C</label> <label><input name="q2" type="radio" value="D"> D</label> <label><input name="q2" type="radio" value="E"> E</label> <label><input name="q2" type="radio" value="F"> F</label> <label><input name="q2" type="radio" value="G"> G</label>
        </div>
      </div>
      <div id="q3-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;">
        <p><strong>3.</strong> ancient customs around pearls</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label><input name="q3" type="radio" value="A"> A</label> <label><input name="q3" type="radio" value="B"> B</label> <label><input name="q3" type="radio" value="C"> C</label> <label><input name="q3" type="radio" value="D"> D</label> <label><input name="q3" type="radio" value="E"> E</label> <label><input name="q3" type="radio" value="F"> F</label> <label><input name="q3" type="radio" value="G"> G</label>
        </div>
      </div>
      <div id="q4-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;">
        <p><strong>4.</strong> distinctions between cultured pearls and natural ones</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label><input name="q4" type="radio" value="A"> A</label> <label><input name="q4" type="radio" value="B"> B</label> <label><input name="q4" type="radio" value="C"> C</label> <label><input name="q4" type="radio" value="D"> D</label> <label><input name="q4" type="radio" value="E"> E</label> <label><input name="q4" type="radio" value="F"> F</label> <label><input name="q4" type="radio" value="G"> G</label>
        </div>
      </div>
    </div>
    
    <div class="group">
      <h4>Questions 5–10</h4>
      <p>Complete the summary using the list of words, A–K, below. Write the correct letter, A–K, in boxes 5–10 on your answer sheet.</p>
      
      <p>Throughout history, people in <span id="q5-anchor"></span><span class="dropzone" data-question="q5"><span class="droplabel">Answer 5</span></span> used pearls for medicine and philtres. There are essentially three types of pearls: natural, cultured and imitation. Natural and cultured pearls share a similar growing process, while imitation pearls are different. And <span id="q6-anchor"></span><span class="dropzone" data-question="q6"><span class="droplabel">Answer 6</span></span> owns the reputation for its imitation pearl industry. The country <span id="q7-anchor"></span><span class="dropzone" data-question="q7"><span class="droplabel">Answer 7</span></span> usually produces the larger pearls due to the favourable environment along the coastline, while the nation of <span id="q8-anchor"></span><span class="dropzone" data-question="q8"><span class="droplabel">Answer 8</span></span> manufactures some of the most glistening cultured pearls. In the past, the country <span id="q9-anchor"></span><span class="dropzone" data-question="q9"><span class="droplabel">Answer 9</span></span> in the Persian Gulf produced the world’s best pearls. At present, the major remaining suppliers of natural pearls are in <span id="q10-anchor"></span><span class="dropzone" data-question="q10"><span class="droplabel">Answer 10</span></span>.</p>
      
      <div class="cardpool">
        <div class="card" draggable="true" data-value="A">A America</div> <div class="card" draggable="true" data-value="B">B Philippines</div> <div class="card" draggable="true" data-value="C">C Australia</div> <div class="card" draggable="true" data-value="D">D Bahrain</div> <div class="card" draggable="true" data-value="E">E China</div> <div class="card" draggable="true" data-value="F">F Japan</div> <div class="card" draggable="true" data-value="G">G India</div> <div class="card" draggable="true" data-value="H">H Egypt</div> <div class="card" draggable="true" data-value="I">I Myanmar</div> <div class="card" draggable="true" data-value="J">J Persia</div> <div class="card" draggable="true" data-value="K">K Mallorca</div>
      </div>
    </div>
    
    <div class="group">
      <h4>Questions 11–13</h4>
      <p>Do the following statements agree with the information given in Reading Passage 1? In boxes 11–13 on your answer sheet, write</p>
      <ul><li><strong>TRUE</strong> if the statement agrees with the information</li><li><strong>FALSE</strong> if the statement contradicts the information</li><li><strong>NOT GIVEN</strong> if there is no information on this</li></ul>
      
      <div id="q11-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;">
        <p><strong>11.</strong> A cultured pearl’s centre is often significantly larger than that in a natural pearl.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label><input name="q11" type="radio" value="TRUE"> TRUE</label> <label><input name="q11" type="radio" value="FALSE"> FALSE</label> <label><input name="q11" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      <div id="q12-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;">
        <p><strong>12.</strong> Imitation pearls are usually the same price as natural ones.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label><input name="q12" type="radio" value="TRUE"> TRUE</label> <label><input name="q12" type="radio" value="FALSE"> FALSE</label> <label><input name="q12" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      <div id="q13-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;">
        <p><strong>13.</strong> Akoya pearls from Japan glow more deeply than South Sea pearls from Australia.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label><input name="q13" type="radio" value="TRUE"> TRUE</label> <label><input name="q13" type="radio" value="FALSE"> FALSE</label> <label><input name="q13" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
    </div>

    <div style="display:flex;gap:8px;margin-bottom:10px;">
      <button class="primary" onclick="grade()">Submit</button>
      <button onclick="resetForm()">Reset</button>
      <button onclick="toggleNotes()">Notes</button>
    </div>
    <div id="results"></div>
    <details class="answerbox" id="answerBox">
      <summary>Show answers (click to toggle) <span class="badge">hidden</span></summary>
      <div id="answerContent"></div>
    </details>
  </section>
</div>

<div aria-label="Selection tools" id="selbar" role="toolbar">
  <button id="btnHL">Highlight</button>
  <button id="btnUH">Remove</button>
  <button id="btnNote">Note</button>
</div>

<div id="notes">
  <header>
    <strong>Notes</strong>
    <div>
      <button id="btnCopy">Copy</button>
      <button id="btnClose">Close</button>
    </div>
  </header>
  <textarea id="noteArea" placeholder="Type your notes here..."></textarea>
</div>

<div id="toast"></div>

<script>
// 页面滚动功能
function scrollToElement(id) {
  const element = document.getElementById(id);
  if (element) {
    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
    const navItem = document.getElementById(id.replace('-anchor', '-nav'));
    if(navItem) {
      navItem.classList.add('active');
      setTimeout(() => navItem.classList.remove('active'), 1200);
    }
  }
}

// Toast通知功能
function showToast(msg) {
  const toastEl = document.getElementById('toast');
  toastEl.textContent = msg;
  toastEl.style.display = 'block';
  setTimeout(() => { toastEl.style.display = 'none'; }, 1500);
}

// 计时器功能
let timerSeconds = 0;
let timerRunning = false;
let timerInterval;
const timerEl = document.getElementById('timer');

function updateTimerDisplay() {
  const minutes = Math.floor(timerSeconds / 60);
  const seconds = timerSeconds % 60;
  timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function startTimer() {
    if (timerRunning) return;
    timerRunning = true;
    timerEl.classList.remove('paused');
    timerInterval = setInterval(() => {
        timerSeconds++;
        updateTimerDisplay();
    }, 1000);
}

function stopTimer() {
    timerRunning = false;
    timerEl.classList.add('paused');
    clearInterval(timerInterval);
}

function toggleTimer() {
  if (timerRunning) {
    stopTimer();
    showToast('Timer paused');
  } else {
    startTimer();
    showToast('Timer resumed');
  }
}

// 主题切换功能
function toggleTheme() {
  document.body.classList.toggle('dark');
  const isDark = document.body.classList.contains('dark');
  localStorage.setItem('darkMode', isDark);
  document.querySelector('.theme-toggle').textContent = isDark ? '☀️' : '🌙';
}

// 拖拽分栏功能
const divider = document.getElementById('divider');
const leftPane = document.getElementById('left');
let isDragging = false;
divider.addEventListener('mousedown', (e) => { isDragging = true; document.body.style.cursor = 'ew-resize'; e.preventDefault(); });
window.addEventListener('mousemove', (e) => {
  if (!isDragging) return;
  const shellRect = document.querySelector('.shell').getBoundingClientRect();
  let newLeftWidth = e.clientX - shellRect.left;
  if (newLeftWidth < 280) newLeftWidth = 280;
  if (newLeftWidth > shellRect.width - 320) newLeftWidth = shellRect.width - 320;
  leftPane.style.flexBasis = newLeftWidth + 'px';
});
window.addEventListener('mouseup', () => { isDragging = false; document.body.style.cursor = 'default'; });

// 高亮和笔记功能
const selbar = document.getElementById('selbar');
let lastRange = null;
function positionSelbar() {
    const selection = window.getSelection();
    if (!selection || selection.rangeCount === 0 || selection.isCollapsed) { selbar.style.display = 'none'; return; }
    const range = selection.getRangeAt(0);
    lastRange = range.cloneRange();
    const rect = range.getBoundingClientRect();
    selbar.style.display = 'flex';
    selbar.style.top = `${window.scrollY + rect.top - selbar.offsetHeight - 5}px`;
    selbar.style.left = `${window.scrollX + rect.left + rect.width / 2 - selbar.offsetWidth / 2}px`;
}
document.getElementById('left').addEventListener('mouseup', positionSelbar);
document.getElementById('btnHL').addEventListener('click', () => {
    if (lastRange) {
        const span = document.createElement('span');
        span.className = 'hl';
        try { lastRange.surroundContents(span); } catch (e) { span.appendChild(lastRange.extractContents()); lastRange.insertNode(span); }
        window.getSelection().removeAllRanges();
        selbar.style.display = 'none';
    }
});
document.getElementById('btnUH').addEventListener('click', () => {
    if (lastRange) {
        const ancestor = lastRange.commonAncestorContainer;
        ancestor.querySelectorAll('.hl').forEach(hl => {
            if (lastRange.intersectsNode(hl)) {
                const parent = hl.parentNode;
                while (hl.firstChild) { parent.insertBefore(hl.firstChild, hl); }
                parent.removeChild(hl);
                parent.normalize();
            }
        });
        window.getSelection().removeAllRanges();
        selbar.style.display = 'none';
    }
});
const notesPanel = document.getElementById('notes');
const noteArea = document.getElementById('noteArea');
function toggleNotes() { notesPanel.style.display = (notesPanel.style.display === 'flex' ? 'none' : 'flex'); }
window.toggleNotes = toggleNotes;
document.getElementById('btnClose').addEventListener('click', toggleNotes);
document.getElementById('btnCopy').addEventListener('click', async () => { await navigator.clipboard.writeText(noteArea.value || ''); showToast('Copied'); });
document.getElementById('btnNote').addEventListener('click', () => {
  const selection = window.getSelection().toString().trim();
  if (selection) {
    noteArea.value += (noteArea.value ? '\n\n' : '') + `> ${selection}`;
    toggleNotes();
    window.getSelection().removeAllRanges();
    selbar.style.display = 'none';
  }
});

// Drag and Drop Logic
const cards = document.querySelectorAll('.card');
const dropzones = document.querySelectorAll('.dropzone');
const cardpool = document.querySelector('.cardpool');
let draggedCard = null;

cards.forEach(card => {
    card.addEventListener('dragstart', (e) => {
        draggedCard = e.target;
        setTimeout(() => e.target.classList.add('dragging'), 0);
    });
    card.addEventListener('dragend', (e) => {
        e.target.classList.remove('dragging');
    });
});

dropzones.forEach(zone => {
    zone.addEventListener('dragover', e => {
        e.preventDefault();
        zone.classList.add('over');
    });
    zone.addEventListener('dragleave', () => {
        zone.classList.remove('over');
    });
    zone.addEventListener('drop', e => {
        e.preventDefault();
        zone.classList.remove('over');
        if (draggedCard) {
            // If the zone already has a card, move it back to the pool
            if (zone.children.length > 1) { // more than just the label
                cardpool.appendChild(zone.querySelector('.card'));
            }
            zone.innerHTML = ''; // Clear the placeholder label
            zone.appendChild(draggedCard);
            updateAnswerStatus();
        }
    });
});

// Allow dropping back into the pool
cardpool.addEventListener('dragover', e => e.preventDefault());
cardpool.addEventListener('drop', e => {
    if (draggedCard) {
        cardpool.appendChild(draggedCard);
    }
});

// 答题状态更新
function updateAnswerStatus() {
  for (let i = 1; i <= 13; i++) {
    const navItem = document.getElementById(`q${i}-nav`);
    if (!navItem) continue;
    
    let answered = false;
    if (i >= 5 && i <= 10) { // Drag and Drop questions
        const zone = document.querySelector(`.dropzone[data-question="q${i}"]`);
        if (zone && zone.querySelector('.card')) {
            answered = true;
        }
    } else { // Radio button questions
        const radio = document.querySelector(`input[name="q${i}"]:checked`);
        if (radio) {
            answered = true;
        }
    }
    navItem.classList.toggle('answered', answered);
  }
}

// 答案和评分系统
const correctAnswers = {
  "q1":"C", "q2":"D", "q3":"A", "q4":"B",
  "q5":"J", "q6":"K", "q7":"C", "q8":"F", "q9":"D", "q10":"G",
  "q11":"TRUE", "q12":"FALSE", "q13":"NOT GIVEN"
};

function grade() {
  let total = 0, correct = 0, resultLines = [];
  
  // Grade Q1-4 and Q11-13 (Radio)
  for (let i = 1; i <= 13; i++) {
    if (i >= 5 && i <= 10) continue; // Skip drag-drop for now
    total++;
    const qName = `q${i}`;
    const radio = document.querySelector(`input[name="${qName}"]:checked`);
    const userAnswer = radio ? radio.value : '';
    const isCorrect = userAnswer === correctAnswers[qName];
    if (isCorrect) correct++;
    resultLines.push(`${qName.toUpperCase()}: ${userAnswer || 'None'} ${isCorrect ? '✓' : '✗'}`);
  }

  // Grade Q5-10 (Drag & Drop)
  for (let i = 5; i <= 10; i++) {
    total++;
    const qName = `q${i}`;
    const zone = document.querySelector(`.dropzone[data-question="${qName}"]`);
    const card = zone ? zone.querySelector('.card') : null;
    const userAnswer = card ? card.dataset.value : '';
    const isCorrect = userAnswer === correctAnswers[qName];
    if (isCorrect) correct++;
    resultLines.push(`${qName.toUpperCase()}: ${userAnswer || 'None'} ${isCorrect ? '✓' : '✗'}`);
  }
  
  resultLines.sort((a, b) => parseInt(a.match(/\d+/)[0]) - parseInt(b.match(/\d+/)[0]));

  const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;
  document.getElementById('results').innerHTML = `<p><strong>Score:</strong> ${correct}/${total} <span class="badge">Accuracy ${accuracy}%</span></p><pre>${resultLines.join('\n')}</pre>`;
  
  document.getElementById('answerContent').innerHTML = `
    <ol style="list-style-type: none; padding-left: 0;">
      <li><strong>1.</strong> C</li>
      <li><strong>2.</strong> D</li>
      <li><strong>3.</strong> A</li>
      <li><strong>4.</strong> B</li>
      <li><strong>5.</strong> J (Persia)</li>
      <li><strong>6.</strong> K (Mallorca)</li>
      <li><strong>7.</strong> C (Australia)</li>
      <li><strong>8.</strong> F (Japan)</li>
      <li><strong>9.</strong> D (Bahrain)</li>
      <li><strong>10.</strong> G (India)</li>
      <li><strong>11.</strong> TRUE</li>
      <li><strong>12.</strong> FALSE</li>
      <li><strong>13.</strong> NOT GIVEN</li>
    </ol>
  `;
  document.querySelector('#answerBox .badge').textContent = 'tap to view';
  updateAnswerStatus();
}

// 重置表单
function resetForm() {
  // Reset radios
  document.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);
  // Reset drag-drop
  dropzones.forEach(zone => {
      const card = zone.querySelector('.card');
      if (card) {
          cardpool.appendChild(card);
      }
      const qNum = zone.dataset.question.replace('q', '');
      zone.innerHTML = `<span class="droplabel">Answer ${qNum}</span>`;
  });
  // Clear results
  document.getElementById('results').innerHTML = '';
  document.getElementById('answerContent').innerHTML = '';
  const answerBadge = document.querySelector('#answerBox .badge');
  if (answerBadge) answerBadge.textContent = 'hidden';
  if (document.getElementById('answerBox').hasAttribute('open')) {
      document.getElementById('answerBox').removeAttribute('open');
  }
  updateAnswerStatus();
  showToast('Form reset');
}

// 页面加载和事件监听
document.addEventListener('DOMContentLoaded', () => {
  startTimer();
  updateAnswerStatus();
  if (localStorage.getItem('darkMode') === 'true') {
    document.body.classList.add('dark');
    document.querySelector('.theme-toggle').textContent = '☀️';
  }
  loadPracticePageEnhancer();
});

document.addEventListener('change', updateAnswerStatus);
document.addEventListener('drop', updateAnswerStatus); // For drag-drop

// ##################################################################
// #               跨窗口数据传输功能 (增强脚本)                      #
// ##################################################################
function loadPracticePageEnhancer() {
  const script = document.createElement('script');
  script.src = '../../../js/practice-page-enhancer.js';
  script.onload = () => console.log('练习页面增强脚本已加载');
  script.onerror = () => { console.error('练习页面增强脚本加载失败，降级到内联版本。'); loadInlineEnhancer(); };
  document.head.appendChild(script);
}

function loadInlineEnhancer() {
  if (window.practicePageEnhancer) return;
  window.practicePageEnhancer = {
    initialize: function() {
      console.log('[InlineEnhancer] 内联增强器已初始化');
      this.setupCommunication();
      this.setupAnswerListeners();
      this.interceptSubmit();
    },
    setupCommunication: function() {
      this.parentWindow = window.opener || window.parent;
      window.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'INIT_SESSION') {
          this.sessionId = event.data.data.sessionId;
          this.sendMessage('SESSION_READY', { pageType: this.detectPageType(), url: window.location.href });
        }
      });
    },
    detectPageType: function() {
      return document.title.includes('P1') ? 'P1' : 'unknown';
    },
    setupAnswerListeners: function() {
      this.answers = {};
      this.startTime = Date.now();
      document.addEventListener('change', (e) => {
        if (e.target.name && e.target.name.startsWith('q')) this.answers[e.target.name] = e.target.value;
      });
      // Listener for drop events
      document.querySelectorAll('.dropzone').forEach(zone => {
          zone.addEventListener('drop', (e) => {
              const qName = zone.dataset.question;
              const card = document.querySelector('.dragging');
              if (qName && card) {
                  this.answers[qName] = card.dataset.value;
              }
          });
      });
    },
    interceptSubmit: function() {
      if (typeof window.grade === 'function') {
        const originalGrade = window.grade;
        window.grade = () => { originalGrade(); setTimeout(() => this.handleSubmit(), 200); };
      }
    },
    handleSubmit: function() {
      const results = {
        sessionId: this.sessionId,
        startTime: this.startTime,
        endTime: Date.now(),
        duration: Math.round((Date.now() - this.startTime) / 1000),
        answers: this.answers,
        scoreInfo: this.extractScore(),
        pageType: this.detectPageType(),
        url: window.location.href
      };
      this.sendMessage('PRACTICE_COMPLETE', results);
    },
    extractScore: function() {
      const resultsEl = document.getElementById('results');
      if (!resultsEl) return null;
      const text = resultsEl.textContent || '';
      const scoreMatch = text.match(/Score:\s*(\d+)\/(\d+)/i);
      if (scoreMatch) {
        const correct = parseInt(scoreMatch[1], 10);
        const total = parseInt(scoreMatch[2], 10);
        return { correct, total, accuracy: total > 0 ? correct / total : 0, percentage: total > 0 ? Math.round((correct / total) * 100) : 0, source: 'inline_extraction' };
      }
      return null;
    },
    sendMessage: function(type, data) {
      if (this.parentWindow && this.parentWindow !== window) {
        this.parentWindow.postMessage({ type, data, source: 'practice_page' }, '*');
      }
    }
  };
  window.practicePageEnhancer.initialize();
}
</script>

</body>
</html>