<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>The Pearls</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<style>
  :root { --line:#e5e7eb; --bg:#f6f7fb; --panel:#fff; --accent:#3b82f6; --muted:#6b7280; --shadow:0 6px 20px rgba(0,0,0,.12); }
  * { box-sizing: border-box; }
  html,body { height:100%; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); }
  #timer { position: static; display: inline-block; margin-left: 8px; background:#fff; border:1px solid var(--line); border-radius:10px; padding:2px 8px; font-size:14px; vertical-align: middle; }
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:var(--panel); overflow:auto; padding:20px; }
  #left { flex: 0 0 50%; min-width: 280px; }
  #right { flex: 1 1 auto; min-width: 320px; background:#fbfbff; border-left:1px solid var(--line); }
  #divider { flex: 0 0 8px; background: linear-gradient(90deg,#e5e7eb,#d1d5db); cursor: ew-resize; position:relative; z-index: 5; user-select:none; }
  h2,h3,h4 { margin:0 0 10px; }
  #left p { margin: 0 0 12px; line-height: 1.6; word-break: normal; overflow-wrap: normal; hyphens: none; }
  .group { background:#fff; border:1px solid var(--line); border-radius:10px; padding:12px; margin-bottom:14px; }
  table { border-collapse: collapse; width:100%; }
  th, td { border:1px solid var(--line); padding:6px; text-align:center; font-size:14px; }
  th:first-child, td:first-child { width:92px; }
  button { padding:8px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; cursor:pointer; }
  button.primary { background:var(--accent); color:#fff; border-color:#3b82f6; }
  #results { background:#fff; border:1px solid var(--line); border-radius:10px; padding:10px; }
  .hl { background:#fff3a3; box-shadow: inset 0 -2px 0 rgba(0,0,0,.05); cursor: pointer; }
  .hl:hover { filter: brightness(0.98); }
  #selbar { position: absolute; display:none; z-index: 2000; background:#111; color:#fff; border-radius: 8px; padding: 6px; box-shadow: var(--shadow); font-size: 13px; gap:6px; align-items: center; }
  #selbar button { background: transparent; color:#fff; border: 1px solid rgba(255,255,255,.25); padding: 4px 8px; border-radius: 6px; cursor:pointer; }
  #selbar button:hover { border-color:#fff; }
  #notes { position: fixed; right: 12px; bottom: 12px; width: 320px; height: 42vh; background:#fff; border:1px solid var(--line); border-radius: 12px; display:none; flex-direction: column; z-index:1500; box-shadow: var(--shadow); }
  #notes header { display:flex; align-items:center; justify-content: space-between; padding:8px 10px; border-bottom:1px solid var(--line); }
  #notes textarea { flex:1; border:0; padding:10px; resize:none; font-size:14px; line-height:1.5; }
  #toast { position: fixed; left:50%; transform: translateX(-50%); bottom: 24px; background:#111; color:#fff; padding:8px 12px; border-radius: 8px; display:none; z-index:2500; }
  .dropzone { border:2px dashed #cbd5e1; background:#f8fafc; border-radius:10px; min-height:40px; padding:4px 8px; display:inline-flex; align-items:center; justify-content:space-between; gap:8px; width: auto; min-width: 120px; max-width: 200px; vertical-align: middle; }
  .droplabel { color:#64748b; font-size:14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .cardpool { background:#f1f5f9; border-radius:10px; padding:12px; display:flex; flex-wrap:wrap; gap:8px; }
  .pool-slot { min-height:40px; }
  .card { background:#fff; border:1px solid #e5e7eb; border-radius:8px; padding:8px 10px; display:inline-flex; gap:8px; align-items:center; cursor:grab; box-shadow:0 1px 0 rgba(0,0,0,.03); white-space: nowrap; }
  .card:active { cursor:grabbing; }
  .tag { background:#eef2ff; color:#4338ca; padding:2px 8px; border-radius:999px; font-size:12px; }
  .btn-clear { border:1px solid #e5e7eb; background:#fff; border-radius:8px; padding:6px 8px; cursor:pointer; }
  .ghost { opacity: .5; }
  .over { outline:2px dashed #3b82f6; }
  details.answerbox summary { cursor: pointer; user-select:none; list-style: none; }
  details.answerbox { border:1px dashed var(--line); border-radius:10px; padding:8px 10px; background:#fff; }
  .badge { display:inline-block; background:#eef2ff; color:#4338ca; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:6px; }
  body { padding-bottom: 82px; }
  .practice-nav { background:#fff; border-bottom:2px solid var(--line); padding:12px 20px; display:flex; align-items:center; gap:20px; box-shadow:0 2px 4px rgba(0,0,0,.05); flex-wrap:wrap; position:fixed; left:0; right:0; bottom:0; border-top:2px solid var(--line); border-bottom:0; z-index:4000; }
  .practice-nav .title { font-weight:600; color:var(--muted); }
  .practice-nav .questions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .practice-nav .q-item { padding:6px 10px; border:1px solid var(--line); border-radius:6px; background:#fff; cursor:pointer; font-size:14px; transition:all 0.2s; min-width:36px; text-align:center; }
  .practice-nav .q-item:hover { background:#f1f5f9; border-color:var(--accent); }
  .practice-nav .q-item.answered { background:#e0e7ff; border-color:var(--accent); color:var(--accent); font-weight:500; }
  .practice-nav .q-item.active { background:var(--accent); color:#fff; border-color:var(--accent); }
  #selbar { z-index: 6000 !important; }
</style>
</head>
<body>
<div class="practice-nav">
  <div class="title">Questions</div>
  <div class="questions">
    <div class="q-item" id="q1-nav" onclick="scrollToElement('q1-anchor')">1</div>
    <div class="q-item" id="q2-nav" onclick="scrollToElement('q2-anchor')">2</div>
    <div class="q-item" id="q3-nav" onclick="scrollToElement('q3-anchor')">3</div>
    <div class="q-item" id="q4-nav" onclick="scrollToElement('q4-anchor')">4</div>
    <div class="q-item" id="q5-nav" onclick="scrollToElement('q5-anchor')">5</div>
    <div class="q-item" id="q6-nav" onclick="scrollToElement('q6-anchor')">6</div>
    <div class="q-item" id="q7-nav" onclick="scrollToElement('q7-anchor')">7</div>
    <div class="q-item" id="q8-nav" onclick="scrollToElement('q8-anchor')">8</div>
    <div class="q-item" id="q9-nav" onclick="scrollToElement('q9-anchor')">9</div>
    <div class="q-item" id="q10-nav" onclick="scrollToElement('q10-anchor')">10</div>
    <div class="q-item" id="q11-nav" onclick="scrollToElement('q11-anchor')">11</div>
    <div class="q-item" id="q12-nav" onclick="scrollToElement('q12-anchor')">12</div>
    <div class="q-item" id="q13-nav" onclick="scrollToElement('q13-anchor')">13</div>
  </div>
</div>
<div class="shell">
  <section class="pane" id="left">
    <h2>READING PASSAGE 1 <span id="timer">00:00</span></h2>
    <p>You should spend about 20 minutes on Questions 1–13, which are based on Reading Passage 1 below.</p>
    <h3>Pearls</h3>
    
    <p><strong>A</strong> Long known as the “Queen of Gems”, pearls possess a history and allure far beyond what today’s wearer may recognize. Throughout much of recorded history, a natural pearl necklace comprised of matched spheres was a treasure of almost incomparable value, in fact, the most expensive jewelry in the world. Before the creation of cultured pearls in the early 1900s, natural pearls were so rare and expensive that they were reserved almost exclusively for the noble and very rich. The ancient Egyptians were particularly fond of their pearls. Many Egyptian leaders treasured pearls so much that they were often buried along with their cherished pearl collection. In the Orient and Persian Empire, pearls were ground into costly powders to cure anything from heart disease to epilepsy, with possible aphrodisiac uses as well. China’s long recorded history also provides ample evidence of the importance of pearls.</p>
    
    <p><strong>B</strong> Pearls usually fall into three categories-natural pearls, cultured pearls and simulated pearls. A natural pearl forms when an irritant, such as a piece of sand, works its way into a particular species of oyster, mussel, or clam. As a defense mechanism, the mollusk secretes a fluid to coat the irritant. Layer upon layer of this coating is deposited on the irritant until a lustrous pearl is formed. A cultured pearl undergoes the same process. The only difference between natural pearls and cultured pearls is that the irritant is a surgically implanted bead or piece of shell called Mother of Pearl. Often, these shells are ground oyster shells that are worth significant amounts of money in their own right as irritant-catalysts for quality pearls. The resulting core is much larger than in a natural pearl. Imitation pearls are a different story altogether. In most cases, a glass bead is dipped into a solution made from fish scales. This coating is thin and may eventually wear off. One can usually tell an imitation by biting on it. The island of Mallorca in Spain is known for its imitation pearl industry.</p>
    
    <p><strong>C</strong> Regardless of the method used to acquire a pearl, the process usually takes several years. Mussels must reach a mature age, which can take up to 3 years, and then be implanted or naturally receive an irritant. Once the irritant is in place, it can take up to another 3 years for the pearl to reach its full size. Often, the irritant may be rejected, the pearl will be terrifically misshapen, or the oyster may simply die from disease or countless other complications. By the end of a 5 to 10 year cycle, only 50% of the oysters will have survived. And of the pearls produced, only approximately 5% are of a quality substantial enough for top jewelry makers.</p>
    
    <p><strong>D</strong> How can untrained eyes determine a pearl’s worth? Luster and size are generally considered the two main factors to look for. Luster, for instance, depends on the fineness and evenness of the layers. The deeper the glow, the more perfect the shape and surface, the more valuable they are. Size, on the other hand, has to do with the age of the oyster that created the pearl (the more mature oysters produce larger pearls) and the location in which the pearl was cultured. The South Sea waters of Australia tend to produce the larger pearls; probably because the water along the coastline is supplied with rich nutrients from the ocean floor. Also, the type of mussel being common to the area seems to possess a predilection for producing comparatively large pearls.</p>
    
    <p><strong>E</strong> In general, cultured pearls are less valuable than natural pearls, whereas imitation pearls have almost no value. One way that jewelers can determine whether a pearl is cultured or natural is to have a gem lab perform an X-ray of the pearl. If the X-ray reveals a nucleus, the pearl is likely a bead nucleated saltwater pearl. If no nucleus is present, but irregular and small dark inner spots indicating a cavity are visible, combined with concentric rings of organic substance, the pearl is likely a cultured freshwater pearl. Among cultured pearls, Akoya pearls from Japan are some of the most lustrous. Although imitation pearls look the part, they do not have the same weight or smoothness as real pearls, and their luster will also dim greatly.</p>
    
    <p><strong>F</strong> Historically, the world’s best pearls came from the Persian Gulf, especially around what is now Bahrain. The pearls of the Persian Gulf were naturally created and collected by breath-hold divers. Unfortunately, the natural pearl industry of the Persian Gulf ended abruptly in the early 1930s with the discovery of large deposits of oil. The water pollution resulting from spilled oil and indiscriminate overfishing of oysters essentially ruined the pristine waters of the Gulf that once produced pearls. Still, Bahrain remains one of the foremost trading centers for high quality pearls. In fact, cultured pearls are banned from the Bahrain pearl market, in an effort to preserve the location’s heritage. Nowadays, the largest stock of natural pearls probably resides in India. Ironically, much of India’s stock of natural pearls came originally from Bahrain. Unlike Bahrain, which has essentially lost its pearl resource, traditional pearl fishing is still practiced on a small scale in India.</p>
    
    <p><strong>G</strong> Pearls also come in many colours. The most popular colours are white, cream, and pink. Silver, black, and gold are also gaining interest. In fact, a deep lustrous black pearl is one of the rarest finds in the pearling industry, usually only being found in the South Sea near Australia. Thus, they can be one of the more costly items. Nowadays, pearls predominantly come from Japan, Australia, Indonesia, Myanmar, China, India, the Philippines, and Tahiti. Japan, however, controls roughly 80% of the world pearl market, with Australia and China coming in second and third, respectively.</p>
    
    <p>&nbsp;</p> <!-- 额外添加的空白行防止加载不完全 -->
  </section>
  <div id="divider" title="Drag to resize"></div>
  <section class="pane" id="right">
    <h3>Questions</h3>
    
    <div class="group">
      <h4>Questions 1–4</h4>
      <p>Reading Passage 1 has seven paragraphs, A–G.<br>Which paragraph contains the following information?<br>Write the correct letter, A–G, in boxes 1–4 on your answer sheet.</p>
      
      <a id="q1-anchor"></a>
      <div id="q1-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>1 difficulties in the cultivation process</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q1" type="radio" value="A"> A</label>
          <label style="margin:0;"><input name="q1" type="radio" value="B"> B</label>
          <label style="margin:0;"><input name="q1" type="radio" value="C"> C</label>
          <label style="margin:0;"><input name="q1" type="radio" value="D"> D</label>
          <label style="margin:0;"><input name="q1" type="radio" value="E"> E</label>
          <label style="margin:0;"><input name="q1" type="radio" value="F"> F</label>
          <label style="margin:0;"><input name="q1" type="radio" value="G"> G</label>
        </div>
      </div>
      
      <a id="q2-anchor"></a>
      <div id="q2-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>2 causes affecting the size of natural pearls</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q2" type="radio" value="A"> A</label>
          <label style="margin:0;"><input name="q2" type="radio" value="B"> B</label>
          <label style="margin:0;"><input name="q2" type="radio" value="C"> C</label>
          <label style="margin:0;"><input name="q2" type="radio" value="D"> D</label>
          <label style="margin:0;"><input name="q2" type="radio" value="E"> E</label>
          <label style="margin:0;"><input name="q2" type="radio" value="F"> F</label>
          <label style="margin:0;"><input name="q2" type="radio" value="G"> G</label>
        </div>
      </div>
      
      <a id="q3-anchor"></a>
      <div id="q3-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>3 ancient customs around pearls</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q3" type="radio" value="A"> A</label>
          <label style="margin:0;"><input name="q3" type="radio" value="B"> B</label>
          <label style="margin:0;"><input name="q3" type="radio" value="C"> C</label>
          <label style="margin:0;"><input name="q3" type="radio" value="D"> D</label>
          <label style="margin:0;"><input name="q3" type="radio" value="E"> E</label>
          <label style="margin:0;"><input name="q3" type="radio" value="F"> F</label>
          <label style="margin:0;"><input name="q3" type="radio" value="G"> G</label>
        </div>
      </div>
      
      <a id="q4-anchor"></a>
      <div id="q4-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>4 distinctions between cultured pearls and natural ones</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q4" type="radio" value="A"> A</label>
          <label style="margin:0;"><input name="q4" type="radio" value="B"> B</label>
          <label style="margin:0;"><input name="q4" type="radio" value="C"> C</label>
          <label style="margin:0;"><input name="q4" type="radio" value="D"> D</label>
          <label style="margin:0;"><input name="q4" type="radio" value="E"> E</label>
          <label style="margin:0;"><input name="q4" type="radio" value="F"> F</label>
          <label style="margin:0;"><input name="q4" type="radio" value="G"> G</label>
        </div>
      </div>
    </div>
    
    <div class="group">
      <h4>Questions 5–10</h4>
      <p>Complete the summary using the list of words, A–K, below.<br>Write the correct letter, A–K, in boxes 5–10 on your answer sheet.</p>
      
      <p>Throughout history, people in <a id="q5-anchor"></a><div class="dropzone" data-target="q5"><span class="droplabel">Drag answer here</span></div> used pearls for medicine and philtres. There are essentially three types of pearls: natural, cultured and imitation. Natural and cultured pearls share a similar growing process, while imitation pearls are different. And <a id="q6-anchor"></a><div class="dropzone" data-target="q6"><span class="droplabel">Drag answer here</span></div> owns the reputation for its imitation pearl industry. The country <a id="q7-anchor"></a><div class="dropzone" data-target="q7"><span class="droplabel">Drag answer here</span></div> usually produces the larger pearls due to the favourable environment along the coastline, while the nation of <a id="q8-anchor"></a><div class="dropzone" data-target="q8"><span class="droplabel">Drag answer here</span></div> manufactures some of the most glistening cultured pearls. In the past, the country <a id="q9-anchor"></a><div class="dropzone" data-target="q9"><span class="droplabel">Drag answer here</span></div> in the Persian Gulf produced the world’s best pearls. At present, the major remaining suppliers of natural pearls are in <a id="q10-anchor"></a><div class="dropzone" data-target="q10"><span class="droplabel">Drag answer here</span></div>.</p>
      
      <div class="cardpool">
        <div class="card" draggable="true" data-value="A">A America</div>
        <div class="card" draggable="true" data-value="B">B Philippines</div>
        <div class="card" draggable="true" data-value="C">C Australia</div>
        <div class="card" draggable="true" data-value="D">D Bahrain</div>
        <div class="card" draggable="true" data-value="E">E China</div>
        <div class="card" draggable="true" data-value="F">F Japan</div>
        <div class="card" draggable="true" data-value="G">G India</div>
        <div class="card" draggable="true" data-value="H">H Egypt</div>
        <div class="card" draggable="true" data-value="I">I Myanmar</div>
        <div class="card" draggable="true" data-value="J">J Persia</div>
        <div class="card" draggable="true" data-value="K">K Mallorca</div>
      </div>
    </div>
    
    <div class="group">
      <h4>Questions 11–13</h4>
      <p>Do the following statements agree with the information given in Reading Passage 1?<br>In boxes 11–13 on your answer sheet, write</p>
      <ul>
        <li>TRUE if the statement agrees with the information</li>
        <li>FALSE if the statement contradicts the information</li>
        <li>NOT GIVEN if there is no information on this</li>
      </ul>
      
      <a id="q11-anchor"></a>
      <div id="q11-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>11 A cultured pearl’s centre is often significantly larger than that in a natural pearl.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q11" type="radio" value="TRUE"> TRUE</label>
          <label style="margin:0;"><input name="q11" type="radio" value="FALSE"> FALSE</label>
          <label style="margin:0;"><input name="q11" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <a id="q12-anchor"></a>
      <div id="q12-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>12 Imitation pearls are usually the same price as natural ones.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q12" type="radio" value="TRUE"> TRUE</label>
          <label style="margin:0;"><input name="q12" type="radio" value="FALSE"> FALSE</label>
          <label style="margin:0;"><input name="q12" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <a id="q13-anchor"></a>
      <div id="q13-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>13 Akoya pearls from Japan glow more deeply than South Sea pearls from Australia.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q13" type="radio" value="TRUE"> TRUE</label>
          <label style="margin:0;"><input name="q13" type="radio" value="FALSE"> FALSE</label>
          <label style="margin:0;"><input name="q13" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
    </div>
    
    <div style="display:flex;gap:8px;margin-bottom:10px;">
      <button class="primary" onclick="grade()">Submit</button>
      <button onclick="resetForm()">Reset</button>
      <button onclick="toggleNotes()">Notes</button>
    </div>
    <div id="results"></div>
    <details class="answerbox" id="answerBox">
      <summary>Show answers (click to toggle) <span class="badge">hidden</span></summary>
      <div id="answerContent"></div>
    </details>
  </section>
</div>
<div aria-label="Selection tools" id="selbar" role="toolbar">
  <button id="btnHL">Highlight</button>
  <button id="btnUH">Remove</button>
  <button id="btnNote">Note</button>
</div>
<div id="notes">
  <header>
    <strong>Notes</strong>
    <div>
      <button id="btnCopy">Copy</button>
      <button id="btnClose">Close</button>
    </div>
  </header>
  <textarea id="noteArea" placeholder="Type your notes here..."></textarea>
</div>
<div id="toast"></div>
<script>
// Timer
let _t=0; const _timerEl=document.getElementById('timer');
setInterval(function(){ 
  _t++; 
  var m=String(Math.floor(_t/60)).padStart(2,'0'); 
  var s=String(_t%60).padStart(2,'0'); 
  _timerEl.textContent=m+':'+s; 
},1000);
// Drag divider
var divider = document.getElementById('divider');
var left = document.getElementById('left');
var right = document.getElementById('right');
var dragging=false;
function startDrag(e){ 
  dragging=true; 
  document.body.style.cursor='ew-resize'; 
  if(e.preventDefault) e.preventDefault(); 
}
function endDrag(){ 
  dragging=false; 
  document.body.style.cursor=''; 
}
function onMove(clientX){
  var container = document.querySelector('.shell').getBoundingClientRect();
  var x = clientX - container.left;
  x = Math.max(280, Math.min(container.width-320, x));
  left.style.flex = '0 0 ' + x + 'px';
  right.style.flex = '1 1 auto';
}
divider.addEventListener('mousedown', function(e){ startDrag(e); });
window.addEventListener('mousemove', function(e){ if(dragging) onMove(e.clientX); });
window.addEventListener('mouseup', endDrag);
divider.addEventListener('touchstart', function(e){ startDrag(e.touches[0]); }, {passive:false});
window.addEventListener('touchmove', function(e){ if(dragging) onMove(e.touches[0].clientX); }, {passive:false});
window.addEventListener('touchend', endDrag);
</script>
<script>
// Highlight toolbar
var selbar = document.getElementById('selbar');
var btnHL = document.getElementById('btnHL');
var btnUH = document.getElementById('btnUH');
var btnNote = document.getElementById('btnNote');
var lastRange=null;
var currentHlNode=null;
var keepToolbar=false;
function positionSelbarForRect(rect){
  selbar.style.display='flex';
  requestAnimationFrame(function(){
    var top = window.scrollY + rect.top - selbar.offsetHeight - 8;
    var leftPos = window.scrollX + rect.left + rect.width/2 - selbar.offsetWidth/2;
    selbar.style.top = ((top>0)?top:(window.scrollY + rect.bottom + 8)) + 'px';
    selbar.style.left = Math.max(8, leftPos) + 'px';
  });
}
function updateSelbar(){
  var sel=window.getSelection();
  if(!sel || sel.rangeCount===0 || sel.isCollapsed) { 
    selbar.style.display='none'; 
    currentHlNode=null; 
    return; 
  }
  var range = sel.getRangeAt(0);
  lastRange = range.cloneRange();
  currentHlNode=null;
  positionSelbarForRect(range.getBoundingClientRect());
}
document.getElementById('left').addEventListener('mouseup', updateSelbar);
document.getElementById('right').addEventListener('mouseup', updateSelbar);
document.addEventListener('selectionchange', function(){ 
  var sel=window.getSelection(); 
  if(!sel || sel.rangeCount===0 || sel.isCollapsed){ 
    if(!keepToolbar && !currentHlNode){ 
      selbar.style.display='none'; 
    } 
  } 
});
document.addEventListener('scroll', function(){ 
  if(selbar.style.display==='flex') updateSelbar(); 
});
document.addEventListener('mousedown', function(e){
  var t = e.target;
  if(t.classList && t.classList.contains('hl')){
    keepToolbar = true;
  } else {
    keepToolbar = false;
  }
}, true);
document.addEventListener('click', function(e){
  var target = e.target;
  if(target.classList && target.classList.contains('hl')){
    currentHlNode = target;
    lastRange = null;
    positionSelbarForRect(target.getBoundingClientRect());
    var sel=window.getSelection();
    if(sel) sel.removeAllRanges();
    setTimeout(function(){ keepToolbar=false; }, 0);
  }
}, true);
function doHighlight(){
  if(currentHlNode) return;
  if(!lastRange || lastRange.collapsed) return;
  var span=document.createElement('span'); span.className='hl';
  try { lastRange.surroundContents(span); }
  catch(e){
    var wrap=document.createElement('span'); wrap.className='hl';
    wrap.appendChild(lastRange.cloneContents());
    lastRange.deleteContents();
    lastRange.insertNode(wrap);
  }
  selbar.style.display='none';
  showToast('Highlighted');
}
function removeHighlight(){
  if(currentHlNode){
    var p = currentHlNode.parentNode;
    while(currentHlNode.firstChild) p.insertBefore(currentHlNode.firstChild, currentHlNode);
    p.removeChild(currentHlNode); p.normalize();
    currentHlNode = null;
    selbar.style.display='none';
    showToast('Highlight removed');
    return;
  }
  if(!lastRange) return;
  var selRect = lastRange.getBoundingClientRect();
  var walker=document.createTreeWalker(document.body, NodeFilter.SHOW_ELEMENT);
  var toRemove=[];
  while(walker.nextNode()){
    var n=walker.currentNode;
    if(n.classList && n.classList.contains('hl')) {
      var r = n.getBoundingClientRect();
      if(!(r.right < selRect.left || r.left > selRect.right || r.bottom < selRect.top || r.top > selRect.bottom)) toRemove.push(n);
    }
  }
  toRemove.forEach(function(el){ var p=el.parentNode; while(el.firstChild) p.insertBefore(el.firstChild, el); p.removeChild(el); p.normalize(); });
  selbar.style.display='none';
  showToast('Highlight removed');
}
btnHL.addEventListener('click', doHighlight);
btnUH.addEventListener('click', removeHighlight);
</script>
<script>
// Notes
var notes = document.getElementById('notes');
var noteArea = document.getElementById('noteArea');
var btnCopy=document.getElementById('btnCopy');
var btnClose=document.getElementById('btnClose');
function toggleNotes(){ 
  notes.style.display = (notes.style.display==='flex'?'none':'flex'); 
}
window.toggleNotes = toggleNotes;
btnClose.addEventListener('click', toggleNotes);
btnCopy.addEventListener('click', async function(){ 
  await navigator.clipboard.writeText(noteArea.value||''); 
  showToast('Copied'); 
});
btnNote.addEventListener('click', function(){
  var text = '';
  if(currentHlNode){ text = (currentHlNode.textContent||'').trim(); }
  else if(lastRange){ var frag = lastRange.cloneContents(); text = (frag.textContent||'').trim(); }
  toggleNotes();
  if(text) noteArea.value = (noteArea.value? noteArea.value+'\n':'') + '> ' + text + '\n';
  selbar.style.display='none';
});
// Toast
var toastEl=document.getElementById('toast');
function showToast(msg){
  toastEl.textContent=msg; 
  toastEl.style.display='block';
  setTimeout(function(){ toastEl.style.display='none'; }, 1200);
}
</script>
<script>
// Drag and drop for questions 5-10
const cards = document.querySelectorAll('.card');
const dropzones = document.querySelectorAll('.dropzone');
cards.forEach(card => {
  card.addEventListener('dragstart', () => {
    card.classList.add('dragging');
  });
  card.addEventListener('dragend', () => {
    card.classList.remove('dragging');
  });
});
dropzones.forEach(zone => {
  zone.addEventListener('dragover', e => {
    e.preventDefault();
    zone.classList.add('over');
  });
  
  zone.addEventListener('dragleave', () => {
    zone.classList.remove('over');
  });
  
  zone.addEventListener('drop', e => {
    e.preventDefault();
    zone.classList.remove('over');
    const draggingCard = document.querySelector('.dragging');
    if (draggingCard) {
      // Clear existing content
      zone.innerHTML = '';
      zone.appendChild(draggingCard);
      // Mark as answered
      const targetQ = zone.dataset.target;
      document.getElementById(targetQ + '-nav').classList.add('answered');
    }
  });
});
</script>
<script>
// Answer key and grading
var answers = {
  "q1":"C", "q2":"D", "q3":"A", "q4":"B",
  "q5":"J", "q6":"K", "q7":"C", "q8":"F", "q9":"D", "q10":"G",
  "q11":"TRUE", "q12":"FALSE", "q13":"NOT GIVEN"
};
function grade(){
  var total=0, correct=0, lines=[];
  
  // Check radio questions (1-4)
  for(let n=1; n<=4; n++){
    const q = `q${n}`;
    total++;
    const selected = document.querySelector(`input[name="${q}"]:checked`);
    const userAnswer = selected ? selected.value : '';
    const isCorrect = userAnswer === answers[q];
    if (isCorrect) correct++;
    lines.push(`${q.toUpperCase()}: ${userAnswer || 'None'} ${isCorrect ? '✅' : '❌'}`);
  }
  
  // Check drag-and-drop questions (5-10)
  dropzones.forEach(zone => {
    const q = zone.dataset.target;
    total++;
    const selectedCard = zone.querySelector('.card');
    const userAnswer = selectedCard ? selectedCard.dataset.value : '';
    const isCorrect = userAnswer === answers[q];
    if (isCorrect) correct++;
    lines.push(`${q.toUpperCase()}: ${userAnswer || 'None'} ${isCorrect ? '✅' : '❌'}`);
  });
  
  // Check radio questions (11-13)
  for(let n=11; n<=13; n++){
    const q = `q${n}`;
    total++;
    const selected = document.querySelector(`input[name="${q}"]:checked`);
    const userAnswer = selected ? selected.value : '';
    const isCorrect = userAnswer === answers[q];
    if (isCorrect) correct++;
    lines.push(`${q.toUpperCase()}: ${userAnswer || 'None'} ${isCorrect ? '✅' : '❌'}`);
  }
  
  // Show results
  const acc = Math.round(100 * correct / total);
  document.getElementById('results').innerHTML = `
    <p><strong>Score:</strong> ${correct}/${total} <span class="badge">Accuracy ${acc}%</span></p>
    <pre>${lines.join('\n')}</pre>
  `;
  
  // Show answer key
  document.getElementById('answerContent').innerHTML = `
    <ol>
      <li>1 → C</li>
      <li>2 → D</li>
      <li>3 → A</li>
      <li>4 → B</li>
      <li>5 → J (Persia)</li>
      <li>6 → K (Mallorca)</li>
      <li>7 → C (Australia)</li>
      <li>8 → F (Japan)</li>
      <li>9 → D (Bahrain)</li>
      <li>10 → G (India)</li>
      <li>11 → TRUE</li>
      <li>12 → FALSE</li>
      <li>13 → NOT GIVEN</li>
    </ol>
  `;
  document.querySelector('#answerBox .badge').textContent = 'tap to view';
}
function resetForm(){
  // Reset drag-and-drop
  dropzones.forEach(zone => {
    const card = zone.querySelector('.card');
    if (card) {
      document.querySelector('.cardpool').appendChild(card);
      zone.innerHTML = '<span class="droplabel">Drag answer here</span>';
    }
  });
  
  // Reset radio buttons
  document.querySelectorAll('input[type="radio"]').forEach(radio => {
    radio.checked = false;
  });
  
  // Reset results and answers
  document.getElementById('results').innerHTML = '';
  document.getElementById('answerContent').innerHTML = '';
  document.querySelector('#answerBox .badge').textContent = 'hidden';
  
  // Reset answered status in nav
  document.querySelectorAll('.q-item').forEach(item => {
    item.classList.remove('answered');
  });
}
// Scroll to question anchor
function scrollToElement(id){
  const el = document.getElementById(id);
  if(el){ 
    el.scrollIntoView({behavior:'smooth', block:'center'}); 
  }
  // Highlight nav item briefly
  const navs = document.querySelectorAll('.practice-nav .q-item');
  navs.forEach(n => n.classList.remove('active'));
  const btn = document.getElementById(id.replace('-anchor','-nav'));
  if(btn){ 
    btn.classList.add('active'); 
    setTimeout(() => btn.classList.remove('active'), 800); 
  }
}
// Mark answered on interaction
(function(){
  function markAnswered(qn){
    const nav = document.getElementById(`q${qn}-nav`);
    if(!nav) return;
    let answered = false;
    
    // Check dropzones (5-10)
    if(qn >=5 && qn <=10){
      const zone = document.querySelector(`.dropzone[data-target="q${qn}"]`);
      answered = zone.querySelector('.card') !== null;
    } 
    // Check radio buttons (1-4, 11-13)
    else {
      const radios = document.querySelectorAll(`input[name="q${qn}"]:checked`);
      answered = radios.length > 0;
    }
    
    if(answered) nav.classList.add('answered');
    else nav.classList.remove('answered');
  }
  
  // Monitor dropzones
  dropzones.forEach(zone => {
    zone.addEventListener('drop', () => {
      const qn = zone.dataset.target.replace('q', '');
      markAnswered(qn);
    });
  });
  
  // Monitor radio buttons
  for(let n=1; n<=4; n++){
    document.querySelectorAll(`input[name="q${n}"]`).forEach(radio => {
      radio.addEventListener('change', () => markAnswered(n));
    });
  }
  for(let n=11; n<=13; n++){
    document.querySelectorAll(`input[name="q${n}"]`).forEach(radio => {
      radio.addEventListener('change', () => markAnswered(n));
    });
  }
})();
</script>

<!-- 练习页面数据传输增强脚本 -->
<script>
// 检查是否已经有增强脚本
if (!window.practicePageEnhancer) {
    // 动态加载增强脚本
    const script = document.createElement('script');
    script.src = '../../js/practice-page-enhancer.js';
    script.onload = function() {
        console.log('练习页面增强脚本已加载');
    };
    script.onerror = function() {
        console.error('练习页面增强脚本加载失败');
        // 降级到内联增强
        loadInlineEnhancer();
    };
    document.head.appendChild(script);
}

// 内联增强器（降级方案）
function loadInlineEnhancer() {
    if (window.practicePageEnhancer) return;
    
    window.practicePageEnhancer = {
        initialize: function() {
            console.log('[InlineEnhancer] 内联增强器已初始化');
            this.setupCommunication();
            this.setupAnswerListeners();
            this.interceptSubmit();
        },
        
        setupCommunication: function() {
            this.parentWindow = window.opener || window.parent;
            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'INIT_SESSION') {
                    this.sessionId = event.data.data.sessionId;
                    this.sendMessage('SESSION_READY', {
                        pageType: this.detectPageType(),
                        url: window.location.href
                    });
                }
            });
        },
        
        detectPageType: function() {
            const title = document.title || '';
            if (title.includes('P1')) return 'P1';
            if (title.includes('P2')) return 'P2';
            if (title.includes('P3')) return 'P3';
            return 'unknown';
        },
        
        setupAnswerListeners: function() {
            this.answers = {};
            this.startTime = Date.now();
            
            document.addEventListener('change', (e) => {
                if (e.target.name && e.target.name.startsWith('q')) {
                    this.answers[e.target.name] = e.target.value;
                }
            });
        },
        
        interceptSubmit: function() {
            // 拦截grade函数
            if (typeof window.grade === 'function') {
                const originalGrade = window.grade;
                window.grade = () => {
                    const result = originalGrade();
                    setTimeout(() => this.handleSubmit(), 200);
                    return result;
                };
            }
            
            // 监听提交按钮
            document.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' && 
                    (e.target.textContent.includes('Submit') || 
                     e.target.onclick && e.target.onclick.toString().includes('grade'))) {
                    setTimeout(() => this.handleSubmit(), 300);
                }
            });
        },
        
        handleSubmit: function() {
            const results = {
                sessionId: this.sessionId,
                startTime: this.startTime,
                endTime: Date.now(),
                duration: Math.round((Date.now() - this.startTime) / 1000),
                answers: this.answers,
                scoreInfo: this.extractScore(),
                pageType: this.detectPageType(),
                url: window.location.href
            };
            
            this.sendMessage('PRACTICE_COMPLETE', results);
        },
        
        extractScore: function() {
            const resultsEl = document.getElementById('results');
            if (!resultsEl) return null;
            
            const text = resultsEl.textContent || '';
            const scoreMatch = text.match(/Score:\s*(\d+)\/(\d+)/i);
            if (scoreMatch) {
                const correct = parseInt(scoreMatch[1]);
                const total = parseInt(scoreMatch[2]);
                return {
                    correct: correct,
                    total: total,
                    accuracy: total > 0 ? correct / total : 0,
                    percentage: Math.round((correct / total) * 100),
                    source: 'inline_extraction'
                };
            }
            return null;
        },
        
        sendMessage: function(type, data) {
            if (this.parentWindow) {
                this.parentWindow.postMessage({
                    type: type,
                    data: data,
                    source: 'practice_page'
                }, '*');
            }
        }
    };
    
    // 初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            window.practicePageEnhancer.initialize();
        });
    } else {
        window.practicePageEnhancer.initialize();
    }
}
</script>

</body></html>