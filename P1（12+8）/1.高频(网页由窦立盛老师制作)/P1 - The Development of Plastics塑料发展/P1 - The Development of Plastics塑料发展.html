<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>P1 ‚Äì Katherine Mansfield (Fixed & Optimized)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root { 
    --line: #e5e7eb; 
    --bg: #f6f7fb; 
    --panel: #fff; 
    --accent: #3b82f6; 
    --muted: #6b7280; 
    --shadow: 0 6px 20px rgba(0,0,0,.12); 
  }
  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body { 
    margin: 0; 
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; 
    background: var(--bg); 
    padding-bottom: 82px; 
  }
  
  /* Â∏ÉÂ±ÄÊ†∑Âºè */
  .shell { display: flex; height: 100vh; width: 100%; }
  .pane { background: var(--panel); overflow: auto; padding: 20px; }
  #left { flex: 0 0 50%; min-width: 280px; }
  #right { flex: 1 1 auto; min-width: 320px; background: #fbfbff; border-left: 1px solid var(--line); }
  #divider { flex: 0 0 8px; background: linear-gradient(90deg, #e5e7eb, #d1d5db); cursor: ew-resize; position: relative; z-index: 5; user-select: none; }
  
  /* ÊñáÊú¨Ê†∑Âºè */
  h2, h3, h4 { margin: 0 0 10px; }
  #left p { margin: 0 0 12px; line-height: 1.6; word-break: normal; overflow-wrap: normal; hyphens: none; }
  
  /* ÁªÑ‰ª∂Ê†∑Âºè */
  .group { background: #fff; border: 1px solid var(--line); border-radius: 10px; padding: 12px; margin-bottom: 14px; }
  table { border-collapse: collapse; width: 100%; margin: 12px 0; }
  th, td { border: 1px solid var(--line); padding: 8px; text-align: left; }
  .blank-input { border:none; border-bottom:1px solid #9ca3af; padding:4px 2px; font-size:1em; background:transparent; width: 120px; margin: 0 4px; }
  .blank-input:focus { outline:none; border-bottom:2px solid var(--accent); }

  /* ÊåâÈíÆÊ†∑Âºè */
  button { padding: 8px 12px; border: 1px solid var(--line); background: #fff; border-radius: 6px; cursor: pointer; transition: all 0.2s; font-size: 14px; }
  button:hover { background: #f8fafc; border-color: #cbd5e1; }
  button.primary { background: var(--accent); color: #fff; border-color: var(--accent); }
  button.primary:hover { background: #2563eb; }
  
  /* ËÆ°Êó∂Âô®Ê†∑Âºè */
  #timer { background: #fff; color: var(--muted); border: 1px solid var(--line); border-radius: 6px; padding: 6px 12px; cursor: pointer; font-family: 'Courier New', monospace; transition: all 0.2s; min-width: 70px; text-align: center; font-size: 18px; font-weight: bold; }
  #timer:hover { background: #f1f5f9; border-color: var(--accent); }
  #timer.paused { color: #ef4444; border-color: #fecaca; background: #fef2f2; }
  
  /* ‰∏ªÈ¢òÂàáÊç¢ÊåâÈíÆ */
  .theme-toggle { background: #fff; color: var(--muted); border: 1px solid var(--line); border-radius: 6px; width: 36px; height: 36px; font-size: 16px; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; }
  .theme-toggle:hover { background: var(--accent); color: #fff; border-color: var(--accent); transform: scale(1.05); }
  
  /* Ê∑±Ëâ≤Ê®°ÂºèÊ†∑Âºè */
  body.dark { --bg: #0f172a; --panel: #1e293b; --line: #334155; --muted: #94a3b8; color: #e2e8f0; }
  body.dark #right { background: #0f172a; }
  body.dark .group { background: #1e293b; border-color: #334155; }
  body.dark button { background: #1e293b; color: #e2e8f0; border-color: #334155; }
  body.dark button:hover { background: #334155; }
  body.dark button.primary { background: var(--accent); color: #fff; }
  body.dark #results { background: #1e293b; border-color: #334155; }
  body.dark #notes { background: #1e293b; border-color: #334155; color: #e2e8f0; }
  body.dark .practice-nav { background: #1e293b; border-color: #334155; }
  body.dark .q-item { background: #0f172a; color: #e2e8f0; border-color: #334155; }
  body.dark .q-item:hover { background: #334155; }
  body.dark .q-item.answered { background: #1e40af; border-color: var(--accent); color: #93c5fd; }
  body.dark #timer { background: #1e293b; color: #e2e8f0; border-color: #334155; }
  body.dark #timer:hover { background: #334155; border-color: var(--accent); }
  body.dark details.answerbox { background: #1e293b; border-color: #334155; }
  body.dark table, body.dark th, body.dark td { border-color: var(--line); }
  body.dark .blank-input { color: #e2e8f0; border-bottom-color: #64748b; }
  body.dark .blank-input:focus { border-bottom-color: var(--accent); }

  /* ÂìçÂ∫îÂºèËÆæËÆ° */
  @media (max-width: 768px) {
    .shell { flex-direction: column; }
    #left, #right { flex: none; min-width: auto; }
    #divider { display: none; }
    .practice-nav .controls { gap: 8px; }
    #timer { font-size: 12px; padding: 3px 8px; }
    .theme-toggle { width: 32px; height: 32px; font-size: 14px; }
    #notes { width: calc(100vw - 24px); right: 12px; left: 12px; }
  }
  
  /* ÈÄâÊã©Â∑•ÂÖ∑Ê†è */
  #selbar { position: fixed; display: none; z-index: 2000; background: #111; color: #fff; border-radius: 8px; padding: 6px; box-shadow: var(--shadow); font-size: 13px; gap: 6px; align-items: center; }
  #selbar button { background: transparent; color: #fff; border: 1px solid rgba(255,255,255,.25); padding: 4px 8px; border-radius: 6px; cursor: pointer; }
  #selbar button:hover { border-color: #fff; }
  
  /* Á¨îËÆ∞Èù¢Êùø */
  #notes { position: fixed; right: 12px; bottom: 12px; width: 320px; height: 42vh; background: #fff; border: 1px solid var(--line); border-radius: 12px; display: none; flex-direction: column; z-index: 1500; box-shadow: var(--shadow); }
  #notes header { display: flex; align-items: center; justify-content: space-between; padding: 8px 10px; border-bottom: 1px solid var(--line); }
  #notes textarea { flex: 1; border: 0; padding: 10px; resize: none; font-size: 14px; line-height: 1.5; }
  
  /* ToastÈÄöÁü• */
  #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: #fff; padding: 8px 16px; border-radius: 4px; display: none; z-index: 3000; font-size: 14px; }
  
  /* Á≠îÈ¢òÂØºËà™ */
  .practice-nav { background: #fff; padding: 12px 20px; display: flex; align-items: center; gap: 16px; box-shadow: 0 2px 4px rgba(0,0,0,.05); flex-wrap: wrap; position: fixed; left: 0; right: 0; bottom: 0; border-top: 2px solid var(--line); z-index: 4000; }
  .practice-nav .title { font-weight: 600; color: var(--muted); }
  .practice-nav .questions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  .practice-nav .q-item { padding: 6px 10px; border: 1px solid var(--line); border-radius: 6px; background: #fff; cursor: pointer; font-size: 14px; transition: all 0.2s; min-width: 36px; text-align: center; }
  .practice-nav .q-item:hover { background: #f1f5f9; border-color: var(--accent); }
  .practice-nav .q-item.answered { background: #e0e7ff; border-color: var(--accent); color: var(--accent); font-weight: 500; }
  .practice-nav .q-item.active { background: var(--accent); color: #fff; }
  .practice-nav .controls { display: flex; gap: 12px; margin-left: auto; align-items: center; }
  
  /* Á≠îÈ¢òÁªìÊûúÊòæÁ§∫ */
  #results { background: #fff; border: 1px solid var(--line); border-radius: 10px; padding: 12px; margin: 16px 0; font-family: monospace; white-space: pre-wrap; }
  #results p { margin: 0 0 8px; }
  .badge { background: #e0e7ff; color: var(--accent); padding: 2px 8px; border-radius: 999px; font-size: 12px; }
  
  /* Á≠îÊ°àÊ°Ü */
  details.answerbox { background: #fff; border: 1px solid var(--line); border-radius: 10px; padding: 12px; margin-top: 10px; }
  details.answerbox summary { cursor: pointer; font-weight: 600; list-style: none; display: flex; align-items: center; justify-content: space-between; }
  details.answerbox summary::-webkit-details-marker { display: none; }
  #answerContent { margin-top: 10px; }
  #answerContent ol { margin: 0; padding-left: 20px; }
  #answerContent li { margin: 4px 0; }

  /* È´ò‰∫ÆÊ†∑Âºè */
  .hl { background: #ffeb3b; color: #000; }
  body.dark .hl { background: #8a6d00; color: #fff; }
  
  /* ÊªöÂä®Êù°Ê†∑Âºè */
  ::-webkit-scrollbar { width: 8px; height: 8px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #c5c5d2; border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: #999; }
  body.dark ::-webkit-scrollbar-thumb { background: #4a5568; }
  body.dark ::-webkit-scrollbar-thumb:hover { background: #718096; }
</style>
</head>
<body>

<div class="practice-nav">
  <div class="title">Questions</div>
  <div class="questions">
    <div class="q-item" id="q1-nav" onclick="scrollToElement('q1-anchor')">1</div>
    <div class="q-item" id="q2-nav" onclick="scrollToElement('q2-anchor')">2</div>
    <div class="q-item" id="q3-nav" onclick="scrollToElement('q3-anchor')">3</div>
    <div class="q-item" id="q4-nav" onclick="scrollToElement('q4-anchor')">4</div>
    <div class="q-item" id="q5-nav" onclick="scrollToElement('q5-anchor')">5</div>
    <div class="q-item" id="q6-nav" onclick="scrollToElement('q6-anchor')">6</div>
    <div class="q-item" id="q7-nav" onclick="scrollToElement('q7-anchor')">7</div>
    <div class="q-item" id="q8-nav" onclick="scrollToElement('q8-anchor')">8</div>
    <div class="q-item" id="q9-nav" onclick="scrollToElement('q9-anchor')">9</div>
    <div class="q-item" id="q10-nav" onclick="scrollToElement('q10-anchor')">10</div>
    <div class="q-item" id="q11-nav" onclick="scrollToElement('q11-anchor')">11</div>
    <div class="q-item" id="q12-nav" onclick="scrollToElement('q12-anchor')">12</div>
    <div class="q-item" id="q13-nav" onclick="scrollToElement('q13-anchor')">13</div>
  </div>
  <div class="controls">
    <span id="timer" onclick="toggleTimer()">00:00</span>
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode">üåô</button>
  </div>
</div>

<div class="shell">
  <section class="pane" id="left">
    <h2>READING PASSAGE 1</h2>
    <p>You should spend about 20 minutes on Questions 1‚Äì13, which are based on Reading Passage 1 below.</p>
    
    <h3>Katherine Mansfield</h3>
  
    <p>Katherine Mansfield Beauchamp Murry was born in 1888, into a prominent family in Wellington, New Zealand. She became one of New Zealand‚Äôs best-known writers, using the pen name of Katherine Mansfield. The daughter of a banker, and born into a middle-class family, she was also a first cousin of Countess Elizabeth von Arnim, a distinguished novelist in her time. Mansfield had two older sisters and a younger brother. Her father, Harold Beauchamp, went on to become the chairman of the Bank of New Zealand. In 1893, the Mansfield family moved to Karori, a suburb of Wellington, where Mansfield would spend the happiest years of her childhood; she later used her memories of this time as an inspiration for her Prelude story.</p>
    <p>Her first published stories appeared in the High School Reporter and the Wellington Girls‚Äô High School magazine in 1898 and 1899. In 1902, she developed strong feelings for a musician who played the cello, Arnold Trowell, although her feelings were not, for the most part, returned. Mansfield herself was an accomplished cellist, having received lessons from Trowell‚Äôs father. Mansfield wrote in her journals of feeling isolated to some extent in New Zealand, and, in general terms, of her interest in the Maori people (New Zealand‚Äôs native people), who were often portrayed in a sympathetic light in her later stories, such as How Pearl Button Was Kidnapped.</p>
    <p>She moved to London in 1903, where she attended Queen‚Äôs College, along with her two sisters. Mansfield recommenced playing the cello, an occupation that she believed, during her time at Queen‚Äôs, she would take up professionally. She also began contributing to the college newspaper, with such a dedication to it that she eventually became its editor. She was particularly interested in the works of the French writers of this period and in the 19th century British writer, Oscar Wilde, and she was appreciated amongst fellow students at Queen‚Äôs for her lively and charismatic approach to life and work. She met fellow writer Ida Baker, a South African, at the college, and the pair became lifelong friends. Mansfield did not actively support the suffragette movement in the UK. Women in New Zealand had gained the right to vote in 1893.</p>
    <p>Mansfield first began journeying into other parts of Europe in the period 1903‚Äì1906, mainly to Belgium and Germany. After finishing her schooling in England, she returned to her New Zealand home in 1906, only then beginning to write short stories in a serious way. She had several works published in Australia in a magazine called The Native Companion, which was her first paid writing work, and by this time she had her mind set on becoming a professional writer. It was also the first occasion on which she used the pseudonym ‚ÄúK. Mansfield‚Äù.</p>
    <p>Mansfield rapidly grew discontented with the provincial New Zealand lifestyle, and with her family. Two years later she headed again to London. Her father sent her an annual subsidy of ¬£100 for the rest of her life. In later years, she would express both admiration and disdain for New Zealand in her journals.</p>
    <p>In 1911, Mansfield met John Middleton Murry, the Oxford scholar and editor of the literary magazine Rhythm. They were later to marry in 1918. Mansfield became a co-editor of Rhythm, which was subsequently called The Blue Review, in which more of her works were published. She and Murry lived in various houses in England and briefly in Paris. The Blue Review failed to gain enough readers and was no longer published. Their attempt to set up as writers in Paris was cut short by Murry‚Äôs bankruptcy, which resulted from the failure of this and other journals. Life back in England meant frequently changed addresses and very limited funds.</p>
    <p>Between 1915 and 1918, Mansfield moved between England and Bandol, France. She and Murry developed close contact with other well-known writers of the time such as D. H. Lawrence, Bertrand Russell and Aldous Huxley. By October 1918 Mansfield had become seriously ill; she had been diagnosed with tuberculosis and was advised to enter a sanatorium. She could no longer spend winters in London. In the autumn of 1918 she was so ill that she decided to go to Ospedaletti in Italy. It was the publication of Bliss and Other Stories in 1920 that was to solidify Mansfield‚Äôs reputation as a writer.</p>
    <p>Mansfield also spent time in Menton, France, as the tenant of her father‚Äôs cousin at ‚ÄúThe Villa Isola Bella‚Äù. There she wrote eight stories including Miss Brill and The Daughters of the Late Colonel, the latter of which she pronounced to be ‚Äú‚Ä¶the only story that satisfies me to any extent‚Äù.</p>
    <p>Mansfield produced a great deal of work in the final years of her life, and much of her prose and poetry remained unpublished at her death in 1923. After her death, her husband, Murry, took on the task of editing and publishing her works. His efforts resulted in two additional volumes of short stories, The Doves‚Äô Nest and Something Childish, published in 1923 and 1924 respectively; the publication of her Poems; as well as a collection of critical writings (Novels and Novelists) and a number of editions of Mansfield‚Äôs previously unpublished letters and journals.</p>

    <p>&nbsp;</p>
    <p>&nbsp;</p>
    <p>&nbsp;</p>

  </section>
  <div id="divider" title="Drag to resize"></div>
  <section class="pane" id="right">
    <h3>Questions</h3>
    
    <div class="group">
      <h4>Questions 1‚Äì6</h4>
      <p>Do the following statements agree with the information given in Reading Passage 1? Write:</p>
      <ul><li><strong>TRUE</strong>, <strong>FALSE</strong>, or <strong>NOT GIVEN</strong></li></ul>
      
      <div id="q1-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;"><p><strong>1.</strong> The name Katherine Mansfield, which appears on the writer‚Äôs books, was exactly the same as her original name.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;"><label><input name="q1" type="radio" value="TRUE"> TRUE</label><label><input name="q1" type="radio" value="FALSE"> FALSE</label><label><input name="q1" type="radio" value="NOT GIVEN"> NOT GIVEN</label></div>
      </div>
      <div id="q2-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;"><p><strong>2.</strong> Mansfield won a prize for a story she wrote for the High School Reporter.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;"><label><input name="q2" type="radio" value="TRUE"> TRUE</label><label><input name="q2" type="radio" value="FALSE"> FALSE</label><label><input name="q2" type="radio" value="NOT GIVEN"> NOT GIVEN</label></div>
      </div>
      <div id="q3-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;"><p><strong>3.</strong> How Pearl Button Was Kidnapped portrayed Maori people in a favourable way.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;"><label><input name="q3" type="radio" value="TRUE"> TRUE</label><label><input name="q3" type="radio" value="FALSE"> FALSE</label><label><input name="q3" type="radio" value="NOT GIVEN"> NOT GIVEN</label></div>
      </div>
      <div id="q4-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;"><p><strong>4.</strong> When Mansfield was at Queen‚Äôs College, she planned to be a professional writer.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;"><label><input name="q4" type="radio" value="TRUE"> TRUE</label><label><input name="q4" type="radio" value="FALSE"> FALSE</label><label><input name="q4" type="radio" value="NOT GIVEN"> NOT GIVEN</label></div>
      </div>
      <div id="q5-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;"><p><strong>5.</strong> Mansfield was unpopular with the other students at Queen‚Äôs College.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;"><label><input name="q5" type="radio" value="TRUE"> TRUE</label><label><input name="q5" type="radio" value="FALSE"> FALSE</label><label><input name="q5" type="radio" value="NOT GIVEN"> NOT GIVEN</label></div>
      </div>
      <div id="q6-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;"><p><strong>6.</strong> In London, Mansfield showed little interest in politics.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;"><label><input name="q6" type="radio" value="TRUE"> TRUE</label><label><input name="q6" type="radio" value="FALSE"> FALSE</label><label><input name="q6" type="radio" value="NOT GIVEN"> NOT GIVEN</label></div>
      </div>
    </div>
    
    <div class="group">
      <h4>Questions 7‚Äì13</h4>
      <p>Complete the notes below. Choose <strong>ONE WORD AND/OR A NUMBER</strong> from the passage for each answer.</p>
      
      <p><strong>Katherine Mansfield‚Äôs adult years</strong></p>
      <div id="q7-anchor" style="padding:8px 0;border-top:1px dashed #e5e7eb;">‚Ä¢ <input type="text" class="blank-input" name="q7" placeholder="Answer 7"> ‚Äì moved from England back to New Zealand</div>
      <div id="q8-anchor" style="padding-top: 8px;">‚Ä¢ First paid writing work was in a publication based in <input type="text" class="blank-input" name="q8" placeholder="Answer 8"></div>
      <div id="q9-anchor" style="padding-top: 8px;">‚Ä¢ Her <input type="text" class="blank-input" name="q9" placeholder="Answer 9"> and the New Zealand way of life made her feel dissatisfied</div>
      <div style="padding-top: 8px;">‚Ä¢ <strong>1908:</strong> returned to London</div>
      <div style="padding-top: 8px;">‚Ä¢ <strong>1911‚Äì1919:</strong> Met John Middleton Murry in 1911</div>
      <div id="q10-anchor" style="padding-top: 8px;">‚Ä¢ <input type="text" class="blank-input" name="q10" placeholder="Answer 10"> prevented Mansfield and Murry from staying together in Paris</div>
      <div id="q11-anchor" style="padding-top: 8px;">‚Ä¢ Spent time with distinguished <input type="text" class="blank-input" name="q11" placeholder="Answer 11"></div>
      <div style="padding-top: 8px;">‚Ä¢ From 1916, tuberculosis restricted the time she spent in London</div>
      <div style="padding-top: 8px;">‚Ä¢ <strong>1920:</strong></div>
      <div id="q12-anchor" style="padding-top: 8px;">‚Ä¢ Her <input type="text" class="blank-input" name="q12" placeholder="Answer 12"> was consolidated when Bliss and Other Stories was published</div>
      <div style="padding-top: 8px;">‚Ä¢ Wrote several stories at "Villa Isola Bella"</div>
      <div style="padding-top: 8px;">‚Ä¢ <strong>1923‚Äì1924:</strong></div>
      <div id="q13-anchor" style="padding-top: 8px;">‚Ä¢ Mansfield‚Äôs <input type="text" class="blank-input" name="q13" placeholder="Answer 13"> published more of her works after her death</div>
    </div>

    <div style="display:flex;gap:8px;margin-bottom:10px;">
      <button class="primary" onclick="grade()">Submit</button>
      <button onclick="resetForm()">Reset</button>
      <button onclick="toggleNotes()">Notes</button>
    </div>
    <div id="results"></div>
    <details class="answerbox" id="answerBox">
      <summary>Show answers (click to toggle) <span class="badge">hidden</span></summary>
      <div id="answerContent"></div>
    </details>
  </section>
</div>

<div aria-label="Selection tools" id="selbar" role="toolbar">
  <button id="btnHL">Highlight</button><button id="btnUH">Remove</button><button id="btnNote">Note</button>
</div>

<div id="notes">
  <header><strong>Notes</strong><div><button id="btnCopy">Copy</button><button id="btnClose">Close</button></div></header>
  <textarea id="noteArea" placeholder="Type your notes here..."></textarea>
</div>

<div id="toast"></div>

<script>
// UI functions: scrollToElement, showToast, Timer, toggleTheme, Divider, Highlighter, Notes
function scrollToElement(id) {
    const element = document.getElementById(id);
    if (element) {
        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
        const navItem = document.getElementById(id.replace('-anchor', '-nav'));
        if (navItem) {
            navItem.classList.add('active');
            setTimeout(() => navItem.classList.remove('active'), 1200);
        }
    }
}

function showToast(msg) {
    const toastEl = document.getElementById('toast');
    toastEl.textContent = msg;
    toastEl.style.display = 'block';
    setTimeout(() => { toastEl.style.display = 'none'; }, 1500);
}

let timerSeconds = 0, timerRunning = false, timerInterval;
const timerEl = document.getElementById('timer');
function updateTimerDisplay() {
    const minutes = Math.floor(timerSeconds / 60);
    const seconds = timerSeconds % 60;
    timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function startTimer() {
    if (!timerRunning) {
        timerRunning = true;
        timerEl.classList.remove('paused');
        timerInterval = setInterval(() => { timerSeconds++; updateTimerDisplay(); }, 1000);
    }
}

function stopTimer() {
    timerRunning = false;
    timerEl.classList.add('paused');
    clearInterval(timerInterval);
}

function toggleTimer() {
    if (timerRunning) { stopTimer(); showToast('Timer paused'); }
    else { startTimer(); showToast('Timer resumed'); }
}

function toggleTheme() {
    document.body.classList.toggle('dark');
    const isDark = document.body.classList.contains('dark');
    localStorage.setItem('darkMode', isDark);
    document.querySelector('.theme-toggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
}

const divider = document.getElementById('divider'), leftPane = document.getElementById('left');
let isDragging = false;
divider.addEventListener('mousedown', (e) => { isDragging = true; document.body.style.cursor = 'ew-resize'; e.preventDefault(); });
window.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    const shellRect = document.querySelector('.shell').getBoundingClientRect();
    let newLeftWidth = e.clientX - shellRect.left;
    if (newLeftWidth < 280) newLeftWidth = 280;
    if (newLeftWidth > shellRect.width - 320) newLeftWidth = shellRect.width - 320;
    leftPane.style.flexBasis = newLeftWidth + 'px';
});
window.addEventListener('mouseup', () => { isDragging = false; document.body.style.cursor = 'default'; });

const selbar = document.getElementById('selbar');
let lastRange = null;
function positionSelbar() {
    const selection = window.getSelection();
    if (!selection || selection.rangeCount === 0 || selection.isCollapsed) { selbar.style.display = 'none'; return; }
    const range = selection.getRangeAt(0);
    lastRange = range.cloneRange();
    const rect = range.getBoundingClientRect();
    selbar.style.display = 'flex';
    selbar.style.top = `${window.scrollY + rect.top - selbar.offsetHeight - 5}px`;
    selbar.style.left = `${window.scrollX + rect.left + rect.width / 2 - selbar.offsetWidth / 2}px`;
}
document.getElementById('left').addEventListener('mouseup', positionSelbar);
document.getElementById('btnHL').addEventListener('click', () => { if (lastRange) { const span = document.createElement('span'); span.className = 'hl'; try { lastRange.surroundContents(span); } catch (e) { span.appendChild(lastRange.extractContents()); lastRange.insertNode(span); } window.getSelection().removeAllRanges(); selbar.style.display = 'none'; } });
document.getElementById('btnUH').addEventListener('click', () => { if (lastRange) { const ancestor = lastRange.commonAncestorContainer; ancestor.querySelectorAll('.hl').forEach(hl => { if (lastRange.intersectsNode(hl)) { const parent = hl.parentNode; while (hl.firstChild) { parent.insertBefore(hl.firstChild, hl); } parent.removeChild(hl); parent.normalize(); } }); window.getSelection().removeAllRanges(); selbar.style.display = 'none'; } });

const notesPanel = document.getElementById('notes'), noteArea = document.getElementById('noteArea');
function toggleNotes() { notesPanel.style.display = (notesPanel.style.display === 'flex' ? 'none' : 'flex'); }
window.toggleNotes = toggleNotes;
document.getElementById('btnClose').addEventListener('click', toggleNotes);
document.getElementById('btnCopy').addEventListener('click', async () => { await navigator.clipboard.writeText(noteArea.value || ''); showToast('Copied'); });
document.getElementById('btnNote').addEventListener('click', () => { const selection = window.getSelection().toString().trim(); if (selection) { noteArea.value += (noteArea.value ? '\n\n' : '') + `> ${selection}`; toggleNotes(); window.getSelection().removeAllRanges(); selbar.style.display = 'none'; } });

// Core Logic: Grading, Resetting, Status Updates
const correctAnswers = {
    q1: "FALSE", q2: "NOT GIVEN", q3: "TRUE", q4: "FALSE", q5: "FALSE", q6: "TRUE",
    q7: "1906", q8: "Australia", q9: "family", q10: "bankruptcy", q11: "writers", q12: "reputation", q13: "husband"
};

function updateAnswerStatus() {
    for (let i = 1; i <= 13; i++) {
        const navItem = document.getElementById(`q${i}-nav`);
        if (navItem) {
            let answered = false;
            const radio = document.querySelector(`input[name="q${i}"]:checked`);
            const textInput = document.querySelector(`input[name="q${i}"].blank-input`);
            if (radio) {
                answered = true;
            } else if (textInput && textInput.value.trim() !== '') {
                answered = true;
            }
            navItem.classList.toggle('answered', answered);
        }
    }
}

function grade() {
    let total = 13, correct = 0, resultLines = [];
    
    for (let i = 1; i <= 13; i++) {
        const qName = `q${i}`;
        let userAnswer = '';
        const radio = document.querySelector(`input[name="${qName}"]:checked`);
        const textInput = document.querySelector(`input[name="${qName}"].blank-input`);

        if (radio) {
            userAnswer = radio.value;
        } else if (textInput) {
            userAnswer = textInput.value.trim();
        }

        const isCorrect = userAnswer.toLowerCase() === correctAnswers[qName].toLowerCase();
        if (isCorrect) correct++;
        resultLines.push(`${i}. ${userAnswer || 'None'} ${isCorrect ? '‚úì' : '‚úó'}`);
    }

    const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;
    document.getElementById('results').innerHTML = `<p><strong>Score:</strong> ${correct}/${total} <span class="badge">Accuracy ${accuracy}%</span></p><pre>${resultLines.join('\n')}</pre>`;
    
    document.getElementById('answerContent').innerHTML = `
        <ol>
            ${Object.values(correctAnswers).map(answer => `<li>${answer}</li>`).join('')}
        </ol>
    `;
    document.querySelector('#answerBox .badge').textContent = 'tap to view';
    updateAnswerStatus();
}

function resetForm() {
    document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(input => input.checked = false);
    document.querySelectorAll('.blank-input').forEach(input => input.value = '');
    document.getElementById('results').innerHTML = '';
    document.getElementById('answerContent').innerHTML = '';
    const answerBadge = document.querySelector('#answerBox .badge');
    if (answerBadge) answerBadge.textContent = 'hidden';
    if (document.getElementById('answerBox').hasAttribute('open')) {
        document.getElementById('answerBox').removeAttribute('open');
    }
    updateAnswerStatus();
    showToast('Form reset');
}

// Event Listeners and Initialization
document.addEventListener('DOMContentLoaded', () => {
    startTimer();
    updateAnswerStatus();
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark');
        document.querySelector('.theme-toggle').textContent = '‚òÄÔ∏è';
    }
    loadPracticePageEnhancer();
});
document.addEventListener('input', updateAnswerStatus);

// Practice Page Enhancer Script
function loadPracticePageEnhancer() {
    const script = document.createElement('script');
    script.src = '../../../js/practice-page-enhancer.js';
    script.onload = () => console.log('Practice page enhancer script loaded.');
    script.onerror = () => { console.error('Failed to load practice page enhancer script. Falling back to inline version.'); loadInlineEnhancer(); };
    document.head.appendChild(script);
}

function loadInlineEnhancer() {
    if (window.practicePageEnhancer) return;
    window.practicePageEnhancer = {
        initialize: function() { this.setupCommunication(); this.setupAnswerListeners(); this.interceptSubmit(); },
        setupCommunication: function() {
            this.parentWindow = window.opener || window.parent;
            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'INIT_SESSION') {
                    this.sessionId = event.data.data.sessionId;
                    this.sendMessage('SESSION_READY', { pageType: this.detectPageType(), url: window.location.href });
                }
            });
        },
        detectPageType: () => document.title.includes('P1') ? 'P1' : 'unknown',
        setupAnswerListeners: function() {
            this.answers = {};
            this.startTime = Date.now();
            document.addEventListener('input', (e) => {
                if (e.target.name && e.target.name.startsWith('q')) {
                    this.answers[e.target.name] = e.target.value;
                }
            });
        },
        interceptSubmit: function() { if (typeof window.grade === 'function') { const originalGrade = window.grade; window.grade = () => { originalGrade(); setTimeout(() => this.handleSubmit(), 200); }; } },
        handleSubmit: function() {
            const results = {
                sessionId: this.sessionId,
                startTime: this.startTime,
                endTime: Date.now(),
                duration: Math.round((Date.now() - this.startTime) / 1000),
                answers: this.answers,
                scoreInfo: this.extractScore(),
                pageType: this.detectPageType(),
                url: window.location.href
            };
            this.sendMessage('PRACTICE_COMPLETE', results);
        },
        extractScore: function() {
            const resultsEl = document.getElementById('results');
            if (!resultsEl) return null;
            const text = resultsEl.textContent || '';
            const scoreMatch = text.match(/Score:\s*(\d+)\/(\d+)/i);
            if (scoreMatch) {
                const correct = parseInt(scoreMatch[1], 10);
                const total = parseInt(scoreMatch[2], 10);
                return { correct, total, accuracy: total > 0 ? correct / total : 0, percentage: total > 0 ? Math.round((correct / total) * 100) : 0, source: 'inline_extraction' };
            }
            return null;
        },
        sendMessage: function(type, data) { if (this.parentWindow && this.parentWindow !== window) { this.parentWindow.postMessage({ type, data, source: 'practice_page' }, '*'); } }
    };
    window.practicePageEnhancer.initialize();
}
</script>

</body>
</html>