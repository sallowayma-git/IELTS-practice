<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P1 – The Blockbuster Phenomenon</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root { --line:#e5e7eb; --bg:#f6f7fb; --panel:#fff; --accent:#3b82f6; --muted:#6b7280; --shadow:0 6px 20px rgba(0,0,0,.12); }
  * { box-sizing: border-box; }
  html,body { height:100%; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); padding-bottom: 82px; }
  #timer { position: static; display: inline-block; margin-left: 8px; background:#fff; border:1px solid var(--line); border-radius:10px; padding:2px 8px; font-size:14px; vertical-align: middle; }
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:var(--panel); overflow:auto; padding:20px; }
  #left { flex: 0 0 50%; min-width: 280px; }
  #right { flex: 1 1 auto; min-width: 320px; background:#fbfbff; border-left:1px solid var(--line); }
  #divider { flex: 0 0 8px; background: linear-gradient(90deg,#e5e7eb,#d1d5db); cursor: ew-resize; position:relative; z-index: 5; user-select:none; }
  h2,h3,h4 { margin:0 0 10px; }
  #left p { margin: 0 0 12px; line-height: 1.6; word-break: normal; overflow-wrap: normal; hyphens: none; }
  .group { background:#fff; border:1px solid var(--line); border-radius:10px; padding:12px; margin-bottom:14px; }
  input.blank { border:none; border-bottom:1px solid #9ca3af; padding:2px 4px; font-size:1em; background:transparent; }
  input.blank:focus { outline:none; border-bottom:2px solid var(--accent); }
  button { padding:8px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; cursor:pointer; }
  button.primary { background:var(--accent); color:#fff; border-color:#3b82f6; }
  #results { background:#fff; border:1px solid var(--line); border-radius:10px; padding:10px; }
  .hl { background:#fff3a3; box-shadow: inset 0 -2px 0 rgba(0,0,0,.05); cursor: pointer; }
  .hl:hover { filter: brightness(0.98); }
  #selbar { position: absolute; display:none; z-index: 2000; background:#111; color:#fff; border-radius: 8px; padding: 6px; box-shadow: var(--shadow); font-size: 13px; gap:6px; align-items: center; }
  #selbar button { background: transparent; color:#fff; border: 1px solid rgba(255,255,255,.25); padding: 4px 8px; border-radius: 6px; cursor:pointer; }
  #selbar button:hover { border-color:#fff; }
  #notes { position: fixed; right: 12px; bottom: 12px; width: 320px; height: 42vh; background:#fff; border:1px solid var(--line); border-radius: 12px; display:none; flex-direction: column; z-index:1500; box-shadow: var(--shadow); }
  #notes header { display:flex; align-items:center; justify-content: space-between; padding:8px 10px; border-bottom:1px solid var(--line); }
  #notes textarea { flex:1; border:0; padding:10px; resize:none; font-size:14px; line-height:1.5; }
  #toast { position: fixed; left:50%; transform: translateX(-50%); bottom: 24px; background:#111; color:#fff; padding:8px 12px; border-radius: 8px; display:none; z-index:2500; }
  details.answerbox summary { cursor: pointer; user-select:none; list-style: none; }
  details.answerbox { border:1px dashed var(--line); border-radius:10px; padding:8px 10px; background:#fff; }
  .badge { display:inline-block; background:#eef2ff; color:#4338ca; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:6px; }
  .practice-nav { background:#fff; border-bottom:2px solid var(--line); padding:12px 20px; display:flex; align-items:center; gap:20px; box-shadow:0 2px 4px rgba(0,0,0,.05); flex-wrap:wrap; position:fixed; left:0; right:0; bottom:0; border-top:2px solid var(--line); border-bottom:0; z-index:4000; }
  .practice-nav .title { font-weight:600; color:var(--muted); }
  .practice-nav .questions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .practice-nav .q-item { padding:6px 10px; border:1px solid var(--line); border-radius:6px; background:#fff; cursor:pointer; font-size:14px; transition:all 0.2s; min-width:36px; text-align:center; }
  .practice-nav .q-item:hover { background:#f1f5f9; border-color:var(--accent); }
  .practice-nav .q-item.answered { background:#e0e7ff; border-color:var(--accent); color:var(--accent); font-weight:500; }
  .practice-nav .q-item.active { background:var(--accent); color:#fff; border-color:var(--accent); }
  #selbar { z-index: 6000 !important; }
</style>
</head>
<body>

<div class="practice-nav">
  <div class="title">Questions</div>
  <div class="questions">
    <div class="q-item" id="q1-nav" onclick="scrollToElement('q1-anchor')">1</div>
    <div class="q-item" id="q2-nav" onclick="scrollToElement('q2-anchor')">2</div>
    <div class="q-item" id="q3-nav" onclick="scrollToElement('q3-anchor')">3</div>
    <div class="q-item" id="q4-nav" onclick="scrollToElement('q4-anchor')">4</div>
    <div class="q-item" id="q5-nav" onclick="scrollToElement('q5-anchor')">5</div>
    <div class="q-item" id="q6-nav" onclick="scrollToElement('q6-anchor')">6</div>
    <div class="q-item" id="q7-nav" onclick="scrollToElement('q7-anchor')">7</div>
    <div class="q-item" id="q8-nav" onclick="scrollToElement('q8-anchor')">8</div>
    <div class="q-item" id="q9-nav" onclick="scrollToElement('q9-anchor')">9</div>
    <div class="q-item" id="q10-nav" onclick="scrollToElement('q10-anchor')">10</div>
    <div class="q-item" id="q11-nav" onclick="scrollToElement('q11-anchor')">11</div>
    <div class="q-item" id="q12-nav" onclick="scrollToElement('q12-anchor')">12</div>
    <div class="q-item" id="q13-nav" onclick="scrollToElement('q13-anchor')">13</div>
  </div>
</div>

<div class="shell">
  <section class="pane" id="left">
    <h2>READING PASSAGE 1 <span id="timer">00:00</span></h2>
    <p>You should spend about 20 minutes on Questions 1–13, which are based on Reading Passage 1 below.</p>
    
    <h3>The Blockbuster Phenomenon: A New Museum Trend</h3>
    <p>Museums in Australia, like other pleasure-giving public organizations, are adapting their activities so that they more closely reflect the marketplace.</p>
    
    <h4>A</h4>
    <p>Since the 1980s, the term ‘blockbuster' has become the fashionable word for spectacular, high-profile museum exhibitions that have the ability to attract large crowds. A blockbuster is a 'large-scale loan exhibition that people who normally don't go to museums will stand in line for hours to see' (Eisen 1984). Once the museum that created the exhibition has shown it to its local market, it can be offered to other organizations for a fee. This means that you can boost your own door takings and make money from boosting someone else's door takings.</p>
    
    <h4>B</h4>
    <p>While partaking of the excitement of the blockbuster, visitors thus lured are likely to stay longer at the museum. Betty Churcher, when Director of the Australian National Gallery, summed up the new blockbuster creed as follows: 'The bonus of the blockbuster exhibitions is that people come to see the blockbuster and they stay to look at the permanent collection, so you are getting broader exposure for your collection.'</p>
    
    <h4>C</h4>
    <p>Museums across the UK, USA, Canada and Australia currently operate under a system of plural funding: revenue raised through contributions by federal, state and/or local governments, combined with revenue raised through admission charges and other activities. Maintaining and increasing visitor levels is thus paramount and involves not only creating or hiring blockbuster exhibitions, but providing regular exhibition changes and innovations. In addition, the visiting public have become known as customers rather than visitors, and the skills that are valued in museums to keep the new customers coming through the door have changed. Curators are now administrators, and being a museum director no longer requires an Arts degree—but public relations skills are essential if the museum is going to compete with other museums to stage travelling exhibitions which draw huge crowds.</p>
    
    <h4>D</h4>
    <p>The convergence of museums, the heritage industry, tourism, profit-making and pleasure-giving has resulted in the new 'museology'. This has given rise to much debate about whether it is appropriate to see museums primarily as tourist attractions. In literature from both the UK and USA, the words that are starting to appear in some descriptions of blockbusters are ‘less scholarly', 'non-elitist' and 'popularist', while others extol the virtues of encouraging scholars to co-operate on projects, and to provide exhibitions that cater for a broad selection of the community rather than an elite sector. Whatever commentators may think, managers of museums worldwide are looking for artful ways to blend culture and commerce, and blockbuster exhibitions are at the top of the list.</p>
    
    <h4>E</h4>
    <p>But do blockbusters held in public institutions really create a surplus to fund other activities? If the bottom line is profit, then according to the records of many major museums blockbusters do make money. For museums in some countries, it may be the money that they require to replace parts of their collections or to fix buildings that are in need of attention. For some museums in Australia, it may be the opportunity to illustrate that they are attempting to pay their way by recovering part of their operating costs. Also, creating or hiring a blockbuster has many positive spin-offs: blockbusters mean crowds, and crowds are good for the local economy, providing increased trade for shops, hotels, restaurants, the transport industry and retailers. The argument that the arts provide sustained economic benefits has been well illustrated in impact studies in the USA and UK.</p>
    
    <h4>F</h4>
    <p>However, blockbusters require large capital expenditure and draw on resources across all branches of an organization, and the costs don't end there. There is a Human Resource Management cost in addition to a measurable 'real' dollar cost. Receiving a touring exhibition draws resources from across functional management structures in a project-management style. Everyone—from general labourers to building services, front-of-house, technical, promotional, educational and administrative staff—is required to perform additional tasks. Furthermore, as an increasing number of institutions try their hand at increasing visitor numbers and memberships (and therefore revenue) by staging blockbuster exhibitions, it may be less likely that blockbusters will continue to provide a surplus to subsidize other activities due to the competitive nature of the market.</p>
    
    <h4>G</h4>
    <p>It has been illustrated in both the UK and USA that the blockbuster ideology has resulted in the false expectation that the momentum required to stage blockbusters can be maintained continually. Creating, mounting or hiring blockbusters is exhausting, with the real costs throughout an institution difficult to calculate. Secondly, as some analysts have argued, the 'shopkeeping' mentality and cost-benefit analysis, and a pure concentration on the bottom line, can squeeze substance out of an exhibition. Taking out substance can be a recipe for blockbuster failure and therefore financial failure.</p>
    
    <h4>Η</h4>
    <p>Perhaps the best pathway to take is one that balances both blockbusters and regular exhibitions. However, this easy middle ground may only work if you have enough space, and have alternative sources of funding to continue to support the regular, less exciting fare. Perhaps the advice should be to make sure that you find out what your local community wants from you and make sure that your regular activities and exhibitions are more enduring.</p>
    
    <p>&nbsp;</p>
  </section>
  <div id="divider" title="Drag to resize"></div>
  <section class="pane" id="right">
    <h3>Questions</h3>
    
    <div class="group">
      <h4>Questions 1–4</h4>
      <p>Reading Passage 1 has eight paragraphs, A–H.</p>
      <p>Which paragraph contains the following information?</p>
      <p>Write the correct letter, A–H, in boxes 1–4 on your answer sheet.</p>
      <p>NB You may use any letter more than once.</p>
      
      <a id="q1-anchor"></a>
      <div id="q1-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>1 the reason why museum directors need to constantly alter and update their exhibits</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label><input name="q1" type="radio" value="A"> A</label> <label><input name="q1" type="radio" value="B"> B</label> <label><input name="q1" type="radio" value="C"> C</label> <label><input name="q1" type="radio" value="D"> D</label> <label><input name="q1" type="radio" value="E"> E</label> <label><input name="q1" type="radio" value="F"> F</label> <label><input name="q1" type="radio" value="G"> G</label> <label><input name="q1" type="radio" value="H"> H</label>
        </div>
      </div>
      
      <a id="q2-anchor"></a>
      <div id="q2-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>2 mention of the length of time people will queue to see a blockbuster</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label><input name="q2" type="radio" value="A"> A</label> <label><input name="q2" type="radio" value="B"> B</label> <label><input name="q2" type="radio" value="C"> C</label> <label><input name="q2" type="radio" value="D"> D</label> <label><input name="q2" type="radio" value="E"> E</label> <label><input name="q2" type="radio" value="F"> F</label> <label><input name="q2" type="radio" value="G"> G</label> <label><input name="q2" type="radio" value="H"> H</label>
        </div>
      </div>
      
      <a id="q3-anchor"></a>
      <div id="q3-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>3 terms that people have used when referring to blockbusters</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label><input name="q3" type="radio" value="A"> A</label> <label><input name="q3" type="radio" value="B"> B</label> <label><input name="q3" type="radio" value="C"> C</label> <label><input name="q3" type="radio" value="D"> D</label> <label><input name="q3" type="radio" value="E"> E</label> <label><input name="q3" type="radio" value="F"> F</label> <label><input name="q3" type="radio" value="G"> G</label> <label><input name="q3" type="radio" value="H"> H</label>
        </div>
      </div>
      
      <a id="q4-anchor"></a>
      <div id="q4-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>4 the various ways that institutions like museums get financial support</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label><input name="q4" type="radio" value="A"> A</label> <label><input name="q4" type="radio" value="B"> B</label> <label><input name="q4" type="radio" value="C"> C</label> <label><input name="q4" type="radio" value="D"> D</label> <label><input name="q4" type="radio" value="E"> E</label> <label><input name="q4" type="radio" value="F"> F</label> <label><input name="q4" type="radio" value="G"> G</label> <label><input name="q4" type="radio" value="H"> H</label>
        </div>
      </div>
    </div>
    
    <div class="group">
      <h4>Questions 5–8</h4>
      <p>Complete the sentences below.</p>
      <p>Choose <strong>NO MORE THAN THREE WORDS</strong> from the passage for each answer.</p>
      
      <a id="q5-anchor"></a><p style="margin-top:1em;">5 These days, museum visitors tend to be referred to as <input name="q5" type="text" class="blank" maxlength="40"></p>
      <a id="q6-anchor"></a><p>6 Museum curators now need <input name="q6" type="text" class="blank" maxlength="40"> rather than academic qualifications.</p>
      <a id="q7-anchor"></a><p>7 The linking of a range of public institutions that entertain the public is known as <input name="q7" type="text" class="blank" maxlength="40">.</p>
      <a id="q8-anchor"></a><p>8 There is discussion about whether museums can be regarded in the same way as other <input name="q8" type="text" class="blank" maxlength="40">.</p>
    </div>

    <div class="group">
      <a id="q9-anchor"></a><a id="q10-anchor"></a>
      <h4>Questions 9 and 10</h4>
      <p>Choose <strong>TWO</strong> letters, A–E.</p>
      <p>Which <strong>TWO</strong> of the following are mentioned by the writer as advantages of blockbusters?</p>
      <div style="margin-top:1em;">
        <label style="display:block; margin:4px 0;"><input type="checkbox" name="q9-10" value="A"> A Some of the money they raise can be used for structural repairs.</label>
        <label style="display:block; margin:4px 0;"><input type="checkbox" name="q9-10" value="B"> B They can provide funds to help support amateur artists.</label>
        <label style="display:block; margin:4px 0;"><input type="checkbox" name="q9-10" value="C"> C Local services benefit from the extra business they bring about.</label>
        <label style="display:block; margin:4px 0;"><input type="checkbox" name="q9-10" value="D"> D They encourage overseas workers into the local area.</label>
        <label style="display:block; margin:4px 0;"><input type="checkbox" name="q9-10" value="E"> E They raise employee performance levels.</label>
      </div>
    </div>

    <div class="group">
      <a id="q11-anchor"></a><a id="q12-anchor"></a><a id="q13-anchor"></a>
      <h4>Questions 11–13</h4>
      <p>Choose <strong>THREE</strong> letters, A–G.</p>
      <p>Which <strong>THREE</strong> of the following are mentioned by the writer as disadvantages of blockbusters?</p>
      <div style="margin-top:1em;">
        <label style="display:block; margin:4px 0;"><input type="checkbox" name="q11-13" value="A"> A They do not suit museum management styles.</label>
        <label style="display:block; margin:4px 0;"><input type="checkbox" name="q11-13" value="B"> B Specialist business advice has to be paid for.</label>
        <label style="display:block; margin:4px 0;"><input type="checkbox" name="q11-13" value="C"> C They involve an increased workload for personnel.</label>
        <label style="display:block; margin:4px 0;"><input type="checkbox" name="q11-13" value="D"> D They do not increase overall annual visitor numbers.</label>
        <label style="display:block; margin:4px 0;"><input type="checkbox" name="q11-13" value="E"> E They are very tiring to put on.</label>
        <label style="display:block; margin:4px 0;"><input type="checkbox" name="q11-13" value="F"> F What is popular in one country may not be popular in another.</label>
        <label style="display:block; margin:4px 0;"><input type="checkbox" name="q11-13" value="G"> G The content can be weakened through financial pressure.</label>
      </div>
    </div>
    
    <div style="display:flex;gap:8px;margin-bottom:10px;">
      <button class="primary" onclick="grade()">Submit</button>
      <button onclick="resetForm()">Reset</button>
      <button onclick="toggleNotes()">Notes</button>
    </div>
    <div id="results"></div>
    <details class="answerbox" id="answerBox">
      <summary>Show answers (click to toggle) <span class="badge">hidden</span></summary>
      <div id="answerContent"></div>
    </details>
  </section>
</div>

<div aria-label="Selection tools" id="selbar" role="toolbar">
  <button id="btnHL">Highlight</button>
  <button id="btnUH">Remove</button>
  <button id="btnNote">Note</button>
</div>
<div id="notes">
  <header>
    <strong>Notes</strong>
    <div>
      <button id="btnCopy">Copy</button>
      <button id="btnClose">Close</button>
    </div>
  </header>
  <textarea id="noteArea" placeholder="Type your notes here..."></textarea>
</div>
<div id="toast"></div>

<script>
// Timer
let _t=0; const _timerEl=document.getElementById('timer');
setInterval(function(){ 
  _t++; 
  var m=String(Math.floor(_t/60)).padStart(2,'0'); 
  var s=String(_t%60).padStart(2,'0'); 
  _timerEl.textContent=m+':'+s; 
},1000);
// Drag divider
var divider = document.getElementById('divider');
var left = document.getElementById('left');
var right = document.getElementById('right');
var dragging=false;
function startDrag(e){ 
  dragging=true; 
  document.body.style.cursor='ew-resize'; 
  if(e.preventDefault) e.preventDefault(); 
}
function endDrag(){ 
  dragging=false; 
  document.body.style.cursor=''; 
}
function onMove(clientX){
  var container = document.querySelector('.shell').getBoundingClientRect();
  var x = clientX - container.left;
  x = Math.max(280, Math.min(container.width-320, x));
  left.style.flex = '0 0 ' + x + 'px';
  right.style.flex = '1 1 auto';
}
divider.addEventListener('mousedown', function(e){ startDrag(e); });
window.addEventListener('mousemove', function(e){ if(dragging) onMove(e.clientX); });
window.addEventListener('mouseup', endDrag);
divider.addEventListener('touchstart', function(e){ startDrag(e.touches[0]); }, {passive:false});
window.addEventListener('touchmove', function(e){ if(dragging) onMove(e.touches[0].clientX); }, {passive:false});
window.addEventListener('touchend', endDrag);
// Highlight toolbar
var selbar = document.getElementById('selbar');
var btnHL = document.getElementById('btnHL');
var btnUH = document.getElementById('btnUH');
var btnNote = document.getElementById('btnNote');
var lastRange=null;
var currentHlNode=null;
var keepToolbar=false;
function positionSelbarForRect(rect){
  selbar.style.display='flex';
  requestAnimationFrame(function(){
    var top = window.scrollY + rect.top - selbar.offsetHeight - 8;
    var leftPos = window.scrollX + rect.left + rect.width/2 - selbar.offsetWidth/2;
    selbar.style.top = ((top>0)?top:(window.scrollY + rect.bottom + 8)) + 'px';
    selbar.style.left = Math.max(8, leftPos) + 'px';
  });
}
function updateSelbar(){
  var sel=window.getSelection();
  if(!sel || sel.rangeCount===0 || sel.isCollapsed) { 
    selbar.style.display='none'; 
    currentHlNode=null; 
    return; 
  }
  var range = sel.getRangeAt(0);
  lastRange = range.cloneRange();
  currentHlNode=null;
  positionSelbarForRect(range.getBoundingClientRect());
}
document.getElementById('left').addEventListener('mouseup', updateSelbar);
document.getElementById('right').addEventListener('mouseup', updateSelbar);
document.addEventListener('selectionchange', function(){ 
  var sel=window.getSelection(); 
  if(!sel || sel.rangeCount===0 || sel.isCollapsed){ 
    if(!keepToolbar && !currentHlNode){ 
      selbar.style.display='none'; 
    } 
  } 
});
document.addEventListener('scroll', function(){ 
  if(selbar.style.display==='flex') updateSelbar(); 
});
document.addEventListener('mousedown', function(e){
  var t = e.target;
  if(t.classList && t.classList.contains('hl')){
    keepToolbar = true;
  } else {
    keepToolbar = false;
  }
}, true);
document.addEventListener('click', function(e){
  var target = e.target;
  if(target.classList && target.classList.contains('hl')){
    currentHlNode = target;
    lastRange = null;
    positionSelbarForRect(target.getBoundingClientRect());
    var sel=window.getSelection();
    if(sel) sel.removeAllRanges();
    setTimeout(function(){ keepToolbar=false; }, 0);
  }
}, true);
function doHighlight(){
  if(currentHlNode) return;
  if(!lastRange || lastRange.collapsed) return;
  var span=document.createElement('span'); span.className='hl';
  try { lastRange.surroundContents(span); }
  catch(e){
    var wrap=document.createElement('span'); wrap.className='hl';
    wrap.appendChild(lastRange.cloneContents());
    lastRange.deleteContents();
    lastRange.insertNode(wrap);
  }
  selbar.style.display='none';
  showToast('Highlighted');
}
function removeHighlight(){
  if(currentHlNode){
    var p = currentHlNode.parentNode;
    while(currentHlNode.firstChild) p.insertBefore(currentHlNode.firstChild, currentHlNode);
    p.removeChild(currentHlNode); p.normalize();
    currentHlNode = null;
    selbar.style.display='none';
    showToast('Highlight removed');
    return;
  }
  if(!lastRange) return;
  var selRect = lastRange.getBoundingClientRect();
  var walker=document.createTreeWalker(document.body, NodeFilter.SHOW_ELEMENT);
  var toRemove=[];
  while(walker.nextNode()){
    var n=walker.currentNode;
    if(n.classList && n.classList.contains('hl')) {
      var r = n.getBoundingClientRect();
      if(!(r.right < selRect.left || r.left > selRect.right || r.bottom < selRect.top || r.top > selRect.bottom)) toRemove.push(n);
    }
  }
  toRemove.forEach(function(el){ var p=el.parentNode; while(el.firstChild) p.insertBefore(el.firstChild, el); p.removeChild(el); p.normalize(); });
  selbar.style.display='none';
  showToast('Highlight removed');
}
btnHL.addEventListener('click', doHighlight);
btnUH.addEventListener('click', removeHighlight);
// Notes
var notes = document.getElementById('notes');
var noteArea = document.getElementById('noteArea');
var btnCopy=document.getElementById('btnCopy');
var btnClose=document.getElementById('btnClose');
function toggleNotes(){ 
  notes.style.display = (notes.style.display==='flex'?'none':'flex'); 
}
window.toggleNotes = toggleNotes;
btnClose.addEventListener('click', toggleNotes);
btnCopy.addEventListener('click', async function(){ 
  await navigator.clipboard.writeText(noteArea.value||''); 
  showToast('Copied'); 
});
btnNote.addEventListener('click', function(){
  var text = '';
  if(currentHlNode){ text = (currentHlNode.textContent||'').trim(); }
  else if(lastRange){ var frag = lastRange.cloneContents(); text = (frag.textContent||'').trim(); }
  toggleNotes();
  if(text) noteArea.value = (noteArea.value? noteArea.value+'\n':'') + '> ' + text + '\n';
  selbar.style.display='none';
});
// Toast
var toastEl=document.getElementById('toast');
function showToast(msg){
  toastEl.textContent=msg; 
  toastEl.style.display='block';
  setTimeout(function(){ toastEl.style.display='none'; }, 1200);
}
// Answer key and grading
var answers = {
  q1: "C", q2: "A", q3: "D", q4: "C",
  q5: "customers", q6: "public relations skills", q7: "museology", q8: "tourist attractions",
  "q9-10": ["A", "C"],
  "q11-13": ["C", "E", "G"]
};
function arraysEqual(a, b) {
  if (a === b) return true;
  if (a == null || b == null) return false;
  if (a.length !== b.length) return false;
  a.sort(); b.sort();
  for (var i = 0; i < a.length; ++i) {
    if (a[i] !== b[i]) return false;
  }
  return true;
}
function grade(){
  var total=0, correct=0, lines=[];
  function push(q, ok, user){
    total++; if(ok) correct++;
    lines.push(q.toUpperCase()+": "+(user||'None')+" "+(ok?'✅':'❌'));
  }
  // 1–4 matching info
  for(var n=1;n<=4;n++){
    var sel=document.querySelector('input[name="q'+n+'"]:checked');
    var val=sel?sel.value:'';
    push('q'+n, val === answers['q'+n], val);
  }
  // 5-8 sentence completion
  for(var n=5;n<=8;n++){
    var el=document.querySelector('input[name="q'+n+'"]');
    var val=el?el.value.trim().toLowerCase():'';
    push('q'+n, val === answers['q'+n], val);
  }
  // 9-10 (Choose 2)
  var user_q9_10 = [];
  document.querySelectorAll('input[name="q9-10"]:checked').forEach(el => user_q9_10.push(el.value));
  var ok_q9_10 = arraysEqual(user_q9_10, answers['q9-10']);
  push('Q9-10', ok_q9_10, user_q9_10.join(', '));
  // 11-13 (Choose 3)
  var user_q11_13 = [];
  document.querySelectorAll('input[name="q11-13"]:checked').forEach(el => user_q11_13.push(el.value));
  var ok_q11_13 = arraysEqual(user_q11_13, answers['q11-13']);
  push('Q11-13', ok_q11_13, user_q11_13.join(', '));
  
  var acc = (total? Math.round(100*correct/total):0);
  var html = '<p><strong>Score:</strong> '+correct+'/'+(total-2+13-8)+' <span class="badge">Accuracy '+acc+'%</span></p>'; // Adjust total count
  html += '<pre>'+lines.join('\n')+'</pre>';
  document.getElementById('results').innerHTML = html;
  
  var ahtml = '<ol>';
  ahtml += '<li>C</li><li>A</li><li>D</li><li>C</li>';
  ahtml += '<li>customers</li><li>public relations skills</li><li>museology</li><li>tourist attractions</li>';
  ahtml += '<li>& 10. A, C</li><li>& 12. & 13. C, E, G</li>';
  ahtml = ahtml.replace('<li>& 10. A, C</li>', '<li>A (in any order)</li><li>C (in any order)</li>');
  ahtml = ahtml.replace('<li>& 12. & 13. C, E, G</li>', '<li>C (in any order)</li><li>E (in any order)</li><li>G (in any order)</li>');
  ahtml += '</ol>';
  document.getElementById('answerContent').innerHTML = ahtml;
  document.querySelector('#answerBox .badge').textContent='tap to view';
}
function resetForm(){
  document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(el=>el.checked=false);
  document.querySelectorAll('input[type="text"]').forEach(el=>el.value="");
  document.getElementById('results').innerHTML='';
  document.getElementById('answerContent').innerHTML='';
  document.querySelector('#answerBox .badge').textContent = 'hidden';
  document.querySelectorAll('.q-item').forEach(item => item.classList.remove('answered'));
}
function scrollToElement(id){
  var el = document.getElementById(id);
  if(el){ 
    el.scrollIntoView({behavior:'smooth', block:'center'}); 
  }
  var navs = document.querySelectorAll('.practice-nav .q-item');
  navs.forEach(n => n.classList.remove('active'));
  var btn = document.getElementById(id.replace('-anchor','-nav'));
  if(btn){ 
    btn.classList.add('active'); 
    setTimeout(() => btn.classList.remove('active'), 800); 
  }
}
(function(){
  function mark(qn, isMulti=false, groupName=''){
    var navId = `q${qn}-nav`;
    var nav = document.getElementById(navId);
    if(!nav && isMulti) {
        // For multi-questions like 9-10, mark both nav items
        const ids = groupName.match(/\d+/g);
        ids.forEach(id => mark(id, false)); // Call recursively for each question in the group
        return;
    }
    if(!nav) return;
    
    var answered = false;
    if (isMulti) {
        answered = document.querySelectorAll(`input[name="${groupName}"]:checked`).length > 0;
    } else {
        var radios = document.querySelectorAll(`input[name="q${qn}"]`);
        var text = document.querySelector(`input[name="q${qn}"].blank`);
        if(radios.length){ radios.forEach(function(r){ if(r.checked) answered=true; }); }
        if(text){ answered = answered || (text.value && text.value.trim().length>0); }
    }

    if(answered) nav.classList.add('answered'); else nav.classList.remove('answered');
  }
  for(var q=1;q<=8;q++){
    (function(n){
      document.querySelectorAll(`input[name="q${n}"]`).forEach(function(r){ r.addEventListener('change', function(){ mark(n); }); });
      var text = document.querySelector(`input[name="q${n}"].blank`);
      if(text){ text.addEventListener('input', function(){ mark(n); }); }
    })(q);
  }
  document.querySelectorAll('input[name="q9-10"]').forEach(el => el.addEventListener('change', () => mark(9, true, 'q9-10')));
  document.querySelectorAll('input[name="q11-13"]').forEach(el => el.addEventListener('change', () => mark(11, true, 'q11-13')));
})();
</script>

<!-- 练习页面数据传输增强脚本 -->
<script>
if (!window.practicePageEnhancer) {
    const script = document.createElement('script');
    script.src = '../../js/practice-page-enhancer.js';
    script.onload = function() { console.log('练习页面增强脚本已加载'); };
    script.onerror = function() { console.error('练习页面增强脚本加载失败'); loadInlineEnhancer(); };
    document.head.appendChild(script);
}
function loadInlineEnhancer() {
    if (window.practicePageEnhancer) return;
    window.practicePageEnhancer = {
        initialize: function() {
            this.setupCommunication();
            this.setupAnswerListeners();
            this.interceptSubmit();
        },
        setupCommunication: function() {
            this.parentWindow = window.opener || window.parent;
            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'INIT_SESSION') {
                    this.sessionId = event.data.data.sessionId;
                    this.sendMessage('SESSION_READY', { pageType: this.detectPageType(), url: window.location.href });
                }
            });
        },
        detectPageType: function() {
            const title = document.title || '';
            if (title.includes('P1')) return 'P1';
            if (title.includes('P2')) return 'P2';
            if (title.includes('P3')) return 'P3';
            return 'unknown';
        },
        setupAnswerListeners: function() {
            this.answers = {};
            this.startTime = Date.now();
            document.addEventListener('change', (e) => {
                if (e.target.name) {
                    if (e.target.type === 'checkbox') {
                        if (!this.answers[e.target.name]) this.answers[e.target.name] = [];
                        if (e.target.checked) {
                            this.answers[e.target.name].push(e.target.value);
                        } else {
                            this.answers[e.target.name] = this.answers[e.target.name].filter(v => v !== e.target.value);
                        }
                    } else {
                        this.answers[e.target.name] = e.target.value;
                    }
                }
            });
        },
        interceptSubmit: function() {
            if (typeof window.grade === 'function') {
                const originalGrade = window.grade;
                window.grade = () => {
                    const result = originalGrade();
                    setTimeout(() => this.handleSubmit(), 200);
                    return result;
                };
            }
        },
        handleSubmit: function() {
            const results = {
                sessionId: this.sessionId,
                startTime: this.startTime,
                endTime: Date.now(),
                duration: Math.round((Date.now() - this.startTime) / 1000),
                answers: this.answers,
                scoreInfo: this.extractScore(),
                pageType: this.detectPageType(),
                url: window.location.href
            };
            this.sendMessage('PRACTICE_COMPLETE', results);
        },
        extractScore: function() {
            const resultsEl = document.getElementById('results');
            if (!resultsEl) return null;
            const text = resultsEl.textContent || '';
            const scoreMatch = text.match(/Score:\s*(\d+)\/(\d+)/i);
            if (scoreMatch) {
                const correct = parseInt(scoreMatch[1]);
                const total = parseInt(scoreMatch[2]);
                return { correct: correct, total: total, accuracy: total > 0 ? correct / total : 0, percentage: Math.round((correct / total) * 100), source: 'inline_extraction' };
            }
            return null;
        },
        sendMessage: function(type, data) {
            if (this.parentWindow) {
                this.parentWindow.postMessage({ type: type, data: data, source: 'practice_page' }, '*');
            }
        }
    };
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => { window.practicePageEnhancer.initialize(); });
    } else {
        window.practicePageEnhancer.initialize();
    }
}
</script>

</body>
</html>