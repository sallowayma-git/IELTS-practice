<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>P1 – Rubber (Fixed & Optimized with Enhancer)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root { 
    --line: #e5e7eb; 
    --bg: #f6f7fb; 
    --panel: #fff; 
    --accent: #3b82f6; 
    --muted: #6b7280; 
    --shadow: 0 6px 20px rgba(0,0,0,.12); 
  }
  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body { 
    margin: 0; 
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; 
    background: var(--bg); 
    padding-bottom: 82px; 
  }
  
  /* 布局样式 */
  .shell { display: flex; height: 100vh; width: 100%; }
  .pane { background: var(--panel); overflow: auto; padding: 20px; }
  #left { flex: 0 0 50%; min-width: 280px; }
  #right { flex: 1 1 auto; min-width: 320px; background: #fbfbff; border-left: 1px solid var(--line); }
  #divider { flex: 0 0 8px; background: linear-gradient(90deg, #e5e7eb, #d1d5db); cursor: ew-resize; position: relative; z-index: 5; user-select: none; }
  
  /* 文本样式 */
  h2, h3, h4 { margin: 0 0 10px; }
  #left p { margin: 0 0 12px; line-height: 1.6; word-break: normal; overflow-wrap: normal; hyphens: none; }
  
  /* 组件样式 */
  .group { background: #fff; border: 1px solid var(--line); border-radius: 10px; padding: 12px; margin-bottom: 14px; }
  input.blank { 
    border: none; 
    border-bottom: 1px solid #9ca3af; 
    padding: 2px 4px; 
    font-size: 1em; 
    background: transparent; 
    min-width: 80px;
  }
  input.blank:focus { outline: none; border-bottom: 2px solid var(--accent); }
  table { border-collapse: collapse; width: 100%; margin-bottom: 12px; }
  th, td { border: 1px solid var(--line); padding: 8px; text-align: left; }
  
  /* 按钮样式 */
  button { 
    padding: 8px 12px; 
    border: 1px solid var(--line); 
    background: #fff; 
    border-radius: 6px; 
    cursor: pointer; 
    transition: all 0.2s; 
    font-size: 14px; 
  }
  button:hover { background: #f8fafc; border-color: #cbd5e1; }
  button.primary { 
    background: var(--accent); 
    color: #fff; 
    border-color: var(--accent); 
  }
  button.primary:hover { background: #2563eb; }
  
  /* 计时器样式 */
  #timer { 
    background: #fff; 
    color: var(--muted); 
    border: 1px solid var(--line); 
    border-radius: 6px; 
    padding: 6px 12px; 
    cursor: pointer; 
    font-family: 'Courier New', monospace; 
    transition: all 0.2s; 
    min-width: 70px;
    text-align: center;
    font-size: 18px;
    font-weight: bold;
  }
  #timer:hover { 
    background: #f1f5f9; 
    border-color: var(--accent); 
  }
  #timer.paused { 
    color: #ef4444; 
    border-color: #fecaca; 
    background: #fef2f2; 
  }
  
  /* 主题切换按钮 */
  .theme-toggle { 
    background: #fff; 
    color: var(--muted); 
    border: 1px solid var(--line); 
    border-radius: 6px; 
    width: 36px;
    height: 36px;
    font-size: 16px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .theme-toggle:hover {
    background: var(--accent);
    color: #fff;
    border-color: var(--accent);
    transform: scale(1.05);
  }
  
  /* 深色模式样式 */
  body.dark { 
    --bg: #0f172a; 
    --panel: #1e293b; 
    --line: #334155; 
    --muted: #94a3b8; 
    color: #e2e8f0; 
  }
  body.dark #right { background: #0f172a; }
  body.dark .group { background: #1e293b; border-color: #334155; }
  body.dark button { background: #1e293b; color: #e2e8f0; border-color: #334155; }
  body.dark button:hover { background: #334155; }
  body.dark button.primary { background: var(--accent); color: #fff; }
  body.dark #results { background: #1e293b; border-color: #334155; }
  body.dark #notes { background: #1e293b; border-color: #334155; color: #e2e8f0; }
  body.dark .practice-nav { background: #1e293b; border-color: #334155; }
  body.dark .q-item { background: #0f172a; color: #e2e8f0; border-color: #334155; }
  body.dark .q-item:hover { background: #334155; }
  body.dark .q-item.answered { background: #1e40af; border-color: var(--accent); color: #93c5fd; }
  body.dark #timer { background: #1e293b; color: #e2e8f0; border-color: #334155; }
  body.dark #timer:hover { background: #334155; border-color: var(--accent); }
  body.dark details.answerbox { background: #1e293b; border-color: #334155; }
  body.dark input.blank { color: #e2e8f0; border-bottom-color: #64748b; }
  body.dark input.blank:focus { border-bottom-color: var(--accent); }
  body.dark table, body.dark th, body.dark td { border-color: var(--line); }

  /* 响应式设计 */
  @media (max-width: 768px) {
    .shell { flex-direction: column; }
    #left, #right { flex: none; min-width: auto; }
    #divider { display: none; }
    .practice-nav .controls { gap: 8px; }
    #timer { font-size: 12px; padding: 3px 8px; }
    .theme-toggle { width: 32px; height: 32px; font-size: 14px; }
    #notes { width: calc(100vw - 24px); right: 12px; left: 12px; }
  }
  
  /* 选择工具栏 */
  #selbar { 
    position: fixed; 
    display: none; 
    z-index: 2000; 
    background: #111; 
    color: #fff; 
    border-radius: 8px; 
    padding: 6px; 
    box-shadow: var(--shadow); 
    font-size: 13px; 
    gap: 6px; 
    align-items: center; 
  }
  #selbar button { 
    background: transparent; 
    color: #fff; 
    border: 1px solid rgba(255,255,255,.25); 
    padding: 4px 8px; 
    border-radius: 6px; 
    cursor: pointer; 
  }
  #selbar button:hover { border-color: #fff; }
  
  /* 笔记面板 */
  #notes { 
    position: fixed; 
    right: 12px; 
    bottom: 12px; 
    width: 320px; 
    height: 42vh; 
    background: #fff; 
    border: 1px solid var(--line); 
    border-radius: 12px; 
    display: none; 
    flex-direction: column; 
    z-index: 1500; 
    box-shadow: var(--shadow); 
  }
  #notes header { 
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
    padding: 8px 10px; 
    border-bottom: 1px solid var(--line); 
  }
  #notes textarea { 
    flex: 1; 
    border: 0; 
    padding: 10px; 
    resize: none; 
    font-size: 14px; 
    line-height: 1.5; 
  }
  
  /* Toast通知 */
  #toast { 
    position: fixed; 
    bottom: 20px; 
    left: 50%; 
    transform: translateX(-50%); 
    background: rgba(0,0,0,0.8); 
    color: #fff; 
    padding: 8px 16px; 
    border-radius: 4px; 
    display: none; 
    z-index: 3000; 
    font-size: 14px; 
  }
  
  /* 答题导航 */
  .practice-nav { 
    background: #fff; 
    padding: 12px 20px; 
    display: flex; 
    align-items: center; 
    gap: 16px; 
    box-shadow: 0 2px 4px rgba(0,0,0,.05); 
    flex-wrap: wrap; 
    position: fixed; 
    left: 0; 
    right: 0; 
    bottom: 0; 
    border-top: 2px solid var(--line); 
    z-index: 4000; 
  }
  .practice-nav .title { font-weight: 600; color: var(--muted); }
  .practice-nav .questions { 
    display: flex; 
    gap: 8px; 
    align-items: center; 
    flex-wrap: wrap; 
  }
  .practice-nav .q-item { 
    padding: 6px 10px; 
    border: 1px solid var(--line); 
    border-radius: 6px; 
    background: #fff; 
    cursor: pointer; 
    font-size: 14px; 
    transition: all 0.2s; 
    min-width: 36px; 
    text-align: center; 
  }
  .practice-nav .q-item:hover { 
    background: #f1f5f9; 
    border-color: var(--accent); 
  }
  .practice-nav .q-item.answered { 
    background: #e0e7ff; 
    border-color: var(--accent); 
    color: var(--accent); 
    font-weight: 500; 
  }
  .practice-nav .q-item.active { 
    background: var(--accent); 
    color: #fff; 
  }
  .practice-nav .controls { 
    display: flex; 
    gap: 12px; 
    margin-left: auto; 
    align-items: center; 
  }
  
  /* 答题结果显示 */
  #results { 
    background: #fff; 
    border: 1px solid var(--line); 
    border-radius: 10px; 
    padding: 12px; 
    margin: 16px 0; 
    font-family: monospace; 
    white-space: pre-wrap; 
  }
  #results p { margin: 0 0 8px; }
  .badge { 
    background: #e0e7ff; 
    color: var(--accent); 
    padding: 2px 8px; 
    border-radius: 999px; 
    font-size: 12px; 
  }
  
  /* 答案框 */
  details.answerbox { 
    background: #fff; 
    border: 1px solid var(--line); 
    border-radius: 10px; 
    padding: 12px; 
    margin-top: 10px; 
  }
  details.answerbox summary { 
    cursor: pointer; 
    font-weight: 600; 
    list-style: none; 
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
  }
  details.answerbox summary::-webkit-details-marker { display: none; }
  #answerContent { margin-top: 10px; }
  #answerContent ol { margin: 0; padding-left: 20px; }
  #answerContent li { margin: 4px 0; }
  
  /* 高亮样式 */
  .hl { background: #ffeb3b; color: #000; }
  body.dark .hl { background: #8a6d00; color: #fff; }
  
  /* 滚动条样式 */
  ::-webkit-scrollbar { width: 8px; height: 8px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #c5c5d2; border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: #999; }
  body.dark ::-webkit-scrollbar-thumb { background: #4a5568; }
  body.dark ::-webkit-scrollbar-thumb:hover { background: #718096; }
</style>
</head>
<body>

<div class="practice-nav">
  <div class="title">Questions</div>
  <div class="questions">
    <div class="q-item" id="q1-nav" onclick="scrollToElement('q1-anchor')">1</div>
    <div class="q-item" id="q2-nav" onclick="scrollToElement('q2-anchor')">2</div>
    <div class="q-item" id="q3-nav" onclick="scrollToElement('q3-anchor')">3</div>
    <div class="q-item" id="q4-nav" onclick="scrollToElement('q4-anchor')">4</div>
    <div class="q-item" id="q5-nav" onclick="scrollToElement('q5-anchor')">5</div>
    <div class="q-item" id="q6-nav" onclick="scrollToElement('q6-anchor')">6</div>
    <div class="q-item" id="q7-nav" onclick="scrollToElement('q7-anchor')">7</div>
    <div class="q-item" id="q8-nav" onclick="scrollToElement('q8-anchor')">8</div>
    <div class="q-item" id="q9-nav" onclick="scrollToElement('q9-anchor')">9</div>
    <div class="q-item" id="q10-nav" onclick="scrollToElement('q10-anchor')">10</div>
    <div class="q-item" id="q11-nav" onclick="scrollToElement('q11-anchor')">11</div>
    <div class="q-item" id="q12-nav" onclick="scrollToElement('q12-anchor')">12</div>
    <div class="q-item" id="q13-nav" onclick="scrollToElement('q13-anchor')">13</div>
  </div>
  <div class="controls">
    <span id="timer" onclick="toggleTimer()">00:00</span>
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode">🌙</button>
  </div>
</div>

<div class="shell">
  <section class="pane" id="left">
    <h2>READING PASSAGE 1</h2>
    <p>You should spend about 20 minutes on Questions 1–13, which are based on Reading Passage 1 below.</p>
    
    <h3>Rubber</h3>
    <p><em>T. and W. Musgrove discuss the origins and early uses of rubber</em></p>
  
    <p>The plants that produce rubber are spread right across the globe, and grow in many different habitats. One might think it likely, therefore, that humankind has known about rubber for thousands of years. Yet, unlike other crops of economic importance, rubber led a relatively anonymous life until the last 150 years or so. The Indians of South America appear to be the first people to have understood the properties of rubber, and the Aztecs of what is now Mexico were the first to be recorded using the substance; a wall painting dating back to the sixth century depicts a scene of a tribute offering of crude rubber. With the arrival of Columbus in the Americas and the resulting Spanish influx, further evidence starts to appear concerning the Native American use of rubber. Antonio de Herrera y Tordesillas describes a ritual game played with a rubber ball at the court of the Aztec Emperor Montezuma II, and the Mayan and Toltec people are known to have taken part in similar activities. Rubber was also used to make raincoats, shoes, jars, torches and musical instruments, all of which must have been made from the indigenous Castilla elastica, as the Para rubber plant now favoured for rubber cultivation does not grow in the Mexican region.</p>
  
    <p>The first description of latex (liquid rubber) extraction was made by Juan de Torquemada, who noted that if a receptacle was not at hand the Native Americans would place the latex on their bodies to allow it to solidify. However, no real interest in rubber was shown by any European until Charles de la Condamine, a French mathematician, published an account of his journey to South America in 1735. The journey was undertaken on behalf of the Paris Academy of Sciences to measure an arc of the meridian line on the equator, but the journey home was to turn out to be more significant than the true purpose of the trip. Condamine explored Brazil and Peru and discovered how the local people used one single piece of coagulated latex to make boots. The boots were impervious to water and, when smoked, looked like real leather. In 1747 the first description of the rubber tree and latex tapping was made by a military engineer and amateur botanist, François Fresneau, who was posted to French Guiana. The publications of Condamine and Fresneau created considerable excitement among French scientists, and an attempt was made to discover a solvent that could turn the crude rubber into a substance for commercial exploitation.</p>
  
    <p>In 1818 a British medical student named James Syme first used rubber to make waterproof cloth. Another early use of the substance was as an eraser of pencil marks, hence the name ‘rubber’. This was complemented by balloons, rubber bands, braces, boots for the army and other ideas that met with varying degrees of success. In 1820 Thomas Hancock, an English manufacturer of rubber goods such as driving belts, industrial rollers and rubber hoses, invented a machine he called the ‘masticator’, which chewed up waste strips for reuse. It was discovered that the masticated rubber was more malleable, while maintaining much of its elasticity. In Scotland at the same time, Charles Mackintosh had discovered a way of using rubber as waterproofing material, by a process he patented in 1823. Hancock and Mackintosh joined forces in 1834, and three years later Hancock invented a machine for spreading rubber onto material.</p>
  
    <p>Despite their beneficial qualities, such as waterproofing, rubber goods were still not particularly popular as they had some major flaws, including the fact that they dissolved malodorously. They also became pliant when warm and rigid when cold. Then in 1839 the American Charles Goodyear discovered that it was possible to stabilise rubber by mixing it with sulphur while exposing it to heat - a process he called vulcanisation - and the full versatility of this extraordinary substance became apparent.</p>
  
    <p>Rubber goods could now be manufactured which had all the beneficial qualities of the material, such as durability, elasticity and variability, but which were not sticky, soluble or governed by the vagaries of the weather. The economic potential of rubber was now clearly evident. It played an important role in the Industrial Revolution, being employed in the steam engines found in factories, mills, mines and railways. It made a triumphant entrance as a new and innovative material at the Great Exhibition of 1851, where shoes, airbeds, furniture and clothing made out of newly improved rubber were proudly displayed.</p>
  
    <p>One of the most important rubber inventions was made in 1888, when an Irishman called John Boyd Dunlop produced the first pneumatic tyre. Solid rubber tyres had been used for the previous 18 years, but Dunlop’s new design, which he updated in 1890, immediately became popular. In 1895 Dunlop’s tyres were first used in motor cars, and with the mass production of cars just over the horizon the rubber industry had never looked healthier. The import levels of rubber over the nineteenth century bear witness to its irrepressible rise. In 1830 Britain had imported just 211 kg of crude rubber. This had risen to 10,000 kg in 1857, and by 1874 levels were just under six times as much again.</p>
    
  </section>
  <div id="divider" title="Drag to resize"></div>
  <section class="pane" id="right">
    <h3>Questions</h3>
    
    <div class="group">
      <h4>Questions 1–6</h4>
      <p>Do the following statements agree with the information given in Reading Passage 1?</p>
      <table>
        <tbody><tr>
          <td><strong>TRUE</strong></td>
          <td>if the statement agrees with the information</td>
        </tr>
        <tr>
          <td><strong>FALSE</strong></td>
          <td>if the statement contradicts the information</td>
        </tr>
        <tr>
          <td><strong>NOT GIVEN</strong></td>
          <td>if there is no information on this</td>
        </tr>
      </tbody></table>
      
      <div id="q1-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;">
        <p><strong>1</strong> Rubber plants grow only in certain regions of the world.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label><input name="q1" type="radio" value="TRUE"> TRUE</label> 
          <label><input name="q1" type="radio" value="FALSE"> FALSE</label> 
          <label><input name="q1" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <div id="q2-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;">
        <p><strong>2</strong> Rubber was extracted in Mexico as early as the sixth century.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label><input name="q2" type="radio" value="TRUE"> TRUE</label> 
          <label><input name="q2" type="radio" value="FALSE"> FALSE</label> 
          <label><input name="q2" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <div id="q3-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;">
        <p><strong>3</strong> Rubber from the Castilla elastica plant is of poorer quality than that from the Para plant.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label><input name="q3" type="radio" value="TRUE"> TRUE</label> 
          <label><input name="q3" type="radio" value="FALSE"> FALSE</label> 
          <label><input name="q3" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>

      <div id="q4-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;">
        <p><strong>4</strong> A French mathematician inspired real interest in rubber amongst Europeans.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label><input name="q4" type="radio" value="TRUE"> TRUE</label> 
          <label><input name="q4" type="radio" value="FALSE"> FALSE</label> 
          <label><input name="q4" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>

      <div id="q5-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;">
        <p><strong>5</strong> The process of vulcanisation was discovered by accident.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label><input name="q5" type="radio" value="TRUE"> TRUE</label> 
          <label><input name="q5" type="radio" value="FALSE"> FALSE</label> 
          <label><input name="q5" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>

      <div id="q6-anchor" style="padding-top: 8px; border-top: 1px dashed #e5e7eb;">
        <p><strong>6</strong> Imports of crude rubber into Britain fell during the nineteenth century.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label><input name="q6" type="radio" value="TRUE"> TRUE</label> 
          <label><input name="q6" type="radio" value="FALSE"> FALSE</label> 
          <label><input name="q6" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>

    </div>
    
    <div class="group">
      <h4>Questions 7–13</h4>
      <p>Complete the summary below.</p>
      <p>Choose <strong>NO MORE THAN THREE WORDS</strong> from the passage for each answer.</p>
      
      <div style="padding: 10px; border-radius: 8px; margin-top: 1em; line-height: 2;">
        <h4 style="text-align: center;">The Commercial Development of Rubber</h4>
        
        <p id="q7-anchor">Early European travellers gave accounts of various rubber objects in use in Central and South America, and these accounts created interest in the commercial exploitation of rubber. In 1818, <strong>7</strong> <input name="q7" type="text" class="blank" maxlength="40"> was produced using rubber, </p>
        <p id="q8-anchor">and in 1820 a machine was invented for recycling <strong>8</strong> <input name="q8" type="text" class="blank" maxlength="40"> of rubber. Over the next few years, other attempts were made to improve rubber, but some problems remained. </p>
        <p id="q9-anchor">For example, rubber products smelt bad when they were dissolved, and could turn either soft or <strong>9</strong> <input name="q9" type="text" class="blank" maxlength="40"> depending on the temperature. </p>
        <p id="q10-anchor">However, in 1839 a new process to <strong>10</strong> <input name="q10" type="text" class="blank" maxlength="40"> the substance greatly increased its potential. </p>
        <p id="q11-anchor">For example, rubber was used in the creation of the <strong>11</strong> <input name="q11" type="text" class="blank" maxlength="40"> during the Industrial Revolution. </p>
        <p id="q12-anchor">Then in 1888 the <strong>12</strong> <input name="q12" type="text" class="blank" maxlength="40"> was developed, </p>
        <p id="q13-anchor">and a few years later the <strong>13</strong> <input name="q13" type="text" class="blank" maxlength="40"> of the motor car began.</p>

      </div>
    </div>

    <div style="display:flex;gap:8px;margin-bottom:10px;">
      <button class="primary" onclick="grade()">Submit</button>
      <button onclick="resetForm()">Reset</button>
      <button onclick="toggleNotes()">Notes</button>
    </div>
    <div id="results"></div>
    <details class="answerbox" id="answerBox">
      <summary>Show answers (click to toggle) <span class="badge">hidden</span></summary>
      <div id="answerContent"></div>
    </details>
  </section>
</div>

<div aria-label="Selection tools" id="selbar" role="toolbar">
  <button id="btnHL">Highlight</button>
  <button id="btnUH">Remove</button>
  <button id="btnNote">Note</button>
</div>

<div id="notes">
  <header>
    <strong>Notes</strong>
    <div>
      <button id="btnCopy">Copy</button>
      <button id="btnClose">Close</button>
    </div>
  </header>
  <textarea id="noteArea" placeholder="Type your notes here..."></textarea>
</div>

<div id="toast"></div>

<script>
// 页面滚动功能
function scrollToElement(id) {
  const element = document.getElementById(id);
  if (element) {
    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
    const navItem = document.getElementById(id.replace('-anchor', '-nav'));
    if(navItem) {
      navItem.classList.add('active');
      setTimeout(() => navItem.classList.remove('active'), 1200);
    }
  }
}

// 重置表单功能
function resetForm() {
  document.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);
  document.querySelectorAll('input.blank').forEach(input => input.value = '');
  document.getElementById('results').innerHTML = '';
  document.getElementById('answerContent').innerHTML = '';
  const answerBadge = document.querySelector('#answerBox .badge');
  if (answerBadge) answerBadge.textContent = 'hidden';
  if (document.getElementById('answerBox').hasAttribute('open')) {
      document.getElementById('answerBox').removeAttribute('open');
  }
  updateAnswerStatus();
  showToast('Form reset');
}

// Toast通知功能
function showToast(msg) {
  const toastEl = document.getElementById('toast');
  toastEl.textContent = msg;
  toastEl.style.display = 'block';
  setTimeout(() => { toastEl.style.display = 'none'; }, 1500);
}

// 计时器功能
let timerSeconds = 0;
let timerRunning = false;
let timerInterval;
const timerEl = document.getElementById('timer');

function updateTimerDisplay() {
  const minutes = Math.floor(timerSeconds / 60);
  const seconds = timerSeconds % 60;
  timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function startTimer() {
    if (timerRunning) return;
    timerRunning = true;
    timerEl.classList.remove('paused');
    timerInterval = setInterval(() => {
        timerSeconds++;
        updateTimerDisplay();
    }, 1000);
}

function stopTimer() {
    timerRunning = false;
    timerEl.classList.add('paused');
    clearInterval(timerInterval);
}

function toggleTimer() {
  if (timerRunning) {
    stopTimer();
    showToast('Timer paused');
  } else {
    startTimer();
    showToast('Timer resumed');
  }
}

// 主题切换功能
function toggleTheme() {
  document.body.classList.toggle('dark');
  const isDark = document.body.classList.contains('dark');
  localStorage.setItem('darkMode', isDark);
  document.querySelector('.theme-toggle').textContent = isDark ? '☀️' : '🌙';
}

// 拖拽分栏功能
const divider = document.getElementById('divider');
const leftPane = document.getElementById('left');
let isDragging = false;

divider.addEventListener('mousedown', (e) => {
  isDragging = true;
  document.body.style.cursor = 'ew-resize';
  e.preventDefault();
});

window.addEventListener('mousemove', (e) => {
  if (!isDragging) return;
  const shellRect = document.querySelector('.shell').getBoundingClientRect();
  let newLeftWidth = e.clientX - shellRect.left;
  if (newLeftWidth < 280) newLeftWidth = 280; // min-width
  if (newLeftWidth > shellRect.width - 320) newLeftWidth = shellRect.width - 320; // min-width
  leftPane.style.flexBasis = newLeftWidth + 'px';
});

window.addEventListener('mouseup', () => {
  isDragging = false;
  document.body.style.cursor = 'default';
});

// 高亮和笔记功能
const selbar = document.getElementById('selbar');
let lastRange = null;

function positionSelbar() {
    const selection = window.getSelection();
    if (!selection || selection.rangeCount === 0 || selection.isCollapsed) {
        selbar.style.display = 'none';
        return;
    }
    const range = selection.getRangeAt(0);
    lastRange = range.cloneRange();
    const rect = range.getBoundingClientRect();
    selbar.style.display = 'flex';
    selbar.style.top = `${window.scrollY + rect.top - selbar.offsetHeight - 5}px`;
    selbar.style.left = `${window.scrollX + rect.left + rect.width / 2 - selbar.offsetWidth / 2}px`;
}

document.getElementById('left').addEventListener('mouseup', positionSelbar);

document.getElementById('btnHL').addEventListener('click', () => {
    if (lastRange) {
        const span = document.createElement('span');
        span.className = 'hl';
        try {
            lastRange.surroundContents(span);
        } catch (e) {
            console.warn("Could not surround contents, wrapping instead.", e);
            span.appendChild(lastRange.extractContents());
            lastRange.insertNode(span);
        }
        window.getSelection().removeAllRanges();
        selbar.style.display = 'none';
    }
});

document.getElementById('btnUH').addEventListener('click', () => {
    if (lastRange) {
        const ancestor = lastRange.commonAncestorContainer;
        ancestor.querySelectorAll('.hl').forEach(hl => {
            if (lastRange.intersectsNode(hl)) {
                const parent = hl.parentNode;
                while (hl.firstChild) {
                    parent.insertBefore(hl.firstChild, hl);
                }
                parent.removeChild(hl);
                parent.normalize();
            }
        });
        window.getSelection().removeAllRanges();
        selbar.style.display = 'none';
    }
});

// 笔记功能
const notesPanel = document.getElementById('notes');
const noteArea = document.getElementById('noteArea');

function toggleNotes() {
    notesPanel.style.display = (notesPanel.style.display === 'flex' ? 'none' : 'flex');
}
window.toggleNotes = toggleNotes;

document.getElementById('btnClose').addEventListener('click', toggleNotes);
document.getElementById('btnCopy').addEventListener('click', async () => {
  await navigator.clipboard.writeText(noteArea.value || '');
  showToast('Copied');
});

document.getElementById('btnNote').addEventListener('click', () => {
  const selection = window.getSelection().toString().trim();
  if (selection) {
    noteArea.value += (noteArea.value ? '\n\n' : '') + `> ${selection}`;
    toggleNotes();
    window.getSelection().removeAllRanges();
    selbar.style.display = 'none';
  }
});


// 答题状态更新
function updateAnswerStatus() {
  for (let i = 1; i <= 13; i++) {
    const inputs = document.querySelectorAll(`input[name="q${i}"]`);
    const navItem = document.getElementById(`q${i}-nav`);
    if (navItem) {
      let answered = false;
      inputs.forEach(input => {
        if ((input.type === 'radio' && input.checked) || (input.type === 'text' && input.value.trim())) {
          answered = true;
        }
      });
      navItem.classList.toggle('answered', answered);
    }
  }
}

// 答案和评分系统
const correctAnswers = {
  "q1": "FALSE", "q2": "NOT GIVEN", "q3": "NOT GIVEN", "q4": "TRUE", "q5": "NOT GIVEN", "q6": "FALSE",
  "q7": "waterproof cloth", "q8": "waste strips", "q9": "rigid", "q10": "stabilise", 
  "q11": "steam engines", "q12": "pneumatic tyre", "q13": "mass production"
};

function grade() {
  let total = 0, correct = 0, resultLines = [];
  
  for (let i = 1; i <= 13; i++) {
    total++;
    const questionName = `q${i}`;
    const radioChecked = document.querySelector(`input[name="${questionName}"]:checked`);
    const textInput = document.querySelector(`input[name="${questionName}"][type="text"]`);
    let userAnswer = '';
    
    if (radioChecked) {
      userAnswer = radioChecked.value;
    } else if (textInput) {
      userAnswer = textInput.value.trim();
    }
    
    const isCorrect = userAnswer.toLowerCase() === correctAnswers[questionName].toLowerCase();
    
    if (isCorrect) correct++;
    resultLines.push(`${questionName.toUpperCase()}: ${userAnswer || 'None'} ${isCorrect ? '✓' : '✗'}`);
  }
  
  const accuracy = Math.round((correct / total) * 100);
  document.getElementById('results').innerHTML = `
    <p><strong>Score:</strong> ${correct}/${total} <span class="badge">Accuracy ${accuracy}%</span></p>
    <pre>${resultLines.join('\n')}</pre>
  `;
  
  document.getElementById('answerContent').innerHTML = `
    <ol>
      <li>1 → FALSE</li>
      <li>2 → NOT GIVEN</li>
      <li>3 → NOT GIVEN</li>
      <li>4 → TRUE</li>
      <li>5 → NOT GIVEN</li>
      <li>6 → FALSE</li>
      <li>7 → waterproof cloth</li>
      <li>8 → waste strips</li>
      <li>9 → rigid</li>
      <li>10 → stabilise</li>
      <li>11 → steam engines</li>
      <li>12 → pneumatic tyre</li>
      <li>13 → mass production</li>
    </ol>
  `;
  document.querySelector('#answerBox .badge').textContent = 'tap to view';
  
  updateAnswerStatus();
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', () => {
  startTimer();
  updateAnswerStatus();
  
  if (localStorage.getItem('darkMode') === 'true') {
    document.body.classList.add('dark');
    document.querySelector('.theme-toggle').textContent = '☀️';
  }
  
  // 加载增强脚本
  loadPracticePageEnhancer();
});

// 监听答案变化以更新导航栏状态
document.addEventListener('change', updateAnswerStatus);
document.addEventListener('input', updateAnswerStatus);

// ##################################################################
// #               跨窗口数据传输功能 (增强脚本)                      #
// ##################################################################

// 尝试加载外部增强脚本
function loadPracticePageEnhancer() {
  const script = document.createElement('script');
  // 注意：这里的路径需要根据您的实际项目结构进行调整
  script.src = '../../../js/practice-page-enhancer.js';
  script.onload = function() {
    console.log('练习页面增强脚本已加载');
  };
  script.onerror = function() {
    console.error('练习页面增强脚本加载失败，降级到内联版本。');
    loadInlineEnhancer();
  };
  document.head.appendChild(script);
}

// 内联增强器（作为备用方案）
function loadInlineEnhancer() {
  if (window.practicePageEnhancer) return;
  
  window.practicePageEnhancer = {
    initialize: function() {
      console.log('[InlineEnhancer] 内联增强器已初始化');
      this.setupCommunication();
      this.setupAnswerListeners();
      this.interceptSubmit();
    },
    
    setupCommunication: function() {
      this.parentWindow = window.opener || window.parent;
      window.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'INIT_SESSION') {
          this.sessionId = event.data.data.sessionId;
          this.sendMessage('SESSION_READY', {
            pageType: this.detectPageType(),
            url: window.location.href
          });
        }
      });
    },
    
    detectPageType: function() {
      const title = document.title || '';
      if (title.includes('P1')) return 'P1';
      if (title.includes('P2')) return 'P2';
      if (title.includes('P3')) return 'P3';
      return 'unknown';
    },
    
    setupAnswerListeners: function() {
      this.answers = {};
      this.startTime = Date.now();
      
      document.addEventListener('change', (e) => {
        if (e.target.name && e.target.name.startsWith('q')) {
          this.answers[e.target.name] = e.target.value;
        }
      });
      
      document.addEventListener('input', (e) => {
        if (e.target.name && e.target.name.startsWith('q')) {
          this.answers[e.target.name] = e.target.value;
        }
      });
    },
    
    interceptSubmit: function() {
      // 拦截全局的grade函数
      if (typeof window.grade === 'function') {
        const originalGrade = window.grade;
        window.grade = () => {
          originalGrade(); // 先执行原始的评分函数
          setTimeout(() => this.handleSubmit(), 200); // 稍后处理数据提交
        };
      }
    },
    
    handleSubmit: function() {
      const results = {
        sessionId: this.sessionId,
        startTime: this.startTime,
        endTime: Date.now(),
        duration: Math.round((Date.now() - this.startTime) / 1000),
        answers: this.answers,
        scoreInfo: this.extractScore(),
        pageType: this.detectPageType(),
        url: window.location.href
      };
      
      this.sendMessage('PRACTICE_COMPLETE', results);
    },
    
    extractScore: function() {
      const resultsEl = document.getElementById('results');
      if (!resultsEl) return null;
      
      const text = resultsEl.textContent || '';
      const scoreMatch = text.match(/Score:\s*(\d+)\/(\d+)/i);
      if (scoreMatch) {
        const correct = parseInt(scoreMatch[1], 10);
        const total = parseInt(scoreMatch[2], 10);
        return {
          correct: correct,
          total: total,
          accuracy: total > 0 ? correct / total : 0,
          percentage: total > 0 ? Math.round((correct / total) * 100) : 0,
          source: 'inline_extraction'
        };
      }
      return null;
    },
    
    sendMessage: function(type, data) {
      if (this.parentWindow && this.parentWindow !== window) {
        this.parentWindow.postMessage({
          type: type,
          data: data,
          source: 'practice_page'
        }, '*');
         console.log('Message sent to parent:', {type, data});
      } else {
        console.log('No parent window found to send message to.');
      }
    }
  };
  
  // 初始化内联增强器
  window.practicePageEnhancer.initialize();
}

</script>

</body>
</html>