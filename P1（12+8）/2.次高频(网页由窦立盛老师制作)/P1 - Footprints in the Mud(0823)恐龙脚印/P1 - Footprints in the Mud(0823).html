<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Footprints in the Mud</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<style>
  :root { --line:#e5e7eb; --bg:#f6f7fb; --panel:#fff; --accent:#3b82f6; --muted:#6b7280; --shadow:0 6px 20px rgba(0,0,0,.12); }
  * { box-sizing: border-box; }
  html,body { height:100%; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); }
  #timer { position: static; display: inline-block; margin-left: 8px; background:#fff; border:1px solid var(--line); border-radius:10px; padding:2px 8px; font-size:14px; vertical-align: middle; }
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:var(--panel); overflow:auto; padding:20px; }
  #left { flex: 0 0 50%; min-width: 280px; }
  #right { flex: 1 1 auto; min-width: 320px; background:#fbfbff; border-left:1px solid var(--line); }
  #divider { flex: 0 0 8px; background: linear-gradient(90deg,#e5e7eb,#d1d5db); cursor: ew-resize; position:relative; z-index: 5; user-select:none; }
  h2,h3,h4 { margin:0 0 10px; }
  #left p { margin: 0 0 12px; line-height: 1.6; word-break: normal; overflow-wrap: normal; hyphens: none; }
  .group { background:#fff; border:1px solid var(--line); border-radius:10px; padding:12px; margin-bottom:14px; }
  table { border-collapse: collapse; width:100%; }
  th, td { border:1px solid var(--line); padding:6px; text-align:center; font-size:14px; }
  th:first-child, td:first-child { width:92px; }
  button { padding:8px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; cursor:pointer; }
  button.primary { background:var(--accent); color:#fff; border-color:#3b82f6; }
  #results { background:#fff; border:1px solid var(--line); border-radius:10px; padding:10px; }
  .hl { background:#fff3a3; box-shadow: inset 0 -2px 0 rgba(0,0,0,.05); cursor: pointer; }
  .hl:hover { filter: brightness(0.98); }
  #selbar { position: absolute; display:none; z-index: 2000; background:#111; color:#fff; border-radius: 8px; padding: 6px; box-shadow: var(--shadow); font-size:13px; gap:6px; align-items: center; }
  #selbar button { background: transparent; color:#fff; border: 1px solid rgba(255,255,255,.25); padding: 4px 8px; border-radius: 6px; cursor:pointer; }
  #selbar button:hover { border-color:#fff; }
  #notes { position: fixed; right: 12px; bottom: 12px; width: 320px; height: 42vh; background:#fff; border:1px solid var(--line); border-radius: 12px; display:none; flex-direction: column; z-index:1500; box-shadow: var(--shadow); }
  #notes header { display:flex; align-items:center; justify-content: space-between; padding:8px 10px; border-bottom:1px solid var(--line); }
  #notes textarea { flex:1; border:0; padding:10px; resize:none; font-size:14px; line-height:1.5; }
  #toast { position: fixed; left:50%; transform: translateX(-50%); bottom: 24px; background:#111; color:#fff; padding:8px 12px; border-radius: 8px; display:none; z-index:2500; }
  .dropzone { border:2px dashed #cbd5e1; background:#f8fafc; border-radius:10px; min-height:40px; padding:4px 8px; display:inline-flex; align-items:center; justify-content:space-between; gap:8px; width: auto; min-width: 120px; max-width: 200px; vertical-align: middle; }
  .droplabel { color:#64748b; font-size:14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .cardpool { background:#f1f5f9; border-radius:10px; padding:12px; display:flex; flex-wrap:wrap; gap:8px; }
  .pool-slot { min-height:40px; }
  .card { background:#fff; border:1px solid #e5e7eb; border-radius:8px; padding:8px 10px; display:inline-flex; gap:8px; align-items:center; cursor:grab; box-shadow:0 1px 0 rgba(0,0,0,.03); white-space: nowrap; }
  .card:active { cursor:grabbing; }
  .tag { background:#eef2ff; color:#4338ca; padding:2px 8px; border-radius:999px; font-size:12px; }
  .btn-clear { border:1px solid #e5e7eb; background:#fff; border-radius:8px; padding:6px 8px; cursor:pointer; }
  .ghost { opacity: .5; }
  .over { outline:2px dashed #3b82f6; }
  details.answerbox summary { cursor: pointer; user-select:none; list-style: none; }
  details.answerbox { border:1px dashed var(--line); border-radius:10px; padding:8px 10px; background:#fff; }
  .badge { display:inline-block; background:#eef2ff; color:#4338ca; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:6px; }
  body { padding-bottom: 82px; }
  .practice-nav { background:#fff; border-bottom:2px solid var(--line); padding:12px 20px; display:flex; align-items:center; gap:20px; box-shadow:0 2px 4px rgba(0,0,0,.05); flex-wrap:wrap; position:fixed; left:0; right:0; bottom:0; border-top:2px solid var(--line); border-bottom:0; z-index:4000; }
  .practice-nav .title { font-weight:600; color:var(--muted); }
  .practice-nav .questions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .practice-nav .q-item { padding:6px 10px; border:1px solid var(--line); border-radius:6px; background:#fff; cursor:pointer; font-size:14px; transition:all 0.2s; min-width:36px; text-align:center; }
  .practice-nav .q-item:hover { background:#f1f5f9; border-color:var(--accent); }
  .practice-nav .q-item.answered { background:#e0e7ff; border-color:var(--accent); color:var(--accent); font-weight:500; }
  .practice-nav .q-item.active { background:var(--accent); color:#fff; border-color:var(--accent); }
  #timer { display: inline-block; background:#fff; border:1px solid var(--line); border-radius:10px; padding:4px 10px; font-size:14px; vertical-align: middle; }
  .theme-toggle { cursor: pointer; background: transparent; border: none; font-size: 18px; padding: 4px; }
  #selbar { z-index: 6000 !important; }

  /* Dark Mode Styles */
  body.dark-mode { --bg: #1a1a1a; --panel: #2a2a2a; --line: #4a4a4a; --muted: #999; color: #e0e0e0; }
  body.dark-mode .pane { background: var(--panel); color: #e0e0e0; }
  body.dark-mode #right { background: #222; }
  body.dark-mode button { background: #3a3a3a; color: #e0e0e0; border-color: #555; }
  body.dark-mode button.primary { background: var(--accent); color: #fff; border-color: var(--accent); }
  body.dark-mode input.blank, body.dark-mode input[type="text"] { background: #2a2a2a; color: #e0e0e0; border-bottom-color: #666; }
  body.dark-mode input.blank:focus, body.dark-mode input[type="text"]:focus { border-bottom-color: var(--accent); }
  body.dark-mode .group, body.dark-mode #results, body.dark-mode details.answerbox { background: #2f2f2f; border-color: var(--line); }
  body.dark-mode .practice-nav { background: #252525; border-top-color: #444; }
  body.dark-mode .practice-nav .q-item { background: #3a3a3a; color: #ccc; border-color: #555; }
  body.dark-mode .practice-nav .q-item:hover { background: #4a4a4a; border-color: var(--accent); }
  body.dark-mode .practice-nav .q-item.answered { background: #3949ab; border-color: #5c6bc0; color: #e8eaf6; }
  body.dark-mode .practice-nav .q-item.active { background: var(--accent); color: #fff; border-color: var(--accent); }
  body.dark-mode #timer { background: #3a3a3a; color: #ccc; border-color: #555; }
  body.dark-mode .hl { background-color: #5b21b6; color: #f5f3ff; }
  body.dark-mode table, body.dark-mode th, body.dark-mode td { border-color: var(--line); }
  body.dark-mode th { background: #333; color: #e0e0e0; }
  body.dark-mode td { background: #2a2a2a; color: #ccc; }
</style>
</head>
<body>
<div class="practice-nav">
  <div class="title">Questions</div>
  <div class="controls">
    <span id="timer">00:00</span>
    <button class="theme-toggle" onclick="toggleDarkMode()" title="Toggle dark/light mode">☀️</button>
  </div>
  <div class="questions">
    <div class="q-item" id="q1-nav" onclick="scrollToElement('q1-anchor')">1</div>
    <div class="q-item" id="q2-nav" onclick="scrollToElement('q2-anchor')">2</div>
    <div class="q-item" id="q3-nav" onclick="scrollToElement('q3-anchor')">3</div>
    <div class="q-item" id="q4-nav" onclick="scrollToElement('q4-anchor')">4</div>
    <div class="q-item" id="q5-nav" onclick="scrollToElement('q5-anchor')">5</div>
    <div class="q-item" id="q6-nav" onclick="scrollToElement('q6-anchor')">6</div>
    <div class="q-item" id="q7-nav" onclick="scrollToElement('q7-anchor')">7</div>
    <div class="q-item" id="q8-nav" onclick="scrollToElement('q8-anchor')">8</div>
    <div class="q-item" id="q9-nav" onclick="scrollToElement('q9-anchor')">9</div>
    <div class="q-item" id="q10-nav" onclick="scrollToElement('q10-anchor')">10</div>
    <div class="q-item" id="q11-nav" onclick="scrollToElement('q11-anchor')">11</div>
    <div class="q-item" id="q12-nav" onclick="scrollToElement('q12-anchor')">12</div>
    <div class="q-item" id="q13-nav" onclick="scrollToElement('q13-anchor')">13</div>
  </div>
</div>
<div class="shell">
  <section class="pane" id="left">
    <h2>READING PASSAGE 1</h2>
    <p>You should spend about 20 minutes on Questions 1–13, which are based on Reading Passage 1 below.</p>
    <h3>Footprints in the Mud</h3>
    <p>The dinosaurs may have risen to power in as little as 10,000 years.</p>
    
    <p>Everybody knows that the dinosaurs became extinct as a result of a large asteroid; something big hit the Earth 65 million years ago and, when the dust had fallen, so had the great reptiles. There is thus a nice, if ironic, symmetry in the idea that a similar impact brought about the dinosaurs’ rise. That is the thesis proposed by Paul Olsen of Columbia University.</p>
    
    <p>Dinosaurs first appear in the fossil record 230 million years ago, during the Triassic period. But they were mostly small, and they shared the Earth with lots of other sorts of reptile. It was in the subsequent Jurassic period, which began 202 million years ago, that they overran the planet and turned into the monsters realistically depicted in modern books and movies. Dr Olsen and his colleagues are not the first to suggest that the dinosaurs inherited the Earth as the result of an asteroid strike. But they are the first to show that the takeover did, indeed, happen in a geological eye-blink.</p>
    
    <p>Dinosaur skeletons are rare. Dinosaur footprints are, however, surprisingly abundant. And the size of the prints is as good an indication of the size of the beasts as are the skeletons themselves. Dr Olsen and his colleagues therefore concentrated on prints, not bones. The prints in question were made in Eastern North America, a part of the world then full of rift valleys similar to those in East Africa today. Like the modern African rift valleys, the Triassic/Jurassic American ones contained lakes, and these lakes grew and shrank at regular intervals because of climatic changes. Rocks from this place and period can be dated to within a few thousand years. As a bonus, squishy lake-edge sediments are just the things for recording the tracks of passing animals.</p>
    
    <p>By dividing the labour between them, the research team were able to study such tracks at 80 sites and look at 18 so-called ‘ichnotaxa’. These are recognisable types of footprint that cannot be matched precisely within the species of animal that left them. But they can be matched with a general sort of animal, and thus act as an indicator of the fate of that group, even when there are no bones to tell the story.</p>
    
    <p>Their findings show that five of the ichnotaxa disappear before the end of the Triassic, and four march confidently across the boundary into the Jurassic. Six, however, vanish at the boundary, or only just splutter across it; and three appear from nowhere, almost as soon as the Jurassic begins. That boundary itself is suggestive. The first geological indication of the impact that killed the dinosaurs was an unusually high level of iridium in rocks at the end of the Cretaceous period, when the beasts disappear from the fossil record. Iridium is normally rare at the Earth’s surface, but it is more abundant in meteorites. When people began to believe the impact theory, they started looking for other Cretaceous-end anomalies. One that turned up was a surprising abundance of fern spores in rocks just above the boundary layer – a phenomenon known as the ‘fern spike’.</p>
    
    <p>That matched the theory nicely. Many modern ferns are opportunists. They cannot compete against plants with leaves, but if a piece of land is cleared by, say, a volcanic eruption, they are often the first things to set up shop there. An asteroid strike would have scoured much of the Earth of its vegetable cover, and provided a paradise for ferns. A fern spike in the rocks is thus a good indication that something terrible has happened.</p>
    
    <p>The surprises are how rapidly the new ichnotaxa appeared and how quickly they increased in size. Dr Olsen and his colleagues suggest that the explanation for this may be a phenomenon called ecological release. This is seen today when reptiles (which in modern times tend to be small creatures) reach islands where they face no competitors. The most spectacular example is on the Indonesian island of Komodo, where local lizards have grown so large that they are often referred to as dragons. The dinosaurs, in other words, could flourish only when the competition had been knocked out.</p>
    
    <p>That leaves the question of where the impact happened. No large hole in the Earth’s crust seems to be 202 million years old. It may, of course, have been overlooked. Old craters are eroded and buried, and not always easy to find. Alternatively, it may have vanished. Although continental crust is more or less permanent, the ocean floor is constantly recycled by the tectonic processes that bring about continental drift. There is no ocean floor left that is more than 200 million years old, so a crater that formed in the ocean would have been swallowed up by now.</p>
    
    <p>There is a third possibility, however. This is that the crater is known, but has been misdated. The Manicouagan ‘structure’, a crater in Quebec, is thought to be 214 million years old. It is huge – some 100 kilometres across – and seems to be the largest of between three and five craters that formed within a few hours of each other as the lumps of disintegrated comet hit the Earth one by one. Such an impact would surely have had a perceptible effect on the world, but the rocks from 214 million years ago do not record one. It is possible, therefore, that Manicouagan has been misdated. That will be the next thing to check.</p>
    
    <p>&nbsp;</p> <!-- 增加空白行防止加载不完全 -->
    <p>&nbsp;</p> <!-- 额外增加一行空白行，确保加载完全 -->
  </section>
  <div id="divider" title="Drag to resize"></div>
  <section class="pane" id="right">
    <h3>Questions</h3>
    
    <div class="group">
      <h4>Questions 1–6</h4>
      <p>Do the following statements agree with the information in Reading Passage 1?</p>
      <p>In boxes 1–6 on your answer sheet, write</p>
      <ul>
        <li>TRUE if the statement agrees with the information</li>
        <li>FALSE if the statement contradicts the information</li>
        <li>NOT GIVEN if there is no information about this</li>
      </ul>
      
      <a id="q1-anchor"></a>
      <div id="q1-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>1 There is still doubt about the theory that an asteroid strike killed the dinosaurs.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q1" type="radio" value="TRUE"> TRUE</label>
          <label style="margin:0;"><input name="q1" type="radio" value="FALSE"> FALSE</label>
          <label style="margin:0;"><input name="q1" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <a id="q2-anchor"></a>
      <div id="q2-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>2 Books and the cinema have exaggerated the size of dinosaurs.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q2" type="radio" value="TRUE"> TRUE</label>
          <label style="margin:0;"><input name="q2" type="radio" value="FALSE"> FALSE</label>
          <label style="margin:0;"><input name="q2" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <a id="q3-anchor"></a>
      <div id="q3-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>3 Other scientists have rejected Olsen’s idea of a sudden dinosaur occupation of the Earth.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q3" type="radio" value="TRUE"> TRUE</label>
          <label style="margin:0;"><input name="q3" type="radio" value="FALSE"> FALSE</label>
          <label style="margin:0;"><input name="q3" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <a id="q4-anchor"></a>
      <div id="q4-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>4 Dinosaur footprints are found more frequently than dinosaur skeletons.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q4" type="radio" value="TRUE"> TRUE</label>
          <label style="margin:0;"><input name="q4" type="radio" value="FALSE"> FALSE</label>
          <label style="margin:0;"><input name="q4" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <a id="q5-anchor"></a>
      <div id="q5-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>5 Ichnotaxa offer an exact identification of a dinosaur species.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q5" type="radio" value="TRUE"> TRUE</label>
          <label style="margin:0;"><input name="q5" type="radio" value="FALSE"> FALSE</label>
          <label style="margin:0;"><input name="q5" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <a id="q6-anchor"></a>
      <div id="q6-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>6 There is evidence that some groups of dinosaurs survived from the Triassic period into the Jurassic period.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q6" type="radio" value="TRUE"> TRUE</label>
          <label style="margin:0;"><input name="q6" type="radio" value="FALSE"> FALSE</label>
          <label style="margin:0;"><input name="q6" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
    </div>
    
    <div class="group">
      <a id="q7-anchor"></a>
      <h4>Questions 7–13</h4>
      <p>Complete the summary below.</p>
      <p>Choose NO MORE THAN THREE WORDS from the passage for each answer.</p>
      <p>Write your answers in boxes 7–13 on your answer sheet.</p>
      
      <p>Dr Olsen’s group believe that the sudden increase in the size of dinosaurs may have been due to something known as 7 <input type="text" name="q7" style="width: 120px; margin-left: 10px;">. A current example of this can be found on Komodo Island in Indonesia, where some of the lizards are commonly called 8 <input type="text" name="q8" style="width: 80px; margin-left: 10px;"> because of their size. Apparently, they have grown this big because they do not have any 9 <input type="text" name="q9" style="width: 80px; margin-left: 10px;">. The asteroid strike that may have cleared the way for dinosaurs to become the dominant group probably occurred 202 million years ago.</p>
      
      <p>According to the writer, there are three possible reasons why we have not found a large hole in the Earth’s crust dating back 202 million years. First, it may have been 10 <input type="text" name="q10" style="width: 80px; margin-left: 10px;"> by scientists, because craters are easily covered up. Or, it could have 11 <input type="text" name="q11" style="width: 80px; margin-left: 10px;">; for example, if the hole had been in the ocean, it would no longer exist because of the 12 <input type="text" name="q12" style="width: 120px; margin-left: 10px;"> that produce continental drift. Thirdly, the hole could still exist but have been 13 <input type="text" name="q13" style="width: 80px; margin-left: 10px;">.</p>
    </div>
    
    <div style="display:flex;gap:8px;margin-bottom:10px;">
      <button class="primary" onclick="grade()">Submit</button>
      <button onclick="resetForm()">Reset</button>
      <button onclick="toggleNotes()">Notes</button>
    </div>
    <div id="results"></div>
    <details class="answerbox" id="answerBox">
      <summary>Show answers (click to toggle) <span class="badge">hidden</span></summary>
      <div id="answerContent"></div>
    </details>
  </section>
</div>
<div aria-label="Selection tools" id="selbar" role="toolbar">
  <button id="btnHL">Highlight</button>
  <button id="btnUH">Remove</button>
  <button id="btnNote">Note</button>
</div>
<div id="notes">
  <header>
    <strong>Notes</strong>
    <div>
      <button id="btnCopy">Copy</button>
      <button id="btnClose">Close</button>
    </div>
  </header>
  <textarea id="noteArea" placeholder="Type your notes here..."></textarea>
</div>
<div id="toast"></div>
<script>
// Timer
let _t=0; const _timerEl=document.getElementById('timer');
setInterval(function(){ 
  _t++; 
  var m=String(Math.floor(_t/60)).padStart(2,'0'); 
  var s=String(_t%60).padStart(2,'0'); 
  _timerEl.textContent=m+':'+s; 
},1000);
// Drag divider
var divider = document.getElementById('divider');
var left = document.getElementById('left');
var right = document.getElementById('right');
var dragging=false;
function startDrag(e){ 
  dragging=true; 
  document.body.style.cursor='ew-resize'; 
  if(e.preventDefault) e.preventDefault(); 
}
function endDrag(){ 
  dragging=false; 
  document.body.style.cursor=''; 
}
function onMove(clientX){
  var container = document.querySelector('.shell').getBoundingClientRect();
  var x = clientX - container.left;
  x = Math.max(280, Math.min(container.width-320, x));
  left.style.flex = '0 0 ' + x + 'px';
  right.style.flex = '1 1 auto';
}
divider.addEventListener('mousedown', function(e){ startDrag(e); });
window.addEventListener('mousemove', function(e){ if(dragging) onMove(e.clientX); });
window.addEventListener('mouseup', endDrag);
divider.addEventListener('touchstart', function(e){ startDrag(e.touches[0]); }, {passive:false});
window.addEventListener('touchmove', function(e){ if(dragging) onMove(e.touches[0].clientX); }, {passive:false});
window.addEventListener('touchend', endDrag);
</script>
<script>
// Highlight toolbar
var selbar = document.getElementById('selbar');
var btnHL = document.getElementById('btnHL');
var btnUH = document.getElementById('btnUH');
var btnNote = document.getElementById('btnNote');
var lastRange=null;
var currentHlNode=null;
var keepToolbar=false;
function positionSelbarForRect(rect){
  selbar.style.display='flex';
  requestAnimationFrame(function(){
    var top = window.scrollY + rect.top - selbar.offsetHeight - 8;
    var leftPos = window.scrollX + rect.left + rect.width/2 - selbar.offsetWidth/2;
    selbar.style.top = ((top>0)?top:(window.scrollY + rect.bottom + 8)) + 'px';
    selbar.style.left = Math.max(8, leftPos) + 'px';
  });
}
function updateSelbar(){
  var sel=window.getSelection();
  if(!sel || sel.rangeCount===0 || sel.isCollapsed) { 
    selbar.style.display='none'; 
    currentHlNode=null; 
    return; 
  }
  var range = sel.getRangeAt(0);
  lastRange = range.cloneRange();
  currentHlNode=null;
  positionSelbarForRect(range.getBoundingClientRect());
}
document.getElementById('left').addEventListener('mouseup', updateSelbar);
document.getElementById('right').addEventListener('mouseup', updateSelbar);
document.addEventListener('selectionchange', function(){ 
  var sel=window.getSelection(); 
  if(!sel || sel.rangeCount===0 || sel.isCollapsed){ 
    if(!keepToolbar && !currentHlNode){ 
      selbar.style.display='none'; 
    } 
  } 
});
document.addEventListener('scroll', function(){ 
  if(selbar.style.display==='flex') updateSelbar(); 
});
document.addEventListener('mousedown', function(e){
  var t = e.target;
  if(t.classList && t.classList.contains('hl')){
    keepToolbar = true;
  } else {
    keepToolbar = false;
  }
}, true);
document.addEventListener('click', function(e){
  var target = e.target;
  if(target.classList && target.classList.contains('hl')){
    currentHlNode = target;
    lastRange = null;
    positionSelbarForRect(target.getBoundingClientRect());
    var sel=window.getSelection();
    if(sel) sel.removeAllRanges();
    setTimeout(function(){ keepToolbar=false; }, 0);
  }
}, true);
function doHighlight(){
  if(currentHlNode) return;
  if(!lastRange || lastRange.collapsed) return;
  var span=document.createElement('span'); span.className='hl';
  try { lastRange.surroundContents(span); }
  catch(e){
    var wrap=document.createElement('span'); wrap.className='hl';
    wrap.appendChild(lastRange.cloneContents());
    lastRange.deleteContents();
    lastRange.insertNode(wrap);
  }
  selbar.style.display='none';
  showToast('Highlighted');
}
function removeHighlight(){
  if(currentHlNode){
    var p = currentHlNode.parentNode;
    while(currentHlNode.firstChild) p.insertBefore(currentHlNode.firstChild, currentHlNode);
    p.removeChild(currentHlNode); p.normalize();
    currentHlNode = null;
    selbar.style.display='none';
    showToast('Highlight removed');
    return;
  }
  if(!lastRange) return;
  var selRect = lastRange.getBoundingClientRect();
  var walker=document.createTreeWalker(document.body, NodeFilter.SHOW_ELEMENT);
  var toRemove=[];
  while(walker.nextNode()){
    var n=walker.currentNode;
    if(n.classList && n.classList.contains('hl')) {
      var r = n.getBoundingClientRect();
      if(!(r.right < selRect.left || r.left > selRect.right || r.bottom < selRect.top || r.top > selRect.bottom)) toRemove.push(n);
    }
  }
  toRemove.forEach(function(el){ var p=el.parentNode; while(el.firstChild) p.insertBefore(el.firstChild, el); p.removeChild(el); p.normalize(); });
  selbar.style.display='none';
  showToast('Highlight removed');
}
btnHL.addEventListener('click', doHighlight);
btnUH.addEventListener('click', removeHighlight);
</script>
<script>
// Notes
var notes = document.getElementById('notes');
var noteArea = document.getElementById('noteArea');
var btnCopy=document.getElementById('btnCopy');
var btnClose=document.getElementById('btnClose');
function toggleNotes(){ 
  notes.style.display = (notes.style.display==='flex'?'none':'flex'); 
}
window.toggleNotes = toggleNotes;
btnClose.addEventListener('click', toggleNotes);
btnCopy.addEventListener('click', async function(){ 
  await navigator.clipboard.writeText(noteArea.value||''); 
  showToast('Copied'); 
});
btnNote.addEventListener('click', function(){
  var text = '';
  if(currentHlNode){ text = (currentHlNode.textContent||'').trim(); }
  else if(lastRange){ var frag = lastRange.cloneContents(); text = (frag.textContent||'').trim(); }
  toggleNotes();
  if(text) noteArea.value = (noteArea.value? noteArea.value+'\n':'') + '> ' + text + '\n';
  selbar.style.display='none';
});
// Toast
var toastEl = document.getElementById('toast');
function showToast(msg){
  toastEl.textContent = msg; 
  toastEl.style.display = 'block';
  setTimeout(function(){ toastEl.style.display = 'none'; }, 1200);
}

// Dark Mode Toggle
function toggleDarkMode() {
  document.body.classList.toggle('dark-mode');
  const isDarkMode = document.body.classList.contains('dark-mode');
  localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');
  document.querySelector('.theme-toggle').textContent = isDarkMode ? '🌙' : '☀️';
}

// Initialize dark mode from localStorage
if (localStorage.getItem('darkMode') === 'enabled') {
  document.body.classList.add('dark-mode');
  document.querySelector('.theme-toggle').textContent = '🌙';
}
</script>
<script>
// Answer key and grading
var answers = {
  "q1":"FALSE", "q2":"FALSE", "q3":"NOT GIVEN", "q4":"TRUE", "q5":"FALSE", "q6":"TRUE",
  "q7":"ecological release", "q8":"dragons", "q9":"competitors", "q10":"overlooked", "q11":"vanished", "q12":"tectonic processes", "q13":"misdated"
};
function grade(){
  var total=0, correct=0, lines=[];
  
  // Check radio questions (1-6)
  for(let n=1; n<=6; n++){
    const q = `q${n}`;
    total++;
    const selected = document.querySelector(`input[name="${q}"]:checked`);
    const userAnswer = selected ? selected.value : '';
    const isCorrect = userAnswer === answers[q];
    if (isCorrect) correct++;
    lines.push(`${q.toUpperCase()}: ${userAnswer || 'None'} ${isCorrect ? '✓' : '✗'}`);
  }
  
  // Check text input questions (7-13)
  for(let n=7; n<=13; n++){
    const q = `q${n}`;
    total++;
    const input = document.querySelector(`input[name="${q}"]`);
    const userAnswer = input ? input.value.trim() : '';
    // Normalize answers (case-insensitive for text answers)
    const normalizedUser = userAnswer.toLowerCase();
    const normalizedCorrect = answers[q].toLowerCase();
    const isCorrect = normalizedUser === normalizedCorrect;
    if (isCorrect) correct++;
    lines.push(`${q.toUpperCase()}: ${userAnswer || 'None'} ${isCorrect ? '✓' : '✗'}`);
  }
  
  // Show results
  const acc = Math.round(100 * correct / total);
  document.getElementById('results').innerHTML = `
    <p><strong>Score:</strong> ${correct}/${total} <span class="badge">Accuracy ${acc}%</span></p>
    <pre>${lines.join('\n')}</pre>
  `;
  
  // Show answer key
  document.getElementById('answerContent').innerHTML = `
    <ol>
      <li>1 → FALSE (原文将小行星致恐龙灭绝视为"众所周知"的事实，无怀疑)</li>
      <li>2 → FALSE (原文提到书籍和电影"realistically depicted"，未夸大)</li>
      <li>3 → NOT GIVEN (无信息显示其他科学家拒绝Olsen的观点)</li>
      <li>4 → TRUE (原文明确"恐龙骨架稀少，足迹丰富")</li>
      <li>5 → FALSE (原文提到ichnotaxa"无法精确匹配物种")</li>
      <li>6 → TRUE (4类ichnotaxa跨越三叠纪-侏罗纪边界，证明部分恐龙存活)</li>
      <li>7 → ecological release (恐龙体型骤增的原因)</li>
      <li>8 → dragons (科莫多岛巨蜥的别称)</li>
      <li>9 → competitors (巨蜥无竞争者故体型大)</li>
      <li>10 → overlooked (陨石坑可能被忽略)</li>
      <li>11 → vanished (陨石坑可能已消失)</li>
      <li>12 → tectonic processes (海底被板块构造过程回收)</li>
      <li>13 → misdated (陨石坑可能被误定年代)</li>
    </ol>
  `;
  document.querySelector('#answerBox .badge').textContent = 'tap to view';
}
function resetForm(){
  // Reset radio buttons
  document.querySelectorAll('input[type="radio"]').forEach(radio => {
    radio.checked = false;
  });
  
  // Reset text inputs
  document.querySelectorAll('input[type="text"]').forEach(input => {
    input.value = '';
  });
  
  // Reset results and answers
  document.getElementById('results').innerHTML = '';
  document.getElementById('answerContent').innerHTML = '';
  document.querySelector('#answerBox .badge').textContent = 'hidden';
  
  // Reset answered status in nav
  document.querySelectorAll('.q-item').forEach(item => {
    item.classList.remove('answered');
  });
}
// Scroll to question anchor
function scrollToElement(id){
  const el = document.getElementById(id);
  if(el){ 
    el.scrollIntoView({behavior:'smooth', block:'center'}); 
  }
  // Highlight nav item briefly
  const navs = document.querySelectorAll('.practice-nav .q-item');
  navs.forEach(n => n.classList.remove('active'));
  const btn = document.getElementById(id.replace('-anchor','-nav'));
  if(btn){ 
    btn.classList.add('active'); 
    setTimeout(() => btn.classList.remove('active'), 800); 
  }
}
// Mark answered on interaction
(function(){
  function markAnswered(qn){
    const nav = document.getElementById(`q${qn}-nav`);
    if(!nav) return;
    let answered = false;
    
    // Check radio buttons (1-6)
    if(qn >= 1 && qn <=6){
      const radios = document.querySelectorAll(`input[name="q${qn}"]:checked`);
      answered = radios.length > 0;
    } 
    // Check text inputs (7-13)
    else if(qn >=7 && qn <=13){
      const input = document.querySelector(`input[name="q${qn}"]`);
      answered = input && input.value.trim().length > 0;
    }
    
    if(answered) nav.classList.add('answered');
    else nav.classList.remove('answered');
  }
  
  // Monitor radio buttons
  for(let n=1; n<=6; n++){
    document.querySelectorAll(`input[name="q${n}"]`).forEach(radio => {
      radio.addEventListener('change', () => markAnswered(n));
    });
  }
  
  // Monitor text inputs
  for(let n=7; n<=13; n++){
    const input = document.querySelector(`input[name="${n}"]`);
    if(input) {
      input.addEventListener('input', () => markAnswered(n));
      input.addEventListener('blur', () => markAnswered(n));
    }
  }
})();
</script>

<script>
// 检查是否已经有增强脚本
if (!window.practicePageEnhancer) {
    // 动态加载增强脚本
    const script = document.createElement('script');
    script.src = '../../../js/practice-page-enhancer.js';
    script.onload = function() {
        console.log('[PracticePageEnhancer] 外部脚本加载成功');
        if (window.practicePageEnhancer) {
            window.practicePageEnhancer.initialize();
        }
    };
    script.onerror = function() {
        console.log('[PracticePageEnhancer] 外部脚本加载失败，使用内联版本');
        loadInlineEnhancer();
    };
    document.head.appendChild(script);
    
    // 超时降级
    setTimeout(function() {
        if (!window.practicePageEnhancer) {
            console.log('[PracticePageEnhancer] 超时降级到内联版本');
            loadInlineEnhancer();
        }
    }, 2000);
}

// 内联增强器（降级方案）
function loadInlineEnhancer() {
    if (window.practicePageEnhancer) return;
    
    window.practicePageEnhancer = {
        initialize: function() {
            console.log('[InlineEnhancer] 内联增强器已初始化');
            this.setupCommunication();
            this.setupAnswerListeners();
            this.interceptSubmit();
        },
        
        setupCommunication: function() {
            this.parentWindow = window.opener || window.parent;
            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'INIT_SESSION') {
                    this.sessionId = event.data.data.sessionId;
                    this.sendMessage('SESSION_READY', {
                        pageType: this.detectPageType(),
                        url: window.location.href
                    });
                }
            });
        },
        
        detectPageType: function() {
            const title = document.title || '';
            if (title.includes('P1')) return 'P1';
            if (title.includes('P2')) return 'P2';
            if (title.includes('P3')) return 'P3';
            return 'unknown';
        },
        
        setupAnswerListeners: function() {
            this.answers = {};
            this.startTime = Date.now();
            
            document.addEventListener('change', (e) => {
                if (e.target.name && e.target.name.startsWith('q')) {
                    this.answers[e.target.name] = e.target.value;
                }
            });
        },
        
        interceptSubmit: function() {
            // 拦截grade函数
            if (typeof window.grade === 'function') {
                const originalGrade = window.grade;
                window.grade = () => {
                    const result = originalGrade();
                    setTimeout(() => this.handleSubmit(), 200);
                    return result;
                };
            }
            
            // 监听提交按钮
            document.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' && 
                    (e.target.textContent.includes('Submit') || 
                     e.target.textContent.includes('提交') ||
                     e.target.textContent.includes('完成') ||
                     e.target.textContent.includes('Check') ||
                     e.target.onclick && e.target.onclick.toString().includes('grade'))) {
                    setTimeout(() => this.handleSubmit(), 300);
                }
            });
        },
        
        handleSubmit: function() {
            const results = {
                sessionId: this.sessionId,
                startTime: this.startTime,
                endTime: Date.now(),
                duration: Math.round((Date.now() - this.startTime) / 1000),
                answers: this.answers,
                scoreInfo: this.extractScore(),
                pageType: this.detectPageType(),
                url: window.location.href
            };
            
            this.sendMessage('PRACTICE_COMPLETE', results);
        },
        
        extractScore: function() {
            const resultsEl = document.getElementById('results');
            if (!resultsEl) return null;
            
            const text = resultsEl.textContent || '';
            const scoreMatch = text.match(/Score:\s*(\d+)\/(\d+)/i);
            if (scoreMatch) {
                const correct = parseInt(scoreMatch[1]);
                const total = parseInt(scoreMatch[2]);
                return {
                    correct: correct,
                    total: total,
                    accuracy: total > 0 ? correct / total : 0,
                    percentage: Math.round((correct / total) * 100),
                    source: 'inline_extraction'
                };
            }
            return null;
        },
        
        sendMessage: function(type, data) {
            if (this.parentWindow) {
                this.parentWindow.postMessage({
                    type: type,
                    data: data,
                    source: 'practice_page'
                }, '*');
            }
        }
    };
    
    // 初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            window.practicePageEnhancer.initialize();
        });
    } else {
        window.practicePageEnhancer.initialize();
    }
}
</script></body>
</html>
