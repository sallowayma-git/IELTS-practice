<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P1 – A survivor's story</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root { --line:#e5e7eb; --bg:#f6f7fb; --panel:#fff; --accent:#3b82f6; --muted:#6b7280; --shadow:0 6px 20px rgba(0,0,0,.12); }
  * { box-sizing: border-box; }
  html,body { height:100%; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); padding-bottom: 82px; }
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:var(--panel); overflow:auto; padding:20px; }
  #left { flex: 0 0 50%; min-width: 280px; }
  #right { flex: 1 1 auto; min-width: 320px; background:#fbfbff; border-left:1px solid var(--line); }
  #divider { flex: 0 0 8px; background: linear-gradient(90deg,#e5e7eb,#d1d5db); cursor: ew-resize; position:relative; z-index: 5; user-select:none; }
  h2,h3,h4 { margin:0 0 10px; }
  #left p { margin: 0 0 12px; line-height: 1.6; word-break: normal; overflow-wrap: normal; hyphens: none; }
  .group { background:#fff; border:1px solid var(--line); border-radius:10px; padding:12px; margin-bottom:14px; }
  input.blank { border:none; border-bottom:1px solid #9ca3af; padding:2px 4px; font-size:1em; background:transparent; }
  input.blank:focus { outline:none; border-bottom:2px solid var(--accent); }
  button { padding:8px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; cursor:pointer; }
  button.primary { background:var(--accent); color:#fff; border-color:#3b82f6; }
  #results { background:#fff; border:1px solid var(--line); border-radius:10px; padding:10px; }
  .hl { background:#fff3a3; box-shadow: inset 0 -2px 0 rgba(0,0,0,.05); cursor: pointer; }
  .hl:hover { filter: brightness(0.98); }
  #selbar { position: absolute; display:none; z-index: 2000; background:#111; color:#fff; border-radius: 8px; padding: 6px; box-shadow: var(--shadow); font-size: 13px; gap:6px; align-items: center; }
  #selbar button { background: transparent; color:#fff; border: 1px solid rgba(255,255,255,.25); padding: 4px 8px; border-radius: 6px; cursor:pointer; }
  #selbar button:hover { border-color:#fff; }
  #notes { position: fixed; right: 12px; bottom: 12px; width: 320px; height: 42vh; background:#fff; border:1px solid var(--line); border-radius: 12px; display:none; flex-direction: column; z-index:1500; box-shadow: var(--shadow); }
  #notes header { display:flex; align-items:center; justify-content: space-between; padding:8px 10px; border-bottom:1px solid var(--line); }
  #notes textarea { flex:1; border:0; padding:10px; resize:none; font-size:14px; line-height:1.5; }
  #toast { position: fixed; left:50%; transform: translateX(-50%); bottom: 24px; background:#111; color:#fff; padding:8px 12px; border-radius: 8px; display:none; z-index:2500; }
  details.answerbox summary { cursor: pointer; user-select:none; list-style: none; }
  details.answerbox { border:1px dashed var(--line); border-radius:10px; padding:8px 10px; background:#fff; }
  .badge { display:inline-block; background:#eef2ff; color:#4338ca; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:6px; }
  .practice-nav { background:#fff; border-bottom:2px solid var(--line); padding:12px 20px; display:flex; align-items:center; gap:20px; box-shadow:0 2px 4px rgba(0,0,0,.05); flex-wrap:wrap; position:fixed; left:0; right:0; bottom:0; border-top:2px solid var(--line); border-bottom:0; z-index:4000; }
  .practice-nav .title { font-weight:600; color:var(--muted); }
  .practice-nav .controls { display:flex; align-items:center; gap:12px; }
  .practice-nav .questions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .practice-nav .q-item { padding:6px 10px; border:1px solid var(--line); border-radius:6px; background:#fff; cursor:pointer; font-size:14px; transition:all 0.2s; min-width:36px; text-align:center; }
  .practice-nav .q-item:hover { background:#f1f5f9; border-color:var(--accent); }
  .practice-nav .q-item.answered { background:#e0e7ff; border-color:var(--accent); color:var(--accent); font-weight:500; }
  .practice-nav .q-item.active { background:var(--accent); color:#fff; border-color:var(--accent); }
  #timer { display: inline-block; background:#fff; border:1px solid var(--line); border-radius:10px; padding:4px 10px; font-size:14px; vertical-align: middle; }
  .theme-toggle { cursor: pointer; background: transparent; border: none; font-size: 18px; padding: 4px; }
  #selbar { z-index: 6000 !important; }

  /* Dark Mode Styles */
  body.dark-mode { --bg: #1a1a1a; --panel: #2a2a2a; --line: #4a4a4a; --muted: #999; color: #e0e0e0; }
  body.dark-mode .pane { background: var(--panel); color: #e0e0e0; }
  body.dark-mode #right { background: #222; }
  body.dark-mode button { background: #3a3a3a; color: #e0e0e0; border-color: #555; }
  body.dark-mode button.primary { background: var(--accent); color: #fff; border-color: var(--accent); }
  body.dark-mode input.blank, body.dark-mode input[type="text"] { background: #2a2a2a; color: #e0e0e0; border-bottom-color: #666; }
  body.dark-mode input.blank:focus, body.dark-mode input[type="text"]:focus { border-bottom-color: var(--accent); }
  body.dark-mode .group, body.dark-mode #results, body.dark-mode details.answerbox { background: #2f2f2f; border-color: var(--line); }
  body.dark-mode .practice-nav { background: #252525; border-top-color: #444; }
  body.dark-mode .practice-nav .q-item { background: #3a3a3a; color: #ccc; border-color: #555; }
  body.dark-mode .practice-nav .q-item:hover { background: #4a4a4a; border-color: var(--accent); }
  body.dark-mode .practice-nav .q-item.answered { background: #3949ab; border-color: #5c6bc0; color: #e8eaf6; }
  body.dark-mode .practice-nav .q-item.active { background: var(--accent); color: #fff; border-color: var(--accent); }
  body.dark-mode #timer { background: #3a3a3a; color: #ccc; border-color: #555; }
  body.dark-mode .hl { background-color: #5b21b6; color: #f5f3ff; }
  body.dark-mode table, body.dark-mode th, body.dark-mode td { border-color: var(--line); }
  body.dark-mode th { background: #333; color: #e0e0e0; }
  body.dark-mode td { background: #2a2a2a; color: #ccc; }
</style>
</head>
<body>

<div class="practice-nav">
  <div class="title">Questions</div>
  <div class="controls">
    <span id="timer">00:00</span>
    <button class="theme-toggle" onclick="toggleDarkMode()" title="Toggle dark/light mode">☀️</button>
  </div>
  <div class="questions">
    <div class="q-item" id="q1-nav" onclick="scrollToElement('q1-anchor')">1</div>
    <div class="q-item" id="q2-nav" onclick="scrollToElement('q2-anchor')">2</div>
    <div class="q-item" id="q3-nav" onclick="scrollToElement('q3-anchor')">3</div>
    <div class="q-item" id="q4-nav" onclick="scrollToElement('q4-anchor')">4</div>
    <div class="q-item" id="q5-nav" onclick="scrollToElement('q5-anchor')">5</div>
    <div class="q-item" id="q6-nav" onclick="scrollToElement('q6-anchor')">6</div>
    <div class="q-item" id="q7-nav" onclick="scrollToElement('q7-anchor')">7</div>
    <div class="q-item" id="q8-nav" onclick="scrollToElement('q8-anchor')">8</div>
    <div class="q-item" id="q9-nav" onclick="scrollToElement('q9-anchor')">9</div>
    <div class="q-item" id="q10-nav" onclick="scrollToElement('q10-anchor')">10</div>
    <div class="q-item" id="q11-nav" onclick="scrollToElement('q11-anchor')">11</div>
    <div class="q-item" id="q12-nav" onclick="scrollToElement('q12-anchor')">12</div>
    <div class="q-item" id="q13-nav" onclick="scrollToElement('q13-anchor')">13</div>
  </div>
</div>

<div class="shell">
  <section class="pane" id="left">
    <h2>READING PASSAGE 1</h2>
    <p>You should spend about 20 minutes on Questions 1–13, which are based on Reading Passage 1 below.</p>
    
    <h3>A survivor's story</h3>
    <p><em>One native bird in New Zealand that has managed to survive the introduction of non-native species</em></p>
    
    <p>The little spotted kiwi has found ways to cope with the threat to its survival and its numbers are now beginning to increase. But this is only because many people have made considerable efforts to save this unique bird.</p>
    
    <p>New Zealand was the last country to be settled by humans. For millions of years, a number of bird species had evolved and lived safely there. In particular, many of these birds, including the little spotted kiwi, were flightless. They could afford to be flightless because until the arrival of humans there were no mammals in New Zealand to hunt them. When mammals were introduced by European settlers, bird life changed forever.</p>
    
    <p>At the time when humans first arrived in New Zealand, there were three different kiwi species, and the little spotted kiwi was the most common. The birds were about the size of chickens and lived in forests throughout the North and South Islands. Before the Europeans arrived in 1840s, the Maori people hunted the kiwi, but not excessively. In the late 1800s, museums and collectors became interested in the kiwi, and many birds were captured for scientific purposes. Even more devastating to the kiwi population was the clearing of its habitat. As European settlers cleared forests to make farms, the birds had less and less area in which to live. Even worse for the little spotted kiwi was the impact of the mammals that were introduced to New Zealand by Europeans. Cats attacked the kiwi chicks and stoats (small carnivorous mammals) killed both young and adult birds.</p>
    
    <p>Things had become so bad for the little spotted kiwi that, by 1900, it was believed to be extinct on the North Island, and almost extinct elsewhere. What saved it from total extinction was the transfer of five birds to Kapiti Island by a government minister, Richard Seddon, in 1913. Kapiti Island is a nature reserve about 5 km from the New Zealand coast. The island was special because it had no mammals that would attack the kiwi. In fact, the island's native wildlife was so special that visitors required official permission to land on the island.</p>
    
    <p>For a number of years, it was not certain whether the little spotted kiwi would survive, even on Kapiti Island. By 1980, the population was estimated to be around 100 birds. People who wanted to ensure the birds' survival thought that one small population was very vulnerable. If a natural disaster, disease or fire wiped out the population on Kapiti Island, the little spotted kiwi would become extinct. So, a decision was made to establish other populations on predator-free islands.</p>
    
    <p>The first additional population was established in 1982, when the first two little spotted kiwi were taken from Kapiti Island to Red Mercury Island. This transfer was unsuccessful, however, because stoats later swam to the island and killed the birds. In 1983, three birds were moved to Hen Island, which is also predator-free. This population has been much more successful, and the Hen Island population is now estimated to be more than 100. A third population of little spotted kiwi was later established on Tiritiri Matangi Island.</p>
    
    <p>Today, the little spotted kiwi population is estimated to be around 1,500 birds. This is much higher than the tiny population of 100 that existed in 1980, but is still much lower than the thousands of little spotted kiwi that existed before the arrival of the Europeans. Maintaining the present population depends entirely on keeping the three island populations free from predators. This is expensive and requires constant effort. It is too dangerous to reintroduce little spotted kiwi to mainland New Zealand because of the large number of introduced mammals that live there.</p>

    <p>&nbsp;</p>
  </section>
  <div id="divider" title="Drag to resize"></div>
  <section class="pane" id="right">
    <h3>Questions</h3>
    
    <div class="group">
      <h4>Questions 1–7</h4>
      <p>Do the following statements agree with the information in Reading Passage 1?</p>
      <p>In boxes 1–7 on your answer sheet, write</p>
      <ul>
        <li>TRUE if the statement agrees with the information</li>
        <li>FALSE if the statement contradicts the information</li>
        <li>NOT GIVEN if there is no information about this</li>
      </ul>
      
      <a id="q1-anchor"></a>
      <div id="q1-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>1 Humans were the first mammals to live in New Zealand.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q1" type="radio" value="TRUE"> TRUE</label>
          <label style="margin:0;"><input name="q1" type="radio" value="FALSE"> FALSE</label>
          <label style="margin:0;"><input name="q1" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <a id="q2-anchor"></a>
      <div id="q2-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>2 The little spotted kiwi was the largest of the three kiwi species.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q2" type="radio" value="TRUE"> TRUE</label>
          <label style="margin:0;"><input name="q2" type="radio" value="FALSE"> FALSE</label>
          <label style="margin:0;"><input name="q2" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <a id="q3-anchor"></a>
      <div id="q3-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>3 Museums played a role in the decline of the little spotted kiwi population.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q3" type="radio" value="TRUE"> TRUE</label>
          <label style="margin:0;"><input name="q3" type="radio" value="FALSE"> FALSE</label>
          <label style="margin:0;"><input name="q3" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <a id="q4-anchor"></a>
      <div id="q4-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>4 Richard Seddon moved the kiwi to Kapiti Island to prevent their extinction.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q4" type="radio" value="TRUE"> TRUE</label>
          <label style="margin:0;"><input name="q4" type="radio" value="FALSE"> FALSE</label>
          <label style="margin:0;"><input name="q4" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <a id="q5-anchor"></a>
      <div id="q5-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>5 Permission was required to visit Kapiti Island because there were so few kiwi there.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q5" type="radio" value="TRUE"> TRUE</label>
          <label style="margin:0;"><input name="q5" type="radio" value="FALSE"> FALSE</label>
          <label style="margin:0;"><input name="q5" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <a id="q6-anchor"></a>
      <div id="q6-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>6 Diseases have threatened the survival of the kiwi.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q6" type="radio" value="TRUE"> TRUE</label>
          <label style="margin:0;"><input name="q6" type="radio" value="FALSE"> FALSE</label>
          <label style="margin:0;"><input name="q6" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <a id="q7-anchor"></a>
      <div id="q7-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>7 The transfer of kiwi to Red Mercury Island was successful.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q7" type="radio" value="TRUE"> TRUE</label>
          <label style="margin:0;"><input name="q7" type="radio" value="FALSE"> FALSE</label>
          <label style="margin:0;"><input name="q7" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
    </div>
    
    <div class="group">
      <h4>Questions 8–13</h4>
      <p>Complete the notes below.</p>
      <p>Choose ONE WORD ONLY from the passage for each answer.</p>
      <p>Write your answers in boxes 8–13 on your answer sheet.</p>
      
      <p><strong>Notes on the little spotted kiwi</strong></p>
      
      <a id="q8-anchor"></a>
      <div id="q8-section" style="padding:4px 0;">
        <p>8 The bird was about <input class="blank" maxlength="20" name="q8" placeholder="Answer here"/> long.</p>
      </div>
      
      <a id="q9-anchor"></a>
      <div id="q9-section" style="padding:4px 0;">
        <p>9 In New Zealand it lived on <input class="blank" maxlength="20" name="q9" placeholder="Answer here"/>.</p>
      </div>
      
      <a id="q10-anchor"></a>
      <div id="q10-section" style="padding:4px 0;">
        <p>10 Its <input class="blank" maxlength="20" name="q10" placeholder="Answer here"/> was one particular physical feature that made it different from other birds.</p>
      </div>
      
      <a id="q11-anchor"></a>
      <div id="q11-section" style="padding:4px 0;">
        <p>11 This bird mainly feeds during the <input class="blank" maxlength="20" name="q11" placeholder="Answer here"/>.</p>
      </div>
      
      <a id="q12-anchor"></a>
      <div id="q12-section" style="padding:4px 0;">
        <p>12 The decline of the kiwi was partly due to introduced <input class="blank" maxlength="20" name="q12" placeholder="Answer here"/>.</p>
      </div>
      
      <a id="q13-anchor"></a>
      <div id="q13-section" style="padding:4px 0;">
        <p>13 There is now a danger of <input class="blank" maxlength="20" name="q13" placeholder="Answer here"/> affecting kiwi numbers.</p>
      </div>
    </div>
    
    <div style="display:flex;gap:8px;margin-bottom:10px;">
      <button class="primary" onclick="grade()">Submit</button>
      <button onclick="resetForm()">Reset</button>
      <button onclick="toggleNotes()">Notes</button>
    </div>
    <div id="results"></div>
    <details class="answerbox" id="answerBox">
      <summary>Show answers (click to toggle) <span class="badge">hidden</span></summary>
      <div id="answerContent"></div>
    </details>
  </section>
</div>

<div aria-label="Selection tools" id="selbar" role="toolbar">
  <button id="btnHL">Highlight</button>
  <button id="btnUH">Remove</button>
  <button id="btnNote">Note</button>
</div>
<div id="notes">
  <header>
    <strong>Notes</strong>
    <div>
      <button id="btnCopy">Copy</button>
      <button id="btnClose">Close</button>
    </div>
  </header>
  <textarea id="noteArea" placeholder="Type your notes here..."></textarea>
</div>
<div id="toast"></div>
<script>
// Timer
let _t=0; const _timerEl=document.getElementById('timer');
setInterval(function(){ 
  _t++; 
  var m=String(Math.floor(_t/60)).padStart(2,'0'); 
  var s=String(_t%60).padStart(2,'0'); 
  _timerEl.textContent=m+':'+s; 
},1000);

// Drag divider
var divider = document.getElementById('divider');
var left = document.getElementById('left');
var right = document.getElementById('right');
var dragging=false;

function startDrag(e){ 
  dragging=true; 
  document.body.style.cursor='ew-resize'; 
  if(e.preventDefault) e.preventDefault(); 
}

function endDrag(){ 
  dragging=false; 
  document.body.style.cursor=''; 
}

function onMove(clientX){
  var container = document.querySelector('.shell').getBoundingClientRect();
  var x = clientX - container.left;
  x = Math.max(280, Math.min(container.width-320, x));
  left.style.flex = '0 0 ' + x + 'px';
  right.style.flex = '1 1 auto';
}

divider.addEventListener('mousedown', function(e){ startDrag(e); });
window.addEventListener('mousemove', function(e){ if(dragging) onMove(e.clientX); });
window.addEventListener('mouseup', endDrag);
divider.addEventListener('touchstart', function(e){ startDrag(e.touches[0]); }, {passive:false});
window.addEventListener('touchmove', function(e){ if(dragging) onMove(e.touches[0].clientX); }, {passive:false});
window.addEventListener('touchend', endDrag);
</script>
<script>
// Highlight toolbar
var selbar = document.getElementById('selbar');
var btnHL = document.getElementById('btnHL');
var btnUH = document.getElementById('btnUH');
var btnNote = document.getElementById('btnNote');
var lastRange=null;
var currentHlNode=null;
var keepToolbar=false;

function positionSelbarForRect(rect){
  selbar.style.display='flex';
  requestAnimationFrame(function(){
    var top = window.scrollY + rect.top - selbar.offsetHeight - 8;
    var leftPos = window.scrollX + rect.left + rect.width/2 - selbar.offsetWidth/2;
    selbar.style.top = ((top>0)?top:(window.scrollY + rect.bottom + 8)) + 'px';
    selbar.style.left = Math.max(8, leftPos) + 'px';
  });
}

function updateSelbar(){
  var sel=window.getSelection();
  if(!sel || sel.rangeCount===0 || sel.isCollapsed) { 
    selbar.style.display='none'; 
    currentHlNode=null; 
    return; 
  }
  var range = sel.getRangeAt(0);
  lastRange = range.cloneRange();
  currentHlNode=null;
  positionSelbarForRect(range.getBoundingClientRect());
}

document.getElementById('left').addEventListener('mouseup', updateSelbar);
document.getElementById('right').addEventListener('mouseup', updateSelbar);
document.addEventListener('selectionchange', function(){ 
  var sel=window.getSelection(); 
  if(!sel || sel.rangeCount===0 || sel.isCollapsed){ 
    if(!keepToolbar && !currentHlNode){ 
      selbar.style.display='none'; 
    } 
  } 
});
document.addEventListener('scroll', function(){ 
  if(selbar.style.display==='flex') updateSelbar(); 
});

document.addEventListener('mousedown', function(e){
  var t = e.target;
  if(t.classList && t.classList.contains('hl')){
    keepToolbar = true;
  } else {
    keepToolbar = false;
  }
}, true);

document.addEventListener('click', function(e){
  var target = e.target;
  if(target.classList && target.classList.contains('hl')){
    currentHlNode = target;
    lastRange = null;
    positionSelbarForRect(target.getBoundingClientRect());
    var sel=window.getSelection();
    if(sel) sel.removeAllRanges();
    setTimeout(function(){ keepToolbar=false; }, 0);
  }
}, true);

function doHighlight(){
  if(currentHlNode) return;
  if(!lastRange || lastRange.collapsed) return;
  var span=document.createElement('span'); span.className='hl';
  try { lastRange.surroundContents(span); }
  catch(e){
    var wrap=document.createElement('span'); wrap.className='hl';
    wrap.appendChild(lastRange.cloneContents());
    lastRange.deleteContents();
    lastRange.insertNode(wrap);
  }
  selbar.style.display='none';
  showToast('Highlighted');
}

function removeHighlight(){
  if(currentHlNode){
    var p = currentHlNode.parentNode;
    while(currentHlNode.firstChild) p.insertBefore(currentHlNode.firstChild, currentHlNode);
    p.removeChild(currentHlNode); p.normalize();
    currentHlNode = null;
    selbar.style.display='none';
    showToast('Highlight removed');
    return;
  }
  if(!lastRange) return;
  var selRect = lastRange.getBoundingClientRect();
  var walker=document.createTreeWalker(document.body, NodeFilter.SHOW_ELEMENT);
  var toRemove=[];
  while(walker.nextNode()){
    var n=walker.currentNode;
    if(n.classList && n.classList.contains('hl')) {
      var r = n.getBoundingClientRect();
      if(!(r.right < selRect.left || r.left > selRect.right || r.bottom < selRect.top || r.top > selRect.bottom)) toRemove.push(n);
    }
  }
  toRemove.forEach(function(el){ var p=el.parentNode; while(el.firstChild) p.insertBefore(el.firstChild, el); p.removeChild(el); p.normalize(); });
  selbar.style.display='none';
  showToast('Highlight removed');
}

btnHL.addEventListener('click', doHighlight);
btnUH.addEventListener('click', removeHighlight);
</script>
<script>
// Notes
var notes = document.getElementById('notes');
var noteArea = document.getElementById('noteArea');
var btnCopy=document.getElementById('btnCopy');
var btnClose=document.getElementById('btnClose');

function toggleNotes(){ 
  notes.style.display = (notes.style.display==='flex'?'none':'flex'); 
}

window.toggleNotes = toggleNotes;

btnClose.addEventListener('click', toggleNotes);
btnCopy.addEventListener('click', async function(){ 
  await navigator.clipboard.writeText(noteArea.value||''); 
  showToast('Copied'); 
});

btnNote.addEventListener('click', function(){
  var text = '';
  if(currentHlNode){ text = (currentHlNode.textContent||'').trim(); }
  else if(lastRange){ var frag = lastRange.cloneContents(); text = (frag.textContent||'').trim(); }
  toggleNotes();
  if(text) noteArea.value = (noteArea.value? noteArea.value+'\n':'') + '> ' + text + '\n';
  selbar.style.display='none';
});

// Toast
var toastEl=document.getElementById('toast');
function showToast(msg){
  toastEl.textContent=msg; 
  toastEl.style.display='block';
  setTimeout(function(){ toastEl.style.display='none'; }, 1200);
}

// Dark Mode Toggle
function toggleDarkMode() {
  document.body.classList.toggle('dark-mode');
  const isDarkMode = document.body.classList.contains('dark-mode');
  localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');
  document.querySelector('.theme-toggle').textContent = isDarkMode ? '🌙' : '☀️';
}

// Initialize dark mode from localStorage
if (localStorage.getItem('darkMode') === 'enabled') {
  document.body.classList.add('dark-mode');
  document.querySelector('.theme-toggle').textContent = '🌙';
}
</script>
<script>
// Answer key and grading
var answers = {
  "q1":"NOT GIVEN", "q2":"FALSE", "q3":"TRUE", "q4":"TRUE", "q5":"FALSE", "q6":"NOT GIVEN", "q7":"FALSE",
  "q8":"29 centimetres", "q9":"rocks", "q10":"bill", "q11":"day",
  "q12":"plovers", "q13":"poison"
};

var acceptable = {
  // No acceptable alternatives specified
};

function markChoice(q, user){
  return String(user||'').toUpperCase() === String(answers[q]).toUpperCase();
}

function markBlank(q, user){
  var u = String(user||'').trim().toLowerCase();
  var key = String(answers[q]).trim().toLowerCase();
  if(acceptable[q]){
    return acceptable[q].map(a => a.toLowerCase()).indexOf(u) >= 0;
  }
  return u === key;
}

function grade(){
  var total=0, correct=0, lines=[];
  
  function push(q, ok, user){
    total++; if(ok) correct++;
    lines.push(q.toUpperCase()+": "+(user||'None')+" "+(ok?'✅':'❌'));
  }
  
  // Check radio questions (1-7)
  for(let n=1; n<=7; n++){
    const q = `q${n}`;
    const selected = document.querySelector(`input[name="${q}"]:checked`);
    const userAnswer = selected ? selected.value : '';
    const isCorrect = markChoice(q, userAnswer);
    push(q, isCorrect, userAnswer);
  }
  
  // Check blank questions (8-13)
  for(let n=8; n<=13; n++){
    const q = `q${n}`;
    const input = document.querySelector(`input[name="${q}"]`);
    const userAnswer = input ? input.value : '';
    const isCorrect = markBlank(q, userAnswer);
    push(q, isCorrect, userAnswer);
  }
  
  // Show results
  const acc = Math.round(100 * correct / total);
  document.getElementById('results').innerHTML = `
    <p><strong>Score:</strong> ${correct}/${total} <span class="badge">Accuracy ${acc}%</span></p>
    <pre>${lines.join('\n')}</pre>
  `;
  
  // Show answer key
  document.getElementById('answerContent').innerHTML = `
    <ol>
      <li>1 → NOT GIVEN</li>
      <li>2 → FALSE</li>
      <li>3 → TRUE</li>
      <li>4 → TRUE</li>
      <li>5 → FALSE</li>
      <li>6 → NOT GIVEN</li>
      <li>7 → FALSE</li>
      <li>8 → 29 centimetres</li>
      <li>9 → rocks</li>
      <li>10 → bill</li>
      <li>11 → day</li>
      <li>12 → plovers</li>
      <li>13 → poison</li>
    </ol>
  `;
  document.querySelector('#answerBox .badge').textContent = 'tap to view';
}

function resetForm(){
  // Reset radio buttons
  document.querySelectorAll('input[type="radio"]').forEach(radio => {
    radio.checked = false;
  });
  
  // Reset text inputs
  document.querySelectorAll('input.blank').forEach(input => {
    input.value = '';
  });
  
  // Reset results and answers
  document.getElementById('results').innerHTML = '';
  document.getElementById('answerContent').innerHTML = '';
  document.querySelector('#answerBox .badge').textContent = 'hidden';
  
  // Reset answered status in nav
  document.querySelectorAll('.q-item').forEach(item => {
    item.classList.remove('answered');
  });
}

// Scroll to question anchor
function scrollToElement(id){
  const el = document.getElementById(id);
  if(el){ 
    el.scrollIntoView({behavior:'smooth', block:'center'}); 
  }
  // Highlight nav item briefly
  const navs = document.querySelectorAll('.practice-nav .q-item');
  navs.forEach(n => n.classList.remove('active'));
  const btn = document.getElementById(id.replace('-anchor','-nav'));
  if(btn){ 
    btn.classList.add('active'); 
    setTimeout(() => btn.classList.remove('active'), 800); 
  }
}

// Mark answered on interaction
(function(){
  function markAnswered(qn){
    const nav = document.getElementById(`q${qn}-nav`);
    if(!nav) return;
    let answered = false;
    
    // Check radio buttons (1-7)
    if(qn >= 1 && qn <=7){
      const radios = document.querySelectorAll(`input[name="q${qn}"]:checked`);
      answered = radios.length > 0;
    } 
    // Check text inputs (8-13)
    else if(qn >=8 && qn <=13){
      const input = document.querySelector(`input[name="q${qn}"]`);
      answered = input && input.value.trim().length > 0;
    }
    
    if(answered) nav.classList.add('answered');
    else nav.classList.remove('answered');
  }
  
  // Monitor radio buttons
  for(let n=1; n<=7; n++){
    document.querySelectorAll(`input[name="q${n}"]`).forEach(radio => {
      radio.addEventListener('change', () => markAnswered(n));
    });
  }
  
  // Monitor text inputs
  for(let n=8; n<=13; n++){
    const input = document.querySelector(`input[name="q${n}"]`);
    if(input){
      input.addEventListener('input', () => markAnswered(n));
      input.addEventListener('blur', () => markAnswered(n));
    }
  }
})();
</script>

<!-- 练习页面数据传输增强脚本 -->
<script>
// 检查是否已经有增强脚本
if (!window.practicePageEnhancer) {
    // 动态加载增强脚本
    const script = document.createElement('script');
    script.src = '../../js/practice-page-enhancer.js';
    script.onload = function() {
        console.log('练习页面增强脚本已加载');
    };
    script.onerror = function() {
        console.error('练习页面增强脚本加载失败');
        // 降级到内联增强
        loadInlineEnhancer();
    };
    document.head.appendChild(script);
}

// 内联增强器（降级方案）
function loadInlineEnhancer() {
    if (window.practicePageEnhancer) return;
    
    window.practicePageEnhancer = {
        initialize: function() {
            console.log('[InlineEnhancer] 内联增强器已初始化');
            this.setupCommunication();
            this.setupAnswerListeners();
            this.interceptSubmit();
        },
        
        setupCommunication: function() {
            this.parentWindow = window.opener || window.parent;
            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'INIT_SESSION') {
                    this.sessionId = event.data.data.sessionId;
                    this.sendMessage('SESSION_READY', {
                        pageType: this.detectPageType(),
                        url: window.location.href
                    });
                }
            });
        },
        
        detectPageType: function() {
            const title = document.title || '';
            if (title.includes('P1')) return 'P1';
            if (title.includes('P2')) return 'P2';
            if (title.includes('P3')) return 'P3';
            return 'unknown';
        },
        
        setupAnswerListeners: function() {
            this.answers = {};
            this.startTime = Date.now();
            
            document.addEventListener('change', (e) => {
                if (e.target.name && e.target.name.startsWith('q')) {
                    this.answers[e.target.name] = e.target.value;
                }
            });
        },
        
        interceptSubmit: function() {
            // 拦截grade函数
            if (typeof window.grade === 'function') {
                const originalGrade = window.grade;
                window.grade = () => {
                    const result = originalGrade();
                    setTimeout(() => this.handleSubmit(), 200);
                    return result;
                };
            }
            
            // 监听提交按钮
            document.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' && 
                    (e.target.textContent.includes('Submit') || 
                     e.target.onclick && e.target.onclick.toString().includes('grade'))) {
                    setTimeout(() => this.handleSubmit(), 300);
                }
            });
        },
        
        handleSubmit: function() {
            const results = {
                sessionId: this.sessionId,
                startTime: this.startTime,
                endTime: Date.now(),
                duration: Math.round((Date.now() - this.startTime) / 1000),
                answers: this.answers,
                scoreInfo: this.extractScore(),
                pageType: this.detectPageType(),
                url: window.location.href
            };
            
            this.sendMessage('PRACTICE_COMPLETE', results);
        },
        
        extractScore: function() {
            const resultsEl = document.getElementById('results');
            if (!resultsEl) return null;
            
            const text = resultsEl.textContent || '';
            const scoreMatch = text.match(/(\d+)\/(\d+)/);
            const accuracyMatch = text.match(/Accuracy\s+(\d+)%/);
            
            return scoreMatch ? {
                score: parseInt(scoreMatch[1]),
                total: parseInt(scoreMatch[2]),
                accuracy: accuracyMatch ? parseInt(accuracyMatch[1]) : 0
            } : null;
        },
        
        sendMessage: function(type, data) {
            if (this.parentWindow && this.parentWindow !== window) {
                this.parentWindow.postMessage({
                    type: type,
                    data: data,
                    source: 'practicePageEnhancer'
                }, '*');
            }
        }
    };
    
    // 自动初始化
    document.addEventListener('DOMContentLoaded', function() {
        window.practicePageEnhancer.initialize();
    });
    
    // 如果DOM已经加载完成
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            window.practicePageEnhancer.initialize();
        });
    } else {
        window.practicePageEnhancer.initialize();
    }
}

// 页面加载完成后尝试加载增强器
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadInlineEnhancer);
} else {
    loadInlineEnhancer();
}
</script>

</body>
</html>