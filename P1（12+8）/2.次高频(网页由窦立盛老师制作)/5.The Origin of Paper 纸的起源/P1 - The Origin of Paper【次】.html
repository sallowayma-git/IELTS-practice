<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>P1 – The Origin of Paper</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<style>
  :root { --line:#e5e7eb; --bg:#f6f7fb; --panel:#fff; --accent:#3b82f6; --muted:#6b7280; --shadow:0 6px 20px rgba(0,0,0,.12); }
  * { box-sizing: border-box; }
  html,body { height:100%; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); }
  #timer { position: static; display: inline-block; margin-left: 8px; background:#fff; border:1px solid var(--line); border-radius:10px; padding:2px 8px; font-size:14px; vertical-align: middle; }
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:var(--panel); overflow:auto; padding:20px; }
  #left { flex: 0 0 50%; min-width: 280px; }
  #right { flex: 1 1 auto; min-width: 320px; background:#fbfbff; border-left:1px solid var(--line); }
  #divider { flex: 0 0 8px; background: linear-gradient(90deg,#e5e7eb,#d1d5db); cursor: ew-resize; position:relative; z-index: 5; user-select:none; }
  h2,h3,h4 { margin:0 0 10px; }
  #left p { margin: 0 0 12px; line-height: 1.6; word-break: normal; overflow-wrap: normal; hyphens: none; }
  .group { background:#fff; border:1px solid var(--line); border-radius:10px; padding:12px; margin-bottom:14px; }
  table { border-collapse: collapse; width:100%; }
  th, td { border:1px solid var(--line); padding:6px; text-align:center; font-size:14px; }
  th:first-child, td:first-child { width:92px; }
  button { padding:8px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; cursor:pointer; }
  button.primary { background:var(--accent); color:#fff; border-color:#3b82f6; }
  #results { background:#fff; border:1px solid var(--line); border-radius:10px; padding:10px; }
  .hl { background:#fff3a3; box-shadow: inset 0 -2px 0 rgba(0,0,0,.05); cursor: pointer; }
  .hl:hover { filter: brightness(0.98); }
  #selbar { position: absolute; display:none; z-index: 2000; background:#111; color:#fff; border-radius: 8px; padding: 6px; box-shadow: var(--shadow); font-size: 13px; gap:6px; align-items: center; }
  #selbar button { background: transparent; color:#fff; border: 1px solid rgba(255,255,255,.25); padding: 4px 8px; border-radius: 6px; cursor:pointer; }
  #selbar button:hover { border-color:#fff; }
  #notes { position: fixed; right: 12px; bottom: 12px; width: 320px; height: 42vh; background:#fff; border:1px solid var(--line); border-radius: 12px; display:none; flex-direction: column; z-index:1500; box-shadow: var(--shadow); }
  #notes header { display:flex; align-items:center; justify-content: space-between; padding:8px 10px; border-bottom:1px solid var(--line); }
  #notes textarea { flex:1; border:0; padding:10px; resize:none; font-size:14px; line-height:1.5; }
  #toast { position: fixed; left:50%; transform: translateX(-50%); bottom: 24px; background:#111; color:#fff; padding:8px 12px; border-radius: 8px; display:none; z-index:2500; }
  .dropzone { border:2px dashed #cbd5e1; background:#f8fafc; border-radius:10px; min-height:40px; padding:4px 8px; display:inline-flex; align-items:center; justify-content:space-between; gap:8px; width: auto; min-width: 120px; max-width: 200px; vertical-align: middle; }
  .droplabel { color:#64748b; font-size:14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .cardpool { background:#f1f5f9; border-radius:10px; padding:12px; display:flex; flex-wrap:wrap; gap:8px; }
  .pool-slot { min-height:40px; }
  .card { background:#fff; border:1px solid #e5e7eb; border-radius:8px; padding:8px 10px; display:inline-flex; gap:8px; align-items:center; cursor:grab; box-shadow:0 1px 0 rgba(0,0,0,.03); white-space: nowrap; }
  .card:active { cursor:grabbing; }
  .tag { background:#eef2ff; color:#4338ca; padding:2px 8px; border-radius:999px; font-size:12px; }
  .btn-clear { border:1px solid #e5e7eb; background:#fff; border-radius:8px; padding:6px 8px; cursor:pointer; }
  .ghost { opacity: .5; }
  .over { outline:2px dashed #3b82f6; }
  details.answerbox summary { cursor: pointer; user-select:none; list-style: none; }
  details.answerbox { border:1px dashed var(--line); border-radius:10px; padding:8px 10px; background:#fff; }
  .badge { display:inline-block; background:#eef2ff; color:#4338ca; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:6px; }
  body { padding-bottom: 82px; }
  .practice-nav { background:#fff; border-bottom:2px solid var(--line); padding:12px 20px; display:flex; align-items:center; gap:20px; box-shadow:0 2px 4px rgba(0,0,0,.05); flex-wrap:wrap; position:fixed; left:0; right:0; bottom:0; border-top:2px solid var(--line); border-bottom:0; z-index:4000; }
  .practice-nav .title { font-weight:600; color:var(--muted); }
  .practice-nav .questions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .practice-nav .q-item { padding:6px 10px; border:1px solid var(--line); border-radius:6px; background:#fff; cursor:pointer; font-size:14px; transition:all 0.2s; min-width:36px; text-align:center; }
  .practice-nav .q-item:hover { background:#f1f5f9; border-color:var(--accent); }
  .practice-nav .q-item.answered { background:#e0e7ff; border-color:var(--accent); color:var(--accent); font-weight:500; }
  .practice-nav .q-item.active { background:var(--accent); color:#fff; border-color:var(--accent); }
  #selbar { z-index: 6000 !important; }
</style>
</head>
<body>
<div class="practice-nav">
  <div class="title">Questions</div>
  <div class="questions">
    <div class="q-item" id="q1-nav" onclick="scrollToElement('q1-anchor')">1</div>
    <div class="q-item" id="q2-nav" onclick="scrollToElement('q2-anchor')">2</div>
    <div class="q-item" id="q3-nav" onclick="scrollToElement('q3-anchor')">3</div>
    <div class="q-item" id="q4-nav" onclick="scrollToElement('q4-anchor')">4</div>
    <div class="q-item" id="q5-nav" onclick="scrollToElement('q5-anchor')">5</div>
    <div class="q-item" id="q6-nav" onclick="scrollToElement('q6-anchor')">6</div>
    <div class="q-item" id="q7-nav" onclick="scrollToElement('q7-anchor')">7</div>
    <div class="q-item" id="q8-nav" onclick="scrollToElement('q8-anchor')">8</div>
    <div class="q-item" id="q9-nav" onclick="scrollToElement('q9-anchor')">9</div>
    <div class="q-item" id="q10-nav" onclick="scrollToElement('q10-anchor')">10</div>
    <div class="q-item" id="q11-nav" onclick="scrollToElement('q11-anchor')">11</div>
    <div class="q-item" id="q12-nav" onclick="scrollToElement('q12-anchor')">12</div>
    <div class="q-item" id="q13-nav" onclick="scrollToElement('q13-anchor')">13</div>
  </div>
</div>
<div class="shell">
  <section class="pane" id="left">
    <h2>READING PASSAGE 1 <span id="timer">00:00</span></h2>
    <p>You should spend about 20 minutes on Questions 1–13, which are based on Reading Passage 1 below.</p>
    <h3>The Origin of Paper</h3>
    
    <p>The word paper derives from the Greek term for the ancient Egyptian writing material called papyrus. In about 2400 BC, the Egyptians discovered how to make a writing surface out of papyrus, a type of reed that grows along waterways in southern Europe and North Africa. The Egyptians cut the plant into strips which they softened in water. Papyrus was crosswoven into a mat and then pounded into a hard, thin sheet.</p>
    
    <p>As the papyrus plant requires subtropical conditions to grow, papyrus was not much used in Europe at that time; instead, the main material used for writing was parchment. This was made from animal skin and was extremely expensive. In fact, it has been estimated that a single book written on parchment required the skins of 300 sheep. The skins had to be specially prepared by drying them and they were then stretched on a special frame. It is not known when parchment was first introduced, but it was the main writing material in Europe for hundreds of years.</p>
    
    <p>Paper-made from pulp, rags and fibres of plants-seems to have been invented in China and is considered to be one of the Four Great Inventions of Ancient China. In 105 AD, under the Han-Dynasty emperor Ho-Ti, a government official in China named Ts’ai Lun was the first to start a papermaking industry. Ts’ai Lun seems to have made his paper by mixing finely chopped mulberry bark and hemp rags with water, mashing the mixture flat with a stone mortar, and then pressing out the water and letting it dry in the sun. He may have based his idea on bark cloth, which was very common in China and also made from mulberry.</p>
    
    <p>Previously, during the Shang (1600-1050 BC) and Zhou (1050-256 BC) dynasties of Ancient China, documents were ordinarily written on bone or bamboo (on tablets or bamboo strips bound and rolled together into scrolls), making them very heavy and awkward to transport. The light material of silk was sometimes used, but was normally too expensive to consider. When paper was first invented, it was used for purposes of wrapping or padding protection for delicate bronze mirrors. Although paper for writing became popular by the 3rd century AD, it continued to be used for wrapping and other purposes.</p>
    
    <p>During the Tang Dynasty (618-907 AD) paper was folded and sewn into square bags to preserve the flavour of tea. During the same period, according to a written account, tea was served from baskets with multi-coloured paper cups and paper napkins of different sizes and shapes. During the Chinese Song Dynasty (960-1279 AD) not only did the government produce the world’s first known printed paper money, or banknote, but paper money bestowed as gifts was wrapped in special paper envelopes.</p>
    
    <p>Paper spread widely outside China; other Asian cultures, even after seeing paper, could not make it themselves. Instruction in the manufacturing process was required, and the Chinese were reluctant to share their secrets. It made its true push westward in 751 AD when the Tang Dynasty was at war with the Islamic world. During a battle on the banks of the Talas River, a Chinese caravan was captured which happened to include several papermakers. They were taken away to Samarkand, which was a good place to make paper because it had an abundant supply of hemp and flax. Samarkanders changed the technology of manufacturing paper. They began to prepare it in stone mills and Samarkand became an important papermaking centre.</p>
    
    <p>The rudimentary and laborious process of papermaking was refined, and bulk manufacturing of paper began in Iran, where they invented a method to make a thicker sheet of paper, which helped transform papermaking from an art into an important business.</p>
    
    <p>Gradually papermakers made their way further west through the Arab world-to Baghdad, Damascus and Cairo. Finally, when the Moors from North Africa invaded Spain and Portugal, they brought the technology with them and so it was that papermaking entered Europe in the 12th century.</p>
    
    <p>In Europe, the preferred medium for the artists and literati of the time was still the smooth and lustrous parchment. The notion of paper being used as a practical everyday item did not occur until the 15th century, when Johannes Gutenberg perfected movable-type printing, which included the use of metal moulds and alloys, a special press, and oil-based inks, allowing the mass production of printed books. The birth of the modern paper and printing industry is commonly marked from this date.</p>
    
    <p>Printing technology rapidly developed and created an ever-increasing demand for paper. The early European papers were made from recycled cotton and linen-and a huge trade quickly developed around the trading of old rags. It is said that the disease known as the Black Death entered England from Europe on these old rags. Yet soon this source became insufficient and some curious attempts were made to find new materials. Experiments with fibres such as straw, cabbage, wasp nests and finally wood resulted in inexpensive-and replaceable-materials for papermaking. Today, the long, soft fibres of softwoods such as spruce have become the most suitable source of pulp for the mass production of paper.</p>
    
    <p>&nbsp;</p> <!-- 添加空白行防止加载不完全 -->
  </section>
  <div id="divider" title="Drag to resize"></div>
  <section class="pane" id="right">
    <h3>Questions</h3>
    
    <div class="group">
      <h4>Questions 1–7</h4>
      <p>Do the following statements agree with the information given in Reading Passage 1?</p>
      <p>In boxes 1-7 on your answer sheet, write</p>
      <ul>
        <li>TRUE if the statement agrees with the information</li>
        <li>FALSE if the statement contradicts the information</li>
        <li>NOT GIVEN if there is no information on this</li>
      </ul>
      
      <a id="q1-anchor"></a>
      <div id="q1-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>1 In Ancient China, writing was occasionally done on silk.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q1" type="radio" value="TRUE"> TRUE</label>
          <label style="margin:0;"><input name="q1" type="radio" value="FALSE"> FALSE</label>
          <label style="margin:0;"><input name="q1" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <a id="q2-anchor"></a>
      <div id="q2-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>2 Coloured paper was invented during the Tang Dynasty.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q2" type="radio" value="TRUE"> TRUE</label>
          <label style="margin:0;"><input name="q2" type="radio" value="FALSE"> FALSE</label>
          <label style="margin:0;"><input name="q2" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <a id="q3-anchor"></a>
      <div id="q3-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>3 Papermakers from Samarkand were captured by the Chinese.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q3" type="radio" value="TRUE"> TRUE</label>
          <label style="margin:0;"><input name="q3" type="radio" value="FALSE"> FALSE</label>
          <label style="margin:0;"><input name="q3" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <a id="q4-anchor"></a>
      <div id="q4-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>4 Papermaking as a large-scale industry originated in Iran.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q4" type="radio" value="TRUE"> TRUE</label>
          <label style="margin:0;"><input name="q4" type="radio" value="FALSE"> FALSE</label>
          <label style="margin:0;"><input name="q4" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <a id="q5-anchor"></a>
      <div id="q5-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>5 Papermaking skills were brought to Europe via North Africa.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q5" type="radio" value="TRUE"> TRUE</label>
          <label style="margin:0;"><input name="q5" type="radio" value="FALSE"> FALSE</label>
          <label style="margin:0;"><input name="q5" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <a id="q6-anchor"></a>
      <div id="q6-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>6 When Gutenberg invented movable type, paper materials were very expensive.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q6" type="radio" value="TRUE"> TRUE</label>
          <label style="margin:0;"><input name="q6" type="radio" value="FALSE"> FALSE</label>
          <label style="margin:0;"><input name="q6" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <a id="q7-anchor"></a>
      <div id="q7-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>7 The end of the trade in rags was brought about by the difficulty of transporting them.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q7" type="radio" value="TRUE"> TRUE</label>
          <label style="margin:0;"><input name="q7" type="radio" value="FALSE"> FALSE</label>
          <label style="margin:0;"><input name="q7" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
    </div>
    
    <div class="group">
      <h4>Questions 8–13</h4>
      <p>Complete the table below.</p>
      <p>Choose ONE WORD ONLY from the passage for each answer.</p>
      <p>Write your answers in boxes 8-13 on your answer sheet.</p>
      
      <table>
        <thead>
          <tr>
            <th>Place</th>
            <th>Date of introduction</th>
            <th>Materials used</th>
            <th>Method of production</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Egypt</td>
            <td>about 2400 BC</td>
            <td>a plant called papyrus</td>
            <td>8 ________ softened in water, woven and pounded</td>
          </tr>
          <tr>
            <td>Europe</td>
            <td>unknown</td>
            <td>parchment made from the skin of animals such as 9 ________</td>
            <td>skin was dried and 10 ________</td>
          </tr>
          <tr>
            <td>China</td>
            <td>105 AD</td>
            <td>11 ________ of a mulberry tree and hemp rags</td>
            <td>ingredients were mixed with water, pressed and put outside in the sun</td>
          </tr>
          <tr>
            <td>12 ________</td>
            <td>751 AD</td>
            <td>flax and hemp</td>
            <td>mills made of 13 ________ were used</td>
          </tr>
        </tbody>
      </table>
      
      <div style="margin-top: 10px;">
        <a id="q8-anchor"></a>
        <div id="q8-section" style="padding:4px 0;">
          <p>8 <input class="blank" maxlength="20" name="q8" placeholder="Answer here"/></p>
        </div>
        
        <a id="q9-anchor"></a>
        <div id="q9-section" style="padding:4px 0;">
          <p>9 <input class="blank" maxlength="20" name="q9" placeholder="Answer here"/></p>
        </div>
        
        <a id="q10-anchor"></a>
        <div id="q10-section" style="padding:4px 0;">
          <p>10 <input class="blank" maxlength="20" name="q10" placeholder="Answer here"/></p>
        </div>
        
        <a id="q11-anchor"></a>
        <div id="q11-section" style="padding:4px 0;">
          <p>11 <input class="blank" maxlength="20" name="q11" placeholder="Answer here"/></p>
        </div>
        
        <a id="q12-anchor"></a>
        <div id="q12-section" style="padding:4px 0;">
          <p>12 <input class="blank" maxlength="20" name="q12" placeholder="Answer here"/></p>
        </div>
        
        <a id="q13-anchor"></a>
        <div id="q13-section" style="padding:4px 0;">
          <p>13 <input class="blank" maxlength="20" name="q13" placeholder="Answer here"/></p>
        </div>
      </div>
    </div>
    
    <div style="display:flex;gap:8px;margin-bottom:10px;">
      <button class="primary" onclick="grade()">Submit</button>
      <button onclick="resetForm()">Reset</button>
      <button onclick="toggleNotes()">Notes</button>
    </div>
    <div id="results"></div>
    <details class="answerbox" id="answerBox">
      <summary>Show answers (click to toggle) <span class="badge">hidden</span></summary>
      <div id="answerContent"></div>
    </details>
  </section>
</div>
<div aria-label="Selection tools" id="selbar" role="toolbar">
  <button id="btnHL">Highlight</button>
  <button id="btnUH">Remove</button>
  <button id="btnNote">Note</button>
</div>
<div id="notes">
  <header>
    <strong>Notes</strong>
    <div>
      <button id="btnCopy">Copy</button>
      <button id="btnClose">Close</button>
    </div>
  </header>
  <textarea id="noteArea" placeholder="Type your notes here..."></textarea>
</div>
<div id="toast"></div>
<script>
// Timer
let _t=0; const _timerEl=document.getElementById('timer');
setInterval(function(){ 
  _t++; 
  var m=String(Math.floor(_t/60)).padStart(2,'0'); 
  var s=String(_t%60).padStart(2,'0'); 
  _timerEl.textContent=m+':'+s; 
},1000);

// Drag divider
var divider = document.getElementById('divider');
var left = document.getElementById('left');
var right = document.getElementById('right');
var dragging=false;

function startDrag(e){ 
  dragging=true; 
  document.body.style.cursor='ew-resize'; 
  if(e.preventDefault) e.preventDefault(); 
}

function endDrag(){ 
  dragging=false; 
  document.body.style.cursor=''; 
}

function onMove(clientX){
  var container = document.querySelector('.shell').getBoundingClientRect();
  var x = clientX - container.left;
  x = Math.max(280, Math.min(container.width-320, x));
  left.style.flex = '0 0 ' + x + 'px';
  right.style.flex = '1 1 auto';
}

divider.addEventListener('mousedown', function(e){ startDrag(e); });
window.addEventListener('mousemove', function(e){ if(dragging) onMove(e.clientX); });
window.addEventListener('mouseup', endDrag);
divider.addEventListener('touchstart', function(e){ startDrag(e.touches[0]); }, {passive:false});
window.addEventListener('touchmove', function(e){ if(dragging) onMove(e.touches[0].clientX); }, {passive:false});
window.addEventListener('touchend', endDrag);
</script>
<script>
// Highlight toolbar
var selbar = document.getElementById('selbar');
var btnHL = document.getElementById('btnHL');
var btnUH = document.getElementById('btnUH');
var btnNote = document.getElementById('btnNote');
var lastRange=null;
var currentHlNode=null;
var keepToolbar=false;

function positionSelbarForRect(rect){
  selbar.style.display='flex';
  requestAnimationFrame(function(){
    var top = window.scrollY + rect.top - selbar.offsetHeight - 8;
    var leftPos = window.scrollX + rect.left + rect.width/2 - selbar.offsetWidth/2;
    selbar.style.top = ((top>0)?top:(window.scrollY + rect.bottom + 8)) + 'px';
    selbar.style.left = Math.max(8, leftPos) + 'px';
  });
}

function updateSelbar(){
  var sel=window.getSelection();
  if(!sel || sel.rangeCount===0 || sel.isCollapsed) { 
    selbar.style.display='none'; 
    currentHlNode=null; 
    return; 
  }
  var range = sel.getRangeAt(0);
  lastRange = range.cloneRange();
  currentHlNode=null;
  positionSelbarForRect(range.getBoundingClientRect());
}

document.getElementById('left').addEventListener('mouseup', updateSelbar);
document.getElementById('right').addEventListener('mouseup', updateSelbar);
document.addEventListener('selectionchange', function(){ 
  var sel=window.getSelection(); 
  if(!sel || sel.rangeCount===0 || sel.isCollapsed){ 
    if(!keepToolbar && !currentHlNode){ 
      selbar.style.display='none'; 
    } 
  } 
});
document.addEventListener('scroll', function(){ 
  if(selbar.style.display==='flex') updateSelbar(); 
});

document.addEventListener('mousedown', function(e){
  var t = e.target;
  if(t.classList && t.classList.contains('hl')){
    keepToolbar = true;
  } else {
    keepToolbar = false;
  }
}, true);

document.addEventListener('click', function(e){
  var target = e.target;
  if(target.classList && target.classList.contains('hl')){
    currentHlNode = target;
    lastRange = null;
    positionSelbarForRect(target.getBoundingClientRect());
    var sel=window.getSelection();
    if(sel) sel.removeAllRanges();
    setTimeout(function(){ keepToolbar=false; }, 0);
  }
}, true);

function doHighlight(){
  if(currentHlNode) return;
  if(!lastRange || lastRange.collapsed) return;
  var span=document.createElement('span'); span.className='hl';
  try { lastRange.surroundContents(span); }
  catch(e){
    var wrap=document.createElement('span'); wrap.className='hl';
    wrap.appendChild(lastRange.cloneContents());
    lastRange.deleteContents();
    lastRange.insertNode(wrap);
  }
  selbar.style.display='none';
  showToast('Highlighted');
}

function removeHighlight(){
  if(currentHlNode){
    var p = currentHlNode.parentNode;
    while(currentHlNode.firstChild) p.insertBefore(currentHlNode.firstChild, currentHlNode);
    p.removeChild(currentHlNode); p.normalize();
    currentHlNode = null;
    selbar.style.display='none';
    showToast('Highlight removed');
    return;
  }
  if(!lastRange) return;
  var selRect = lastRange.getBoundingClientRect();
  var walker=document.createTreeWalker(document.body, NodeFilter.SHOW_ELEMENT);
  var toRemove=[];
  while(walker.nextNode()){
    var n=walker.currentNode;
    if(n.classList && n.classList.contains('hl')) {
      var r = n.getBoundingClientRect();
      if(!(r.right < selRect.left || r.left > selRect.right || r.bottom < selRect.top || r.top > selRect.bottom)) toRemove.push(n);
    }
  }
  toRemove.forEach(function(el){ var p=el.parentNode; while(el.firstChild) p.insertBefore(el.firstChild, el); p.removeChild(el); p.normalize(); });
  selbar.style.display='none';
  showToast('Highlight removed');
}

btnHL.addEventListener('click', doHighlight);
btnUH.addEventListener('click', removeHighlight);
</script>
<script>
// Notes
var notes = document.getElementById('notes');
var noteArea = document.getElementById('noteArea');
var btnCopy=document.getElementById('btnCopy');
var btnClose=document.getElementById('btnClose');

function toggleNotes(){ 
  notes.style.display = (notes.style.display==='flex'?'none':'flex'); 
}

window.toggleNotes = toggleNotes;

btnClose.addEventListener('click', toggleNotes);
btnCopy.addEventListener('click', async function(){ 
  await navigator.clipboard.writeText(noteArea.value||''); 
  showToast('Copied'); 
});

btnNote.addEventListener('click', function(){
  var text = '';
  if(currentHlNode){ text = (currentHlNode.textContent||'').trim(); }
  else if(lastRange){ var frag = lastRange.cloneContents(); text = (frag.textContent||'').trim(); }
  toggleNotes();
  if(text) noteArea.value = (noteArea.value? noteArea.value+'\n':'') + '> ' + text + '\n';
  selbar.style.display='none';
});

// Toast
var toastEl=document.getElementById('toast');
function showToast(msg){
  toastEl.textContent=msg; 
  toastEl.style.display='block';
  setTimeout(function(){ toastEl.style.display='none'; }, 1200);
}
</script>
<script>
// Answer key and grading
var answers = {
  "q1":"TRUE", "q2":"NOT GIVEN", "q3":"FALSE", "q4":"TRUE", "q5":"TRUE", "q6":"NOT GIVEN", "q7":"FALSE",
  "q8":"strips", "q9":"sheep", "q10":"stretched", "q11":"bark", "q12":"Samarkand", "q13":"stone"
};

var acceptable = {
  // No acceptable alternatives specified in the original document
};

function markChoice(q, user){
  return String(user||'').toUpperCase() === String(answers[q]).toUpperCase();
}

function markBlank(q, user){
  var u = String(user||'').trim().toLowerCase();
  var key = String(answers[q]).trim().toLowerCase();
  if(acceptable[q]){
    return acceptable[q].map(a => a.toLowerCase()).indexOf(u) >= 0;
  }
  return u === key;
}

function grade(){
  var total=0, correct=0, lines=[];
  
  function push(q, ok, user){
    total++; if(ok) correct++;
    lines.push(q.toUpperCase()+": "+(user||'None')+" "+(ok?'✅':'❌'));
  }
  
  // Check radio questions (1-7)
  for(let n=1; n<=7; n++){
    const q = `q${n}`;
    const selected = document.querySelector(`input[name="${q}"]:checked`);
    const userAnswer = selected ? selected.value : '';
    const isCorrect = markChoice(q, userAnswer);
    push(q, isCorrect, userAnswer);
  }
  
  // Check blank questions (8-13)
  for(let n=8; n<=13; n++){
    const q = `q${n}`;
    const input = document.querySelector(`input[name="${q}"]`);
    const userAnswer = input ? input.value : '';
    const isCorrect = markBlank(q, userAnswer);
    push(q, isCorrect, userAnswer);
  }
  
  // Show results
  const acc = Math.round(100 * correct / total);
  document.getElementById('results').innerHTML = `
    <p><strong>Score:</strong> ${correct}/${total} <span class="badge">Accuracy ${acc}%</span></p>
    <pre>${lines.join('\n')}</pre>
  `;
  
  // Show answer key
  document.getElementById('answerContent').innerHTML = `
    <ol>
      <li>1 → TRUE</li>
      <li>2 → NOT GIVEN</li>
      <li>3 → FALSE</li>
      <li>4 → TRUE</li>
      <li>5 → TRUE</li>
      <li>6 → NOT GIVEN</li>
      <li>7 → FALSE</li>
      <li>8 → strips</li>
      <li>9 → sheep</li>
      <li>10 → stretched</li>
      <li>11 → bark</li>
      <li>12 → Samarkand</li>
      <li>13 → stone</li>
    </ol>
  `;
  document.querySelector('#answerBox .badge').textContent = 'tap to view';
}

function resetForm(){
  // Reset radio buttons
  document.querySelectorAll('input[type="radio"]').forEach(radio => {
    radio.checked = false;
  });
  
  // Reset text inputs
  document.querySelectorAll('input.blank').forEach(input => {
    input.value = '';
  });
  
  // Reset results and answers
  document.getElementById('results').innerHTML = '';
  document.getElementById('answerContent').innerHTML = '';
  document.querySelector('#answerBox .badge').textContent = 'hidden';
  
  // Reset answered status in nav
  document.querySelectorAll('.q-item').forEach(item => {
    item.classList.remove('answered');
  });
}

// Scroll to question anchor
function scrollToElement(id){
  const el = document.getElementById(id);
  if(el){ 
    el.scrollIntoView({behavior:'smooth', block:'center'}); 
  }
  // Highlight nav item briefly
  const navs = document.querySelectorAll('.practice-nav .q-item');
  navs.forEach(n => n.classList.remove('active'));
  const btn = document.getElementById(id.replace('-anchor','-nav'));
  if(btn){ 
    btn.classList.add('active'); 
    setTimeout(() => btn.classList.remove('active'), 800); 
  }
}

// Mark answered on interaction
(function(){
  function markAnswered(qn){
    const nav = document.getElementById(`q${qn}-nav`);
    if(!nav) return;
    let answered = false;
    
    // Check radio buttons (1-7)
    if(qn >= 1 && qn <=7){
      const radios = document.querySelectorAll(`input[name="q${qn}"]:checked`);
      answered = radios.length > 0;
    } 
    // Check text inputs (8-13)
    else if(qn >=8 && qn <=13){
      const input = document.querySelector(`input[name="q${qn}"]`);
      answered = input && input.value.trim().length > 0;
    }
    
    if(answered) nav.classList.add('answered');
    else nav.classList.remove('answered');
  }
  
  // Monitor radio buttons
  for(let n=1; n<=7; n++){
    document.querySelectorAll(`input[name="q${n}"]`).forEach(radio => {
      radio.addEventListener('change', () => markAnswered(n));
    });
  }
  
  // Monitor text inputs
  for(let n=8; n<=13; n++){
    const input = document.querySelector(`input[name="q${n}"]`);
    if(input){
      input.addEventListener('input', () => markAnswered(n));
      input.addEventListener('blur', () => markAnswered(n));
    }
  }
})();
</script>

<!-- 练习页面数据传输增强脚本 -->
<script>
// 检查是否已经有增强脚本
if (!window.practicePageEnhancer) {
    // 动态加载增强脚本
    const script = document.createElement('script');
    script.src = '../../js/practice-page-enhancer.js';
    script.onload = function() {
        console.log('练习页面增强脚本已加载');
    };
    script.onerror = function() {
        console.error('练习页面增强脚本加载失败');
        // 降级到内联增强
        loadInlineEnhancer();
    };
    document.head.appendChild(script);
}

// 内联增强器（降级方案）
function loadInlineEnhancer() {
    if (window.practicePageEnhancer) return;
    
    window.practicePageEnhancer = {
        initialize: function() {
            console.log('[InlineEnhancer] 内联增强器已初始化');
            this.setupCommunication();
            this.setupAnswerListeners();
            this.interceptSubmit();
        },
        
        setupCommunication: function() {
            this.parentWindow = window.opener || window.parent;
            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'INIT_SESSION') {
                    this.sessionId = event.data.data.sessionId;
                    this.sendMessage('SESSION_READY', {
                        pageType: this.detectPageType(),
                        url: window.location.href
                    });
                }
            });
        },
        
        detectPageType: function() {
            const title = document.title || '';
            if (title.includes('P1')) return 'P1';
            if (title.includes('P2')) return 'P2';
            if (title.includes('P3')) return 'P3';
            return 'unknown';
        },
        
        setupAnswerListeners: function() {
            this.answers = {};
            this.startTime = Date.now();
            
            document.addEventListener('change', (e) => {
                if (e.target.name && e.target.name.startsWith('q')) {
                    this.answers[e.target.name] = e.target.value;
                }
            });
        },
        
        interceptSubmit: function() {
            // 拦截grade函数
            if (typeof window.grade === 'function') {
                const originalGrade = window.grade;
                window.grade = () => {
                    const result = originalGrade();
                    setTimeout(() => this.handleSubmit(), 200);
                    return result;
                };
            }
            
            // 监听提交按钮
            document.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' && 
                    (e.target.textContent.includes('Submit') || 
                     e.target.onclick && e.target.onclick.toString().includes('grade'))) {
                    setTimeout(() => this.handleSubmit(), 300);
                }
            });
        },
        
        handleSubmit: function() {
            const results = {
                sessionId: this.sessionId,
                startTime: this.startTime,
                endTime: Date.now(),
                duration: Math.round((Date.now() - this.startTime) / 1000),
                answers: this.answers,
                scoreInfo: this.extractScore(),
                pageType: this.detectPageType(),
                url: window.location.href
            };
            
            this.sendMessage('PRACTICE_COMPLETE', results);
        },
        
        extractScore: function() {
            const resultsEl = document.getElementById('results');
            if (!resultsEl) return null;
            
            const text = resultsEl.textContent || '';
            const scoreMatch = text.match(/Score:\s*(\d+)\/(\d+)/i);
            if (scoreMatch) {
                const correct = parseInt(scoreMatch[1]);
                const total = parseInt(scoreMatch[2]);
                return {
                    correct: correct,
                    total: total,
                    accuracy: total > 0 ? correct / total : 0,
                    percentage: Math.round((correct / total) * 100),
                    source: 'inline_extraction'
                };
            }
            return null;
        },
        
        sendMessage: function(type, data) {
            if (this.parentWindow) {
                this.parentWindow.postMessage({
                    type: type,
                    data: data,
                    source: 'practice_page'
                }, '*');
            }
        }
    };
    
    // 初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            window.practicePageEnhancer.initialize();
        });
    } else {
        window.practicePageEnhancer.initialize();
    }
}
</script>

</body>
</html>