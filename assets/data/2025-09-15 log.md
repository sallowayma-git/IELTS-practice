### 操作日志：练习记录功能修复与临时JSON导出按钮添加

**日期**：2025年9月15日  
**操作人**：Grok（xAI生成）  
**上下文**：针对练习记录功能问题（正确答案显示为N/A、导出格式错误、消息类型混淆等），参考0.2版本实现，完成了多项修复，并新增临时JSON导出按钮以协助问题复现和数据验证。

---

#### 一、问题背景与目标
1. **问题描述**：
   - 练习记录页面（js/main.js）中，“导出数据”按钮错误调用JSON导出（`exportPracticeData`），应为Markdown格式（参考0.2版本）。
   - 练习历史详情弹窗（`js/components/practiceRecordModal.js`）显示正确答案为“N/A”，尤其是新练习记录（例：题号i, vi, ix, x等）。
   - 主应用监听`PRACTICE_COMPLETE`，但`js/main.js`仍监听未使用的`practice_completed`，导致消息处理混淆；本地文件协议下`origin`为`null`时丢消息。
   - 需要添加临时JSON导出按钮，方便提取问题记录样本以验证题号键不一致（罗马数字 vs 数字/q前缀）导致的N/A问题。

2. **目标**：
   - 统一消息类型，消除`practice_completed`混淆，确保本地文件协议兼容。
   - 修复练习记录页面导出为Markdown（`ielts-practice-records-YYYY-MM-DD.md`）。
   - 修复练习历史详情正确答案缺失（N/A），参考0.2版本`practiceHistory`的字段读取逻辑。
   - 添加临时JSON导出按钮（`practice-record-<记录ID>.json`），协助提供样本数据以精准修复题号键不一致问题。

---

#### 二、已完成变更
以下为针对上述问题的具体代码修改与实现，基于用户提供的上下文和0.2版本参考。

##### 1. 统一消息类型（消除`practice_completed`混淆）
- **文件**：`js/main.js`
- **变更**：
  - 修改`setupMessageListener`函数：
    - 放宽安全检查，允许`file://`协议下的`null origin`（本地页面兼容）。
    - 统一处理`PRACTICE_COMPLETE`和`practice_completed`两种消息类型，触发`syncPracticeRecords()`（300ms延迟确保存储同步）。
  - **代码片段**：
    ```diff
    --- js/main.js
    +++ js/main.js
    @@ -73,17 +73,19 @@
     function setupMessageListener() {
         window.addEventListener('message', (event) => {
    -        // Basic security check
    (17 lines truncated)
    +            console.log('[System] 收到练习完成消息，正在同步记录...');
                 showMessage('练习已完成，正在更新记录...', 'success');
    -            // Use a timeout to ensure storage has been updated by the other window
    -            setTimeout(syncPracticeRecords, 500);
    +            setTimeout(syncPracticeRecords, 300);
             }
         });
     }
    ```
- **效果**：
  - 本地页面（`file://`）也能正常接收消息。
  - 两种消息类型均触发记录同步，页面无需刷新即可显示新记录。
  - 消除了`practice_completed`的潜在混淆。

##### 2. 练习记录页导出改为Markdown格式
- **文件**：
  - `index.html`：更新“导出数据”按钮调用。
  - `js/utils/markdownExporter.js`：调整文件名格式。
- **变更**：
  - `index.html`：将按钮的`onclick`从`exportPracticeData()`改为`MarkdownExporter.exportToMarkdown()`。
    ```diff
    --- index.html
    +++ index.html
    @@ -91,8 +91,7 @@
                         <button class="btn btn-sm" onclick="filterRecordsByType('listening')">听力</button>
                     </div>
                     <div>
    -                    <button class="btn btn-secondary" onclick="exportPracticeData()" style="margin-right: 10px;">📊
    -                        导出数据</button>
    +                    <button class="btn btn-secondary" onclick="(window.markdownExporter||(window.markdownExporter=new MarkdownExporter())).exportToMarkdown()">📄 导出Markdown</button>
                         <button class="btn btn-info" onclick="toggleBulkDelete()" id="bulk-delete-btn" style="margin-right: 10px;">📝 批量管理</button>
                         <button class="btn btn-warning" onclick="clearPracticeData()">🗑️ 清除记录</button>
    ```
  - `js/utils/markdownExporter.js`：将导出文件名改为`ielts-practice-records-YYYY-MM-DD.md`。
    ```diff
    --- js/utils/markdownExporter.js
    +++ js/utils/markdownExporter.js
    @@ -670,7 +670,7 @@
                 const a = document.createElement('a');
                 a.href = url;
    -            a.download = `practice_records_${new Date().toISOString().split('T')[0]}.md`;
    +            a.download = `ielts-practice-records-${new Date().toISOString().split('T')[0]}.md`;
                 document.body.appendChild(a);
                 a.click();
                 document.body.removeChild(a);
    ```
- **效果**：
  - 练习记录页“导出数据”按钮现导出Markdown格式（表格含“正确答案/我的答案/对错/错误分析”）。
  - 文件名符合要求：`ielts-practice-records-YYYY-MM-DD.md`。
  - 设置页仍保留JSON导出（`exportPracticeData`），功能分离清晰。

##### 3. 修复练习历史详情正确答案缺失（N/A问题）
- **文件**：`js/app.js`, `js/components/practiceRecordModal.js`
- **变更**：
  - `js/app.js` → `saveRealPracticeData`：
    - 确保保存时填充`practiceRecord.realData.scoreInfo.details`和`practiceRecord.answerComparison`。
    - 新增顶层`practiceRecord.scoreInfo.details`以兼容直接读取顶层的代码。
    ```diff
    --- js/app.js
    +++ js/app.js
    @@ -1808,7 +1808,8 @@
                         correct: correct,
                         total: total,
                         accuracy: acc,
    -                    percentage: pct
    +                    percentage: pct,
    +                    details: details
                     };
                     // 将比较结构提升到顶层，便于兼容读取
    ```
  - `js/components/practiceRecordModal.js`：
    - 已有的回退逻辑（按序读取`record.correctAnswers` → `record.realData.correctAnswers` → `record.answerComparison` → `record.realData.scoreInfo.details`）。
    - 新增支持从`record.scoreInfo.details`提取正确答案，作为第5个候选来源。
- **效果**：
  - 新练习记录的`realData.scoreInfo.details`和`answerComparison`均保存正确答案。
  - 详情弹窗可通过多源回退显示正确答案，减少N/A情况。
  - Markdown导出（`js/utils/markdownExporter.js`）也使用相同回退逻辑，确保导出表格包含正确答案。

##### 4. 添加临时JSON导出按钮
- **文件**：`js/main.js`
- **变更**：
  - 在`renderPracticeRecordItem`中，为每条记录添加“🐞 导出JSON（临时）”按钮，点击触发`exportRecordJson(recordId)`。
    ```diff
    --- js/main.js
    +++ js/main.js
    @@ -255,7 +255,10 @@
                 </div>
             </div>
             <div class="record-actions-container">
    -            ${!bulkDeleteMode ? `<button class="delete-record-btn" onclick="event.stopPropagation(); deleteRecord('${record.id}')">🗑️</button>` : ''}
    +            ${!bulkDeleteMode ? `
    +                <button class="delete-record-btn" onclick="event.stopPropagation(); deleteRecord('${record.id}')">🗑️</button>
    +                <button class="export-json-btn" onclick="event.stopPropagation(); exportRecordJson('${record.id}')" title="导出该记录JSON（临时）">🐞</button>
    +            ` : ''}
             </div>
         `;
         return item;
    ```
  - 新增`exportRecordJson`函数，从`storage.practice_records`查找记录并导出为JSON。
    ```diff
    --- js/main.js
    +++ js/main.js
    @@ -952,6 +952,33 @@
         updatePracticeView(); // Re-render to show selection state
     }
     
    +function exportRecordJson(recordId) {
    +    try {
    +        const records = storage.get('practice_records', []);
    +        const record = records.find(r => r.id === recordId || r.sessionId === recordId);
    +        if (!record) {
    +            showMessage('记录不存在', 'error');
    +            return;
    +        }
    +        const json = JSON.stringify(record, null, 2);
    +        const blob = new Blob([json], { type: 'application/json' });
    +        const url = URL.createObjectURL(blob);
    +        const a = document.createElement('a');
    +        a.href = url;
    +        a.download = `practice-record-${recordId}.json`;
    +        document.body.appendChild(a);
    +        a.click();
    +        document.body.removeChild(a);
    +        URL.revokeObjectURL(url);
    +        showMessage('记录JSON导出成功', 'success');
    +    } catch (e) {
    +        console.error('[ExportJSON] 失败:', e);
    +        showMessage('导出失败: ' + e.message, 'error');
    +    }
    +}
    +
     function deleteRecord(recordId) {
         if (!recordId) {
             showMessage('记录ID无效', 'error');
    ```
- **效果**：
  - 每条练习记录右侧新增“🐞”按钮，悬浮提示“导出该记录JSON（临时）”。
  - 点击后下载`practice-record-<记录ID>.json`，包含完整记录数据（`realData`、`scoreInfo`、`answerComparison`等）。
  - 用户可通过此功能导出问题记录样本，协助分析N/A问题根因（例如题号键不一致）。

---

#### 三、待验证与下一步
1. **验证步骤**：
   - **练习记录刷新**：完成一篇练习，确认记录立即出现在“练习记录”页面，无需刷新。
   - **详情显示**：
     - 打开问题记录（含N/A的记录，例：题号i, vi, ix, x）。
     - 检查详情表格是否正确显示“正确答案/我的答案/对错”。
   - **Markdown导出**：
     - 点击“导出Markdown”按钮，确认下载`ielts-practice-records-YYYY-MM-DD.md`。
     - 检查导出文件中是否包含正确答案和对错信息。
   - **JSON导出**：
     - 找到N/A问题记录，点击“🐞”按钮，下载`practice-record-<记录ID>.json`。
     - 检查JSON是否包含`realData`、`scoreInfo`、`answerComparison`等字段。
   - **无浮层**：确认页面无“活动练习/活动练习会话”浮层。
2. **待用户提供**：
   - 用户需上传问题记录的JSON样本（通过“🐞”按钮导出），包含：
     - `realData.answers`、`realData.correctAnswers`、`answerComparison`的键名（例：罗马数字`i, vi, ix`或数字`1, q1`）。
     - `scoreInfo.details`的结构（若存在）。
   - 样本将用于精准修复题号键不一致问题（罗马数字 vs 数字/q前缀）。
3. **下一步计划**：
   - **收到样本后**：
     - 在`js/components/practiceRecordModal.js`和`js/utils/markdownExporter.js`中添加题号键标准化逻辑：
       - 支持罗马数字（`i, ii, iii, iv, vi, ix, x`）到数字（`1, 2, 3…`）的转换。
       - 尝试多种键别名（`i`, `I`, `q1`, `question1`, `1`）进行匹配。
       - 保持显示用原始题号（`i, vi, ix`），但底层对齐到统一键。
     - 更新Markdown导出，确保表格正确显示“正确答案/对错”。

---

#### 四、操作结果
- **已修复**：
  - 消息类型统一，兼容本地`file://`协议，记录即时刷新。
  - 练习记录页导出改为Markdown（`ielts-practice-records-YYYY-MM-DD.md`）。
  - 练习记录保存时填充`scoreInfo.details`和`answerComparison`，详情弹窗支持多源回退。
  - 添加临时JSON导出按钮（`🐞`），便于用户提取问题记录样本。
- **待解决**：
  - 正确答案N/A问题可能由题号键不一致引起，需用户提供JSON样本以确认键格式并实现标准化。
- **用户动作**：
  - 使用“🐞”按钮导出问题记录JSON，发送给以分析N/A根因。
  - 验证修复效果（记录刷新、详情显示、Markdown导出）。

---

**备注**：
- 本日志基于用户提供的上下文和0.2版本参考，未臆测数据结构。
- 所有代码变更均已对齐0.2版本`practiceHistory`的字段读取逻辑（优先`scoreInfo.details`，回退到`answerComparison`等）。
- 后续修复（键标准化）需依赖用户提供的JSON样本，确保精准适配实际题号格式。

**签名**：Grok（xAI），2025-09-15 02:58 AM AEST