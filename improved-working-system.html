<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€ƒè¯•æ€»è§ˆç³»ç»Ÿ - æ”¹è¿›ç‰ˆ</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
        }

        /* æ¶ˆæ¯é€šçŸ¥åŒºåŸŸ - å›ºå®šä½ç½® */
        .message-container {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 350px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            pointer-events: none;
        }

        .message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid;
            font-size: 14px;
            line-height: 1.4;
            pointer-events: auto;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .message.success {
            background: rgba(74, 222, 128, 0.9);
            border-color: #4ade80;
            color: #065f46;
        }

        .message.error {
            background: rgba(255, 107, 107, 0.9);
            border-color: #ff6b6b;
            color: #7f1d1d;
        }

        .message.info {
            background: rgba(59, 130, 246, 0.9);
            border-color: #3b82f6;
            color: #1e3a8a;
        }

        .main-nav {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .nav-btn:hover,
        .nav-btn.active {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .view {
            display: none;
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            min-height: 400px;
        }

        .view.active {
            display: block;
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .category-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .category-card:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .category-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .category-icon {
            font-size: 2em;
            margin-right: 15px;
        }

        .category-title {
            font-size: 1.3em;
            font-weight: bold;
        }

        .category-meta {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 5px;
        }

        .category-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            flex: 1;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #2196F3, #1976D2);
        }

        .btn-info {
            background: linear-gradient(45deg, #17a2b8, #138496);
        }

        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
        }

        .btn-warning {
            background: linear-gradient(45deg, #ffc107, #e0a800);
            color: #212529;
        }

        .btn-info:hover {
            background: linear-gradient(45deg, #138496, #117a8b);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .exam-list {
            display: grid;
            gap: 15px;
            max-height: 600px;
            overflow-y: auto;
        }

        .exam-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .exam-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }

        .exam-info h4 {
            margin-bottom: 5px;
            font-size: 1.1em;
        }

        .exam-meta {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .exam-actions {
            display: flex;
            gap: 10px;
        }

        .loading {
            text-align: center;
            padding: 50px;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid white;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }



        .search-box {
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }



        /* ç»ƒä¹ è®°å½•æ ·å¼ */
        .practice-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #4ade80;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 5px;
        }

        .practice-history {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .delete-record-btn {
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 14px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
            padding: 4px;
            border-radius: 4px;
        }

        .history-item:hover .delete-record-btn {
            opacity: 1;
        }

        .delete-record-btn:hover {
            background: rgba(255, 0, 0, 0.1);
            transform: translateY(-50%) scale(1.1);
        }

        .history-item.deleting {
            opacity: 0.5;
            transform: scale(0.95);
            transition: all 0.3s ease;
        }

        .history-item.deleted {
            opacity: 0;
            transform: scale(0.9) translateX(100px);
            transition: all 0.5s ease;
        }



        @media (max-width: 768px) {
            .message-container {
                position: relative;
                top: auto;
                right: auto;
                width: 100%;
                margin-bottom: 20px;
            }

            .container {
                padding: 10px;
            }

            .header {
                padding: 20px;
                margin-bottom: 20px;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .main-nav {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }

            .nav-btn {
                width: 100%;
                max-width: 300px;
                padding: 12px 20px;
                font-size: 14px;
            }

            .category-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .category-card {
                padding: 20px;
            }

            .category-actions {
                flex-direction: column;
                gap: 8px;
            }

            .exam-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
                padding: 15px;
            }

            .exam-actions {
                width: 100%;
                justify-content: stretch;
                flex-direction: column;
                gap: 8px;
            }

            .exam-actions .btn {
                width: 100%;
                margin: 0;
            }

            .view {
                padding: 20px;
            }

            .search-input {
                font-size: 16px; /* é˜²æ­¢iOSç¼©æ”¾ */
            }

            .practice-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-number {
                font-size: 1.5em;
            }

            /* è®¾ç½®é¡µé¢ç§»åŠ¨ä¼˜åŒ– */
            #settings-view div[style*="display: flex"] {
                flex-direction: column !important;
                gap: 10px !important;
            }

            #settings-view .btn {
                width: 100%;
                margin: 5px 0 !important;
            }

            /* æŠ¥å‘Šæ˜¾ç¤ºä¼˜åŒ– */
            .performance-report,
            .backup-list,
            .validation-report,
            .ux-report {
                margin: 10px 0 !important;
                padding: 15px !important;
            }

            /* è™šæ‹Ÿæ»šåŠ¨å®¹å™¨ä¼˜åŒ– */
            #virtual-scroll-container {
                height: 400px !important;
            }
        }

        /* å°å±å¹•è®¾å¤‡è¿›ä¸€æ­¥ä¼˜åŒ– */
        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }

            .header {
                padding: 15px;
            }

            .header h1 {
                font-size: 1.3em;
            }

            .nav-btn {
                padding: 10px 15px;
                font-size: 13px;
            }

            .category-card,
            .exam-item {
                padding: 12px;
            }

            .btn {
                padding: 8px 12px;
                font-size: 13px;
            }

            .practice-stats {
                grid-template-columns: 1fr;
            }

            .message {
                padding: 10px;
                font-size: 12px;
            }
        }
    </style>
</head>

<body>
    <div class="message-container" id="message-container"></div>

    <div class="container">
        <div class="header">
            <h1>ğŸ“š è€ƒè¯•æ€»è§ˆç³»ç»Ÿ</h1>
            <p>IELTSé˜…è¯»ç»ƒä¹ ç®¡ç†å¹³å° - æ”¹è¿›ç‰ˆ</p>
        </div>

        <nav class="main-nav">
            <button class="nav-btn active" onclick="showView('overview')">ğŸ“Š æ€»è§ˆ</button>
            <button class="nav-btn" onclick="showView('browse')">ğŸ“š é¢˜åº“æµè§ˆ</button>
            <button class="nav-btn" onclick="showView('practice')">ğŸ“ ç»ƒä¹ è®°å½•</button>
            <button class="nav-btn" onclick="showView('settings')">âš™ï¸ è®¾ç½®</button>
        </nav>

        <!-- æ€»è§ˆé¡µé¢ -->
        <div id="overview-view" class="view active">
            <h2>ğŸ“Š å­¦ä¹ æ€»è§ˆ</h2>

            <div class="category-grid" id="category-overview">
                <!-- åˆ†ç±»å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- é¢˜åº“æµè§ˆé¡µé¢ -->
        <div id="browse-view" class="view">

            <h2 id="browse-title">ğŸ“š é¢˜åº“æµè§ˆ</h2>

            <div class="search-box">
                <input type="text" class="search-input" placeholder="æœç´¢é¢˜ç›®..." onkeyup="searchExams(this.value)">
            </div>

            <div id="exam-list-container"></div>
            <div class="loading">
                <div class="spinner"></div>
                <p>æ­£åœ¨åŠ è½½é¢˜ç›®åˆ—è¡¨...</p>
            </div>
        </div>
    </div>

    <!-- ç»ƒä¹ è®°å½•é¡µé¢ -->
    <div id="practice-view" class="view">
        <h2>ğŸ“ ç»ƒä¹ è®°å½•</h2>

        <div class="practice-stats">
            <div class="stat-card">
                <div class="stat-number" id="total-practiced">0</div>
                <div class="stat-label">å·²ç»ƒä¹ é¢˜ç›®</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avg-score">0%</div>
                <div class="stat-label">å¹³å‡æ­£ç¡®ç‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="study-time">0</div>
                <div class="stat-label">å­¦ä¹ æ—¶é•¿(åˆ†é’Ÿ)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="streak-days">0</div>
                <div class="stat-label">è¿ç»­å­¦ä¹ å¤©æ•°</div>
            </div>
        </div>

        <div class="practice-history">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>ğŸ“ˆ ç»ƒä¹ å†å²</h3>
                <div>
                    <button class="btn btn-secondary" onclick="exportPracticeData()" style="margin-right: 10px;">ğŸ“Š
                        å¯¼å‡ºæ•°æ®</button>
                    <button class="btn" onclick="cleanupPracticeData()" style="margin-right: 10px;">ğŸ§¹ æ¸…ç†é‡å¤</button>
                    <button class="btn btn-info" onclick="toggleBulkDelete()" id="bulk-delete-btn"
                        style="margin-right: 10px;">ğŸ“
                        æ‰¹é‡ç®¡ç†</button>
                    <button class="btn btn-warning" onclick="clearPracticeData()">ğŸ—‘ï¸ æ¸…é™¤è®°å½•</button>
                </div>
            </div>

            <div id="practice-history-list">
                <div style="text-align: center; padding: 40px; opacity: 0.7;">
                    <div style="font-size: 3em; margin-bottom: 15px;">ğŸ“‹</div>
                    <p>æš‚æ— ç»ƒä¹ è®°å½•</p>
                    <p style="font-size: 0.9em; margin-top: 10px;">å¼€å§‹ç»ƒä¹ åï¼Œè®°å½•å°†è‡ªåŠ¨ä¿å­˜åœ¨è¿™é‡Œ</p>
                </div>
            </div>
        </div>
    </div>

    <!-- è®¾ç½®é¡µé¢ -->
    <div id="settings-view" class="view">
        <h2>âš™ï¸ ç³»ç»Ÿè®¾ç½®</h2>
        <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px;">
            <h3>ğŸ”§ ç³»ç»Ÿç®¡ç†</h3>
            <p style="margin: 15px 0; opacity: 0.9;">ç³»ç»Ÿå·¥å…·å’Œè®¾ç½®é€‰é¡¹</p>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-warning" onclick="clearCache()">ğŸ—‘ï¸ æ¸…é™¤ç¼“å­˜</button>
                <button class="btn" onclick="reloadLibrary()">ğŸ”„ é‡æ–°åŠ è½½é¢˜åº“</button>

                <button class="btn btn-secondary" onclick="showPerformanceReport()">ğŸ“Š æ€§èƒ½æŠ¥å‘Š</button>

                <button class="btn btn-success" onclick="runCompleteSystemValidation()">âœ… å®Œæ•´åŠŸèƒ½éªŒè¯</button>
            </div>

            <div style="margin-top: 30px;">
                <h3>ğŸ’¾ æ•°æ®ç®¡ç†</h3>
                <p style="margin: 15px 0; opacity: 0.9;">æ•°æ®å¤‡ä»½ã€å¯¼å…¥å¯¼å‡ºå’Œå®Œæ•´æ€§æ£€æŸ¥</p>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn" onclick="createManualBackup()">ğŸ’¾ åˆ›å»ºå¤‡ä»½</button>
                    <button class="btn btn-secondary" onclick="showBackupList()">ğŸ“‹ å¤‡ä»½åˆ—è¡¨</button>
                    <button class="btn btn-info" onclick="exportAllData()">ğŸ“¤ å¯¼å‡ºæ•°æ®</button>
                    <button class="btn btn-warning" onclick="importData()">ğŸ“¥ å¯¼å…¥æ•°æ®</button>
                    <button class="btn btn-success" onclick="validateAllData()">ğŸ” æ•°æ®å®Œæ•´æ€§æ£€æŸ¥</button>
                </div>
            </div>

            <div style="margin-top: 30px;">
                <h3>ğŸ“Š ç³»ç»Ÿä¿¡æ¯</h3>
                <div style="margin-top: 15px; line-height: 1.8;">
                    <div>é¢˜åº“çŠ¶æ€: <span style="color: #4ade80;">å·²åŠ è½½å®Œæ•´ç´¢å¼•</span></div>
                    <div>é¢˜ç›®æ€»æ•°: <span id="total-exams">73</span> ä¸ª</div>
                    <div>HTMLé¢˜ç›®: <span id="html-exams">57</span> ä¸ª</div>
                    <div>PDFé¢˜ç›®: <span id="pdf-exams">16</span> ä¸ª</div>
                    <div>æœ€åæ›´æ–°: <span id="last-update">é¡µé¢åŠ è½½æ—¶</span></div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- åŠ è½½å®Œæ•´é¢˜åº“æ•°æ® -->
    <script src="complete-exam-data.js"></script>

    <!-- åŠ è½½å·¥å…·å‡½æ•° -->
    <script src="js/utils/helpers.js"></script>

    <!-- åŠ è½½æ ¸å¿ƒç»„ä»¶ -->
    <script src="js/core/practiceRecorder.js"></script>
    <script src="js/practice-page-enhancer.js"></script>
    <script src="js/components/PDFHandler.js"></script>
    <script src="js/components/examBrowser.js"></script>
    <script src="js/components/ExamScanner.js"></script>
    <script src="js/components/IndexValidator.js"></script>
    <script src="js/components/CommunicationTester.js"></script>
    <script src="js/components/ErrorFixer.js"></script>
    <script src="js/components/CommunicationRecovery.js"></script>
    <script src="js/components/PerformanceOptimizer.js"></script>
    <script src="js/components/DataIntegrityManager.js"></script>
    <script src="js/components/BrowseStateManager.js"></script>
    <script src="system-validation.js"></script>
    <script src="test-system-fixes.js"></script>
    <script src="test-console-fixes.js"></script>
    <script src="cleanup-floating-buttons.js"></script>

    <script>
        // å¢å¼ºçš„å…¨å±€é”™è¯¯å¤„ç†å™¨
        window.handleError = function (error, context, options = {}) {
            const errorId = `error_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

            // é”™è¯¯è¯¦ç»†ä¿¡æ¯
            const errorDetails = {
                id: errorId,
                timestamp: new Date().toISOString(),
                context: context,
                message: error.message || 'å‘ç”ŸæœªçŸ¥é”™è¯¯',
                stack: error.stack,
                url: window.location.href,
                userAgent: navigator.userAgent,
                recoverable: options.recoverable !== false
            };

            // è®°å½•é”™è¯¯åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆç”¨äºè°ƒè¯•å’Œåˆ†æï¼‰
            try {
                const errorLog = JSON.parse(localStorage.getItem('system_error_log') || '[]');
                errorLog.push(errorDetails);
                // åªä¿ç•™æœ€è¿‘50ä¸ªé”™è¯¯
                if (errorLog.length > 50) {
                    errorLog.splice(0, errorLog.length - 50);
                }
                localStorage.setItem('system_error_log', JSON.stringify(errorLog));
            } catch (logError) {
                console.warn('æ— æ³•è®°å½•é”™è¯¯æ—¥å¿—:', logError);
            }

            // å¼€å‘æ¨¡å¼ä¸‹è¾“å‡ºè¯¦ç»†é”™è¯¯
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                console.error(`[${errorId}] Error in ${context}:`, error);
                console.error('Error details:', errorDetails);
            }

            // æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯
            let userMessage = '';
            if (options.userMessage) {
                userMessage = options.userMessage;
            } else {
                userMessage = window.getErrorUserMessage(error, context);
            }

            window.showMessage(userMessage, 'error');

            // å°è¯•è‡ªåŠ¨æ¢å¤
            if (errorDetails.recoverable && options.autoRecover !== false) {
                setTimeout(() => {
                    window.attemptErrorRecovery(error, context, errorDetails);
                }, 1000);
            }

            return errorDetails;
        };

        // è·å–ç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯
        window.getErrorUserMessage = function (error, context) {
            const errorType = error.name || 'Error';
            const errorMessage = error.message || 'æœªçŸ¥é”™è¯¯';

            // æ ¹æ®é”™è¯¯ç±»å‹å’Œä¸Šä¸‹æ–‡æä¾›å‹å¥½æ¶ˆæ¯
            const messageMap = {
                'NetworkError': 'ç½‘ç»œè¿æ¥å‡ºç°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®',
                'TypeError': 'æ•°æ®æ ¼å¼é”™è¯¯ï¼Œæ­£åœ¨å°è¯•ä¿®å¤',
                'ReferenceError': 'ç³»ç»Ÿç»„ä»¶åŠ è½½å¤±è´¥ï¼Œæ­£åœ¨é‡æ–°åŠ è½½',
                'SyntaxError': 'æ•°æ®è§£æé”™è¯¯ï¼Œæ­£åœ¨å°è¯•ä¿®å¤',
                'QuotaExceededError': 'å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œè¯·æ¸…ç†æµè§ˆå™¨æ•°æ®',
                'SecurityError': 'å®‰å…¨é™åˆ¶ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®'
            };

            const contextMap = {
                'é¢˜åº“åŠ è½½': 'é¢˜åº“æ•°æ®åŠ è½½å¤±è´¥ï¼Œæ­£åœ¨å°è¯•é‡æ–°åŠ è½½',
                'æ•°æ®å­˜å‚¨': 'æ•°æ®ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥å­˜å‚¨ç©ºé—´',
                'æ•°æ®è¯»å–': 'æ•°æ®è¯»å–å¤±è´¥ï¼Œæ­£åœ¨å°è¯•ä¿®å¤',
                'è·¨çª—å£é€šä¿¡': 'é¡µé¢é€šä¿¡å¤±è´¥ï¼Œæ­£åœ¨é‡æ–°å»ºç«‹è¿æ¥',
                'æ–‡ä»¶åŠ è½½': 'æ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œæ­£åœ¨å°è¯•å¤‡ç”¨æ–¹æ¡ˆ'
            };

            return contextMap[context] || messageMap[errorType] || `${context}å‡ºç°é—®é¢˜: ${errorMessage}`;
        };

        // é”™è¯¯æ¢å¤æœºåˆ¶
        window.attemptErrorRecovery = function (error, context, errorDetails) {
            console.log(`[Recovery] å°è¯•æ¢å¤é”™è¯¯: ${context}`);

            const recoveryStrategies = {
                'é¢˜åº“åŠ è½½': () => {
                    console.log('[Recovery] é‡æ–°åŠ è½½é¢˜åº“æ•°æ®');
                    setTimeout(() => {
                        if (typeof loadExamData === 'function') {
                            loadExamData();
                        }
                    }, 2000);
                },
                'æ•°æ®å­˜å‚¨': () => {
                    console.log('[Recovery] æ¸…ç†å­˜å‚¨ç©ºé—´å¹¶é‡è¯•');
                    try {
                        // æ¸…ç†æ—§æ•°æ®
                        const keys = Object.keys(localStorage);
                        const oldKeys = keys.filter(key => {
                            try {
                                const data = JSON.parse(localStorage.getItem(key));
                                return data.timestamp && (Date.now() - data.timestamp > 7 * 24 * 60 * 60 * 1000);
                            } catch {
                                return false;
                            }
                        });
                        oldKeys.forEach(key => localStorage.removeItem(key));
                        window.showMessage('å·²æ¸…ç†å­˜å‚¨ç©ºé—´ï¼Œè¯·é‡è¯•æ“ä½œ', 'info');
                    } catch (recoveryError) {
                        console.error('[Recovery] å­˜å‚¨æ¢å¤å¤±è´¥:', recoveryError);
                    }
                },
                'è·¨çª—å£é€šä¿¡': () => {
                    console.log('[Recovery] é‡æ–°å»ºç«‹è·¨çª—å£é€šä¿¡');
                    // é‡æ–°åˆå§‹åŒ–é€šä¿¡
                    if (window.communicationManager && typeof window.communicationManager.reinitialize === 'function') {
                        window.communicationManager.reinitialize();
                    }
                },
                'æ–‡ä»¶åŠ è½½': () => {
                    console.log('[Recovery] å°è¯•å¤‡ç”¨æ–‡ä»¶åŠ è½½æ–¹æ¡ˆ');
                    // å¯ä»¥åœ¨è¿™é‡Œå®ç°å¤‡ç”¨åŠ è½½é€»è¾‘
                }
            };

            const strategy = recoveryStrategies[context];
            if (strategy) {
                try {
                    strategy();
                } catch (recoveryError) {
                    console.error(`[Recovery] æ¢å¤ç­–ç•¥æ‰§è¡Œå¤±è´¥:`, recoveryError);
                }
            }
        };

        // å¢å¼ºçš„å…¨å±€JavaScripté”™è¯¯æ•è·
        window.addEventListener('error', function (event) {
            const error = event.error || new Error(event.message);
            const context = event.filename ? `è„šæœ¬åŠ è½½ (${event.filename}:${event.lineno})` : 'ç³»ç»Ÿè¿è¡Œ';

            // æ£€æŸ¥æ˜¯å¦æ˜¯èµ„æºåŠ è½½é”™è¯¯
            if (event.target && event.target !== window) {
                const resourceType = event.target.tagName.toLowerCase();
                const resourceSrc = event.target.src || event.target.href;
                window.handleResourceLoadError(resourceType, resourceSrc, event);
                return true;
            }

            window.handleError(error, context, {
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno
            });
            return true; // é˜»æ­¢é»˜è®¤é”™è¯¯å¤„ç†
        });

        // å¢å¼ºçš„Promiseé”™è¯¯æ•è·
        window.addEventListener('unhandledrejection', function (event) {
            const error = event.reason instanceof Error ? event.reason : new Error(String(event.reason));

            // æ£€æŸ¥æ˜¯å¦æ˜¯ç½‘ç»œè¯·æ±‚é”™è¯¯
            if (event.reason && typeof event.reason === 'object' && event.reason.name === 'TypeError' &&
                event.reason.message.includes('fetch')) {
                window.handleError(error, 'ç½‘ç»œè¯·æ±‚', {
                    recoverable: true,
                    userMessage: 'ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œæ­£åœ¨é‡è¯•...'
                });
            } else {
                window.handleError(error, 'Promiseå¤„ç†', { recoverable: true });
            }

            event.preventDefault(); // é˜»æ­¢é»˜è®¤é”™è¯¯å¤„ç†
        });

        // èµ„æºåŠ è½½é”™è¯¯å¤„ç†
        window.handleResourceLoadError = function(resourceType, resourceSrc, event) {
            console.warn(`[ResourceError] ${resourceType} åŠ è½½å¤±è´¥:`, resourceSrc);
            
            const errorDetails = {
                type: 'resource_load_error',
                resourceType: resourceType,
                resourceSrc: resourceSrc,
                timestamp: Date.now()
            };

            // å°è¯•å¤‡ç”¨åŠ è½½æ–¹æ¡ˆ
            if (resourceType === 'script') {
                window.handleScriptLoadError(resourceSrc, event);
            } else if (resourceType === 'link') {
                window.handleStyleLoadError(resourceSrc, event);
            } else {
                window.showMessage(`èµ„æºåŠ è½½å¤±è´¥: ${resourceSrc}`, 'warning');
            }
        };

        // è„šæœ¬åŠ è½½é”™è¯¯å¤„ç†
        window.handleScriptLoadError = function(scriptSrc, event) {
            console.warn(`[ScriptError] è„šæœ¬åŠ è½½å¤±è´¥: ${scriptSrc}`);
            
            // è®°å½•å¤±è´¥çš„è„šæœ¬
            if (!window.failedScripts) {
                window.failedScripts = new Set();
            }
            window.failedScripts.add(scriptSrc);

            // å°è¯•ä»å¤‡ç”¨è·¯å¾„åŠ è½½
            const backupPaths = [
                scriptSrc.replace('/js/', '/backup/js/'),
                scriptSrc.replace('.js', '.min.js'),
                scriptSrc.replace('.min.js', '.js')
            ];

            let retryCount = 0;
            const maxRetries = backupPaths.length;

            const tryLoadScript = () => {
                if (retryCount >= maxRetries) {
                    window.showMessage(`è„šæœ¬åŠ è½½å¤±è´¥ï¼Œç³»ç»Ÿå¯èƒ½ä¸ç¨³å®š: ${scriptSrc}`, 'error');
                    return;
                }

                const backupSrc = backupPaths[retryCount];
                retryCount++;

                const script = document.createElement('script');
                script.src = backupSrc;
                script.onload = () => {
                    console.log(`[ScriptError] å¤‡ç”¨è„šæœ¬åŠ è½½æˆåŠŸ: ${backupSrc}`);
                    window.showMessage('ç³»ç»Ÿç»„ä»¶å·²æ¢å¤', 'success');
                };
                script.onerror = () => {
                    console.warn(`[ScriptError] å¤‡ç”¨è„šæœ¬ä¹Ÿå¤±è´¥: ${backupSrc}`);
                    setTimeout(tryLoadScript, 1000);
                };
                document.head.appendChild(script);
            };

            // å»¶è¿Ÿé‡è¯•ï¼Œé¿å…ç«‹å³é‡è¯•
            setTimeout(tryLoadScript, 500);
        };

        // æ ·å¼åŠ è½½é”™è¯¯å¤„ç†
        window.handleStyleLoadError = function(styleSrc, event) {
            console.warn(`[StyleError] æ ·å¼åŠ è½½å¤±è´¥: ${styleSrc}`);
            window.showMessage('æ ·å¼æ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œç•Œé¢å¯èƒ½æ˜¾ç¤ºå¼‚å¸¸', 'warning');
        };

        // å…¨å±€å¯¹è±¡åˆå§‹åŒ–
        window.storage = {
                        get: (key, defaultValue) => {
                            try {
                                const value = localStorage.getItem(key);
                                return value ? JSON.parse(value) : defaultValue;
                            } catch (error) {
                                window.handleError(error, 'æ•°æ®è¯»å–');
                                return defaultValue;
                            }
                        },
                        set: (key, value) => {
                            try {
                                // æ£€æŸ¥å­˜å‚¨ç©ºé—´
                                const testKey = '_storage_test_';
                                localStorage.setItem(testKey, 'test');
                                localStorage.removeItem(testKey);

                                // å­˜å‚¨æ•°æ®
                                localStorage.setItem(key, JSON.stringify(value));
                                return true;
                            } catch (error) {
                                if (error.name === 'QuotaExceededError') {
                                    showMessage('å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œè¯·æ¸…ç†æµè§ˆå™¨æ•°æ®', 'warning');
                                    // å°è¯•æ¸…ç†æ—§æ•°æ®
                                    window.storage.cleanup();
                                    // é‡è¯•ä¸€æ¬¡
                                    try {
                                        localStorage.setItem(key, JSON.stringify(value));
                                        return true;
                                    } catch (retryError) {
                                        window.handleError(retryError, 'æ•°æ®å­˜å‚¨é‡è¯•');
                                        return false;
                                    }
                                } else {
                                    window.handleError(error, 'æ•°æ®å­˜å‚¨');
                                    return false;
                                }
                            }
                        },
                        cleanup: () => {
                            try {
                                // æ¸…ç†è¶…è¿‡30å¤©çš„ç»ƒä¹ è®°å½•
                                const records = JSON.parse(localStorage.getItem('practice_records') || '[]');
                                const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
                                const cleanedRecords = records.filter(record =>
                                    record.startTime && new Date(record.startTime).getTime() > thirtyDaysAgo
                                );

                                if (cleanedRecords.length < records.length) {
                                    localStorage.setItem('practice_records', JSON.stringify(cleanedRecords));
                                    showMessage(`å·²æ¸…ç† ${records.length - cleanedRecords.length} æ¡æ—§è®°å½•`, 'info');
                                }
                            } catch (error) {
                                window.handleError(error, 'æ•°æ®æ¸…ç†');
                            }
                        }
                    };

                // é”™è¯¯å¤„ç†å™¨
                window.errorHandler = {
                    handle: (error, context) => {
                        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                            console.error(`[${context}]`, error);
                        }
                        showMessage(`é”™è¯¯: ${error.message}`, 'error');
                    }
                };

                // å·¥å…·å‡½æ•°
                window.Utils = {
                    sleep: (ms) => new Promise(resolve => setTimeout(resolve, ms)),
                    throttle: (func, delay) => {
                        let timeoutId;
                        let lastExecTime = 0;
                        return function (...args) {
                            const currentTime = Date.now();
                            if (currentTime - lastExecTime > delay) {
                                func.apply(this, args);
                                lastExecTime = currentTime;
                            } else {
                                clearTimeout(timeoutId);
                                timeoutId = setTimeout(() => {
                                    func.apply(this, args);
                                    lastExecTime = Date.now();
                                }, delay - (currentTime - lastExecTime));
                            }
                        };
                    }
                };

                // é¢˜åº“æ•°æ®å’ŒçŠ¶æ€
                let examIndex = [];
                let currentCategory = 'all';
                let filteredExams = [];
                let app = null; // ä¸»åº”ç”¨å®ä¾‹
                let pdfHandler = null; // PDFå¤„ç†å™¨å®ä¾‹
                let browseStateManager = null; // æµè§ˆçŠ¶æ€ç®¡ç†å™¨å®ä¾‹

                // ç»ƒä¹ è®°å½•æ•°æ®ï¼ˆä½¿ç”¨ç»Ÿä¸€çš„é”®åï¼‰
                let practiceRecords = JSON.parse(localStorage.getItem('practice_records') || '[]');
                let practiceStats = {
                    totalPracticed: 0,
                    totalScore: 0,
                    totalTime: 0,
                    streakDays: 0,
                    lastPracticeDate: null
                };

                // PDFå¤„ç†è¾…åŠ©å‡½æ•°
                function openPDFSafely(pdfPath, examTitle) {
                    if (!pdfHandler) {
                        // é™çº§å¤„ç†ï¼šç›´æ¥åœ¨æ–°çª—å£æ‰“å¼€PDF
                        const pdfWindow = window.open(pdfPath, `pdf_${Date.now()}`,
                            'width=1000,height=800,scrollbars=yes,resizable=yes,status=yes,toolbar=yes');
                        if (pdfWindow) {
                            showMessage(`æ­£åœ¨æ‰“å¼€PDF: ${examTitle}`, 'success');
                        } else {
                            showMessage('æ— æ³•æ‰“å¼€PDFæ–‡ä»¶ï¼Œè¯·å…è®¸å¼¹çª—æˆ–æ£€æŸ¥æµè§ˆå™¨è®¾ç½®', 'error');
                        }
                        return pdfWindow;
                    }

                    // ä½¿ç”¨PDFå¤„ç†å™¨æ‰“å¼€
                    return pdfHandler.openPDF(pdfPath, examTitle);
                }

                // æ¶ˆæ¯ç³»ç»Ÿ - æ”¹è¿›ç‰ˆ
                function showMessage(message, type = 'info', duration = 4000) {
                    const messageContainer = document.getElementById('message-container');
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${type}`;

                    const icon = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
                    messageDiv.innerHTML = `<strong>${icon}</strong> ${message}`;

                    messageContainer.appendChild(messageDiv);

                    // è‡ªåŠ¨ç§»é™¤æ¶ˆæ¯
                    setTimeout(() => {
                        if (messageDiv.parentNode) {
                            messageDiv.style.animation = 'slideOut 0.3s ease-in forwards';
                            setTimeout(() => {
                                if (messageDiv.parentNode) {
                                    messageDiv.parentNode.removeChild(messageDiv);
                                }
                            }, 300);
                        }
                    }, duration);

                    // é™åˆ¶æ¶ˆæ¯æ•°é‡
                    const messages = messageContainer.children;
                    if (messages.length > 3) {
                        messageContainer.removeChild(messages[0]);
                    }
                }

                // è§†å›¾åˆ‡æ¢
                function showView(viewName, resetCategory = true) {
                    document.querySelectorAll('.view').forEach(view => {
                        view.classList.remove('active');
                    });

                    document.getElementById(viewName + '-view').classList.add('active');

                    document.querySelectorAll('.nav-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });

                    const activeBtn = Array.from(document.querySelectorAll('.nav-btn')).find(btn =>
                        btn.textContent.includes(getViewName(viewName))
                    );
                    if (activeBtn) {
                        activeBtn.classList.add('active');
                    }

                    if (viewName === 'browse') {
                        // åªæœ‰åœ¨resetCategoryä¸ºtrueæ—¶æ‰é‡ç½®åˆ†ç±»
                        if (resetCategory) {
                            currentCategory = 'all';
                            document.getElementById('browse-title').textContent = 'ğŸ“š é¢˜åº“æµè§ˆ';
                        }
                        loadExamList();
                    } else if (viewName === 'practice') {
                        updatePracticeView();
                    }
                }

                function getViewName(viewName) {
                    const names = {
                        'overview': 'æ€»è§ˆ',
                        'browse': 'é¢˜åº“æµè§ˆ',
                        'practice': 'ç»ƒä¹ è®°å½•',
                        'settings': 'è®¾ç½®'
                    };
                    return names[viewName] || viewName;
                }

                // ä¼˜åŒ–çš„é¢˜åº“åŠ è½½å‡½æ•°
                function loadLibrary() {
                    const startTime = performance.now();
                    
                    // æ£€æŸ¥ç¼“å­˜
                    if (window.performanceOptimizer) {
                        const cachedData = window.performanceOptimizer.getCache('exam_index');
                        if (cachedData) {
                            console.log('[System] ä½¿ç”¨ç¼“å­˜çš„é¢˜åº“æ•°æ®');
                            examIndex = cachedData;
                            updateOverview();
                            updateSystemInfo();
                            showMessage('é¢˜åº“å·²ä»ç¼“å­˜åŠ è½½', 'success');
                            return;
                        }
                    }

                    showMessage('æ­£åœ¨åŠ è½½é¢˜åº“ç´¢å¼•...', 'info');

                    try {
                        // æ£€æŸ¥é¢˜åº“æ•°æ®æ˜¯å¦å¯ç”¨
                        if (!window.completeExamIndex || !Array.isArray(window.completeExamIndex)) {
                            throw new Error('é¢˜åº“æ•°æ®æœªæ­£ç¡®åŠ è½½');
                        }

                        // ä½¿ç”¨å®Œæ•´çš„é¢˜åº“ç´¢å¼•
                        examIndex = [...window.completeExamIndex];

                        // éªŒè¯æ•°æ®å®Œæ•´æ€§
                        if (examIndex.length === 0) {
                            throw new Error('é¢˜åº“æ•°æ®ä¸ºç©º');
                        }

                        // ç¼“å­˜é¢˜åº“æ•°æ®
                        if (window.performanceOptimizer) {
                            window.performanceOptimizer.setCache('exam_index', examIndex, {
                                ttl: 1800000 // 30åˆ†é’Ÿç¼“å­˜
                            });
                        }

                        // æ‰¹é‡å¤„ç†é¢˜åº“æ•°æ®ä»¥é¿å…é˜»å¡UI
                        if (window.performanceOptimizer && examIndex.length > 100) {
                            window.performanceOptimizer.batchProcess(
                                examIndex,
                                (exam, index) => {
                                    // é¢„å¤„ç†é¢˜ç›®æ•°æ®
                                    if (!exam.searchText) {
                                        exam.searchText = `${exam.title} ${exam.category}`.toLowerCase();
                                    }
                                    return exam;
                                },
                                50, // æ¯æ‰¹50ä¸ª
                                10  // 10mså»¶è¿Ÿ
                            ).then(() => {
                                finishLibraryLoading(startTime);
                            });
                        } else {
                            // ç›´æ¥å¤„ç†å°æ•°æ®é›†
                            examIndex.forEach(exam => {
                                if (!exam.searchText) {
                                    exam.searchText = `${exam.title} ${exam.category}`.toLowerCase();
                                }
                            });
                            finishLibraryLoading(startTime);
                        }

                    } catch (error) {
                        window.handleError(error, 'é¢˜åº“åŠ è½½');

                        // æä¾›é™çº§æ–¹æ¡ˆ
                        setTimeout(() => {
                            showMessage('æ­£åœ¨å°è¯•å¤‡ç”¨åŠ è½½æ–¹å¼...', 'info');
                            loadLibraryFallback();
                        }, 2000);
                    }
                }

                // å®Œæˆé¢˜åº“åŠ è½½
                function finishLibraryLoading(startTime) {
                    const loadTime = performance.now() - startTime;
                    
                    if (window.performanceOptimizer) {
                        window.performanceOptimizer.recordLoadTime(loadTime);
                    }

                    const htmlCount = examIndex.filter(exam => exam.hasHtml).length;
                    const pdfCount = examIndex.filter(exam => !exam.hasHtml).length;
                    
                    // å…³é”®ä¿®å¤ï¼šå°†æ•°æ®ä¿å­˜åˆ°localStorageï¼Œä»¥ä¾¿ExamBrowserç»„ä»¶å¯ä»¥è¯»å–
                    try {
                        localStorage.setItem('exam_index', JSON.stringify(examIndex));
                        console.log('[System] é¢˜åº“æ•°æ®å·²ä¿å­˜åˆ°localStorageï¼Œæ•°é‡:', examIndex.length);
                        
                        // åŒæ—¶æ›´æ–°storageå¯¹è±¡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                        if (window.storage && typeof window.storage.set === 'function') {
                            window.storage.set('exam_index', examIndex);
                            console.log('[System] é¢˜åº“æ•°æ®å·²ä¿å­˜åˆ°storageå¯¹è±¡');
                        }
                    } catch (error) {
                        console.error('[System] ä¿å­˜é¢˜åº“æ•°æ®å¤±è´¥:', error);
                        window.handleError(error, 'æ•°æ®ä¿å­˜');
                    }
                    
                    showMessage(
                        `é¢˜åº“åŠ è½½å®Œæˆï¼å…± ${examIndex.length} ä¸ªé¢˜ç›® (${htmlCount} ä¸ªHTML, ${pdfCount} ä¸ªPDF) - ${Math.round(loadTime)}ms`, 
                        'success'
                    );
                    
                    updateOverview();
                    updateSystemInfo();
                    
                    // é€šçŸ¥ExamBrowserç»„ä»¶æ•°æ®å·²æ›´æ–°
                    if (window.app && window.app.components && window.app.components.examBrowser) {
                        console.log('[System] é€šçŸ¥ExamBrowserç»„ä»¶åˆ·æ–°æ•°æ®');
                        setTimeout(() => {
                            window.app.components.examBrowser.refreshExamList();
                        }, 100);
                    }
                }

                // é¢˜åº“åŠ è½½é™çº§æ–¹æ¡ˆ
                function loadLibraryFallback() {
                    try {
                        // åˆ›å»ºåŸºæœ¬çš„é¢˜åº“ç»“æ„
                        examIndex = [
                            {
                                id: 'fallback-notice',
                                title: 'é¢˜åº“åŠ è½½å¼‚å¸¸ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•',
                                category: 'P1',
                                frequency: 'high',
                                path: '',
                                filename: '',
                                hasHtml: false,
                                hasPdf: false
                            }
                        ];

                        showMessage('å·²å¯ç”¨å¤‡ç”¨æ¨¡å¼ï¼ŒåŠŸèƒ½å¯èƒ½å—é™', 'warning');
                        updateOverview();

                    } catch (error) {
                        window.handleError(error, 'å¤‡ç”¨åŠ è½½');
                        showMessage('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢', 'error');
                    }
                }

                // é‡æ–°åŠ è½½é¢˜åº“
                function reloadLibrary() {
                    showMessage('æ­£åœ¨é‡æ–°åŠ è½½é¢˜åº“...', 'info');
                    examIndex = [];
                    setTimeout(() => {
                        loadLibrary();
                    }, 500);
                }

                // åŠ è½½é¢˜åº“æ•°æ®ï¼ˆå…¼å®¹æ€§å‡½æ•°ï¼‰
                function loadExamData() {
                    loadLibrary();
                }

                // æ›´æ–°ç³»ç»Ÿç»Ÿè®¡ä¿¡æ¯
                function updateSystemInfo() {
                    if (!examIndex || examIndex.length === 0) {
                        return;
                    }

                    const totalExams = examIndex.length;
                    const htmlExams = examIndex.filter(exam => exam.hasHtml).length;
                    const pdfExams = examIndex.filter(exam => exam.hasPdf).length;

                    // æ›´æ–°æ˜¾ç¤º
                    const totalExamsEl = document.getElementById('total-exams');
                    const htmlExamsEl = document.getElementById('html-exams');
                    const pdfExamsEl = document.getElementById('pdf-exams');
                    const lastUpdateEl = document.getElementById('last-update');

                    if (totalExamsEl) totalExamsEl.textContent = totalExams;
                    if (htmlExamsEl) htmlExamsEl.textContent = htmlExams;
                    if (pdfExamsEl) pdfExamsEl.textContent = pdfExams;
                    if (lastUpdateEl) lastUpdateEl.textContent = new Date().toLocaleString();
                }





                // éšæœºç»ƒä¹  - ä¿®å¤åŠŸèƒ½
                function startRandomPractice(category) {
                    const categoryExams = examIndex.filter(exam => exam.category === category);

                    if (categoryExams.length === 0) {
                        showMessage(`${category} åˆ†ç±»æš‚æ— å¯ç”¨é¢˜ç›®ï¼Œè¯·å…ˆåŠ è½½é¢˜åº“`, 'error');
                        return;
                    }

                    const randomExam = categoryExams[Math.floor(Math.random() * categoryExams.length)];
                    showMessage(`éšæœºé€‰æ‹©: ${randomExam.title}`, 'info');

                    // å»¶è¿Ÿä¸€ä¸‹å†æ‰“å¼€ï¼Œè®©ç”¨æˆ·çœ‹åˆ°é€‰æ‹©çš„é¢˜ç›®
                    setTimeout(() => {
                        openExam(randomExam.id);
                    }, 1000);
                }

                // ç­›é€‰é¢˜ç›®
                function filterExams(filterType) {
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    document.querySelectorAll('.filter-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    event.target.classList.add('active');

                    let filtered = [];

                    switch (filterType) {
                        case 'all':
                            filtered = examIndex;
                            currentCategory = 'all';
                            break;
                        case 'P1':
                        case 'P2':
                        case 'P3':
                            filtered = examIndex.filter(exam => exam.category === filterType);
                            currentCategory = filterType;
                            break;
                        case 'high':
                            filtered = examIndex.filter(exam => exam.frequency === 'high');
                            currentCategory = 'all';
                            break;
                        case 'low':
                            filtered = examIndex.filter(exam => exam.frequency === 'low');
                            currentCategory = 'all';
                            break;
                        default:
                            filtered = examIndex;
                    }

                    filteredExams = filtered;
                    displayExams(filteredExams);

                    // æ¸…ç©ºæœç´¢æ¡†
                    const searchInput = document.querySelector('.search-input');
                    if (searchInput) {
                        searchInput.value = '';
                    }
                }

                // ä¼˜åŒ–çš„æœç´¢é¢˜ç›®å‡½æ•°
                function searchExams(query) {
                    // ä½¿ç”¨é˜²æŠ–ä¼˜åŒ–æœç´¢æ€§èƒ½
                    if (window.performanceOptimizer) {
                        const debouncedSearch = window.performanceOptimizer.debounce(
                            performSearch, 
                            300, 
                            'exam_search'
                        );
                        debouncedSearch(query);
                    } else {
                        performSearch(query);
                    }
                }

                // æ‰§è¡Œæœç´¢çš„æ ¸å¿ƒå‡½æ•°
                function performSearch(query) {
                    const startTime = performance.now();
                    
                    if (!query.trim()) {
                        displayExams(filteredExams);
                        return;
                    }

                    const normalizedQuery = query.toLowerCase().trim();
                    
                    // æ£€æŸ¥æœç´¢ç¼“å­˜
                    const cacheKey = `search_${normalizedQuery}_${currentCategory}`;
                    if (window.performanceOptimizer) {
                        const cachedResults = window.performanceOptimizer.getCache(cacheKey);
                        if (cachedResults) {
                            console.log('[Search] ä½¿ç”¨ç¼“å­˜çš„æœç´¢ç»“æœ');
                            displayExams(cachedResults);
                            return;
                        }
                    }

                    // æ‰§è¡Œæœç´¢
                    const searchResults = filteredExams.filter(exam => {
                        // ä½¿ç”¨é¢„å¤„ç†çš„æœç´¢æ–‡æœ¬æé«˜æ€§èƒ½
                        if (exam.searchText) {
                            return exam.searchText.includes(normalizedQuery);
                        }
                        
                        // é™çº§åˆ°åŸå§‹æœç´¢æ–¹å¼
                        return exam.title.toLowerCase().includes(normalizedQuery) ||
                               exam.category.toLowerCase().includes(normalizedQuery);
                    });

                    // ç¼“å­˜æœç´¢ç»“æœ
                    if (window.performanceOptimizer && searchResults.length > 0) {
                        window.performanceOptimizer.setCache(cacheKey, searchResults, {
                            ttl: 300000 // 5åˆ†é’Ÿç¼“å­˜
                        });
                    }

                    const searchTime = performance.now() - startTime;
                    console.log(`[Search] æœç´¢å®Œæˆ: ${searchResults.length} ä¸ªç»“æœ (${Math.round(searchTime)}ms)`);
                    
                    displayExams(searchResults);
                }

                // æµè§ˆåˆ†ç±»
                function browseCategory(category) {
                    currentCategory = category;
                    document.getElementById('browse-title').textContent = `ğŸ“š ${category} é¢˜åº“æµè§ˆ`;
                    showView('browse', false); // ä¸é‡ç½®åˆ†ç±»
                }

                // åŠ è½½é¢˜ç›®åˆ—è¡¨
                function loadExamList() {
                    const container = document.getElementById('exam-list-container');
                    const loadingElement = document.querySelector('#browse-view .loading');

                    // æ˜¾ç¤ºloadingçŠ¶æ€
                    if (loadingElement) {
                        loadingElement.style.display = 'block';
                    }

                    setTimeout(() => {
                        let examsToShow = examIndex;

                        if (currentCategory !== 'all') {
                            examsToShow = examIndex.filter(exam => exam.category === currentCategory);
                        }

                        // éšè—loadingçŠ¶æ€
                        if (loadingElement) {
                            loadingElement.style.display = 'none';
                        }

                        if (examsToShow.length === 0) {
                            container.innerHTML = `
                        <div style="text-align: center; padding: 40px; background: rgba(255, 255, 255, 0.1); border-radius: 10px;">
                            <h3>ğŸ“ æš‚æ— é¢˜ç›®</h3>
                            <p style="margin: 15px 0; opacity: 0.8;">è¯·å…ˆæ‰«æé¢˜åº“æ¥åŠ è½½é¢˜ç›®åˆ—è¡¨</p>
                            <button class="btn" onclick="loadLibrary()">åŠ è½½é¢˜åº“</button>
                        </div>
                    `;
                            return;
                        }

                        filteredExams = examsToShow;
                        displayExams(filteredExams);
                    }, 500);
                }

                // ä¼˜åŒ–çš„é¢˜ç›®åˆ—è¡¨æ˜¾ç¤ºå‡½æ•°
                function displayExams(exams) {
                    const startTime = performance.now();
                    const container = document.getElementById('exam-list-container');

                    if (exams.length === 0) {
                        container.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: rgba(255, 255, 255, 0.1); border-radius: 10px;">
                        <h3>ğŸ” æœªæ‰¾åˆ°åŒ¹é…çš„é¢˜ç›®</h3>
                        <p style="opacity: 0.8;">è¯·å°è¯•å…¶ä»–æœç´¢å…³é”®è¯</p>
                    </div>
                `;
                        return;
                    }

                    // æ¸…ç†ä¹‹å‰çš„è™šæ‹Ÿæ»šåŠ¨å™¨
                    if (window.currentVirtualScroller) {
                        window.currentVirtualScroller.destroy();
                        window.currentVirtualScroller = null;
                    }

                    // å¯¹äºå¤§é‡æ•°æ®ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨
                    if (exams.length > 50 && window.performanceOptimizer) {
                        console.log(`[Display] ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨æ˜¾ç¤º ${exams.length} ä¸ªé¢˜ç›®`);
                        setupVirtualScrolling(container, exams);
                    } else {
                        // å¯¹äºå°‘é‡æ•°æ®ä½¿ç”¨ä¼ ç»Ÿæ¸²æŸ“
                        renderExamList(container, exams);
                    }

                    const renderTime = performance.now() - startTime;
                    if (window.performanceOptimizer) {
                        window.performanceOptimizer.recordRenderTime(renderTime);
                    }
                    
                    console.log(`[Display] æ¸²æŸ“å®Œæˆ: ${exams.length} ä¸ªé¢˜ç›® (${Math.round(renderTime)}ms)`);
                }

                // è®¾ç½®è™šæ‹Ÿæ»šåŠ¨
                function setupVirtualScrolling(container, exams) {
                    // åˆ›å»ºæ»šåŠ¨å®¹å™¨
                    container.innerHTML = '<div id="virtual-scroll-container" style="height: 600px; overflow-y: auto;"></div>';
                    const scrollContainer = document.getElementById('virtual-scroll-container');

                    // åˆ›å»ºè™šæ‹Ÿæ»šåŠ¨å™¨
                    window.currentVirtualScroller = window.performanceOptimizer.createVirtualScroller(
                        scrollContainer,
                        exams,
                        renderExamItem,
                        {
                            itemHeight: 120, // æ¯ä¸ªé¢˜ç›®é¡¹çš„é«˜åº¦
                            bufferSize: 5   // ç¼“å†²åŒºå¤§å°
                        }
                    );
                }

                // æ¸²æŸ“å•ä¸ªé¢˜ç›®é¡¹
                function renderExamItem(exam, index) {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'exam-item';
                    itemDiv.innerHTML = `
                        <div class="exam-info">
                            <h4>${exam.title}</h4>
                            <div class="exam-meta">
                                ${exam.category} â€¢ ${exam.frequency === 'high' ? 'é«˜é¢‘' : 'æ¬¡é«˜é¢‘'} â€¢ 
                                ${exam.hasHtml ? 'ğŸŒ HTML' : 'ğŸ“„ PDF'}
                                ${exam.note ? ` â€¢ ${exam.note}` : ''}
                            </div>
                        </div>
                        <div class="exam-actions">
                            <button class="btn ${exam.hasHtml ? '' : 'btn-secondary'}" 
                                    onclick="openExam('${exam.id}')" 
                                    ${exam.hasHtml ? '' : 'title="PDFæ–‡ä»¶ï¼Œå°†åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€"'}>
                                ${exam.hasHtml ? 'å¼€å§‹ç»ƒä¹ ' : 'æŸ¥çœ‹PDF'}
                            </button>
                            <button class="btn btn-secondary" onclick="viewPDF('${exam.id}')">
                                æŸ¥çœ‹PDF
                            </button>
                            ${!exam.hasHtml ? `<button class="btn btn-info" onclick="generateHTML('${exam.id}')" title="ä¸ºæ­¤PDFè€ƒè¯•ç”ŸæˆHTMLç»ƒä¹ ç‰ˆæœ¬">ç”ŸæˆHTML</button>` : ''}
                        </div>
                    `;
                    return itemDiv;
                }

                // ä¼ ç»Ÿåˆ—è¡¨æ¸²æŸ“ï¼ˆç”¨äºå°‘é‡æ•°æ®ï¼‰
                function renderExamList(container, exams) {
                    // ä½¿ç”¨æ‰¹é‡å¤„ç†é¿å…é˜»å¡UI
                    if (window.performanceOptimizer && exams.length > 20) {
                        container.innerHTML = '<div class="exam-list" id="exam-list-content"></div>';
                        const listContainer = document.getElementById('exam-list-content');
                        
                        window.performanceOptimizer.batchProcess(
                            exams,
                            (exam, index) => {
                                const itemElement = renderExamItem(exam, index);
                                listContainer.appendChild(itemElement);
                                return itemElement;
                            },
                            10, // æ¯æ‰¹10ä¸ª
                            5   // 5mså»¶è¿Ÿ
                        );
                    } else {
                        // ç›´æ¥æ¸²æŸ“å°æ•°æ®é›†
                        container.innerHTML = `
                    <div class="exam-list">
                        ${exams.map(exam => `
                            <div class="exam-item">
                                <div class="exam-info">
                                    <h4>${exam.title}</h4>
                                    <div class="exam-meta">
                                        ${exam.category} â€¢ ${exam.frequency === 'high' ? 'é«˜é¢‘' : 'æ¬¡é«˜é¢‘'} â€¢ 
                                        ${exam.hasHtml ? 'ğŸŒ HTML' : 'ğŸ“„ PDF'}
                                        ${exam.note ? ` â€¢ ${exam.note}` : ''}
                                    </div>
                                </div>
                                <div class="exam-actions">
                                    <button class="btn ${exam.hasHtml ? '' : 'btn-secondary'}" 
                                            onclick="openExam('${exam.id}')" 
                                            ${exam.hasHtml ? '' : 'title="PDFæ–‡ä»¶ï¼Œå°†åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€"'}>
                                        ${exam.hasHtml ? 'å¼€å§‹ç»ƒä¹ ' : 'æŸ¥çœ‹PDF'}
                                    </button>
                                    <button class="btn btn-secondary" onclick="viewPDF('${exam.id}')">
                                        æŸ¥çœ‹PDF
                                    </button>
                                    ${!exam.hasHtml ? `<button class="btn btn-info" onclick="generateHTML('${exam.id}')" title="ä¸ºæ­¤PDFè€ƒè¯•ç”ŸæˆHTMLç»ƒä¹ ç‰ˆæœ¬">ç”ŸæˆHTML</button>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                    }
                }



                // æ‰“å¼€é¢˜ç›®
                function openExam(examId) {
                    const exam = examIndex.find(e => e.id === examId);
                    if (!exam) {
                        showMessage('é¢˜ç›®ä¸å­˜åœ¨', 'error');
                        return;
                    }

                    showMessage(`æ­£åœ¨æ‰“å¼€: ${exam.title}`, 'info');

                    try {
                        // å¦‚æœæ˜¯PDFæ–‡ä»¶ï¼Œä½¿ç”¨PDFæŸ¥çœ‹åŠŸèƒ½
                        if (!exam.hasHtml) {
                            console.log('[System] æ‰“å¼€PDFæ–‡ä»¶:', exam.title);
                            viewPDF(examId);
                            return;
                        }

                        // å¦‚æœä¸»åº”ç”¨å·²åˆå§‹åŒ–ï¼Œä½¿ç”¨ä¸»åº”ç”¨çš„æ–¹æ³•
                        if (app && typeof app.openExam === 'function') {
                            console.log('[System] ä½¿ç”¨ä¸»åº”ç”¨æ‰“å¼€é¢˜ç›®');
                            app.openExam(examId);
                        } else {
                            // é™çº§åˆ°ç®€å•çš„çª—å£æ‰“å¼€
                            console.log('[System] ä½¿ç”¨ç®€åŒ–æ–¹å¼æ‰“å¼€é¢˜ç›®');
                            const fullPath = exam.path + exam.filename;

                            const examWindow = window.open(fullPath, `exam_${exam.id}`,
                                'width=1200,height=800,scrollbars=yes,resizable=yes,status=yes,toolbar=no,menubar=no,location=no'
                            );

                            if (examWindow) {
                                showMessage(`é¢˜ç›®å·²æ‰“å¼€: ${exam.title}`, 'success');

                                // ç­‰å¾…é¡µé¢åŠ è½½åå‘é€åˆå§‹åŒ–æ¶ˆæ¯
                                setTimeout(() => {
                                    if (examWindow && !examWindow.closed) {
                                        try {
                                            const initData = {
                                                type: 'INIT_SESSION',
                                                data: {
                                                    sessionId: examId + '_' + Date.now(),
                                                    examId: examId,
                                                    examTitle: exam.title,
                                                    examCategory: exam.category,
                                                    parentOrigin: window.location.origin,
                                                    timestamp: Date.now()
                                                }
                                            };
                                            examWindow.postMessage(initData, '*');
                                            console.log('[System] å‘é€åˆå§‹åŒ–æ¶ˆæ¯åˆ°ç»ƒä¹ é¡µé¢:', initData);
                                        } catch (error) {
                                            console.warn('[System] æ— æ³•å‘é€åˆå§‹åŒ–æ¶ˆæ¯:', error);
                                        }
                                    }
                                }, 2000);

                            } else {
                                showMessage('æ— æ³•æ‰“å¼€æ–°çª—å£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å¼¹çª—è®¾ç½®', 'error');
                            }
                        }
                    } catch (error) {
                        console.error('[System] æ‰“å¼€é¢˜ç›®å¤±è´¥:', error);
                        showMessage('æ‰“å¼€é¢˜ç›®å¤±è´¥: ' + error.message, 'error');
                    }
                }

                // æ£€æŸ¥é¢˜ç›®æ–‡ä»¶
                function checkExamFile(examId) {
                    const exam = examIndex.find(e => e.id === examId);
                    if (!exam) {
                        showMessage('é¢˜ç›®ä¸å­˜åœ¨', 'error');
                        return;
                    }

                    const fullPath = exam.path + exam.filename;
                    showMessage(`æ£€æŸ¥æ–‡ä»¶: ${exam.filename}`, 'info');

                    fetch(fullPath, { method: 'HEAD' })
                        .then(response => {
                            if (response.ok) {
                                showMessage(`âœ… æ–‡ä»¶å­˜åœ¨: ${exam.filename}`, 'success');
                            } else {
                                showMessage(`âŒ æ–‡ä»¶ä¸å­˜åœ¨ (${response.status}): ${exam.filename}`, 'error');
                            }
                        })
                        .catch(error => {
                            showMessage(`âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                        });
                }

                // ç”ŸæˆHTMLç‰ˆæœ¬
                function generateHTML(examId) {
                    if (window.app && typeof window.app.generateHTMLForPDFExam === 'function') {
                        window.app.generateHTMLForPDFExam(examId);
                    } else {
                        showMessage('HTMLç”ŸæˆåŠŸèƒ½ä¸å¯ç”¨', 'error');
                    }
                }



                // ç³»ç»Ÿç»„ä»¶çŠ¶æ€æ£€æŸ¥
                function checkSystemStatus() {
                    const components = {
                        'ExamSystemApp': !!window.ExamSystemApp,
                        'PracticeRecorder': !!window.PracticeRecorder,
                        'PDFHandler': !!window.PDFHandler,
                        'App Instance': !!window.app,
                        'Practice Records': practiceRecords.length > 0,
                        'Exam Index': examIndex.length > 0
                    };

                    let statusMessage = 'ç³»ç»Ÿç»„ä»¶çŠ¶æ€:\n\n';
                    let allGood = true;

                    Object.entries(components).forEach(([name, status]) => {
                        const icon = status ? 'âœ…' : 'âŒ';
                        statusMessage += `${icon} ${name}: ${status ? 'æ­£å¸¸' : 'æœªåŠ è½½'}\n`;
                        if (!status && name !== 'Practice Records') allGood = false;
                    });

                    if (window.app && window.app.components) {
                        statusMessage += '\nåº”ç”¨ç»„ä»¶:\n';
                        Object.entries(window.app.components).forEach(([name, component]) => {
                            const icon = component ? 'âœ…' : 'âŒ';
                            statusMessage += `${icon} ${name}: ${component ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–'}\n`;
                        });
                    }

                    statusMessage += `\næ€»ä½“çŠ¶æ€: ${allGood ? 'âœ… ç³»ç»Ÿæ­£å¸¸' : 'âš ï¸ éƒ¨åˆ†ç»„ä»¶æœªåŠ è½½'}`;

                    alert(statusMessage);
                    console.log('[System] ç»„ä»¶çŠ¶æ€æ£€æŸ¥:', components);
                }

                // æŸ¥çœ‹PDFæ–‡ä»¶
                function viewPDF(examId) {
                    const exam = examIndex.find(e => e.id === examId);
                    if (!exam) {
                        showMessage('é¢˜ç›®ä¸å­˜åœ¨', 'error');
                        return;
                    }

                    // æ„é€ PDFæ–‡ä»¶è·¯å¾„
                    let pdfPath = exam.path + exam.filename;

                    // å¦‚æœæ–‡ä»¶åä¸æ˜¯PDFï¼Œå°è¯•æŸ¥æ‰¾å¯¹åº”çš„PDFæ–‡ä»¶
                    if (!pdfPath.toLowerCase().endsWith('.pdf')) {
                        // å°è¯•å¸¸è§çš„PDFæ–‡ä»¶åæ¨¡å¼
                        const basePath = exam.path;
                        const possiblePdfNames = [
                            exam.filename.replace(/\.html?$/i, '.pdf'),
                            exam.id.replace(/^p\d+-\w+-\d+/, exam.category) + '.pdf',
                            // æ ¹æ®ç›®å½•ç»“æ„æ¨æµ‹PDFæ–‡ä»¶å
                            exam.title.split(' ')[0] + '.pdf'
                        ];

                        // ä½¿ç”¨ç¬¬ä¸€ä¸ªå¯èƒ½çš„PDFæ–‡ä»¶å
                        pdfPath = basePath + possiblePdfNames[0];
                    }

                    showMessage(`æ­£åœ¨æ‰“å¼€PDF: ${exam.title}`, 'info');

                    // ä½¿ç”¨PDFå¤„ç†å™¨æ‰“å¼€PDF
                    const pdfWindow = openPDFSafely(pdfPath, exam.title);

                    if (pdfWindow) {
                        // éªŒè¯PDFæ˜¯å¦æˆåŠŸåŠ è½½
                        setTimeout(() => {
                            if (pdfHandler && typeof pdfHandler.validatePDF === 'function') {
                                pdfHandler.validatePDF(pdfPath).then(isValid => {
                                    if (!isValid) {
                                        showMessage(`PDFæ–‡ä»¶å¯èƒ½æ— æ³•æ­£å¸¸æ˜¾ç¤º: ${exam.title}`, 'warning');
                                    }
                                }).catch(error => {
                                    console.warn('[System] PDFéªŒè¯å¤±è´¥:', error);
                                });
                            }
                        }, 2000);
                    }
                }

                // åŠ è½½å®Œæ•´ç³»ç»Ÿ
                function loadFullSystem() {
                    if (confirm('ç¡®å®šè¦å°è¯•åŠ è½½å®Œæ•´ç³»ç»Ÿå—ï¼Ÿ\næ³¨æ„ï¼šå¦‚æœindex.htmlä¸å­˜åœ¨ï¼Œå°†æ˜¾ç¤ºé”™è¯¯é¡µé¢ã€‚')) {
                        showMessage('æ­£åœ¨è·³è½¬åˆ°å®Œæ•´ç³»ç»Ÿ...', 'info');
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 1000);
                    }
                }

                // æ¸…é™¤ç¼“å­˜
                function clearCache() {
                    if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ç¼“å­˜æ•°æ®å—ï¼Ÿ')) {
                        localStorage.clear();
                        sessionStorage.clear();
                        
                        // æ¸…é™¤æ€§èƒ½ä¼˜åŒ–å™¨ç¼“å­˜
                        if (window.performanceOptimizer) {
                            window.performanceOptimizer.cleanup();
                        }
                        
                        showMessage('ç¼“å­˜å·²æ¸…é™¤', 'success');
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    }
                }

                // æ˜¾ç¤ºæ€§èƒ½æŠ¥å‘Š
                function showPerformanceReport() {
                    if (!window.performanceOptimizer) {
                        showMessage('æ€§èƒ½ä¼˜åŒ–å™¨æœªåˆå§‹åŒ–', 'warning');
                        return;
                    }

                    const report = window.performanceOptimizer.getPerformanceReport();
                    
                    let reportHtml = `
                        <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px; margin: 20px 0;">
                            <h3>ğŸ“Š ç³»ç»Ÿæ€§èƒ½æŠ¥å‘Š</h3>
                            
                            <div style="margin: 15px 0;">
                                <h4>ğŸ—„ï¸ ç¼“å­˜ç»Ÿè®¡</h4>
                                <p>ç¼“å­˜é¡¹æ•°: ${report.cache.itemCount}</p>
                                <p>ç¼“å­˜å¤§å°: ${Math.round(report.cache.totalSize / 1024)} KB</p>
                                <p>å‘½ä¸­ç‡: ${Math.round(report.cache.hitRate)}%</p>
                            </div>

                            <div style="margin: 15px 0;">
                                <h4>âš¡ æ€§èƒ½æŒ‡æ ‡</h4>
                                <p>å¹³å‡åŠ è½½æ—¶é—´: ${report.performance.averageLoadTime} ms</p>
                                <p>å¹³å‡æ¸²æŸ“æ—¶é—´: ${report.performance.averageRenderTime} ms</p>
                                <p>åŠ è½½æ ·æœ¬æ•°: ${report.performance.totalLoadSamples}</p>
                                <p>æ¸²æŸ“æ ·æœ¬æ•°: ${report.performance.totalRenderSamples}</p>
                            </div>
                    `;

                    if (report.memory) {
                        const usagePercent = Math.round((report.memory.used / report.memory.limit) * 100);
                        reportHtml += `
                            <div style="margin: 15px 0;">
                                <h4>ğŸ’¾ å†…å­˜ä½¿ç”¨</h4>
                                <p>å·²ä½¿ç”¨: ${report.memory.used} MB</p>
                                <p>æ€»è®¡: ${report.memory.total} MB</p>
                                <p>é™åˆ¶: ${report.memory.limit} MB</p>
                                <p>ä½¿ç”¨ç‡: ${usagePercent}%</p>
                            </div>
                        `;
                    }

                    reportHtml += `
                            <div style="margin-top: 20px;">
                                <button class="btn btn-secondary" onclick="this.parentElement.parentElement.remove()">å…³é—­</button>
                            </div>
                        </div>
                    `;

                    // æ˜¾ç¤ºæŠ¥å‘Š
                    const container = document.getElementById('settings-view');
                    const existingReport = container.querySelector('.performance-report');
                    if (existingReport) {
                        existingReport.remove();
                    }

                    const reportDiv = document.createElement('div');
                    reportDiv.className = 'performance-report';
                    reportDiv.innerHTML = reportHtml;
                    container.appendChild(reportDiv);

                    showMessage('æ€§èƒ½æŠ¥å‘Šå·²ç”Ÿæˆ', 'success');
                }

                // æ•°æ®ç®¡ç†åŠŸèƒ½

                // åˆ›å»ºæ‰‹åŠ¨å¤‡ä»½
                async function createManualBackup() {
                    if (!window.dataIntegrityManager) {
                        showMessage('æ•°æ®å®Œæ•´æ€§ç®¡ç†å™¨æœªåˆå§‹åŒ–', 'error');
                        return;
                    }

                    try {
                        showMessage('æ­£åœ¨åˆ›å»ºå¤‡ä»½...', 'info');
                        const backup = await window.dataIntegrityManager.createBackup(null, 'manual');
                        showMessage(`å¤‡ä»½åˆ›å»ºæˆåŠŸ: ${backup.id}`, 'success');
                    } catch (error) {
                        console.error('[DataManagement] åˆ›å»ºå¤‡ä»½å¤±è´¥:', error);
                        showMessage('å¤‡ä»½åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
                    }
                }

                // æ˜¾ç¤ºå¤‡ä»½åˆ—è¡¨
                function showBackupList() {
                    if (!window.dataIntegrityManager) {
                        showMessage('æ•°æ®å®Œæ•´æ€§ç®¡ç†å™¨æœªåˆå§‹åŒ–', 'error');
                        return;
                    }

                    const backups = window.dataIntegrityManager.getBackupList();
                    
                    if (backups.length === 0) {
                        showMessage('æš‚æ— å¤‡ä»½è®°å½•', 'info');
                        return;
                    }

                    let backupHtml = `
                        <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px; margin: 20px 0;">
                            <h3>ğŸ“‹ å¤‡ä»½åˆ—è¡¨</h3>
                            <div style="max-height: 300px; overflow-y: auto; margin: 15px 0;">
                    `;

                    backups.forEach(backup => {
                        const date = new Date(backup.timestamp).toLocaleString();
                        const sizeKB = Math.round(backup.size / 1024);
                        const typeIcon = backup.type === 'auto' ? 'ğŸ”„' : backup.type === 'manual' ? 'ğŸ‘¤' : 'âš ï¸';
                        
                        backupHtml += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <div>
                                    <strong>${typeIcon} ${backup.id}</strong><br>
                                    <small>${date} â€¢ ${sizeKB} KB â€¢ v${backup.version}</small>
                                </div>
                                <button class="btn btn-secondary" onclick="restoreBackup('${backup.id}')" style="margin-left: 10px;">æ¢å¤</button>
                            </div>
                        `;
                    });

                    backupHtml += `
                            </div>
                            <button class="btn btn-secondary" onclick="this.parentElement.parentElement.remove()">å…³é—­</button>
                        </div>
                    `;

                    // æ˜¾ç¤ºå¤‡ä»½åˆ—è¡¨
                    const container = document.getElementById('settings-view');
                    const existingList = container.querySelector('.backup-list');
                    if (existingList) {
                        existingList.remove();
                    }

                    const listDiv = document.createElement('div');
                    listDiv.className = 'backup-list';
                    listDiv.innerHTML = backupHtml;
                    container.appendChild(listDiv);
                }

                // æ¢å¤å¤‡ä»½
                async function restoreBackup(backupId) {
                    if (!window.dataIntegrityManager) {
                        showMessage('æ•°æ®å®Œæ•´æ€§ç®¡ç†å™¨æœªåˆå§‹åŒ–', 'error');
                        return;
                    }

                    if (!confirm(`ç¡®å®šè¦æ¢å¤å¤‡ä»½ ${backupId} å—ï¼Ÿå½“å‰æ•°æ®å°†è¢«è¦†ç›–ã€‚`)) {
                        return;
                    }

                    try {
                        showMessage('æ­£åœ¨æ¢å¤å¤‡ä»½...', 'info');
                        await window.dataIntegrityManager.restoreBackup(backupId);
                        showMessage('å¤‡ä»½æ¢å¤æˆåŠŸï¼Œé¡µé¢å°†åˆ·æ–°', 'success');
                        
                        setTimeout(() => {
                            location.reload();
                        }, 2000);
                    } catch (error) {
                        console.error('[DataManagement] æ¢å¤å¤‡ä»½å¤±è´¥:', error);
                        showMessage('å¤‡ä»½æ¢å¤å¤±è´¥: ' + error.message, 'error');
                    }
                }

                // å¯¼å‡ºæ‰€æœ‰æ•°æ®
                function exportAllData() {
                    if (!window.dataIntegrityManager) {
                        showMessage('æ•°æ®å®Œæ•´æ€§ç®¡ç†å™¨æœªåˆå§‹åŒ–', 'error');
                        return;
                    }

                    try {
                        showMessage('æ­£åœ¨å¯¼å‡ºæ•°æ®...', 'info');
                        window.dataIntegrityManager.exportData();
                        showMessage('æ•°æ®å¯¼å‡ºæˆåŠŸ', 'success');
                    } catch (error) {
                        console.error('[DataManagement] å¯¼å‡ºæ•°æ®å¤±è´¥:', error);
                        showMessage('æ•°æ®å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
                    }
                }

                // å¯¼å…¥æ•°æ®
                function importData() {
                    if (!window.dataIntegrityManager) {
                        showMessage('æ•°æ®å®Œæ•´æ€§ç®¡ç†å™¨æœªåˆå§‹åŒ–', 'error');
                        return;
                    }

                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.json';
                    
                    input.onchange = async (event) => {
                        const file = event.target.files[0];
                        if (!file) return;

                        if (!confirm('å¯¼å…¥æ•°æ®å°†è¦†ç›–å½“å‰æ•°æ®ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ')) {
                            return;
                        }

                        try {
                            showMessage('æ­£åœ¨å¯¼å…¥æ•°æ®...', 'info');
                            const result = await window.dataIntegrityManager.importData(file);
                            showMessage(`æ•°æ®å¯¼å…¥æˆåŠŸ: ${result.importedCount} ä¸ªé¡¹ç›®`, 'success');
                            
                            setTimeout(() => {
                                location.reload();
                            }, 2000);
                        } catch (error) {
                            console.error('[DataManagement] å¯¼å…¥æ•°æ®å¤±è´¥:', error);
                            showMessage('æ•°æ®å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
                        }
                    };

                    input.click();
                }

                // éªŒè¯æ‰€æœ‰æ•°æ®
                function validateAllData() {
                    if (!window.dataIntegrityManager) {
                        showMessage('æ•°æ®å®Œæ•´æ€§ç®¡ç†å™¨æœªåˆå§‹åŒ–', 'error');
                        return;
                    }

                    try {
                        showMessage('æ­£åœ¨æ£€æŸ¥æ•°æ®å®Œæ•´æ€§...', 'info');
                        const report = window.dataIntegrityManager.getIntegrityReport();
                        
                        let validationHtml = `
                            <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px; margin: 20px 0;">
                                <h3>ğŸ” æ•°æ®å®Œæ•´æ€§æŠ¥å‘Š</h3>
                                <p><strong>æ£€æŸ¥æ—¶é—´:</strong> ${new Date(report.timestamp).toLocaleString()}</p>
                                <p><strong>æ•°æ®ç‰ˆæœ¬:</strong> ${report.dataVersion}</p>
                                <p><strong>å¤‡ä»½æ•°é‡:</strong> ${report.backups.length}</p>
                                
                                <div style="margin: 15px 0;">
                                    <h4>éªŒè¯ç»“æœ:</h4>
                        `;

                        let totalErrors = 0;
                        Object.entries(report.validation).forEach(([key, validation]) => {
                            const status = validation.valid ? 'âœ…' : 'âŒ';
                            const errorCount = validation.errors.length;
                            totalErrors += errorCount;
                            
                            validationHtml += `
                                <div style="margin: 5px 0;">
                                    ${status} <strong>${key}:</strong> ${validation.valid ? 'æ­£å¸¸' : `${errorCount} ä¸ªé”™è¯¯`}
                                </div>
                            `;
                            
                            if (!validation.valid) {
                                validation.errors.forEach(error => {
                                    validationHtml += `<div style="margin-left: 20px; font-size: 0.9em; opacity: 0.8;">â€¢ ${error}</div>`;
                                });
                            }
                        });

                        validationHtml += `
                                </div>
                                <div style="margin-top: 20px;">
                                    <strong>æ€»ä½“çŠ¶æ€:</strong> ${totalErrors === 0 ? 'âœ… æ•°æ®å®Œæ•´' : `âš ï¸ å‘ç° ${totalErrors} ä¸ªé—®é¢˜`}
                                </div>
                                <button class="btn btn-secondary" onclick="this.parentElement.parentElement.remove()">å…³é—­</button>
                            </div>
                        `;

                        // æ˜¾ç¤ºæŠ¥å‘Š
                        const container = document.getElementById('settings-view');
                        const existingReport = container.querySelector('.validation-report');
                        if (existingReport) {
                            existingReport.remove();
                        }

                        const reportDiv = document.createElement('div');
                        reportDiv.className = 'validation-report';
                        reportDiv.innerHTML = validationHtml;
                        container.appendChild(reportDiv);

                        const messageType = totalErrors === 0 ? 'success' : 'warning';
                        showMessage(`æ•°æ®æ£€æŸ¥å®Œæˆï¼Œ${totalErrors === 0 ? 'æ•°æ®å®Œæ•´' : `å‘ç° ${totalErrors} ä¸ªé—®é¢˜`}`, messageType);

                    } catch (error) {
                        console.error('[DataManagement] æ•°æ®éªŒè¯å¤±è´¥:', error);
                        showMessage('æ•°æ®éªŒè¯å¤±è´¥: ' + error.message, 'error');
                    }
                }



                // è¿è¡Œå®Œæ•´ç³»ç»ŸéªŒè¯
                function runCompleteSystemValidation() {
                    if (typeof window.runSystemValidation !== 'function') {
                        showMessage('ç³»ç»ŸéªŒè¯è„šæœ¬æœªåŠ è½½', 'error');
                        return;
                    }

                    showMessage('æ­£åœ¨è¿›è¡Œå®Œæ•´ç³»ç»ŸéªŒè¯...', 'info');
                    
                    try {
                        // è¿è¡ŒéªŒè¯å¹¶æ˜¾ç¤ºç»“æœ
                        const result = window.runSystemValidation();
                        
                        setTimeout(() => {
                            const messageType = result.successRate >= 80 ? 'success' : 
                                              result.successRate >= 60 ? 'info' : 'error';
                            
                            showMessage(
                                `ç³»ç»ŸéªŒè¯å®Œæˆï¼é€šè¿‡ç‡: ${result.successRate}% (${result.passed}/${result.total})`,
                                messageType
                            );
                            
                            if (result.successRate >= 80) {
                                setTimeout(() => {
                                    showMessage('ğŸ‰ ç³»ç»ŸåŠŸèƒ½å®Œæ•´ï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼', 'success');
                                }, 1000);
                            }
                        }, 2000);
                        
                    } catch (error) {
                        console.error('[SystemValidation] éªŒè¯å¤±è´¥:', error);
                        showMessage('ç³»ç»ŸéªŒè¯å¤±è´¥: ' + error.message, 'error');
                    }
                }

                // æ˜¾ç¤ºé¢˜åº“ç´¢å¼•ä¿¡æ¯
                function showExamIndexInfo() {
                    console.log('[ExamIndex] é¢˜åº“æ€»æ•°:', examIndex.length);

                    if (examIndex.length > 0) {
                        console.log('[ExamIndex] å‰10ä¸ªé¢˜ç›®:');
                        examIndex.slice(0, 10).forEach((exam, index) => {
                            console.log(`${index + 1}. ID: ${exam.id}, æ–‡ä»¶å: ${exam.filename}, æ ‡é¢˜: ${exam.title}`);
                        });

                        // æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤çš„æ–‡ä»¶å
                        const filenames = examIndex.map(exam => exam.filename).filter(f => f);
                        const uniqueFilenames = [...new Set(filenames)];
                        if (filenames.length !== uniqueFilenames.length) {
                            console.warn('[ExamIndex] å‘ç°é‡å¤çš„æ–‡ä»¶å');
                        }

                        showMessage(`é¢˜åº“ä¿¡æ¯å·²è¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œå…± ${examIndex.length} ä¸ªé¢˜ç›®`, 'info');
                    } else {
                        showMessage('é¢˜åº“ä¸ºç©ºï¼Œè¯·å…ˆåŠ è½½é¢˜åº“', 'error');
                    }
                }



                // ä¿®å¤ä¸å®Œæ•´çš„æ ‡é¢˜
                function fixIncompleteTitles() {
                    const records = storage.get('practice_records', []);
                    let fixedCount = 0;

                    records.forEach(record => {
                        if (record.dataSource === 'real' && record.realData) {
                            // æ£€æŸ¥æ˜¯å¦éœ€è¦ä¿®å¤æ ‡é¢˜
                            const needsFix = record.title === 'P1' || record.title === 'P2' || record.title === 'P3' ||
                                record.title === 'Unknown Practice' || record.title.includes('Unknown') ||
                                record.title.length < 5; // æ ‡é¢˜å¤ªçŸ­ä¹Ÿéœ€è¦ä¿®å¤

                            if (needsFix && record.realData.url) {
                                const urlParts = record.realData.url.split('/');
                                let filename = urlParts[urlParts.length - 1];
                                console.log(`[Fix] åŸå§‹æ–‡ä»¶å: ${filename}`);

                                // URLè§£ç 
                                try {
                                    filename = decodeURIComponent(filename);
                                    console.log(`[Fix] è§£ç åæ–‡ä»¶å: ${filename}`);
                                } catch (e) {
                                    console.log(`[Fix] URLè§£ç å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æ–‡ä»¶å`);
                                }

                                // é¦–å…ˆå°è¯•é€šè¿‡æ–‡ä»¶åç²¾ç¡®åŒ¹é…
                                let examInfo = examIndex.find(exam => exam.filename === filename);

                                // å¦‚æœç²¾ç¡®åŒ¹é…å¤±è´¥ï¼Œå°è¯•æ¨¡ç³ŠåŒ¹é…
                                if (!examInfo) {
                                    // å°è¯•ä¸åŒºåˆ†å¤§å°å†™åŒ¹é…
                                    examInfo = examIndex.find(exam =>
                                        exam.filename && exam.filename.toLowerCase() === filename.toLowerCase()
                                    );
                                }

                                if (!examInfo) {
                                    // å°è¯•ä»æ–‡ä»¶åä¸­æå–å…³é”®ä¿¡æ¯è¿›è¡ŒåŒ¹é…
                                    const cleanFilename = filename.replace(/\.(html?|php)$/i, '');
                                    console.log(`[Fix] æ¸…ç†åçš„æ–‡ä»¶å: ${cleanFilename}`);

                                    // æå–åˆ†ç±»å’Œæ ‡é¢˜ - å¤„ç†æ ¼å¼å¦‚ "P2 - A new look for Talbot Parkã€é«˜ã€‘"
                                    const match = cleanFilename.match(/^(P[123])\s*[-â€“]\s*(.+?)(?:ã€.+ã€‘)?$/);
                                    if (match) {
                                        const [, category, titlePart] = match;
                                        console.log(`[Fix] æå–çš„åˆ†ç±»: ${category}, æ ‡é¢˜éƒ¨åˆ†: ${titlePart}`);

                                        // é€šè¿‡æ ‡é¢˜å…³é”®è¯åŒ¹é…
                                        const titleWords = titlePart.toLowerCase().split(/\s+/).filter(word => word.length > 2);
                                        console.log(`[Fix] æ ‡é¢˜å…³é”®è¯: ${titleWords.join(', ')}`);

                                        examInfo = examIndex.find(exam => {
                                            const examTitleLower = exam.title.toLowerCase();
                                            const matchCount = titleWords.filter(word => examTitleLower.includes(word)).length;
                                            return matchCount >= Math.min(2, titleWords.length);
                                        });

                                        if (examInfo) {
                                            console.log(`[Fix] é€šè¿‡å…³é”®è¯åŒ¹é…æ‰¾åˆ°: ${examInfo.title}`);
                                        }
                                    }
                                }

                                if (examInfo) {
                                    console.log(`[Fix] ä¿®å¤æ ‡é¢˜: "${record.title}" -> "${examInfo.title}"`);
                                    record.title = examInfo.title;
                                    record.category = examInfo.category;
                                    record.frequency = examInfo.frequency;
                                    fixedCount++;
                                } else {
                                    console.log(`[Fix] æ— æ³•æ‰¾åˆ°åŒ¹é…çš„é¢˜ç›®: ${filename}`);
                                }
                            }
                        }
                    });

                    if (fixedCount > 0) {
                        storage.set('practice_records', records);
                        practiceRecords = records;
                        showMessage(`å·²ä¿®å¤ ${fixedCount} ä¸ªä¸å®Œæ•´çš„æ ‡é¢˜`, 'success');
                        updatePracticeView();
                    } else {
                        showMessage('æ²¡æœ‰å‘ç°éœ€è¦ä¿®å¤çš„æ ‡é¢˜', 'info');
                    }
                }

                // è®°å½•ç»ƒä¹ ï¼ˆå·²åºŸå¼ƒï¼Œç°åœ¨ä½¿ç”¨çœŸå®æ•°æ®ä¼ è¾“ï¼‰
                function recordPractice(exam, startTime) {
                    console.log('[Practice] recordPracticeå‡½æ•°å·²åºŸå¼ƒï¼Œä¸å†ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®');
                    console.log('[Practice] ç­‰å¾…çœŸå®æ•°æ®é€šè¿‡è·¨çª—å£é€šä¿¡ä¼ è¾“');
                    // ä¸å†ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®ï¼Œæ‰€æœ‰æ•°æ®éƒ½é€šè¿‡è·¨çª—å£é€šä¿¡è·å–
                }

                // è®¡ç®—ç»ƒä¹ ç»Ÿè®¡ï¼ˆåªç»Ÿè®¡çœŸå®æ•°æ®ï¼‰
                function calculatePracticeStats() {
                    // åªç»Ÿè®¡çœŸå®æ•°æ®è®°å½•
                    const realDataRecords = practiceRecords.filter(record =>
                        record.dataSource === 'real' && record.realData
                    );

                    if (realDataRecords.length === 0) {
                        practiceStats = {
                            totalPracticed: 0,
                            avgScore: 0,
                            totalTime: 0,
                            streakDays: 0
                        };
                        return;
                    }

                    practiceStats.totalPracticed = realDataRecords.length;

                    // åªè®¡ç®—çœŸå®æ•°æ®çš„ç»Ÿè®¡
                    let totalScore = 0;
                    let totalTime = 0;

                    realDataRecords.forEach(record => {
                        const score = record.realData.percentage || record.percentage || Math.round((record.realData.accuracy || 0) * 100);
                        const duration = Math.round((record.realData.duration || record.duration || 0) / 60); // è½¬æ¢ä¸ºåˆ†é’Ÿ
                        totalScore += score;
                        totalTime += duration;
                    });

                    practiceStats.avgScore = Math.round(totalScore / realDataRecords.length);
                    practiceStats.totalTime = totalTime;

                    // è®¡ç®—åˆ†ç±»ç»Ÿè®¡
                    practiceStats.categoryStats = {
                        P1: { count: 0, avgScore: 0, totalTime: 0 },
                        P2: { count: 0, avgScore: 0, totalTime: 0 },
                        P3: { count: 0, avgScore: 0, totalTime: 0 }
                    };

                    ['P1', 'P2', 'P3'].forEach(category => {
                        const categoryRecords = realDataRecords.filter(record => record.category === category);
                        if (categoryRecords.length > 0) {
                            const categoryTotalScore = categoryRecords.reduce((sum, record) => {
                                const score = record.realData.percentage || record.percentage || Math.round((record.realData.accuracy || 0) * 100);
                                return sum + score;
                            }, 0);
                            const categoryTotalTime = categoryRecords.reduce((sum, record) => {
                                const duration = Math.round((record.realData.duration || record.duration || 0) / 60);
                                return sum + duration;
                            }, 0);

                            practiceStats.categoryStats[category] = {
                                count: categoryRecords.length,
                                avgScore: Math.round(categoryTotalScore / categoryRecords.length),
                                totalTime: categoryTotalTime
                            };
                        }
                    });

                    // è®¡ç®—è¿ç»­å­¦ä¹ å¤©æ•°
                    const today = new Date();
                    const dates = [...new Set(realDataRecords.map(record => new Date(record.date).toDateString()))];
                    dates.sort((a, b) => new Date(b) - new Date(a));

                    let streak = 0;
                    let currentDate = new Date(today);

                    for (let dateStr of dates) {
                        const recordDate = new Date(dateStr);
                        const diffDays = Math.floor((currentDate - recordDate) / (1000 * 60 * 60 * 24));

                        if (diffDays === streak) {
                            streak++;
                            currentDate = recordDate;
                        } else if (diffDays === streak + 1) {
                            streak++;
                            currentDate = recordDate;
                        } else {
                            break;
                        }
                    }

                    practiceStats.streakDays = streak;
                }

                // æ›´æ–°ç»ƒä¹ è§†å›¾
                function updatePracticeView() {
                    calculatePracticeStats();

                    // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
                    document.getElementById('total-practiced').textContent = practiceStats.totalPracticed;
                    document.getElementById('avg-score').textContent = practiceStats.avgScore + '%';
                    document.getElementById('study-time').textContent = practiceStats.totalTime;
                    document.getElementById('streak-days').textContent = practiceStats.streakDays;

                    // æ›´æ–°ç»ƒä¹ å†å²
                    const historyContainer = document.getElementById('practice-history-list');

                    if (practiceRecords.length === 0) {
                        historyContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; opacity: 0.7;">
                        <div style="font-size: 3em; margin-bottom: 15px;">ğŸ“‹</div>
                        <p>æš‚æ— ç»ƒä¹ è®°å½•</p>
                        <p style="font-size: 0.9em; margin-top: 10px;">å¼€å§‹ç»ƒä¹ åï¼Œè®°å½•å°†è‡ªåŠ¨ä¿å­˜åœ¨è¿™é‡Œ</p>
                    </div>
                `;
                        return;
                    }

                    // åªæ˜¾ç¤ºçœŸå®æ•°æ®è®°å½•
                    const realDataRecords = practiceRecords.filter(record =>
                        record.dataSource === 'real' && record.realData
                    );

                    if (realDataRecords.length === 0) {
                        historyContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; opacity: 0.7;">
                        <div style="font-size: 3em; margin-bottom: 15px;">ğŸ“‹</div>
                        <p>æš‚æ— ç»ƒä¹ è®°å½•</p>
                        <p style="font-size: 0.9em; margin-top: 10px;">å®Œæˆç»ƒä¹ åï¼Œæ•°æ®å°†è‡ªåŠ¨ä¿å­˜åœ¨è¿™é‡Œ</p>
                    </div>
                `;
                        return;
                    }

                    historyContainer.innerHTML = realDataRecords.slice(0, 20).map(record => {
                        const date = new Date(record.date);

                        // å¤„ç†æ•°æ®æ ¼å¼
                        const score = record.realData.score || record.score || 0;
                        const totalQuestions = record.realData.totalQuestions || record.totalQuestions || 0;
                        const duration = Math.round((record.realData.duration || record.duration || 0) / 60); // è½¬æ¢ä¸ºåˆ†é’Ÿ
                        const accuracy = record.realData.percentage || record.percentage || Math.round((record.realData.accuracy || 0) * 100);

                        const scoreColor = accuracy >= 80 ? '#4ade80' : accuracy >= 60 ? '#fbbf24' : '#ff6b6b';

                        // è¯¦ç»†ä¿¡æ¯æç¤º
                        let detailsTooltip = '';
                        if (record.realData) {
                            const details = [];
                            if (score !== undefined && totalQuestions !== undefined) {
                                details.push(`å¾—åˆ†: ${score}/${totalQuestions}`);
                            }
                            if (record.realData.source) {
                                const sourceText = record.realData.source === 'page_extraction' ? 'é¡µé¢æå–' :
                                    record.realData.source === 'calculation' ? 'è‡ªåŠ¨è®¡ç®—' :
                                        record.realData.source === 'manual_input' ? 'æ‰‹åŠ¨è¾“å…¥' : record.realData.source;
                                details.push(`æ¥æº: ${sourceText}`);
                            }
                            detailsTooltip = details.length > 0 ? `title="${details.join(' | ')}"` : '';
                        }

                        const isSelected = selectedRecords.has(record.id);
                        const selectionStyle = bulkDeleteMode ?
                            (isSelected ? 'background: rgba(255, 0, 0, 0.1); border: 2px solid #ff6b6b;' : 'border: 2px solid transparent;') : '';
                        const clickHandler = bulkDeleteMode ? `toggleRecordSelection('${record.id}')` : '';

                        return `
                    <div class="history-item" ${detailsTooltip} 
                         data-record-id="${record.id}"
                         style="cursor: ${bulkDeleteMode ? 'pointer' : 'help'}; position: relative; ${selectionStyle}"
                         ${bulkDeleteMode ? `onclick="${clickHandler}"` : ''}>
                        <div>
                            <strong>${record.title}</strong><br>
                            <small>${record.category} â€¢ ${date.toLocaleDateString()} ${date.toLocaleTimeString()}</small>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: ${scoreColor}; font-weight: bold;">${accuracy}%</div>
                            <small>${duration}åˆ†é’Ÿ</small>
                        </div>
                        ${bulkDeleteMode ?
                                `<div style="position: absolute; top: 10px; right: 10px; font-size: 18px;">
                                ${isSelected ? 'âœ…' : 'â­•'}
                            </div>` :
                                `<button class="delete-record-btn" onclick="deleteRecord('${record.id}')" title="åˆ é™¤æ­¤è®°å½•">
                                âŒ
                            </button>`
                            }
                    </div>
                `;
                    }).join('');
                }

                // å¯¼å‡ºç»ƒä¹ æ•°æ®
                function exportPracticeData() {
                    if (practiceRecords.length === 0) {
                        showMessage('æš‚æ— ç»ƒä¹ æ•°æ®å¯å¯¼å‡º', 'info');
                        return;
                    }

                    const data = {
                        exportDate: new Date().toISOString(),
                        stats: practiceStats,
                        records: practiceRecords
                    };

                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `practice-records-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    showMessage('ç»ƒä¹ æ•°æ®å·²å¯¼å‡º', 'success');
                }

                // æ¸…é™¤ç»ƒä¹ æ•°æ®
                function clearPracticeData() {
                    if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ç»ƒä¹ è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                        practiceRecords = [];
                        localStorage.removeItem('practice_records');
                        processedSessions.clear(); // æ¸…é™¤å·²å¤„ç†ä¼šè¯è®°å½•
                        updatePracticeView();
                        showMessage('ç»ƒä¹ è®°å½•å·²æ¸…é™¤', 'success');
                    }
                }

                // åˆ é™¤å•ä¸ªç»ƒä¹ è®°å½•
                function deleteRecord(recordId) {
                    if (!recordId) {
                        showMessage('è®°å½•IDæ— æ•ˆ', 'error');
                        return;
                    }

                    const records = storage.get('practice_records', []);
                    const recordIndex = records.findIndex(record => record.id === recordId);

                    if (recordIndex === -1) {
                        showMessage('æœªæ‰¾åˆ°æŒ‡å®šè®°å½•', 'error');
                        return;
                    }

                    const record = records[recordIndex];
                    const confirmMessage = `ç¡®å®šè¦åˆ é™¤è¿™æ¡ç»ƒä¹ è®°å½•å—ï¼Ÿ\n\né¢˜ç›®: ${record.title}\næ—¶é—´: ${new Date(record.date).toLocaleString()}\n\næ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`;

                    if (confirm(confirmMessage)) {
                        // æ·»åŠ åˆ é™¤åŠ¨ç”»
                        const historyItem = document.querySelector(`[onclick="deleteRecord('${recordId}')"]`).closest('.history-item');
                        if (historyItem) {
                            historyItem.classList.add('deleting');

                            // å»¶è¿Ÿæ‰§è¡Œåˆ é™¤ä»¥æ˜¾ç¤ºåŠ¨ç”»
                            setTimeout(() => {
                                historyItem.classList.add('deleted');

                                setTimeout(() => {
                                    // åˆ é™¤è®°å½•
                                    records.splice(recordIndex, 1);

                                    // ä¿å­˜æ›´æ–°åçš„è®°å½•
                                    storage.set('practice_records', records);
                                    practiceRecords = records;

                                    // é‡æ–°è®¡ç®—ç»Ÿè®¡æ•°æ®
                                    calculatePracticeStats();

                                    // æ›´æ–°æ˜¾ç¤º
                                    updatePracticeView();

                                    showMessage('è®°å½•å·²åˆ é™¤', 'success');

                                    console.log(`[System] å·²åˆ é™¤ç»ƒä¹ è®°å½•: ${recordId}`);
                                }, 500);
                            }, 200);
                        } else {
                            // å¦‚æœæ‰¾ä¸åˆ°DOMå…ƒç´ ï¼Œç›´æ¥åˆ é™¤
                            records.splice(recordIndex, 1);
                            storage.set('practice_records', records);
                            practiceRecords = records;
                            calculatePracticeStats();
                            updatePracticeView();
                            showMessage('è®°å½•å·²åˆ é™¤', 'success');
                        }
                    }
                }

                // æ‰¹é‡åˆ é™¤ç®¡ç†
                let bulkDeleteMode = false;
                let selectedRecords = new Set();

                function toggleBulkDelete() {
                    bulkDeleteMode = !bulkDeleteMode;
                    const btn = document.getElementById('bulk-delete-btn');

                    if (bulkDeleteMode) {
                        btn.textContent = 'âœ… å®Œæˆé€‰æ‹©';
                        btn.classList.remove('btn-info');
                        btn.classList.add('btn-success');
                        selectedRecords.clear();
                        showMessage('æ‰¹é‡ç®¡ç†æ¨¡å¼å·²å¼€å¯ï¼Œç‚¹å‡»è®°å½•è¿›è¡Œé€‰æ‹©', 'info');
                    } else {
                        btn.textContent = 'ğŸ“ æ‰¹é‡ç®¡ç†';
                        btn.classList.remove('btn-success');
                        btn.classList.add('btn-info');

                        if (selectedRecords.size > 0) {
                            const confirmMessage = `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedRecords.size} æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`;
                            if (confirm(confirmMessage)) {
                                bulkDeleteRecords();
                            }
                        }
                        selectedRecords.clear();
                    }

                    updatePracticeView();
                }

                function bulkDeleteRecords() {
                    const records = storage.get('practice_records', []);
                    const recordsToKeep = records.filter(record => !selectedRecords.has(record.id));

                    const deletedCount = records.length - recordsToKeep.length;

                    storage.set('practice_records', recordsToKeep);
                    practiceRecords = recordsToKeep;

                    calculatePracticeStats();
                    updatePracticeView();

                    showMessage(`å·²åˆ é™¤ ${deletedCount} æ¡è®°å½•`, 'success');
                    console.log(`[System] æ‰¹é‡åˆ é™¤äº† ${deletedCount} æ¡ç»ƒä¹ è®°å½•`);
                }

                function toggleRecordSelection(recordId) {
                    if (!bulkDeleteMode) return;

                    if (selectedRecords.has(recordId)) {
                        selectedRecords.delete(recordId);
                    } else {
                        selectedRecords.add(recordId);
                    }

                    // æ›´æ–°è§†è§‰åé¦ˆ
                    const historyItem = document.querySelector(`[data-record-id="${recordId}"]`);
                    if (historyItem) {
                        if (selectedRecords.has(recordId)) {
                            historyItem.style.background = 'rgba(255, 0, 0, 0.1)';
                            historyItem.style.border = '2px solid #ff6b6b';
                        } else {
                            historyItem.style.background = '';
                            historyItem.style.border = '';
                        }
                    }
                }

                // æ¸…ç†é‡å¤å’Œæ— æ•ˆè®°å½•
                function cleanupPracticeData() {
                    const records = storage.get('practice_records', []);
                    const cleanedRecords = [];
                    const seenKeys = new Set();
                    let fixedTitles = 0;

                    // åªä¿ç•™çœŸå®æ•°æ®è®°å½•ï¼Œå¹¶å»é‡ï¼ŒåŒæ—¶ä¿®å¤é¢˜ç›®æ ‡é¢˜
                    records.forEach(record => {
                        if (record.dataSource === 'real' && record.realData) {
                            const key = record.examId + '_' + record.endTime;
                            if (!seenKeys.has(key)) {
                                seenKeys.add(key);

                                // å°è¯•ä¿®å¤é¢˜ç›®æ ‡é¢˜
                                if (record.title === 'Unknown Practice' || record.title.includes('Unknown')) {
                                    const examInfo = findExamInfo(record);
                                    if (examInfo) {
                                        record.title = examInfo.title;
                                        record.category = examInfo.category;
                                        record.frequency = examInfo.frequency;
                                        fixedTitles++;
                                        console.log('[Cleanup] ä¿®å¤é¢˜ç›®æ ‡é¢˜:', record.title);
                                    }
                                }

                                cleanedRecords.push(record);
                            }
                        }
                    });

                    const removedCount = records.length - cleanedRecords.length;
                    let message = '';

                    if (removedCount > 0 || fixedTitles > 0) {
                        storage.set('practice_records', cleanedRecords);
                        practiceRecords = cleanedRecords;

                        if (removedCount > 0 && fixedTitles > 0) {
                            message = `å·²æ¸…ç† ${removedCount} æ¡é‡å¤è®°å½•ï¼Œä¿®å¤ ${fixedTitles} ä¸ªé¢˜ç›®æ ‡é¢˜`;
                        } else if (removedCount > 0) {
                            message = `å·²æ¸…ç† ${removedCount} æ¡é‡å¤æˆ–æ— æ•ˆè®°å½•`;
                        } else {
                            message = `å·²ä¿®å¤ ${fixedTitles} ä¸ªé¢˜ç›®æ ‡é¢˜`;
                        }

                        showMessage(message, 'success');
                        updatePracticeView();
                    } else {
                        showMessage('æ²¡æœ‰å‘ç°éœ€è¦æ¸…ç†çš„è®°å½•', 'info');
                    }
                }

                // æŸ¥æ‰¾é¢˜ç›®ä¿¡æ¯çš„è¾…åŠ©å‡½æ•°
                function findExamInfo(record) {
                    if (!record.realData) return null;

                    // å°è¯•é€šè¿‡examIdåŒ¹é…
                    let examInfo = examIndex.find(exam => exam.id === record.examId);

                    // å°è¯•é€šè¿‡URLåŒ¹é…
                    if (!examInfo && record.realData.url) {
                        const urlParts = record.realData.url.split('/');
                        const filename = urlParts[urlParts.length - 1];
                        console.log('[FindExam] å°è¯•åŒ¹é…æ–‡ä»¶å:', filename);
                        examInfo = examIndex.find(exam => exam.filename === filename);
                        if (examInfo) {
                            console.log('[FindExam] é€šè¿‡æ–‡ä»¶åæ‰¾åˆ°:', examInfo.title);
                        }
                    }

                    // å°è¯•é€šè¿‡æ ‡é¢˜å…³é”®è¯åŒ¹é…
                    if (!examInfo && record.title && record.title !== 'Unknown Practice') {
                        // æå–è‹±æ–‡æ ‡é¢˜éƒ¨åˆ†è¿›è¡ŒåŒ¹é…
                        const titleParts = record.title.split(' ');
                        for (let i = 1; i < titleParts.length; i++) {
                            const searchTerm = titleParts.slice(i).join(' ');
                            examInfo = examIndex.find(exam =>
                                exam.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                searchTerm.toLowerCase().includes(exam.title.toLowerCase())
                            );
                            if (examInfo) {
                                console.log('[FindExam] é€šè¿‡æ ‡é¢˜åŒ¹é…æ‰¾åˆ°:', examInfo.title);
                                break;
                            }
                        }
                    }

                    return examInfo;
                }

                // æ›´æ–°ç³»ç»Ÿä¿¡æ¯
                function updateSystemInfo() {
                    const htmlCount = examIndex.filter(exam => exam.hasHtml).length;
                    const pdfCount = examIndex.filter(exam => !exam.hasHtml).length;

                    document.getElementById('total-exams').textContent = examIndex.length;
                    document.getElementById('html-exams').textContent = htmlCount;
                    document.getElementById('pdf-exams').textContent = pdfCount;
                    document.getElementById('last-update').textContent = new Date().toLocaleString();
                }

                // æ›´æ–°æ€»è§ˆé¡µé¢
                function updateOverview() {
                    const categoryStats = {
                        'P1': { total: 0, html: 0, pdf: 0 },
                        'P2': { total: 0, html: 0, pdf: 0 },
                        'P3': { total: 0, html: 0, pdf: 0 }
                    };

                    examIndex.forEach(exam => {
                        if (categoryStats[exam.category]) {
                            categoryStats[exam.category].total++;
                            if (exam.hasHtml) {
                                categoryStats[exam.category].html++;
                            } else {
                                categoryStats[exam.category].pdf++;
                            }
                        }
                    });

                    const categoryContainer = document.getElementById('category-overview');
                    categoryContainer.innerHTML = `
                <div class="category-card">
                    <div class="category-header">
                        <div class="category-icon">ğŸ“–</div>
                        <div>
                            <div class="category-title">P1 åŸºç¡€é˜…è¯»</div>
                            <div class="category-meta">${categoryStats.P1.total} ç¯‡æ–‡ç«  (${categoryStats.P1.html} HTML, ${categoryStats.P1.pdf} PDF)</div>
                        </div>
                    </div>
                    <div class="category-actions">
                        <button class="btn" onclick="browseCategory('P1')">ğŸ“š æµè§ˆé¢˜ç›®</button>
                        <button class="btn btn-secondary" onclick="startRandomPractice('P1')">ğŸ² éšæœºç»ƒä¹ </button>
                    </div>
                </div>
                
                <div class="category-card">
                    <div class="category-header">
                        <div class="category-icon">ğŸ“š</div>
                        <div>
                            <div class="category-title">P2 ä¸­çº§é˜…è¯»</div>
                            <div class="category-meta">${categoryStats.P2.total} ç¯‡æ–‡ç«  (${categoryStats.P2.html} HTML, ${categoryStats.P2.pdf} PDF)</div>
                        </div>
                    </div>
                    <div class="category-actions">
                        <button class="btn" onclick="browseCategory('P2')">ğŸ“š æµè§ˆé¢˜ç›®</button>
                        <button class="btn btn-secondary" onclick="startRandomPractice('P2')">ğŸ² éšæœºç»ƒä¹ </button>
                    </div>
                </div>
                
                <div class="category-card">
                    <div class="category-header">
                        <div class="category-icon">ğŸ“‘</div>
                        <div>
                            <div class="category-title">P3 é«˜çº§é˜…è¯»</div>
                            <div class="category-meta">${categoryStats.P3.total} ç¯‡æ–‡ç«  (${categoryStats.P3.html} HTML, ${categoryStats.P3.pdf} PDF)</div>
                        </div>
                    </div>
                    <div class="category-actions">
                        <button class="btn" onclick="browseCategory('P3')">ğŸ“š æµè§ˆé¢˜ç›®</button>
                        <button class="btn btn-secondary" onclick="startRandomPractice('P3')">ğŸ² éšæœºç»ƒä¹ </button>
                    </div>
                </div>
                `;
                }

                // æ·»åŠ CSSåŠ¨ç”»
                const style = document.createElement('style');
                style.textContent = `
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100 %);
                    opacity: 0;
                }
            }
            `;
                document.head.appendChild(style);

                // è®¾ç½®å…¨å±€æ¶ˆæ¯ç›‘å¬å™¨ï¼ˆæ— è®ºåº”ç”¨æ˜¯å¦åˆå§‹åŒ–éƒ½è¦è®¾ç½®ï¼‰
                function setupMessageListener() {
                    window.addEventListener('message', (event) => {
                        console.log('[System] æ”¶åˆ°æ¶ˆæ¯:', event.data);

                        if (event.data && event.data.source === 'practice_page') {
                            console.log('[System] æ”¶åˆ°ç»ƒä¹ é¡µé¢æ¶ˆæ¯:', event.data);

                            switch (event.data.type) {
                                case 'SESSION_READY':
                                    console.log('[System] ç»ƒä¹ ä¼šè¯å·²å‡†å¤‡');
                                    showMessage('ç»ƒä¹ é¡µé¢å·²è¿æ¥', 'success');
                                    break;
                                case 'PROGRESS_UPDATE':
                                    console.log('[System] ç»ƒä¹ è¿›åº¦æ›´æ–°:', event.data.data);
                                    break;
                                case 'PRACTICE_COMPLETE':
                                    console.log('[System] ç»ƒä¹ å®Œæˆï¼Œå¤„ç†æ•°æ®');
                                    console.log('[System] å®Œæ•´ç»ƒä¹ æ•°æ®:', JSON.stringify(event.data.data, null, 2));
                                    handlePracticeDataReceived(event.data.data);
                                    break;
                                case 'ERROR_OCCURRED':
                                    console.error('[System] ç»ƒä¹ é¡µé¢é”™è¯¯:', event.data.data);
                                    showMessage('ç»ƒä¹ é¡µé¢å‘ç”Ÿé”™è¯¯', 'error');
                                    break;
                                default:
                                    console.log('[System] æœªçŸ¥æ¶ˆæ¯ç±»å‹:', event.data.type);
                            }
                        }
                    });
                    console.log('[System] æ¶ˆæ¯ç›‘å¬å™¨å·²è®¾ç½®');
                }

                // åˆå§‹åŒ–ä¸»åº”ç”¨
                function initializeApp() {
                    try {
                        if (window.ExamSystemApp) {
                            app = new ExamSystemApp();
                            app.initialize();
                            console.log('[System] ä¸»åº”ç”¨å·²åˆå§‹åŒ–');
                        } else {
                            console.warn('[System] ExamSystemAppç±»æœªåŠ è½½ï¼Œä½¿ç”¨ç®€åŒ–æ¨¡å¼');
                        }

                        // åˆå§‹åŒ–é€šä¿¡æ¢å¤æœºåˆ¶
                        if (window.CommunicationRecovery) {
                            window.communicationManager = new CommunicationRecovery();
                            console.log('[System] é€šä¿¡æ¢å¤æœºåˆ¶å·²åˆå§‹åŒ–');
                        } else {
                            console.warn('[System] CommunicationRecoveryç±»æœªåŠ è½½');
                        }

                        // åˆå§‹åŒ–æ€§èƒ½ä¼˜åŒ–å™¨
                        if (window.PerformanceOptimizer) {
                            window.performanceOptimizer = new PerformanceOptimizer();
                            console.log('[System] æ€§èƒ½ä¼˜åŒ–å™¨å·²åˆå§‹åŒ–');
                        } else {
                            console.warn('[System] PerformanceOptimizerç±»æœªåŠ è½½');
                        }

                        // åˆå§‹åŒ–æ•°æ®å®Œæ•´æ€§ç®¡ç†å™¨
                        if (window.DataIntegrityManager) {
                            window.dataIntegrityManager = new DataIntegrityManager();
                            
                            // æ£€æŸ¥æ•°æ®å…¼å®¹æ€§
                            const compatibility = window.dataIntegrityManager.checkDataCompatibility();
                            if (compatibility.migrated) {
                                showMessage('æ•°æ®å·²å‡çº§åˆ°æ–°ç‰ˆæœ¬', 'info');
                            } else if (!compatibility.compatible) {
                                showMessage('æ•°æ®å…¼å®¹æ€§æ£€æŸ¥å¤±è´¥: ' + compatibility.error, 'warning');
                            }
                            
                            console.log('[System] æ•°æ®å®Œæ•´æ€§ç®¡ç†å™¨å·²åˆå§‹åŒ–');
                        } else {
                            console.warn('[System] DataIntegrityManagerç±»æœªåŠ è½½');
                        }

                        return true;
                    } catch (error) {
                        console.error('[System] åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', error);
                        window.handleError(error, 'åº”ç”¨åˆå§‹åŒ–', {
                            userMessage: 'ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨'
                        });
                        return false;
                    }
                }

                // ç”¨äºé˜²æ­¢é‡å¤å¤„ç†çš„ä¼šè¯IDé›†åˆ
                const processedSessions = new Set();

                // å¤„ç†æ¥æ”¶åˆ°çš„ç»ƒä¹ æ•°æ®
                function handlePracticeDataReceived(practiceData) {
                    console.log('[System] å¤„ç†ç»ƒä¹ æ•°æ®:', practiceData);

                    // æ›´å¼ºçš„é‡å¤æ£€æµ‹æœºåˆ¶
                    const sessionKey = practiceData.sessionId + '_' + practiceData.endTime;
                    const examKey = (practiceData.examId || practiceData.sessionId) + '_' + practiceData.endTime;

                    if (processedSessions.has(sessionKey) || processedSessions.has(examKey)) {
                        console.log('[System] æ•°æ®å·²å¤„ç†è¿‡ï¼Œè·³è¿‡é‡å¤å¤„ç†:', sessionKey);
                        return;
                    }
                    processedSessions.add(sessionKey);
                    processedSessions.add(examKey);

                    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„è®°å½•
                    const existingRecords = storage.get('practice_records', []);
                    const isDuplicate = existingRecords.some(record =>
                        record.examId === (practiceData.examId || practiceData.sessionId) &&
                        Math.abs(new Date(record.endTime).getTime() - new Date(practiceData.endTime).getTime()) < 5000 // 5ç§’å†…çš„è®°å½•è§†ä¸ºé‡å¤
                    );

                    if (isDuplicate) {
                        console.log('[System] æ£€æµ‹åˆ°é‡å¤è®°å½•ï¼Œè·³è¿‡ä¿å­˜');
                        return;
                    }

                    try {
                        // å°è¯•ä»examIdè·å–é¢˜ç›®ä¿¡æ¯
                        const examId = practiceData.examId || practiceData.sessionId;
                        console.log('[System] æŸ¥æ‰¾é¢˜ç›®ä¿¡æ¯ - examId:', examId);
                        console.log('[System] å¯ç”¨é¢˜ç›®ç´¢å¼•æ•°é‡:', examIndex.length);

                        // æ™ºèƒ½é¢˜ç›®ä¿¡æ¯æå–
                        let finalTitle = 'Unknown Practice';
                        let finalCategory = 'Unknown';
                        let finalFrequency = 'unknown';

                        console.log('[System] å¼€å§‹é¢˜ç›®ä¿¡æ¯æå–');
                        console.log('[System] ç»ƒä¹ æ•°æ®URL:', practiceData.url);
                        console.log('[System] é¢˜åº“ç´¢å¼•æ•°é‡:', examIndex.length);

                        // æ–¹æ³•1: é€šè¿‡examIdç›´æ¥åŒ¹é…
                        let examInfo = examIndex.find(exam => exam.id === examId);
                        if (examInfo) {
                            finalTitle = examInfo.title;
                            finalCategory = examInfo.category;
                            finalFrequency = examInfo.frequency;
                            console.log('[System] é€šè¿‡examIdåŒ¹é…æˆåŠŸ:', examInfo.title);
                        }

                        // æ–¹æ³•2: å¦‚æœæ–¹æ³•1å¤±è´¥ï¼Œé€šè¿‡URLæ–‡ä»¶ååŒ¹é…
                        if (finalTitle === 'Unknown Practice' && practiceData.url) {
                            const urlParts = practiceData.url.split('/');
                            let filename = urlParts[urlParts.length - 1];
                            console.log('[System] åŸå§‹æ–‡ä»¶å:', filename);

                            // URLè§£ç 
                            try {
                                filename = decodeURIComponent(filename);
                                console.log('[System] è§£ç åæ–‡ä»¶å:', filename);
                            } catch (e) {
                                console.log('[System] URLè§£ç å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æ–‡ä»¶å');
                            }

                            // æ˜¾ç¤ºå‰å‡ ä¸ªé¢˜åº“é¡¹ç›®ç”¨äºè°ƒè¯•
                            if (examIndex.length > 0) {
                                console.log('[System] é¢˜åº“ç¤ºä¾‹:', examIndex.slice(0, 3).map(e => ({ id: e.id, filename: e.filename, title: e.title })));
                            }

                            // å°è¯•ç²¾ç¡®åŒ¹é…
                            let matchedExam = examIndex.find(exam => exam.filename === filename);

                            if (!matchedExam) {
                                // å°è¯•ä¸åŒºåˆ†å¤§å°å†™çš„åŒ¹é…
                                matchedExam = examIndex.find(exam =>
                                    exam.filename && exam.filename.toLowerCase() === filename.toLowerCase()
                                );
                            }

                            if (!matchedExam) {
                                // å°è¯•ä»æ–‡ä»¶åä¸­æå–å…³é”®ä¿¡æ¯è¿›è¡ŒåŒ¹é…
                                // ä¾‹å¦‚: "P2 - A new look for Talbot Parkã€é«˜ã€‘.html"
                                const cleanFilename = filename.replace(/\.(html?|php)$/i, ''); // ç§»é™¤æ‰©å±•å
                                console.log('[System] æ¸…ç†åçš„æ–‡ä»¶å:', cleanFilename);

                                // æå–åˆ†ç±»å’Œæ ‡é¢˜
                                const match = cleanFilename.match(/^(P[123])\s*[-â€“]\s*(.+?)(?:ã€.+ã€‘)?$/);
                                if (match) {
                                    const [, category, titlePart] = match;
                                    console.log('[System] æå–çš„åˆ†ç±»:', category, 'æ ‡é¢˜éƒ¨åˆ†:', titlePart);

                                    // é€šè¿‡æ ‡é¢˜å…³é”®è¯åŒ¹é…
                                    const titleWords = titlePart.toLowerCase().split(/\s+/).filter(word => word.length > 2);
                                    console.log('[System] æ ‡é¢˜å…³é”®è¯:', titleWords);

                                    matchedExam = examIndex.find(exam => {
                                        const examTitleLower = exam.title.toLowerCase();
                                        const matchCount = titleWords.filter(word => examTitleLower.includes(word)).length;
                                        return matchCount >= Math.min(2, titleWords.length); // è‡³å°‘åŒ¹é…2ä¸ªå…³é”®è¯æˆ–æ‰€æœ‰å…³é”®è¯
                                    });

                                    if (matchedExam) {
                                        console.log('[System] é€šè¿‡å…³é”®è¯åŒ¹é…æˆåŠŸ:', matchedExam.title);
                                    }
                                }
                            }

                            if (matchedExam) {
                                finalTitle = matchedExam.title;
                                finalCategory = matchedExam.category;
                                finalFrequency = matchedExam.frequency;
                                console.log('[System] æ–‡ä»¶ååŒ¹é…æˆåŠŸ:', matchedExam.title);
                            } else {
                                console.log('[System] æ‰€æœ‰æ–‡ä»¶ååŒ¹é…æ–¹æ³•éƒ½å¤±è´¥');
                            }
                        }

                        // æ–¹æ³•3: å¦‚æœè¿˜æ˜¯å¤±è´¥ï¼Œå°è¯•ä»URLè·¯å¾„æå–ä¿¡æ¯
                        if (finalTitle === 'Unknown Practice' && practiceData.url) {
                            const pathParts = practiceData.url.split('/').filter(part => part.length > 0);
                            console.log('[System] URLè·¯å¾„éƒ¨åˆ†:', pathParts);

                            let categoryFromPath = '';
                            let titleFromPath = '';

                            for (let part of pathParts) {
                                if (part.match(/^P[123]$/i)) {
                                    categoryFromPath = part.toUpperCase();
                                } else if (part.includes('.html') || part.includes('.htm')) {
                                    titleFromPath = part.replace(/\.(html?|php)$/i, '').replace(/[-_]/g, ' ');
                                }
                            }

                            console.log('[System] ä»è·¯å¾„æå– - åˆ†ç±»:', categoryFromPath, 'æ ‡é¢˜:', titleFromPath);

                            if (titleFromPath) {
                                // å°è¯•é€šè¿‡æ ‡é¢˜å…³é”®è¯åŒ¹é…
                                const titleWords = titleFromPath.toLowerCase().split(' ').filter(word => word.length > 2);
                                console.log('[System] æ ‡é¢˜å…³é”®è¯:', titleWords);

                                const possibleMatch = examIndex.find(exam => {
                                    const examTitleLower = exam.title.toLowerCase();
                                    return titleWords.some(word => examTitleLower.includes(word));
                                });

                                if (possibleMatch) {
                                    finalTitle = possibleMatch.title;
                                    finalCategory = possibleMatch.category;
                                    finalFrequency = possibleMatch.frequency;
                                    console.log('[System] é€šè¿‡å…³é”®è¯åŒ¹é…æˆåŠŸ:', possibleMatch.title);
                                } else if (categoryFromPath) {
                                    // å¦‚æœå…³é”®è¯åŒ¹é…ä¹Ÿå¤±è´¥ï¼Œè‡³å°‘ä½¿ç”¨è·¯å¾„ä¿¡æ¯
                                    finalTitle = `${categoryFromPath} ${titleFromPath}`;
                                    finalCategory = categoryFromPath;
                                    console.log('[System] ä½¿ç”¨è·¯å¾„æ„å»ºæ ‡é¢˜:', finalTitle);
                                }
                            }
                        }

                        // æ–¹æ³•4: æœ€åå°è¯•é¡µé¢æ ‡é¢˜åŒ¹é…
                        if (finalTitle === 'Unknown Practice' && practiceData.pageTitle) {
                            console.log('[System] å°è¯•é¡µé¢æ ‡é¢˜åŒ¹é…:', practiceData.pageTitle);
                            const titleMatch = examIndex.find(exam =>
                                exam.title.toLowerCase().includes(practiceData.pageTitle.toLowerCase()) ||
                                practiceData.pageTitle.toLowerCase().includes(exam.title.toLowerCase())
                            );

                            if (titleMatch) {
                                finalTitle = titleMatch.title;
                                finalCategory = titleMatch.category;
                                finalFrequency = titleMatch.frequency;
                                console.log('[System] é€šè¿‡é¡µé¢æ ‡é¢˜åŒ¹é…æˆåŠŸ:', titleMatch.title);
                            }
                        }

                        console.log('[System] æœ€ç»ˆæ ‡é¢˜:', finalTitle);
                        console.log('[System] æœ€ç»ˆåˆ†ç±»:', finalCategory);

                        // åˆ›å»ºç»ƒä¹ è®°å½•
                        const record = {
                            id: 'real_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                            examId: examId,
                            title: finalTitle,
                            category: finalCategory,
                            frequency: finalFrequency,

                            // çœŸå®æ•°æ®æ ‡è¯†
                            dataSource: 'real',
                            isRealData: true,

                            // åŸºæœ¬ä¿¡æ¯
                            startTime: new Date(practiceData.startTime).toISOString(),
                            endTime: new Date(practiceData.endTime).toISOString(),
                            date: new Date().toISOString(),

                            // æˆç»©æ•°æ®
                            score: practiceData.scoreInfo?.correct || 0,
                            totalQuestions: practiceData.scoreInfo?.total || Object.keys(practiceData.answers || {}).length,
                            accuracy: practiceData.scoreInfo?.accuracy || 0,
                            percentage: practiceData.scoreInfo?.percentage || 0,
                            duration: Math.round(practiceData.duration || 0), // ç§’

                            // è¯¦ç»†æ•°æ®
                            realData: {
                                sessionId: practiceData.sessionId,
                                answers: practiceData.answers || {},
                                interactions: practiceData.interactions || [],
                                scoreInfo: practiceData.scoreInfo || {},
                                pageType: practiceData.pageType,
                                url: practiceData.url,
                                source: practiceData.scoreInfo?.source || 'page_extraction'
                            }
                        };

                        // ä¿å­˜åˆ°localStorage
                        const records = storage.get('practice_records', []);
                        records.unshift(record);

                        // é™åˆ¶è®°å½•æ•°é‡
                        if (records.length > 1000) {
                            records.splice(1000);
                        }

                        storage.set('practice_records', records);

                        // æ›´æ–°å…¨å±€å˜é‡
                        practiceRecords = records;

                        console.log('[System] ç»ƒä¹ è®°å½•å·²ä¿å­˜:', record.id);
                        showMessage('ç»ƒä¹ æ•°æ®å·²ä¿å­˜ï¼', 'success');

                        // å¦‚æœå½“å‰åœ¨ç»ƒä¹ è®°å½•é¡µé¢ï¼Œåˆ·æ–°æ˜¾ç¤º
                        const currentView = document.querySelector('.view.active');
                        if (currentView && currentView.id === 'practice-view') {
                            updatePracticeView();
                        }

                    } catch (error) {
                        console.error('[System] ä¿å­˜ç»ƒä¹ æ•°æ®å¤±è´¥:', error);
                        showMessage('ä¿å­˜ç»ƒä¹ æ•°æ®å¤±è´¥', 'error');
                    }
                }

                // åˆå§‹åŒ–
                document.addEventListener('DOMContentLoaded', () => {
                    showMessage('æ¬¢è¿ä½¿ç”¨è€ƒè¯•æ€»è§ˆç³»ç»Ÿï¼', 'success');

                    // ç«‹å³è®¾ç½®æ¶ˆæ¯ç›‘å¬å™¨ï¼ˆè¿™æ˜¯æœ€é‡è¦çš„ï¼‰
                    setupMessageListener();

                    // è‡ªåŠ¨æ¸…ç†ä¸€æ¬¡é‡å¤è®°å½•
                    setTimeout(() => {
                        const records = storage.get('practice_records', []);
                        if (records.length > 0) {
                            cleanupPracticeData();
                        }
                    }, 1000);

                    // åˆå§‹åŒ–åº”ç”¨
                    setTimeout(() => {
                        const appInitialized = initializeApp();
                        if (appInitialized) {
                            console.log('[System] ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
                        } else {
                            console.warn('[System] ç³»ç»Ÿåˆå§‹åŒ–éƒ¨åˆ†å¤±è´¥ï¼Œä½¿ç”¨ç®€åŒ–æ¨¡å¼');
                        }

                        // åˆå§‹åŒ–PDFå¤„ç†å™¨
                        if (window.PDFHandler) {
                            pdfHandler = new PDFHandler();
                            console.log('[System] PDFå¤„ç†å™¨å·²åˆå§‹åŒ–');
                        } else {
                            console.warn('[System] PDFHandlerç±»æœªåŠ è½½');
                        }

                        // åˆå§‹åŒ–æµè§ˆçŠ¶æ€ç®¡ç†å™¨
                        if (window.BrowseStateManager) {
                            browseStateManager = new BrowseStateManager();
                            console.log('[System] æµè§ˆçŠ¶æ€ç®¡ç†å™¨å·²åˆå§‹åŒ–');
                        } else {
                            console.warn('[System] BrowseStateManagerç±»æœªåŠ è½½');
                        }

                        // è‡ªåŠ¨åŠ è½½é¢˜åº“
                        loadLibrary();
                    }, 500);
                });

                // é”®ç›˜å¿«æ·é”®
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch (e.key) {
                            case '1':
                                e.preventDefault();
                                showView('overview');
                                break;
                            case '2':
                                e.preventDefault();
                                showView('browse');
                                break;
                            case '3':
                                e.preventDefault();
                                showView('practice');
                                break;
                            case '4':
                                e.preventDefault();
                                showView('settings');
                                break;
                        }
                    }
                });
    </script>

    <!-- åŠ è½½ä¸»åº”ç”¨ -->
    <script src="js/app.js"></script>
</body>

</html>