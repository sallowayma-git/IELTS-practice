<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>考试总览系统 - 改进版</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
        }

        /* 消息通知区域 - 固定位置 */
        .message-container {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 350px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            pointer-events: none;
        }

        .message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid;
            font-size: 14px;
            line-height: 1.4;
            pointer-events: auto;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .message.success {
            background: rgba(74, 222, 128, 0.9);
            border-color: #4ade80;
            color: #065f46;
        }

        .message.error {
            background: rgba(255, 107, 107, 0.9);
            border-color: #ff6b6b;
            color: #7f1d1d;
        }

        .message.info {
            background: rgba(59, 130, 246, 0.9);
            border-color: #3b82f6;
            color: #1e3a8a;
        }

        .main-nav {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .nav-btn:hover,
        .nav-btn.active {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .view {
            display: none;
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            min-height: 400px;
        }

        .view.active {
            display: block;
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .category-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .category-card:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .category-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .category-icon {
            font-size: 2em;
            margin-right: 15px;
        }

        .category-title {
            font-size: 1.3em;
            font-weight: bold;
        }

        .category-meta {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 5px;
        }

        .category-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            flex: 1;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #2196F3, #1976D2);
        }

        .btn-info {
            background: linear-gradient(45deg, #17a2b8, #138496);
        }

        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
        }

        .btn-warning {
            background: linear-gradient(45deg, #ffc107, #e0a800);
            color: #212529;
        }

        .btn-info:hover {
            background: linear-gradient(45deg, #138496, #117a8b);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .exam-list {
            display: grid;
            gap: 15px;
            max-height: 600px;
            overflow-y: auto;
        }

        .exam-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .exam-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }

        .exam-info h4 {
            margin-bottom: 5px;
            font-size: 1.1em;
        }

        .exam-meta {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .exam-actions {
            display: flex;
            gap: 10px;
        }

        .loading {
            text-align: center;
            padding: 50px;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid white;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }



        .search-box {
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }



        /* 练习记录样式 */
        .practice-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #4ade80;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 5px;
        }

        .practice-history {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .delete-record-btn {
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 14px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
            padding: 4px;
            border-radius: 4px;
        }

        .history-item:hover .delete-record-btn {
            opacity: 1;
        }

        .delete-record-btn:hover {
            background: rgba(255, 0, 0, 0.1);
            transform: translateY(-50%) scale(1.1);
        }

        .history-item.deleting {
            opacity: 0.5;
            transform: scale(0.95);
            transition: all 0.3s ease;
        }

        .history-item.deleted {
            opacity: 0;
            transform: scale(0.9) translateX(100px);
            transition: all 0.5s ease;
        }



        @media (max-width: 768px) {
            .message-container {
                position: relative;
                top: auto;
                right: auto;
                width: 100%;
                margin-bottom: 20px;
            }

            .container {
                padding: 10px;
            }

            .header {
                padding: 20px;
                margin-bottom: 20px;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .main-nav {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }

            .nav-btn {
                width: 100%;
                max-width: 300px;
                padding: 12px 20px;
                font-size: 14px;
            }

            .category-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .category-card {
                padding: 20px;
            }

            .category-actions {
                flex-direction: column;
                gap: 8px;
            }

            .exam-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
                padding: 15px;
            }

            .exam-actions {
                width: 100%;
                justify-content: stretch;
                flex-direction: column;
                gap: 8px;
            }

            .exam-actions .btn {
                width: 100%;
                margin: 0;
            }

            .view {
                padding: 20px;
            }

            .search-input {
                font-size: 16px; /* 防止iOS缩放 */
            }

            .practice-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-number {
                font-size: 1.5em;
            }

            /* 设置页面移动优化 */
            #settings-view div[style*="display: flex"] {
                flex-direction: column !important;
                gap: 10px !important;
            }

            #settings-view .btn {
                width: 100%;
                margin: 5px 0 !important;
            }

            /* 报告显示优化 */
            .performance-report,
            .backup-list,
            .validation-report,
            .ux-report {
                margin: 10px 0 !important;
                padding: 15px !important;
            }

            /* 虚拟滚动容器优化 */
            #virtual-scroll-container {
                height: 400px !important;
            }
        }

        /* 小屏幕设备进一步优化 */
        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }

            .header {
                padding: 15px;
            }

            .header h1 {
                font-size: 1.3em;
            }

            .nav-btn {
                padding: 10px 15px;
                font-size: 13px;
            }

            .category-card,
            .exam-item {
                padding: 12px;
            }

            .btn {
                padding: 8px 12px;
                font-size: 13px;
            }

            .practice-stats {
                grid-template-columns: 1fr;
            }

            .message {
                padding: 10px;
                font-size: 12px;
            }
        }
    </style>
</head>

<body>
    <div class="message-container" id="message-container"></div>

    <div class="container">
        <div class="header">
            <h1>📚 考试总览系统</h1>
            <p>IELTS阅读练习管理平台 - 改进版</p>
        </div>

        <nav class="main-nav">
            <button class="nav-btn active" onclick="showView('overview')">📊 总览</button>
            <button class="nav-btn" onclick="showView('browse')">📚 题库浏览</button>
            <button class="nav-btn" onclick="showView('practice')">📝 练习记录</button>
            <button class="nav-btn" onclick="showView('settings')">⚙️ 设置</button>
        </nav>

        <!-- 总览页面 -->
        <div id="overview-view" class="view active">
            <h2>📊 学习总览</h2>

            <div class="category-grid" id="category-overview">
                <!-- 分类卡片将通过JavaScript动态生成 -->
            </div>
        </div>

        <!-- 题库浏览页面 -->
        <div id="browse-view" class="view">

            <h2 id="browse-title">📚 题库浏览</h2>

            <div class="search-box">
                <input type="text" class="search-input" placeholder="搜索题目..." onkeyup="searchExams(this.value)">
            </div>

            <div id="exam-list-container"></div>
            <div class="loading">
                <div class="spinner"></div>
                <p>正在加载题目列表...</p>
            </div>
        </div>
    </div>

    <!-- 练习记录页面 -->
    <div id="practice-view" class="view">
        <h2>📝 练习记录</h2>

        <div class="practice-stats">
            <div class="stat-card">
                <div class="stat-number" id="total-practiced">0</div>
                <div class="stat-label">已练习题目</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avg-score">0%</div>
                <div class="stat-label">平均正确率</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="study-time">0</div>
                <div class="stat-label">学习时长(分钟)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="streak-days">0</div>
                <div class="stat-label">连续学习天数</div>
            </div>
        </div>

        <div class="practice-history">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>📈 练习历史</h3>
                <div>
                    <button class="btn btn-secondary" onclick="exportPracticeData()" style="margin-right: 10px;">📊
                        导出数据</button>
                    <button class="btn" onclick="cleanupPracticeData()" style="margin-right: 10px;">🧹 清理重复</button>
                    <button class="btn btn-info" onclick="toggleBulkDelete()" id="bulk-delete-btn"
                        style="margin-right: 10px;">📝
                        批量管理</button>
                    <button class="btn btn-warning" onclick="clearPracticeData()">🗑️ 清除记录</button>
                </div>
            </div>

            <div id="practice-history-list">
                <div style="text-align: center; padding: 40px; opacity: 0.7;">
                    <div style="font-size: 3em; margin-bottom: 15px;">📋</div>
                    <p>暂无练习记录</p>
                    <p style="font-size: 0.9em; margin-top: 10px;">开始练习后，记录将自动保存在这里</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 设置页面 -->
    <div id="settings-view" class="view">
        <h2>⚙️ 系统设置</h2>
        <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px;">
            <h3>🔧 系统管理</h3>
            <p style="margin: 15px 0; opacity: 0.9;">系统工具和设置选项</p>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-warning" onclick="clearCache()">🗑️ 清除缓存</button>
                <button class="btn" onclick="reloadLibrary()">🔄 重新加载题库</button>

                <button class="btn btn-secondary" onclick="showPerformanceReport()">📊 性能报告</button>

                <button class="btn btn-success" onclick="runCompleteSystemValidation()">✅ 完整功能验证</button>
            </div>

            <div style="margin-top: 30px;">
                <h3>💾 数据管理</h3>
                <p style="margin: 15px 0; opacity: 0.9;">数据备份、导入导出和完整性检查</p>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn" onclick="createManualBackup()">💾 创建备份</button>
                    <button class="btn btn-secondary" onclick="showBackupList()">📋 备份列表</button>
                    <button class="btn btn-info" onclick="exportAllData()">📤 导出数据</button>
                    <button class="btn btn-warning" onclick="importData()">📥 导入数据</button>
                    <button class="btn btn-success" onclick="validateAllData()">🔍 数据完整性检查</button>
                </div>
            </div>

            <div style="margin-top: 30px;">
                <h3>📊 系统信息</h3>
                <div style="margin-top: 15px; line-height: 1.8;">
                    <div>题库状态: <span style="color: #4ade80;">已加载完整索引</span></div>
                    <div>题目总数: <span id="total-exams">73</span> 个</div>
                    <div>HTML题目: <span id="html-exams">57</span> 个</div>
                    <div>PDF题目: <span id="pdf-exams">16</span> 个</div>
                    <div>最后更新: <span id="last-update">页面加载时</span></div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- 加载完整题库数据 -->
    <script src="complete-exam-data.js"></script>

    <!-- 加载工具函数 -->
    <script src="js/utils/helpers.js"></script>

    <!-- 加载核心组件 -->
    <script src="js/core/practiceRecorder.js"></script>
    <script src="js/practice-page-enhancer.js"></script>
    <script src="js/components/PDFHandler.js"></script>
    <script src="js/components/examBrowser.js"></script>
    <script src="js/components/ExamScanner.js"></script>
    <script src="js/components/IndexValidator.js"></script>
    <script src="js/components/CommunicationTester.js"></script>
    <script src="js/components/ErrorFixer.js"></script>
    <script src="js/components/CommunicationRecovery.js"></script>
    <script src="js/components/PerformanceOptimizer.js"></script>
    <script src="js/components/DataIntegrityManager.js"></script>
    <script src="js/components/BrowseStateManager.js"></script>
    <script src="system-validation.js"></script>
    <script src="test-system-fixes.js"></script>
    <script src="test-console-fixes.js"></script>
    <script src="cleanup-floating-buttons.js"></script>

    <script>
        // 增强的全局错误处理器
        window.handleError = function (error, context, options = {}) {
            const errorId = `error_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

            // 错误详细信息
            const errorDetails = {
                id: errorId,
                timestamp: new Date().toISOString(),
                context: context,
                message: error.message || '发生未知错误',
                stack: error.stack,
                url: window.location.href,
                userAgent: navigator.userAgent,
                recoverable: options.recoverable !== false
            };

            // 记录错误到本地存储（用于调试和分析）
            try {
                const errorLog = JSON.parse(localStorage.getItem('system_error_log') || '[]');
                errorLog.push(errorDetails);
                // 只保留最近50个错误
                if (errorLog.length > 50) {
                    errorLog.splice(0, errorLog.length - 50);
                }
                localStorage.setItem('system_error_log', JSON.stringify(errorLog));
            } catch (logError) {
                console.warn('无法记录错误日志:', logError);
            }

            // 开发模式下输出详细错误
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                console.error(`[${errorId}] Error in ${context}:`, error);
                console.error('Error details:', errorDetails);
            }

            // 显示用户友好的错误消息
            let userMessage = '';
            if (options.userMessage) {
                userMessage = options.userMessage;
            } else {
                userMessage = window.getErrorUserMessage(error, context);
            }

            window.showMessage(userMessage, 'error');

            // 尝试自动恢复
            if (errorDetails.recoverable && options.autoRecover !== false) {
                setTimeout(() => {
                    window.attemptErrorRecovery(error, context, errorDetails);
                }, 1000);
            }

            return errorDetails;
        };

        // 获取用户友好的错误消息
        window.getErrorUserMessage = function (error, context) {
            const errorType = error.name || 'Error';
            const errorMessage = error.message || '未知错误';

            // 根据错误类型和上下文提供友好消息
            const messageMap = {
                'NetworkError': '网络连接出现问题，请检查网络设置',
                'TypeError': '数据格式错误，正在尝试修复',
                'ReferenceError': '系统组件加载失败，正在重新加载',
                'SyntaxError': '数据解析错误，正在尝试修复',
                'QuotaExceededError': '存储空间不足，请清理浏览器数据',
                'SecurityError': '安全限制，请检查浏览器设置'
            };

            const contextMap = {
                '题库加载': '题库数据加载失败，正在尝试重新加载',
                '数据存储': '数据保存失败，请检查存储空间',
                '数据读取': '数据读取失败，正在尝试修复',
                '跨窗口通信': '页面通信失败，正在重新建立连接',
                '文件加载': '文件加载失败，正在尝试备用方案'
            };

            return contextMap[context] || messageMap[errorType] || `${context}出现问题: ${errorMessage}`;
        };

        // 错误恢复机制
        window.attemptErrorRecovery = function (error, context, errorDetails) {
            console.log(`[Recovery] 尝试恢复错误: ${context}`);

            const recoveryStrategies = {
                '题库加载': () => {
                    console.log('[Recovery] 重新加载题库数据');
                    setTimeout(() => {
                        if (typeof loadExamData === 'function') {
                            loadExamData();
                        }
                    }, 2000);
                },
                '数据存储': () => {
                    console.log('[Recovery] 清理存储空间并重试');
                    try {
                        // 清理旧数据
                        const keys = Object.keys(localStorage);
                        const oldKeys = keys.filter(key => {
                            try {
                                const data = JSON.parse(localStorage.getItem(key));
                                return data.timestamp && (Date.now() - data.timestamp > 7 * 24 * 60 * 60 * 1000);
                            } catch {
                                return false;
                            }
                        });
                        oldKeys.forEach(key => localStorage.removeItem(key));
                        window.showMessage('已清理存储空间，请重试操作', 'info');
                    } catch (recoveryError) {
                        console.error('[Recovery] 存储恢复失败:', recoveryError);
                    }
                },
                '跨窗口通信': () => {
                    console.log('[Recovery] 重新建立跨窗口通信');
                    // 重新初始化通信
                    if (window.communicationManager && typeof window.communicationManager.reinitialize === 'function') {
                        window.communicationManager.reinitialize();
                    }
                },
                '文件加载': () => {
                    console.log('[Recovery] 尝试备用文件加载方案');
                    // 可以在这里实现备用加载逻辑
                }
            };

            const strategy = recoveryStrategies[context];
            if (strategy) {
                try {
                    strategy();
                } catch (recoveryError) {
                    console.error(`[Recovery] 恢复策略执行失败:`, recoveryError);
                }
            }
        };

        // 增强的全局JavaScript错误捕获
        window.addEventListener('error', function (event) {
            const error = event.error || new Error(event.message);
            const context = event.filename ? `脚本加载 (${event.filename}:${event.lineno})` : '系统运行';

            // 检查是否是资源加载错误
            if (event.target && event.target !== window) {
                const resourceType = event.target.tagName.toLowerCase();
                const resourceSrc = event.target.src || event.target.href;
                window.handleResourceLoadError(resourceType, resourceSrc, event);
                return true;
            }

            window.handleError(error, context, {
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno
            });
            return true; // 阻止默认错误处理
        });

        // 增强的Promise错误捕获
        window.addEventListener('unhandledrejection', function (event) {
            const error = event.reason instanceof Error ? event.reason : new Error(String(event.reason));

            // 检查是否是网络请求错误
            if (event.reason && typeof event.reason === 'object' && event.reason.name === 'TypeError' &&
                event.reason.message.includes('fetch')) {
                window.handleError(error, '网络请求', {
                    recoverable: true,
                    userMessage: '网络请求失败，正在重试...'
                });
            } else {
                window.handleError(error, 'Promise处理', { recoverable: true });
            }

            event.preventDefault(); // 阻止默认错误处理
        });

        // 资源加载错误处理
        window.handleResourceLoadError = function(resourceType, resourceSrc, event) {
            console.warn(`[ResourceError] ${resourceType} 加载失败:`, resourceSrc);
            
            const errorDetails = {
                type: 'resource_load_error',
                resourceType: resourceType,
                resourceSrc: resourceSrc,
                timestamp: Date.now()
            };

            // 尝试备用加载方案
            if (resourceType === 'script') {
                window.handleScriptLoadError(resourceSrc, event);
            } else if (resourceType === 'link') {
                window.handleStyleLoadError(resourceSrc, event);
            } else {
                window.showMessage(`资源加载失败: ${resourceSrc}`, 'warning');
            }
        };

        // 脚本加载错误处理
        window.handleScriptLoadError = function(scriptSrc, event) {
            console.warn(`[ScriptError] 脚本加载失败: ${scriptSrc}`);
            
            // 记录失败的脚本
            if (!window.failedScripts) {
                window.failedScripts = new Set();
            }
            window.failedScripts.add(scriptSrc);

            // 尝试从备用路径加载
            const backupPaths = [
                scriptSrc.replace('/js/', '/backup/js/'),
                scriptSrc.replace('.js', '.min.js'),
                scriptSrc.replace('.min.js', '.js')
            ];

            let retryCount = 0;
            const maxRetries = backupPaths.length;

            const tryLoadScript = () => {
                if (retryCount >= maxRetries) {
                    window.showMessage(`脚本加载失败，系统可能不稳定: ${scriptSrc}`, 'error');
                    return;
                }

                const backupSrc = backupPaths[retryCount];
                retryCount++;

                const script = document.createElement('script');
                script.src = backupSrc;
                script.onload = () => {
                    console.log(`[ScriptError] 备用脚本加载成功: ${backupSrc}`);
                    window.showMessage('系统组件已恢复', 'success');
                };
                script.onerror = () => {
                    console.warn(`[ScriptError] 备用脚本也失败: ${backupSrc}`);
                    setTimeout(tryLoadScript, 1000);
                };
                document.head.appendChild(script);
            };

            // 延迟重试，避免立即重试
            setTimeout(tryLoadScript, 500);
        };

        // 样式加载错误处理
        window.handleStyleLoadError = function(styleSrc, event) {
            console.warn(`[StyleError] 样式加载失败: ${styleSrc}`);
            window.showMessage('样式文件加载失败，界面可能显示异常', 'warning');
        };

        // 全局对象初始化
        window.storage = {
                        get: (key, defaultValue) => {
                            try {
                                const value = localStorage.getItem(key);
                                return value ? JSON.parse(value) : defaultValue;
                            } catch (error) {
                                window.handleError(error, '数据读取');
                                return defaultValue;
                            }
                        },
                        set: (key, value) => {
                            try {
                                // 检查存储空间
                                const testKey = '_storage_test_';
                                localStorage.setItem(testKey, 'test');
                                localStorage.removeItem(testKey);

                                // 存储数据
                                localStorage.setItem(key, JSON.stringify(value));
                                return true;
                            } catch (error) {
                                if (error.name === 'QuotaExceededError') {
                                    showMessage('存储空间不足，请清理浏览器数据', 'warning');
                                    // 尝试清理旧数据
                                    window.storage.cleanup();
                                    // 重试一次
                                    try {
                                        localStorage.setItem(key, JSON.stringify(value));
                                        return true;
                                    } catch (retryError) {
                                        window.handleError(retryError, '数据存储重试');
                                        return false;
                                    }
                                } else {
                                    window.handleError(error, '数据存储');
                                    return false;
                                }
                            }
                        },
                        cleanup: () => {
                            try {
                                // 清理超过30天的练习记录
                                const records = JSON.parse(localStorage.getItem('practice_records') || '[]');
                                const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
                                const cleanedRecords = records.filter(record =>
                                    record.startTime && new Date(record.startTime).getTime() > thirtyDaysAgo
                                );

                                if (cleanedRecords.length < records.length) {
                                    localStorage.setItem('practice_records', JSON.stringify(cleanedRecords));
                                    showMessage(`已清理 ${records.length - cleanedRecords.length} 条旧记录`, 'info');
                                }
                            } catch (error) {
                                window.handleError(error, '数据清理');
                            }
                        }
                    };

                // 错误处理器
                window.errorHandler = {
                    handle: (error, context) => {
                        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                            console.error(`[${context}]`, error);
                        }
                        showMessage(`错误: ${error.message}`, 'error');
                    }
                };

                // 工具函数
                window.Utils = {
                    sleep: (ms) => new Promise(resolve => setTimeout(resolve, ms)),
                    throttle: (func, delay) => {
                        let timeoutId;
                        let lastExecTime = 0;
                        return function (...args) {
                            const currentTime = Date.now();
                            if (currentTime - lastExecTime > delay) {
                                func.apply(this, args);
                                lastExecTime = currentTime;
                            } else {
                                clearTimeout(timeoutId);
                                timeoutId = setTimeout(() => {
                                    func.apply(this, args);
                                    lastExecTime = Date.now();
                                }, delay - (currentTime - lastExecTime));
                            }
                        };
                    }
                };

                // 题库数据和状态
                let examIndex = [];
                let currentCategory = 'all';
                let filteredExams = [];
                let app = null; // 主应用实例
                let pdfHandler = null; // PDF处理器实例
                let browseStateManager = null; // 浏览状态管理器实例

                // 练习记录数据（使用统一的键名）
                let practiceRecords = JSON.parse(localStorage.getItem('practice_records') || '[]');
                let practiceStats = {
                    totalPracticed: 0,
                    totalScore: 0,
                    totalTime: 0,
                    streakDays: 0,
                    lastPracticeDate: null
                };

                // PDF处理辅助函数
                function openPDFSafely(pdfPath, examTitle) {
                    if (!pdfHandler) {
                        // 降级处理：直接在新窗口打开PDF
                        const pdfWindow = window.open(pdfPath, `pdf_${Date.now()}`,
                            'width=1000,height=800,scrollbars=yes,resizable=yes,status=yes,toolbar=yes');
                        if (pdfWindow) {
                            showMessage(`正在打开PDF: ${examTitle}`, 'success');
                        } else {
                            showMessage('无法打开PDF文件，请允许弹窗或检查浏览器设置', 'error');
                        }
                        return pdfWindow;
                    }

                    // 使用PDF处理器打开
                    return pdfHandler.openPDF(pdfPath, examTitle);
                }

                // 消息系统 - 改进版
                function showMessage(message, type = 'info', duration = 4000) {
                    const messageContainer = document.getElementById('message-container');
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${type}`;

                    const icon = type === 'error' ? '❌' : type === 'success' ? '✅' : 'ℹ️';
                    messageDiv.innerHTML = `<strong>${icon}</strong> ${message}`;

                    messageContainer.appendChild(messageDiv);

                    // 自动移除消息
                    setTimeout(() => {
                        if (messageDiv.parentNode) {
                            messageDiv.style.animation = 'slideOut 0.3s ease-in forwards';
                            setTimeout(() => {
                                if (messageDiv.parentNode) {
                                    messageDiv.parentNode.removeChild(messageDiv);
                                }
                            }, 300);
                        }
                    }, duration);

                    // 限制消息数量
                    const messages = messageContainer.children;
                    if (messages.length > 3) {
                        messageContainer.removeChild(messages[0]);
                    }
                }

                // 视图切换
                function showView(viewName, resetCategory = true) {
                    document.querySelectorAll('.view').forEach(view => {
                        view.classList.remove('active');
                    });

                    document.getElementById(viewName + '-view').classList.add('active');

                    document.querySelectorAll('.nav-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });

                    const activeBtn = Array.from(document.querySelectorAll('.nav-btn')).find(btn =>
                        btn.textContent.includes(getViewName(viewName))
                    );
                    if (activeBtn) {
                        activeBtn.classList.add('active');
                    }

                    if (viewName === 'browse') {
                        // 只有在resetCategory为true时才重置分类
                        if (resetCategory) {
                            currentCategory = 'all';
                            document.getElementById('browse-title').textContent = '📚 题库浏览';
                        }
                        loadExamList();
                    } else if (viewName === 'practice') {
                        updatePracticeView();
                    }
                }

                function getViewName(viewName) {
                    const names = {
                        'overview': '总览',
                        'browse': '题库浏览',
                        'practice': '练习记录',
                        'settings': '设置'
                    };
                    return names[viewName] || viewName;
                }

                // 优化的题库加载函数
                function loadLibrary() {
                    const startTime = performance.now();
                    
                    // 检查缓存
                    if (window.performanceOptimizer) {
                        const cachedData = window.performanceOptimizer.getCache('exam_index');
                        if (cachedData) {
                            console.log('[System] 使用缓存的题库数据');
                            examIndex = cachedData;
                            updateOverview();
                            updateSystemInfo();
                            showMessage('题库已从缓存加载', 'success');
                            return;
                        }
                    }

                    showMessage('正在加载题库索引...', 'info');

                    try {
                        // 检查题库数据是否可用
                        if (!window.completeExamIndex || !Array.isArray(window.completeExamIndex)) {
                            throw new Error('题库数据未正确加载');
                        }

                        // 使用完整的题库索引
                        examIndex = [...window.completeExamIndex];

                        // 验证数据完整性
                        if (examIndex.length === 0) {
                            throw new Error('题库数据为空');
                        }

                        // 缓存题库数据
                        if (window.performanceOptimizer) {
                            window.performanceOptimizer.setCache('exam_index', examIndex, {
                                ttl: 1800000 // 30分钟缓存
                            });
                        }

                        // 批量处理题库数据以避免阻塞UI
                        if (window.performanceOptimizer && examIndex.length > 100) {
                            window.performanceOptimizer.batchProcess(
                                examIndex,
                                (exam, index) => {
                                    // 预处理题目数据
                                    if (!exam.searchText) {
                                        exam.searchText = `${exam.title} ${exam.category}`.toLowerCase();
                                    }
                                    return exam;
                                },
                                50, // 每批50个
                                10  // 10ms延迟
                            ).then(() => {
                                finishLibraryLoading(startTime);
                            });
                        } else {
                            // 直接处理小数据集
                            examIndex.forEach(exam => {
                                if (!exam.searchText) {
                                    exam.searchText = `${exam.title} ${exam.category}`.toLowerCase();
                                }
                            });
                            finishLibraryLoading(startTime);
                        }

                    } catch (error) {
                        window.handleError(error, '题库加载');

                        // 提供降级方案
                        setTimeout(() => {
                            showMessage('正在尝试备用加载方式...', 'info');
                            loadLibraryFallback();
                        }, 2000);
                    }
                }

                // 完成题库加载
                function finishLibraryLoading(startTime) {
                    const loadTime = performance.now() - startTime;
                    
                    if (window.performanceOptimizer) {
                        window.performanceOptimizer.recordLoadTime(loadTime);
                    }

                    const htmlCount = examIndex.filter(exam => exam.hasHtml).length;
                    const pdfCount = examIndex.filter(exam => !exam.hasHtml).length;
                    
                    // 关键修复：将数据保存到localStorage，以便ExamBrowser组件可以读取
                    try {
                        localStorage.setItem('exam_index', JSON.stringify(examIndex));
                        console.log('[System] 题库数据已保存到localStorage，数量:', examIndex.length);
                        
                        // 同时更新storage对象（如果存在）
                        if (window.storage && typeof window.storage.set === 'function') {
                            window.storage.set('exam_index', examIndex);
                            console.log('[System] 题库数据已保存到storage对象');
                        }
                    } catch (error) {
                        console.error('[System] 保存题库数据失败:', error);
                        window.handleError(error, '数据保存');
                    }
                    
                    showMessage(
                        `题库加载完成！共 ${examIndex.length} 个题目 (${htmlCount} 个HTML, ${pdfCount} 个PDF) - ${Math.round(loadTime)}ms`, 
                        'success'
                    );
                    
                    updateOverview();
                    updateSystemInfo();
                    
                    // 通知ExamBrowser组件数据已更新
                    if (window.app && window.app.components && window.app.components.examBrowser) {
                        console.log('[System] 通知ExamBrowser组件刷新数据');
                        setTimeout(() => {
                            window.app.components.examBrowser.refreshExamList();
                        }, 100);
                    }
                }

                // 题库加载降级方案
                function loadLibraryFallback() {
                    try {
                        // 创建基本的题库结构
                        examIndex = [
                            {
                                id: 'fallback-notice',
                                title: '题库加载异常，请刷新页面重试',
                                category: 'P1',
                                frequency: 'high',
                                path: '',
                                filename: '',
                                hasHtml: false,
                                hasPdf: false
                            }
                        ];

                        showMessage('已启用备用模式，功能可能受限', 'warning');
                        updateOverview();

                    } catch (error) {
                        window.handleError(error, '备用加载');
                        showMessage('系统初始化失败，请刷新页面', 'error');
                    }
                }

                // 重新加载题库
                function reloadLibrary() {
                    showMessage('正在重新加载题库...', 'info');
                    examIndex = [];
                    setTimeout(() => {
                        loadLibrary();
                    }, 500);
                }

                // 加载题库数据（兼容性函数）
                function loadExamData() {
                    loadLibrary();
                }

                // 更新系统统计信息
                function updateSystemInfo() {
                    if (!examIndex || examIndex.length === 0) {
                        return;
                    }

                    const totalExams = examIndex.length;
                    const htmlExams = examIndex.filter(exam => exam.hasHtml).length;
                    const pdfExams = examIndex.filter(exam => exam.hasPdf).length;

                    // 更新显示
                    const totalExamsEl = document.getElementById('total-exams');
                    const htmlExamsEl = document.getElementById('html-exams');
                    const pdfExamsEl = document.getElementById('pdf-exams');
                    const lastUpdateEl = document.getElementById('last-update');

                    if (totalExamsEl) totalExamsEl.textContent = totalExams;
                    if (htmlExamsEl) htmlExamsEl.textContent = htmlExams;
                    if (pdfExamsEl) pdfExamsEl.textContent = pdfExams;
                    if (lastUpdateEl) lastUpdateEl.textContent = new Date().toLocaleString();
                }





                // 随机练习 - 修复功能
                function startRandomPractice(category) {
                    const categoryExams = examIndex.filter(exam => exam.category === category);

                    if (categoryExams.length === 0) {
                        showMessage(`${category} 分类暂无可用题目，请先加载题库`, 'error');
                        return;
                    }

                    const randomExam = categoryExams[Math.floor(Math.random() * categoryExams.length)];
                    showMessage(`随机选择: ${randomExam.title}`, 'info');

                    // 延迟一下再打开，让用户看到选择的题目
                    setTimeout(() => {
                        openExam(randomExam.id);
                    }, 1000);
                }

                // 筛选题目
                function filterExams(filterType) {
                    // 更新按钮状态
                    document.querySelectorAll('.filter-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    event.target.classList.add('active');

                    let filtered = [];

                    switch (filterType) {
                        case 'all':
                            filtered = examIndex;
                            currentCategory = 'all';
                            break;
                        case 'P1':
                        case 'P2':
                        case 'P3':
                            filtered = examIndex.filter(exam => exam.category === filterType);
                            currentCategory = filterType;
                            break;
                        case 'high':
                            filtered = examIndex.filter(exam => exam.frequency === 'high');
                            currentCategory = 'all';
                            break;
                        case 'low':
                            filtered = examIndex.filter(exam => exam.frequency === 'low');
                            currentCategory = 'all';
                            break;
                        default:
                            filtered = examIndex;
                    }

                    filteredExams = filtered;
                    displayExams(filteredExams);

                    // 清空搜索框
                    const searchInput = document.querySelector('.search-input');
                    if (searchInput) {
                        searchInput.value = '';
                    }
                }

                // 优化的搜索题目函数
                function searchExams(query) {
                    // 使用防抖优化搜索性能
                    if (window.performanceOptimizer) {
                        const debouncedSearch = window.performanceOptimizer.debounce(
                            performSearch, 
                            300, 
                            'exam_search'
                        );
                        debouncedSearch(query);
                    } else {
                        performSearch(query);
                    }
                }

                // 执行搜索的核心函数
                function performSearch(query) {
                    const startTime = performance.now();
                    
                    if (!query.trim()) {
                        displayExams(filteredExams);
                        return;
                    }

                    const normalizedQuery = query.toLowerCase().trim();
                    
                    // 检查搜索缓存
                    const cacheKey = `search_${normalizedQuery}_${currentCategory}`;
                    if (window.performanceOptimizer) {
                        const cachedResults = window.performanceOptimizer.getCache(cacheKey);
                        if (cachedResults) {
                            console.log('[Search] 使用缓存的搜索结果');
                            displayExams(cachedResults);
                            return;
                        }
                    }

                    // 执行搜索
                    const searchResults = filteredExams.filter(exam => {
                        // 使用预处理的搜索文本提高性能
                        if (exam.searchText) {
                            return exam.searchText.includes(normalizedQuery);
                        }
                        
                        // 降级到原始搜索方式
                        return exam.title.toLowerCase().includes(normalizedQuery) ||
                               exam.category.toLowerCase().includes(normalizedQuery);
                    });

                    // 缓存搜索结果
                    if (window.performanceOptimizer && searchResults.length > 0) {
                        window.performanceOptimizer.setCache(cacheKey, searchResults, {
                            ttl: 300000 // 5分钟缓存
                        });
                    }

                    const searchTime = performance.now() - startTime;
                    console.log(`[Search] 搜索完成: ${searchResults.length} 个结果 (${Math.round(searchTime)}ms)`);
                    
                    displayExams(searchResults);
                }

                // 浏览分类
                function browseCategory(category) {
                    currentCategory = category;
                    document.getElementById('browse-title').textContent = `📚 ${category} 题库浏览`;
                    showView('browse', false); // 不重置分类
                }

                // 加载题目列表
                function loadExamList() {
                    const container = document.getElementById('exam-list-container');
                    const loadingElement = document.querySelector('#browse-view .loading');

                    // 显示loading状态
                    if (loadingElement) {
                        loadingElement.style.display = 'block';
                    }

                    setTimeout(() => {
                        let examsToShow = examIndex;

                        if (currentCategory !== 'all') {
                            examsToShow = examIndex.filter(exam => exam.category === currentCategory);
                        }

                        // 隐藏loading状态
                        if (loadingElement) {
                            loadingElement.style.display = 'none';
                        }

                        if (examsToShow.length === 0) {
                            container.innerHTML = `
                        <div style="text-align: center; padding: 40px; background: rgba(255, 255, 255, 0.1); border-radius: 10px;">
                            <h3>📝 暂无题目</h3>
                            <p style="margin: 15px 0; opacity: 0.8;">请先扫描题库来加载题目列表</p>
                            <button class="btn" onclick="loadLibrary()">加载题库</button>
                        </div>
                    `;
                            return;
                        }

                        filteredExams = examsToShow;
                        displayExams(filteredExams);
                    }, 500);
                }

                // 优化的题目列表显示函数
                function displayExams(exams) {
                    const startTime = performance.now();
                    const container = document.getElementById('exam-list-container');

                    if (exams.length === 0) {
                        container.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: rgba(255, 255, 255, 0.1); border-radius: 10px;">
                        <h3>🔍 未找到匹配的题目</h3>
                        <p style="opacity: 0.8;">请尝试其他搜索关键词</p>
                    </div>
                `;
                        return;
                    }

                    // 清理之前的虚拟滚动器
                    if (window.currentVirtualScroller) {
                        window.currentVirtualScroller.destroy();
                        window.currentVirtualScroller = null;
                    }

                    // 对于大量数据使用虚拟滚动
                    if (exams.length > 50 && window.performanceOptimizer) {
                        console.log(`[Display] 使用虚拟滚动显示 ${exams.length} 个题目`);
                        setupVirtualScrolling(container, exams);
                    } else {
                        // 对于少量数据使用传统渲染
                        renderExamList(container, exams);
                    }

                    const renderTime = performance.now() - startTime;
                    if (window.performanceOptimizer) {
                        window.performanceOptimizer.recordRenderTime(renderTime);
                    }
                    
                    console.log(`[Display] 渲染完成: ${exams.length} 个题目 (${Math.round(renderTime)}ms)`);
                }

                // 设置虚拟滚动
                function setupVirtualScrolling(container, exams) {
                    // 创建滚动容器
                    container.innerHTML = '<div id="virtual-scroll-container" style="height: 600px; overflow-y: auto;"></div>';
                    const scrollContainer = document.getElementById('virtual-scroll-container');

                    // 创建虚拟滚动器
                    window.currentVirtualScroller = window.performanceOptimizer.createVirtualScroller(
                        scrollContainer,
                        exams,
                        renderExamItem,
                        {
                            itemHeight: 120, // 每个题目项的高度
                            bufferSize: 5   // 缓冲区大小
                        }
                    );
                }

                // 渲染单个题目项
                function renderExamItem(exam, index) {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'exam-item';
                    itemDiv.innerHTML = `
                        <div class="exam-info">
                            <h4>${exam.title}</h4>
                            <div class="exam-meta">
                                ${exam.category} • ${exam.frequency === 'high' ? '高频' : '次高频'} • 
                                ${exam.hasHtml ? '🌐 HTML' : '📄 PDF'}
                                ${exam.note ? ` • ${exam.note}` : ''}
                            </div>
                        </div>
                        <div class="exam-actions">
                            <button class="btn ${exam.hasHtml ? '' : 'btn-secondary'}" 
                                    onclick="openExam('${exam.id}')" 
                                    ${exam.hasHtml ? '' : 'title="PDF文件，将在新标签页中打开"'}>
                                ${exam.hasHtml ? '开始练习' : '查看PDF'}
                            </button>
                            <button class="btn btn-secondary" onclick="viewPDF('${exam.id}')">
                                查看PDF
                            </button>
                            ${!exam.hasHtml ? `<button class="btn btn-info" onclick="generateHTML('${exam.id}')" title="为此PDF考试生成HTML练习版本">生成HTML</button>` : ''}
                        </div>
                    `;
                    return itemDiv;
                }

                // 传统列表渲染（用于少量数据）
                function renderExamList(container, exams) {
                    // 使用批量处理避免阻塞UI
                    if (window.performanceOptimizer && exams.length > 20) {
                        container.innerHTML = '<div class="exam-list" id="exam-list-content"></div>';
                        const listContainer = document.getElementById('exam-list-content');
                        
                        window.performanceOptimizer.batchProcess(
                            exams,
                            (exam, index) => {
                                const itemElement = renderExamItem(exam, index);
                                listContainer.appendChild(itemElement);
                                return itemElement;
                            },
                            10, // 每批10个
                            5   // 5ms延迟
                        );
                    } else {
                        // 直接渲染小数据集
                        container.innerHTML = `
                    <div class="exam-list">
                        ${exams.map(exam => `
                            <div class="exam-item">
                                <div class="exam-info">
                                    <h4>${exam.title}</h4>
                                    <div class="exam-meta">
                                        ${exam.category} • ${exam.frequency === 'high' ? '高频' : '次高频'} • 
                                        ${exam.hasHtml ? '🌐 HTML' : '📄 PDF'}
                                        ${exam.note ? ` • ${exam.note}` : ''}
                                    </div>
                                </div>
                                <div class="exam-actions">
                                    <button class="btn ${exam.hasHtml ? '' : 'btn-secondary'}" 
                                            onclick="openExam('${exam.id}')" 
                                            ${exam.hasHtml ? '' : 'title="PDF文件，将在新标签页中打开"'}>
                                        ${exam.hasHtml ? '开始练习' : '查看PDF'}
                                    </button>
                                    <button class="btn btn-secondary" onclick="viewPDF('${exam.id}')">
                                        查看PDF
                                    </button>
                                    ${!exam.hasHtml ? `<button class="btn btn-info" onclick="generateHTML('${exam.id}')" title="为此PDF考试生成HTML练习版本">生成HTML</button>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                    }
                }



                // 打开题目
                function openExam(examId) {
                    const exam = examIndex.find(e => e.id === examId);
                    if (!exam) {
                        showMessage('题目不存在', 'error');
                        return;
                    }

                    showMessage(`正在打开: ${exam.title}`, 'info');

                    try {
                        // 如果是PDF文件，使用PDF查看功能
                        if (!exam.hasHtml) {
                            console.log('[System] 打开PDF文件:', exam.title);
                            viewPDF(examId);
                            return;
                        }

                        // 如果主应用已初始化，使用主应用的方法
                        if (app && typeof app.openExam === 'function') {
                            console.log('[System] 使用主应用打开题目');
                            app.openExam(examId);
                        } else {
                            // 降级到简单的窗口打开
                            console.log('[System] 使用简化方式打开题目');
                            const fullPath = exam.path + exam.filename;

                            const examWindow = window.open(fullPath, `exam_${exam.id}`,
                                'width=1200,height=800,scrollbars=yes,resizable=yes,status=yes,toolbar=no,menubar=no,location=no'
                            );

                            if (examWindow) {
                                showMessage(`题目已打开: ${exam.title}`, 'success');

                                // 等待页面加载后发送初始化消息
                                setTimeout(() => {
                                    if (examWindow && !examWindow.closed) {
                                        try {
                                            const initData = {
                                                type: 'INIT_SESSION',
                                                data: {
                                                    sessionId: examId + '_' + Date.now(),
                                                    examId: examId,
                                                    examTitle: exam.title,
                                                    examCategory: exam.category,
                                                    parentOrigin: window.location.origin,
                                                    timestamp: Date.now()
                                                }
                                            };
                                            examWindow.postMessage(initData, '*');
                                            console.log('[System] 发送初始化消息到练习页面:', initData);
                                        } catch (error) {
                                            console.warn('[System] 无法发送初始化消息:', error);
                                        }
                                    }
                                }, 2000);

                            } else {
                                showMessage('无法打开新窗口，请检查浏览器弹窗设置', 'error');
                            }
                        }
                    } catch (error) {
                        console.error('[System] 打开题目失败:', error);
                        showMessage('打开题目失败: ' + error.message, 'error');
                    }
                }

                // 检查题目文件
                function checkExamFile(examId) {
                    const exam = examIndex.find(e => e.id === examId);
                    if (!exam) {
                        showMessage('题目不存在', 'error');
                        return;
                    }

                    const fullPath = exam.path + exam.filename;
                    showMessage(`检查文件: ${exam.filename}`, 'info');

                    fetch(fullPath, { method: 'HEAD' })
                        .then(response => {
                            if (response.ok) {
                                showMessage(`✅ 文件存在: ${exam.filename}`, 'success');
                            } else {
                                showMessage(`❌ 文件不存在 (${response.status}): ${exam.filename}`, 'error');
                            }
                        })
                        .catch(error => {
                            showMessage(`❌ 检查失败: ${error.message}`, 'error');
                        });
                }

                // 生成HTML版本
                function generateHTML(examId) {
                    if (window.app && typeof window.app.generateHTMLForPDFExam === 'function') {
                        window.app.generateHTMLForPDFExam(examId);
                    } else {
                        showMessage('HTML生成功能不可用', 'error');
                    }
                }



                // 系统组件状态检查
                function checkSystemStatus() {
                    const components = {
                        'ExamSystemApp': !!window.ExamSystemApp,
                        'PracticeRecorder': !!window.PracticeRecorder,
                        'PDFHandler': !!window.PDFHandler,
                        'App Instance': !!window.app,
                        'Practice Records': practiceRecords.length > 0,
                        'Exam Index': examIndex.length > 0
                    };

                    let statusMessage = '系统组件状态:\n\n';
                    let allGood = true;

                    Object.entries(components).forEach(([name, status]) => {
                        const icon = status ? '✅' : '❌';
                        statusMessage += `${icon} ${name}: ${status ? '正常' : '未加载'}\n`;
                        if (!status && name !== 'Practice Records') allGood = false;
                    });

                    if (window.app && window.app.components) {
                        statusMessage += '\n应用组件:\n';
                        Object.entries(window.app.components).forEach(([name, component]) => {
                            const icon = component ? '✅' : '❌';
                            statusMessage += `${icon} ${name}: ${component ? '已初始化' : '未初始化'}\n`;
                        });
                    }

                    statusMessage += `\n总体状态: ${allGood ? '✅ 系统正常' : '⚠️ 部分组件未加载'}`;

                    alert(statusMessage);
                    console.log('[System] 组件状态检查:', components);
                }

                // 查看PDF文件
                function viewPDF(examId) {
                    const exam = examIndex.find(e => e.id === examId);
                    if (!exam) {
                        showMessage('题目不存在', 'error');
                        return;
                    }

                    // 构造PDF文件路径
                    let pdfPath = exam.path + exam.filename;

                    // 如果文件名不是PDF，尝试查找对应的PDF文件
                    if (!pdfPath.toLowerCase().endsWith('.pdf')) {
                        // 尝试常见的PDF文件名模式
                        const basePath = exam.path;
                        const possiblePdfNames = [
                            exam.filename.replace(/\.html?$/i, '.pdf'),
                            exam.id.replace(/^p\d+-\w+-\d+/, exam.category) + '.pdf',
                            // 根据目录结构推测PDF文件名
                            exam.title.split(' ')[0] + '.pdf'
                        ];

                        // 使用第一个可能的PDF文件名
                        pdfPath = basePath + possiblePdfNames[0];
                    }

                    showMessage(`正在打开PDF: ${exam.title}`, 'info');

                    // 使用PDF处理器打开PDF
                    const pdfWindow = openPDFSafely(pdfPath, exam.title);

                    if (pdfWindow) {
                        // 验证PDF是否成功加载
                        setTimeout(() => {
                            if (pdfHandler && typeof pdfHandler.validatePDF === 'function') {
                                pdfHandler.validatePDF(pdfPath).then(isValid => {
                                    if (!isValid) {
                                        showMessage(`PDF文件可能无法正常显示: ${exam.title}`, 'warning');
                                    }
                                }).catch(error => {
                                    console.warn('[System] PDF验证失败:', error);
                                });
                            }
                        }, 2000);
                    }
                }

                // 加载完整系统
                function loadFullSystem() {
                    if (confirm('确定要尝试加载完整系统吗？\n注意：如果index.html不存在，将显示错误页面。')) {
                        showMessage('正在跳转到完整系统...', 'info');
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 1000);
                    }
                }

                // 清除缓存
                function clearCache() {
                    if (confirm('确定要清除所有缓存数据吗？')) {
                        localStorage.clear();
                        sessionStorage.clear();
                        
                        // 清除性能优化器缓存
                        if (window.performanceOptimizer) {
                            window.performanceOptimizer.cleanup();
                        }
                        
                        showMessage('缓存已清除', 'success');
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    }
                }

                // 显示性能报告
                function showPerformanceReport() {
                    if (!window.performanceOptimizer) {
                        showMessage('性能优化器未初始化', 'warning');
                        return;
                    }

                    const report = window.performanceOptimizer.getPerformanceReport();
                    
                    let reportHtml = `
                        <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px; margin: 20px 0;">
                            <h3>📊 系统性能报告</h3>
                            
                            <div style="margin: 15px 0;">
                                <h4>🗄️ 缓存统计</h4>
                                <p>缓存项数: ${report.cache.itemCount}</p>
                                <p>缓存大小: ${Math.round(report.cache.totalSize / 1024)} KB</p>
                                <p>命中率: ${Math.round(report.cache.hitRate)}%</p>
                            </div>

                            <div style="margin: 15px 0;">
                                <h4>⚡ 性能指标</h4>
                                <p>平均加载时间: ${report.performance.averageLoadTime} ms</p>
                                <p>平均渲染时间: ${report.performance.averageRenderTime} ms</p>
                                <p>加载样本数: ${report.performance.totalLoadSamples}</p>
                                <p>渲染样本数: ${report.performance.totalRenderSamples}</p>
                            </div>
                    `;

                    if (report.memory) {
                        const usagePercent = Math.round((report.memory.used / report.memory.limit) * 100);
                        reportHtml += `
                            <div style="margin: 15px 0;">
                                <h4>💾 内存使用</h4>
                                <p>已使用: ${report.memory.used} MB</p>
                                <p>总计: ${report.memory.total} MB</p>
                                <p>限制: ${report.memory.limit} MB</p>
                                <p>使用率: ${usagePercent}%</p>
                            </div>
                        `;
                    }

                    reportHtml += `
                            <div style="margin-top: 20px;">
                                <button class="btn btn-secondary" onclick="this.parentElement.parentElement.remove()">关闭</button>
                            </div>
                        </div>
                    `;

                    // 显示报告
                    const container = document.getElementById('settings-view');
                    const existingReport = container.querySelector('.performance-report');
                    if (existingReport) {
                        existingReport.remove();
                    }

                    const reportDiv = document.createElement('div');
                    reportDiv.className = 'performance-report';
                    reportDiv.innerHTML = reportHtml;
                    container.appendChild(reportDiv);

                    showMessage('性能报告已生成', 'success');
                }

                // 数据管理功能

                // 创建手动备份
                async function createManualBackup() {
                    if (!window.dataIntegrityManager) {
                        showMessage('数据完整性管理器未初始化', 'error');
                        return;
                    }

                    try {
                        showMessage('正在创建备份...', 'info');
                        const backup = await window.dataIntegrityManager.createBackup(null, 'manual');
                        showMessage(`备份创建成功: ${backup.id}`, 'success');
                    } catch (error) {
                        console.error('[DataManagement] 创建备份失败:', error);
                        showMessage('备份创建失败: ' + error.message, 'error');
                    }
                }

                // 显示备份列表
                function showBackupList() {
                    if (!window.dataIntegrityManager) {
                        showMessage('数据完整性管理器未初始化', 'error');
                        return;
                    }

                    const backups = window.dataIntegrityManager.getBackupList();
                    
                    if (backups.length === 0) {
                        showMessage('暂无备份记录', 'info');
                        return;
                    }

                    let backupHtml = `
                        <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px; margin: 20px 0;">
                            <h3>📋 备份列表</h3>
                            <div style="max-height: 300px; overflow-y: auto; margin: 15px 0;">
                    `;

                    backups.forEach(backup => {
                        const date = new Date(backup.timestamp).toLocaleString();
                        const sizeKB = Math.round(backup.size / 1024);
                        const typeIcon = backup.type === 'auto' ? '🔄' : backup.type === 'manual' ? '👤' : '⚠️';
                        
                        backupHtml += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <div>
                                    <strong>${typeIcon} ${backup.id}</strong><br>
                                    <small>${date} • ${sizeKB} KB • v${backup.version}</small>
                                </div>
                                <button class="btn btn-secondary" onclick="restoreBackup('${backup.id}')" style="margin-left: 10px;">恢复</button>
                            </div>
                        `;
                    });

                    backupHtml += `
                            </div>
                            <button class="btn btn-secondary" onclick="this.parentElement.parentElement.remove()">关闭</button>
                        </div>
                    `;

                    // 显示备份列表
                    const container = document.getElementById('settings-view');
                    const existingList = container.querySelector('.backup-list');
                    if (existingList) {
                        existingList.remove();
                    }

                    const listDiv = document.createElement('div');
                    listDiv.className = 'backup-list';
                    listDiv.innerHTML = backupHtml;
                    container.appendChild(listDiv);
                }

                // 恢复备份
                async function restoreBackup(backupId) {
                    if (!window.dataIntegrityManager) {
                        showMessage('数据完整性管理器未初始化', 'error');
                        return;
                    }

                    if (!confirm(`确定要恢复备份 ${backupId} 吗？当前数据将被覆盖。`)) {
                        return;
                    }

                    try {
                        showMessage('正在恢复备份...', 'info');
                        await window.dataIntegrityManager.restoreBackup(backupId);
                        showMessage('备份恢复成功，页面将刷新', 'success');
                        
                        setTimeout(() => {
                            location.reload();
                        }, 2000);
                    } catch (error) {
                        console.error('[DataManagement] 恢复备份失败:', error);
                        showMessage('备份恢复失败: ' + error.message, 'error');
                    }
                }

                // 导出所有数据
                function exportAllData() {
                    if (!window.dataIntegrityManager) {
                        showMessage('数据完整性管理器未初始化', 'error');
                        return;
                    }

                    try {
                        showMessage('正在导出数据...', 'info');
                        window.dataIntegrityManager.exportData();
                        showMessage('数据导出成功', 'success');
                    } catch (error) {
                        console.error('[DataManagement] 导出数据失败:', error);
                        showMessage('数据导出失败: ' + error.message, 'error');
                    }
                }

                // 导入数据
                function importData() {
                    if (!window.dataIntegrityManager) {
                        showMessage('数据完整性管理器未初始化', 'error');
                        return;
                    }

                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.json';
                    
                    input.onchange = async (event) => {
                        const file = event.target.files[0];
                        if (!file) return;

                        if (!confirm('导入数据将覆盖当前数据，确定继续吗？')) {
                            return;
                        }

                        try {
                            showMessage('正在导入数据...', 'info');
                            const result = await window.dataIntegrityManager.importData(file);
                            showMessage(`数据导入成功: ${result.importedCount} 个项目`, 'success');
                            
                            setTimeout(() => {
                                location.reload();
                            }, 2000);
                        } catch (error) {
                            console.error('[DataManagement] 导入数据失败:', error);
                            showMessage('数据导入失败: ' + error.message, 'error');
                        }
                    };

                    input.click();
                }

                // 验证所有数据
                function validateAllData() {
                    if (!window.dataIntegrityManager) {
                        showMessage('数据完整性管理器未初始化', 'error');
                        return;
                    }

                    try {
                        showMessage('正在检查数据完整性...', 'info');
                        const report = window.dataIntegrityManager.getIntegrityReport();
                        
                        let validationHtml = `
                            <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px; margin: 20px 0;">
                                <h3>🔍 数据完整性报告</h3>
                                <p><strong>检查时间:</strong> ${new Date(report.timestamp).toLocaleString()}</p>
                                <p><strong>数据版本:</strong> ${report.dataVersion}</p>
                                <p><strong>备份数量:</strong> ${report.backups.length}</p>
                                
                                <div style="margin: 15px 0;">
                                    <h4>验证结果:</h4>
                        `;

                        let totalErrors = 0;
                        Object.entries(report.validation).forEach(([key, validation]) => {
                            const status = validation.valid ? '✅' : '❌';
                            const errorCount = validation.errors.length;
                            totalErrors += errorCount;
                            
                            validationHtml += `
                                <div style="margin: 5px 0;">
                                    ${status} <strong>${key}:</strong> ${validation.valid ? '正常' : `${errorCount} 个错误`}
                                </div>
                            `;
                            
                            if (!validation.valid) {
                                validation.errors.forEach(error => {
                                    validationHtml += `<div style="margin-left: 20px; font-size: 0.9em; opacity: 0.8;">• ${error}</div>`;
                                });
                            }
                        });

                        validationHtml += `
                                </div>
                                <div style="margin-top: 20px;">
                                    <strong>总体状态:</strong> ${totalErrors === 0 ? '✅ 数据完整' : `⚠️ 发现 ${totalErrors} 个问题`}
                                </div>
                                <button class="btn btn-secondary" onclick="this.parentElement.parentElement.remove()">关闭</button>
                            </div>
                        `;

                        // 显示报告
                        const container = document.getElementById('settings-view');
                        const existingReport = container.querySelector('.validation-report');
                        if (existingReport) {
                            existingReport.remove();
                        }

                        const reportDiv = document.createElement('div');
                        reportDiv.className = 'validation-report';
                        reportDiv.innerHTML = validationHtml;
                        container.appendChild(reportDiv);

                        const messageType = totalErrors === 0 ? 'success' : 'warning';
                        showMessage(`数据检查完成，${totalErrors === 0 ? '数据完整' : `发现 ${totalErrors} 个问题`}`, messageType);

                    } catch (error) {
                        console.error('[DataManagement] 数据验证失败:', error);
                        showMessage('数据验证失败: ' + error.message, 'error');
                    }
                }



                // 运行完整系统验证
                function runCompleteSystemValidation() {
                    if (typeof window.runSystemValidation !== 'function') {
                        showMessage('系统验证脚本未加载', 'error');
                        return;
                    }

                    showMessage('正在进行完整系统验证...', 'info');
                    
                    try {
                        // 运行验证并显示结果
                        const result = window.runSystemValidation();
                        
                        setTimeout(() => {
                            const messageType = result.successRate >= 80 ? 'success' : 
                                              result.successRate >= 60 ? 'info' : 'error';
                            
                            showMessage(
                                `系统验证完成！通过率: ${result.successRate}% (${result.passed}/${result.total})`,
                                messageType
                            );
                            
                            if (result.successRate >= 80) {
                                setTimeout(() => {
                                    showMessage('🎉 系统功能完整，可以正常使用！', 'success');
                                }, 1000);
                            }
                        }, 2000);
                        
                    } catch (error) {
                        console.error('[SystemValidation] 验证失败:', error);
                        showMessage('系统验证失败: ' + error.message, 'error');
                    }
                }

                // 显示题库索引信息
                function showExamIndexInfo() {
                    console.log('[ExamIndex] 题库总数:', examIndex.length);

                    if (examIndex.length > 0) {
                        console.log('[ExamIndex] 前10个题目:');
                        examIndex.slice(0, 10).forEach((exam, index) => {
                            console.log(`${index + 1}. ID: ${exam.id}, 文件名: ${exam.filename}, 标题: ${exam.title}`);
                        });

                        // 检查是否有重复的文件名
                        const filenames = examIndex.map(exam => exam.filename).filter(f => f);
                        const uniqueFilenames = [...new Set(filenames)];
                        if (filenames.length !== uniqueFilenames.length) {
                            console.warn('[ExamIndex] 发现重复的文件名');
                        }

                        showMessage(`题库信息已输出到控制台，共 ${examIndex.length} 个题目`, 'info');
                    } else {
                        showMessage('题库为空，请先加载题库', 'error');
                    }
                }



                // 修复不完整的标题
                function fixIncompleteTitles() {
                    const records = storage.get('practice_records', []);
                    let fixedCount = 0;

                    records.forEach(record => {
                        if (record.dataSource === 'real' && record.realData) {
                            // 检查是否需要修复标题
                            const needsFix = record.title === 'P1' || record.title === 'P2' || record.title === 'P3' ||
                                record.title === 'Unknown Practice' || record.title.includes('Unknown') ||
                                record.title.length < 5; // 标题太短也需要修复

                            if (needsFix && record.realData.url) {
                                const urlParts = record.realData.url.split('/');
                                let filename = urlParts[urlParts.length - 1];
                                console.log(`[Fix] 原始文件名: ${filename}`);

                                // URL解码
                                try {
                                    filename = decodeURIComponent(filename);
                                    console.log(`[Fix] 解码后文件名: ${filename}`);
                                } catch (e) {
                                    console.log(`[Fix] URL解码失败，使用原始文件名`);
                                }

                                // 首先尝试通过文件名精确匹配
                                let examInfo = examIndex.find(exam => exam.filename === filename);

                                // 如果精确匹配失败，尝试模糊匹配
                                if (!examInfo) {
                                    // 尝试不区分大小写匹配
                                    examInfo = examIndex.find(exam =>
                                        exam.filename && exam.filename.toLowerCase() === filename.toLowerCase()
                                    );
                                }

                                if (!examInfo) {
                                    // 尝试从文件名中提取关键信息进行匹配
                                    const cleanFilename = filename.replace(/\.(html?|php)$/i, '');
                                    console.log(`[Fix] 清理后的文件名: ${cleanFilename}`);

                                    // 提取分类和标题 - 处理格式如 "P2 - A new look for Talbot Park【高】"
                                    const match = cleanFilename.match(/^(P[123])\s*[-–]\s*(.+?)(?:【.+】)?$/);
                                    if (match) {
                                        const [, category, titlePart] = match;
                                        console.log(`[Fix] 提取的分类: ${category}, 标题部分: ${titlePart}`);

                                        // 通过标题关键词匹配
                                        const titleWords = titlePart.toLowerCase().split(/\s+/).filter(word => word.length > 2);
                                        console.log(`[Fix] 标题关键词: ${titleWords.join(', ')}`);

                                        examInfo = examIndex.find(exam => {
                                            const examTitleLower = exam.title.toLowerCase();
                                            const matchCount = titleWords.filter(word => examTitleLower.includes(word)).length;
                                            return matchCount >= Math.min(2, titleWords.length);
                                        });

                                        if (examInfo) {
                                            console.log(`[Fix] 通过关键词匹配找到: ${examInfo.title}`);
                                        }
                                    }
                                }

                                if (examInfo) {
                                    console.log(`[Fix] 修复标题: "${record.title}" -> "${examInfo.title}"`);
                                    record.title = examInfo.title;
                                    record.category = examInfo.category;
                                    record.frequency = examInfo.frequency;
                                    fixedCount++;
                                } else {
                                    console.log(`[Fix] 无法找到匹配的题目: ${filename}`);
                                }
                            }
                        }
                    });

                    if (fixedCount > 0) {
                        storage.set('practice_records', records);
                        practiceRecords = records;
                        showMessage(`已修复 ${fixedCount} 个不完整的标题`, 'success');
                        updatePracticeView();
                    } else {
                        showMessage('没有发现需要修复的标题', 'info');
                    }
                }

                // 记录练习（已废弃，现在使用真实数据传输）
                function recordPractice(exam, startTime) {
                    console.log('[Practice] recordPractice函数已废弃，不再生成模拟数据');
                    console.log('[Practice] 等待真实数据通过跨窗口通信传输');
                    // 不再生成模拟数据，所有数据都通过跨窗口通信获取
                }

                // 计算练习统计（只统计真实数据）
                function calculatePracticeStats() {
                    // 只统计真实数据记录
                    const realDataRecords = practiceRecords.filter(record =>
                        record.dataSource === 'real' && record.realData
                    );

                    if (realDataRecords.length === 0) {
                        practiceStats = {
                            totalPracticed: 0,
                            avgScore: 0,
                            totalTime: 0,
                            streakDays: 0
                        };
                        return;
                    }

                    practiceStats.totalPracticed = realDataRecords.length;

                    // 只计算真实数据的统计
                    let totalScore = 0;
                    let totalTime = 0;

                    realDataRecords.forEach(record => {
                        const score = record.realData.percentage || record.percentage || Math.round((record.realData.accuracy || 0) * 100);
                        const duration = Math.round((record.realData.duration || record.duration || 0) / 60); // 转换为分钟
                        totalScore += score;
                        totalTime += duration;
                    });

                    practiceStats.avgScore = Math.round(totalScore / realDataRecords.length);
                    practiceStats.totalTime = totalTime;

                    // 计算分类统计
                    practiceStats.categoryStats = {
                        P1: { count: 0, avgScore: 0, totalTime: 0 },
                        P2: { count: 0, avgScore: 0, totalTime: 0 },
                        P3: { count: 0, avgScore: 0, totalTime: 0 }
                    };

                    ['P1', 'P2', 'P3'].forEach(category => {
                        const categoryRecords = realDataRecords.filter(record => record.category === category);
                        if (categoryRecords.length > 0) {
                            const categoryTotalScore = categoryRecords.reduce((sum, record) => {
                                const score = record.realData.percentage || record.percentage || Math.round((record.realData.accuracy || 0) * 100);
                                return sum + score;
                            }, 0);
                            const categoryTotalTime = categoryRecords.reduce((sum, record) => {
                                const duration = Math.round((record.realData.duration || record.duration || 0) / 60);
                                return sum + duration;
                            }, 0);

                            practiceStats.categoryStats[category] = {
                                count: categoryRecords.length,
                                avgScore: Math.round(categoryTotalScore / categoryRecords.length),
                                totalTime: categoryTotalTime
                            };
                        }
                    });

                    // 计算连续学习天数
                    const today = new Date();
                    const dates = [...new Set(realDataRecords.map(record => new Date(record.date).toDateString()))];
                    dates.sort((a, b) => new Date(b) - new Date(a));

                    let streak = 0;
                    let currentDate = new Date(today);

                    for (let dateStr of dates) {
                        const recordDate = new Date(dateStr);
                        const diffDays = Math.floor((currentDate - recordDate) / (1000 * 60 * 60 * 24));

                        if (diffDays === streak) {
                            streak++;
                            currentDate = recordDate;
                        } else if (diffDays === streak + 1) {
                            streak++;
                            currentDate = recordDate;
                        } else {
                            break;
                        }
                    }

                    practiceStats.streakDays = streak;
                }

                // 更新练习视图
                function updatePracticeView() {
                    calculatePracticeStats();

                    // 更新统计卡片
                    document.getElementById('total-practiced').textContent = practiceStats.totalPracticed;
                    document.getElementById('avg-score').textContent = practiceStats.avgScore + '%';
                    document.getElementById('study-time').textContent = practiceStats.totalTime;
                    document.getElementById('streak-days').textContent = practiceStats.streakDays;

                    // 更新练习历史
                    const historyContainer = document.getElementById('practice-history-list');

                    if (practiceRecords.length === 0) {
                        historyContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; opacity: 0.7;">
                        <div style="font-size: 3em; margin-bottom: 15px;">📋</div>
                        <p>暂无练习记录</p>
                        <p style="font-size: 0.9em; margin-top: 10px;">开始练习后，记录将自动保存在这里</p>
                    </div>
                `;
                        return;
                    }

                    // 只显示真实数据记录
                    const realDataRecords = practiceRecords.filter(record =>
                        record.dataSource === 'real' && record.realData
                    );

                    if (realDataRecords.length === 0) {
                        historyContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; opacity: 0.7;">
                        <div style="font-size: 3em; margin-bottom: 15px;">📋</div>
                        <p>暂无练习记录</p>
                        <p style="font-size: 0.9em; margin-top: 10px;">完成练习后，数据将自动保存在这里</p>
                    </div>
                `;
                        return;
                    }

                    historyContainer.innerHTML = realDataRecords.slice(0, 20).map(record => {
                        const date = new Date(record.date);

                        // 处理数据格式
                        const score = record.realData.score || record.score || 0;
                        const totalQuestions = record.realData.totalQuestions || record.totalQuestions || 0;
                        const duration = Math.round((record.realData.duration || record.duration || 0) / 60); // 转换为分钟
                        const accuracy = record.realData.percentage || record.percentage || Math.round((record.realData.accuracy || 0) * 100);

                        const scoreColor = accuracy >= 80 ? '#4ade80' : accuracy >= 60 ? '#fbbf24' : '#ff6b6b';

                        // 详细信息提示
                        let detailsTooltip = '';
                        if (record.realData) {
                            const details = [];
                            if (score !== undefined && totalQuestions !== undefined) {
                                details.push(`得分: ${score}/${totalQuestions}`);
                            }
                            if (record.realData.source) {
                                const sourceText = record.realData.source === 'page_extraction' ? '页面提取' :
                                    record.realData.source === 'calculation' ? '自动计算' :
                                        record.realData.source === 'manual_input' ? '手动输入' : record.realData.source;
                                details.push(`来源: ${sourceText}`);
                            }
                            detailsTooltip = details.length > 0 ? `title="${details.join(' | ')}"` : '';
                        }

                        const isSelected = selectedRecords.has(record.id);
                        const selectionStyle = bulkDeleteMode ?
                            (isSelected ? 'background: rgba(255, 0, 0, 0.1); border: 2px solid #ff6b6b;' : 'border: 2px solid transparent;') : '';
                        const clickHandler = bulkDeleteMode ? `toggleRecordSelection('${record.id}')` : '';

                        return `
                    <div class="history-item" ${detailsTooltip} 
                         data-record-id="${record.id}"
                         style="cursor: ${bulkDeleteMode ? 'pointer' : 'help'}; position: relative; ${selectionStyle}"
                         ${bulkDeleteMode ? `onclick="${clickHandler}"` : ''}>
                        <div>
                            <strong>${record.title}</strong><br>
                            <small>${record.category} • ${date.toLocaleDateString()} ${date.toLocaleTimeString()}</small>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: ${scoreColor}; font-weight: bold;">${accuracy}%</div>
                            <small>${duration}分钟</small>
                        </div>
                        ${bulkDeleteMode ?
                                `<div style="position: absolute; top: 10px; right: 10px; font-size: 18px;">
                                ${isSelected ? '✅' : '⭕'}
                            </div>` :
                                `<button class="delete-record-btn" onclick="deleteRecord('${record.id}')" title="删除此记录">
                                ❌
                            </button>`
                            }
                    </div>
                `;
                    }).join('');
                }

                // 导出练习数据
                function exportPracticeData() {
                    if (practiceRecords.length === 0) {
                        showMessage('暂无练习数据可导出', 'info');
                        return;
                    }

                    const data = {
                        exportDate: new Date().toISOString(),
                        stats: practiceStats,
                        records: practiceRecords
                    };

                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `practice-records-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    showMessage('练习数据已导出', 'success');
                }

                // 清除练习数据
                function clearPracticeData() {
                    if (confirm('确定要清除所有练习记录吗？此操作不可恢复。')) {
                        practiceRecords = [];
                        localStorage.removeItem('practice_records');
                        processedSessions.clear(); // 清除已处理会话记录
                        updatePracticeView();
                        showMessage('练习记录已清除', 'success');
                    }
                }

                // 删除单个练习记录
                function deleteRecord(recordId) {
                    if (!recordId) {
                        showMessage('记录ID无效', 'error');
                        return;
                    }

                    const records = storage.get('practice_records', []);
                    const recordIndex = records.findIndex(record => record.id === recordId);

                    if (recordIndex === -1) {
                        showMessage('未找到指定记录', 'error');
                        return;
                    }

                    const record = records[recordIndex];
                    const confirmMessage = `确定要删除这条练习记录吗？\n\n题目: ${record.title}\n时间: ${new Date(record.date).toLocaleString()}\n\n此操作不可恢复。`;

                    if (confirm(confirmMessage)) {
                        // 添加删除动画
                        const historyItem = document.querySelector(`[onclick="deleteRecord('${recordId}')"]`).closest('.history-item');
                        if (historyItem) {
                            historyItem.classList.add('deleting');

                            // 延迟执行删除以显示动画
                            setTimeout(() => {
                                historyItem.classList.add('deleted');

                                setTimeout(() => {
                                    // 删除记录
                                    records.splice(recordIndex, 1);

                                    // 保存更新后的记录
                                    storage.set('practice_records', records);
                                    practiceRecords = records;

                                    // 重新计算统计数据
                                    calculatePracticeStats();

                                    // 更新显示
                                    updatePracticeView();

                                    showMessage('记录已删除', 'success');

                                    console.log(`[System] 已删除练习记录: ${recordId}`);
                                }, 500);
                            }, 200);
                        } else {
                            // 如果找不到DOM元素，直接删除
                            records.splice(recordIndex, 1);
                            storage.set('practice_records', records);
                            practiceRecords = records;
                            calculatePracticeStats();
                            updatePracticeView();
                            showMessage('记录已删除', 'success');
                        }
                    }
                }

                // 批量删除管理
                let bulkDeleteMode = false;
                let selectedRecords = new Set();

                function toggleBulkDelete() {
                    bulkDeleteMode = !bulkDeleteMode;
                    const btn = document.getElementById('bulk-delete-btn');

                    if (bulkDeleteMode) {
                        btn.textContent = '✅ 完成选择';
                        btn.classList.remove('btn-info');
                        btn.classList.add('btn-success');
                        selectedRecords.clear();
                        showMessage('批量管理模式已开启，点击记录进行选择', 'info');
                    } else {
                        btn.textContent = '📝 批量管理';
                        btn.classList.remove('btn-success');
                        btn.classList.add('btn-info');

                        if (selectedRecords.size > 0) {
                            const confirmMessage = `确定要删除选中的 ${selectedRecords.size} 条记录吗？此操作不可恢复。`;
                            if (confirm(confirmMessage)) {
                                bulkDeleteRecords();
                            }
                        }
                        selectedRecords.clear();
                    }

                    updatePracticeView();
                }

                function bulkDeleteRecords() {
                    const records = storage.get('practice_records', []);
                    const recordsToKeep = records.filter(record => !selectedRecords.has(record.id));

                    const deletedCount = records.length - recordsToKeep.length;

                    storage.set('practice_records', recordsToKeep);
                    practiceRecords = recordsToKeep;

                    calculatePracticeStats();
                    updatePracticeView();

                    showMessage(`已删除 ${deletedCount} 条记录`, 'success');
                    console.log(`[System] 批量删除了 ${deletedCount} 条练习记录`);
                }

                function toggleRecordSelection(recordId) {
                    if (!bulkDeleteMode) return;

                    if (selectedRecords.has(recordId)) {
                        selectedRecords.delete(recordId);
                    } else {
                        selectedRecords.add(recordId);
                    }

                    // 更新视觉反馈
                    const historyItem = document.querySelector(`[data-record-id="${recordId}"]`);
                    if (historyItem) {
                        if (selectedRecords.has(recordId)) {
                            historyItem.style.background = 'rgba(255, 0, 0, 0.1)';
                            historyItem.style.border = '2px solid #ff6b6b';
                        } else {
                            historyItem.style.background = '';
                            historyItem.style.border = '';
                        }
                    }
                }

                // 清理重复和无效记录
                function cleanupPracticeData() {
                    const records = storage.get('practice_records', []);
                    const cleanedRecords = [];
                    const seenKeys = new Set();
                    let fixedTitles = 0;

                    // 只保留真实数据记录，并去重，同时修复题目标题
                    records.forEach(record => {
                        if (record.dataSource === 'real' && record.realData) {
                            const key = record.examId + '_' + record.endTime;
                            if (!seenKeys.has(key)) {
                                seenKeys.add(key);

                                // 尝试修复题目标题
                                if (record.title === 'Unknown Practice' || record.title.includes('Unknown')) {
                                    const examInfo = findExamInfo(record);
                                    if (examInfo) {
                                        record.title = examInfo.title;
                                        record.category = examInfo.category;
                                        record.frequency = examInfo.frequency;
                                        fixedTitles++;
                                        console.log('[Cleanup] 修复题目标题:', record.title);
                                    }
                                }

                                cleanedRecords.push(record);
                            }
                        }
                    });

                    const removedCount = records.length - cleanedRecords.length;
                    let message = '';

                    if (removedCount > 0 || fixedTitles > 0) {
                        storage.set('practice_records', cleanedRecords);
                        practiceRecords = cleanedRecords;

                        if (removedCount > 0 && fixedTitles > 0) {
                            message = `已清理 ${removedCount} 条重复记录，修复 ${fixedTitles} 个题目标题`;
                        } else if (removedCount > 0) {
                            message = `已清理 ${removedCount} 条重复或无效记录`;
                        } else {
                            message = `已修复 ${fixedTitles} 个题目标题`;
                        }

                        showMessage(message, 'success');
                        updatePracticeView();
                    } else {
                        showMessage('没有发现需要清理的记录', 'info');
                    }
                }

                // 查找题目信息的辅助函数
                function findExamInfo(record) {
                    if (!record.realData) return null;

                    // 尝试通过examId匹配
                    let examInfo = examIndex.find(exam => exam.id === record.examId);

                    // 尝试通过URL匹配
                    if (!examInfo && record.realData.url) {
                        const urlParts = record.realData.url.split('/');
                        const filename = urlParts[urlParts.length - 1];
                        console.log('[FindExam] 尝试匹配文件名:', filename);
                        examInfo = examIndex.find(exam => exam.filename === filename);
                        if (examInfo) {
                            console.log('[FindExam] 通过文件名找到:', examInfo.title);
                        }
                    }

                    // 尝试通过标题关键词匹配
                    if (!examInfo && record.title && record.title !== 'Unknown Practice') {
                        // 提取英文标题部分进行匹配
                        const titleParts = record.title.split(' ');
                        for (let i = 1; i < titleParts.length; i++) {
                            const searchTerm = titleParts.slice(i).join(' ');
                            examInfo = examIndex.find(exam =>
                                exam.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                searchTerm.toLowerCase().includes(exam.title.toLowerCase())
                            );
                            if (examInfo) {
                                console.log('[FindExam] 通过标题匹配找到:', examInfo.title);
                                break;
                            }
                        }
                    }

                    return examInfo;
                }

                // 更新系统信息
                function updateSystemInfo() {
                    const htmlCount = examIndex.filter(exam => exam.hasHtml).length;
                    const pdfCount = examIndex.filter(exam => !exam.hasHtml).length;

                    document.getElementById('total-exams').textContent = examIndex.length;
                    document.getElementById('html-exams').textContent = htmlCount;
                    document.getElementById('pdf-exams').textContent = pdfCount;
                    document.getElementById('last-update').textContent = new Date().toLocaleString();
                }

                // 更新总览页面
                function updateOverview() {
                    const categoryStats = {
                        'P1': { total: 0, html: 0, pdf: 0 },
                        'P2': { total: 0, html: 0, pdf: 0 },
                        'P3': { total: 0, html: 0, pdf: 0 }
                    };

                    examIndex.forEach(exam => {
                        if (categoryStats[exam.category]) {
                            categoryStats[exam.category].total++;
                            if (exam.hasHtml) {
                                categoryStats[exam.category].html++;
                            } else {
                                categoryStats[exam.category].pdf++;
                            }
                        }
                    });

                    const categoryContainer = document.getElementById('category-overview');
                    categoryContainer.innerHTML = `
                <div class="category-card">
                    <div class="category-header">
                        <div class="category-icon">📖</div>
                        <div>
                            <div class="category-title">P1 基础阅读</div>
                            <div class="category-meta">${categoryStats.P1.total} 篇文章 (${categoryStats.P1.html} HTML, ${categoryStats.P1.pdf} PDF)</div>
                        </div>
                    </div>
                    <div class="category-actions">
                        <button class="btn" onclick="browseCategory('P1')">📚 浏览题目</button>
                        <button class="btn btn-secondary" onclick="startRandomPractice('P1')">🎲 随机练习</button>
                    </div>
                </div>
                
                <div class="category-card">
                    <div class="category-header">
                        <div class="category-icon">📚</div>
                        <div>
                            <div class="category-title">P2 中级阅读</div>
                            <div class="category-meta">${categoryStats.P2.total} 篇文章 (${categoryStats.P2.html} HTML, ${categoryStats.P2.pdf} PDF)</div>
                        </div>
                    </div>
                    <div class="category-actions">
                        <button class="btn" onclick="browseCategory('P2')">📚 浏览题目</button>
                        <button class="btn btn-secondary" onclick="startRandomPractice('P2')">🎲 随机练习</button>
                    </div>
                </div>
                
                <div class="category-card">
                    <div class="category-header">
                        <div class="category-icon">📑</div>
                        <div>
                            <div class="category-title">P3 高级阅读</div>
                            <div class="category-meta">${categoryStats.P3.total} 篇文章 (${categoryStats.P3.html} HTML, ${categoryStats.P3.pdf} PDF)</div>
                        </div>
                    </div>
                    <div class="category-actions">
                        <button class="btn" onclick="browseCategory('P3')">📚 浏览题目</button>
                        <button class="btn btn-secondary" onclick="startRandomPractice('P3')">🎲 随机练习</button>
                    </div>
                </div>
                `;
                }

                // 添加CSS动画
                const style = document.createElement('style');
                style.textContent = `
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100 %);
                    opacity: 0;
                }
            }
            `;
                document.head.appendChild(style);

                // 设置全局消息监听器（无论应用是否初始化都要设置）
                function setupMessageListener() {
                    window.addEventListener('message', (event) => {
                        console.log('[System] 收到消息:', event.data);

                        if (event.data && event.data.source === 'practice_page') {
                            console.log('[System] 收到练习页面消息:', event.data);

                            switch (event.data.type) {
                                case 'SESSION_READY':
                                    console.log('[System] 练习会话已准备');
                                    showMessage('练习页面已连接', 'success');
                                    break;
                                case 'PROGRESS_UPDATE':
                                    console.log('[System] 练习进度更新:', event.data.data);
                                    break;
                                case 'PRACTICE_COMPLETE':
                                    console.log('[System] 练习完成，处理数据');
                                    console.log('[System] 完整练习数据:', JSON.stringify(event.data.data, null, 2));
                                    handlePracticeDataReceived(event.data.data);
                                    break;
                                case 'ERROR_OCCURRED':
                                    console.error('[System] 练习页面错误:', event.data.data);
                                    showMessage('练习页面发生错误', 'error');
                                    break;
                                default:
                                    console.log('[System] 未知消息类型:', event.data.type);
                            }
                        }
                    });
                    console.log('[System] 消息监听器已设置');
                }

                // 初始化主应用
                function initializeApp() {
                    try {
                        if (window.ExamSystemApp) {
                            app = new ExamSystemApp();
                            app.initialize();
                            console.log('[System] 主应用已初始化');
                        } else {
                            console.warn('[System] ExamSystemApp类未加载，使用简化模式');
                        }

                        // 初始化通信恢复机制
                        if (window.CommunicationRecovery) {
                            window.communicationManager = new CommunicationRecovery();
                            console.log('[System] 通信恢复机制已初始化');
                        } else {
                            console.warn('[System] CommunicationRecovery类未加载');
                        }

                        // 初始化性能优化器
                        if (window.PerformanceOptimizer) {
                            window.performanceOptimizer = new PerformanceOptimizer();
                            console.log('[System] 性能优化器已初始化');
                        } else {
                            console.warn('[System] PerformanceOptimizer类未加载');
                        }

                        // 初始化数据完整性管理器
                        if (window.DataIntegrityManager) {
                            window.dataIntegrityManager = new DataIntegrityManager();
                            
                            // 检查数据兼容性
                            const compatibility = window.dataIntegrityManager.checkDataCompatibility();
                            if (compatibility.migrated) {
                                showMessage('数据已升级到新版本', 'info');
                            } else if (!compatibility.compatible) {
                                showMessage('数据兼容性检查失败: ' + compatibility.error, 'warning');
                            }
                            
                            console.log('[System] 数据完整性管理器已初始化');
                        } else {
                            console.warn('[System] DataIntegrityManager类未加载');
                        }

                        return true;
                    } catch (error) {
                        console.error('[System] 应用初始化失败:', error);
                        window.handleError(error, '应用初始化', {
                            userMessage: '系统初始化失败，部分功能可能不可用'
                        });
                        return false;
                    }
                }

                // 用于防止重复处理的会话ID集合
                const processedSessions = new Set();

                // 处理接收到的练习数据
                function handlePracticeDataReceived(practiceData) {
                    console.log('[System] 处理练习数据:', practiceData);

                    // 更强的重复检测机制
                    const sessionKey = practiceData.sessionId + '_' + practiceData.endTime;
                    const examKey = (practiceData.examId || practiceData.sessionId) + '_' + practiceData.endTime;

                    if (processedSessions.has(sessionKey) || processedSessions.has(examKey)) {
                        console.log('[System] 数据已处理过，跳过重复处理:', sessionKey);
                        return;
                    }
                    processedSessions.add(sessionKey);
                    processedSessions.add(examKey);

                    // 检查是否已存在相同的记录
                    const existingRecords = storage.get('practice_records', []);
                    const isDuplicate = existingRecords.some(record =>
                        record.examId === (practiceData.examId || practiceData.sessionId) &&
                        Math.abs(new Date(record.endTime).getTime() - new Date(practiceData.endTime).getTime()) < 5000 // 5秒内的记录视为重复
                    );

                    if (isDuplicate) {
                        console.log('[System] 检测到重复记录，跳过保存');
                        return;
                    }

                    try {
                        // 尝试从examId获取题目信息
                        const examId = practiceData.examId || practiceData.sessionId;
                        console.log('[System] 查找题目信息 - examId:', examId);
                        console.log('[System] 可用题目索引数量:', examIndex.length);

                        // 智能题目信息提取
                        let finalTitle = 'Unknown Practice';
                        let finalCategory = 'Unknown';
                        let finalFrequency = 'unknown';

                        console.log('[System] 开始题目信息提取');
                        console.log('[System] 练习数据URL:', practiceData.url);
                        console.log('[System] 题库索引数量:', examIndex.length);

                        // 方法1: 通过examId直接匹配
                        let examInfo = examIndex.find(exam => exam.id === examId);
                        if (examInfo) {
                            finalTitle = examInfo.title;
                            finalCategory = examInfo.category;
                            finalFrequency = examInfo.frequency;
                            console.log('[System] 通过examId匹配成功:', examInfo.title);
                        }

                        // 方法2: 如果方法1失败，通过URL文件名匹配
                        if (finalTitle === 'Unknown Practice' && practiceData.url) {
                            const urlParts = practiceData.url.split('/');
                            let filename = urlParts[urlParts.length - 1];
                            console.log('[System] 原始文件名:', filename);

                            // URL解码
                            try {
                                filename = decodeURIComponent(filename);
                                console.log('[System] 解码后文件名:', filename);
                            } catch (e) {
                                console.log('[System] URL解码失败，使用原始文件名');
                            }

                            // 显示前几个题库项目用于调试
                            if (examIndex.length > 0) {
                                console.log('[System] 题库示例:', examIndex.slice(0, 3).map(e => ({ id: e.id, filename: e.filename, title: e.title })));
                            }

                            // 尝试精确匹配
                            let matchedExam = examIndex.find(exam => exam.filename === filename);

                            if (!matchedExam) {
                                // 尝试不区分大小写的匹配
                                matchedExam = examIndex.find(exam =>
                                    exam.filename && exam.filename.toLowerCase() === filename.toLowerCase()
                                );
                            }

                            if (!matchedExam) {
                                // 尝试从文件名中提取关键信息进行匹配
                                // 例如: "P2 - A new look for Talbot Park【高】.html"
                                const cleanFilename = filename.replace(/\.(html?|php)$/i, ''); // 移除扩展名
                                console.log('[System] 清理后的文件名:', cleanFilename);

                                // 提取分类和标题
                                const match = cleanFilename.match(/^(P[123])\s*[-–]\s*(.+?)(?:【.+】)?$/);
                                if (match) {
                                    const [, category, titlePart] = match;
                                    console.log('[System] 提取的分类:', category, '标题部分:', titlePart);

                                    // 通过标题关键词匹配
                                    const titleWords = titlePart.toLowerCase().split(/\s+/).filter(word => word.length > 2);
                                    console.log('[System] 标题关键词:', titleWords);

                                    matchedExam = examIndex.find(exam => {
                                        const examTitleLower = exam.title.toLowerCase();
                                        const matchCount = titleWords.filter(word => examTitleLower.includes(word)).length;
                                        return matchCount >= Math.min(2, titleWords.length); // 至少匹配2个关键词或所有关键词
                                    });

                                    if (matchedExam) {
                                        console.log('[System] 通过关键词匹配成功:', matchedExam.title);
                                    }
                                }
                            }

                            if (matchedExam) {
                                finalTitle = matchedExam.title;
                                finalCategory = matchedExam.category;
                                finalFrequency = matchedExam.frequency;
                                console.log('[System] 文件名匹配成功:', matchedExam.title);
                            } else {
                                console.log('[System] 所有文件名匹配方法都失败');
                            }
                        }

                        // 方法3: 如果还是失败，尝试从URL路径提取信息
                        if (finalTitle === 'Unknown Practice' && practiceData.url) {
                            const pathParts = practiceData.url.split('/').filter(part => part.length > 0);
                            console.log('[System] URL路径部分:', pathParts);

                            let categoryFromPath = '';
                            let titleFromPath = '';

                            for (let part of pathParts) {
                                if (part.match(/^P[123]$/i)) {
                                    categoryFromPath = part.toUpperCase();
                                } else if (part.includes('.html') || part.includes('.htm')) {
                                    titleFromPath = part.replace(/\.(html?|php)$/i, '').replace(/[-_]/g, ' ');
                                }
                            }

                            console.log('[System] 从路径提取 - 分类:', categoryFromPath, '标题:', titleFromPath);

                            if (titleFromPath) {
                                // 尝试通过标题关键词匹配
                                const titleWords = titleFromPath.toLowerCase().split(' ').filter(word => word.length > 2);
                                console.log('[System] 标题关键词:', titleWords);

                                const possibleMatch = examIndex.find(exam => {
                                    const examTitleLower = exam.title.toLowerCase();
                                    return titleWords.some(word => examTitleLower.includes(word));
                                });

                                if (possibleMatch) {
                                    finalTitle = possibleMatch.title;
                                    finalCategory = possibleMatch.category;
                                    finalFrequency = possibleMatch.frequency;
                                    console.log('[System] 通过关键词匹配成功:', possibleMatch.title);
                                } else if (categoryFromPath) {
                                    // 如果关键词匹配也失败，至少使用路径信息
                                    finalTitle = `${categoryFromPath} ${titleFromPath}`;
                                    finalCategory = categoryFromPath;
                                    console.log('[System] 使用路径构建标题:', finalTitle);
                                }
                            }
                        }

                        // 方法4: 最后尝试页面标题匹配
                        if (finalTitle === 'Unknown Practice' && practiceData.pageTitle) {
                            console.log('[System] 尝试页面标题匹配:', practiceData.pageTitle);
                            const titleMatch = examIndex.find(exam =>
                                exam.title.toLowerCase().includes(practiceData.pageTitle.toLowerCase()) ||
                                practiceData.pageTitle.toLowerCase().includes(exam.title.toLowerCase())
                            );

                            if (titleMatch) {
                                finalTitle = titleMatch.title;
                                finalCategory = titleMatch.category;
                                finalFrequency = titleMatch.frequency;
                                console.log('[System] 通过页面标题匹配成功:', titleMatch.title);
                            }
                        }

                        console.log('[System] 最终标题:', finalTitle);
                        console.log('[System] 最终分类:', finalCategory);

                        // 创建练习记录
                        const record = {
                            id: 'real_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                            examId: examId,
                            title: finalTitle,
                            category: finalCategory,
                            frequency: finalFrequency,

                            // 真实数据标识
                            dataSource: 'real',
                            isRealData: true,

                            // 基本信息
                            startTime: new Date(practiceData.startTime).toISOString(),
                            endTime: new Date(practiceData.endTime).toISOString(),
                            date: new Date().toISOString(),

                            // 成绩数据
                            score: practiceData.scoreInfo?.correct || 0,
                            totalQuestions: practiceData.scoreInfo?.total || Object.keys(practiceData.answers || {}).length,
                            accuracy: practiceData.scoreInfo?.accuracy || 0,
                            percentage: practiceData.scoreInfo?.percentage || 0,
                            duration: Math.round(practiceData.duration || 0), // 秒

                            // 详细数据
                            realData: {
                                sessionId: practiceData.sessionId,
                                answers: practiceData.answers || {},
                                interactions: practiceData.interactions || [],
                                scoreInfo: practiceData.scoreInfo || {},
                                pageType: practiceData.pageType,
                                url: practiceData.url,
                                source: practiceData.scoreInfo?.source || 'page_extraction'
                            }
                        };

                        // 保存到localStorage
                        const records = storage.get('practice_records', []);
                        records.unshift(record);

                        // 限制记录数量
                        if (records.length > 1000) {
                            records.splice(1000);
                        }

                        storage.set('practice_records', records);

                        // 更新全局变量
                        practiceRecords = records;

                        console.log('[System] 练习记录已保存:', record.id);
                        showMessage('练习数据已保存！', 'success');

                        // 如果当前在练习记录页面，刷新显示
                        const currentView = document.querySelector('.view.active');
                        if (currentView && currentView.id === 'practice-view') {
                            updatePracticeView();
                        }

                    } catch (error) {
                        console.error('[System] 保存练习数据失败:', error);
                        showMessage('保存练习数据失败', 'error');
                    }
                }

                // 初始化
                document.addEventListener('DOMContentLoaded', () => {
                    showMessage('欢迎使用考试总览系统！', 'success');

                    // 立即设置消息监听器（这是最重要的）
                    setupMessageListener();

                    // 自动清理一次重复记录
                    setTimeout(() => {
                        const records = storage.get('practice_records', []);
                        if (records.length > 0) {
                            cleanupPracticeData();
                        }
                    }, 1000);

                    // 初始化应用
                    setTimeout(() => {
                        const appInitialized = initializeApp();
                        if (appInitialized) {
                            console.log('[System] 系统初始化完成');
                        } else {
                            console.warn('[System] 系统初始化部分失败，使用简化模式');
                        }

                        // 初始化PDF处理器
                        if (window.PDFHandler) {
                            pdfHandler = new PDFHandler();
                            console.log('[System] PDF处理器已初始化');
                        } else {
                            console.warn('[System] PDFHandler类未加载');
                        }

                        // 初始化浏览状态管理器
                        if (window.BrowseStateManager) {
                            browseStateManager = new BrowseStateManager();
                            console.log('[System] 浏览状态管理器已初始化');
                        } else {
                            console.warn('[System] BrowseStateManager类未加载');
                        }

                        // 自动加载题库
                        loadLibrary();
                    }, 500);
                });

                // 键盘快捷键
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch (e.key) {
                            case '1':
                                e.preventDefault();
                                showView('overview');
                                break;
                            case '2':
                                e.preventDefault();
                                showView('browse');
                                break;
                            case '3':
                                e.preventDefault();
                                showView('practice');
                                break;
                            case '4':
                                e.preventDefault();
                                showView('settings');
                                break;
                        }
                    }
                });
    </script>

    <!-- 加载主应用 -->
    <script src="js/app.js"></script>
</body>

</html>