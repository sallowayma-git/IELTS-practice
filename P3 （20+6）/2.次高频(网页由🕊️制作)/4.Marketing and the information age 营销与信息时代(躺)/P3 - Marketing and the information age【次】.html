<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>P3 - Marketing and The Information Age</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<style>
  :root { --line:#e5e7eb; --bg:#f6f7fb; --panel:#fff; --accent:#3b82f6; --muted:#6b7280; --shadow:0 6px 20px rgba(0,0,0,.12); }
  * { box-sizing: border-box; }
  html,body { height:100%; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); }
  #timer { position: static; display: inline-block; margin-left: 8px; background:#fff; border:1px solid var(--line); border-radius:10px; padding:2px 8px; font-size:14px; vertical-align: middle; }
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:var(--panel); overflow:auto; padding:20px; }
  #left { flex: 0 0 50%; min-width: 280px; }
  #right { flex: 1 1 auto; min-width: 320px; background:#fbfbff; border-left:1px solid var(--line); }
  #divider { flex: 0 0 8px; background: linear-gradient(90deg,#e5e7eb,#d1d5db); cursor: ew-resize; position:relative; z-index: 5; user-select:none; }
  h2,h3,h4 { margin:0 0 10px; }
  #left p { margin: 0 0 12px; line-height: 1.6; word-break: normal; overflow-wrap: normal; hyphens: none; }
  .group { background:#fff; border:1px solid var(--line); border-radius:10px; padding:12px; margin-bottom:14px; }
  table { border-collapse: collapse; width:100%; }
  th, td { border:1px solid var(--line); padding:6px; text-align:center; font-size:14px; }
  th:first-child, td:first-child { width: auto; text-align: left; padding-left: 8px; }
  button { padding:8px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; cursor:pointer; }
  button.primary { background:var(--accent); color:#fff; border-color:#3b82f6; }
  #results { background:#fff; border:1px solid var(--line); border-radius:10px; padding:10px; }
  .hl { background:#fff3a3; box-shadow: inset 0 -2px 0 rgba(0,0,0,.05); cursor: pointer; }
  .hl:hover { filter: brightness(0.98); }
  #selbar { position: absolute; display:none; z-index: 2000; background:#111; color:#fff; border-radius: 8px; padding: 6px; box-shadow: var(--shadow); font-size: 13px; gap:6px; align-items: center; }
  #selbar button { background: transparent; color:#fff; border: 1px solid rgba(255,255,255,.25); padding: 4px 8px; border-radius: 6px; cursor:pointer; }
  #selbar button:hover { border-color:#fff; }
  #notes { position: fixed; right: 12px; bottom: 12px; width: 320px; height: 42vh; background:#fff; border:1px solid var(--line); border-radius: 12px; display:none; flex-direction: column; z-index:1500; box-shadow: var(--shadow); }
  #notes header { display:flex; align-items:center; justify-content: space-between; padding:8px 10px; border-bottom:1px solid var(--line); }
  #notes textarea { flex:1; border:0; padding:10px; resize:none; font-size:14px; line-height:1.5; }
  #toast { position: fixed; left:50%; transform: translateX(-50%); bottom: 24px; background:#111; color:#fff; padding:8px 12px; border-radius: 8px; display:none; z-index:2500; }
  .badge { display:inline-block; background:#eef2ff; color:#4338ca; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:6px; }
  body { padding-bottom: 82px; }
  .practice-nav { background:#fff; border-bottom:2px solid var(--line); padding:12px 20px; display:flex; align-items:center; gap:20px; box-shadow:0 2px 4px rgba(0,0,0,.05); flex-wrap:wrap; position:fixed; left:0; right:0; bottom:0; border-top:2px solid var(--line); border-bottom:0; z-index:4000; }
  .practice-nav .title { font-weight:600; color:var(--muted); }
  .practice-nav .questions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .practice-nav .q-item { padding:6px 10px; border:1px solid var(--line); border-radius:6px; background:#fff; cursor:pointer; font-size:14px; transition:all 0.2s; min-width:36px; text-align:center; }
  .practice-nav .q-item:hover { background:#f1f5f9; border-color:var(--accent); }
  .practice-nav .q-item.answered { background:#e0e7ff; border-color:var(--accent); color:var(--accent); font-weight:500; }
  .practice-nav .q-item.active { background:var(--accent); color:#fff; border-color:var(--accent); }
  #selbar { z-index: 6000 !important; }
  input.blank { border: 1px solid #ccc; padding: 4px; border-radius: 4px; width: 180px; }
  .flowchart { text-align: center; }
  .flowchart .box { border: 1px solid black; padding: 10px; margin: 10px auto; width: 80%; border-radius: 5px; }
  .flowchart .arrow { font-size: 24px; margin: 0; padding: 0; line-height: 1; }
</style>
</head>
<body>
<div class="practice-nav">
  <div class="title">Questions</div>
  <div class="questions">
    <div class="q-item" id="q27-nav" onclick="scrollToElement('q27-anchor')">27</div>
    <div class="q-item" id="q28-nav" onclick="scrollToElement('q28-anchor')">28</div>
    <div class="q-item" id="q29-nav" onclick="scrollToElement('q29-anchor')">29</div>
    <div class="q-item" id="q30-nav" onclick="scrollToElement('q30-anchor')">30</div>
    <div class="q-item" id="q31-nav" onclick="scrollToElement('q31-anchor')">31</div>
    <div class="q-item" id="q32-nav" onclick="scrollToElement('q32-anchor')">32</div>
    <div class="q-item" id="q33-nav" onclick="scrollToElement('q33-anchor')">33</div>
    <div class="q-item" id="q34-nav" onclick="scrollToElement('q34-anchor')">34</div>
    <div class="q-item" id="q35-nav" onclick="scrollToElement('q35-anchor')">35</div>
    <div class="q-item" id="q36-nav" onclick="scrollToElement('q36-anchor')">36</div>
    <div class="q-item" id="q37-nav" onclick="scrollToElement('q37-anchor')">37</div>
    <div class="q-item" id="q38-nav" onclick="scrollToElement('q38-anchor')">38</div>
    <div class="q-item" id="q39-nav" onclick="scrollToElement('q39-anchor')">39</div>
    <div class="q-item" id="q40-nav" onclick="scrollToElement('q40-anchor')">40</div>
  </div>
</div>
<div class="shell">
<section class="pane" id="left">
  <h2>READING PASSAGE 3 <span id="timer">00:00</span></h2>
  <p>You should spend about 20 minutes on Questions 27–40, which are based on Reading Passage 3 below.</p>
  <h3>Marketing and The Information Age</h3>
  
  <h4>A</h4>
  <p>For the early practitioners of marketing in the late 19th and early 20th centuries, the business of selling was simply a matter of continually finding new customers. By contrast, marketing managers in the current era recognise the importance of gathering information about the market and about potential customers. They recognise that if companies are to be profitable, customers must gain and retain their perceptions of value from the brands they buy over a long time frame, rather than from a single transaction. This also means that customers must see value in returning continually to the stores where they shop, as well as to the service providers they deal with.</p>
  
  <h4>B</h4>
  <p>Marketing practitioners and marketing scientists have never worked more closely than they currently do. There are many reasons for this, including the fact that this is the information age where convergence in telecommunications, media and technology is causing old ways to be challenged, and new methods and tools to be tested. Customer expectations have risen as new technologies allow new approaches. For instance, the subscriber-TV music channel Channel [V] encourages its viewers to sign up for text messages and email alerts that tell them when their favourite artists and songs are about to be broadcast. Competitive advantage lies in being able to recognise which customers can be given greater attention, not just because they demand it but because it makes commercial sense to provide high levels of product quality and service.</p>
  
  <h4>C</h4>
  <p>Modern marketing information systems rely on information technology to enable marketing intelligence to be gathered and to store and analyse marketing research information. While some of the information used is gathered by government bodies such as the Australian Bureau of Statistics and Statistics New Zealand, most of it is purposefully gathered by marketing organisations for client companies. In the process, computer technology is used to manipulate the data and then to present the information in such a way that executives can readily identify any problems or issues, and quickly arrive at solutions.</p>
  
  <h4>D</h4>
  <p>In order to produce superior value and satisfaction for customers, marketing managers need information at almost every turn. They need information about customers – end-users and resellers as well as competitors and governmental and other forces in the marketplace. One marketing executive put it this way: ‘To manage a business well is to manage its future; and to manage the future is to manage information.' Increasingly, marketers are viewing information not just as an input for making better decisions but also as an important strategic asset and marketing tool. As household incomes increase, choice widens and buyers become better at discriminating, so sellers need information about how buyers respond to different products and advertising campaigns.</p>
  
  <h4>E</h4>
  <p>The supply of information has also increased greatly. It has been suggested by the futurist and best-selling author John Naisbitt that the United States and, by observation, developed countries such as Australia, New Zealand and Singapore are moving from industrial to information-based economies. These post-industrial economies earn 70–80% of their Gross Domestic Product from services, and have entered what some commentators have termed the ‘Information Age' or the ‘Information Technology Era'.</p>
  
  <h4>F</h4>
  <p>One study found that with all the information now available through supermarket scanners, a packaged-goods product controller is bombarded with one million to one billion new numbers each week. As Naisbitt points out: 'Running out of information is not a problem, but drowning in it is.' Yet marketers frequently complain that they lack information of the right kind but have plenty of the wrong kind, or they claim that marketing information is so widely spread throughout the organisation that it takes great effort to locate even simple facts. In addition, subordinates may withhold information they believe will reflect badly on their performance and important information often arrives too late to be useful, or on-time information is not accurate. So marketing managers need better information. Although marketing organisations have greater capacity to provide managers with information, they often do not use it well. As a result, many marketing organisations are now studying their managers' information needs and designing information systems specifically to meet those needs.</p>
  
  <h4>G</h4>
  <p>One solution is to use a Marketing Information System (MIS). This consists of people, equipment and procedures which, when put together, are able to gather, analyse, evaluate and distribute needed, timely and accurate information to marketing decision-makers. The MIS begins and ends with marketing managers. First, it interacts with these managers to assess the information needs they have. Next, it develops the needed information from internal records, marketing intelligence activities and the research process. The analysis unit processes the data to make it more useful and, finally, the MIS distributes it to managers in the right form and at the right time to help them make better marketing decisions.</p>
  
  <h4>H</h4>
  <p>However, the costs of obtaining, processing, storing and delivering information can mount quickly. In some cases additional information will do little to change or improve a manager's decision, or the costs of the information will exceed the returns from the improved decision. For example, if an organisation estimates that launching a new product without any further information will yield a profit of $500,000, then it would be foolish to spend $30,000 for additional information that would increase the profit to only $525,000. By itself, information is valueless – its value comes from its use.</p>
  
</section>
<div id="divider" title="Drag to resize"></div>
<section class="pane" id="right">
  <h3>Questions</h3>
  
  <div class="group">
    <h4>Questions 27–31</h4>
    <p>Reading Passage 3 has eight paragraphs, A–H.</p>
    <p>Which paragraph contains the following information?</p>
    <p>Write the correct letter, A–H, in boxes 27–31 on your answer sheet.</p>
    <table>
      <thead>
        <tr>
          <th>Information</th>
          <th>A</th><th>B</th><th>C</th><th>D</th><th>E</th><th>F</th><th>G</th><th>H</th>
        </tr>
      </thead>
      <tbody>
        <tr id="q27-anchor">
          <td><b>27</b> the fact that there may be too much information to cope with</td>
          <td><input type="radio" name="q27" value="A"></td>
          <td><input type="radio" name="q27" value="B"></td>
          <td><input type="radio" name="q27" value="C"></td>
          <td><input type="radio" name="q27" value="D"></td>
          <td><input type="radio" name="q27" value="E"></td>
          <td><input type="radio" name="q27" value="F"></td>
          <td><input type="radio" name="q27" value="G"></td>
          <td><input type="radio" name="q27" value="H"></td>
        </tr>
        <tr id="q28-anchor">
          <td><b>28</b> the relevance of generating repeat business</td>
          <td><input type="radio" name="q28" value="A"></td>
          <td><input type="radio" name="q28" value="B"></td>
          <td><input type="radio" name="q28" value="C"></td>
          <td><input type="radio" name="q28" value="D"></td>
          <td><input type="radio" name="q28" value="E"></td>
          <td><input type="radio" name="q28" value="F"></td>
          <td><input type="radio" name="q28" value="G"></td>
          <td><input type="radio" name="q28" value="H"></td>
        </tr>
        <tr id="q29-anchor">
          <td><b>29</b> an example of personalised marketing</td>
          <td><input type="radio" name="q29" value="A"></td>
          <td><input type="radio" name="q29" value="B"></td>
          <td><input type="radio" name="q29" value="C"></td>
          <td><input type="radio" name="q29" value="D"></td>
          <td><input type="radio" name="q29" value="E"></td>
          <td><input type="radio" name="q29" value="F"></td>
          <td><input type="radio" name="q29" value="G"></td>
          <td><input type="radio" name="q29" value="H"></td>
        </tr>
        <tr id="q30-anchor">
          <td><b>30</b> an illustration of a situation where commissioning new information research might not be advisable</td>
          <td><input type="radio" name="q30" value="A"></td>
          <td><input type="radio" name="q30" value="B"></td>
          <td><input type="radio" name="q30" value="C"></td>
          <td><input type="radio" name="q30" value="D"></td>
          <td><input type="radio" name="q30" value="E"></td>
          <td><input type="radio" name="q30" value="F"></td>
          <td><input type="radio" name="q30" value="G"></td>
          <td><input type="radio" name="q30" value="H"></td>
        </tr>
        <tr id="q31-anchor">
          <td><b>31</b> how the greater wealth of customers enables them to select from a broader range of products</td>
          <td><input type="radio" name="q31" value="A"></td>
          <td><input type="radio" name="q31" value="B"></td>
          <td><input type="radio" name="q31" value="C"></td>
          <td><input type="radio" name="q31" value="D"></td>
          <td><input type="radio" name="q31" value="E"></td>
          <td><input type="radio" name="q31" value="F"></td>
          <td><input type="radio" name="q31" value="G"></td>
          <td><input type="radio" name="q31" value="H"></td>
        </tr>
      </tbody>
    </table>
  </div>
  
  <div class="group">
    <h4>Questions 32–36</h4>
    <p>Do the following statements agree with the claims of the writer in Reading Passage 3?</p>
    <p>In boxes 32–36 on your answer sheet, write</p>
    <ul>
      <li><b>YES</b> if the statement agrees with the claims of the writer</li>
      <li><b>NO</b> if the statement contradicts the claims of the writer</li>
      <li><b>NOT GIVEN</b> if it is impossible to say what the writer thinks about this</li>
    </ul>
    
    <div id="q32-anchor" style="padding:8px 0;border-top:1px dashed var(--line);">
      <p><b>32</b> The majority of marketing statistics are gathered by government agencies.</p>
      <label><input type="radio" name="q32" value="YES"> YES</label>
      <label><input type="radio" name="q32" value="NO"> NO</label>
      <label><input type="radio" name="q32" value="NOT GIVEN"> NOT GIVEN</label>
    </div>
    
    <div id="q33-anchor" style="padding:8px 0;border-top:1px dashed var(--line);">
      <p><b>33</b> The move from an industrial to an information-based economy has happened more quickly in New Zealand than in Australia.</p>
      <label><input type="radio" name="q33" value="YES"> YES</label>
      <label><input type="radio" name="q33" value="NO"> NO</label>
      <label><input type="radio" name="q33" value="NOT GIVEN"> NOT GIVEN</label>
    </div>

    <div id="q34-anchor" style="padding:8px 0;border-top:1px dashed var(--line);">
      <p><b>34</b> Employees sometimes hide information that gives a poor impression of them.</p>
      <label><input type="radio" name="q34" value="YES"> YES</label>
      <label><input type="radio" name="q34" value="NO"> NO</label>
      <label><input type="radio" name="q34" value="NOT GIVEN"> NOT GIVEN</label>
    </div>

    <div id="q35-anchor" style="padding:8px 0;border-top:1px dashed var(--line);">
      <p><b>35</b> Managers frequently fail to make good use of the information they receive.</p>
      <label><input type="radio" name="q35" value="YES"> YES</label>
      <label><input type="radio" name="q35" value="NO"> NO</label>
      <label><input type="radio" name="q35" value="NOT GIVEN"> NOT GIVEN</label>
    </div>

    <div id="q36-anchor" style="padding:8px 0;border-top:1px dashed var(--line);">
      <p><b>36</b> Marketing information has to be used to be valuable.</p>
      <label><input type="radio" name="q36" value="YES"> YES</label>
      <label><input type="radio" name="q36" value="NO"> NO</label>
      <label><input type="radio" name="q36" value="NOT GIVEN"> NOT GIVEN</label>
    </div>
  </div>
  
  <div class="group">
    <h4 id="q37-anchor">Questions 37–40</h4>
    <p>Complete the flow-chart below.</p>
    <p>Choose <b>NO MORE THAN TWO WORDS</b> from the passage for each answer.</p>
    <p>Write your answers in boxes 37–40 on your answer sheet.</p>
    
    <div class="flowchart">
      <h4>The Marketing Information System (MIS)</h4>
      <div class="box">
        <input class="blank" name="q37" placeholder="37" type="text">
      </div>
      <p class="arrow">↓</p>
      <div class="box">
        Find out their <input class="blank" name="q38" placeholder="38" type="text">
      </div>
      <p class="arrow">↓</p>
      <div class="box">
        Developed through:
        <ul style="text-align: left; margin: 5px auto; width: 200px;">
          <li><input class="blank" name="q39" placeholder="39" type="text"></li>
          <li>marketing intelligence activities</li>
          <li>research process</li>
        </ul>
      </div>
      <p class="arrow">↓</p>
      <div class="box">
        Processed by the <input class="blank" name="q40" placeholder="40" type="text">
      </div>
       <p class="arrow">↓</p>
       <div class="box">
        Timely and accurate data distribution
       </div>
    </div>
  </div>
  
  <div style="display:flex;gap:8px;margin-bottom:10px;">
    <button class="primary" onclick="grade()">Submit</button>
    <button onclick="resetForm()">Reset</button>
    <button onclick="toggleNotes()">Notes</button>
  </div>
  <div id="results"></div>
  <details class="answerbox" id="answerBox" style="display: none;">
    <summary>Show answers (click to toggle) <span class="badge">hidden</span></summary>
    <div id="answerContent"></div>
  </details>
</section>
</div>
<div aria-label="Selection tools" id="selbar" role="toolbar">
  <button id="btnHL">Highlight</button>
  <button id="btnUH">Remove</button>
  <button id="btnNote">Note</button>
</div>
<div id="notes">
  <header>
    <strong>Notes</strong>
    <div>
      <button id="btnCopy">Copy</button>
      <button id="btnClose">Close</button>
    </div>
  </header>
  <textarea id="noteArea" placeholder="Type your notes here..."></textarea>
</div>
<div id="toast"></div>
<script>
// Timer
let _t=0; const _timerEl=document.getElementById('timer');
setInterval(function(){ 
  _t++; 
  var m=String(Math.floor(_t/60)).padStart(2,'0'); 
  var s=String(_t%60).padStart(2,'0'); 
  _timerEl.textContent=m+':'+s; 
},1000);

// Drag divider
var divider = document.getElementById('divider');
var left = document.getElementById('left');
var right = document.getElementById('right');
var dragging=false;
function startDrag(e){ 
  dragging=true; 
  document.body.style.cursor='ew-resize'; 
  if(e.preventDefault) e.preventDefault(); 
}
function endDrag(){ 
  dragging=false; 
  document.body.style.cursor=''; 
}
function onMove(clientX){
  var container = document.querySelector('.shell').getBoundingClientRect();
  var x = clientX - container.left;
  x = Math.max(280, Math.min(container.width-320, x));
  left.style.flex = '0 0 ' + x + 'px';
  right.style.flex = '1 1 auto';
}
divider.addEventListener('mousedown', function(e){ startDrag(e); });
window.addEventListener('mousemove', function(e){ if(dragging) onMove(e.clientX); });
window.addEventListener('mouseup', endDrag);
divider.addEventListener('touchstart', function(e){ startDrag(e.touches[0]); }, {passive:false});
window.addEventListener('touchmove', function(e){ if(dragging) onMove(e.touches[0].clientX); }, {passive:false});
window.addEventListener('touchend', endDrag);

// Highlight toolbar
var selbar = document.getElementById('selbar');
var btnHL = document.getElementById('btnHL');
var btnUH = document.getElementById('btnUH');
var btnNote = document.getElementById('btnNote');
var lastRange=null;
var currentHlNode=null;
var keepToolbar=false;
function positionSelbarForRect(rect){
  selbar.style.display='flex';
  requestAnimationFrame(function(){
    var top = window.scrollY + rect.top - selbar.offsetHeight - 8;
    var leftPos = window.scrollX + rect.left + rect.width/2 - selbar.offsetWidth/2;
    selbar.style.top = ((top>0)?top:(window.scrollY + rect.bottom + 8)) + 'px';
    selbar.style.left = Math.max(8, leftPos) + 'px';
  });
}
function updateSelbar(){
  var sel=window.getSelection();
  if(!sel || sel.rangeCount===0 || sel.isCollapsed) { 
    selbar.style.display='none'; 
    currentHlNode=null; 
    return; 
  }
  var range = sel.getRangeAt(0);
  lastRange = range.cloneRange();
  currentHlNode=null;
  positionSelbarForRect(range.getBoundingClientRect());
}
document.getElementById('left').addEventListener('mouseup', updateSelbar);
document.getElementById('right').addEventListener('mouseup', updateSelbar);
document.addEventListener('selectionchange', function(){ 
  var sel=window.getSelection(); 
  if(!sel || sel.rangeCount===0 || sel.isCollapsed){ 
    if(!keepToolbar && !currentHlNode){ 
      selbar.style.display='none'; 
    } 
  } 
});
document.addEventListener('scroll', function(){ 
  if(selbar.style.display==='flex') updateSelbar(); 
});
document.addEventListener('mousedown', function(e){
  var t = e.target;
  if(t.classList && t.classList.contains('hl')){
    keepToolbar = true;
  } else {
    keepToolbar = false;
  }
}, true);
document.addEventListener('click', function(e){
  var target = e.target;
  if(target.classList && target.classList.contains('hl')){
    currentHlNode = target;
    lastRange = null;
    positionSelbarForRect(target.getBoundingClientRect());
    var sel=window.getSelection();
    if(sel) sel.removeAllRanges();
    setTimeout(function(){ keepToolbar=false; }, 0);
  }
}, true);
function doHighlight(){
  if(currentHlNode) return;
  if(!lastRange || lastRange.collapsed) return;
  var span=document.createElement('span'); span.className='hl';
  try { lastRange.surroundContents(span); }
  catch(e){
    var wrap=document.createElement('span'); wrap.className='hl';
    wrap.appendChild(lastRange.cloneContents());
    lastRange.deleteContents();
    lastRange.insertNode(wrap);
  }
  selbar.style.display='none';
  showToast('Highlighted');
}
function removeHighlight(){
  if(currentHlNode){
    var p = currentHlNode.parentNode;
    while(currentHlNode.firstChild) p.insertBefore(currentHlNode.firstChild, currentHlNode);
    p.removeChild(currentHlNode); p.normalize();
    currentHlNode = null;
    selbar.style.display='none';
    showToast('Highlight removed');
    return;
  }
  if(!lastRange) return;
  var selRect = lastRange.getBoundingClientRect();
  var walker=document.createTreeWalker(document.body, NodeFilter.SHOW_ELEMENT);
  var toRemove=[];
  while(walker.nextNode()){
    var n=walker.currentNode;
    if(n.classList && n.classList.contains('hl')) {
      var r = n.getBoundingClientRect();
      if(!(r.right < selRect.left || r.left > selRect.right || r.bottom < selRect.top || r.top > selRect.bottom)) toRemove.push(n);
    }
  }
  toRemove.forEach(function(el){ var p=el.parentNode; while(el.firstChild) p.insertBefore(el.firstChild, el); p.removeChild(el); p.normalize(); });
  selbar.style.display='none';
  showToast('Highlight removed');
}
btnHL.addEventListener('click', doHighlight);
btnUH.addEventListener('click', removeHighlight);

// Notes
var notes = document.getElementById('notes');
var noteArea = document.getElementById('noteArea');
var btnCopy=document.getElementById('btnCopy');
var btnClose=document.getElementById('btnClose');
function toggleNotes(){ 
  notes.style.display = (notes.style.display==='flex'?'none':'flex'); 
}
window.toggleNotes = toggleNotes;
btnClose.addEventListener('click', toggleNotes);
btnCopy.addEventListener('click', async function(){ 
  await navigator.clipboard.writeText(noteArea.value||''); 
  showToast('Copied'); 
});
btnNote.addEventListener('click', function(){
  var text = '';
  if(currentHlNode){ text = (currentHlNode.textContent||'').trim(); }
  else if(lastRange){ var frag = lastRange.cloneContents(); text = (frag.textContent||'').trim(); }
  toggleNotes();
  if(text) noteArea.value = (noteArea.value? noteArea.value+'\n':'') + '> ' + text + '\n';
  selbar.style.display='none';
});

// Toast
var toastEl=document.getElementById('toast');
function showToast(msg){
  toastEl.textContent=msg; 
  toastEl.style.display='block';
  setTimeout(function(){ toastEl.style.display='none'; }, 1200);
}

// Answer key and grading
var answers = {
  "q27":"F", "q28":"A", "q29":"B", "q30":"H", "q31":"D",
  "q32":"NO", "q33":"NOT GIVEN", "q34":"YES", "q35":"YES", "q36":"YES",
  "q37":"marketing managers", "q38":"information needs", "q39":"internal records", "q40":"analysis unit"
};

function grade(){
  var total=0, correct=0, lines=[];
  
  // 27–31 Matching
  for(var n=27;n<=31;n++){
    var sel=document.querySelector(`input[name="q${n}"]:checked`);
    var val=sel?sel.value:'';
    var isCorrect = val === answers[`q${n}`];
    total++; if(isCorrect) correct++;
    lines.push(`Q${n}: ${val || 'None'} ${isCorrect ? '✅' : '❌'}`);
  }
  
  // 32–36 YES/NO/NG
  for(var n=32;n<=36;n++){
    var sel=document.querySelector(`input[name="q${n}"]:checked`);
    var val=sel?sel.value:'';
    var isCorrect = val === answers[`q${n}`];
    total++; if(isCorrect) correct++;
    lines.push(`Q${n}: ${val || 'None'} ${isCorrect ? '✅' : '❌'}`);
  }

  // 37–40 Flow-chart
  for(var n=37;n<=40;n++){
    var el=document.querySelector(`input[name="q${n}"]`);
    var val=el?el.value.trim().toLowerCase():'';
    var isCorrect = val === answers[`q${n}`].toLowerCase();
    total++; if(isCorrect) correct++;
    lines.push(`Q${n}: ${val || 'None'} ${isCorrect ? '✅' : '❌'}`);
  }

  var acc = (total? Math.round(100*correct/total):0);
  var html = `<p><strong>Score:</strong> ${correct}/${total} <span class="badge">Accuracy ${acc}%</span></p>`;
  html += `<pre>${lines.join('\n')}</pre>`;
  document.getElementById('results').innerHTML = html;
  
  // Show answer key section
  document.getElementById('answerBox').style.display = 'block';
  var ahtml = `<ol start="27">
    <li>F</li><li>A</li><li>B</li><li>H</li><li>D</li>
    <li>NO</li><li>NOT GIVEN</li><li>YES</li><li>YES</li><li>YES</li>
    <li>marketing managers</li><li>information needs</li><li>internal records</li><li>analysis unit</li>
  </ol>`;
  document.getElementById('answerContent').innerHTML = ahtml;
  document.querySelector('#answerBox .badge').textContent='tap to view';
}

function resetForm(){
  document.querySelectorAll('input[type="radio"]').forEach(el=>el.checked=false);
  document.querySelectorAll('input.blank').forEach(el=>el.value="");
  document.getElementById('results').innerHTML='';
  document.getElementById('answerContent').innerHTML='';
  document.getElementById('answerBox').style.display = 'none';
  document.querySelector('#answerBox .badge').textContent = 'hidden';
  document.querySelectorAll('.q-item').forEach(item => {
    item.classList.remove('answered');
  });
}

function scrollToElement(id){
  var el = document.getElementById(id);
  if(el){ 
    el.scrollIntoView({behavior:'smooth', block:'center'}); 
  }
  var navs = document.querySelectorAll('.practice-nav .q-item');
  navs.forEach(n => n.classList.remove('active'));
  var btn = document.getElementById(id.replace('-anchor','-nav'));
  if(btn){ 
    btn.classList.add('active'); 
    setTimeout(() => btn.classList.remove('active'), 800); 
  }
}

(function(){
  function mark(qn){
    var nav = document.getElementById('q'+qn+'-nav');
    if(!nav) return;
    var radios = document.querySelectorAll('input[name="q'+qn+'"]');
    var text = document.querySelector('input[name="q'+qn+'"].blank');
    var answered=false;
    if(radios.length){ radios.forEach(function(r){ if(r.checked) answered=true; }); }
    if(text){ answered = answered || (text.value && text.value.trim().length>0); }
    if(answered) nav.classList.add('answered'); else nav.classList.remove('answered');
  }
  
  for(var q=27;q<=40;q++){
    (function(n){
      var inputs = document.querySelectorAll('input[name="q'+n+'"]');
      inputs.forEach(function(i){ 
        var eventType = i.type === 'text' ? 'input' : 'change';
        i.addEventListener(eventType, function(){ mark(n); }); 
      });
    })(q);
  }
})();
</script>

<!-- 练习页面数据传输增强脚本 -->
<script>
// 检查是否已经有增强脚本
if (!window.practicePageEnhancer) {
    // 动态加载增强脚本
    const script = document.createElement('script');
    script.src = '../../js/practice-page-enhancer.js';
    script.onload = function() {
        console.log('练习页面增强脚本已加载');
    };
    script.onerror = function() {
        console.error('练习页面增强脚本加载失败');
        // 降级到内联增强
        loadInlineEnhancer();
    };
    document.head.appendChild(script);
}

// 内联增强器（降级方案）
function loadInlineEnhancer() {
    if (window.practicePageEnhancer) return;
    
    window.practicePageEnhancer = {
        initialize: function() {
            console.log('[InlineEnhancer] 内联增强器已初始化');
            this.setupCommunication();
            this.setupAnswerListeners();
            this.interceptSubmit();
        },
        
        setupCommunication: function() {
            this.parentWindow = window.opener || window.parent;
            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'INIT_SESSION') {
                    this.sessionId = event.data.data.sessionId;
                    this.sendMessage('SESSION_READY', {
                        pageType: this.detectPageType(),
                        url: window.location.href
                    });
                }
            });
        },
        
        detectPageType: function() {
            const title = document.title || '';
            if (title.includes('P1')) return 'P1';
            if (title.includes('P2')) return 'P2';
            if (title.includes('P3')) return 'P3';
            return 'unknown';
        },
        
        setupAnswerListeners: function() {
            this.answers = {};
            this.startTime = Date.now();
            
            document.addEventListener('change', (e) => {
                if (e.target.name && e.target.name.startsWith('q')) {
                    this.answers[e.target.name] = e.target.value;
                }
            });
            document.addEventListener('input', (e) => {
                if (e.target.name && e.target.name.startsWith('q') && e.target.classList.contains('blank')) {
                    this.answers[e.target.name] = e.target.value;
                }
            });
        },
        
        interceptSubmit: function() {
            // 拦截grade函数
            if (typeof window.grade === 'function') {
                const originalGrade = window.grade;
                window.grade = () => {
                    const result = originalGrade();
                    setTimeout(() => this.handleSubmit(), 200);
                    return result;
                };
            }
            
            // 监听提交按钮
            document.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' && 
                    (e.target.textContent.includes('Submit') || 
                     e.target.onclick && e.target.onclick.toString().includes('grade'))) {
                    setTimeout(() => this.handleSubmit(), 300);
                }
            });
        },
        
        handleSubmit: function() {
            const results = {
                sessionId: this.sessionId,
                startTime: this.startTime,
                endTime: Date.now(),
                duration: Math.round((Date.now() - this.startTime) / 1000),
                answers: this.answers,
                scoreInfo: this.extractScore(),
                pageType: this.detectPageType(),
                url: window.location.href
            };
            
            this.sendMessage('PRACTICE_COMPLETE', results);
        },
        
        extractScore: function() {
            const resultsEl = document.getElementById('results');
            if (!resultsEl) return null;
            
            const text = resultsEl.textContent || '';
            const scoreMatch = text.match(/Score:\s*(\d+)\/(\d+)/i);
            if (scoreMatch) {
                const correct = parseInt(scoreMatch[1]);
                const total = parseInt(scoreMatch[2]);
                return {
                    correct: correct,
                    total: total,
                    accuracy: total > 0 ? correct / total : 0,
                    percentage: Math.round((correct / total) * 100),
                    source: 'inline_extraction'
                };
            }
            return null;
        },
        
        sendMessage: function(type, data) {
            if (this.parentWindow) {
                this.parentWindow.postMessage({
                    type: type,
                    data: data,
                    source: 'practice_page'
                }, '*');
            }
        }
    };
    
    // 初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            window.practicePageEnhancer.initialize();
        });
    } else {
        window.practicePageEnhancer.initialize();
    }
}
</script>

</body>
</html>