<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P3 – The fluoridation controversy</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root { --line:#e5e7eb; --bg:#f6f7fb; --panel:#fff; --accent:#3b82f6; --muted:#6b7280; --shadow:0 6px 20px rgba(0,0,0,.12); }
  * { box-sizing: border-box; }
  html,body { height:100%; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); padding-bottom: 82px; }
  #timer { position: static; display: inline-block; margin-left: 8px; background:#fff; border:1px solid var(--line); border-radius:10px; padding:2px 8px; font-size:14px; vertical-align: middle; }
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:var(--panel); overflow:auto; padding:20px; }
  #left { flex: 0 0 50%; min-width: 280px; }
  #right { flex: 1 1 auto; min-width: 320px; background:#fbfbff; border-left:1px solid var(--line); }
  #divider { flex: 0 0 8px; background: linear-gradient(90deg,#e5e7eb,#d1d5db); cursor: ew-resize; position:relative; z-index: 5; user-select:none; }
  h2,h3,h4 { margin:0 0 10px; }
  #left p { margin: 0 0 12px; line-height: 1.6; word-break: normal; overflow-wrap: normal; hyphens: none; }
  .group { background:#fff; border:1px solid var(--line); border-radius:10px; padding:12px; margin-bottom:14px; }
  input.blank { border:none; border-bottom:1px solid #9ca3af; padding:2px 4px; font-size:1em; background:transparent; }
  input.blank:focus { outline:none; border-bottom:2px solid var(--accent); }
  button { padding:8px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; cursor:pointer; }
  button.primary { background:var(--accent); color:#fff; border-color:#3b82f6; }
  #results { background:#fff; border:1px solid var(--line); border-radius:10px; padding:10px; }
  .hl { background:#fff3a3; box-shadow: inset 0 -2px 0 rgba(0,0,0,.05); cursor: pointer; }
  .hl:hover { filter: brightness(0.98); }
  #selbar { position: absolute; display:none; z-index: 2000; background:#111; color:#fff; border-radius: 8px; padding: 6px; box-shadow: var(--shadow); font-size: 13px; gap:6px; align-items: center; }
  #selbar button { background: transparent; color:#fff; border: 1px solid rgba(255,255,255,.25); padding: 4px 8px; border-radius: 6px; cursor:pointer; }
  #selbar button:hover { border-color:#fff; }
  #notes { position: fixed; right: 12px; bottom: 12px; width: 320px; height: 42vh; background:#fff; border:1px solid var(--line); border-radius: 12px; display:none; flex-direction: column; z-index:1500; box-shadow: var(--shadow); }
  #notes header { display:flex; align-items:center; justify-content: space-between; padding:8px 10px; border-bottom:1px solid var(--line); }
  #notes textarea { flex:1; border:0; padding:10px; resize:none; font-size:14px; line-height:1.5; }
  #toast { position: fixed; left:50%; transform: translateX(-50%); bottom: 24px; background:#111; color:#fff; padding:8px 12px; border-radius: 8px; display:none; z-index:2500; }
  details.answerbox summary { cursor: pointer; user-select:none; list-style: none; }
  details.answerbox { border:1px dashed var(--line); border-radius:10px; padding:8px 10px; background:#fff; }
  .badge { display:inline-block; background:#eef2ff; color:#4338ca; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:6px; }
  .practice-nav { background:#fff; border-bottom:2px solid var(--line); padding:12px 20px; display:flex; align-items:center; gap:20px; box-shadow:0 2px 4px rgba(0,0,0,.05); flex-wrap:wrap; position:fixed; left:0; right:0; bottom:0; border-top:2px solid var(--line); border-bottom:0; z-index:4000; }
  .practice-nav .title { font-weight:600; color:var(--muted); }
  .practice-nav .questions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .practice-nav .q-item { padding:6px 10px; border:1px solid var(--line); border-radius:6px; background:#fff; cursor:pointer; font-size:14px; transition:all 0.2s; min-width:36px; text-align:center; }
  .practice-nav .q-item:hover { background:#f1f5f9; border-color:var(--accent); }
  .practice-nav .q-item.answered { background:#e0e7ff; border-color:var(--accent); color:var(--accent); font-weight:500; }
  .practice-nav .q-item.active { background:var(--accent); color:#fff; border-color:var(--accent); }
  .practice-nav .controls { margin-left:auto; display:flex; align-items:center; gap:12px; }
  #timer { display:inline-block; background:#fff; border:1px solid var(--line); border-radius:10px; padding:4px 10px; font-size:14px; cursor:pointer; transition:all 0.2s; }
  #timer:hover { background:#f8fafc; border-color:var(--accent); }
  #timer.paused { background:#fef3c7; border-color:#f59e0b; color:#92400e; }
  .theme-toggle { background:transparent; border:1px solid var(--line); border-radius:8px; padding:6px; cursor:pointer; display:flex; align-items:center; justify-content:center; width:36px; height:36px; }
  .theme-toggle:hover { background:var(--accent); color:#fff; border-color:var(--accent); }
  #selbar { z-index: 6000 !important; }
  .matching-options { border: 1px solid #ccc; padding: 12px; margin-top: 1em; border-radius: 8px; background: #f9fafb;}
  .matching-options p { margin: 0; padding: 4px 0; }
  
  /* Dark mode styles */
  body.dark { --bg:#0f172a; --panel:#1e293b; --line:#334155; --muted:#94a3b8; color:#e2e8f0; }
  body.dark #right { background:#0f172a; }
  body.dark .group { background:#1e293b; border-color:#334155; }
  body.dark button { background:#1e293b; color:#e2e8f0; border-color:#334155; }
  body.dark button:hover { background:#334155; }
  body.dark #results { background:#1e293b; border-color:#334155; }
  body.dark #notes { background:#1e293b; border-color:#334155; color:#e2e8f0; }
  body.dark .practice-nav { background:#1e293b; border-color:#334155; }
  body.dark .q-item { background:#0f172a; color:#e2e8f0; border-color:#334155; }
  body.dark .q-item:hover { background:#334155; }
  body.dark #timer { background:#1e293b; color:#e2e8f0; border-color:#334155; }
  body.dark #timer:hover { background:#334155; }
  body.dark .matching-options { background:#1e293b; border-color:#334155; }
</style>
</head>
<body>

<div class="practice-nav">
  <div class="title">Questions</div>
  <div class="questions">
    <div class="q-item" id="q27-nav" onclick="scrollToElement('q27-anchor')">27</div>
    <div class="q-item" id="q28-nav" onclick="scrollToElement('q28-anchor')">28</div>
    <div class="q-item" id="q29-nav" onclick="scrollToElement('q29-anchor')">29</div>
    <div class="q-item" id="q30-nav" onclick="scrollToElement('q30-anchor')">30</div>
    <div class="q-item" id="q31-nav" onclick="scrollToElement('q31-anchor')">31</div>
    <div class="q-item" id="q32-nav" onclick="scrollToElement('q32-anchor')">32</div>
    <div class="q-item" id="q33-nav" onclick="scrollToElement('q33-anchor')">33</div>
    <div class="q-item" id="q34-nav" onclick="scrollToElement('q34-anchor')">34</div>
    <div class="q-item" id="q35-nav" onclick="scrollToElement('q35-anchor')">35</div>
    <div class="q-item" id="q36-nav" onclick="scrollToElement('q36-anchor')">36</div>
    <div class="q-item" id="q37-nav" onclick="scrollToElement('q37-anchor')">37</div>
    <div class="q-item" id="q38-nav" onclick="scrollToElement('q38-anchor')">38</div>
    <div class="q-item" id="q39-nav" onclick="scrollToElement('q39-anchor')">39</div>
    <div class="q-item" id="q40-nav" onclick="scrollToElement('q40-anchor')">40</div>
  </div>
  <div class="controls">
    <span id="timer">00:00</span>
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode">🌙</button>
  </div>
</div>

<div class="shell">
  <section class="pane" id="left">
    <h2>READING PASSAGE 3</h2>
    <p>You should spend about 20 minutes on Questions 27–40, which are based on Reading Passage 3 below.</p>
    
    <h3>The fluoridation controversy</h3>
    <p><em>The long-standing debate about whether to fluoridate our drinking water continues</em></p>
    
    <p>Fluoridation is the addition of fluorine to public water supplies with the aim of reducing tooth decay. The fluorine, when mixed with water, becomes fluoride and the desired concentration of fluoride in public water is approximately one part per million, depending on the regional temperature and hence the amount of water people are likely to drink. Many studies, such as those by McClure in 1970 through to Burt in 1983, have shown that when children drink fluoridated water, their average rate of tooth decay seems greatly reduced. A typical figure claimed is 50 percent reduction. This apparently enormous benefit for children's teeth is the major argument in favor of fluoridation.</p>
    
    <p>Three main grounds for opposition to fluoridation have been expressed. First, opponents claim the benefits are exaggerated or not established. Second, there are claims of health risks to parts of the population, for example, allergic reactions. It is also accepted that high levels of fluoride can cause discoloration of otherwise healthy teeth. Proponents do not consider this to be a problem in such small concentrations, whereas opponents disagree—especially because some people drink more water and obtain much more than the standard 1 milligram of fluoride per day. Third, fluoridation is thought to be an infringement on individual rights because it is compulsory medication of all members of a community.</p>
    
    <p>An understanding of the fluoridation issue has important implications. If, according to the experts, fluoridation is unquestionably a beneficial and non-hazardous measure, then the wisdom of allowing the public to vote on, and reject it must be questioned.</p>
    
    <p>Almost all studies that have been done have assumed that the scientific aspects of the controversy are unproblematic, and they have excluded science from sociological examination. The traditional view is that science is a special kind of knowledge, which is established through scientific methods and objectively applied by members of a scientific community. However, in recent years there has been a major challenge to this picture by a sociology of science that shows how scientific knowledge is socially negotiated, and inevitably linked to the values of the relevant parties, both scientists and nonscientists. These challengers do not see scientific knowledge as exempt from social inquiry.</p>
    
    <p>Kuhn (1970) argued that scientific knowledge does not always develop as an orderly process, but is characterized by periodic revolutions, in which the methods of study and the assessment criteria change in a fragmented way. According to Kuhn, the shift from one scientific way of thinking to another is not made solely on the basis of clear rules of formal scientific practice, but can include social factors, though Kuhn has never developed a full analysis of what these might be. Collins (1975) took this concept further when he asserted that the outcome of experiments was not something whose meaning could be immediately comprehended, but rather something for interpretation, discussion between scientists, and reinterpretation in the light of other experiments.</p>

    <p>One interpretation of this analysis of science is that traditional distinctions between facts and theories, and between scientific knowledge and values, can no longer be justified. Because social processes are involved at all stages of the creation, evaluation, and establishing of scientific knowledge, social values may also be involved.</p>

    <p>In the same way as many scientists who study fluoridation have overlooked social values, sociologists have also downplayed an important part of the debate by ignoring the number of eminent scientists who have questioned aspects of fluoridation. An example is the study by Sutton in 1960, which analyzed the classic North American studies of the effect of fluoridation on tooth decay, and found that each showed significant methodological shortcomings. Sutton's detailed study throws doubt as to the extent of reductions in tooth decay from fluoridation. Yet Sutton's book is not cited in a single analysis of the fluoridation issue by any sociologist.</p>

    <p>In a situation of some scientific uncertainty, differences in values are highlighted. A supporter of fluoridation might argue, 'The evidence for the benefits of fluoridation is quite substantial, while the evidence for harm is limited and dubious. I think the likely benefits outweigh the possible dangers; hence I support fluoridation because it is the cheapest and easiest way to make sure every child reaps the benefits.' An opponent might argue, 'Though the evidence for the benefits of fluoridation is substantial, there is some doubt about it. Since fluoridation is not necessary for good teeth, we should forgo the benefits if there is some slight chance of harm. Some scientists claim that a small percentage of the population could be harmed by fluoride. Therefore, I oppose fluoridation of water supplies and favor the voluntary use of fluoride tablets by those who want to take them.'</p>

    <p>Both arguments consider the scientific evidence concerning fluoridation, but differ in their assessments of the social benefits and costs. This difference is not between rationality and irrationality but is a legitimate difference in values, for example, the positive value placed on good teeth, the negative value placed on possible health risks, and the social benefits or costs of compulsory or voluntary intake of fluorides.</p>

    <p>From the sociological point of view, opposition to fluoridation is not necessarily irrational. Rather, claims to rationality and to scientific authority are better seen as part of a strategy to promote fluoridation than as incontrovertible statements of fact. Second, social values are likely to be bound up in any decision about fluoridation, so this is not an issue on which declarations by scientific experts ought to be considered the final word.</p>

    <p>&nbsp;</p>
  </section>
  <div id="divider" title="Drag to resize"></div>
  <section class="pane" id="right">
    <h3>Questions</h3>
    
    <div class="group">
        <h4>Questions 27–31</h4>
        <p>Choose the correct letter, A, B, C or D.</p>
        
        <a id="q27-anchor"></a>
        <div id="q27-section" style="padding:8px 0;border-top:1px dashed var(--line);">
          <p>27 The optimum amount of fluoride in fluoridated water is calculated partly according to</p>
          <div>
            <label style="display:block; margin:4px 0;"><input name="q27" type="radio" value="A"> A how hot the area is.</label>
            <label style="display:block; margin:4px 0;"><input name="q27" type="radio" value="B"> B how warm the water is.</label>
            <label style="display:block; margin:4px 0;"><input name="q27" type="radio" value="C"> C how many dental problems there are in the community.</label>
            <label style="display:block; margin:4px 0;"><input name="q27" type="radio" value="D"> D how much fluorine the community chooses to have in its water.</label>
          </div>
        </div>

        <a id="q28-anchor"></a>
        <div id="q28-section" style="padding:8px 0;border-top:1px dashed var(--line);">
          <p>28 One reason given by the writer for opposing fluoridation is that</p>
          <div>
            <label style="display:block; margin:4px 0;"><input name="q28" type="radio" value="A"> A it may contribute to tooth decay.</label>
            <label style="display:block; margin:4px 0;"><input name="q28" type="radio" value="B"> B it will be unacceptably expensive for the public.</label>
            <label style="display:block; margin:4px 0;"><input name="q28" type="radio" value="C"> C obligatory fluoridation takes away personal freedom.</label>
            <label style="display:block; margin:4px 0;"><input name="q28" type="radio" value="D"> D excessive fluoride could be added to the water by mistake.</label>
          </div>
        </div>

        <a id="q29-anchor"></a>
        <div id="q29-section" style="padding:8px 0;border-top:1px dashed var(--line);">
          <p>29 The writer mentions Kuhn in order to</p>
          <div>
            <label style="display:block; margin:4px 0;"><input name="q29" type="radio" value="A"> A provide a contrast with the view of Collins.</label>
            <label style="display:block; margin:4px 0;"><input name="q29" type="radio" value="B"> B support the rational nature of scientific inquiry.</label>
            <label style="display:block; margin:4px 0;"><input name="q29" type="radio" value="C"> C demonstrate that Kuhn did not argue his case adequately.</label>
            <label style="display:block; margin:4px 0;"><input name="q29" type="radio" value="D"> D show that science can be influenced by non-scientific considerations.</label>
          </div>
        </div>

        <a id="q30-anchor"></a>
        <div id="q30-section" style="padding:8px 0;border-top:1px dashed var(--line);">
          <p>30 What did Sutton's research discover about earlier studies in North America?</p>
          <div>
            <label style="display:block; margin:4px 0;"><input name="q30" type="radio" value="A"> A There were failings in the way they were carried out.</label>
            <label style="display:block; margin:4px 0;"><input name="q30" type="radio" value="B"> B The scientists involved had achieved unique results.</label>
            <label style="display:block; margin:4px 0;"><input name="q30" type="radio" value="C"> C Proponents of fluoridation had not understood its long-term effects.</label>
            <label style="display:block; margin:4px 0;"><input name="q30" type="radio" value="D"> D Fluoridation had a greater effect on tooth decay than previously believed.</label>
          </div>
        </div>

        <a id="q31-anchor"></a>
        <div id="q31-section" style="padding:8px 0;border-top:1px dashed var(--line);">
          <p>31 In the last paragraph, what does the writer say about scientists?</p>
          <div>
            <label style="display:block; margin:4px 0;"><input name="q31" type="radio" value="A"> A They should reveal their true motivations.</label>
            <label style="display:block; margin:4px 0;"><input name="q31" type="radio" value="B"> B They should not decide the fluoridation policy.</label>
            <label style="display:block; margin:4px 0;"><input name="q31" type="radio" value="C"> C They are solely concerned with scientific truths.</label>
            <label style="display:block; margin:4px 0;"><input name="q31" type="radio" value="D"> D They cannot reach agreement on the fluoridation issue.</label>
          </div>
        </div>
    </div>
    
    <div class="group">
        <h4>Questions 32–35</h4>
        <p>Do the following statements agree with the views of the writer in Reading Passage 3?</p>
        <p>In boxes 32–35 on your answer sheet, write</p>
        <ul>
            <li><strong>YES</strong> if the statement agrees with the views of the writer</li>
            <li><strong>NO</strong> if the statement contradicts the views of the writer</li>
            <li><strong>NOT GIVEN</strong> if it is impossible to say what the writer thinks about this</li>
        </ul>
        
        <a id="q32-anchor"></a><div id="q32-section" style="padding:8px 0;border-top:1px dashed var(--line);"><p>32 Scientific knowledge should be kept separate from social values.</p><div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;"><label><input name="q32" type="radio" value="YES"> YES</label> <label><input name="q32" type="radio" value="NO"> NO</label> <label><input name="q32" type="radio" value="NOT GIVEN"> NOT GIVEN</label></div></div>
        <a id="q33-anchor"></a><div id="q33-section" style="padding:8px 0;border-top:1px dashed var(--line);"><p>33 Many sociologists have disregarded the doubts that some scientists have concerning fluoridation.</p><div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;"><label><input name="q33" type="radio" value="YES"> YES</label> <label><input name="q33" type="radio" value="NO"> NO</label> <label><input name="q33" type="radio" value="NOT GIVEN"> NOT GIVEN</label></div></div>
        <a id="q34-anchor"></a><div id="q34-section" style="padding:8px 0;border-top:1px dashed var(--line);"><p>34 Sutton's findings have been given insufficient attention by scientists outside of North America.</p><div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;"><label><input name="q34" type="radio" value="YES"> YES</label> <label><input name="q34" type="radio" value="NO"> NO</label> <label><input name="q34" type="radio" value="NOT GIVEN"> NOT GIVEN</label></div></div>
        <a id="q35-anchor"></a><div id="q35-section" style="padding:8px 0;border-top:1px dashed var(--line);"><p>35 There are valid arguments on both sides of the fluoridation debate.</p><div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;"><label><input name="q35" type="radio" value="YES"> YES</label> <label><input name="q35" type="radio" value="NO"> NO</label> <label><input name="q35" type="radio" value="NOT GIVEN"> NOT GIVEN</label></div></div>
    </div>

    <div class="group">
        <h4>Questions 36–40</h4>
        <p>Complete each sentence with the correct ending, A–G, below.</p>

        <a id="q36-anchor"></a><p>36 The traditional view of science is that <input name="q36" type="text" class="blank" maxlength="1" style="width: 30px; text-align: center;"></p>
        <a id="q37-anchor"></a><p>37 A sociological view of science argues that <input name="q37" type="text" class="blank" maxlength="1" style="width: 30px; text-align: center;"></p>
        <a id="q38-anchor"></a><p>38 Collins is of the opinion that <input name="q38" type="text" class="blank" maxlength="1" style="width: 30px; text-align: center;"></p>
        <a id="q39-anchor"></a><p>39 The writer suggests that a supporter of fluoridation may conclude that <input name="q39" type="text" class="blank" maxlength="1" style="width: 30px; text-align: center;"></p>
        <a id="q40-anchor"></a><p>40 The writer suggests that an opponent of fluoridation may conclude that <input name="q40" type="text" class="blank" maxlength="1" style="width: 30px; text-align: center;"></p>
        
        <div class="matching-options">
            <p><strong>A</strong> &nbsp; the results of scientific research are not always understood at first.</p>
            <p><strong>B</strong> &nbsp; science is an unbiased discipline.</p>
            <p><strong>C</strong> &nbsp; people should be able to choose whether they want fluoride.</p>
            <p><strong>D</strong> &nbsp; there is insufficient proof to support a cautious approach.</p>
            <p><strong>E</strong> &nbsp; the serious damage fluoride causes far outweighs any positive effects.</p>
            <p><strong>F</strong> &nbsp; children are not the only ones who benefit from fluoridation.</p>
            <p><strong>G</strong> &nbsp; scientific knowledge is affected by the beliefs of everyone concerned.</p>
        </div>
    </div>

    <div style="display:flex;gap:8px;margin-bottom:10px;">
      <button class="primary" onclick="grade()">Submit</button>
      <button onclick="resetForm()">Reset</button>
      <button onclick="toggleNotes()">Notes</button>
    </div>
    <div id="results"></div>
    <details class="answerbox" id="answerBox">
      <summary>Show answers (click to toggle) <span class="badge">hidden</span></summary>
      <div id="answerContent"></div>
    </details>
  </section>
</div>

<div aria-label="Selection tools" id="selbar" role="toolbar">
  <button id="btnHL">Highlight</button>
  <button id="btnUH">Remove</button>
  <button id="btnNote">Note</button>
</div>
<div id="notes">
  <header>
    <strong>Notes</strong>
    <div>
      <button id="btnCopy">Copy</button>
      <button id="btnClose">Close</button>
    </div>
  </header>
  <textarea id="noteArea" placeholder="Type your notes here..."></textarea>
</div>
<div id="toast"></div>

<script>
// Timer
// Timer with click to pause/resume functionality
let _t = 0;
let timerRunning = true;
let timerInterval;
const _timerEl = document.getElementById('timer');

function updateTimer() {
  const m = Math.floor(_t / 60);
  const s = _t % 60;
  _timerEl.textContent = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
}

function startTimer() {
  timerInterval = setInterval(() => {
    if (timerRunning) {
      _t++;
      updateTimer();
    }
  }, 1000);
}

// Add click functionality to timer
_timerEl.addEventListener('click', function () {
  if (timerRunning) {
    clearInterval(timerInterval);
    timerRunning = false;
    _timerEl.classList.add('paused');
    showToast('Timer paused');
  } else {
    startTimer();
    timerRunning = true;
    _timerEl.classList.remove('paused');
    showToast('Timer resumed');
  }
});

// Start timer on page load
startTimer();

// Dark mode functionality
function toggleTheme() {
  document.body.classList.toggle('dark');
  const isDark = document.body.classList.contains('dark');
  localStorage.setItem('darkMode', isDark);
  const themeButton = document.querySelector('.theme-toggle');
  themeButton.textContent = isDark ? '☀️' : '🌙';
}

// Load saved theme
if (localStorage.getItem('darkMode') === 'true') {
  document.body.classList.add('dark');
  document.querySelector('.theme-toggle').textContent = '☀️';
}
setInterval(function(){ 
  _t++; 
  var m=String(Math.floor(_t/60)).padStart(2,'0'); 
  var s=String(_t%60).padStart(2,'0'); 
  _timerEl.textContent=m+':'+s; 
},1000);
// Drag divider
var divider = document.getElementById('divider');
var left = document.getElementById('left');
var right = document.getElementById('right');
var dragging=false;
function startDrag(e){ 
  dragging=true; 
  document.body.style.cursor='ew-resize'; 
  if(e.preventDefault) e.preventDefault(); 
}
function endDrag(){ 
  dragging=false; 
  document.body.style.cursor=''; 
}
function onMove(clientX){
  var container = document.querySelector('.shell').getBoundingClientRect();
  var x = clientX - container.left;
  x = Math.max(280, Math.min(container.width-320, x));
  left.style.flex = '0 0 ' + x + 'px';
  right.style.flex = '1 1 auto';
}
divider.addEventListener('mousedown', function(e){ startDrag(e); });
window.addEventListener('mousemove', function(e){ if(dragging) onMove(e.clientX); });
window.addEventListener('mouseup', endDrag);
divider.addEventListener('touchstart', function(e){ startDrag(e.touches[0]); }, {passive:false});
window.addEventListener('touchmove', function(e){ if(dragging) onMove(e.touches[0].clientX); }, {passive:false});
window.addEventListener('touchend', endDrag);
// Highlight toolbar
var selbar = document.getElementById('selbar');
var btnHL = document.getElementById('btnHL');
var btnUH = document.getElementById('btnUH');
var btnNote = document.getElementById('btnNote');
var lastRange=null;
var currentHlNode=null;
var keepToolbar=false;
function positionSelbarForRect(rect){
  selbar.style.display='flex';
  requestAnimationFrame(function(){
    var top = window.scrollY + rect.top - selbar.offsetHeight - 8;
    var leftPos = window.scrollX + rect.left + rect.width/2 - selbar.offsetWidth/2;
    selbar.style.top = ((top>0)?top:(window.scrollY + rect.bottom + 8)) + 'px';
    selbar.style.left = Math.max(8, leftPos) + 'px';
  });
}
function updateSelbar(){
  var sel=window.getSelection();
  if(!sel || sel.rangeCount===0 || sel.isCollapsed) { 
    selbar.style.display='none'; 
    currentHlNode=null; 
    return; 
  }
  var range = sel.getRangeAt(0);
  lastRange = range.cloneRange();
  currentHlNode=null;
  positionSelbarForRect(range.getBoundingClientRect());
}
document.getElementById('left').addEventListener('mouseup', updateSelbar);
document.getElementById('right').addEventListener('mouseup', updateSelbar);
document.addEventListener('selectionchange', function(){ 
  var sel=window.getSelection(); 
  if(!sel || sel.rangeCount===0 || sel.isCollapsed){ 
    if(!keepToolbar && !currentHlNode){ 
      selbar.style.display='none'; 
    } 
  } 
});
document.addEventListener('scroll', function(){ 
  if(selbar.style.display==='flex') updateSelbar(); 
});
document.addEventListener('mousedown', function(e){
  var t = e.target;
  if(t.classList && t.classList.contains('hl')){
    keepToolbar = true;
  } else {
    keepToolbar = false;
  }
}, true);
document.addEventListener('click', function(e){
  var target = e.target;
  if(target.classList && target.classList.contains('hl')){
    currentHlNode = target;
    lastRange = null;
    positionSelbarForRect(target.getBoundingClientRect());
    var sel=window.getSelection();
    if(sel) sel.removeAllRanges();
    setTimeout(function(){ keepToolbar=false; }, 0);
  }
}, true);
function doHighlight(){
  if(currentHlNode) return;
  if(!lastRange || lastRange.collapsed) return;
  var span=document.createElement('span'); span.className='hl';
  try { lastRange.surroundContents(span); }
  catch(e){
    var wrap=document.createElement('span'); wrap.className='hl';
    wrap.appendChild(lastRange.cloneContents());
    lastRange.deleteContents();
    lastRange.insertNode(wrap);
  }
  selbar.style.display='none';
  showToast('Highlighted');
}
function removeHighlight(){
  if(currentHlNode){
    var p = currentHlNode.parentNode;
    while(currentHlNode.firstChild) p.insertBefore(currentHlNode.firstChild, currentHlNode);
    p.removeChild(currentHlNode); p.normalize();
    currentHlNode = null;
    selbar.style.display='none';
    showToast('Highlight removed');
    return;
  }
  if(!lastRange) return;
  var selRect = lastRange.getBoundingClientRect();
  var walker=document.createTreeWalker(document.body, NodeFilter.SHOW_ELEMENT);
  var toRemove=[];
  while(walker.nextNode()){
    var n=walker.currentNode;
    if(n.classList && n.classList.contains('hl')) {
      var r = n.getBoundingClientRect();
      if(!(r.right < selRect.left || r.left > selRect.right || r.bottom < selRect.top || r.top > selRect.bottom)) toRemove.push(n);
    }
  }
  toRemove.forEach(function(el){ var p=el.parentNode; while(el.firstChild) p.insertBefore(el.firstChild, el); p.removeChild(el); p.normalize(); });
  selbar.style.display='none';
  showToast('Highlight removed');
}
btnHL.addEventListener('click', doHighlight);
btnUH.addEventListener('click', removeHighlight);
// Notes
var notes = document.getElementById('notes');
var noteArea = document.getElementById('noteArea');
var btnCopy=document.getElementById('btnCopy');
var btnClose=document.getElementById('btnClose');
function toggleNotes(){ 
  notes.style.display = (notes.style.display==='flex'?'none':'flex'); 
}
window.toggleNotes = toggleNotes;
btnClose.addEventListener('click', toggleNotes);
btnCopy.addEventListener('click', async function(){ 
  await navigator.clipboard.writeText(noteArea.value||''); 
  showToast('Copied'); 
});
btnNote.addEventListener('click', function(){
  var text = '';
  if(currentHlNode){ text = (currentHlNode.textContent||'').trim(); }
  else if(lastRange){ var frag = lastRange.cloneContents(); text = (frag.textContent||'').trim(); }
  toggleNotes();
  if(text) noteArea.value = (noteArea.value? noteArea.value+'\n':'') + '> ' + text + '\n';
  selbar.style.display='none';
});
// Toast
var toastEl=document.getElementById('toast');
function showToast(msg){
  toastEl.textContent=msg; 
  toastEl.style.display='block';
  setTimeout(function(){ toastEl.style.display='none'; }, 1200);
}
// Answer key and grading
var answers = {
  q27: "A", q28: "C", q29: "D", q30: "A", q31: "B",
  q32: "NO", q33: "YES", q34: "NOT GIVEN", q35: "YES",
  q36: "B", q37: "G", q38: "A", q39: "D", q40: "C"
};
function grade(){
  var total=0, correct=0, lines=[];
  function push(q, ok, user){
    total++; if(ok) correct++;
    lines.push(q.toUpperCase()+": "+(user||'None')+" "+(ok?'✅':'❌'));
  }
  
  for(var n=27;n<=40;n++){
      var qName = 'q' + n;
      var radios = document.querySelectorAll('input[name="'+qName+'"]');
      var textInput = document.querySelector('input[name="'+qName+'"].blank');
      var val = '';
      var isCorrect = false;

      if(radios.length > 0) { // Radio button questions
          var sel = document.querySelector('input[name="'+qName+'"]:checked');
          val = sel ? sel.value : '';
          isCorrect = val.toUpperCase() === answers[qName].toUpperCase();
      } else if (textInput) { // Text input questions
          val = textInput.value.trim().toUpperCase();
          isCorrect = val === answers[qName];
      }
      push(qName, isCorrect, val);
  }
  
  var acc = (total? Math.round(100*correct/total):0);
  var html = '<p><strong>Score:</strong> '+correct+'/'+total+' <span class="badge">Accuracy '+acc+'%</span></p>';
  html += '<pre>'+lines.join('\n')+'</pre>';
  document.getElementById('results').innerHTML = html;
  
  var ahtml = '<ol start="27">';
  for(var i=27; i<=40; i++){
    ahtml += '<li>' + answers['q'+i] + '</li>';
  }
  ahtml += '</ol>';
  document.getElementById('answerContent').innerHTML = ahtml;
  document.querySelector('#answerBox .badge').textContent='tap to view';
}
function resetForm(){
  document.querySelectorAll('input[type="radio"]').forEach(el=>el.checked=false);
  document.querySelectorAll('input[type="text"]').forEach(el=>el.value="");
  document.getElementById('results').innerHTML='';
  document.getElementById('answerContent').innerHTML='';
  document.querySelector('#answerBox .badge').textContent = 'hidden';
  document.querySelectorAll('.q-item').forEach(item => item.classList.remove('answered'));
}
function scrollToElement(id){
  var el = document.getElementById(id);
  if(el){ 
    el.scrollIntoView({behavior:'smooth', block:'center'}); 
  }
  var navs = document.querySelectorAll('.practice-nav .q-item');
  navs.forEach(n => n.classList.remove('active'));
  var btn = document.getElementById(id.replace('-anchor','-nav'));
  if(btn){ 
    btn.classList.add('active'); 
    setTimeout(() => btn.classList.remove('active'), 800); 
  }
}
(function(){
  function mark(qn){
    var nav = document.getElementById('q'+qn+'-nav');
    if(!nav) return;
    
    var answered = false;
    var radios = document.querySelectorAll(`input[name="q${qn}"]`);
    var text = document.querySelector(`input[name="q${qn}"].blank`);
    
    if (radios.length > 0) {
      radios.forEach(function(r){ if(r.checked) answered=true; });
    }
    if (text) {
      answered = answered || (text.value && text.value.trim().length > 0);
    }

    if(answered) nav.classList.add('answered'); else nav.classList.remove('answered');
  }
  for(var q=27;q<=40;q++){
    (function(n){
      document.querySelectorAll(`input[name="q${n}"]`).forEach(function(r){ r.addEventListener('change', function(){ mark(n); }); });
      var text = document.querySelector(`input[name="q${n}"].blank`);
      if(text){ text.addEventListener('input', function(){ mark(n); }); }
    })(q);
  }
})();
</script>

<!-- 练习页面数据传输增强脚本 -->
<script>
if (!window.practicePageEnhancer) {
    const script = document.createElement('script');
    script.src = '../../js/practice-page-enhancer.js';
    script.onload = function() { console.log('练习页面增强脚本已加载'); };
    script.onerror = function() { console.error('练习页面增强脚本加载失败'); loadInlineEnhancer(); };
    document.head.appendChild(script);
}
function loadInlineEnhancer() {
    if (window.practicePageEnhancer) return;
    window.practicePageEnhancer = {
        initialize: function() {
            this.setupCommunication();
            this.setupAnswerListeners();
            this.interceptSubmit();
        },
        setupCommunication: function() {
            this.parentWindow = window.opener || window.parent;
            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'INIT_SESSION') {
                    this.sessionId = event.data.data.sessionId;
                    this.sendMessage('SESSION_READY', { pageType: this.detectPageType(), url: window.location.href });
                }
            });
        },
        detectPageType: function() {
            const title = document.title || '';
            if (title.includes('P1')) return 'P1';
            if (title.includes('P2')) return 'P2';
            if (title.includes('P3')) return 'P3';
            return 'unknown';
        },
        setupAnswerListeners: function() {
            this.answers = {};
            this.startTime = Date.now();
            document.addEventListener('change', (e) => {
                if (e.target.name) {
                    this.answers[e.target.name] = e.target.value;
                }
            });
             document.addEventListener('input', (e) => {
                if (e.target.name && e.target.classList.contains('blank')) {
                    this.answers[e.target.name] = e.target.value;
                }
            });
        },
        interceptSubmit: function() {
            if (typeof window.grade === 'function') {
                const originalGrade = window.grade;
                window.grade = () => {
                    const result = originalGrade();
                    setTimeout(() => this.handleSubmit(), 200);
                    return result;
                };
            }
        },
        handleSubmit: function() {
            const results = {
                sessionId: this.sessionId,
                startTime: this.startTime,
                endTime: Date.now(),
                duration: Math.round((Date.now() - this.startTime) / 1000),
                answers: this.answers,
                scoreInfo: this.extractScore(),
                pageType: this.detectPageType(),
                url: window.location.href
            };
            this.sendMessage('PRACTICE_COMPLETE', results);
        },
        extractScore: function() {
            const resultsEl = document.getElementById('results');
            if (!resultsEl) return null;
            const text = resultsEl.textContent || '';
            const scoreMatch = text.match(/Score:\s*(\d+)\/(\d+)/i);
            if (scoreMatch) {
                const correct = parseInt(scoreMatch[1]);
                const total = parseInt(scoreMatch[2]);
                return { correct: correct, total: total, accuracy: total > 0 ? correct / total : 0, percentage: Math.round((correct / total) * 100), source: 'inline_extraction' };
            }
            return null;
        },
        sendMessage: function(type, data) {
            if (this.parentWindow) {
                this.parentWindow.postMessage({ type: type, data: data, source: 'practice_page' }, '*');
            }
        }
    };
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => { window.practicePageEnhancer.initialize(); });
    } else {
        window.practicePageEnhancer.initialize();
    }
}
</script>

</body>
</html>