<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Charles Darwin and Evolutionary Psychology</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<style>
  :root { --line:#e5e7eb; --bg:#f6f7fb; --panel:#fff; --accent:#3b82f6; --muted:#6b7280; --shadow:0 6px 20px rgba(0,0,0,.12); }
  * { box-sizing: border-box; }
  html,body { height:100%; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); }
  #timer { position: static; display: inline-block; margin-left: 8px; background:#fff; border:1px solid var(--line); border-radius:10px; padding:2px 8px; font-size:14px; vertical-align: middle; }
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:var(--panel); overflow:auto; padding:20px; }
  #left { flex: 0 0 50%; min-width: 280px; }
  #right { flex: 1 1 auto; min-width: 320px; background:#fbfbff; border-left:1px solid var(--line); }
  #divider { flex: 0 0 8px; background: linear-gradient(90deg,#e5e7eb,#d1d5db); cursor: ew-resize; position:relative; z-index: 5; user-select:none; }
  h2,h3,h4 { margin:0 0 10px; }
  #left p { margin: 0 0 12px; line-height: 1.6; word-break: normal; overflow-wrap: normal; hyphens: none; }
  .group { background:#fff; border:1px solid var(--line); border-radius:10px; padding:12px; margin-bottom:14px; }
  table { border-collapse: collapse; width:100%; }
  th, td { border:1px solid var(--line); padding:6px; text-align:center; font-size:14px; }
  th:first-child, td:first-child { width:92px; }
  button { padding:8px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; cursor:pointer; }
  button.primary { background:var(--accent); color:#fff; border-color:#3b82f6; }
  #results { background:#fff; border:1px solid var(--line); border-radius:10px; padding:10px; }
  .hl { background:#fff3a3; box-shadow: inset 0 -2px 0 rgba(0,0,0,.05); cursor: pointer; }
  .hl:hover { filter: brightness(0.98); }
  #selbar { position: absolute; display:none; z-index: 2000; background:#111; color:#fff; border-radius: 8px; padding: 6px; box-shadow: var(--shadow); font-size: 13px; gap:6px; align-items: center; }
  #selbar button { background: transparent; color:#fff; border: 1px solid rgba(255,255,255,.25); padding: 4px 8px; border-radius: 6px; cursor:pointer; }
  #selbar button:hover { border-color:#fff; }
  #notes { position: fixed; right: 12px; bottom: 12px; width: 320px; height: 42vh; background:#fff; border:1px solid var(--line); border-radius: 12px; display:none; flex-direction: column; z-index:1500; box-shadow: var(--shadow); }
  #notes header { display:flex; align-items:center; justify-content: space-between; padding:8px 10px; border-bottom:1px solid var(--line); }
  #notes textarea { flex:1; border:0; padding:10px; resize:none; font-size:14px; line-height:1.5; }
  #toast { position: fixed; left:50%; transform: translateX(-50%); bottom: 24px; background:#111; color:#fff; padding:8px 12px; border-radius: 8px; display:none; z-index:2500; }
  .dropzone { border:2px dashed #cbd5e1; background:#f8fafc; border-radius:10px; min-height:40px; padding:4px 8px; display:inline-flex; align-items:center; justify-content:space-between; gap:8px; width: auto; min-width: 120px; max-width: 200px; vertical-align: middle; }
  .droplabel { color:#64748b; font-size:14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .cardpool { background:#f1f5f9; border-radius:10px; padding:12px; display:flex; flex-wrap:wrap; gap:8px; }
  .pool-slot { min-height:40px; }
  .card { background:#fff; border:1px solid #e5e7eb; border-radius:8px; padding:8px 10px; display:inline-flex; gap:8px; align-items:center; cursor:grab; box-shadow:0 1px 0 rgba(0,0,0,.03); white-space: nowrap; }
  .card:active { cursor:grabbing; }
  .tag { background:#eef2ff; color:#4338ca; padding:2px 8px; border-radius:999px; font-size:12px; }
  .btn-clear { border:1px solid #e5e7eb; background:#fff; border-radius:8px; padding:6px 8px; cursor:pointer; }
  .ghost { opacity: .5; }
  .over { outline:2px dashed #3b82f6; }
  details.answerbox summary { cursor: pointer; user-select:none; list-style: none; }
  details.answerbox { border:1px dashed var(--line); border-radius:10px; padding:8px 10px; background:#fff; }
  .badge { display:inline-block; background:#eef2ff; color:#4338ca; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:6px; }
  body { padding-bottom: 82px; }
  .practice-nav { background:#fff; border-bottom:2px solid var(--line); padding:12px 20px; display:flex; align-items:center; gap:20px; box-shadow:0 2px 4px rgba(0,0,0,.05); flex-wrap:wrap; position:fixed; left:0; right:0; bottom:0; border-top:2px solid var(--line); border-bottom:0; z-index:4000; }
  .practice-nav .title { font-weight:600; color:var(--muted); }
  .practice-nav .questions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .practice-nav .q-item { padding:6px 10px; border:1px solid var(--line); border-radius:6px; background:#fff; cursor:pointer; font-size:14px; transition:all 0.2s; min-width:36px; text-align:center; }
  .practice-nav .q-item:hover { background:#f1f5f9; border-color:var(--accent); }
  .practice-nav .q-item.answered { background:#e0e7ff; border-color:var(--accent); color:var(--accent); font-weight:500; }
  .practice-nav .q-item.active { background:var(--accent); color:#fff; border-color:var(--accent); }
  #selbar { z-index: 6000 !important; }
</style>
</head>
<body>
<div class="practice-nav">
  <div class="title">Questions</div>
  <div class="questions">
    <div class="q-item" id="q27-nav" onclick="scrollToElement('q27-anchor')">27</div>
    <div class="q-item" id="q28-nav" onclick="scrollToElement('q28-anchor')">28</div>
    <div class="q-item" id="q29-nav" onclick="scrollToElement('q29-anchor')">29</div>
    <div class="q-item" id="q30-nav" onclick="scrollToElement('q30-anchor')">30</div>
    <div class="q-item" id="q31-nav" onclick="scrollToElement('q31-anchor')">31</div>
    <div class="q-item" id="q32-nav" onclick="scrollToElement('q32-anchor')">32</div>
    <div class="q-item" id="q33-nav" onclick="scrollToElement('q33-anchor')">33</div>
    <div class="q-item" id="q34-nav" onclick="scrollToElement('q34-anchor')">34</div>
    <div class="q-item" id="q35-nav" onclick="scrollToElement('q35-anchor')">35</div>
    <div class="q-item" id="q36-nav" onclick="scrollToElement('q36-anchor')">36</div>
    <div class="q-item" id="q37-nav" onclick="scrollToElement('q37-anchor')">37</div>
    <div class="q-item" id="q38-nav" onclick="scrollToElement('q38-anchor')">38</div>
    <div class="q-item" id="q39-nav" onclick="scrollToElement('q39-anchor')">39</div>
    <div class="q-item" id="q40-nav" onclick="scrollToElement('q40-anchor')">40</div>
  </div>
</div>
<div class="shell">
  <section class="pane" id="left">
    <h2>READING PASSAGE 3 <span id="timer">00:00</span></h2>
    <p>You should spend about 20 minutes on Questions 27–40, which are based on Reading Passage 3 below.</p>
    <h3>Charles Darwin and Evolutionary Psychology</h3>
    
    <p>Charles Darwin, the brilliant anthropologist and creator of the theory of evolution, is not normally associated with the modern business world. Nevertheless, Darwinian evolutionary theory is the foundation of a new wave of ideas about human behaviour in general and particularly the way people behave in the workplace; these ideas have given the title of ‘evolutionary psychology’. Evolutionary psychology revolves around the notion that our brains, like our bodies, have an inherited evolutionary design that has scarcely changed for 10,000 years. As respected evolutionary psychology experts Leda Cosmides and John Tooby comment, ‘our modern skulls house a Stone Age mind’. The US biologist Edward O. Wilson sees evolutionary psychology as being a discipline which is based on both sociobiology, which is the study of the biological basis of social behaviour, and psychology, which is the systematic study of human behaviour.</p>
    
    <p>Nigel Nicholson, an organisational psychologist from the London Business School, is a strong supporter of evolutionary psychology and on this subject has published Managing the Human Animal. His book takes the reader on a journey from the Stone Age plains of the savannah to the modern office, and includes a discussion of Darwinism and behavioural psychology, together with a dissection of dysfunctional organisational behaviour. It is an effective approach explaining why people behave as they do, particularly at work. Evolutionary psychology is increasingly being cited in management circles, where managers are trying to understand puzzling aspects of human behaviour and, by doing so, improve the workplace. Nicholson believes that evolutionary psychology can help managers understand what goes wrong in organisational life and what they can do about it.</p>
    
    <p>Nicholson maintains that evolutionary psychology dismisses the long-held assumption that our minds are like blank pages just waiting for culture and experience to write on them and shape our nature. He points out that sophisticated research shows the brain actually houses a store of knowledge when we are born, and now genetic research is establishing there are certain genes that account for abilities, tastes and tendencies. The stored knowledge in the human brain has not changed much since the Stone Age. As Tooby and Cosmides stress, there have not been enough generations for a brain that is well-adapted to our post-industrial life to evolve through natural selection.</p>
    
    <p>The evolutionary psychology version of human nature revolves around some key elements which we have inherited from our hunter-gatherer minds. One key element is emotion. Emotion was originally essential to keep early man alive and safe from predators. Emotion was, and continues to be, our radar, guiding us throughout today’s techno-defined business world. Despite this, the business world emphasises rational, not emotional, behaviour, and does not admit the importance of emotion. We still use the emotional part of our minds to make sense of other people’s behaviour and to create an impression, so we can often be taken in by appearances. This mental predisposition actually works best in small communities (the tribe), not in much larger environments filled with people we barely know (the modern workplace). Our minds naturally try to re-create our ancestral communities with networks of no more than 150 people, where there are clear hierarchies and leaders. As a consequence, it takes very little to trigger people’s innate distrust of others because our safety in antiquity depended on supporting our near family and friends, whom we valued more than other people.</p>
    
    <p>So what advice does Nicholson have for the corporate world? He thinks that by knowing the reasons for people’s behaviour it is possible to mould corporate environments into places that have more chance of working efficiently and being pleasant places to work in. Nicholson admits that not everybody in the business world agrees with his belief in the effectiveness of evolutionary psychology in the workplace. One group that resists the theory of evolutionary psychology is young MBA graduates who are just beginning their careers and feel that evolutionary psychology will make their lives at work more difficult. Older and wiser executives point out that they still tend to cling to the idea of a magic formula to bring people into line with corporate strategy. But that is back-to-front thinking, according to Nicholson, who contends that we should be reinventing our business structures, not our fundamental human nature.</p>
    
    <p>At the end of his book, Nicholson gives his forecast of what will and will not change in the business world. He believes that most people will still prefer more traditional forms of work and throughout their lives will continue to aim at lifelong status advancement. He also maintains that the line between work and home will be less defined, but that people will prefer traditional working patterns if working from home leaves them isolated from their work community. He doubts that the high-tech ideas of virtual companies will ever be very successful because people will still want to meet each other face-to-face. Nicholson describes his ideal organisation in the future: it would be decentralised, with small subunits; the staff would be from diverse backgrounds and be allowed a high degree of selfdetermination. New endeavours and creativity would replace systems and rationality. Nicholson acknowledges that there is a long way to go in terms of the translation of his ideas of evolutionary psychology into practical propositions, but he is confident more and more people will come round to his way of thinking.</p>
    
    <p>&nbsp;</p> <!-- 添加空白行防止加载不完全 -->
  </section>
  <div id="divider" title="Drag to resize"></div>
  <section class="pane" id="right">
    <h3>Questions</h3>
    
    <div class="group">
      <h4>Questions 27–31</h4>
      <p>Choose the correct letter, A, B, C or D.</p>
      <p>Write the correct letter in boxes 27–31 on your answer sheet.</p>
      
      <a id="q27-anchor"></a>
      <div id="q27-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>27 The writer’s purpose in the first paragraph is to</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q27" type="radio" value="A"> A oppose the views of Charles Darwin.</label>
          <label style="margin:0;"><input name="q27" type="radio" value="B"> B compare experts’ opinions of Darwin’s theory.</label>
          <label style="margin:0;"><input name="q27" type="radio" value="C"> C explain the theory of evolutionary psychology.</label>
          <label style="margin:0;"><input name="q27" type="radio" value="D"> D name experts in the field of evolutionary psychology.</label>
        </div>
      </div>
      
      <a id="q28-anchor"></a>
      <div id="q28-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>28 In the third paragraph, which view about evolutionary psychology matches Nicholson’s opinion?</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q28" type="radio" value="A"> A Our characters determine our career choices.</label>
          <label style="margin:0;"><input name="q28" type="radio" value="B"> B We begin life without any preconceived notions.</label>
          <label style="margin:0;"><input name="q28" type="radio" value="C"> C Our interests and skills depend on our environment.</label>
          <label style="margin:0;"><input name="q28" type="radio" value="D"> D We inherit ideas and characteristics from our ancestors.</label>
        </div>
      </div>
      
      <a id="q29-anchor"></a>
      <div id="q29-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>29 The writer discusses the key element of emotion in order to</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q29" type="radio" value="A"> A criticise primitive survival strategies.</label>
          <label style="margin:0;"><input name="q29" type="radio" value="B"> B explain attitudes and actions at work.</label>
          <label style="margin:0;"><input name="q29" type="radio" value="C"> C demonstrate the slowness of evolution.</label>
          <label style="margin:0;"><input name="q29" type="radio" value="D"> D suggest companies today are poorly structured.</label>
        </div>
      </div>
      
      <a id="q30-anchor"></a>
      <div id="q30-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>30 Which of the following does Nicholson predict will happen in the business world?</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q30" type="radio" value="A"> A Companies will remain in city centres.</label>
          <label style="margin:0;"><input name="q30" type="radio" value="B"> B Promotion will no longer motivate people.</label>
          <label style="margin:0;"><input name="q30" type="radio" value="C"> C Employees will be less independent than now.</label>
          <label style="margin:0;"><input name="q30" type="radio" value="D"> D Social interaction will remain important to workers.</label>
        </div>
      </div>
      
      <a id="q31-anchor"></a>
      <div id="q31-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>31 Which of the following is the most suitable title for Reading Passage 3?</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q31" type="radio" value="A"> A How successful companies manage change.</label>
          <label style="margin:0;"><input name="q31" type="radio" value="B"> B Understanding the origins of workplace behaviour.</label>
          <label style="margin:0;"><input name="q31" type="radio" value="C"> C Darwin’s theories rejected by modern management.</label>
          <label style="margin:0;"><input name="q31" type="radio" value="D"> D Why post-industrial organisations need to evolve more quickly.</label>
        </div>
      </div>
    </div>
    
    <div class="group">
      <h4>Questions 32–35</h4>
      <p>Do the following statements agree with the information given in Reading Passage 3?</p>
      <p>In boxes 32–35 on your answer sheet, write</p>
      <ul>
        <li>YES if the statement agrees with the views of the writer</li>
        <li>NO if the statement contradicts the views of the writer</li>
        <li>NOT GIVEN if it is impossible to say what the writer thinks about this</li>
      </ul>
      
      <a id="q32-anchor"></a>
      <div id="q32-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>32 Nicholson makes a persuasive argument in his book.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q32" type="radio" value="YES"> YES</label>
          <label style="margin:0;"><input name="q32" type="radio" value="NO"> NO</label>
          <label style="margin:0;"><input name="q32" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <a id="q33-anchor"></a>
      <div id="q33-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>33 Tooby and Cosmides believe natural selection through the generations has prepared us for modern times.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q33" type="radio" value="YES"> YES</label>
          <label style="margin:0;"><input name="q33" type="radio" value="NO"> NO</label>
          <label style="margin:0;"><input name="q33" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <a id="q34-anchor"></a>
      <div id="q34-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>34 Our reliance on technology causes emotional problems in the workplace.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q34" type="radio" value="YES"> YES</label>
          <label style="margin:0;"><input name="q34" type="radio" value="NO"> NO</label>
          <label style="margin:0;"><input name="q34" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <a id="q35-anchor"></a>
      <div id="q35-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>35 People today are more trusting than they used to be.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q35" type="radio" value="YES"> YES</label>
          <label style="margin:0;"><input name="q35" type="radio" value="NO"> NO</label>
          <label style="margin:0;"><input name="q35" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
    </div>
    
    <div class="group">
      <h4>Questions 36–40</h4>
      <p>Complete the summary using the list of words, A–I, below.</p>
      <p>Write the correct letter, A–I, in boxes 36–40 on your answer sheet.</p>
      
      <p>Nicholson’s advice to the corporate world</p>
      <p>Nicholson believes that if we know why people act the way they do, we can change
      <a id="q36-anchor"></a><div class="dropzone" data-target="q36"><span class="droplabel">Drag answer here</span></div> so employees will work more efficiently. Nicholson’s ideas are unwelcome to
      <a id="q37-anchor"></a><div class="dropzone" data-target="q37"><span class="droplabel">Drag answer here</span></div>, but some executives are more open to what evolutionary psychology says.
      However, these executives still believe that there is a <a id="q38-anchor"></a><div class="dropzone" data-target="q38"><span class="droplabel">Drag answer here</span></div> that will make employees act according to the company’s practices. According to Nicholson, these senior executives are engaging in <a id="q39-anchor"></a><div class="dropzone" data-target="q39"><span class="droplabel">Drag answer here</span></div>, and we should not try to change
      <a id="q40-anchor"></a><div class="dropzone" data-target="q40"><span class="droplabel">Drag answer here</span></div> but instead we should change our business structures.</p>
      
      <div class="cardpool">
        <div class="card" draggable="true" data-value="A">A business leaders</div>
        <div class="card" draggable="true" data-value="B">B MBA graduates</div>
        <div class="card" draggable="true" data-value="C">C promotion structures</div>
        <div class="card" draggable="true" data-value="D">D reward strategy</div>
        <div class="card" draggable="true" data-value="E">E magic formula</div>
        <div class="card" draggable="true" data-value="F">F strategic planning</div>
        <div class="card" draggable="true" data-value="G">G back-to-front thinking</div>
        <div class="card" draggable="true" data-value="H">H business environments</div>
        <div class="card" draggable="true" data-value="I">I human nature</div>
      </div>
    </div>
    
    <div style="display:flex;gap:8px;margin-bottom:10px;">
      <button class="primary" onclick="grade()">Submit</button>
      <button onclick="resetForm()">Reset</button>
      <button onclick="toggleNotes()">Notes</button>
    </div>
    <div id="results"></div>
    <details class="answerbox" id="answerBox">
      <summary>Show answers (click to toggle) <span class="badge">hidden</span></summary>
      <div id="answerContent"></div>
    </details>
  </section>
</div>
<div aria-label="Selection tools" id="selbar" role="toolbar">
  <button id="btnHL">Highlight</button>
  <button id="btnUH">Remove</button>
  <button id="btnNote">Note</button>
</div>
<div id="notes">
  <header>
    <strong>Notes</strong>
    <div>
      <button id="btnCopy">Copy</button>
      <button id="btnClose">Close</button>
    </div>
  </header>
  <textarea id="noteArea" placeholder="Type your notes here..."></textarea>
</div>
<div id="toast"></div>
<script>
// Timer
let _t=0; const _timerEl=document.getElementById('timer');
setInterval(function(){ 
  _t++; 
  var m=String(Math.floor(_t/60)).padStart(2,'0'); 
  var s=String(_t%60).padStart(2,'0'); 
  _timerEl.textContent=m+':'+s; 
},1000);
// Drag divider
var divider = document.getElementById('divider');
var left = document.getElementById('left');
var right = document.getElementById('right');
var dragging=false;
function startDrag(e){ 
  dragging=true; 
  document.body.style.cursor='ew-resize'; 
  if(e.preventDefault) e.preventDefault(); 
}
function endDrag(){ 
  dragging=false; 
  document.body.style.cursor=''; 
}
function onMove(clientX){
  var container = document.querySelector('.shell').getBoundingClientRect();
  var x = clientX - container.left;
  x = Math.max(280, Math.min(container.width-320, x));
  left.style.flex = '0 0 ' + x + 'px';
  right.style.flex = '1 1 auto';
}
divider.addEventListener('mousedown', function(e){ startDrag(e); });
window.addEventListener('mousemove', function(e){ if(dragging) onMove(e.clientX); });
window.addEventListener('mouseup', endDrag);
divider.addEventListener('touchstart', function(e){ startDrag(e.touches[0]); }, {passive:false});
window.addEventListener('touchmove', function(e){ if(dragging) onMove(e.touches[0].clientX); }, {passive:false});
window.addEventListener('touchend', endDrag);
</script>
<script>
// Highlight toolbar
var selbar = document.getElementById('selbar');
var btnHL = document.getElementById('btnHL');
var btnUH = document.getElementById('btnUH');
var btnNote = document.getElementById('btnNote');
var lastRange=null;
var currentHlNode=null;
var keepToolbar=false;
function positionSelbarForRect(rect){
  selbar.style.display='flex';
  requestAnimationFrame(function(){
    var top = window.scrollY + rect.top - selbar.offsetHeight - 8;
    var leftPos = window.scrollX + rect.left + rect.width/2 - selbar.offsetWidth/2;
    selbar.style.top = ((top>0)?top:(window.scrollY + rect.bottom + 8)) + 'px';
    selbar.style.left = Math.max(8, leftPos) + 'px';
  });
}
function updateSelbar(){
  var sel=window.getSelection();
  if(!sel || sel.rangeCount===0 || sel.isCollapsed) { 
    selbar.style.display='none'; 
    currentHlNode=null; 
    return; 
  }
  var range = sel.getRangeAt(0);
  lastRange = range.cloneRange();
  currentHlNode=null;
  positionSelbarForRect(range.getBoundingClientRect());
}
document.getElementById('left').addEventListener('mouseup', updateSelbar);
document.getElementById('right').addEventListener('mouseup', updateSelbar);
document.addEventListener('selectionchange', function(){ 
  var sel=window.getSelection(); 
  if(!sel || sel.rangeCount===0 || sel.isCollapsed){ 
    if(!keepToolbar && !currentHlNode){ 
      selbar.style.display='none'; 
    } 
  } 
});
document.addEventListener('scroll', function(){ 
  if(selbar.style.display==='flex') updateSelbar(); 
});
document.addEventListener('mousedown', function(e){
  var t = e.target;
  if(t.classList && t.classList.contains('hl')){
    keepToolbar = true;
  } else {
    keepToolbar = false;
  }
}, true);
document.addEventListener('click', function(e){
  var target = e.target;
  if(target.classList && target.classList.contains('hl')){
    currentHlNode = target;
    lastRange = null;
    positionSelbarForRect(target.getBoundingClientRect());
    var sel=window.getSelection();
    if(sel) sel.removeAllRanges();
    setTimeout(function(){ keepToolbar=false; }, 0);
  }
}, true);
function doHighlight(){
  if(currentHlNode) return;
  if(!lastRange || lastRange.collapsed) return;
  
  // 处理简单选择（同一节点内）
  if (lastRange.startContainer === lastRange.endContainer) {
    try {
      const span = document.createElement('span');
      span.className = 'hl';
      lastRange.surroundContents(span);
      selbar.style.display = 'none';
      showToast('Highlighted');
      return;
    } catch (e) {
      // 处理边界情况
    }
  }
  
  // 处理复杂选择（跨多个节点）
  const fragment = lastRange.cloneContents();
  const div = document.createElement('div');
  div.appendChild(fragment);
  
  // 递归处理所有文本节点并添加高亮
  function processNode(node, parentHighlight) {
    if (node.nodeType === Node.TEXT_NODE) {
      if (node.textContent.trim().length > 0) {
        const span = document.createElement('span');
        span.className = 'hl';
        span.textContent = node.textContent;
        return span;
      }
      return node;
    }
    
    if (node.nodeType === Node.ELEMENT_NODE) {
      // 对于块级元素，创建新的块级高亮容器
      const isBlock = window.getComputedStyle(node).display.includes('block') || 
                     ['P', 'H1', 'H2', 'H3', 'H4', 'DIV'].includes(node.tagName);
      
      const wrapper = isBlock ? document.createElement(node.tagName.toLowerCase()) : document.createElement('span');
      wrapper.className = isBlock ? node.className + ' hl' : 'hl';
      
      // 复制其他属性
      Array.from(node.attributes).forEach(attr => {
        wrapper.setAttribute(attr.name, attr.value);
      });
      
      // 处理子节点
      while (node.firstChild) {
        const processedChild = processNode(node.firstChild, wrapper);
        wrapper.appendChild(processedChild);
      }
      
      return wrapper;
    }
    
    return node;
  }
  
  // 处理所有内容
  const highlightedContent = processNode(div, null);
  
  // 清除原有内容并插入高亮内容
  lastRange.deleteContents();
  lastRange.insertNode(highlightedContent);
  
  selbar.style.display = 'none';
  showToast('Highlighted');
}
function removeHighlight(){
  if(currentHlNode){
    // 移除单个高亮元素
    const parent = currentHlNode.parentNode;
    while(currentHlNode.firstChild) {
      parent.insertBefore(currentHlNode.firstChild, currentHlNode);
    }
    parent.removeChild(currentHlNode);
    parent.normalize(); // 合并相邻文本节点
    currentHlNode = null;
    selbar.style.display='none';
    showToast('Highlight removed');
    return;
  }
  
  if(!lastRange) return;
  
  // 移除选区中的所有高亮
  const selRect = lastRange.getBoundingClientRect();
  const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_ELEMENT);
  const toRemove = [];
  
  while(walker.nextNode()){
    const node = walker.currentNode;
    if(node.classList && node.classList.contains('hl')) {
      const rect = node.getBoundingClientRect();
      // 检查节点是否与选区重叠
      if(!(rect.right < selRect.left || rect.left > selRect.right || 
          rect.bottom < selRect.top || rect.top > selRect.bottom)) {
        toRemove.push(node);
      }
    }
  }
  
  // 移除所有找到的高亮元素
  toRemove.forEach(el => {
    const parent = el.parentNode;
    while(el.firstChild) {
      parent.insertBefore(el.firstChild, el);
    }
    parent.removeChild(el);
    parent.normalize(); // 合并相邻文本节点
  });
  
  selbar.style.display='none';
  showToast('Highlight removed');
}
btnHL.addEventListener('click', doHighlight);
btnUH.addEventListener('click', removeHighlight);
</script>
<script>
// Notes
var notes = document.getElementById('notes');
var noteArea = document.getElementById('noteArea');
var btnCopy=document.getElementById('btnCopy');
var btnClose=document.getElementById('btnClose');
function toggleNotes(){ 
  notes.style.display = (notes.style.display==='flex'?'none':'flex'); 
}
window.toggleNotes = toggleNotes;
btnClose.addEventListener('click', toggleNotes);
btnCopy.addEventListener('click', async function(){ 
  await navigator.clipboard.writeText(noteArea.value||''); 
  showToast('Copied'); 
});
btnNote.addEventListener('click', function(){
  var text = '';
  if(currentHlNode){ 
    text = (currentHlNode.textContent||'').trim(); 
  } else if(lastRange){ 
    var frag = lastRange.cloneContents(); 
    text = (frag.textContent||'').trim(); 
  }
  toggleNotes();
  if(text) {
    noteArea.value = (noteArea.value? noteArea.value+'\n':'') + '> ' + text + '\n';
  }
  selbar.style.display='none';
});
// Toast
var toastEl=document.getElementById('toast');
function showToast(msg){
  toastEl.textContent=msg; 
  toastEl.style.display='block';
  setTimeout(function(){ toastEl.style.display='none'; }, 1200);
}
</script>
<script>
// Drag and drop for questions 36-40
const cards = document.querySelectorAll('.card');
const dropzones = document.querySelectorAll('.dropzone');
cards.forEach(card => {
  card.addEventListener('dragstart', () => {
    card.classList.add('dragging');
  });
  card.addEventListener('dragend', () => {
    card.classList.remove('dragging');
  });
});
dropzones.forEach(zone => {
  zone.addEventListener('dragover', e => {
    e.preventDefault();
    zone.classList.add('over');
  });
  
  zone.addEventListener('dragleave', () => {
    zone.classList.remove('over');
  });
  
  zone.addEventListener('drop', e => {
    e.preventDefault();
    zone.classList.remove('over');
    const draggingCard = document.querySelector('.dragging');
    if (draggingCard) {
      // 清除现有内容
      zone.innerHTML = '';
      zone.appendChild(draggingCard);
      // 标记为已回答
      const targetQ = zone.dataset.target;
      document.getElementById(targetQ + '-nav').classList.add('answered');
    }
  });
});
</script>
<script>
// Answer key and grading
var answers = {
  "q27":"C", "q28":"D", "q29":"B", "q30":"D", "q31":"B",
  "q32":"YES", "q33":"NO", "q34":"NOT GIVEN", "q35":"NOT GIVEN",
  "q36":"H", "q37":"B", "q38":"E", "q39":"G", "q40":"I"
};
function grade(){
  var total=0, correct=0, lines=[];
  
  // 检查单选题 (27-31, 32-35)
  for(let n=27; n<=35; n++){
    const q = `q${n}`;
    total++;
    const selected = document.querySelector(`input[name="${q}"]:checked`);
    const userAnswer = selected ? selected.value : '';
    const isCorrect = userAnswer === answers[q];
    if (isCorrect) correct++;
    lines.push(`${q.toUpperCase()}: ${userAnswer || 'None'} ${isCorrect ? '✓' : '✗'}`);
  }
  
  // 检查拖放题 (36-40)
  dropzones.forEach(zone => {
    const q = zone.dataset.target;
    total++;
    const selectedCard = zone.querySelector('.card');
    const userAnswer = selectedCard ? selectedCard.dataset.value : '';
    const isCorrect = userAnswer === answers[q];
    if (isCorrect) correct++;
    lines.push(`${q.toUpperCase()}: ${userAnswer || 'None'} ${isCorrect ? '✓' : '✗'}`);
  });
  
  // 显示结果
  const acc = Math.round(100 * correct / total);
  document.getElementById('results').innerHTML = `
    <p><strong>Score:</strong> ${correct}/${total} <span class="badge">Accuracy ${acc}%</span></p>
    <pre>${lines.join('\n')}</pre>
  `;
  
  // 显示答案
  document.getElementById('answerContent').innerHTML = `
    <ol>
      <li>27 → C</li>
      <li>28 → D</li>
      <li>29 → B</li>
      <li>30 → D</li>
      <li>31 → B</li>
      <li>32 → YES</li>
      <li>33 → NO</li>
      <li>34 → NOT GIVEN</li>
      <li>35 → NOT GIVEN</li>
      <li>36 → H (business environments)</li>
      <li>37 → B (MBA graduates)</li>
      <li>38 → E (magic formula)</li>
      <li>39 → G (back-to-front thinking)</li>
      <li>40 → I (human nature)</li>
    </ol>
  `;
  document.querySelector('#answerBox .badge').textContent = 'tap to view';
}
function resetForm(){
  // 重置拖放题
  dropzones.forEach(zone => {
    const card = zone.querySelector('.card');
    if (card) {
      document.querySelector('.cardpool').appendChild(card);
      zone.innerHTML = '<span class="droplabel">Drag answer here</span>';
    }
  });
  
  // 重置单选题
  document.querySelectorAll('input[type="radio"]').forEach(radio => {
    radio.checked = false;
  });
  
  // 重置结果和答案
  document.getElementById('results').innerHTML = '';
  document.getElementById('answerContent').innerHTML = '';
  document.querySelector('#answerBox .badge').textContent = 'hidden';
  
  // 重置导航栏的已回答状态
  document.querySelectorAll('.q-item').forEach(item => {
    item.classList.remove('answered');
  });
}
// 滚动到问题锚点
function scrollToElement(id){
  const el = document.getElementById(id);
  if(el){ 
    el.scrollIntoView({behavior:'smooth', block:'center'}); 
  }
  // 短暂高亮导航项
  const navs = document.querySelectorAll('.practice-nav .q-item');
  navs.forEach(n => n.classList.remove('active'));
  const btn = document.getElementById(id.replace('-anchor','-nav'));
  if(btn){ 
    btn.classList.add('active'); 
    setTimeout(() => btn.classList.remove('active'), 800); 
  }
}
// 监听交互并标记已回答
(function(){
  function markAnswered(qn){
    const nav = document.getElementById(`q${qn}-nav`);
    if(!nav) return;
    let answered = false;
    
    // 检查拖放区 (36-40)
    if(qn >=36 && qn <=40){
      const zone = document.querySelector(`.dropzone[data-target="q${qn}"]`);
      answered = zone.querySelector('.card') !== null;
    } 
    // 检查单选题 (27-31, 32-35)
    else {
      const radios = document.querySelectorAll(`input[name="q${qn}"]:checked`);
      answered = radios.length > 0;
    }
    
    if(answered) nav.classList.add('answered');
    else nav.classList.remove('answered');
  }
  
  // 监听拖放区
  dropzones.forEach(zone => {
    zone.addEventListener('drop', () => {
      const qn = zone.dataset.target.replace('q', '');
      markAnswered(qn);
    });
  });
  
  // 监听单选题
  for(let n=27; n<=35; n++){
    document.querySelectorAll(`input[name="q${n}"]`).forEach(radio => {
      radio.addEventListener('change', () => markAnswered(n));
    });
  }
})();
</script>

<!-- 练习页面数据传输增强脚本 -->
<script>
// 检查是否已经有增强脚本
if (!window.practicePageEnhancer) {
    // 动态加载增强脚本
    const script = document.createElement('script');
    script.src = '../../js/practice-page-enhancer.js';
    script.onload = function() {
        console.log('练习页面增强脚本已加载');
    };
    script.onerror = function() {
        console.error('练习页面增强脚本加载失败');
        // 降级到内联增强
        loadInlineEnhancer();
    };
    document.head.appendChild(script);
}

// 内联增强器（降级方案）
function loadInlineEnhancer() {
    if (window.practicePageEnhancer) return;
    
    window.practicePageEnhancer = {
        initialize: function() {
            console.log('[InlineEnhancer] 内联增强器已初始化');
            this.setupCommunication();
            this.setupAnswerListeners();
            this.interceptSubmit();
        },
        
        setupCommunication: function() {
            this.parentWindow = window.opener || window.parent;
            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'INIT_SESSION') {
                    this.sessionId = event.data.data.sessionId;
                    this.sendMessage('SESSION_READY', {
                        pageType: this.detectPageType(),
                        url: window.location.href
                    });
                }
            });
        },
        
        detectPageType: function() {
            const title = document.title || '';
            if (title.includes('P1')) return 'P1';
            if (title.includes('P2')) return 'P2';
            if (title.includes('P3')) return 'P3';
            return 'unknown';
        },
        
        setupAnswerListeners: function() {
            this.answers = {};
            this.startTime = Date.now();
            
            document.addEventListener('change', (e) => {
                if (e.target.name && e.target.name.startsWith('q')) {
                    this.answers[e.target.name] = e.target.value;
                }
            });
        },
        
        interceptSubmit: function() {
            // 拦截grade函数
            if (typeof window.grade === 'function') {
                const originalGrade = window.grade;
                window.grade = () => {
                    const result = originalGrade();
                    setTimeout(() => this.handleSubmit(), 200);
                    return result;
                };
            }
            
            // 监听提交按钮
            document.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' && 
                    (e.target.textContent.includes('Submit') || 
                     e.target.onclick && e.target.onclick.toString().includes('grade'))) {
                    setTimeout(() => this.handleSubmit(), 300);
                }
            });
        },
        
        handleSubmit: function() {
            const results = {
                sessionId: this.sessionId,
                startTime: this.startTime,
                endTime: Date.now(),
                duration: Math.round((Date.now() - this.startTime) / 1000),
                answers: this.answers,
                scoreInfo: this.extractScore(),
                pageType: this.detectPageType(),
                url: window.location.href
            };
            
            this.sendMessage('PRACTICE_COMPLETE', results);
        },
        
        extractScore: function() {
            const resultsEl = document.getElementById('results');
            if (!resultsEl) return null;
            
            const text = resultsEl.textContent || '';
            const scoreMatch = text.match(/Score:\s*(\d+)\/(\d+)/i);
            if (scoreMatch) {
                const correct = parseInt(scoreMatch[1]);
                const total = parseInt(scoreMatch[2]);
                return {
                    correct: correct,
                    total: total,
                    accuracy: total > 0 ? correct / total : 0,
                    percentage: Math.round((correct / total) * 100),
                    source: 'inline_extraction'
                };
            }
            return null;
        },
        
        sendMessage: function(type, data) {
            if (this.parentWindow) {
                this.parentWindow.postMessage({
                    type: type,
                    data: data,
                    source: 'practice_page'
                }, '*');
            }
        }
    };
    
    // 初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            window.practicePageEnhancer.initialize();
        });
    } else {
        window.practicePageEnhancer.initialize();
    }
}
</script>

</body>
</html>
