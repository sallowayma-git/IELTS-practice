<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P3 – The Pirahã people of Brazil</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root { --line:#e5e7eb; --bg:#f6f7fb; --panel:#fff; --accent:#3b82f6; --muted:#6b7280; --shadow:0 6px 20px rgba(0,0,0,.12); }
  * { box-sizing: border-box; }
  html,body { height:100%; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); padding-bottom: 82px; }
  #timer { position: static; display: inline-block; margin-left: 8px; background:#fff; border:1px solid var(--line); border-radius:10px; padding:2px 8px; font-size:14px; vertical-align: middle; }
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:var(--panel); overflow:auto; padding:20px; }
  #left { flex: 0 0 50%; min-width: 280px; }
  #right { flex: 1 1 auto; min-width: 320px; background:#fbfbff; border-left:1px solid var(--line); }
  #divider { flex: 0 0 8px; background: linear-gradient(90deg,#e5e7eb,#d1d5db); cursor: ew-resize; position:relative; z-index: 5; user-select:none; }
  h2,h3,h4 { margin:0 0 10px; }
  #left p { margin: 0 0 12px; line-height: 1.6; word-break: normal; overflow-wrap: normal; hyphens: none; }
  .group { background:#fff; border:1px solid var(--line); border-radius:10px; padding:12px; margin-bottom:14px; }
  input.blank { border:none; border-bottom:1px solid #9ca3af; padding:2px 4px; font-size:1em; background:transparent; text-align: center; }
  input.blank:focus { outline:none; border-bottom:2px solid var(--accent); }
  button { padding:8px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; cursor:pointer; }
  button.primary { background:var(--accent); color:#fff; border-color:#3b82f6; }
  #results { background:#fff; border:1px solid var(--line); border-radius:10px; padding:10px; }
  .hl { background:#fff3a3; box-shadow: inset 0 -2px 0 rgba(0,0,0,.05); cursor: pointer; }
  .hl:hover { filter: brightness(0.98); }
  #selbar { position: absolute; display:none; z-index: 2000; background:#111; color:#fff; border-radius: 8px; padding: 6px; box-shadow: var(--shadow); font-size: 13px; gap:6px; align-items: center; }
  #selbar button { background: transparent; color:#fff; border: 1px solid rgba(255,255,255,.25); padding: 4px 8px; border-radius: 6px; cursor:pointer; }
  #selbar button:hover { border-color:#fff; }
  #notes { position: fixed; right: 12px; bottom: 12px; width: 320px; height: 42vh; background:#fff; border:1px solid var(--line); border-radius: 12px; display:none; flex-direction: column; z-index:1500; box-shadow: var(--shadow); }
  #notes header { display:flex; align-items:center; justify-content: space-between; padding:8px 10px; border-bottom:1px solid var(--line); }
  #notes textarea { flex:1; border:0; padding:10px; resize:none; font-size:14px; line-height:1.5; }
  #toast { position: fixed; left:50%; transform: translateX(-50%); bottom: 24px; background:#111; color:#fff; padding:8px 12px; border-radius: 8px; display:none; z-index:2500; }
  details.answerbox summary { cursor: pointer; user-select:none; list-style: none; }
  details.answerbox { border:1px dashed var(--line); border-radius:10px; padding:8px 10px; background:#fff; }
  .badge { display:inline-block; background:#eef2ff; color:#4338ca; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:6px; }
  .practice-nav { background:#fff; border-bottom:2px solid var(--line); padding:12px 20px; display:flex; align-items:center; gap:20px; box-shadow:0 2px 4px rgba(0,0,0,.05); flex-wrap:wrap; position:fixed; left:0; right:0; bottom:0; border-top:2px solid var(--line); border-bottom:0; z-index:4000; }
  .practice-nav .title { font-weight:600; color:var(--muted); }
  .practice-nav .questions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .practice-nav .q-item { padding:6px 10px; border:1px solid var(--line); border-radius:6px; background:#fff; cursor:pointer; font-size:14px; transition:all 0.2s; min-width:36px; text-align:center; }
  .practice-nav .q-item:hover { background:#f1f5f9; border-color:var(--accent); }
  .practice-nav .q-item.answered { background:#e0e7ff; border-color:var(--accent); color:var(--accent); font-weight:500; }
  .practice-nav .q-item.active { background:var(--accent); color:#fff; border-color:var(--accent); }
  #selbar { z-index: 6000 !important; }
  .summary-box { border: 1px solid #ccc; padding: 12px; margin-top: 1em; border-radius: 8px;}
  .word-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; margin-top: 12px; padding: 10px; background: #f9fafb; border-radius: 6px;}
</style>
</head>
<body>

<div class="practice-nav">
  <div class="title">Questions</div>
  <div class="questions">
    <div class="q-item" id="q27-nav" onclick="scrollToElement('q27-anchor')">27</div>
    <div class="q-item" id="q28-nav" onclick="scrollToElement('q28-anchor')">28</div>
    <div class="q-item" id="q29-nav" onclick="scrollToElement('q29-anchor')">29</div>
    <div class="q-item" id="q30-nav" onclick="scrollToElement('q30-anchor')">30</div>
    <div class="q-item" id="q31-nav" onclick="scrollToElement('q31-anchor')">31</div>
    <div class="q-item" id="q32-nav" onclick="scrollToElement('q32-anchor')">32</div>
    <div class="q-item" id="q33-nav" onclick="scrollToElement('q33-anchor')">33</div>
    <div class="q-item" id="q34-nav" onclick="scrollToElement('q34-anchor')">34</div>
    <div class="q-item" id="q35-nav" onclick="scrollToElement('q35-anchor')">35</div>
    <div class="q-item" id="q36-nav" onclick="scrollToElement('q36-anchor')">36</div>
    <div class="q-item" id="q37-nav" onclick="scrollToElement('q37-anchor')">37</div>
    <div class="q-item" id="q38-nav" onclick="scrollToElement('q38-anchor')">38</div>
    <div class="q-item" id="q39-nav" onclick="scrollToElement('q39-anchor')">39</div>
    <div class="q-item" id="q40-nav" onclick="scrollToElement('q40-anchor')">40</div>
  </div>
</div>

<div class="shell">
  <section class="pane" id="left">
    <h2>READING PASSAGE 3 <span id="timer">00:00</span></h2>
    <p>You should spend about 20 minutes on Questions 27-40, which are based on Reading Passage 3 below.</p>
    
    <h3>The Pirahã people of Brazil</h3>
    <p><em>The Pirahã language has stirred up debate among experts</em></p>
    
    <p>The Pirahã tribe live deep in Brazil's Amazon forest, and their language is hotly debated by linguists. Since 1977, the ethnologist Daniel Everett has spent a total of seven years living with the Pirahã and has committed his career to studying their puzzling speech. Indeed, he was uncertain for so long about what he was actually hearing while living among the Pirahã that he waited nearly three decades before publishing his findings.</p>
    
    <p>The debate over the Pirahã language goes right to the core of the riddle regarding how Homo sapiens managed to develop vocal communication. Although bees dance, birds sing and whales even sing with syntax, human language is unique, if only for the reason that it enables humans to piece together never-before-constructed thoughts, and be infinitely imaginative - think of Shakespeare's plays or Einstein's theory of relativity.</p>
    
    <p>Linguistics generally focuses on what features all human languages have in common, but the Pirahã language departs from what some academics have long maintained are essential and inalienable features of all human languages. Most of all, it may be unique for not employing subordinate clauses. Instead of saying, ‘When I have finished eating, I will speak to you,' the Pirahã say, 'I finish eating, I speak with you.' Equally perplexing, the Pirahã appear not to use numbers. During the time he spent with them, Everett never heard words like 'all', 'every' and 'more'. There is one word, ‘hoi', that comes close to the numeral 1, but it can also mean 'small'. And they were never observed to count without language, on their fingers for example, in order to determine important tasks in village life like how many pieces of meat to grill.</p>
    
    <p>Everett's findings among the Pirahã have brought new life to a controversial theory by the linguist Benjamin Whorf, who suggested that people are only capable of constructing thoughts for which they possess actual words. Or to put it another way, because they have no words for numbers, they cannot even begin to understand the concept of numbers or arithmetic.</p>
    
    <p>The Warlpiri language - spoken by a group of Australian Aborigines - like that of the Pirahã, features only the most rudimentary system of counting. However, the Warlpiri people had no difficulty counting farther than three in a foreign language, in this case English, but when Everett attempted to teach the Pirahã how to count in Portuguese, like other Brazilians, not a single person could count to 10.</p>
    
    <p>Everett is at pains to point out that the Pirahã are not unintelligent, for their thinking is not any slower than that of the average university student. And although they reside in a remote part of the forest, they do not live in complete genetic isolation, but mix with people from the surrounding populations and share similar intellectual capacities with their neighbours whose languages do contain numbers.</p>
    
    <p>Eventually, after some 30 years of research, Everett has come up with a surprising explanation for the peculiarities of the Pirahã language. Language, he believes, is created by a people's way of life, their belief system and values. In this way, variety in human language is almost limitless, a function of the human capacity to live in different ways, such as in the forest. What Everett's research has revealed is that the central tenet of the Pirahã culture is to live in the here and now. The only thing of importance that is worth communicating to others is what is being experienced at that very moment, though this can often be described with great care and detail. In consequence, the language has no means to conjugate verbs in order to describe ‘yesterday' or 'last week' or 'when I was a child'. Their very literal view of the world curtails abstract thought, and many features taken for granted among other peoples are absent among the Pirahã, such as a creation myth, storytelling and painting. One manifestation of their beliefs is that by tradition the names they give their children are not particularly imaginative. Often they are named after other members of the tribe with whom they share similar character traits. Standing out or being different is not encouraged by the Pirahã, and this is reflected in their perhaps colourless choice of names.</p>
    
    <p>Everett anticipated that these findings would be controversial and the reaction came as expected. Until this point, many linguists had defended the theories of Noam Chomsky, according to which all human languages have a universal grammar. What exactly makes up this universal grammar is the subject of debate, but at its heart is the concept of 'recursion', which is defined as replication of a structure within its single parts. Without it, humans would not be able to view separate thoughts as subordinate parts of a complex whole. And, most pertinent to Everett's work, there would not be subordinate clauses, which are responsible for translating the concept of recursion into grammar. But if the Pirahã do not form subordinate clauses, then recursion cannot explain the uniqueness of human language, and this would negate Chomsky's theories.</p>
    
    <p>The logical way forward now would be to try to prove that the Pirahã can think in a recursive fashion. The only problem is, nobody can confirm or deny Everett's observations since no other researcher can speak Pirahã as well as he does. Despite this, several researchers - including two of Chomsky's colleagues - will soon travel to Brazil to check his claims. My concern is that soon the Pirahã will simply become one more scientific oddity with every aspect of their lives being exploited and analysed.</p>
    
    <p>&nbsp;</p>
  </section>
  <div id="divider" title="Drag to resize"></div>
  <section class="pane" id="right">
    <h3>Questions</h3>
    
    <div class="group">
        <h4>Questions 27–32</h4>
        <p>Choose the correct letter, A, B, C or D.</p>
        
        <a id="q27-anchor"></a>
        <div id="q27-section" style="padding:8px 0;border-top:1px dashed var(--line);">
          <p>27 What are we told about Daniel Everett in the first paragraph?</p>
          <div>
            <label style="display:block; margin:4px 0;"><input name="q27" type="radio" value="A"> A He has lived among the Pirahã since 1977.</label>
            <label style="display:block; margin:4px 0;"><input name="q27" type="radio" value="B"> B It took him seven years to learn the Pirahã language.</label>
            <label style="display:block; margin:4px 0;"><input name="q27" type="radio" value="C"> C No one would publish his research for three decades.</label>
            <label style="display:block; margin:4px 0;"><input name="q27" type="radio" value="D"> D Studying the Pirahã language is the focus of his work.</label>
          </div>
        </div>

        <a id="q28-anchor"></a>
        <div id="q28-section" style="padding:8px 0;border-top:1px dashed var(--line);">
          <p>28 Which of the following is the best summary of the second paragraph?</p>
          <div>
            <label style="display:block; margin:4px 0;"><input name="q28" type="radio" value="A"> A Humans are the only species to be linguistically creative.</label>
            <label style="display:block; margin:4px 0;"><input name="q28" type="radio" value="B"> B Humans, bees, birds and whales share a characteristic.</label>
            <label style="display:block; margin:4px 0;"><input name="q28" type="radio" value="C"> C Human language is not fully understood by scientists.</label>
            <label style="display:block; margin:4px 0;"><input name="q28" type="radio" value="D"> D Humans are the only species to use syntax.</label>
          </div>
        </div>

        <a id="q29-anchor"></a>
        <div id="q29-section" style="padding:8px 0;border-top:1px dashed var(--line);">
          <p>29 Why does the writer refer to subordinate clauses?</p>
          <div>
            <label style="display:block; margin:4px 0;"><input name="q29" type="radio" value="A"> A to criticise the general approach of linguistics</label>
            <label style="display:block; margin:4px 0;"><input name="q29" type="radio" value="B"> B to compare two features of the Pirahã language</label>
            <label style="display:block; margin:4px 0;"><input name="q29" type="radio" value="C"> C to explain why the Pirahã language is difficult to learn</label>
            <label style="display:block; margin:4px 0;"><input name="q29" type="radio" value="D"> D to exemplify an unusual feature of the Pirahã language</label>
          </div>
        </div>

        <a id="q30-anchor"></a>
        <div id="q30-section" style="padding:8px 0;border-top:1px dashed var(--line);">
          <p>30 What point does the writer make about the work of Whorf?</p>
          <div>
            <label style="display:block; margin:4px 0;"><input name="q30" type="radio" value="A"> A He thought that numbers were common to all human languages.</label>
            <label style="display:block; margin:4px 0;"><input name="q30" type="radio" value="B"> B His theory might be supported by Everett's research.</label>
            <label style="display:block; margin:4px 0;"><input name="q30" type="radio" value="C"> C His research enabled him to find a new life among the Pirahã.</label>
            <label style="display:block; margin:4px 0;"><input name="q30" type="radio" value="D"> D He predicted that people like the Pirahã would never be found.</label>
          </div>
        </div>

        <a id="q31-anchor"></a>
        <div id="q31-section" style="padding:8px 0;border-top:1px dashed var(--line);">
          <p>31 The writer refers to the Warlpiri people in order to</p>
          <div>
            <label style="display:block; margin:4px 0;"><input name="q31" type="radio" value="A"> A suggest that the Pirahã be taught to count in English.</label>
            <label style="display:block; margin:4px 0;"><input name="q31" type="radio" value="B"> B show how tribal peoples learn a foreign language.</label>
            <label style="display:block; margin:4px 0;"><input name="q31" type="radio" value="C"> C compare counting in English and Portuguese.</label>
            <label style="display:block; margin:4px 0;"><input name="q31" type="radio" value="D"> D illustrate the uniqueness of the Pirahã.</label>
          </div>
        </div>

        <a id="q32-anchor"></a>
        <div id="q32-section" style="padding:8px 0;border-top:1px dashed var(--line);">
          <p>32 What is Everett's point about the Pirahã's intellectual capacities?</p>
          <div>
            <label style="display:block; margin:4px 0;"><input name="q32" type="radio" value="A"> A Pirahã students have not graduated from universities.</label>
            <label style="display:block; margin:4px 0;"><input name="q32" type="radio" value="B"> B He does not want people to criticise their intelligence.</label>
            <label style="display:block; margin:4px 0;"><input name="q32" type="radio" value="C"> C Their isolation makes it difficult to evaluate their intelligence.</label>
            <label style="display:block; margin:4px 0;"><input name="q32" type="radio" value="D"> D He believes their language is more complex than their neighbours'.</label>
          </div>
        </div>
    </div>
    
    <div class="group">
        <h4>Questions 33–36</h4>
        <p>Complete the summary using the list of words, A–I, below.</p>
        <div class="summary-box">
            <h5 style="text-align:center; margin-top:0;">Everett's explanation</h5>
            <p>
                Everett believes that a group's language is a product of their 33 <a id="q33-anchor"></a><input name="q33" type="text" class="blank" maxlength="1" style="width: 30px;"> and thus language is infinitely varied. During the time he spent living among them, he observed that the Pirahã only place value on the 34 <a id="q34-anchor"></a><input name="q34" type="text" class="blank" maxlength="1" style="width: 30px;"> and have no 35 <a id="q35-anchor"></a><input name="q35" type="text" class="blank" maxlength="1" style="width: 30px;"> to describe completed events. Similarly, the types of names they use reflect the fact that they do not celebrate 36 <a id="q36-anchor"></a><input name="q36" type="text" class="blank" maxlength="1" style="width: 30px;">.
            </p>
        </div>
        <div class="word-list">
            <span><strong>A</strong> present</span>
            <span><strong>B</strong> past</span>
            <span><strong>C</strong> time</span>
            <span><strong>D</strong> future</span>
            <span><strong>E</strong> culture</span>
            <span><strong>F</strong> grammar</span>
            <span><strong>G</strong> art</span>
            <span><strong>H</strong> individuality</span>
            <span><strong>I</strong> children</span>
        </div>
    </div>

    <div class="group">
        <h4>Questions 37–40</h4>
        <p>Do the following statements agree with the views of the writer in Reading Passage 3?</p>
        <p>In boxes 37–40 on your answer sheet, write</p>
        <ul>
            <li><strong>YES</strong> if the statement agrees with the views of the writer</li>
            <li><strong>NO</strong> if the statement contradicts the views of the writer</li>
            <li><strong>NOT GIVEN</strong> if it is impossible to say what the writer thinks about this</li>
        </ul>
        
        <a id="q37-anchor"></a>
        <div id="q37-section" style="padding:8px 0;border-top:1px dashed var(--line);">
          <p>37 Everett was surprised by the way his research was greeted.</p>
          <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
            <label><input name="q37" type="radio" value="YES"> YES</label> <label><input name="q37" type="radio" value="NO"> NO</label> <label><input name="q37" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
          </div>
        </div>
        
        <a id="q38-anchor"></a>
        <div id="q38-section" style="padding:8px 0;border-top:1px dashed var(--line);">
          <p>38 Chomsky has been critical of Everett's research methodology.</p>
          <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
            <label><input name="q38" type="radio" value="YES"> YES</label> <label><input name="q38" type="radio" value="NO"> NO</label> <label><input name="q38" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
          </div>
        </div>

        <a id="q39-anchor"></a>
        <div id="q39-section" style="padding:8px 0;border-top:1px dashed var(--line);">
          <p>39 If 'recursion' as a universal concept is disproved, Chomsky's ideas about language would be wrong.</p>
          <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
            <label><input name="q39" type="radio" value="YES"> YES</label> <label><input name="q39" type="radio" value="NO"> NO</label> <label><input name="q39" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
          </div>
        </div>

        <a id="q40-anchor"></a>
        <div id="q40-section" style="padding:8px 0;border-top:1px dashed var(--line);">
          <p>40 The Pirahã will benefit from their new-found status among academics.</p>
          <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
            <label><input name="q40" type="radio" value="YES"> YES</label> <label><input name="q40" type="radio" value="NO"> NO</label> <label><input name="q40" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
          </div>
        </div>
    </div>

    <div style="display:flex;gap:8px;margin-bottom:10px;">
      <button class="primary" onclick="grade()">Submit</button>
      <button onclick="resetForm()">Reset</button>
      <button onclick="toggleNotes()">Notes</button>
    </div>
    <div id="results"></div>
    <details class="answerbox" id="answerBox">
      <summary>Show answers (click to toggle) <span class="badge">hidden</span></summary>
      <div id="answerContent"></div>
    </details>
  </section>
</div>

<div aria-label="Selection tools" id="selbar" role="toolbar">
  <button id="btnHL">Highlight</button>
  <button id="btnUH">Remove</button>
  <button id="btnNote">Note</button>
</div>
<div id="notes">
  <header>
    <strong>Notes</strong>
    <div>
      <button id="btnCopy">Copy</button>
      <button id="btnClose">Close</button>
    </div>
  </header>
  <textarea id="noteArea" placeholder="Type your notes here..."></textarea>
</div>
<div id="toast"></div>

<script>
// Timer
let _t=0; const _timerEl=document.getElementById('timer');
setInterval(function(){ 
  _t++; 
  var m=String(Math.floor(_t/60)).padStart(2,'0'); 
  var s=String(_t%60).padStart(2,'0'); 
  _timerEl.textContent=m+':'+s; 
},1000);
// Drag divider
var divider = document.getElementById('divider');
var left = document.getElementById('left');
var right = document.getElementById('right');
var dragging=false;
function startDrag(e){ 
  dragging=true; 
  document.body.style.cursor='ew-resize'; 
  if(e.preventDefault) e.preventDefault(); 
}
function endDrag(){ 
  dragging=false; 
  document.body.style.cursor=''; 
}
function onMove(clientX){
  var container = document.querySelector('.shell').getBoundingClientRect();
  var x = clientX - container.left;
  x = Math.max(280, Math.min(container.width-320, x));
  left.style.flex = '0 0 ' + x + 'px';
  right.style.flex = '1 1 auto';
}
divider.addEventListener('mousedown', function(e){ startDrag(e); });
window.addEventListener('mousemove', function(e){ if(dragging) onMove(e.clientX); });
window.addEventListener('mouseup', endDrag);
divider.addEventListener('touchstart', function(e){ startDrag(e.touches[0]); }, {passive:false});
window.addEventListener('touchmove', function(e){ if(dragging) onMove(e.touches[0].clientX); }, {passive:false});
window.addEventListener('touchend', endDrag);
// Highlight toolbar
var selbar = document.getElementById('selbar');
var btnHL = document.getElementById('btnHL');
var btnUH = document.getElementById('btnUH');
var btnNote = document.getElementById('btnNote');
var lastRange=null;
var currentHlNode=null;
var keepToolbar=false;
function positionSelbarForRect(rect){
  selbar.style.display='flex';
  requestAnimationFrame(function(){
    var top = window.scrollY + rect.top - selbar.offsetHeight - 8;
    var leftPos = window.scrollX + rect.left + rect.width/2 - selbar.offsetWidth/2;
    selbar.style.top = ((top>0)?top:(window.scrollY + rect.bottom + 8)) + 'px';
    selbar.style.left = Math.max(8, leftPos) + 'px';
  });
}
function updateSelbar(){
  var sel=window.getSelection();
  if(!sel || sel.rangeCount===0 || sel.isCollapsed) { 
    selbar.style.display='none'; 
    currentHlNode=null; 
    return; 
  }
  var range = sel.getRangeAt(0);
  lastRange = range.cloneRange();
  currentHlNode=null;
  positionSelbarForRect(range.getBoundingClientRect());
}
document.getElementById('left').addEventListener('mouseup', updateSelbar);
document.getElementById('right').addEventListener('mouseup', updateSelbar);
document.addEventListener('selectionchange', function(){ 
  var sel=window.getSelection(); 
  if(!sel || sel.rangeCount===0 || sel.isCollapsed){ 
    if(!keepToolbar && !currentHlNode){ 
      selbar.style.display='none'; 
    } 
  } 
});
document.addEventListener('scroll', function(){ 
  if(selbar.style.display==='flex') updateSelbar(); 
});
document.addEventListener('mousedown', function(e){
  var t = e.target;
  if(t.classList && t.classList.contains('hl')){
    keepToolbar = true;
  } else {
    keepToolbar = false;
  }
}, true);
document.addEventListener('click', function(e){
  var target = e.target;
  if(target.classList && target.classList.contains('hl')){
    currentHlNode = target;
    lastRange = null;
    positionSelbarForRect(target.getBoundingClientRect());
    var sel=window.getSelection();
    if(sel) sel.removeAllRanges();
    setTimeout(function(){ keepToolbar=false; }, 0);
  }
}, true);
function doHighlight(){
  if(currentHlNode) return;
  if(!lastRange || lastRange.collapsed) return;
  var span=document.createElement('span'); span.className='hl';
  try { lastRange.surroundContents(span); }
  catch(e){
    var wrap=document.createElement('span'); wrap.className='hl';
    wrap.appendChild(lastRange.cloneContents());
    lastRange.deleteContents();
    lastRange.insertNode(wrap);
  }
  selbar.style.display='none';
  showToast('Highlighted');
}
function removeHighlight(){
  if(currentHlNode){
    var p = currentHlNode.parentNode;
    while(currentHlNode.firstChild) p.insertBefore(currentHlNode.firstChild, currentHlNode);
    p.removeChild(currentHlNode); p.normalize();
    currentHlNode = null;
    selbar.style.display='none';
    showToast('Highlight removed');
    return;
  }
  if(!lastRange) return;
  var selRect = lastRange.getBoundingClientRect();
  var walker=document.createTreeWalker(document.body, NodeFilter.SHOW_ELEMENT);
  var toRemove=[];
  while(walker.nextNode()){
    var n=walker.currentNode;
    if(n.classList && n.classList.contains('hl')) {
      var r = n.getBoundingClientRect();
      if(!(r.right < selRect.left || r.left > selRect.right || r.bottom < selRect.top || r.top > selRect.bottom)) toRemove.push(n);
    }
  }
  toRemove.forEach(function(el){ var p=el.parentNode; while(el.firstChild) p.insertBefore(el.firstChild, el); p.removeChild(el); p.normalize(); });
  selbar.style.display='none';
  showToast('Highlight removed');
}
btnHL.addEventListener('click', doHighlight);
btnUH.addEventListener('click', removeHighlight);
// Notes
var notes = document.getElementById('notes');
var noteArea = document.getElementById('noteArea');
var btnCopy=document.getElementById('btnCopy');
var btnClose=document.getElementById('btnClose');
function toggleNotes(){ 
  notes.style.display = (notes.style.display==='flex'?'none':'flex'); 
}
window.toggleNotes = toggleNotes;
btnClose.addEventListener('click', toggleNotes);
btnCopy.addEventListener('click', async function(){ 
  await navigator.clipboard.writeText(noteArea.value||''); 
  showToast('Copied'); 
});
btnNote.addEventListener('click', function(){
  var text = '';
  if(currentHlNode){ text = (currentHlNode.textContent||'').trim(); }
  else if(lastRange){ var frag = lastRange.cloneContents(); text = (frag.textContent||'').trim(); }
  toggleNotes();
  if(text) noteArea.value = (noteArea.value? noteArea.value+'\n':'') + '> ' + text + '\n';
  selbar.style.display='none';
});
// Toast
var toastEl=document.getElementById('toast');
function showToast(msg){
  toastEl.textContent=msg; 
  toastEl.style.display='block';
  setTimeout(function(){ toastEl.style.display='none'; }, 1200);
}
// Answer key and grading
var answers = {
  q27: "D", q28: "A", q29: "D", q30: "B", q31: "D", q32: "B",
  q33: "E", q34: "A", q35: "F", q36: "H",
  q37: "NO", q38: "NOT GIVEN", q39: "YES", q40: "NO"
};
function grade(){
  var total=0, correct=0, lines=[];
  function push(q, ok, user){
    total++; if(ok) correct++;
    lines.push(q.toUpperCase()+": "+(user||'None')+" "+(ok?'✅':'❌'));
  }
  
  for(var n=27;n<=40;n++){
      var qName = 'q' + n;
      var radios = document.querySelectorAll('input[name="'+qName+'"]');
      var textInput = document.querySelector('input[name="'+qName+'"].blank');
      var val = '';
      var isCorrect = false;

      if(radios.length > 0) { // Radio button questions
          var sel = document.querySelector('input[name="'+qName+'"]:checked');
          val = sel ? sel.value : '';
          isCorrect = val === answers[qName];
      } else if (textInput) { // Text input questions
          val = textInput.value.trim().toUpperCase();
          isCorrect = val === answers[qName];
      }
      push(qName, isCorrect, val);
  }
  
  var acc = (total? Math.round(100*correct/total):0);
  var html = '<p><strong>Score:</strong> '+correct+'/'+total+' <span class="badge">Accuracy '+acc+'%</span></p>';
  html += '<pre>'+lines.join('\n')+'</pre>';
  document.getElementById('results').innerHTML = html;
  
  var ahtml = '<ol start="27">';
  for(var i=27; i<=40; i++){
    ahtml += '<li>' + answers['q'+i] + '</li>';
  }
  ahtml += '</ol>';
  document.getElementById('answerContent').innerHTML = ahtml;
  document.querySelector('#answerBox .badge').textContent='tap to view';
}
function resetForm(){
  document.querySelectorAll('input[type="radio"]').forEach(el=>el.checked=false);
  document.querySelectorAll('input[type="text"]').forEach(el=>el.value="");
  document.getElementById('results').innerHTML='';
  document.getElementById('answerContent').innerHTML='';
  document.querySelector('#answerBox .badge').textContent = 'hidden';
  document.querySelectorAll('.q-item').forEach(item => item.classList.remove('answered'));
}
function scrollToElement(id){
  var el = document.getElementById(id);
  if(el){ 
    el.scrollIntoView({behavior:'smooth', block:'center'}); 
  }
  var navs = document.querySelectorAll('.practice-nav .q-item');
  navs.forEach(n => n.classList.remove('active'));
  var btn = document.getElementById(id.replace('-anchor','-nav'));
  if(btn){ 
    btn.classList.add('active'); 
    setTimeout(() => btn.classList.remove('active'), 800); 
  }
}
(function(){
  function mark(qn){
    var nav = document.getElementById('q'+qn+'-nav');
    if(!nav) return;
    
    var answered = false;
    var radios = document.querySelectorAll(`input[name="q${qn}"]`);
    var text = document.querySelector(`input[name="q${qn}"].blank`);
    
    if (radios.length > 0) {
      radios.forEach(function(r){ if(r.checked) answered=true; });
    }
    if (text) {
      answered = answered || (text.value && text.value.trim().length > 0);
    }

    if(answered) nav.classList.add('answered'); else nav.classList.remove('answered');
  }
  for(var q=27;q<=40;q++){
    (function(n){
      document.querySelectorAll(`input[name="q${n}"]`).forEach(function(r){ r.addEventListener('change', function(){ mark(n); }); });
      var text = document.querySelector(`input[name="q${n}"].blank`);
      if(text){ text.addEventListener('input', function(){ mark(n); }); }
    })(q);
  }
})();
</script>

<!-- 练习页面数据传输增强脚本 -->
<script>
if (!window.practicePageEnhancer) {
    const script = document.createElement('script');
    script.src = '../../js/practice-page-enhancer.js';
    script.onload = function() { console.log('练习页面增强脚本已加载'); };
    script.onerror = function() { console.error('练习页面增强脚本加载失败'); loadInlineEnhancer(); };
    document.head.appendChild(script);
}
function loadInlineEnhancer() {
    if (window.practicePageEnhancer) return;
    window.practicePageEnhancer = {
        initialize: function() {
            this.setupCommunication();
            this.setupAnswerListeners();
            this.interceptSubmit();
        },
        setupCommunication: function() {
            this.parentWindow = window.opener || window.parent;
            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'INIT_SESSION') {
                    this.sessionId = event.data.data.sessionId;
                    this.sendMessage('SESSION_READY', { pageType: this.detectPageType(), url: window.location.href });
                }
            });
        },
        detectPageType: function() {
            const title = document.title || '';
            if (title.includes('P1')) return 'P1';
            if (title.includes('P2')) return 'P2';
            if (title.includes('P3')) return 'P3';
            return 'unknown';
        },
        setupAnswerListeners: function() {
            this.answers = {};
            this.startTime = Date.now();
            document.addEventListener('change', (e) => {
                if (e.target.name) {
                    this.answers[e.target.name] = e.target.value;
                }
            });
             document.addEventListener('input', (e) => {
                if (e.target.name && e.target.classList.contains('blank')) {
                    this.answers[e.target.name] = e.target.value;
                }
            });
        },
        interceptSubmit: function() {
            if (typeof window.grade === 'function') {
                const originalGrade = window.grade;
                window.grade = () => {
                    const result = originalGrade();
                    setTimeout(() => this.handleSubmit(), 200);
                    return result;
                };
            }
        },
        handleSubmit: function() {
            const results = {
                sessionId: this.sessionId,
                startTime: this.startTime,
                endTime: Date.now(),
                duration: Math.round((Date.now() - this.startTime) / 1000),
                answers: this.answers,
                scoreInfo: this.extractScore(),
                pageType: this.detectPageType(),
                url: window.location.href
            };
            this.sendMessage('PRACTICE_COMPLETE', results);
        },
        extractScore: function() {
            const resultsEl = document.getElementById('results');
            if (!resultsEl) return null;
            const text = resultsEl.textContent || '';
            const scoreMatch = text.match(/Score:\s*(\d+)\/(\d+)/i);
            if (scoreMatch) {
                const correct = parseInt(scoreMatch[1]);
                const total = parseInt(scoreMatch[2]);
                return { correct: correct, total: total, accuracy: total > 0 ? correct / total : 0, percentage: Math.round((correct / total) * 100), source: 'inline_extraction' };
            }
            return null;
        },
        sendMessage: function(type, data) {
            if (this.parentWindow) {
                this.parentWindow.postMessage({ type: type, data: data, source: 'practice_page' }, '*');
            }
        }
    };
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => { window.practicePageEnhancer.initialize(); });
    } else {
        window.practicePageEnhancer.initialize();
    }
}
</script>

</body>
</html>