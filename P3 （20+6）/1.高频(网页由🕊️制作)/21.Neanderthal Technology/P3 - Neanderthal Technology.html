<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Neanderthal Technology</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<style>
  :root { 
    --line:#e5e7eb; 
    --bg:#f6f7fb; 
    --panel:#fff; 
    --accent:#3b82f6; 
    --muted:#6b7280; 
    --shadow:0 6px 20px rgba(0,0,0,.12); 
  }
  
  body.dark {
    --line: #374151;
    --bg: #111827;
    --panel: #1f2937;
    --accent: #60a5fa;
    --muted: #9ca3af;
    --shadow: 0 6px 20px rgba(0,0,0,.3);
  }
  
  body {
    transition: background-color 0.3s ease, color 0.3s ease;
    background: var(--bg);
    color: #1f2937;
  }
  
  /* Timer enhancements */
  #timer {
    cursor: pointer !important;
    transition: all 0.2s ease;
    user-select: none;
  }
  
  #timer:hover {
    background: #f8fafc;
    border-color: var(--accent);
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
  }
  
  
    background: #1e293b;
    color: #e2e8f0;
    border-color: #334155;
  }
  
  
    background: #334155;
    border-color: var(--accent);
  }
  
  #timer.paused {
    background: #fef3c7 !important;
    color: #92400e !important;
    border-color: #f59e0b !important;
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }
  
  /* Controls layout */
  .practice-nav .controls {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  /* Theme toggle button */
  .theme-toggle {
    border: none;
    cursor: pointer;
    background: transparent;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    transition: all 0.2s ease;
  }
  
  .theme-toggle:hover {
    background: var(--accent);
    color: #fff;
    transform: scale(1.05);
  }
  
  .theme-toggle:active {
    transform: scale(0.95);
  }

  * { box-sizing: border-box; }
  html,body { height:100%; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); }
  #timer { 
    position: static; 
    display: inline-block; 
    margin-left: 8px; 
    background:#fff; 
    border:1px solid var(--line); 
    border-radius:10px; 
    padding:8px 12px; 
    font-size:14px; 
    vertical-align: middle; 
    cursor: pointer;
    transition: all 0.2s ease;
    user-select: none;
    font-weight: 500;
  }
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:var(--panel); overflow:auto; padding:20px; }
  #left { flex: 0 0 50%; min-width: 280px; }
  #right { flex: 1 1 auto; min-width: 320px; background:#fbfbff; border-left:1px solid var(--line); }
  #divider { flex: 0 0 8px; background: linear-gradient(90deg,#e5e7eb,#d1d5db); cursor: ew-resize; position:relative; z-index: 5; user-select:none; }
  h2,h3,h4 { margin:0 0 10px; }
  #left p { margin: 0 0 12px; line-height: 1.6; word-break: normal; overflow-wrap: normal; hyphens: none; }
  .group { background:#fff; border:1px solid var(--line); border-radius:10px; padding:12px; margin-bottom:14px; }
  table { border-collapse: collapse; width:100%; }
  th, td { border:1px solid var(--line); padding:6px; text-align:left; font-size:14px; }
  th:first-child, td:first-child { width:auto; }
  button { padding:8px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; cursor:pointer; }
  button.primary { background:var(--accent); color:#fff; border-color:#3b82f6; }
  #results { background:#fff; border:1px solid var(--line); border-radius:10px; padding:10px; }
  .hl { background:#fff3a3; box-shadow: inset 0 -2px 0 rgba(0,0,0,.05); cursor: pointer; }
  .hl:hover { filter: brightness(0.98); }
  #selbar { position: absolute; display:none; z-index: 2000; background:#111; color:#fff; border-radius: 8px; padding: 6px; box-shadow: var(--shadow); font-size: 13px; gap:6px; align-items: center; }
  #selbar button { background: transparent; color:#fff; border: 1px solid rgba(255,255,255,.25); padding: 4px 8px; border-radius: 6px; cursor:pointer; }
  #selbar button:hover { border-color:#fff; }
  #notes { position: fixed; right: 12px; bottom: 12px; width: 320px; height: 42vh; background:#fff; border:1px solid var(--line); border-radius: 12px; display:none; flex-direction: column; z-index:1500; box-shadow: var(--shadow); }
  #notes header { display:flex; align-items:center; justify-content: space-between; padding:8px 10px; border-bottom:1px solid var(--line); }
  #notes textarea { flex:1; border:0; padding:10px; resize:none; font-size:14px; line-height:1.5; }
  #toast { position: fixed; left:50%; transform: translateX(-50%); bottom: 24px; background:#111; color:#fff; padding:8px 12px; border-radius: 8px; display:none; z-index:2500; }
  .dropzone { border:2px dashed #cbd5e1; background:#f8fafc; border-radius:10px; min-height:40px; padding:4px 8px; display:inline-flex; align-items:center; justify-content:space-between; gap:8px; width: auto; min-width: 120px; max-width: 200px; vertical-align: middle; }
  .droplabel { color:#64748b; font-size:14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .cardpool { background:#f1f5f9; border-radius:10px; padding:12px; display:flex; flex-wrap:wrap; gap:8px; }
  .pool-slot { min-height:40px; }
  .card { background:#fff; border:1px solid #e5e7eb; border-radius:8px; padding:8px 10px; display:inline-flex; gap:8px; align-items:center; cursor:grab; box-shadow:0 1px 0 rgba(0,0,0,.03); white-space: nowrap; }
  .card:active { cursor:grabbing; }
  .tag { background:#eef2ff; color:#4338ca; padding:2px 8px; border-radius:999px; font-size:12px; }
  .btn-clear { border:1px solid #e5e7eb; background:#fff; border-radius:8px; padding:6px 8px; cursor:pointer; }
  .ghost { opacity: .5; }
  .over { outline:2px dashed #3b82f6; }
  details.answerbox summary { cursor: pointer; user-select:none; list-style: none; }
  details.answerbox { border:1px dashed var(--line); border-radius:10px; padding:8px 10px; background:#fff; }
  .badge { display:inline-block; background:#eef2ff; color:#4338ca; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:6px; }
  body { padding-bottom: 82px; }
  .practice-nav { background:#fff; border-bottom:2px solid var(--line); padding:12px 20px; display:flex; align-items:center; gap:20px; box-shadow:0 2px 4px rgba(0,0,0,.05); flex-wrap:wrap; position:fixed; left:0; right:0; bottom:0; border-top:2px solid var(--line); border-bottom:0; z-index:4000; }
  .practice-nav .title { font-weight:600; color:var(--muted); }
  .practice-nav .questions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .practice-nav .q-item { padding:6px 10px; border:1px solid var(--line); border-radius:6px; background:#fff; cursor:pointer; font-size:14px; transition:all 0.2s; min-width:36px; text-align:center; }
  .practice-nav .q-item:hover { background:#f1f5f9; border-color:var(--accent); }
  .practice-nav .q-item.answered { background:#e0e7ff; border-color:var(--accent); color:var(--accent); font-weight:500; }
  .practice-nav .q-item.active { background:var(--accent); color:#fff; border-color:var(--accent); }
  #selbar { z-index: 6000 !important; }

/* Âº∫ÂäõÈªëÊöóÊ®°Âºè‰øÆÂ§ç - ‰ΩøÁî®!importantÁ°Æ‰øù‰ºòÂÖàÁ∫ß */
body.dark {
  background: #111827 !important;
  color: #f9fafb !important;
}

body.dark * {
  border-color: #374151 !important;
}

body.dark .shell {
  background: #111827 !important;
}

body.dark .pane {
  background: #1f2937 !important;
  color: #f9fafb !important;
}

body.dark #left {
  background: #1f2937 !important;
}

body.dark #right {
  background: #1f2937 !important;
}

body.dark h1, body.dark h2, body.dark h3, body.dark h4, body.dark h5, body.dark h6 {
  color: #f9fafb !important;
}

body.dark p, body.dark li, body.dark td, body.dark th, body.dark label, body.dark span, body.dark div {
  color: #e5e7eb !important;
}

body.dark .group {
  background: #1f2937 !important;
  border: 1px solid #374151 !important;
  color: #f9fafb !important;
}

body.dark button {
  background: #374151 !important;
  color: #f9fafb !important;
  border: 1px solid #4b5563 !important;
}

body.dark button:hover {
  background: #4b5563 !important;
  border-color: #60a5fa !important;
}

body.dark button.primary {
  background: #3b82f6 !important;
  color: white !important;
}

body.dark #results {
  background: #1f2937 !important;
  color: #f9fafb !important;
  border: 1px solid #374151 !important;
}

body.dark details.answerbox {
  background: #1f2937 !important;
  border: 1px solid #374151 !important;
  color: #f9fafb !important;
}

body.dark details.answerbox summary {
  color: #f9fafb !important;
}

body.dark .practice-nav {
  background: #1f2937 !important;
  border: 1px solid #374151 !important;
}

body.dark .practice-nav .q-item {
  background: #374151 !important;
  color: #f9fafb !important;
  border: 1px solid #4b5563 !important;
}

body.dark .practice-nav .q-item:hover {
  background: #4b5563 !important;
  border-color: #60a5fa !important;
}

body.dark .practice-nav .q-item.answered {
  background: #1e40af !important;
  color: #93c5fd !important;
}

body.dark .practice-nav .q-item.active {
  background: #3b82f6 !important;
  color: white !important;
}

body.dark #timer {
  background: #374151 !important;
  color: #f9fafb !important;
  border: 1px solid #4b5563 !important;
}

body.dark #timer:hover {
  background: #4b5563 !important;
  border-color: #60a5fa !important;
}

body.dark .dropzone {
  background: #374151 !important;
  border: 2px dashed #4b5563 !important;
  color: #f9fafb !important;
}

body.dark .card {
  background: #374151 !important;
  border: 1px solid #4b5563 !important;
  color: #f9fafb !important;
}

body.dark .cardpool {
  background: #4b5563 !important;
}

body.dark .hl {
  background: #fbbf24 !important;
  color: #1f2937 !important;
}

body.dark input[type="radio"] {
  accent-color: #60a5fa !important;
}

body.dark input.blank {
  color: #f9fafb !important;
  border-bottom: 2px solid #4b5563 !important;
  background: transparent !important;
}

body.dark input.blank:focus {
  border-bottom-color: #60a5fa !important;
}

body.dark #notes {
  background: #1f2937 !important;
  border: 1px solid #374151 !important;
}

body.dark #notes header {
  color: #f9fafb !important;
  border-bottom: 1px solid #374151 !important;
}

body.dark #notes textarea {
  background: #1f2937 !important;
  color: #f9fafb !important;
  border: 1px solid #374151 !important;
}

body.dark table {
  border-color: #374151 !important;
}

body.dark th, body.dark td {
  border-color: #374151 !important;
  color: #e5e7eb !important;
}

body.dark #divider {
  background: linear-gradient(90deg, #374151, #4b5563) !important;
}

/* ‰øÆÂ§çÈÄâÊã©Âô®ÂíåÂÖ∂‰ªñÂÖÉÁ¥† */
body.dark select, body.dark option {
  background: #374151 !important;
  color: #f9fafb !important;
  border: 1px solid #4b5563 !important;
}

body.dark textarea {
  background: #1f2937 !important;
  color: #f9fafb !important;
  border: 1px solid #374151 !important;
}

body.dark input[type="text"], body.dark input[type="number"] {
  background: #1f2937 !important;
  color: #f9fafb !important;
  border: 1px solid #374151 !important;
}

</style>
</head>
<body>
<div class="practice-nav">
  <div class="title">Questions</div>
  <div class="questions">
    <div class="q-item" id="q27-nav" onclick="scrollToElement('q27-anchor')">27</div>
    <div class="q-item" id="q28-nav" onclick="scrollToElement('q28-anchor')">28</div>
    <div class="q-item" id="q29-nav" onclick="scrollToElement('q29-anchor')">29</div>
    <div class="q-item" id="q30-nav" onclick="scrollToElement('q30-anchor')">30</div>
    <div class="q-item" id="q31-nav" onclick="scrollToElement('q31-anchor')">31</div>
    <div class="q-item" id="q32-nav" onclick="scrollToElement('q32-anchor')">32</div>
    <div class="q-item" id="q33-nav" onclick="scrollToElement('q33-anchor')">33</div>
    <div class="q-item" id="q34-nav" onclick="scrollToElement('q34-anchor')">34</div>
    <div class="q-item" id="q35-nav" onclick="scrollToElement('q35-anchor')">35</div>
    <div class="q-item" id="q36-nav" onclick="scrollToElement('q36-anchor')">36</div>
    <div class="q-item" id="q37-nav" onclick="scrollToElement('q37-anchor')">37</div>
    <div class="q-item" id="q38-nav" onclick="scrollToElement('q38-anchor')">38</div>
    <div class="q-item" id="q39-nav" onclick="scrollToElement('q39-anchor')">39</div>
    <div class="q-item" id="q40-nav" onclick="scrollToElement('q40-anchor')">40</div>
  </div>
  <div class="controls">
    <span id="timer" onclick="toggleTimer()">00:00</span>
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">üåô</button>
  </div>
</div>
<div class="shell">
  <section class="pane" id="left">
    <h2>READING PASSAGE 3</h2>
    <p>You should spend about 20 minutes on Questions 27‚Äì40, which are based on Reading Passage 3 below.</p>
    <div style="display:flex; gap:10px; margin-bottom: 20px;">
      <!-- Removed AI-related buttons to meet user's request -->
    </div>
    <h3>Neanderthal Technology</h3>
    
    <p>A We think of our prehistoric ancestors as people of the ice and snow, living in caves, and for many of the West European Neanderthalers that is just a picture of their life. But where there were no caves, further to the east on the Russian steppe, for example, open-air sites with some sort of constructed shelter were the only option. We now know much more about the cave sites than the open-air ones because, historically, it was the cave sites of Western Europe that were first explored by archaeologists and also because open-air sites are harder to find - many of them have disappeared under deep mud deposits or under the rising postglacial seas. Caves, moreover, aid the survival of archaeological material and can preserve the records of remote millennia.</p>
    
    <p>B In south-west France, the limestone caves of the P√©rigord region made ideal homes for the Neanderthal people. There were good supplies of flint to hand for axes and the like, and the caves were often sited in small river valleys that offered protection against the worst of the weather. The Neanderthalers liked south-facing caves, for obvious reasons of sunshine and wind avoidance, and caves at some height above the valley floor offered refuge from floods and good game-watching vantage points. The P√©rigord region during the last ice age was, in fact, an exceptionally benign habitat for humans. It enjoyed a rather maritime climate with cooler summers that permitted the extension of tundra and steppe over its higher plateaux, and its year-round high levels of sunshine favoured the growth of the ground plants needed by reindeer, bison and horse. Winters were mildish for the ice age, animals never needed to migrate far from summer to winter, and men never needed to travel far from home to find abundant supplies of meat.</p>
    
    <p>C In Central and Eastern Europe, where caves are less readily available, such open-air sites as have been discovered were mostly located near water: bottom-land was a good area to be for people and animals, and also because the sedimentation pattern of lakes and stream courses has aided archaeological preservation - whereas erosion has presumably blown away sites which were out in the open. Some of the open-air sites in Germany, Central Europe and Russia have provided valuable information about Neanderthal man and his way of life. From Moldova, for example, comes evidence that has been interpreted as the remains of wind-breaks, or even a large tent-ring, up to about 8x5 m in size, of mainly mammoth bones enclosing a dense concentration of stone tools, animal bones and ash.</p>
    
    <p>D From the West European caves more evidence of built structures is available, and some of it goes back a long way in time. In the Grotte du Lazaret, near Nice, at a date during the last ice age but one, claims for some sort of skin tent within the cave have been advanced, on the basis of arrangements of large stones out from the cave wall that might have supported timber struts for a covering of skins up to the rock face above. At Lazaret, what might be openings in the hypothesised tents seem to point away from the cave mouth, and finds of wolf and fox foot bones, without the rest of the skeletons, inside these 'tents' have been thought to indicate the use of animal pelts as bed coverings. The two patches of ash at Lazaret that mark ancient fires, with stone tools around them evidently made and used on the spot, are edged with small marine mollusc shells, prompting the excavator to suggest that seaweed had been used as bedding around the fires. The cave of Baume-Bonne in the Basses-Alpes region of France, another early site, boasts ten square metres of cobbles brought up from the local river and laid down, as though to take care of a puddle area in the cave, with the smoothest and roundest surfaces of the stones uppermost, and there are other similar cases.</p>
    
    <p>E The ash encountered in concentrations at some sites testifies to the Neanderthal people's use of fire: not surprising, since use of fire was, by Neanderthal times, an already ancient accomplishment of evolving humanity, and survival in the sub-arctic conditions faced by the Neanderthalers is inconceivable without control of fire. Fire gave warmth, light, heat for cooking and defence against predatory animals. A charred piece of birch from Krapina in Croatia is thought to be the remains of a fire-making twirl stick. But Neanderthal hearths, in the sense of specially constructed places for fire, are fewer and harder to identify with certainty than the mere ash piles that are a regular feature of their sites. They seem often to have just lit a small fire (40-50 cm across) on the existing ground surface of the cave, without preparation. Judging from the shallow penetration of heat effects under the ash, this fire was only of short duration. Sometimes the fires were larger in size, up to one metre across, and quite irregular in shape. It is not always easy to decide how much additional structure some fires possessed: claims of stone circles to contain the fire run up against the fact that stones tend to litter the cave floors everywhere and those around a fire can quite accidentally look as though they were arranged in a circle.</p>
    
    <p>&nbsp;</p>
  </section>
  <div id="divider" title="Drag to resize"></div>
  <section class="pane" id="right">
    <h3>Questions</h3>
    
    <div class="group">
      <h4>Questions 27‚Äì31</h4>
      <p>Reading Passage 3 has five sections, A-E.</p>
      <p>Choose the correct heading for each section from the list of headings below.</p>
      <p>Write the correct number, i-vi, in boxes 27‚Äì31 on your answer sheet.</p>
      
      <a id="q27-anchor"></a>
      <div style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>27 Section A</p>
        <div class="dropzone" data-target="q27"><span class="droplabel">Drag answer here</span></div>
      </div>
      <a id="q28-anchor"></a>
      <div style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>28 Section B</p>
        <div class="dropzone" data-target="q28"><span class="droplabel">Drag answer here</span></div>
      </div>
      <a id="q29-anchor"></a>
      <div style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>29 Section C</p>
        <div class="dropzone" data-target="q29"><span class="droplabel">Drag answer here</span></div>
      </div>
      <a id="q30-anchor"></a>
      <div style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>30 Section D</p>
        <div class="dropzone" data-target="q30"><span class="droplabel">Drag answer here</span></div>
      </div>
      <a id="q31-anchor"></a>
      <div style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>31 Section E</p>
        <div class="dropzone" data-target="q31"><span class="droplabel">Drag answer here</span></div>
      </div>

      <h4>List of Headings</h4>
      <div class="cardpool" id="pool-27-31">
        <div class="card" draggable="true" data-value="i">i Evidence of outdoor dwellings</div>
        <div class="card" draggable="true" data-value="ii">ii Learning to make fire</div>
        <div class="card" draggable="true" data-value="iii">iii A perfect place to live</div>
        <div class="card" draggable="true" data-value="iv">iv Examining the cave contents</div>
        <div class="card" draggable="true" data-value="v">v Contrasting two types of home</div>
        <div class="card" draggable="true" data-value="vi">vi A vital source of power</div>
      </div>
    </div>
    
    <div class="group">
      <h4>Questions 32‚Äì36</h4>
      <p>Look at the following findings (Questions 32‚Äì36) and the list of places below.</p>
      <p>Match each finding with the correct place, A‚ÄìE.</p>
      <p>Write the correct letter, A‚ÄìE, in boxes 32‚Äì36 on your answer sheet.</p>
      <p>NB You may use any letter more than once.</p>
      
      <a id="q32-anchor"></a>
      <div style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>32 a burnt piece of wood</p>
        <div class="dropzone" data-target="q32"><span class="droplabel">Drag answer here</span></div>
      </div>
      <a id="q33-anchor"></a>
      <div style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>33 evidence of efforts to prevent pools of water forming</p>
        <div class="dropzone" data-target="q33"><span class="droplabel">Drag answer here</span></div>
      </div>
      <a id="q34-anchor"></a>
      <div style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>34 the remains of sea creatures</p>
        <div class="dropzone" data-target="q34"><span class="droplabel">Drag answer here</span></div>
      </div>
      <a id="q35-anchor"></a>
      <div style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>35 a circular arrangement of animal bones</p>
        <div class="dropzone" data-target="q35"><span class="droplabel">Drag answer here</span></div>
      </div>
      <a id="q36-anchor"></a>
      <div style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>36 evidence suggesting the use of animal fur for warmth</p>
        <div class="dropzone" data-target="q36"><span class="droplabel">Drag answer here</span></div>
      </div>
      
      <h4>List of Places</h4>
      <div class="cardpool" id="pool-32-36">
        <div class="card" draggable="true" data-value="A">A The P√©rigord region</div>
        <div class="card" draggable="true" data-value="B">B Moldova</div>
        <div class="card" draggable="true" data-value="C">C The Grotte du Lazaret</div>
        <div class="card" draggable="true" data-value="D">D The cave of Baume-Bonne</div>
        <div class="card" draggable="true" data-value="E">E Krapina</div>
      </div>
    </div>
    
    <div class="group">
      <h4>Questions 37‚Äì39</h4>
      <p>Complete the summary below.</p>
      <p>Choose NO MORE THAN TWO WORDS from the passage for each answer.</p>
      <p>Write your answers in boxes 37‚Äì39 on your answer sheet.</p>
      
      <p>The use of fire</p>
      <p>Neanderthalers could not have survived without fire because the conditions they lived in were <a id="q37-anchor"></a><input class="blank" maxlength="40" name="q37" placeholder="37"/></p>
      <p>Most evidence of purpose-built fires takes the form of ash piles, features of which suggest that the fires lasted a <a id="q38-anchor"></a><input class="blank" maxlength="40" name="q38" placeholder="38"/> time. It is hard to be certain about the size and structure of the fires, though they were certainly needed to protect the occupants from dangerous <a id="q39-anchor"></a><input class="blank" maxlength="40" name="q39" placeholder="39"/> among other things.</p>
    </div>
    
    <div class="group">
      <h4>Question 40</h4>
      <p>Choose the correct letter, A, B, C or D.</p>
      <p>Write the correct letter in box 40 on your answer sheet.</p>
      
      <a id="q40-anchor"></a>
      <div id="q40-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>40 The purpose of the writer of this article is to</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q40" type="radio" value="A"> A argue that Neanderthal homes were bigger than originally thought.</label>
          <label style="margin:0;"><input name="q40" type="radio" value="B"> B explain why Neanderthal people migrated to Western Europe.</label>
          <label style="margin:0;"><input name="q40" type="radio" value="C"> C discuss what is known about Neanderthal settlements.</label>
          <label style="margin:0;"><input name="q40" type="radio" value="D"> D track the progress of early Neanderthal development.</label>
        </div>
      </div>
    </div>

    <div style="display:flex;gap:8px;margin-bottom:10px;">
      <button class="primary" onclick="grade()">Submit</button>
      <button onclick="resetForm()">Reset</button>
      <button onclick="toggleNotes()">Notes</button>
    </div>
    <div id="results"></div>
    <details class="answerbox" id="answerBox">
      <summary>Show answers (click to toggle) <span class="badge">hidden</span></summary>
      <div id="answerContent"></div>
    </details>
  </section>
</div>
<div aria-label="Selection tools" id="selbar" role="toolbar">
  <button id="btnHL">Highlight</button>
  <button id="btnUH">Remove</button>
  <button id="btnNote">Note</button>
</div>
<div id="notes">
  <header>
    <strong>Notes</strong>
    <div>
      <button id="btnCopy">Copy</button>
      <button id="btnClose">Close</button>
    </div>
  </header>
  <textarea id="noteArea" placeholder="Type your notes here..."></textarea>
</div>
<div id="toast"></div>
<script>
// Timer
let _t = 0;
const _timerEl = document.getElementById('timer');
let timerInterval;

function startTimer() {
    if (timerInterval) return;
    timerInterval = setInterval(() => {
        _t++;
        const m = String(Math.floor(_t / 60)).padStart(2, '0');
        const s = String(_t % 60).padStart(2, '0');
        _timerEl.textContent = `${m}:${s}`;
    }, 1000);
}

function stopTimer() {
    clearInterval(timerInterval);
    timerInterval = null;
}

// Initial timer start on page load
window.onload = startTimer;

// Drag divider
var divider = document.getElementById('divider');
var left = document.getElementById('left');
var right = document.getElementById('right');
var dragging = false;
function startDrag(e){ 
  dragging = true; 
  document.body.style.cursor = 'ew-resize'; 
  if(e.preventDefault) e.preventDefault(); 
}
function endDrag(){ 
  dragging = false; 
  document.body.style.cursor = ''; 
}
function onMove(clientX){
  var container = document.querySelector('.shell').getBoundingClientRect();
  var x = clientX - container.left;
  x = Math.max(280, Math.min(container.width - 320, x));
  left.style.flex = '0 0 ' + x + 'px';
  right.style.flex = '1 1 auto';
}
divider.addEventListener('mousedown', function(e){ startDrag(e); });
window.addEventListener('mousemove', function(e){ if(dragging) onMove(e.clientX); });
window.addEventListener('mouseup', endDrag);
divider.addEventListener('touchstart', function(e){ startDrag(e.touches[0]); }, {passive:false});
window.addEventListener('touchmove', function(e){ if(dragging) onMove(e.touches[0].clientX); }, {passive:false});
window.addEventListener('touchend', endDrag);

// Drag and drop for questions
const cardPools = document.querySelectorAll('.cardpool');
const dropzones = document.querySelectorAll('.dropzone');
const initialCardHTML = {
  'pool-27-31': `
    <div class="card" draggable="true" data-value="i">i Evidence of outdoor dwellings</div>
    <div class="card" draggable="true" data-value="ii">ii Learning to make fire</div>
    <div class="card" draggable="true" data-value="iii">iii A perfect place to live</div>
    <div class="card" draggable="true" data-value="iv">iv Examining the cave contents</div>
    <div class="card" draggable="true" data-value="v">v Contrasting two types of home</div>
    <div class="card" draggable="true" data-value="vi">vi A vital source of power</div>
  `,
  'pool-32-36': `
    <div class="card" draggable="true" data-value="A">A The P√©rigord region</div>
    <div class="card" draggable="true" data-value="B">B Moldova</div>
    <div class="card" draggable="true" data-value="C">C The Grotte du Lazaret</div>
    <div class="card" draggable="true" data-value="D">D The cave of Baume-Bonne</div>
    <div class="card" draggable="true" data-value="E">E Krapina</div>
  `
};

function addDragListenersToCards(cards) {
    cards.forEach(card => {
        card.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', e.target.dataset.value);
            e.dataTransfer.setData('text/html', e.target.outerHTML);
            e.target.classList.add('dragging');
        });
        card.addEventListener('dragend', () => {
            card.classList.remove('dragging');
        });
    });
}

// Timer functionality
let timerRunning = false;
let timerPaused = false;

function toggleTimer() {
    const timer = document.getElementById('timer');
    
    if (!timerRunning && !timerPaused) {
        // Start timer
        startTimer();
        timerRunning = true;
        timer.classList.remove('paused');
    } else if (timerRunning && !timerPaused) {
        // Pause timer
        stopTimer();
        timerPaused = true;
        timerRunning = false;
        timer.classList.add('paused');
    } else if (!timerRunning && timerPaused) {
        // Resume timer
        startTimer();
        timerRunning = true;
        timerPaused = false;
        timer.classList.remove('paused');
    }
}

// Theme toggle
function toggleTheme() {
    document.body.classList.toggle('dark');
    const themeBtn = document.querySelector('.theme-toggle');
    themeBtn.textContent = document.body.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåô';
    
    // Save theme preference
    localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
}

// Load saved theme
if (localStorage.getItem('theme') === 'dark') {
    document.body.classList.add('dark');
    document.querySelector('.theme-toggle').textContent = '‚òÄÔ∏è';
}

// Navigation functionality
function scrollToElement(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // Update active state
        document.querySelectorAll('.q-item').forEach(item => item.classList.remove('active'));
        const navItem = document.getElementById(elementId.replace('-anchor', '-nav'));
        if (navItem) navItem.classList.add('active');
    }
}

// Complete the drag and drop functionality
dropzones.forEach(zone => {
    zone.addEventListener('dragover', (e) => {
        e.preventDefault();
        zone.classList.add('over');
    });
    
    zone.addEventListener('dragleave', () => {
        zone.classList.remove('over');
    });
    
    zone.addEventListener('drop', (e) => {
        e.preventDefault();
        zone.classList.remove('over');
        
        const value = e.dataTransfer.getData('text/plain');
        const cardHTML = e.dataTransfer.getData('text/html');
        
        if (value && cardHTML) {
            // Remove existing card if any
            const existingCard = zone.querySelector('.card');
            if (existingCard) {
                // Return to pool
                const poolId = zone.closest('.group').querySelector('.cardpool').id;
                const pool = document.getElementById(poolId);
                pool.appendChild(existingCard);
            }
            
            // Add new card
            zone.innerHTML = cardHTML;
            const newCard = zone.querySelector('.card');
            newCard.draggable = true;
            
            // Remove from pool
            const draggingCard = document.querySelector('.card.dragging');
            if (draggingCard) {
                draggingCard.remove();
            }
            
            // Add drag listeners to new card
            addDragListenersToCards([newCard]);
        }
    });
});

// Initialize drag listeners
document.querySelectorAll('.card').forEach(card => {
    addDragListenersToCards([card]);
});

// Grading functionality
const answers = {
    q27: 'v', q28: 'iii', q29: 'i', q30: 'iv', q31: 'vi',
    q32: 'E', q33: 'D', q34: 'C', q35: 'B', q36: 'C',
    q37: 'sub-arctic', q38: 'short', q39: 'predatory animals',
    q40: 'C'
};

function grade() {
    let correct = 0;
    let total = Object.keys(answers).length;
    let results = [];
    
    // Check drag-drop answers
    document.querySelectorAll('.dropzone').forEach(zone => {
        const questionId = zone.dataset.target;
        const card = zone.querySelector('.card');
        const userAnswer = card ? card.dataset.value : '';
        const correctAnswer = answers[questionId];
        
        if (userAnswer === correctAnswer) {
            correct++;
            results.push(`${questionId}: ‚úì ${userAnswer}`);
        } else {
            results.push(`${questionId}: ‚úó ${userAnswer || '(no answer)'} ‚Üí ${correctAnswer}`);
        }
    });
    
    // Check text inputs
    document.querySelectorAll('input.blank').forEach(input => {
        const questionId = input.name;
        const userAnswer = input.value.trim().toLowerCase();
        const correctAnswer = answers[questionId].toLowerCase();
        
        if (userAnswer === correctAnswer) {
            correct++;
            results.push(`${questionId}: ‚úì ${input.value}`);
        } else {
            results.push(`${questionId}: ‚úó ${input.value || '(no answer)'} ‚Üí ${answers[questionId]}`);
        }
    });
    
    // Check radio buttons
    document.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
        const questionId = radio.name;
        const userAnswer = radio.value;
        const correctAnswer = answers[questionId];
        
        if (userAnswer === correctAnswer) {
            correct++;
            results.push(`${questionId}: ‚úì ${userAnswer}`);
        } else {
            results.push(`${questionId}: ‚úó ${userAnswer} ‚Üí ${correctAnswer}`);
        }
    });
    
    const percentage = Math.round((correct / total) * 100);
    
    document.getElementById('results').innerHTML = `
        <h4>Results: ${correct}/${total} (${percentage}%)</h4>
        <div style="font-family: monospace; font-size: 13px; line-height: 1.4;">
            ${results.join('<br>')}
        </div>
    `;
    
    // Stop timer when grading
    if (timerRunning) {
        stopTimer();
        timerRunning = false;
        document.getElementById('timer').classList.remove('paused');
    }
}

function resetForm() {
    // Reset drag-drop questions
    document.querySelectorAll('.dropzone').forEach(zone => {
        const card = zone.querySelector('.card');
        if (card) {
            const poolId = zone.closest('.group').querySelector('.cardpool').id;
            const pool = document.getElementById(poolId);
            pool.appendChild(card);
        }
        zone.innerHTML = '<span class="droplabel">Drag answer here</span>';
    });
    
    // Reset pools
    Object.keys(initialCardHTML).forEach(poolId => {
        const pool = document.getElementById(poolId);
        pool.innerHTML = initialCardHTML[poolId];
        pool.querySelectorAll('.card').forEach(card => {
            addDragListenersToCards([card]);
        });
    });
    
    // Reset text inputs
    document.querySelectorAll('input.blank').forEach(input => {
        input.value = '';
    });
    
    // Reset radio buttons
    document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.checked = false;
    });
    
    // Reset results
    document.getElementById('results').innerHTML = '';
    
    // Reset timer
    _t = 0;
    document.getElementById('timer').textContent = '00:00';
    stopTimer();
    timerRunning = false;
    timerPaused = false;
    document.getElementById('timer').classList.remove('paused');
}

function toggleNotes() {
    const notes = document.getElementById('notes');
    notes.style.display = notes.style.display === 'flex' ? 'none' : 'flex';
}

document.getElementById('btnClose').onclick = () => {
    document.getElementById('notes').style.display = 'none';
};

document.getElementById('btnCopy').onclick = () => {
    const textarea = document.getElementById('noteArea');
    textarea.select();
    document.execCommand('copy');
};
</script>
</body>
</html>EventListener('dragend', (e) => {
            e.target.classList.remove('dragging');
        });
    });
}

// Initializing drag listeners
addDragListenersToCards(document.querySelectorAll('.card'));

dropzones.forEach(zone => {
  zone.addEventListener('dragover', e => {
    e.preventDefault();
    zone.classList.add('over');
  });
  
  zone.addEventListener('dragleave', () => {
    zone.classList.remove('over');
  });
  
  zone.addEventListener('drop', e => {
    e.preventDefault();
    zone.classList.remove('over');

    const dataValue = e.dataTransfer.getData('text/plain');
    const dataHtml = e.dataTransfer.getData('text/html');
    
    // Create a new card based on the dropped data
    const droppedCard = document.createElement('div');
    droppedCard.innerHTML = dataHtml;
    const cardEl = droppedCard.firstElementChild;
    
    if (cardEl) {
      const qNum = parseInt(zone.dataset.target.replace('q', ''));
      const oldCard = zone.querySelector('.card');
      
      // Handle returning old card to its original pool
      if (oldCard) {
          const originalPool = oldCard.closest('.cardpool');
          if (originalPool) {
              originalPool.appendChild(oldCard);
          } else {
              oldCard.remove();
          }
      }

      // Append the new card to the dropzone
      zone.innerHTML = '';
      zone.appendChild(cardEl);

      // Re-add drag listeners to the new card
      addDragListenersToCards([cardEl]);
      
      const targetQ = zone.dataset.target;
      document.getElementById(targetQ + '-nav').classList.add('answered');
    }
  });
});

// Highlight toolbar
var selbar = document.getElementById('selbar');
var btnHL = document.getElementById('btnHL');
var btnUH = document.getElementById('btnUH');
var btnNote = document.getElementById('btnNote');
var lastRange = null;
var currentHlNode = null;
var keepToolbar = false;
function positionSelbarForRect(rect){
  selbar.style.display = 'flex';
  requestAnimationFrame(function(){
    var top = window.scrollY + rect.top - selbar.offsetHeight - 8;
    var leftPos = window.scrollX + rect.left + rect.width / 2 - selbar.offsetWidth / 2;
    selbar.style.top = ((top > 0) ? top : (window.scrollY + rect.bottom + 8)) + 'px';
    selbar.style.left = Math.max(8, leftPos) + 'px';
  });
}
function updateSelbar(){
  var sel = window.getSelection();
  if (!sel || sel.rangeCount === 0 || sel.isCollapsed) { 
    selbar.style.display = 'none'; 
    currentHlNode = null; 
    return; 
  }
  var range = sel.getRangeAt(0);
  lastRange = range.cloneRange();
  currentHlNode = null;
  positionSelbarForRect(range.getBoundingClientRect());
}
document.getElementById('left').addEventListener('mouseup', updateSelbar);
document.getElementById('right').addEventListener('mouseup', updateSelbar);
document.addEventListener('selectionchange', function(){ 
  var sel = window.getSelection(); 
  if (!sel || sel.rangeCount === 0 || sel.isCollapsed) { 
    if (!keepToolbar && !currentHlNode) { 
      selbar.style.display = 'none'; 
    } 
  } 
});
document.addEventListener('scroll', function(){ 
  if (selbar.style.display === 'flex') updateSelbar(); 
});
document.addEventListener('mousedown', function(e){
  var t = e.target;
  if (t.classList && t.classList.contains('hl')) {
    keepToolbar = true;
  } else {
    keepToolbar = false;
  }
}, true);
document.addEventListener('click', function(e){
  var target = e.target;
  if (target.classList && target.classList.contains('hl')) {
    currentHlNode = target;
    lastRange = null;
    positionSelbarForRect(target.getBoundingClientRect());
    var sel = window.getSelection();
    if (sel) sel.removeAllRanges();
    setTimeout(function(){ keepToolbar = false; }, 0);
  }
}, true);
function doHighlight(){
  if(currentHlNode) return;
  if(!lastRange || lastRange.collapsed) return;
  var span = document.createElement('span'); span.className = 'hl';
  try { lastRange.surroundContents(span); }
  catch(e){
    var wrap = document.createElement('span'); wrap.className = 'hl';
    wrap.appendChild(lastRange.cloneContents());
    lastRange.deleteContents();
    lastRange.insertNode(wrap);
  }
  selbar.style.display = 'none';
  showToast('Highlighted');
}
function removeHighlight(){
  if(currentHlNode){
    var p = currentHlNode.parentNode;
    while(currentHlNode.firstChild) p.insertBefore(currentHlNode.firstChild, currentHlNode);
    p.removeChild(currentHlNode); p.normalize();
    currentHlNode = null;
    selbar.style.display = 'none';
    showToast('Highlight removed');
    return;
  }
  if(!lastRange) return;
  var selRect = lastRange.getBoundingClientRect();
  var walker = document.createTreeWalker(document.body, NodeFilter.SHOW_ELEMENT);
  var toRemove = [];
  while(walker.nextNode()){
    var n = walker.currentNode;
    if(n.classList && n.classList.contains('hl')) {
      var r = n.getBoundingClientRect();
      if(!(r.right < selRect.left || r.left > selRect.right || r.bottom < selRect.top || r.top > selRect.bottom)) toRemove.push(n);
    }
  }
  toRemove.forEach(function(el){ var p = el.parentNode; while(el.firstChild) p.insertBefore(el.firstChild, el); p.removeChild(el); p.normalize(); });
  selbar.style.display = 'none';
  showToast('Highlight removed');
}
btnHL.addEventListener('click', doHighlight);
btnUH.addEventListener('click', removeHighlight);

// Notes
var notes = document.getElementById('notes');
var noteArea = document.getElementById('noteArea');
var btnCopy = document.getElementById('btnCopy');
var btnClose = document.getElementById('btnClose');
function toggleNotes(){ 
  notes.style.display = (notes.style.display === 'flex' ? 'none' : 'flex'); 
}
window.toggleNotes = toggleNotes;
btnClose.addEventListener('click', toggleNotes);
btnCopy.addEventListener('click', async function(){ 
  await navigator.clipboard.writeText(noteArea.value || ''); 
  showToast('Copied'); 
});
btnNote.addEventListener('click', function(){
  var text = '';
  if (currentHlNode) { 
    text = (currentHlNode.textContent || '').trim(); 
  } else if (lastRange) { 
    var frag = lastRange.cloneContents(); 
    text = (frag.textContent || '').trim(); 
  }
  toggleNotes();
  if (text) {
    noteArea.value = (noteArea.value ? noteArea.value + '\n' : '') + '> ' + text + '\n';
  }
  selbar.style.display = 'none';
});

// Toast
var toastEl = document.getElementById('toast');
function showToast(msg){
  toastEl.textContent = msg; 
  toastEl.style.display = 'block';
  setTimeout(function(){ toastEl.style.display = 'none'; }, 1200);
}

// Answer key and grading
var answers = {
  "q27":"v", "q28":"iii", "q29":"i", "q30":"iv", "q31":"vi",
  "q32":"E", "q33":"D", "q34":"C", "q35":"B", "q36":"C",
  "q37":"sub-arctic", "q38":"short", "q39":"predatory animals",
  "q40":"C"
};
const cardValueToText = {
  "i": "i Evidence of outdoor dwellings", "ii": "ii Learning to make fire", "iii": "iii A perfect place to live",
  "iv": "iv Examining the cave contents", "v": "v Contrasting two types of home", "vi": "vi A vital source of power",
  "A": "A The P√©rigord region", "B": "B Moldova", "C": "C The Grotte du Lazaret",
  "D": "D The cave of Baume-Bonne", "E": "E Krapina"
};

function grade(){
  stopTimer();
  var total=0, correct=0, lines=[];
  
  // Check drag-and-drop questions (27-36)
  for(let n=27; n<=36; n++){
    const q = `q${n}`;
    total++;
    const dropzone = document.querySelector(`.dropzone[data-target="${q}"]`);
    const selectedCard = dropzone ? dropzone.querySelector('.card') : null;
    const userAnswer = selectedCard ? selectedCard.dataset.value : '';
    const isCorrect = userAnswer === answers[q];
    let userDisplay = selectedCard ? selectedCard.textContent.trim() : 'None';
    let resultLine = `${q.toUpperCase()}: ${userDisplay} ${isCorrect ? '‚úÖ' : '‚ùå'}`;
    if (!isCorrect) {
      const correctText = cardValueToText[answers[q]] || answers[q];
      resultLine += ` (Correct: ${correctText})`;
    }
    lines.push(resultLine);
    if (isCorrect) correct++;
  }
  
  // Check text input questions (37-39)
  for(let n=37; n<=39; n++){
    const q = `q${n}`;
    total++;
    const input = document.querySelector(`input[name="${q}"]`);
    const userAnswer = input ? input.value.trim().toLowerCase() : '';
    const isCorrect = userAnswer === answers[q].toLowerCase();
    let resultLine = `${q.toUpperCase()}: ${userAnswer || 'None'} ${isCorrect ? '‚úÖ' : '‚ùå'}`;
    if (!isCorrect) {
      resultLine += ` (Correct: ${answers[q]})`;
    }
    lines.push(resultLine);
    if (isCorrect) correct++;
  }
  
  // Check radio question (40)
  const q = 'q40';
  total++;
  const selected = document.querySelector(`input[name="${q}"]:checked`);
    const userAnswer = selected ? selected.value : '';
  const isCorrect = userAnswer === answers[q];
  let userDisplay = userAnswer || 'None';
  let resultLine = `${q.toUpperCase()}: ${userDisplay} ${isCorrect ? '‚úÖ' : '‚ùå'}`;
  if (!isCorrect) {
    resultLine += ` (Correct: ${answers[q]})`;
  }
  lines.push(resultLine);
  if (isCorrect) correct++;

  // Show results
  const acc = Math.round(100 * correct / total);
  document.getElementById('results').innerHTML = `
    <p><strong>Score:</strong> ${correct}/${total} <span class="badge">Accuracy ${acc}%</span></p>
    <pre>${lines.join('\n')}</pre>
  `;
  
  // Show answer key
  const answerContent = `
    <table>
      <thead>
        <tr>
          <th>Question</th>
          <th>Answer</th>
          <th>Location</th>
        </tr>
      </thead>
      <tbody>
        <tr><td>27</td><td>v</td><td>Section A</td></tr>
        <tr><td>28</td><td>iii</td><td>Section B</td></tr>
        <tr><td>29</td><td>i</td><td>Section C</td></tr>
        <tr><td>30</td><td>iv</td><td>Section D</td></tr>
        <tr><td>31</td><td>vi</td><td>Section E</td></tr>
        <tr><td>32</td><td>E</td><td>Section E</td></tr>
        <tr><td>33</td><td>D</td><td>Section D</td></tr>
        <tr><td>34</td><td>C</td><td>Section D</td></tr>
        <tr><td>35</td><td>B</td><td>Section C</td></tr>
        <tr><td>36</td><td>C</td><td>Section D</td></tr>
        <tr><td>37</td><td>sub-arctic</td><td>Section E</td></tr>
        <tr><td>38</td><td>short</td><td>Section E</td></tr>
        <tr><td>39</td><td>predatory animals</td><td>Section E</td></tr>
        <tr><td>40</td><td>C</td><td>Full article</td></tr>
      </tbody>
    </table>
  `;
  document.getElementById('answerContent').innerHTML = answerContent;
  document.querySelector('#answerBox .badge').textContent = 'tap to view';
}

function resetForm(){
  // Reset all dropzones
  document.querySelectorAll('.dropzone').forEach(zone => {
    zone.innerHTML = '<span class="droplabel">Drag answer here</span>';
  });
  
  // Reset all card pools
  document.getElementById('pool-27-31').innerHTML = initialCardHTML['pool-27-31'];
  document.getElementById('pool-32-36').innerHTML = initialCardHTML['pool-32-36'];
  
  // Re-add event listeners to the cards
  addDragListenersToCards(document.querySelectorAll('.card'));
  
  // Reset text inputs
  document.querySelectorAll('input.blank').forEach(input => {
    input.value = "";
  });
  
  // Reset radio buttons
  document.querySelectorAll('input[type="radio"]').forEach(radio => {
    radio.checked = false;
  });
  
  // Reset results and answers
  document.getElementById('results').innerHTML = '';
  document.getElementById('answerContent').innerHTML = '';
  document.querySelector('#answerBox .badge').textContent = 'hidden';
  
  // Reset answered status in nav
  document.querySelectorAll('.q-item').forEach(item => {
    item.classList.remove('answered');
  });
  
  _t = 0;
  _timerEl.textContent = '00:00';
  startTimer();
}

function scrollToElement(id){
  const el = document.getElementById(id);
  if (el) { 
    el.scrollIntoView({ behavior: 'smooth', block: 'center' }); 
  }
  const navs = document.querySelectorAll('.practice-nav .q-item');
  navs.forEach(n => n.classList.remove('active'));
  const btn = document.getElementById(id.replace('-anchor','-nav'));
  if (btn) { 
    btn.classList.add('active'); 
    setTimeout(() => btn.classList.remove('active'), 800); 
  }
}

// Mark answered on interaction
(function(){
  function markAnswered(qn){
    const nav = document.getElementById(`q${qn}-nav`);
    if (!nav) return;
    let answered = false;
    
    // Check dropzones
    if (qn >= 27 && qn <= 36) {
      const zone = document.querySelector(`.dropzone[data-target="q${qn}"]`);
      answered = zone.querySelector('.card') !== null;
    } 
    // Check text inputs
    else if (qn >= 37 && qn <= 39) {
      const input = document.querySelector(`input[name="q${qn}"]`);
      answered = input && input.value.trim().length > 0;
    }
    // Check radio buttons
    else {
      const radios = document.querySelectorAll(`input[name="q${qn}"]:checked`);
      answered = radios.length > 0;
    }
    
    if (answered) nav.classList.add('answered');
    else nav.classList.remove('answered');
  }
  
  dropzones.forEach(zone => {
    zone.addEventListener('drop', () => {
      const qn = zone.dataset.target.replace('q', '');
      markAnswered(qn);
    });
  });
  
  for (let n=37; n<=39; n++) {
    document.querySelector(`input[name="q${n}"]`).addEventListener('input', () => markAnswered(n));
  }
  
  document.querySelector(`input[name="q40"]`).addEventListener('change', () => markAnswered(40));
})();
</script>

<!-- ÁªÉ‰π†È°µÈù¢Êï∞ÊçÆ‰º†ËæìÂ¢ûÂº∫ËÑöÊú¨ -->
<script>
// Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÊúâÂ¢ûÂº∫ËÑöÊú¨
if (!window.practicePageEnhancer) {
    // Âä®ÊÄÅÂä†ËΩΩÂ¢ûÂº∫ËÑöÊú¨
    const script = document.createElement('script');
    script.src = '../../js/practice-page-enhancer.js';
    script.onload = function() {
        console.log('ÁªÉ‰π†È°µÈù¢Â¢ûÂº∫ËÑöÊú¨Â∑≤Âä†ËΩΩ');
    };
    script.onerror = function() {
        console.error('ÁªÉ‰π†È°µÈù¢Â¢ûÂº∫ËÑöÊú¨Âä†ËΩΩÂ§±Ë¥•');
        // ÈôçÁ∫ßÂà∞ÂÜÖËÅîÂ¢ûÂº∫
        loadInlineEnhancer();
    };
    document.head.appendChild(script);
}

// ÂÜÖËÅîÂ¢ûÂº∫Âô®ÔºàÈôçÁ∫ßÊñπÊ°àÔºâ
function loadInlineEnhancer() {
    if (window.practicePageEnhancer) return;
    
    window.practicePageEnhancer = {
        initialize: function() {
            console.log('[InlineEnhancer] ÂÜÖËÅîÂ¢ûÂº∫Âô®Â∑≤ÂàùÂßãÂåñ');
            this.setupCommunication();
            this.setupAnswerListeners();
            this.interceptSubmit();
        },
        
        setupCommunication: function() {
            this.parentWindow = window.opener || window.parent;
            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'INIT_SESSION') {
                    this.sessionId = event.data.data.sessionId;
                    this.sendMessage('SESSION_READY', {
                        pageType: this.detectPageType(),
                        url: window.location.href
                    });
                }
            });
        },
        
        detectPageType: function() {
            const title = document.title || '';
            if (title.includes('P1')) return 'P1';
            if (title.includes('P2')) return 'P2';
            if (title.includes('P3')) return 'P3';
            return 'unknown';
        },
        
        setupAnswerListeners: function() {
            this.answers = {};
            this.startTime = Date.now();
            
            document.addEventListener('change', (e) => {
                if (e.target.name && e.target.name.startsWith('q')) {
                    this.answers[e.target.name] = e.target.value;
                }
            });
        },
        
        interceptSubmit: function() {
            // Êã¶Êà™gradeÂáΩÊï∞
            if (typeof window.grade === 'function') {
                const originalGrade = window.grade;
                window.grade = () => {
                    const result = originalGrade();
                    setTimeout(() => this.handleSubmit(), 200);
                    return result;
                };
            }
            
            // ÁõëÂê¨Êèê‰∫§ÊåâÈíÆ
            document.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' && 
                    (e.target.textContent.includes('Submit') || 
                     e.target.onclick && e.target.onclick.toString().includes('grade'))) {
                    setTimeout(() => this.handleSubmit(), 300);
                }
            });
        },
        
        handleSubmit: function() {
            const results = {
                sessionId: this.sessionId,
                startTime: this.startTime,
                endTime: Date.now(),
                duration: Math.round((Date.now() - this.startTime) / 1000),
                answers: this.answers,
                scoreInfo: this.extractScore(),
                pageType: this.detectPageType(),
                url: window.location.href
            };
            
            this.sendMessage('PRACTICE_COMPLETE', results);
        },
        
        extractScore: function() {
            const resultsEl = document.getElementById('results');
            if (!resultsEl) return null;
            
            const text = resultsEl.textContent || '';
            const scoreMatch = text.match(/Score:\s*(\d+)\/(\d+)/i);
            if (scoreMatch) {
                const correct = parseInt(scoreMatch[1]);
                const total = parseInt(scoreMatch[2]);
                return {
                    correct: correct,
                    total: total,
                    accuracy: total > 0 ? correct / total : 0,
                    percentage: Math.round((correct / total) * 100),
                    source: 'inline_extraction'
                };
            }
            return null;
        },
        
        sendMessage: function(type, data) {
            if (this.parentWindow) {
                this.parentWindow.postMessage({
                    type: type,
                    data: data,
                    source: 'practice_page'
                }, '*');
            }
        }
    };
    
    // ÂàùÂßãÂåñ
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            window.practicePageEnhancer.initialize();
        });
    } else {
        window.practicePageEnhancer.initialize();
    }
}

// Initialize modern features
function initModernFeatures() {
  loadTheme();
  startTimer();
  
  // Make timer clickable
  const timer = document.getElementById('timer');
  if (timer && !timer.onclick) {
    timer.onclick = toggleTimer;
  }
  
  showToast('Modern features loaded');
}

// Auto-initialize when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initModernFeatures);
} else {
  initModernFeatures();
}
</script>

<script>
// ÂÖ®Èù¢‰øÆÂ§çÁöÑJavaScriptÂäüËÉΩ
(function() {
  // Èò≤Ê≠¢ÈáçÂ§çÂä†ËΩΩ
  if (window.comprehensiveFixLoaded) return;
  window.comprehensiveFixLoaded = true;
  
  console.log('Loading comprehensive P3 fixes...');
  
  // ËÆ°Êó∂Âô®ÂèòÈáè
  let timerSeconds = 0;
  let timerInterval = null;
  let timerPaused = false;
  
  // Âº∫Âà∂Ë¶ÜÁõñËÆ°Êó∂Âô®ÂáΩÊï∞
  window.startTimer = function() {
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(() => {
      if (!timerPaused) {
        timerSeconds++;
        updateTimerDisplay();
      }
    }, 1000);
    console.log('Timer started');
  };
  
  window.updateTimerDisplay = function() {
    const minutes = Math.floor(timerSeconds / 60);
    const seconds = timerSeconds % 60;
    const timerEl = document.getElementById('timer');
    if (timerEl) {
      timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
  };
  
  window.toggleTimer = function() {
    timerPaused = !timerPaused;
    const timerEl = document.getElementById('timer');
    if (timerEl) {
      timerEl.classList.toggle('paused', timerPaused);
      timerEl.style.background = timerPaused ? '#fef3c7' : '';
      timerEl.style.color = timerPaused ? '#92400e' : '';
    }
    
    if (!timerInterval) {
      window.startTimer();
    }
    
    showToast(timerPaused ? 'Timer paused ‚è∏Ô∏è' : 'Timer resumed ‚ñ∂Ô∏è');
  };
  
  // Âº∫Âà∂Ë¶ÜÁõñ‰∏ªÈ¢òÂàáÊç¢ÂáΩÊï∞
  window.toggleTheme = function() {
    const body = document.body;
    const themeButton = document.querySelector('.theme-toggle');
    
    body.classList.toggle('dark');
    const isDark = body.classList.contains('dark');
    
    if (themeButton) {
      themeButton.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
    }
    
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    showToast(`Switched to ${isDark ? 'dark' : 'light'} theme`);
    
    console.log('Theme toggled to:', isDark ? 'dark' : 'light');
  };
  
  window.loadTheme = function() {
    const savedTheme = localStorage.getItem('theme');
    const body = document.body;
    const themeButton = document.querySelector('.theme-toggle');
    
    if (savedTheme === 'dark') {
      body.classList.add('dark');
      if (themeButton) themeButton.textContent = '‚òÄÔ∏è';
    } else {
      body.classList.remove('dark');
      if (themeButton) themeButton.textContent = 'üåô';
    }
    
    console.log('Theme loaded:', savedTheme || 'light');
  };
  
  // ToastÈÄöÁü•Á≥ªÁªü
  window.showToast = function(message) {
    let toast = document.getElementById('toast');
    if (!toast) {
      toast = document.createElement('div');
      toast.id = 'toast';
      toast.style.cssText = `
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        bottom: 100px;
        background: #111;
        color: #fff;
        padding: 12px 20px;
        border-radius: 8px;
        display: none;
        z-index: 2500;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      `;
      document.body.appendChild(toast);
    }
    
    toast.textContent = message;
    toast.style.display = 'block';
    
    setTimeout(() => {
      toast.style.display = 'none';
    }, 2500);
  };
  
  // È´ò‰∫ÆÂäüËÉΩ‰øÆÂ§ç
  window.doHighlight = function(color) {
    const selection = window.getSelection();
    if (selection.rangeCount > 0) {
      const range = selection.getRangeAt(0);
      const span = document.createElement('span');
      span.className = 'hl';
      span.style.backgroundColor = color || '#fbbf24';
      span.style.color = document.body.classList.contains('dark') ? '#1f2937' : 'inherit';
      
      try {
        range.surroundContents(span);
        selection.removeAllRanges();
        showToast('Text highlighted');
      } catch (e) {
        console.log('Highlight failed:', e);
      }
    }
  };
  
  window.removeHighlight = function() {
    const highlights = document.querySelectorAll('.hl');
    highlights.forEach(hl => {
      const parent = hl.parentNode;
      parent.insertBefore(document.createTextNode(hl.textContent), hl);
      parent.removeChild(hl);
    });
    showToast('Highlights removed');
  };
  
  // Á¨îËÆ∞ÂäüËÉΩ‰øÆÂ§ç
  window.toggleNotes = function() {
    const notes = document.getElementById('notes');
    if (notes) {
      const isVisible = notes.style.display !== 'none';
      notes.style.display = isVisible ? 'none' : 'block';
      showToast(isVisible ? 'Notes hidden' : 'Notes shown');
    }
  };
  
  // ÊªöÂä®Âà∞ÂÖÉÁ¥†
  window.scrollToElement = function(id) {
    const element = document.getElementById(id);
    if (element) {
      element.scrollIntoView({ behavior: 'smooth', block: 'start' });
      showToast(`Scrolled to question ${id.replace('q', '')}`);
    }
  };
  
  // Á≠îÊ°àÁä∂ÊÄÅÊõ¥Êñ∞
  window.updateAnswerStatus = function() {
    const questions = document.querySelectorAll('[id^="q"]');
    questions.forEach(q => {
      const qNum = q.id.replace('q', '');
      const navItem = document.querySelector(`.q-item[onclick*="q${qNum}"]`);
      if (navItem) {
        const hasAnswer = q.querySelector('input:checked, input.blank[value!=""]');
        navItem.classList.toggle('answered', !!hasAnswer);
      }
    });
  };
  
  // Ë°®ÂçïÈáçÁΩÆ
  window.resetForm = function() {
    const form = document.querySelector('form');
    if (form) {
      form.reset();
      document.querySelectorAll('.hl').forEach(hl => {
        const parent = hl.parentNode;
        parent.insertBefore(document.createTextNode(hl.textContent), hl);
        parent.removeChild(hl);
      });
      updateAnswerStatus();
      showToast('Form reset');
    }
  };
  
  // ÂàùÂßãÂåñÂáΩÊï∞
  function initComprehensiveFixes() {
    console.log('Initializing comprehensive fixes...');
    
    // Âä†ËΩΩ‰∏ªÈ¢ò
    loadTheme();
    
    // ÂêØÂä®ËÆ°Êó∂Âô®
    startTimer();
    
    // ÁªëÂÆöËÆ°Êó∂Âô®ÁÇπÂáª‰∫ã‰ª∂
    const timer = document.getElementById('timer');
    if (timer) {
      timer.onclick = toggleTimer;
      timer.style.cursor = 'pointer';
      timer.title = 'Click to pause/resume timer';
    }
    
    // ÁªëÂÆö‰∏ªÈ¢òÂàáÊç¢ÊåâÈíÆ
    const themeButton = document.querySelector('.theme-toggle');
    if (themeButton) {
      themeButton.onclick = toggleTheme;
      themeButton.title = 'Toggle dark/light theme';
    }
    
    // ÁªëÂÆöÁ≠îÊ°àÂèòÂåñÁõëÂê¨
    document.addEventListener('change', updateAnswerStatus);
    document.addEventListener('input', updateAnswerStatus);
    
    // ÁªëÂÆöÈ´ò‰∫ÆÈÄâÊã©‰∫ã‰ª∂
    document.addEventListener('mouseup', function() {
      const selection = window.getSelection();
      if (selection.toString().length > 0) {
        // ÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†È´ò‰∫ÆÂ∑•ÂÖ∑Ê†èÊòæÁ§∫ÈÄªËæë
      }
    });
    
    // ÂàùÂßãÂåñÁ≠îÊ°àÁä∂ÊÄÅ
    setTimeout(updateAnswerStatus, 500);
    
    showToast('All features loaded successfully! ‚úÖ');
    console.log('Comprehensive fixes initialized successfully');
  }
  
  // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initComprehensiveFixes);
  } else {
    initComprehensiveFixes();
  }
  
})();
</script>
</body>
</html>
