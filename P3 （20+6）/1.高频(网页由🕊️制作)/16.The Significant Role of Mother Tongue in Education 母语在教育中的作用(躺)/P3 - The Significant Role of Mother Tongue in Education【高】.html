<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>P3 - The Significant Role of Mother Tongue in Education</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<style>
  :root { --line:#e5e7eb; --bg:#f6f7fb; --panel:#fff; --accent:#3b82f6; --muted:#6b7280; --shadow:0 6px 20px rgba(0,0,0,.12); }
  * { box-sizing: border-box; }
  html,body { height:100%; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); }
  #timer { position: static; display: inline-block; margin-left: 8px; background:#fff; border:1px solid var(--line); border-radius:10px; padding:2px 8px; font-size:14px; vertical-align: middle; }
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:var(--panel); overflow:auto; padding:20px; }
  #left { flex: 0 0 50%; min-width: 280px; }
  #right { flex: 1 1 auto; min-width: 320px; background:#fbfbff; border-left:1px solid var(--line); }
  #divider { flex: 0 0 8px; background: linear-gradient(90deg,#e5e7eb,#d1d5db); cursor: ew-resize; position:relative; z-index: 5; user-select:none; }
  h2,h3,h4 { margin:0 0 10px; }
  #left p { margin: 0 0 12px; line-height: 1.6; word-break: normal; overflow-wrap: normal; hyphens: none; }
  .group { background:#fff; border:1px solid var(--line); border-radius:10px; padding:12px; margin-bottom:14px; }
  table { border-collapse: collapse; width:100%; }
  th, td { border:1px solid var(--line); padding:6px; text-align:center; font-size:14px; }
  th:first-child, td:first-child { width:92px; }
  button { padding:8px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; cursor:pointer; }
  button.primary { background:var(--accent); color:#fff; border-color:#3b82f6; }
  #results { background:#fff; border:1px solid var(--line); border-radius:10px; padding:10px; }
  .hl { background:#fff3a3; box-shadow: inset 0 -2px 0 rgba(0,0,0,.05); cursor: pointer; }
  .hl:hover { filter: brightness(0.98); }
  #selbar { position: absolute; display:none; z-index: 2000; background:#111; color:#fff; border-radius: 8px; padding: 6px; box-shadow: var(--shadow); font-size: 13px; gap:6px; align-items: center; }
  #selbar button { background: transparent; color:#fff; border: 1px solid rgba(255,255,255,.25); padding: 4px 8px; border-radius: 6px; cursor:pointer; }
  #selbar button:hover { border-color:#fff; }
  #notes { position: fixed; right: 12px; bottom: 12px; width: 320px; height: 42vh; background:#fff; border:1px solid var(--line); border-radius: 12px; display:none; flex-direction: column; z-index:1500; box-shadow: var(--shadow); }
  #notes header { display:flex; align-items:center; justify-content: space-between; padding:8px 10px; border-bottom:1px solid var(--line); }
  #notes textarea { flex:1; border:0; padding:10px; resize:none; font-size:14px; line-height:1.5; }
  #toast { position: fixed; left:50%; transform: translateX(-50%); bottom: 24px; background:#111; color:#fff; padding:8px 12px; border-radius: 8px; display:none; z-index:2500; }
  .dropzone { border:2px dashed #cbd5e1; background:#f8fafc; border-radius:10px; min-height:40px; padding:4px 8px; display:inline-flex; align-items:center; justify-content:space-between; gap:8px; width: auto; min-width: 120px; max-width: 200px; vertical-align: middle; }
  .droplabel { color:#64748b; font-size:14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .cardpool { background:#f1f5f9; border-radius:10px; padding:12px; display:flex; flex-wrap:wrap; gap:8px; }
  .pool-slot { min-height:40px; }
  .card { background:#fff; border:1px solid #e5e7eb; border-radius:8px; padding:8px 10px; display:inline-flex; gap:8px; align-items:center; cursor:grab; box-shadow:0 1px 0 rgba(0,0,0,.03); white-space: nowrap; }
  .card:active { cursor:grabbing; }
  .tag { background:#eef2ff; color:#4338ca; padding:2px 8px; border-radius:999px; font-size:12px; }
  .btn-clear { border:1px solid #e5e7eb; background:#fff; border-radius:8px; padding:6px 8px; cursor:pointer; }
  .ghost { opacity: .5; }
  .over { outline:2px dashed #3b82f6; }
  details.answerbox summary { cursor: pointer; user-select:none; list-style: none; }
  details.answerbox { border:1px dashed var(--line); border-radius:10px; padding:8px 10px; background:#fff; }
  .badge { display:inline-block; background:#eef2ff; color:#4338ca; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:6px; }
  body { padding-bottom: 82px; }
  .practice-nav { background:#fff; border-bottom:2px solid var(--line); padding:12px 20px; display:flex; align-items:center; gap:20px; box-shadow:0 2px 4px rgba(0,0,0,.05); flex-wrap:wrap; position:fixed; left:0; right:0; bottom:0; border-top:2px solid var(--line); border-bottom:0; z-index:4000; }
  .practice-nav .title { font-weight:600; color:var(--muted); }
  .practice-nav .questions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .practice-nav .q-item { padding:6px 10px; border:1px solid var(--line); border-radius:6px; background:#fff; cursor:pointer; font-size:14px; transition:all 0.2s; min-width:36px; text-align:center; }
  .practice-nav .q-item:hover { background:#f1f5f9; border-color:var(--accent); }
  .practice-nav .q-item.answered { background:#e0e7ff; border-color:var(--accent); color:var(--accent); font-weight:500; }
  .practice-nav .q-item.active { background:var(--accent); color:#fff; border-color:var(--accent); }
  #selbar { z-index: 6000 !important; }
</style>
</head>
<body>
<div class="practice-nav">
  <div class="title">Questions</div>
  <div class="questions">
    <div class="q-item" id="q27-nav" onclick="scrollToElement('q27-anchor')">27</div>
    <div class="q-item" id="q28-nav" onclick="scrollToElement('q28-anchor')">28</div>
    <div class="q-item" id="q29-nav" onclick="scrollToElement('q29-anchor')">29</div>
    <div class="q-item" id="q30-nav" onclick="scrollToElement('q30-anchor')">30</div>
    <div class="q-item" id="q31-nav" onclick="scrollToElement('q31-anchor')">31</div>
    <div class="q-item" id="q32-nav" onclick="scrollToElement('q32-anchor')">32</div>
    <div class="q-item" id="q33-nav" onclick="scrollToElement('q33-anchor')">33</div>
    <div class="q-item" id="q34-nav" onclick="scrollToElement('q34-anchor')">34</div>
    <div class="q-item" id="q35-nav" onclick="scrollToElement('q35-anchor')">35</div>
    <div class="q-item" id="q36-nav" onclick="scrollToElement('q36-anchor')">36</div>
    <div class="q-item" id="q37-nav" onclick="scrollToElement('q37-anchor')">37</div>
    <div class="q-item" id="q38-nav" onclick="scrollToElement('q38-anchor')">38</div>
    <div class="q-item" id="q39-nav" onclick="scrollToElement('q39-anchor')">39</div>
    <div class="q-item" id="q40-nav" onclick="scrollToElement('q40-anchor')">40</div>
  </div>
</div>
<div class="shell">
  <section class="pane" id="left">
    <h2>READING PASSAGE 3 <span id="timer">00:00</span></h2>
    <p>You should spend about 20 minutes on Questions 27–40, which are based on Reading Passage 3 below.</p>
    <h3>The Significant Role of Mother Tongue in Education</h3>
    
    <p>One consequence of population mobility is an increasing diversity within schools. To illustrate, in the city of Toronto in Canada, 58% of kindergarten pupils come from homes where English is not the usual language of communication. Schools in Europe and North America have experienced this diversity for years, and educational policies and practices vary widely between countries and even within countries. Some political parties and groups search for ways to solve the problem of diverse communities and their integration in schools and society. However, they see few positive consequences for the host society and worry that this diversity threatens the identity of the host society. Consequently, they promote unfortunate educational policies that will make the “problem” disappear. If students retain their culture and language, they are viewed as less capable of identifying with the mainstream culture and learning the mainstream language of the society.</p>
    
    <p>The challenge for educators and policy-makers is to shape the evolution of national identity in such a way that the rights of all citizens (including school children) are respected, and the cultural, linguistic, and economic resources of the nation are maximised. To waste the resources of the nation by discouraging children from developing their mother tongues is quite simply unintelligent from the point of view of national self-interest. A first step in providing an appropriate education for culturally and linguistically diverse children is to examine what the existing research says about the role of children's mother tongues in their educational development.</p>
    
    <p>In fact, the research is very clear. When children continue to develop their abilities in two or more languages throughout their primary school, they gain a deeper understanding of language and how to use it effectively. They have more practice in processing language, especially when they develop literacy in both. More than 150 research studies conducted during the past 25 years strongly support what Goethe, the famous eighteenth-century German philosopher, once said: the person who knows only one language does not truly know that language. Research suggests that bilingual children may also develop more flexibility in their thinking as a result of processing information through two different languages.</p>
    
    <p>The level of development of children's mother tongue is a strong predictor of their second language development. Children who come to school with a solid foundation in their mother tongue develop stronger literacy abilities in the school language. When parents and other caregivers (e.g., grandparents) are able to spend time with their children and tell stories or discuss issues with them in a way that develops their mother tongue, children come to school well-prepared to learn the school language and succeed educationally. Children's knowledge and skills transfer across languages from the mother tongue to the school language. Transfer across languages can be two-way: both languages nurture each other when the educational environment permits children access to both languages.</p>
    
    <p>Some educators and parents are suspicious of mother tongue-based teaching programs because they worry that they take time away from the majority language. For example, in a bilingual program when 50% of the time is spent teaching through children's home language and 50% through the majority language, surely children won't progress as far in the latter? One of the most strongly established findings of educational research, however, is that well-implemented bilingual programs can promote literacy and subject-matter knowledge in a minority language without any negative effects on children's development in the majority language. Within Europe, the Foyer program in Belgium, which develops children's speaking and literacy abilities in three languages (their mother tongue, Dutch and French), most clearly illustrates the benefits of bilingual and trilingual education (see Cummins, 2000).</p>
    
    <p>It is easy to understand how this happens. When children are learning through a minority language, they are learning concepts and intellectual skills too. Pupils who know how to tell the time in their mother tongue understand the concept of telling time. In order to tell time in the majority language, they do not need to re-learn the concept. Similarly, at more advanced stages, there is transfer across languages in other skills such as knowing how to distinguish the main idea from the supporting details of a written passage or story, and distinguishing fact from opinion. Studies of secondary school pupils are providing interesting findings in this area, and it would be worth extending this research.</p>
    
    <p>Many people marvel at how quickly bilingual children seem to “pick up” conversational skills in the majority language at school (although it takes much longer for them to catch up with native speakers in academic language skills). However, educators are often much less aware of how quickly children can lose their ability to use their mother tongue, even in the home context. The extent and rapidity of language loss will vary according to the concentration of families from a particular linguistic group in the neighborhood. Where the mother tongue is used extensively in the community, then language loss among young children will be less. However, where language communities are not concentrated in particular neighborhoods, children can lose their ability to communicate in their mother tongue within 2–3 years of starting school. They may retain receptive skills in the language but they will use the majority language in speaking with their peers and siblings and in responding to their parents. By the time children become adolescents, the linguistic division between parents and children has become an emotional chasm. Pupils frequently become alienated from the cultures of both home and school with predictable results.</p>
    
    <p>&nbsp;</p>
  </section>
  <div id="divider" title="Drag to resize"></div>
  <section class="pane" id="right">
    <h3>Questions</h3>
    
    <div class="group">
      <h4>Questions 27–30</h4>
      <p>Choose the correct letter, A, B, C or D.</p>
      <p>Write the correct letter in boxes 27–30 on your answer sheet.</p>
      
      <a id="q27-anchor"></a>
      <div id="q27-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>27 What point did the writer make in the second paragraph?</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q27" type="radio" value="A"> A Some present studies on children's mother tongues are misleading.</label>
          <label style="margin:0;"><input name="q27" type="radio" value="B"> B A culturally rich education programme benefits some children more than others.</label>
          <label style="margin:0;"><input name="q27" type="radio" value="C"> C Bilingual children can make a valuable contribution to the wealth of a country.</label>
          <label style="margin:0;"><input name="q27" type="radio" value="D"> D The law on mother tongue use at school should be strengthened.</label>
        </div>
      </div>
      
      <a id="q28-anchor"></a>
      <div id="q28-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>28 Why does the writer refer to something that Goethe said?</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q28" type="radio" value="A"> A to lend weight to his argument</label>
          <label style="margin:0;"><input name="q28" type="radio" value="B"> B to contradict some research</label>
          <label style="margin:0;"><input name="q28" type="radio" value="C"> C to introduce a new concept</label>
          <label style="margin:0;"><input name="q28" type="radio" value="D"> D to update current thinking</label>
        </div>
      </div>
      
      <a id="q29-anchor"></a>
      <div id="q29-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>29 The writer believes that when young children have a firm grasp of their mother tongue</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q29" type="radio" value="A"> A They can teach older family members what they learnt at school.</label>
          <label style="margin:0;"><input name="q29" type="radio" value="B"> B They go on to do much better throughout their time at school.</label>
          <label style="margin:0;"><input name="q29" type="radio" value="C"> C They can read stories about their cultural background.</label>
          <label style="margin:0;"><input name="q29" type="radio" value="D"> D They develop stronger relationships with their family than with their peers.</label>
        </div>
      </div>
      
      <a id="q30-anchor"></a>
      <div id="q30-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>30 Why are some people suspicious about mother-tongue-based teaching programmes?</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q30" type="radio" value="A"> A They worry that children will be slow to learn to read in either language.</label>
          <label style="margin:0;"><input name="q30" type="radio" value="B"> B They think that children will confuse words in the two languages.</label>
          <label style="margin:0;"><input name="q30" type="radio" value="C"> C They believe that the programmes will make children less interested in their lessons.</label>
          <label style="margin:0;"><input name="q30" type="radio" value="D"> D They fear that the programmes will use up valuable time in the school day.</label>
        </div>
      </div>
    </div>
    
    <div class="group">
      <h4>Questions 31–35</h4>
      <p>Complete the summary using the list of words, A–J, below.</p>
      <p>Write the correct letter, A–J, in boxes 31–35 on your answer sheet.</p>
      
      <p><b>Bilingual Children</b></p>
      <p>It was often recorded that bilingual children acquire the <a id="q31-anchor"></a><div class="dropzone" data-target="q31"><span class="droplabel">Drag answer here</span></div> to converse in the majority language remarkably quickly. The fact that the mother tongue can disappear at a similar <a id="q32-anchor"></a><div class="dropzone" data-target="q32"><span class="droplabel">Drag answer here</span></div> is less well understood. This phenomenon depends, to a certain extent, on the proportion of people with the same linguistic background who have settled in a particular <a id="q33-anchor"></a><div class="dropzone" data-target="q33"><span class="droplabel">Drag answer here</span></div>. If this is limited, children are likely to lose the active use of their mother tongue, and thus no longer employ it even with <a id="q34-anchor"></a><div class="dropzone" data-target="q34"><span class="droplabel">Drag answer here</span></div>, although they may still understand it. It follows that teenage children in these circumstances experience a sense of <a id="q35-anchor"></a><div class="dropzone" data-target="q35"><span class="droplabel">Drag answer here</span></div> in relation to all aspects of their lives.</p>
      
      <div class="cardpool">
        <div class="card" draggable="true" data-value="A">A teachers</div>
        <div class="card" draggable="true" data-value="B">B school</div>
        <div class="card" draggable="true" data-value="C">C dislocation</div>
        <div class="card" draggable="true" data-value="D">D rate</div>
        <div class="card" draggable="true" data-value="E">E time</div>
        <div class="card" draggable="true" data-value="F">F family</div>
        <div class="card" draggable="true" data-value="G">G communication</div>
        <div class="card" draggable="true" data-value="H">H type</div>
        <div class="card" draggable="true" data-value="I">I ability</div>
        <div class="card" draggable="true" data-value="J">J area</div>
      </div>
    </div>
    
    <div class="group">
      <h4>Questions 36–40</h4>
      <p>Do the following statements agree with the information given in Reading Passage 3?</p>
      <p>In boxes 36–40 on your answer sheet, write</p>
      <ul>
        <li>YES if the statement agrees with the views of the writer</li>
        <li>NO if the statement contradicts the views of the writer</li>
        <li>NOT GIVEN if it is impossible to say what the writer thinks about this</li>
      </ul>
      
      <a id="q36-anchor"></a>
      <div id="q36-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>36 Less than half of the children who attend kindergarten in Toronto have English as their mother tongue.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q36" type="radio" value="YES"> YES</label>
          <label style="margin:0;"><input name="q36" type="radio" value="NO"> NO</label>
          <label style="margin:0;"><input name="q36" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <a id="q37-anchor"></a>
      <div id="q37-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>37 Research proves that learning the host country language at school can have an adverse effect on a child's mother tongue.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q37" type="radio" value="YES"> YES</label>
          <label style="margin:0;"><input name="q37" type="radio" value="NO"> NO</label>
          <label style="margin:0;"><input name="q37" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <a id="q38-anchor"></a>
      <div id="q38-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>38 The Foyer program is to be accepted by the French education system.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q38" type="radio" value="YES"> YES</label>
          <label style="margin:0;"><input name="q38" type="radio" value="NO"> NO</label>
          <label style="margin:0;"><input name="q38" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <a id="q39-anchor"></a>
      <div id="q39-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>39 Bilingual children are taught to tell the time earlier than monolingual children.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q39" type="radio" value="YES"> YES</label>
          <label style="margin:0;"><input name="q39" type="radio" value="NO"> NO</label>
          <label style="margin:0;"><input name="q39" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <a id="q40-anchor"></a>
      <div id="q40-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>40 Bilingual children can apply reading comprehension strategies acquired in one language when reading in the other.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q40" type="radio" value="YES"> YES</label>
          <label style="margin:0;"><input name="q40" type="radio" value="NO"> NO</label>
          <label style="margin:0;"><input name="q40" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
    </div>
    
    <div style="display:flex;gap:8px;margin-bottom:10px;">
      <button class="primary" onclick="grade()">Submit</button>
      <button onclick="resetForm()">Reset</button>
      <button onclick="toggleNotes()">Notes</button>
    </div>
    <div id="results"></div>
    <details class="answerbox" id="answerBox">
      <summary>Show answers (click to toggle) <span class="badge">hidden</span></summary>
      <div id="answerContent"></div>
    </details>
  </section>
</div>
<div aria-label="Selection tools" id="selbar" role="toolbar">
  <button id="btnHL">Highlight</button>
  <button id="btnUH">Remove</button>
  <button id="btnNote">Note</button>
</div>
<div id="notes">
  <header>
    <strong>Notes</strong>
    <div>
      <button id="btnCopy">Copy</button>
      <button id="btnClose">Close</button>
    </div>
  </header>
  <textarea id="noteArea" placeholder="Type your notes here..."></textarea>
</div>
<div id="toast"></div>
<script>
// Timer
let _t=0; const _timerEl=document.getElementById('timer');
setInterval(function(){ 
  _t++; 
  var m=String(Math.floor(_t/60)).padStart(2,'0'); 
  var s=String(_t%60).padStart(2,'0'); 
  _timerEl.textContent=m+':'+s; 
},1000);
// Drag divider
var divider = document.getElementById('divider');
var left = document.getElementById('left');
var right = document.getElementById('right');
var dragging=false;
function startDrag(e){ 
  dragging=true; 
  document.body.style.cursor='ew-resize'; 
  if(e.preventDefault) e.preventDefault(); 
}
function endDrag(){ 
  dragging=false; 
  document.body.style.cursor=''; 
}
function onMove(clientX){
  var container = document.querySelector('.shell').getBoundingClientRect();
  var x = clientX - container.left;
  x = Math.max(280, Math.min(container.width-320, x));
  left.style.flex = '0 0 ' + x + 'px';
  right.style.flex = '1 1 auto';
}
divider.addEventListener('mousedown', function(e){ startDrag(e); });
window.addEventListener('mousemove', function(e){ if(dragging) onMove(e.clientX); });
window.addEventListener('mouseup', endDrag);
divider.addEventListener('touchstart', function(e){ startDrag(e.touches[0]); }, {passive:false});
window.addEventListener('touchmove', function(e){ if(dragging) onMove(e.touches[0].clientX); }, {passive:false});
window.addEventListener('touchend', endDrag);
</script>
<script>
// Highlight toolbar
var selbar = document.getElementById('selbar');
var btnHL = document.getElementById('btnHL');
var btnUH = document.getElementById('btnUH');
var btnNote = document.getElementById('btnNote');
var lastRange=null;
var currentHlNode=null;
var keepToolbar=false;
function positionSelbarForRect(rect){
  selbar.style.display='flex';
  requestAnimationFrame(function(){
    var top = window.scrollY + rect.top - selbar.offsetHeight - 8;
    var leftPos = window.scrollX + rect.left + rect.width/2 - selbar.offsetWidth/2;
    selbar.style.top = ((top>0)?top:(window.scrollY + rect.bottom + 8)) + 'px';
    selbar.style.left = Math.max(8, leftPos) + 'px';
  });
}
function updateSelbar(){
  var sel=window.getSelection();
  if(!sel || sel.rangeCount===0 || sel.isCollapsed) { 
    selbar.style.display='none'; 
    currentHlNode=null; 
    return; 
  }
  var range = sel.getRangeAt(0);
  lastRange = range.cloneRange();
  currentHlNode=null;
  positionSelbarForRect(range.getBoundingClientRect());
}
document.getElementById('left').addEventListener('mouseup', updateSelbar);
document.getElementById('right').addEventListener('mouseup', updateSelbar);
document.addEventListener('selectionchange', function(){ 
  var sel=window.getSelection(); 
  if(!sel || sel.rangeCount===0 || sel.isCollapsed){ 
    if(!keepToolbar && !currentHlNode){ 
      selbar.style.display='none'; 
    } 
  } 
});
document.addEventListener('scroll', function(){ 
  if(selbar.style.display==='flex') updateSelbar(); 
});
document.addEventListener('mousedown', function(e){
  var t = e.target;
  if(t.classList && t.classList.contains('hl')){
    keepToolbar = true;
  } else {
    keepToolbar = false;
  }
}, true);
document.addEventListener('click', function(e){
  var target = e.target;
  if(target.classList && target.classList.contains('hl')){
    currentHlNode = target;
    lastRange = null;
    positionSelbarForRect(target.getBoundingClientRect());
    var sel=window.getSelection();
    if(sel) sel.removeAllRanges();
    setTimeout(function(){ keepToolbar=false; }, 0);
  }
}, true);
function doHighlight(){
  if(currentHlNode) return;
  if(!lastRange || lastRange.collapsed) return;
  var span=document.createElement('span'); span.className='hl';
  try { lastRange.surroundContents(span); }
  catch(e){
    var wrap=document.createElement('span'); wrap.className='hl';
    wrap.appendChild(lastRange.cloneContents());
    lastRange.deleteContents();
    lastRange.insertNode(wrap);
  }
  selbar.style.display='none';
  showToast('Highlighted');
}
function removeHighlight(){
  if(currentHlNode){
    var p = currentHlNode.parentNode;
    while(currentHlNode.firstChild) p.insertBefore(currentHlNode.firstChild, currentHlNode);
    p.removeChild(currentHlNode); p.normalize();
    currentHlNode = null;
    selbar.style.display='none';
    showToast('Highlight removed');
    return;
  }
  if(!lastRange) return;
  var selRect = lastRange.getBoundingClientRect();
  var walker=document.createTreeWalker(document.body, NodeFilter.SHOW_ELEMENT);
  var toRemove=[];
  while(walker.nextNode()){
    var n=walker.currentNode;
    if(n.classList && n.classList.contains('hl')) {
      var r = n.getBoundingClientRect();
      if(!(r.right < selRect.left || r.left > selRect.right || r.bottom < selRect.top || r.top > selRect.bottom)) toRemove.push(n);
    }
  }
  toRemove.forEach(function(el){ var p=el.parentNode; while(el.firstChild) p.insertBefore(el.firstChild, el); p.removeChild(el); p.normalize(); });
  selbar.style.display='none';
  showToast('Highlight removed');
}
btnHL.addEventListener('click', doHighlight);
btnUH.addEventListener('click', removeHighlight);
</script>
<script>
// Notes
var notes = document.getElementById('notes');
var noteArea = document.getElementById('noteArea');
var btnCopy=document.getElementById('btnCopy');
var btnClose=document.getElementById('btnClose');
function toggleNotes(){ 
  notes.style.display = (notes.style.display==='flex'?'none':'flex'); 
}
window.toggleNotes = toggleNotes;
btnClose.addEventListener('click', toggleNotes);
btnCopy.addEventListener('click', async function(){ 
  await navigator.clipboard.writeText(noteArea.value||''); 
  showToast('Copied'); 
});
btnNote.addEventListener('click', function(){
  var text = '';
  if(currentHlNode){ text = (currentHlNode.textContent||'').trim(); }
  else if(lastRange){ var frag = lastRange.cloneContents(); text = (frag.textContent||'').trim(); }
  toggleNotes();
  if(text) noteArea.value = (noteArea.value? noteArea.value+'\n':'') + '> ' + text + '\n';
  selbar.style.display='none';
});
// Toast
var toastEl=document.getElementById('toast');
function showToast(msg){
  toastEl.textContent=msg; 
  toastEl.style.display='block';
  setTimeout(function(){ toastEl.style.display='none'; }, 1200);
}
</script>
<script>
// Drag and drop for questions 31-35
const cards = document.querySelectorAll('.card');
const dropzones = document.querySelectorAll('.dropzone');
cards.forEach(card => {
  card.addEventListener('dragstart', () => {
    card.classList.add('dragging');
  });
  card.addEventListener('dragend', () => {
    card.classList.remove('dragging');
  });
});
dropzones.forEach(zone => {
  zone.addEventListener('dragover', e => {
    e.preventDefault();
    zone.classList.add('over');
  });
  
  zone.addEventListener('dragleave', () => {
    zone.classList.remove('over');
  });
  
  zone.addEventListener('drop', e => {
    e.preventDefault();
    zone.classList.remove('over');
    const draggingCard = document.querySelector('.dragging');
    if (draggingCard) {
      // Clear existing content
      zone.innerHTML = '';
      zone.appendChild(draggingCard);
      // Mark as answered
      const targetQ = zone.dataset.target;
      document.getElementById(targetQ + '-nav').classList.add('answered');
    }
  });
});
</script>
<script>
// Answer key and grading
var answers = {
  "q27":"C", "q28":"A", "q29":"B", "q30":"D",
  "q31":"I", "q32":"D", "q33":"J", "q34":"F", "q35":"C",
  "q36":"YES", "q37":"NO", "q38":"NOT GIVEN", "q39":"NOT GIVEN", "q40":"YES"
};
function grade(){
  var total=0, correct=0, lines=[];
  
  // Check multiple choice questions (27-30)
  for(let n=27; n<=30; n++){
    const q = `q${n}`;
    total++;
    const selected = document.querySelector(`input[name="${q}"]:checked`);
    const userAnswer = selected ? selected.value : '';
    const isCorrect = userAnswer === answers[q];
    if (isCorrect) correct++;
    lines.push(`${q.toUpperCase()}: ${userAnswer || 'None'} ${isCorrect ? '✅' : '❌'}`);
  }
  
  // Check drag-and-drop questions (31-35)
  dropzones.forEach(zone => {
    const q = zone.dataset.target;
    total++;
    const selectedCard = zone.querySelector('.card');
    const userAnswer = selectedCard ? selectedCard.dataset.value : '';
    const isCorrect = userAnswer === answers[q];
    if (isCorrect) correct++;
    lines.push(`${q.toUpperCase()}: ${userAnswer || 'None'} ${isCorrect ? '✅' : '❌'}`);
  });
  
  // Check YES/NO/NG questions (36-40)
  for(let n=36; n<=40; n++){
    const q = `q${n}`;
    total++;
    const selected = document.querySelector(`input[name="${q}"]:checked`);
    const userAnswer = selected ? selected.value : '';
    const isCorrect = userAnswer === answers[q];
    if (isCorrect) correct++;
    lines.push(`${q.toUpperCase()}: ${userAnswer || 'None'} ${isCorrect ? '✅' : '❌'}`);
  }
  
  // Show results
  const acc = Math.round(100 * correct / total);
  document.getElementById('results').innerHTML = `
    <p><strong>Score:</strong> ${correct}/${total} <span class="badge">Accuracy ${acc}%</span></p>
    <pre>${lines.join('\n')}</pre>
  `;
  
  // Show answer key
  document.getElementById('answerContent').innerHTML = `
    <ol start="27">
      <li>C</li>
      <li>A</li>
      <li>B</li>
      <li>D</li>
      <li>I (ability)</li>
      <li>D (rate)</li>
      <li>J (area)</li>
      <li>F (family)</li>
      <li>C (dislocation)</li>
      <li>YES</li>
      <li>NO</li>
      <li>NOT GIVEN</li>
      <li>NOT GIVEN</li>
      <li>YES</li>
    </ol>
  `;
  document.querySelector('#answerBox .badge').textContent = 'tap to view';
}
function resetForm(){
  // Reset drag-and-drop
  dropzones.forEach(zone => {
    const card = zone.querySelector('.card');
    if (card) {
      document.querySelector('.cardpool').appendChild(card);
      zone.innerHTML = '<span class="droplabel">Drag answer here</span>';
    }
  });
  
  // Reset radio buttons
  document.querySelectorAll('input[type="radio"]').forEach(radio => {
    radio.checked = false;
  });
  
  // Reset results and answers
  document.getElementById('results').innerHTML = '';
  document.getElementById('answerContent').innerHTML = '';
  document.querySelector('#answerBox .badge').textContent = 'hidden';
  
  // Reset answered status in nav
  document.querySelectorAll('.q-item').forEach(item => {
    item.classList.remove('answered');
  });
}
// Scroll to question anchor
function scrollToElement(id){
  const el = document.getElementById(id);
  if(el){ 
    el.scrollIntoView({behavior:'smooth', block:'center'}); 
  }
  // Highlight nav item briefly
  const navs = document.querySelectorAll('.practice-nav .q-item');
  navs.forEach(n => n.classList.remove('active'));
  const btn = document.getElementById(id.replace('-anchor','-nav'));
  if(btn){ 
    btn.classList.add('active'); 
    setTimeout(() => btn.classList.remove('active'), 800); 
  }
}
// Mark answered on interaction
(function(){
  function markAnswered(qn){
    const nav = document.getElementById(`q${qn}-nav`);
    if(!nav) return;
    let answered = false;
    
    // Check dropzones (31-35)
    if(qn >=31 && qn <=35){
      const zone = document.querySelector(`.dropzone[data-target="q${qn}"]`);
      answered = zone.querySelector('.card') !== null;
    } 
    // Check radio buttons (27-30, 36-40)
    else {
      const radios = document.querySelectorAll(`input[name="q${qn}"]:checked`);
      answered = radios.length > 0;
    }
    
    if(answered) nav.classList.add('answered');
    else nav.classList.remove('answered');
  }
  
  // Monitor dropzones
  dropzones.forEach(zone => {
    zone.addEventListener('drop', () => {
      const qn = zone.dataset.target.replace('q', '');
      markAnswered(qn);
    });
  });
  
  // Monitor radio buttons
  for(let n=27; n<=30; n++){
    document.querySelectorAll(`input[name="q${n}"]`).forEach(radio => {
      radio.addEventListener('change', () => markAnswered(n));
    });
  }
  
  for(let n=36; n<=40; n++){
    document.querySelectorAll(`input[name="q${n}"]`).forEach(radio => {
      radio.addEventListener('change', () => markAnswered(n));
    });
  }
})();
</script>

<!-- 练习页面数据传输增强脚本 -->
<script>
// 检查是否已经有增强脚本
if (!window.practicePageEnhancer) {
    // 动态加载增强脚本
    const script = document.createElement('script');
    script.src = '../../js/practice-page-enhancer.js';
    script.onload = function() {
        console.log('练习页面增强脚本已加载');
    };
    script.onerror = function() {
        console.error('练习页面增强脚本加载失败');
        // 降级到内联增强
        loadInlineEnhancer();
    };
    document.head.appendChild(script);
}

// 内联增强器（降级方案）
function loadInlineEnhancer() {
    if (window.practicePageEnhancer) return;
    
    window.practicePageEnhancer = {
        initialize: function() {
            console.log('[InlineEnhancer] 内联增强器已初始化');
            this.setupCommunication();
            this.setupAnswerListeners();
            this.interceptSubmit();
        },
        
        setupCommunication: function() {
            this.parentWindow = window.opener || window.parent;
            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'INIT_SESSION') {
                    this.sessionId = event.data.data.sessionId;
                    this.sendMessage('SESSION_READY', {
                        pageType: this.detectPageType(),
                        url: window.location.href
                    });
                }
            });
        },
        
        detectPageType: function() {
            const title = document.title || '';
            if (title.includes('P1')) return 'P1';
            if (title.includes('P2')) return 'P2';
            if (title.includes('P3')) return 'P3';
            return 'unknown';
        },
        
        setupAnswerListeners: function() {
            this.answers = {};
            this.startTime = Date.now();
            
            document.addEventListener('change', (e) => {
                if (e.target.name && e.target.name.startsWith('q')) {
                    this.answers[e.target.name] = e.target.value;
                }
            });

            // For drag-drop, we can't rely on change event. 
            // It will be captured by the grade function interception.
        },
        
        interceptSubmit: function() {
            // 拦截grade函数
            if (typeof window.grade === 'function') {
                const originalGrade = window.grade;
                window.grade = () => {
                    // Capture drag-drop answers just before submitting
                    document.querySelectorAll('.dropzone').forEach(zone => {
                        const q = zone.dataset.target;
                        const selectedCard = zone.querySelector('.card');
                        this.answers[q] = selectedCard ? selectedCard.dataset.value : '';
                    });
                    const result = originalGrade();
                    setTimeout(() => this.handleSubmit(), 200);
                    return result;
                };
            }
            
            // 监听提交按钮
            document.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' && 
                    (e.target.textContent.includes('Submit') || 
                     e.target.onclick && e.target.onclick.toString().includes('grade'))) {
                    setTimeout(() => this.handleSubmit(), 300);
                }
            });
        },
        
        handleSubmit: function() {
            const results = {
                sessionId: this.sessionId,
                startTime: this.startTime,
                endTime: Date.now(),
                duration: Math.round((Date.now() - this.startTime) / 1000),
                answers: this.answers,
                scoreInfo: this.extractScore(),
                pageType: this.detectPageType(),
                url: window.location.href
            };
            
            this.sendMessage('PRACTICE_COMPLETE', results);
        },
        
        extractScore: function() {
            const resultsEl = document.getElementById('results');
            if (!resultsEl) return null;
            
            const text = resultsEl.textContent || '';
            const scoreMatch = text.match(/Score:\s*(\d+)\/(\d+)/i);
            if (scoreMatch) {
                const correct = parseInt(scoreMatch[1]);
                const total = parseInt(scoreMatch[2]);
                return {
                    correct: correct,
                    total: total,
                    accuracy: total > 0 ? correct / total : 0,
                    percentage: Math.round((correct / total) * 100),
                    source: 'inline_extraction'
                };
            }
            return null;
        },
        
        sendMessage: function(type, data) {
            if (this.parentWindow) {
                this.parentWindow.postMessage({
                    type: type,
                    data: data,
                    source: 'practice_page'
                }, '*');
            }
        }
    };
    
    // 初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            window.practicePageEnhancer.initialize();
        });
    } else {
        window.practicePageEnhancer.initialize();
    }
}
</script>

</body>
</html>