<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P3 – The Voynich Manuscript</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root { --line:#e5e7eb; --bg:#f6f7fb; --panel:#fff; --accent:#3b82f6; --muted:#6b7280; --shadow:0 6px 20px rgba(0,0,0,.12); }
  body.dark {
    --line: #374151;
    --bg: #111827;
    --panel: #1f2937;
    --accent: #60a5fa;
    --muted: #9ca3af;
    --shadow: 0 6px 20px rgba(0,0,0,.3);
  }
  
  body {
    transition: background-color 0.3s ease, color 0.3s ease;
  }
  
  body.dark h1, body.dark h2, body.dark h3, body.dark h4, body.dark h5, body.dark h6,
  body.dark p, body.dark td, body.dark th, body.dark label, body.dark li {
    color: #f9fafb;
  }
  
  body.dark .practice-nav {
    background: var(--panel);
    border-color: var(--line);
  }
  
  body.dark .practice-nav .q-item {
    background: var(--panel);
    color: #f9fafb;
    border-color: var(--line);
  }
  
  body.dark .practice-nav .q-item:hover {
    background: #374151;
    border-color: var(--accent);
  }
  
  body.dark .practice-nav .q-item.answered {
    background: #1e40af;
    color: #93c5fd;
  }
  
  body.dark .group {
    background: var(--panel);
    border-color: var(--line);
  }
  
  body.dark button {
    background: var(--panel);
    color: #f9fafb;
    border-color: var(--line);
  }
  
  body.dark button:hover {
    background: #374151;
    border-color: var(--accent);
  }
  
  body.dark button.primary {
    background: var(--accent);
    color: white;
  }
  
  body.dark #results {
    background: var(--panel);
    color: #f9fafb;
    border-color: var(--line);
  }
  
  body.dark details.answerbox {
    background: var(--panel);
    border-color: var(--line);
    color: #f9fafb;
  }
  
  body.dark .hl {
    background: #fbbf24;
    color: #1f2937;
  }
  
  body.dark .dropzone {
    background: #374151;
    border-color: var(--line);
  }
  
  body.dark .card {
    background: var(--panel);
    border-color: var(--line);
    color: #f9fafb;
  }
  
  body.dark .cardpool {
    background: #374151;
  }
  
  body.dark #notes {
    background: var(--panel);
    border-color: var(--line);
  }
  
  body.dark #notes header {
    color: #f9fafb;
    border-color: var(--line);
  }
  
  body.dark #notes textarea {
    background: var(--panel);
    color: #f9fafb;
  }
  
  /* Timer enhancements */
  #timer {
    cursor: pointer !important;
    transition: all 0.2s ease;
    user-select: none;
  }
  
  #timer:hover {
    background: #f8fafc;
    border-color: var(--accent);
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
  }
  
  body.dark #timer {
    background: #1e293b;
    color: #e2e8f0;
    border-color: #334155;
  }
  
  body.dark #timer:hover {
    background: #334155;
    border-color: var(--accent);
  }
  
  #timer.paused {
    background: #fef3c7 !important;
    color: #92400e !important;
    border-color: #f59e0b !important;
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }
  
  /* Controls layout */
  .practice-nav .controls {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  /* Theme toggle button */
  .theme-toggle {
    border: none;
    cursor: pointer;
    background: transparent;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    transition: all 0.2s ease;
  }
  
  .theme-toggle:hover {
    background: var(--accent);
    color: #fff;
    transform: scale(1.05);
  }
  
  .theme-toggle:active {
    transform: scale(0.95);
  }

  * { box-sizing: border-box; }
  html,body { height:100%; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); padding-bottom: 82px; }
  #timer { position: static; display: inline-block; margin-left: 8px; background:#fff; border:1px solid var(--line); border-radius:10px; padding:2px 8px; font-size:14px; vertical-align: middle; }
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:var(--panel); overflow:auto; padding:20px; }
  #left { flex: 0 0 50%; min-width: 280px; }
  #right { flex: 1 1 auto; min-width: 320px; background:#fbfbff; border-left:1px solid var(--line); }
  #divider { flex: 0 0 8px; background: linear-gradient(90deg,#e5e7eb,#d1d5db); cursor: ew-resize; position:relative; z-index: 5; user-select:none; }
  h2,h3,h4 { margin:0 0 10px; }
  #left p { margin: 0 0 12px; line-height: 1.6; word-break: normal; overflow-wrap: normal; hyphens: none; }
  .group { background:#fff; border:1px solid var(--line); border-radius:10px; padding:12px; margin-bottom:14px; }
  input.blank { border:none; border-bottom:1px solid #9ca3af; padding:2px 4px; font-size:1em; background:transparent; }
  input.blank:focus { outline:none; border-bottom:2px solid var(--accent); }
  button { padding:8px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; cursor:pointer; }
  button.primary { background:var(--accent); color:#fff; border-color:#3b82f6; }
  #results { background:#fff; border:1px solid var(--line); border-radius:10px; padding:10px; }
  .hl { background:#fff3a3; box-shadow: inset 0 -2px 0 rgba(0,0,0,.05); cursor: pointer; }
  .hl:hover { filter: brightness(0.98); }
  #selbar { position: absolute; display:none; z-index: 2000; background:#111; color:#fff; border-radius: 8px; padding: 6px; box-shadow: var(--shadow); font-size: 13px; gap:6px; align-items: center; }
  #selbar button { background: transparent; color:#fff; border: 1px solid rgba(255,255,255,.25); padding: 4px 8px; border-radius: 6px; cursor:pointer; }
  #selbar button:hover { border-color:#fff; }
  #notes { position: fixed; right: 12px; bottom: 12px; width: 320px; height: 42vh; background:#fff; border:1px solid var(--line); border-radius: 12px; display:none; flex-direction: column; z-index:1500; box-shadow: var(--shadow); }
  #notes header { display:flex; align-items:center; justify-content: space-between; padding:8px 10px; border-bottom:1px solid var(--line); }
  #notes textarea { flex:1; border:0; padding:10px; resize:none; font-size:14px; line-height:1.5; }
  #toast { position: fixed; left:50%; transform: translateX(-50%); bottom: 24px; background:#111; color:#fff; padding:8px 12px; border-radius: 8px; display:none; z-index:2500; }
  details.answerbox summary { cursor: pointer; user-select:none; list-style: none; }
  details.answerbox { border:1px dashed var(--line); border-radius:10px; padding:8px 10px; background:#fff; }
  .badge { display:inline-block; background:#eef2ff; color:#4338ca; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:6px; }
  .practice-nav { background:#fff; border-bottom:2px solid var(--line); padding:12px 20px; display:flex; align-items:center; gap:20px; box-shadow:0 2px 4px rgba(0,0,0,.05); flex-wrap:wrap; position:fixed; left:0; right:0; bottom:0; border-top:2px solid var(--line); border-bottom:0; z-index:4000; }
  .practice-nav .title { font-weight:600; color:var(--muted); }
  .practice-nav .questions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .practice-nav .q-item { padding:6px 10px; border:1px solid var(--line); border-radius:6px; background:#fff; cursor:pointer; font-size:14px; transition:all 0.2s; min-width:36px; text-align:center; }
  .practice-nav .q-item:hover { background:#f1f5f9; border-color:var(--accent); }
  .practice-nav .q-item.answered { background:#e0e7ff; border-color:var(--accent); color:var(--accent); font-weight:500; }
  .practice-nav .q-item.active { background:var(--accent); color:#fff; border-color:var(--accent); }
  #selbar { z-index: 6000 !important; }
  .people-list { border: 1px solid #ccc; padding: 12px; margin-top: 1em; border-radius: 8px; background: #f9fafb;}
  .people-list ul { list-style-type: none; padding: 0; }
  .people-list li { margin: 4px 0; }
</style>
</head>
<body>

<div class="practice-nav">
  <div class="title">Questions</div>
  <div class="questions">
    <div class="q-item" id="q27-nav" onclick="scrollToElement('q27-anchor')">27</div>
    <div class="q-item" id="q28-nav" onclick="scrollToElement('q28-anchor')">28</div>
    <div class="q-item" id="q29-nav" onclick="scrollToElement('q29-anchor')">29</div>
    <div class="q-item" id="q30-nav" onclick="scrollToElement('q30-anchor')">30</div>
    <div class="q-item" id="q31-nav" onclick="scrollToElement('q31-anchor')">31</div>
    <div class="q-item" id="q32-nav" onclick="scrollToElement('q32-anchor')">32</div>
    <div class="q-item" id="q33-nav" onclick="scrollToElement('q33-anchor')">33</div>
    <div class="q-item" id="q34-nav" onclick="scrollToElement('q34-anchor')">34</div>
    <div class="q-item" id="q35-nav" onclick="scrollToElement('q35-anchor')">35</div>
    <div class="q-item" id="q36-nav" onclick="scrollToElement('q36-anchor')">36</div>
    <div class="q-item" id="q37-nav" onclick="scrollToElement('q37-anchor')">37</div>
    <div class="q-item" id="q38-nav" onclick="scrollToElement('q38-anchor')">38</div>
    <div class="q-item" id="q39-nav" onclick="scrollToElement('q39-anchor')">39</div>
    <div class="q-item" id="q40-nav" onclick="scrollToElement('q40-anchor')">40</div>
  </div>
  <div class="controls">
    <span id="timer" onclick="toggleTimer()">00:00</span>
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">🌙</button>
  </div>
</div>

<div class="shell">
  <section class="pane" id="left">
    <h2>READING PASSAGE 3 <span id="timer">00:00</span></h2>
    <p>You should spend about 20 minutes on Questions 27-40, which are based on Reading Passage 3 below.</p>
    
    <h3>The Voynich Manuscript</h3>
    
    <p>The starkly modern Beinecke Library at Yale University is home to some of the most valuable books in the world: first folios of Shakespeare, Gutenberg Bibles and manuscripts from the early Middle Ages. Yet the library's most controversial possession is an unprepossessing vellum manuscript about the size of a hardback book, containing 240-odd pages of drawings and text of unknown age and authorship. Catalogued as MS 408, the manuscript would attract little attention were it not for the fact that the drawings hint at esoteric knowledge, while the text seems to be some sort of code — one that no-one has been able to break. It is known to scholars as the Voynich manuscript, after the American book-dealer Wilfrid Voynich, who bought the manuscript from a Jesuit college in Italy in 1912.</p>
    
    <p>Over the years, the manuscript has attracted the attention of everyone from amateur dabblers to top code-breakers, all determined to succeed where countless others have failed. Academic research papers, books and websites are devoted to making sense of the contents of the manuscript, which are freely available to all. “Most other mysteries involve second-hand reports,” says Dr Gordon Rugg of Keele University, a leading Voynich expert. “But this is one that you can see for yourself."</p>
    
    <p>It is certainly strange: page after page of drawings of weird plants, astrological symbolism and human figures, accompanied by a script that looks like some form of shorthand. What does it say and what are the drawings about? Voynich himself believed that the manuscript was the work of the 13th-century English monk Roger Bacon, famed for his knowledge of alchemy, philosophy and science. In 1921 Voynich's view that Bacon was the writer appeared to win support from the work of William Newbold, Professor of Philosophy at the University of Pennsylvania, who claimed to have found the key to the cipher system used by Bacon. According to Newbold, the manuscript proved that Bacon had access to a microscope centuries before they were supposedly first invented. The claim that this medieval monk had observed living cells created a sensation. It soon became clear, however, that Newbold had fallen victim to wishful thinking. Other scholars showed that his "decoding” methods produced a host of possible interpretations.</p>
    
    <p>The Voynich manuscript has continued to defy the efforts of world-class experts. In 1944, a team was assembled to tackle the mystery, led by William Friedman, the renowned American code-breaker. They began with the most basic code-breaking task: analysing the relative frequencies of the characters making up the text, looking for signs of an underlying structure. Yet Friedman's team soon found themselves in deep water. The precise size of the “alphabet” of the Voynich manuscript was unclear: it is possible to make out more than 70 distinct symbols among the 170,000-character text. Furthermore, Friedman discovered that some words and phrases appeared more often than expected in a standard language, casting doubt on claims that the manuscript concealed a real language, as encryption typically reduces word frequencies.</p>
    
    <p>Friedman concluded that the most plausible resolution of this paradox was that “Voynichese” is some sort of specially created artificial language, whose words are devised from concepts rather than linguistics. So could the Voynich manuscript be the earliest-known example of an artificial language? "Friedman's hypothesis commands respect because of the lifetime of cryptanalytic expertise he brought to bear,” says Rob Churchill, co-author of The Voynich Manuscript. That still leaves a host of questions unanswered, however, such as the identity of the author and the meaning of the bizarre drawings. “It does little to advance our understanding of the manuscript as a whole,” says Churchill.</p>
    
    <p>Even though Friedman was working more than 60 years ago, he suspected that major insights would come from using the device that had already transformed code-breaking: the computer. In this he was right — it is now the key tool for uncovering clues about the manuscript's language.</p>
    
    <p>The insights so far have been perplexing. For example, in 2001 another leading Voynich scholar, Dr Gabriel Landini of Birmingham University in the UK, published the results of his study of the manuscript using a pattern-detecting method called spectral analysis. This revealed evidence that the manuscript contains genuine words, rather than random nonsense, consistent with the existence of some underlying natural language. Yet the following year, Voynich expert René Zandbergen of the European Space Agency in Darmstadt, Germany, showed that the entropy of the text (a measure of the rate of transfer of information) was consistent with Friedman's suspicions that an artificial language had been used.</p>
    
    <p>Many are convinced that the Voynich manuscript is not a hoax. For how could a medieval hoaxer create so many tell-tale signs of a message from random nonsense? Yet even this has been challenged in new research by Rugg. Using a system first published by the Italian mathematician Girolamo Cardano in 1150, in which a specially constructed grille is used to pick out symbols from a table, Rugg found he could rapidly generate text with many of the basic traits of the Voynich manuscript. Publishing his results in 2004, Rugg stresses that he had not set out to prove the manuscript a hoax. “I simply demonstrated that it is feasible to hoax something this complex in a few months," he says.</p>
    
    <p>Inevitably, others beg to differ. Some scholars, such as Zandbergen, still suspect the text has genuine meaning, though believe it may never be decipherable. Others, such as Churchill, have suggested that the sheer weirdness of the illustrations and text hints at an author who had lost touch with reality.</p>
    
    <p>What is clear is that the book-sized manuscript, kept under lock and key at Yale University, has lost none of its fascination. “Many derive great intellectual pleasure from solving puzzles,” says Rugg. "The Voynich manuscript is as challenging a puzzle as anyone could ask for.”</p>

    <p>&nbsp;</p>
  </section>
  <div id="divider" title="Drag to resize"></div>
  <section class="pane" id="right">
    <h3>Questions</h3>
    
    <div class="group">
      <h4>Questions 27–30</h4>
      <p>Do the following statements agree with the information given in Reading Passage 3?</p>
      <p>In boxes 27–30 on your answer sheet, write</p>
      <ul>
        <li><strong>TRUE</strong> if the statement agrees with the information</li>
        <li><strong>FALSE</strong> if the statement contradicts the information</li>
        <li><strong>NOT GIVEN</strong> if there is no information on this</li>
      </ul>
      
      <a id="q27-anchor"></a>
      <div id="q27-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>27 It is uncertain when the Voynich manuscript was written.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label><input name="q27" type="radio" value="TRUE"> TRUE</label> <label><input name="q27" type="radio" value="FALSE"> FALSE</label> <label><input name="q27" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <a id="q28-anchor"></a>
      <div id="q28-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>28 Wilfrid Voynich donated the manuscript to the Beinecke Library.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label><input name="q28" type="radio" value="TRUE"> TRUE</label> <label><input name="q28" type="radio" value="FALSE"> FALSE</label> <label><input name="q28" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <a id="q29-anchor"></a>
      <div id="q29-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>29 Interest in the Voynich manuscript extends beyond that of academics and professional code-breakers.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label><input name="q29" type="radio" value="TRUE"> TRUE</label> <label><input name="q29" type="radio" value="FALSE"> FALSE</label> <label><input name="q29" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>

      <a id="q30-anchor"></a>
      <div id="q30-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>30 The text of the Voynich manuscript contains just under 70 symbols.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label><input name="q30" type="radio" value="TRUE"> TRUE</label> <label><input name="q30" type="radio" value="FALSE"> FALSE</label> <label><input name="q30" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
    </div>
    
    <div class="group">
        <h4>Questions 31–34</h4>
        <p>Look at the following statements (Questions 31-34) and the list of people below.</p>
        <p>Match each statement with the correct person, A–H.</p>

        <a id="q31-anchor"></a><p>31 The number of times that some words occur makes it unlikely that the manuscript is based on an authentic language. <input name="q31" type="text" class="blank" maxlength="1" style="width: 30px; text-align: center;"></p>
        <a id="q32-anchor"></a><p>32 Unlike some other similar objects of fascination, people can gain direct access to the Voynich manuscript. <input name="q32" type="text" class="blank" maxlength="1" style="width: 30px; text-align: center;"></p>
        <a id="q33-anchor"></a><p>33 The person who wrote the manuscript may not have been entirely sane. <input name="q33" type="text" class="blank" maxlength="1" style="width: 30px; text-align: center;"></p>
        <a id="q34-anchor"></a><p>34 It is likely that the author of the manuscript is the same person as suggested by Wilfrid Voynich. <input name="q34" type="text" class="blank" maxlength="1" style="width: 30px; text-align: center;"></p>
        
        <div class="people-list">
            <h5>List of People</h5>
            <ul>
                <li><strong>A</strong> &nbsp; Gordon Rugg</li>
                <li><strong>B</strong> &nbsp; Roger Bacon</li>
                <li><strong>C</strong> &nbsp; William Newbold</li>
                <li><strong>D</strong> &nbsp; William Friedman</li>
                <li><strong>E</strong> &nbsp; Rob Churchill</li>
                <li><strong>F</strong> &nbsp; Gabriel Landini</li>
                <li><strong>G</strong> &nbsp; René Zandbergen</li>
                <li><strong>H</strong> &nbsp; Girolamo Cardano</li>
            </ul>
        </div>
    </div>

    <div class="group">
        <h4>Questions 35–39</h4>
        <p>Complete the summary below.</p>
        <p>Choose <strong>NO MORE THAN TWO WORDS</strong> from the passage for each answer.</p>
        
        <div style="padding: 10px; border: 1px solid #ccc; border-radius: 8px; margin-top: 1em;">
            <h5 style="text-align: center; margin-top: 0;">Voynich Researchers</h5>
            <p>William Newbold believed that the author of the Voynich manuscript had been able to look at cells through a 35 <a id="q35-anchor"></a><input name="q35" type="text" class="blank" maxlength="20">. Other researchers later demonstrated that there were flaws in his argument.</p>
            <p>William Friedman concluded that the manuscript was written in an artificial language that was based on 36 <a id="q36-anchor"></a><input name="q36" type="text" class="blank" maxlength="20">. He couldn't find out the meaning of this language but he believed that the 37 <a id="q37-anchor"></a><input name="q37" type="text" class="blank" maxlength="20"> would continue to bring advances in code-breaking.</p>
            <p>Dr Gabriel Landini used a system known as 38 <a id="q38-anchor"></a><input name="q38" type="text" class="blank" maxlength="20"> in his research, and claims to have demonstrated the presence of genuine words.</p>
            <p>Dr Gordon Rugg's system involved a grille, that made it possible to quickly select symbols that appeared in a 39 <a id="q39-anchor"></a><input name="q39" type="text" class="blank" maxlength="20">. Rugg's conclusion was that the manuscript lacked genuine meaning.</p>
        </div>
    </div>

    <div class="group">
        <h4>Question 40</h4>
        <p>Choose the correct letter, A, B, C or D.</p>
        <a id="q40-anchor"></a>
        <div id="q40-section" style="padding:8px 0;">
          <p>The writer's main aim in this passage is to</p>
          <div>
            <label style="display:block; margin:4px 0;"><input name="q40" type="radio" value="A"> A explain the meaning of the manuscript.</label>
            <label style="display:block; margin:4px 0;"><input name="q40" type="radio" value="B"> B determine the true identity of the manuscript's author.</label>
            <label style="display:block; margin:4px 0;"><input name="q40" type="radio" value="C"> C describe the numerous attempts to decode the manuscript.</label>
            <label style="display:block; margin:4px 0;"><input name="q40" type="radio" value="D"> D identify which research into the manuscript has had the most media coverage.</label>
          </div>
        </div>
    </div>


    <div style="display:flex;gap:8px;margin-bottom:10px;">
      <button class="primary" onclick="grade()">Submit</button>
      <button onclick="resetForm()">Reset</button>
      <button onclick="toggleNotes()">Notes</button>
    </div>
    <div id="results"></div>
    <details class="answerbox" id="answerBox">
      <summary>Show answers (click to toggle) <span class="badge">hidden</span></summary>
      <div id="answerContent"></div>
    </details>
  </section>
</div>

<div aria-label="Selection tools" id="selbar" role="toolbar">
  <button id="btnHL">Highlight</button>
  <button id="btnUH">Remove</button>
  <button id="btnNote">Note</button>
</div>
<div id="notes">
  <header>
    <strong>Notes</strong>
    <div>
      <button id="btnCopy">Copy</button>
      <button id="btnClose">Close</button>
    </div>
  </header>
  <textarea id="noteArea" placeholder="Type your notes here..."></textarea>
</div>
<div id="toast"></div>

<script>

// Enhanced Timer
let timerSeconds = 0;
let timerInterval = null;
let timerPaused = false;

function startTimer() {
  if (timerInterval) return;
  timerInterval = setInterval(() => {
    if (!timerPaused) {
      timerSeconds++;
      updateTimerDisplay();
    }
  }, 1000);
}

function updateTimerDisplay() {
  const minutes = Math.floor(timerSeconds / 60);
  const seconds = timerSeconds % 60;
  const timerEl = document.getElementById('timer');
  if (timerEl) {
    timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  }
}

function toggleTimer() {
  timerPaused = !timerPaused;
  const timerEl = document.getElementById('timer');
  if (timerEl) {
    timerEl.classList.toggle('paused', timerPaused);
  }
  
  if (!timerInterval) {
    startTimer();
  }
  
  showToast(timerPaused ? 'Timer paused' : 'Timer resumed');
}

// Theme functionality
function toggleTheme() {
  const body = document.body;
  const themeButton = document.querySelector('.theme-toggle');
  
  body.classList.toggle('dark');
  const isDark = body.classList.contains('dark');
  
  if (themeButton) {
    themeButton.textContent = isDark ? '☀️' : '🌙';
  }
  localStorage.setItem('theme', isDark ? 'dark' : 'light');
  
  showToast(`Switched to ${isDark ? 'dark' : 'light'} theme`);
}

function loadTheme() {
  const savedTheme = localStorage.getItem('theme');
  const body = document.body;
  const themeButton = document.querySelector('.theme-toggle');
  
  if (savedTheme === 'dark') {
    body.classList.add('dark');
    if (themeButton) themeButton.textContent = '☀️';
  } else {
    if (themeButton) themeButton.textContent = '🌙';
  }
}

// Toast notifications
function showToast(message) {
  let toast = document.getElementById('toast');
  if (!toast) {
    toast = document.createElement('div');
    toast.id = 'toast';
    toast.style.cssText = `
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 100px;
      background: #111;
      color: #fff;
      padding: 12px 20px;
      border-radius: 8px;
      display: none;
      z-index: 2500;
      font-weight: 500;
    `;
    document.body.appendChild(toast);
  }
  
  toast.textContent = message;
  toast.style.display = 'block';
  
  setTimeout(() => {
    toast.style.display = 'none';
  }, 2000);
}

// Initialize modern features
function initModernFeatures() {
  loadTheme();
  startTimer();
  
  // Make timer clickable
  const timer = document.getElementById('timer');
  if (timer && !timer.onclick) {
    timer.onclick = toggleTimer;
  }
  
  showToast('Modern features loaded');
}

// Auto-initialize when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initModernFeatures);
} else {
  initModernFeatures();
}

// Drag divider
var divider = document.getElementById('divider');
var left = document.getElementById('left');
var right = document.getElementById('right');
var dragging=false;
function startDrag(e){ 
  dragging=true; 
  document.body.style.cursor='ew-resize'; 
  if(e.preventDefault) e.preventDefault(); 
}
function endDrag(){ 
  dragging=false; 
  document.body.style.cursor=''; 
}
function onMove(clientX){
  var container = document.querySelector('.shell').getBoundingClientRect();
  var x = clientX - container.left;
  x = Math.max(280, Math.min(container.width-320, x));
  left.style.flex = '0 0 ' + x + 'px';
  right.style.flex = '1 1 auto';
}
divider.addEventListener('mousedown', function(e){ startDrag(e); });
window.addEventListener('mousemove', function(e){ if(dragging) onMove(e.clientX); });
window.addEventListener('mouseup', endDrag);
divider.addEventListener('touchstart', function(e){ startDrag(e.touches[0]); }, {passive:false});
window.addEventListener('touchmove', function(e){ if(dragging) onMove(e.touches[0].clientX); }, {passive:false});
window.addEventListener('touchend', endDrag);
// Highlight toolbar
var selbar = document.getElementById('selbar');
var btnHL = document.getElementById('btnHL');
var btnUH = document.getElementById('btnUH');
var btnNote = document.getElementById('btnNote');
var lastRange=null;
var currentHlNode=null;
var keepToolbar=false;
function positionSelbarForRect(rect){
  selbar.style.display='flex';
  requestAnimationFrame(function(){
    var top = window.scrollY + rect.top - selbar.offsetHeight - 8;
    var leftPos = window.scrollX + rect.left + rect.width/2 - selbar.offsetWidth/2;
    selbar.style.top = ((top>0)?top:(window.scrollY + rect.bottom + 8)) + 'px';
    selbar.style.left = Math.max(8, leftPos) + 'px';
  });
}
function updateSelbar(){
  var sel=window.getSelection();
  if(!sel || sel.rangeCount===0 || sel.isCollapsed) { 
    selbar.style.display='none'; 
    currentHlNode=null; 
    return; 
  }
  var range = sel.getRangeAt(0);
  lastRange = range.cloneRange();
  currentHlNode=null;
  positionSelbarForRect(range.getBoundingClientRect());
}
document.getElementById('left').addEventListener('mouseup', updateSelbar);
document.getElementById('right').addEventListener('mouseup', updateSelbar);
document.addEventListener('selectionchange', function(){ 
  var sel=window.getSelection(); 
  if(!sel || sel.rangeCount===0 || sel.isCollapsed){ 
    if(!keepToolbar && !currentHlNode){ 
      selbar.style.display='none'; 
    } 
  } 
});
document.addEventListener('scroll', function(){ 
  if(selbar.style.display==='flex') updateSelbar(); 
});
document.addEventListener('mousedown', function(e){
  var t = e.target;
  if(t.classList && t.classList.contains('hl')){
    keepToolbar = true;
  } else {
    keepToolbar = false;
  }
}, true);
document.addEventListener('click', function(e){
  var target = e.target;
  if(target.classList && target.classList.contains('hl')){
    currentHlNode = target;
    lastRange = null;
    positionSelbarForRect(target.getBoundingClientRect());
    var sel=window.getSelection();
    if(sel) sel.removeAllRanges();
    setTimeout(function(){ keepToolbar=false; }, 0);
  }
}, true);
function doHighlight(){
  if(currentHlNode) return;
  if(!lastRange || lastRange.collapsed) return;
  var span=document.createElement('span'); span.className='hl';
  try { lastRange.surroundContents(span); }
  catch(e){
    var wrap=document.createElement('span'); wrap.className='hl';
    wrap.appendChild(lastRange.cloneContents());
    lastRange.deleteContents();
    lastRange.insertNode(wrap);
  }
  selbar.style.display='none';
  showToast('Highlighted');
}
function removeHighlight(){
  if(currentHlNode){
    var p = currentHlNode.parentNode;
    while(currentHlNode.firstChild) p.insertBefore(currentHlNode.firstChild, currentHlNode);
    p.removeChild(currentHlNode); p.normalize();
    currentHlNode = null;
    selbar.style.display='none';
    showToast('Highlight removed');
    return;
  }
  if(!lastRange) return;
  var selRect = lastRange.getBoundingClientRect();
  var walker=document.createTreeWalker(document.body, NodeFilter.SHOW_ELEMENT);
  var toRemove=[];
  while(walker.nextNode()){
    var n=walker.currentNode;
    if(n.classList && n.classList.contains('hl')) {
      var r = n.getBoundingClientRect();
      if(!(r.right < selRect.left || r.left > selRect.right || r.bottom < selRect.top || r.top > selRect.bottom)) toRemove.push(n);
    }
  }
  toRemove.forEach(function(el){ var p=el.parentNode; while(el.firstChild) p.insertBefore(el.firstChild, el); p.removeChild(el); p.normalize(); });
  selbar.style.display='none';
  showToast('Highlight removed');
}
btnHL.addEventListener('click', doHighlight);
btnUH.addEventListener('click', removeHighlight);
// Notes
var notes = document.getElementById('notes');
var noteArea = document.getElementById('noteArea');
var btnCopy=document.getElementById('btnCopy');
var btnClose=document.getElementById('btnClose');
function toggleNotes(){ 
  notes.style.display = (notes.style.display==='flex'?'none':'flex'); 
}
window.toggleNotes = toggleNotes;
btnClose.addEventListener('click', toggleNotes);
btnCopy.addEventListener('click', async function(){ 
  await navigator.clipboard.writeText(noteArea.value||''); 
  showToast('Copied'); 
});
btnNote.addEventListener('click', function(){
  var text = '';
  if(currentHlNode){ text = (currentHlNode.textContent||'').trim(); }
  else if(lastRange){ var frag = lastRange.cloneContents(); text = (frag.textContent||'').trim(); }
  toggleNotes();
  if(text) noteArea.value = (noteArea.value? noteArea.value+'\n':'') + '> ' + text + '\n';
  selbar.style.display='none';
});
// Toast
var toastEl=document.getElementById('toast');
function showToast(msg){
  toastEl.textContent=msg; 
  toastEl.style.display='block';
  setTimeout(function(){ toastEl.style.display='none'; }, 1200);
}
// Answer key and grading
var answers = {
  q27: "TRUE", q28: "NOT GIVEN", q29: "TRUE", q30: "FALSE",
  q31: "D", q32: "A", q33: "E", q34: "C",
  q35: "microscope", q36: "concepts", q37: "the computer", q38: "spectral analysis", q39: "table",
  q40: "C"
};
function grade(){
  var total=0, correct=0, lines=[];
  function push(q, ok, user){
    total++; if(ok) correct++;
    lines.push(q.toUpperCase()+": "+(user||'None')+" "+(ok?'✅':'❌'));
  }
  
  for(var n=27;n<=40;n++){
      var qName = 'q' + n;
      var radios = document.querySelectorAll('input[name="'+qName+'"]');
      var textInput = document.querySelector('input[name="'+qName+'"]');
      var val = '';
      var isCorrect = false;

      if(radios.length > 0) { // Radio button questions
          var sel = document.querySelector('input[name="'+qName+'"]:checked');
          val = sel ? sel.value : '';
          isCorrect = val.toUpperCase() === answers[qName].toUpperCase();
      } else if (textInput) { // Text input questions
          val = textInput.value.trim();
          isCorrect = val.toLowerCase() === answers[qName].toLowerCase();
      }
      push(qName, isCorrect, val);
  }
  
  var acc = (total? Math.round(100*correct/total):0);
  var html = '<p><strong>Score:</strong> '+correct+'/'+total+' <span class="badge">Accuracy '+acc+'%</span></p>';
  html += '<pre>'+lines.join('\n')+'</pre>';
  document.getElementById('results').innerHTML = html;
  
  var ahtml = '<ol start="27">';
  for(var i=27; i<=40; i++){
    ahtml += '<li>' + answers['q'+i] + '</li>';
  }
  ahtml += '</ol>';
  document.getElementById('answerContent').innerHTML = ahtml;
  document.querySelector('#answerBox .badge').textContent='tap to view';
}
function resetForm(){
  document.querySelectorAll('input[type="radio"]').forEach(el=>el.checked=false);
  document.querySelectorAll('input[type="text"]').forEach(el=>el.value="");
  document.getElementById('results').innerHTML='';
  document.getElementById('answerContent').innerHTML='';
  document.querySelector('#answerBox .badge').textContent = 'hidden';
  document.querySelectorAll('.q-item').forEach(item => item.classList.remove('answered'));
}
function scrollToElement(id){
  var el = document.getElementById(id);
  if(el){ 
    el.scrollIntoView({behavior:'smooth', block:'center'}); 
  }
  var navs = document.querySelectorAll('.practice-nav .q-item');
  navs.forEach(n => n.classList.remove('active'));
  var btn = document.getElementById(id.replace('-anchor','-nav'));
  if(btn){ 
    btn.classList.add('active'); 
    setTimeout(() => btn.classList.remove('active'), 800); 
  }
}
(function(){
  function mark(qn){
    var nav = document.getElementById('q'+qn+'-nav');
    if(!nav) return;
    
    var answered = false;
    var radios = document.querySelectorAll(`input[name="q${qn}"]`);
    var text = document.querySelector(`input[name="q${qn}"]`);
    
    if (radios.length > 0) {
      radios.forEach(function(r){ if(r.checked) answered=true; });
    }
    if (text) {
      answered = answered || (text.value && text.value.trim().length > 0);
    }

    if(answered) nav.classList.add('answered'); else nav.classList.remove('answered');
  }
  for(var q=27;q<=40;q++){
    (function(n){
      document.querySelectorAll(`input[name="q${n}"]`).forEach(function(r){ r.addEventListener('change', function(){ mark(n); }); });
      var text = document.querySelector(`input[name="q${n}"]`);
      if(text){ text.addEventListener('input', function(){ mark(n); }); }
    })(q);
  }
})();
</script>

<!-- 练习页面数据传输增强脚本 -->
<script>
if (!window.practicePageEnhancer) {
    const script = document.createElement('script');
    script.src = '../../js/practice-page-enhancer.js';
    script.onload = function() { console.log('练习页面增强脚本已加载'); };
    script.onerror = function() { console.error('练习页面增强脚本加载失败'); loadInlineEnhancer(); };
    document.head.appendChild(script);
}
function loadInlineEnhancer() {
    if (window.practicePageEnhancer) return;
    window.practicePageEnhancer = {
        initialize: function() {
            this.setupCommunication();
            this.setupAnswerListeners();
            this.interceptSubmit();
        },
        setupCommunication: function() {
            this.parentWindow = window.opener || window.parent;
            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'INIT_SESSION') {
                    this.sessionId = event.data.data.sessionId;
                    this.sendMessage('SESSION_READY', { pageType: this.detectPageType(), url: window.location.href });
                }
            });
        },
        detectPageType: function() {
            const title = document.title || '';
            if (title.includes('P1')) return 'P1';
            if (title.includes('P2')) return 'P2';
            if (title.includes('P3')) return 'P3';
            return 'unknown';
        },
        setupAnswerListeners: function() {
            this.answers = {};
            this.startTime = Date.now();
            document.addEventListener('change', (e) => {
                if (e.target.name) {
                    this.answers[e.target.name] = e.target.value;
                }
            });
             document.addEventListener('input', (e) => {
                if (e.target.name) {
                    this.answers[e.target.name] = e.target.value;
                }
            });
        },
        interceptSubmit: function() {
            if (typeof window.grade === 'function') {
                const originalGrade = window.grade;
                window.grade = () => {
                    const result = originalGrade();
                    setTimeout(() => this.handleSubmit(), 200);
                    return result;
                };
            }
        },
        handleSubmit: function() {
            const results = {
                sessionId: this.sessionId,
                startTime: this.startTime,
                endTime: Date.now(),
                duration: Math.round((Date.now() - this.startTime) / 1000),
                answers: this.answers,
                scoreInfo: this.extractScore(),
                pageType: this.detectPageType(),
                url: window.location.href
            };
            this.sendMessage('PRACTICE_COMPLETE', results);
        },
        extractScore: function() {
            const resultsEl = document.getElementById('results');
            if (!resultsEl) return null;
            const text = resultsEl.textContent || '';
            const scoreMatch = text.match(/Score:\s*(\d+)\/(\d+)/i);
            if (scoreMatch) {
                const correct = parseInt(scoreMatch[1]);
                const total = parseInt(scoreMatch[2]);
                return { correct: correct, total: total, accuracy: total > 0 ? correct / total : 0, percentage: Math.round((correct / total) * 100), source: 'inline_extraction' };
            }
            return null;
        },
        sendMessage: function(type, data) {
            if (this.parentWindow) {
                this.parentWindow.postMessage({ type: type, data: data, source: 'practice_page' }, '*');
            }
        }
    };
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => { window.practicePageEnhancer.initialize(); });
    } else {
        window.practicePageEnhancer.initialize();
    }
}
</script>

</body>
</html>