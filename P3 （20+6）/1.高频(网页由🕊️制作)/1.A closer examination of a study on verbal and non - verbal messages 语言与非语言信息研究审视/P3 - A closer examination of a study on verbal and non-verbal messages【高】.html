<html lang="en"><head>
<meta charset="utf-8">
<title>A closer examination of a study on verbal and non-verbal messages</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport">
<style>
  :root { --line:#e5e7eb; --bg:#f6f7fb; --panel:#fff; --accent:#3b82f6; --muted:#6b7280; --shadow:0 6px 20px rgba(0,0,0,.12); }
  * { box-sizing: border-box; }
  html,body { height:100%; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); }
  #timer { position: static; display: inline-block; margin-left: 8px; background:#fff; border:1px solid var(--line); border-radius:10px; padding:2px 8px; font-size:14px; vertical-align: middle; }
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:var(--panel); overflow:auto; padding:20px; }
  #left { flex: 0 0 50%; min-width: 280px; }
  #right { flex: 1 1 auto; min-width: 320px; background:#fbfbff; border-left:1px solid var(--line); }
  #divider { flex: 0 0 8px; background: linear-gradient(90deg,#e5e7eb,#d1d5db); cursor: ew-resize; position:relative; z-index: 5; user-select:none; }
  h2,h3,h4 { margin:0 0 10px; }
  #left p { margin: 0 0 12px; line-height: 1.6; word-break: normal; overflow-wrap: normal; hyphens: none; }
  .group { background:#fff; border:1px solid var(--line); border-radius:10px; padding:12px; margin-bottom:14px; }
  table { border-collapse: collapse; width:100%; }
  th, td { border:1px solid var(--line); padding:6px; text-align:center; font-size:14px; }
  th:first-child, td:first-child { width:92px; }
  button { padding:8px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; cursor:pointer; }
  button.primary { background:var(--accent); color:#fff; border-color:#3b82f6; }
  #results { background:#fff; border:1px solid var(--line); border-radius:10px; padding:10px; }
  .hl { background:#fff3a3; box-shadow: inset 0 -2px 0 rgba(0,0,0,.05); cursor: pointer; }
  .hl:hover { filter: brightness(0.98); }
  #selbar { position: absolute; display:none; z-index: 2000; background:#111; color:#fff; border-radius: 8px; padding: 6px; box-shadow: var(--shadow); font-size: 13px; gap:6px; align-items: center; }
  #selbar button { background: transparent; color:#fff; border: 1px solid rgba(255,255,255,.25); padding: 4px 8px; border-radius: 6px; cursor:pointer; }
  #selbar button:hover { border-color:#fff; }
  #notes { position: fixed; right: 12px; bottom: 12px; width: 320px; height: 42vh; background:#fff; border:1px solid var(--line); border-radius: 12px; display:none; flex-direction: column; z-index:1500; box-shadow: var(--shadow); }
  #notes header { display:flex; align-items:center; justify-content: space-between; padding:8px 10px; border-bottom:1px solid var(--line); }
  #notes textarea { flex:1; border:0; padding:10px; resize:none; font-size:14px; line-height:1.5; }
  #toast { position: fixed; left:50%; transform: translateX(-50%); bottom: 24px; background:#111; color:#fff; padding:8px 12px; border-radius: 8px; display:none; z-index:2500; }
  /* DnD styles */
  .dropzone { border:2px dashed #cbd5e1; background:#f8fafc; border-radius:10px; min-height:40px; padding:4px 8px; display:inline-flex; align-items:center; justify-content:space-between; gap:8px; width: auto; min-width: 120px; max-width: 200px; vertical-align: middle; }
  .droplabel { color:#64748b; font-size:14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .cardpool { background:#f1f5f9; border-radius:10px; padding:12px; display:flex; flex-wrap:wrap; gap:8px; }
  .pool-slot { min-height:40px; }
  .card { background:#fff; border:1px solid #e5e7eb; border-radius:8px; padding:8px 10px; display:inline-flex; gap:8px; align-items:center; cursor:grab; box-shadow:0 1px 0 rgba(0,0,0,.03); white-space: nowrap; }
  .card:active { cursor:grabbing; }
  .tag { background:#eef2ff; color:#4338ca; padding:2px 8px; border-radius:999px; font-size:12px; }
  .btn-clear { border:1px solid #e5e7eb; background:#fff; border-radius:8px; padding:6px 8px; cursor:pointer; }
  .ghost { opacity: .5; }
  .over { outline:2px dashed #3b82f6; }
  details.answerbox summary { cursor: pointer; user-select:none; list-style: none; }
  details.answerbox { border:1px dashed var(--line); border-radius:10px; padding:8px 10px; background:#fff; }
  .badge { display:inline-block; background:#eef2ff; color:#4338ca; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:6px; }
/* bottom question nav */
body { padding-bottom: 82px; }
.practice-nav { background:#fff; border-bottom:2px solid var(--line); padding:12px 20px; display:flex; align-items:center; gap:20px; box-shadow:0 2px 4px rgba(0,0,0,.05); flex-wrap:wrap; position:fixed; left:0; right:0; bottom:0; border-top:2px solid var(--line); border-bottom:0; z-index:4000; }
.practice-nav .title { font-weight:600; color:var(--muted); }
.practice-nav .questions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
.practice-nav .q-item { padding:6px 10px; border:1px solid var(--line); border-radius:6px; background:#fff; cursor:pointer; font-size:14px; transition:all 0.2s; min-width:36px; text-align:center; }
.practice-nav .q-item:hover { background:#f1f5f9; border-color:var(--accent); }
.practice-nav .q-item.answered { background:#e0e7ff; border-color:var(--accent); color:var(--accent); font-weight:500; }
.practice-nav .q-item.active { background:var(--accent); color:#fff; border-color:var(--accent); }
#selbar { z-index: 6000 !important; } /* ensure toolbar sits above bottom nav */
</style>
</head>
<body>
<div class="practice-nav">
  <div class="title">Questions</div>
  <div class="questions">
    <div class="q-item" id="q27-nav" onclick="scrollToElement('q27-anchor')">27</div>
    <div class="q-item" id="q28-nav" onclick="scrollToElement('q28-anchor')">28</div>
    <div class="q-item" id="q29-nav" onclick="scrollToElement('q29-anchor')">29</div>
    <div class="q-item" id="q30-nav" onclick="scrollToElement('q30-anchor')">30</div>
    <div class="q-item" id="q31-nav" onclick="scrollToElement('q31-anchor')">31</div>
    <div class="q-item" id="q32-nav" onclick="scrollToElement('q32-anchor')">32</div>
    <div class="q-item" id="q33-nav" onclick="scrollToElement('q33-anchor')">33</div>
    <div class="q-item" id="q34-nav" onclick="scrollToElement('q34-anchor')">34</div>
    <div class="q-item" id="q35-nav" onclick="scrollToElement('q35-anchor')">35</div>
    <div class="q-item" id="q36-nav" onclick="scrollToElement('q36-anchor')">36</div>
    <div class="q-item" id="q37-nav" onclick="scrollToElement('q37-anchor')">37</div>
    <div class="q-item" id="q38-nav" onclick="scrollToElement('q38-anchor')">38</div>
    <div class="q-item" id="q39-nav" onclick="scrollToElement('q39-anchor')">39</div>
    <div class="q-item" id="q40-nav" onclick="scrollToElement('q40-anchor')">40</div>
  </div>
</div>

<div class="shell">
  <section class="pane" id="left">
    <h2>READING PASSAGE 3 <span id="timer">00:00</span></h2>
    <p>You should spend about 20 minutes on Questions 27–40, which are based on Reading Passage 3 below.</p>
    <h3>A closer examination of a study on verbal and non-verbal messages</h3>
    <p><em>A study of non-verbal communication carried out in 1967 continues to be widely quoted today. David Lapakko looks at limitations in the original study.</em></p>
    
    <h4>Description of the Study</h4>
    <p>The findings of a study on verbal and non-verbal messages in communication by Albert Mehrabian and his colleagues at UCLA in 1967 have been quoted so frequently that they are now often regarded as a self-evident truth.</p>
    <p>In the first experiment, subjects were asked to listen to a recording of a female saying the word “maybe” in three tones of voice to convey liking, neutrality, and disliking. The subjects were then shown photos of female faces expressing the same three emotions and were asked to guess the emotions in the recorded voice and the photos. It was found that the photos received more accurate responses than the voices. In the second experiment, subjects listened to nine recorded words spoken in different tones of voice. Three words had positive meanings (e.g. honey), three were neutral (e.g. oh), and three were negative (e.g. terrible). Again, the subjects had to guess the speaker’s emotions. It was found that tone of voice carried more meaning than the individual words. From these experiments the researchers concluded that 7% of our feeling towards a speaker is based on the actual words they use, 38% on their tone of voice, and 55% on their body language (e.g. facial expression).</p>
    
    <h4>Methodological Issues</h4>
    <p>However, a closer look at the study reveals several limitations. The first is that the entire study involved only 62 subjects. Of these, 25 were used to select the word for the first experiment, while the key issue – comparing verbal and non-verbal communication – was determined by only the 37 remaining subjects. All were female undergraduates who participated as part of their introductory psychology course, and their ages and academic qualifications seem remarkably uniform. Thus, the findings may simply be a product of the nature of the sample.</p>
    <p>Critics have also pointed out that the 7–38–55 formula is flawed since it was pieced together from two different experiments, neither of which involved all three channels (verbal, vocal, and facial). In addition, in the first experiment the single word “maybe” was used throughout so it was impossible for the effects of changes in verbal input to be assessed. The researchers intentionally used a “neutral” word so naturally the subjects found little meaning there. Clearly, such a methodology lacks validity. In the real world, people communicate in a particular context and speak in phrases and full-blown sentences, making extensive use of the multi-faceted vehicle of language.</p>
    
    <p>My concern is that interpretations of this study have gained such prominence in our pedagogical literature. This 7–38–55 formula appears in many basic texts, used for training in public speaking, interpersonal communication, and organizational communication.</p>
    
    <h4>Lessons to Consider</h4>
    <p>Clearly, one appealing aspect of the Mehrabian study is its numerical precision. Communication is a complex phenomenon, but it seems less so when we can rely on these three magical numbers. In contrast to the ambiguities of language, numbers seem to possess exactness. And the popular appeal of the study has given the 7–38–55 formula enormous credibility. There is a certain mystique about non-verbal communication, and the continued references to this research sustain it, encouraging people to believe in the overwhelming importance of the non-verbal message compared with the verbal one. Yet we know that even one ill-chosen word to a colleague or friend can make or break a communicative effort. Words do matter. Bradley (1991), one of the few textbook writers to criticize the Mehrabian study, makes the same point when he observes, “If we could communicate 93% of information and attitudes with vocal and facial cues, it would be wasteful to spend time learning a language.”</p>
    
    <p>Mehrabian himself believes his research should not be interpreted to devalue the role of language in communication, saying:</p>
    <p>“Please remember that all my findings… dealt with communications of feelings and attitudes… it is absurd to imply or suggest that the verbal portion of all communication constitutes only 7% of the message… anytime we communicate abstract relationships (e.g., x = y – the square of z) clearly 100% of the entire communication is verbal.” (Mehrabian, 1995)</p>
    <p>To be fair, many textbook writers attempt to be faithful to the context of Mehrabian’s research. For example, Stewart and D’Angelo (1988) write: “Mehrabian argues that when we’re uncertain about what someone’s feeling, or about how much we like him or her, we rely… only 7% on the words that are spoken.” Others try to play down the specific percentages, saying that an understanding of the general importance of non-verbal cues is more important. Nonetheless, other textbook authors simply use the numbers without placing any limits on their meaning.</p>
    
    <h4>Conclusion</h4>
    <p>Since this relatively small study was first published it has achieved an influence far beyond its intended scope. We need to put it into its proper perspective and learn some important lessons from it regarding social science research, communication pedagogy, and the forces which have created widespread misunderstanding about communication.</p>
    <p>&nbsp;</p>
    <p>&nbsp;</p>
  </section>

  <div id="divider" title="Drag to resize"></div>

  <section class="pane" id="right">
    <h3>Questions</h3>
    
    <div class="group">
      <h4>Questions 27–30</h4>
      <p>Complete the summary using the list of words and phrases, A–H, below.</p>
      <p>Write the correct letter, A–H, in boxes 27–30 on your answer sheet.</p>
      <p>Mehrabian’s 1967 study</p>
      <p>Albert Mehrabian and his colleagues carried out an influential study comparing the <a id="q27-anchor"></a></p><div class="dropzone" data-target="q27"><span class="droplabel">Drag answer here</span></div> of verbal and non-verbal communication. This involved two experiments. In both experiments, subjects had to identify the <a id="q28-anchor"></a><div class="dropzone" data-target="q28"><span class="droplabel">Drag answer here</span></div> being communicated by other people. The two main areas focused on in the first experiment were voice tones and <a id="q29-anchor"></a><div class="dropzone" data-target="q29"><span class="droplabel">Drag answer here</span></div>, while the second focused mainly on voice tones and <a id="q30-anchor"></a><div class="dropzone" data-target="q30"><span class="droplabel">Drag answer here</span></div>.<p></p>
      
      <div class="cardpool">
        <div class="card" draggable="true" data-value="A">A facial expressions</div>
        <div class="card" draggable="true" data-value="B">B purposes</div>
        <div class="card" draggable="true" data-value="C">C printed words</div>
        <div class="card" draggable="true" data-value="D">D effects</div>
        <div class="card" draggable="true" data-value="E">E word meanings</div>
        <div class="card" draggable="true" data-value="F">F gender differences</div>
        <div class="card" draggable="true" data-value="G">G feelings</div>
        <div class="card" draggable="true" data-value="H">H characteristics</div>
      </div>
    </div>

    <div class="group">
      <h4>Questions 31–35</h4>
      <p>Do the following statements agree with the views of the writer in Reading Passage 3?</p>
      <p>In boxes 31–35 on your answer sheet, write</p>
      <ul>
        <li>YES if the statement agrees with the views of the writer</li>
        <li>NO if the statement contradicts the views of the writer</li>
        <li>NOT GIVEN if it is impossible to say what the writer thinks about this</li>
      </ul>
      
      <a id="q31-anchor"></a>
      <div id="q31-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>31 One limitation of the study was that there were too few subjects involved.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q31" type="radio" value="YES"> YES</label>
          <label style="margin:0;"><input name="q31" type="radio" value="NO"> NO</label>
          <label style="margin:0;"><input name="q31" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <a id="q32-anchor"></a>
      <div id="q32-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>32 The fact that the subjects in the study came from a similar background was an advantage.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q32" type="radio" value="YES"> YES</label>
          <label style="margin:0;"><input name="q32" type="radio" value="NO"> NO</label>
          <label style="margin:0;"><input name="q32" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <a id="q33-anchor"></a>
      <div id="q33-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>33 The two experiments should have been carried out in a different order.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q33" type="radio" value="YES"> YES</label>
          <label style="margin:0;"><input name="q33" type="radio" value="NO"> NO</label>
          <label style="margin:0;"><input name="q33" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <a id="q34-anchor"></a>
      <div id="q34-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>34 The researchers’ choice of a neutral word was helpful in the context of the study.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q34" type="radio" value="YES"> YES</label>
          <label style="margin:0;"><input name="q34" type="radio" value="NO"> NO</label>
          <label style="margin:0;"><input name="q34" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <a id="q35-anchor"></a>
      <div id="q35-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>35 The study would have been more valid if it had included a range of languages.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q35" type="radio" value="YES"> YES</label>
          <label style="margin:0;"><input name="q35" type="radio" value="NO"> NO</label>
          <label style="margin:0;"><input name="q35" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
    </div>

    <div class="group">
      <h4>Questions 36–40</h4>
      <p>Choose the correct letter, A, B, C or D.</p>
      <p>Write the correct letter in boxes 36–40 on your answer sheet.</p>
      
      <a id="q36-anchor"></a>
      <div id="q36-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>36 What does the writer say about the “numerical precision” of Mehrabian’s study?</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q36" type="radio" value="A"> A It makes the claims more attractive.</label>
          <label style="margin:0;"><input name="q36" type="radio" value="B"> B It is the strongest point of the study.</label>
          <label style="margin:0;"><input name="q36" type="radio" value="C"> C It will appeal to superstitious people.</label>
          <label style="margin:0;"><input name="q36" type="radio" value="D"> D It allows comparison between languages.</label>
        </div>
      </div>
      
      <a id="q37-anchor"></a>
      <div id="q37-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>37 What does the writer say about the popularity of the 7–38–55 formula?</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q37" type="radio" value="A"> A It is unlikely to maintain its present status.</label>
          <label style="margin:0;"><input name="q37" type="radio" value="B"> B It is leading to an undervaluing of words.</label>
          <label style="margin:0;"><input name="q37" type="radio" value="C"> C It should be applied in a more practical way.</label>
          <label style="margin:0;"><input name="q37" type="radio" value="D"> D It may help understanding of non-verbal messages.</label>
        </div>
      </div>
      
      <a id="q38-anchor"></a>
      <div id="q38-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>38 What point is Bradley making about language learning?</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q38" type="radio" value="A"> A Language could be learned more efficiently than it is.</label>
          <label style="margin:0;"><input name="q38" type="radio" value="B"> B More research is needed into attitudes to communication.</label>
          <label style="margin:0;"><input name="q38" type="radio" value="C"> C More time should be spent looking at tone and body language.</label>
          <label style="margin:0;"><input name="q38" type="radio" value="D"> D Language must be important since we make an effort to acquire it.</label>
        </div>
      </div>
      
      <a id="q39-anchor"></a>
      <div id="q39-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>39 What does Mehrabian himself say about his findings?</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q39" type="radio" value="A"> A They are relevant to only one area of communication.</label>
          <label style="margin:0;"><input name="q39" type="radio" value="B"> B It is only in maths that 100% of communication is verbal.</label>
          <label style="margin:0;"><input name="q39" type="radio" value="C"> C Feelings are more difficult to communicate than numerical facts.</label>
          <label style="margin:0;"><input name="q39" type="radio" value="D"> D Non-verbal communication is the main part of the message.</label>
        </div>
      </div>
      
      <a id="q40-anchor"></a>
      <div id="q40-section" style="padding:8px 0;border-top:1px dashed var(--line);">
        <p>40 What is the writer’s purpose in the paragraph beginning “To be fair…”?</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:4px 0;">
          <label style="margin:0;"><input name="q40" type="radio" value="A"> A To justify the strong points of Mehrabian’s study.</label>
          <label style="margin:0;"><input name="q40" type="radio" value="B"> B To outline other research on non-verbal behaviour.</label>
          <label style="margin:0;"><input name="q40" type="radio" value="C"> C To present varying interpretations of Mehrabian’s study.</label>
          <label style="margin:0;"><input name="q40" type="radio" value="D"> D To show that textbooks tend to ignore non-verbal behaviour.</label>
        </div>
      </div>
    </div>

    <div style="display:flex;gap:8px;margin-bottom:10px;">
      <button class="primary" onclick="grade()">Submit</button>
      <button onclick="resetForm()">Reset</button>
      <button onclick="toggleNotes()">Notes</button>
    </div>
    <div id="results"></div>
    <details class="answerbox" id="answerBox">
      <summary>Show answers (click to toggle) <span class="badge">hidden</span></summary>
      <div id="answerContent"></div>
    </details>
  </section>
</div>

<div aria-label="Selection tools" id="selbar" role="toolbar">
  <button id="btnHL">Highlight</button>
  <button id="btnUH">Remove</button>
  <button id="btnNote">Note</button>
</div>

<div id="notes">
  <header>
    <strong>Notes</strong>
    <div>
      <button id="btnCopy">Copy</button>
      <button id="btnClose">Close</button>
    </div>
  </header>
  <textarea id="noteArea" placeholder="Type your notes here..."></textarea>
</div>

<div id="toast"></div>

<script>
// Timer
let _t=0; const _timerEl=document.getElementById('timer');
setInterval(function(){ 
  _t++; 
  var m=String(Math.floor(_t/60)).padStart(2,'0'); 
  var s=String(_t%60).padStart(2,'0'); 
  _timerEl.textContent=m+':'+s; 
},1000);

// Drag divider
var divider = document.getElementById('divider');
var left = document.getElementById('left');
var right = document.getElementById('right');
var dragging=false;

function startDrag(e){ 
  dragging=true; 
  document.body.style.cursor='ew-resize'; 
  if(e.preventDefault) e.preventDefault(); 
}

function endDrag(){ 
  dragging=false; 
  document.body.style.cursor=''; 
}

function onMove(clientX){
  var container = document.querySelector('.shell').getBoundingClientRect();
  var x = clientX - container.left;
  x = Math.max(280, Math.min(container.width-320, x));
  left.style.flex = '0 0 ' + x + 'px';
  right.style.flex = '1 1 auto';
}

divider.addEventListener('mousedown', function(e){ startDrag(e); });
window.addEventListener('mousemove', function(e){ if(dragging) onMove(e.clientX); });
window.addEventListener('mouseup', endDrag);
divider.addEventListener('touchstart', function(e){ startDrag(e.touches[0]); }, {passive:false});
window.addEventListener('touchmove', function(e){ if(dragging) onMove(e.touches[0].clientX); }, {passive:false});
window.addEventListener('touchend', endDrag);
</script>

<script>
// Highlight toolbar (fixed for multi-line highlighting)
var selbar = document.getElementById('selbar');
var btnHL = document.getElementById('btnHL');
var btnUH = document.getElementById('btnUH');
var btnNote = document.getElementById('btnNote');
var lastRange=null;
var currentHlNode=null;
var keepToolbar=false; // prevent selectionchange from hiding toolbar during HL click

function positionSelbarForRect(rect){
  selbar.style.display='flex';
  requestAnimationFrame(function(){
    var top = window.scrollY + rect.top - selbar.offsetHeight - 8;
    var leftPos = window.scrollX + rect.left + rect.width/2 - selbar.offsetWidth/2;
    selbar.style.top = ((top>0)?top:(window.scrollY + rect.bottom + 8)) + 'px';
    selbar.style.left = Math.max(8, leftPos) + 'px';
  });
}

function updateSelbar(){
  var sel=window.getSelection();
  if(!sel || sel.rangeCount===0 || sel.isCollapsed) { 
    selbar.style.display='none'; 
    currentHlNode=null; 
    return; 
  }
  var range = sel.getRangeAt(0);
  lastRange = range.cloneRange();
  currentHlNode=null;
  positionSelbarForRect(range.getBoundingClientRect());
}

document.getElementById('left').addEventListener('mouseup', updateSelbar);
document.getElementById('right').addEventListener('mouseup', updateSelbar);
document.addEventListener('selectionchange', function(){ 
  var sel=window.getSelection(); 
  if(!sel || sel.rangeCount===0 || sel.isCollapsed){ 
    if(!keepToolbar && !currentHlNode){ 
      selbar.style.display='none'; 
    } 
  } 
});
document.addEventListener('scroll', function(){ 
  if(selbar.style.display==='flex') updateSelbar(); 
});

// Pre-flag on mousedown to avoid selectionchange hiding the toolbar
document.addEventListener('mousedown', function(e){
  var t = e.target;
  if(t.classList && t.classList.contains('hl')){
    keepToolbar = true;
  } else {
    keepToolbar = false;
  }
}, true);

// Click a highlight -> show toolbar (capture but do not block)
document.addEventListener('click', function(e){
  var target = e.target;
  if(target.classList && target.classList.contains('hl')){
    currentHlNode = target;
    lastRange = null;
    positionSelbarForRect(target.getBoundingClientRect());
    var sel=window.getSelection();
    if(sel) sel.removeAllRanges();
    setTimeout(function(){ keepToolbar=false; }, 0);
  }
}, true);

// 修复的高光功能，支持跨段落和多行
function doHighlight(){
  if(currentHlNode) return;
  if(!lastRange || lastRange.collapsed) return;
  
  // 检查选择是否跨多个节点
  const startNode = lastRange.startContainer;
  const endNode = lastRange.endContainer;
  
  // 如果是简单选择（同一节点内）
  if (startNode === endNode) {
    try {
      const span = document.createElement('span');
      span.className = 'hl';
      lastRange.surroundContents(span);
      selbar.style.display = 'none';
      showToast('Highlighted');
      return;
    } catch (e) {
      // 处理边界情况
    }
  }
  
  // 处理复杂选择（跨多个节点）
  const fragment = lastRange.cloneContents();
  const div = document.createElement('div');
  div.appendChild(fragment);
  
  // 递归处理所有文本节点并添加高光
  function processNode(node, parentHighlight) {
    if (node.nodeType === Node.TEXT_NODE) {
      if (node.textContent.trim().length > 0) {
        const span = document.createElement('span');
        span.className = 'hl';
        span.textContent = node.textContent;
        return span;
      }
      return node;
    }
    
    if (node.nodeType === Node.ELEMENT_NODE) {
      // 对于块级元素，创建新的块级高光容器
      const isBlock = window.getComputedStyle(node).display.includes('block') || 
                     ['P', 'H1', 'H2', 'H3', 'H4', 'DIV'].includes(node.tagName);
      
      const wrapper = isBlock ? document.createElement(node.tagName.toLowerCase()) : document.createElement('span');
      wrapper.className = isBlock ? node.className + ' hl' : 'hl';
      
      // 复制其他属性
      Array.from(node.attributes).forEach(attr => {
        wrapper.setAttribute(attr.name, attr.value);
      });
      
      // 处理子节点
      while (node.firstChild) {
        const processedChild = processNode(node.firstChild, wrapper);
        wrapper.appendChild(processedChild);
      }
      
      return wrapper;
    }
    
    return node;
  }
  
  // 处理所有内容
  const highlightedContent = processNode(div, null);
  
  // 清除原有内容并插入高光内容
  lastRange.deleteContents();
  lastRange.insertNode(highlightedContent);
  
  selbar.style.display = 'none';
  showToast('Highlighted');
}

function removeHighlight(){
  if(currentHlNode){
    // 移除单个高光元素
    const parent = currentHlNode.parentNode;
    while(currentHlNode.firstChild) {
      parent.insertBefore(currentHlNode.firstChild, currentHlNode);
    }
    parent.removeChild(currentHlNode);
    parent.normalize(); // 合并相邻文本节点
    currentHlNode = null;
    selbar.style.display='none';
    showToast('Highlight removed');
    return;
  }
  
  if(!lastRange) return;
  
  // 移除选区内的所有高光
  const selRect = lastRange.getBoundingClientRect();
  const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_ELEMENT);
  const toRemove = [];
  
  while(walker.nextNode()){
    const node = walker.currentNode;
    if(node.classList && node.classList.contains('hl')) {
      const rect = node.getBoundingClientRect();
      // 检查节点是否与选区重叠
      if(!(rect.right < selRect.left || rect.left > selRect.right || 
          rect.bottom < selRect.top || rect.top > selRect.bottom)) {
        toRemove.push(node);
      }
    }
  }
  
  // 移除所有找到的高光元素
  toRemove.forEach(el => {
    const parent = el.parentNode;
    while(el.firstChild) {
      parent.insertBefore(el.firstChild, el);
    }
    parent.removeChild(el);
    parent.normalize(); // 合并相邻文本节点
  });
  
  selbar.style.display='none';
  showToast('Highlight removed');
}

btnHL.addEventListener('click', doHighlight);
btnUH.addEventListener('click', removeHighlight);
</script>

<script>
// Notes
var notes = document.getElementById('notes');
var noteArea = document.getElementById('noteArea');
var btnCopy=document.getElementById('btnCopy');
var btnClose=document.getElementById('btnClose');

function toggleNotes(){ 
  notes.style.display = (notes.style.display==='flex'?'none':'flex'); 
}
window.toggleNotes = toggleNotes;

btnClose.addEventListener('click', toggleNotes);
btnCopy.addEventListener('click', async function(){ 
  await navigator.clipboard.writeText(noteArea.value||''); 
  showToast('Copied'); 
});

btnNote.addEventListener('click', function(){
  var text = '';
  if(currentHlNode){ 
    text = (currentHlNode.textContent||'').trim(); 
  } else if(lastRange){ 
    var frag = lastRange.cloneContents(); 
    text = (frag.textContent||'').trim(); 
  }
  toggleNotes();
  if(text) {
    noteArea.value = (noteArea.value? noteArea.value+'\n':'') + '> ' + text + '\n';
  }
  selbar.style.display='none';
});

// Toast
var toastEl=document.getElementById('toast');
function showToast(msg){
  toastEl.textContent=msg; 
  toastEl.style.display='block';
  setTimeout(function(){ toastEl.style.display='none'; }, 1200);
}
</script>

<script>
// Drag and drop for questions 27-30
const cards = document.querySelectorAll('.card');
const dropzones = document.querySelectorAll('.dropzone');

cards.forEach(card => {
  card.addEventListener('dragstart', () => {
    card.classList.add('dragging');
  });
  card.addEventListener('dragend', () => {
    card.classList.remove('dragging');
  });
});

dropzones.forEach(zone => {
  zone.addEventListener('dragover', e => {
    e.preventDefault();
    zone.classList.add('over');
  });
  
  zone.addEventListener('dragleave', () => {
    zone.classList.remove('over');
  });
  
  zone.addEventListener('drop', e => {
    e.preventDefault();
    zone.classList.remove('over');
    const draggingCard = document.querySelector('.dragging');
    if (draggingCard) {
      // Clear existing content
      zone.innerHTML = '';
      zone.appendChild(draggingCard);
      // Mark as answered
      const targetQ = zone.dataset.target;
      document.getElementById(targetQ + '-nav').classList.add('answered');
    }
  });
});
</script>

<script>
// Answer key and grading
var answers = {
  "q27":"D", "q28":"G", "q29":"A", "q30":"E",
  "q31":"YES", "q32":"NO", "q33":"NOT GIVEN", "q34":"NO", "q35":"NOT GIVEN",
  "q36":"A", "q37":"B", "q38":"D", "q39":"A", "q40":"C"
};

function grade(){
  var total=0, correct=0, lines=[];
  
  // Check drag-and-drop questions (27-30)
  dropzones.forEach(zone => {
    const q = zone.dataset.target;
    total++;
    const selectedCard = zone.querySelector('.card');
    const userAnswer = selectedCard ? selectedCard.dataset.value : '';
    const isCorrect = userAnswer === answers[q];
    if (isCorrect) correct++;
    lines.push(`${q.toUpperCase()}: ${userAnswer || 'None'} ${isCorrect ? '✅' : '❌'}`);
  });
  
  // Check radio questions (31-40)
  for(let n=31; n<=40; n++){
    const q = `q${n}`;
    total++;
    const selected = document.querySelector(`input[name="${q}"]:checked`);
    const userAnswer = selected ? selected.value : '';
    const isCorrect = userAnswer === answers[q];
    if (isCorrect) correct++;
    lines.push(`${q.toUpperCase()}: ${userAnswer || 'None'} ${isCorrect ? '✅' : '❌'}`);
  }
  
  // Show results
  const acc = Math.round(100 * correct / total);
  document.getElementById('results').innerHTML = `
    <p><strong>Score:</strong> ${correct}/${total} <span class="badge">Accuracy ${acc}%</span></p>
    <pre>${lines.join('\n')}</pre>
  `;
  
  // Show answer key
  document.getElementById('answerContent').innerHTML = `
    <ol>
      <li>27 → D (effects)</li>
      <li>28 → G (feelings)</li>
      <li>29 → A (facial expressions)</li>
      <li>30 → E (word meanings)</li>
      <li>31 → YES</li>
      <li>32 → NO</li>
      <li>33 → NOT GIVEN</li>
      <li>34 → NO</li>
      <li>35 → NOT GIVEN</li>
      <li>36 → A</li>
      <li>37 → B</li>
      <li>38 → D</li>
      <li>39 → A</li>
      <li>40 → C</li>
    </ol>
  `;
  document.querySelector('#answerBox .badge').textContent = 'tap to view';
}

function resetForm(){
  // Reset drag-and-drop
  dropzones.forEach(zone => {
    const card = zone.querySelector('.card');
    if (card) {
      document.querySelector('.cardpool').appendChild(card);
      zone.innerHTML = '<span class="droplabel">Drag answer here</span>';
    }
  });
  
  // Reset radio buttons
  document.querySelectorAll('input[type="radio"]').forEach(radio => {
    radio.checked = false;
  });
  
  // Reset results and answers
  document.getElementById('results').innerHTML = '';
  document.getElementById('answerContent').innerHTML = '';
  document.querySelector('#answerBox .badge').textContent = 'hidden';
  
  // Reset answered status in nav
  document.querySelectorAll('.q-item').forEach(item => {
    item.classList.remove('answered');
  });
}

// Scroll to question anchor
function scrollToElement(id){
  const el = document.getElementById(id);
  if(el){ 
    el.scrollIntoView({behavior:'smooth', block:'center'}); 
  }
  // Highlight nav item briefly
  const navs = document.querySelectorAll('.practice-nav .q-item');
  navs.forEach(n => n.classList.remove('active'));
  const btn = document.getElementById(id.replace('-anchor','-nav'));
  if(btn){ 
    btn.classList.add('active'); 
    setTimeout(() => btn.classList.remove('active'), 800); 
  }
}

// Mark answered on interaction
(function(){
  function markAnswered(qn){
    const nav = document.getElementById(`q${qn}-nav`);
    if(!nav) return;
    let answered = false;
    
    // Check dropzones (27-30)
    if(qn >=27 && qn <=30){
      const zone = document.querySelector(`.dropzone[data-target="q${qn}"]`);
      answered = zone.querySelector('.card') !== null;
    } 
    // Check radio buttons (31-40)
    else {
      const radios = document.querySelectorAll(`input[name="q${qn}"]:checked`);
      answered = radios.length > 0;
    }
    
    if(answered) nav.classList.add('answered');
    else nav.classList.remove('answered');
  }
  
  // Monitor dropzones
  dropzones.forEach(zone => {
    zone.addEventListener('drop', () => {
      const qn = zone.dataset.target.replace('q', '');
      markAnswered(qn);
    });
  });
  
  // Monitor radio buttons
  for(let n=31; n<=40; n++){
    document.querySelectorAll(`input[name="q${n}"]`).forEach(radio => {
      radio.addEventListener('change', () => markAnswered(n));
    });
  }
})();
</script>


<!-- 练习页面数据传输增强脚本 -->
<script>
// 检查是否已经有增强脚本
if (!window.practicePageEnhancer) {
    // 动态加载增强脚本
    const script = document.createElement('script');
    script.src = '../../js/practice-page-enhancer.js';
    script.onload = function() {
        console.log('练习页面增强脚本已加载');
    };
    script.onerror = function() {
        console.error('练习页面增强脚本加载失败');
        // 降级到内联增强
        loadInlineEnhancer();
    };
    document.head.appendChild(script);
}

// 内联增强器（降级方案）
function loadInlineEnhancer() {
    if (window.practicePageEnhancer) return;
    
    window.practicePageEnhancer = {
        initialize: function() {
            console.log('[InlineEnhancer] 内联增强器已初始化');
            this.setupCommunication();
            this.setupAnswerListeners();
            this.interceptSubmit();
        },
        
        setupCommunication: function() {
            this.parentWindow = window.opener || window.parent;
            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'INIT_SESSION') {
                    this.sessionId = event.data.data.sessionId;
                    this.sendMessage('SESSION_READY', {
                        pageType: this.detectPageType(),
                        url: window.location.href
                    });
                }
            });
        },
        
        detectPageType: function() {
            const title = document.title || '';
            if (title.includes('P1')) return 'P1';
            if (title.includes('P2')) return 'P2';
            if (title.includes('P3')) return 'P3';
            return 'unknown';
        },
        
        setupAnswerListeners: function() {
            this.answers = {};
            this.startTime = Date.now();
            
            document.addEventListener('change', (e) => {
                if (e.target.name && e.target.name.startsWith('q')) {
                    this.answers[e.target.name] = e.target.value;
                }
            });
        },
        
        interceptSubmit: function() {
            // 拦截grade函数
            if (typeof window.grade === 'function') {
                const originalGrade = window.grade;
                window.grade = () => {
                    const result = originalGrade();
                    setTimeout(() => this.handleSubmit(), 200);
                    return result;
                };
            }
            
            // 监听提交按钮
            document.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' && 
                    (e.target.textContent.includes('Submit') || 
                     e.target.onclick && e.target.onclick.toString().includes('grade'))) {
                    setTimeout(() => this.handleSubmit(), 300);
                }
            });
        },
        
        handleSubmit: function() {
            const results = {
                sessionId: this.sessionId,
                startTime: this.startTime,
                endTime: Date.now(),
                duration: Math.round((Date.now() - this.startTime) / 1000),
                answers: this.answers,
                scoreInfo: this.extractScore(),
                pageType: this.detectPageType(),
                url: window.location.href
            };
            
            this.sendMessage('PRACTICE_COMPLETE', results);
        },
        
        extractScore: function() {
            const resultsEl = document.getElementById('results');
            if (!resultsEl) return null;
            
            const text = resultsEl.textContent || '';
            const scoreMatch = text.match(/Score:\s*(\d+)\/(\d+)/i);
            if (scoreMatch) {
                const correct = parseInt(scoreMatch[1]);
                const total = parseInt(scoreMatch[2]);
                return {
                    correct: correct,
                    total: total,
                    accuracy: total > 0 ? correct / total : 0,
                    percentage: Math.round((correct / total) * 100),
                    source: 'inline_extraction'
                };
            }
            return null;
        },
        
        sendMessage: function(type, data) {
            if (this.parentWindow) {
                this.parentWindow.postMessage({
                    type: type,
                    data: data,
                    source: 'practice_page'
                }, '*');
            }
        }
    };
    
    // 初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            window.practicePageEnhancer.initialize();
        });
    } else {
        window.practicePageEnhancer.initialize();
    }
}
</script>

</body></html>